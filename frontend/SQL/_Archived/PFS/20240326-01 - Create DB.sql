USE [master]
GO

CREATE DATABASE [PFSProcess]
 CONTAINMENT = NONE
 ON  PRIMARY 
( NAME = N'PFSProcess', FILENAME = N'f:\data\PFSProcess.mdf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
 LOG ON 
( NAME = N'PFSProcess_log', FILENAME = N'F:\Logs\PFSProcess_log.ldf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
GO
ALTER DATABASE [PFSProcess] SET COMPATIBILITY_LEVEL = 100
GO
ALTER DATABASE [PFSProcess] SET ANSI_NULL_DEFAULT OFF 
GO
ALTER DATABASE [PFSProcess] SET ANSI_NULLS OFF 
GO
ALTER DATABASE [PFSProcess] SET ANSI_PADDING OFF 
GO
ALTER DATABASE [PFSProcess] SET ANSI_WARNINGS OFF 
GO
ALTER DATABASE [PFSProcess] SET ARITHABORT OFF 
GO
ALTER DATABASE [PFSProcess] SET AUTO_CLOSE OFF 
GO
ALTER DATABASE [PFSProcess] SET AUTO_SHRINK OFF 
GO
ALTER DATABASE [PFSProcess] SET AUTO_CREATE_STATISTICS ON(INCREMENTAL = OFF)
GO
ALTER DATABASE [PFSProcess] SET AUTO_UPDATE_STATISTICS ON 
GO
ALTER DATABASE [PFSProcess] SET CURSOR_CLOSE_ON_COMMIT OFF 
GO
ALTER DATABASE [PFSProcess] SET CURSOR_DEFAULT  GLOBAL 
GO
ALTER DATABASE [PFSProcess] SET CONCAT_NULL_YIELDS_NULL OFF 
GO
ALTER DATABASE [PFSProcess] SET NUMERIC_ROUNDABORT OFF 
GO
ALTER DATABASE [PFSProcess] SET QUOTED_IDENTIFIER OFF 
GO
ALTER DATABASE [PFSProcess] SET RECURSIVE_TRIGGERS OFF 
GO
ALTER DATABASE [PFSProcess] SET  DISABLE_BROKER 
GO
ALTER DATABASE [PFSProcess] SET AUTO_UPDATE_STATISTICS_ASYNC OFF 
GO
ALTER DATABASE [PFSProcess] SET DATE_CORRELATION_OPTIMIZATION OFF 
GO
ALTER DATABASE [PFSProcess] SET PARAMETERIZATION SIMPLE 
GO
ALTER DATABASE [PFSProcess] SET READ_COMMITTED_SNAPSHOT OFF 
GO
ALTER DATABASE [PFSProcess] SET  READ_WRITE 
GO
ALTER DATABASE [PFSProcess] SET RECOVERY FULL 
GO
ALTER DATABASE [PFSProcess] SET  MULTI_USER 
GO
ALTER DATABASE [PFSProcess] SET PAGE_VERIFY CHECKSUM  
GO
ALTER DATABASE [PFSProcess] SET TARGET_RECOVERY_TIME = 60 SECONDS 
GO
ALTER DATABASE [PFSProcess] SET DELAYED_DURABILITY = DISABLED 
GO
USE [PFSProcess]
GO
ALTER DATABASE SCOPED CONFIGURATION SET LEGACY_CARDINALITY_ESTIMATION = Off;
GO
ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET LEGACY_CARDINALITY_ESTIMATION = Primary;
GO
ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 0;
GO
ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET MAXDOP = PRIMARY;
GO
ALTER DATABASE SCOPED CONFIGURATION SET PARAMETER_SNIFFING = On;
GO
ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET PARAMETER_SNIFFING = Primary;
GO
ALTER DATABASE SCOPED CONFIGURATION SET QUERY_OPTIMIZER_HOTFIXES = Off;
GO
ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET QUERY_OPTIMIZER_HOTFIXES = Primary;
GO
USE [PFSProcess]
GO
IF NOT EXISTS (SELECT name FROM sys.filegroups WHERE is_default=1 AND name = N'PRIMARY') ALTER DATABASE [PFSProcess] MODIFY FILEGROUP [PRIMARY] DEFAULT
GO

USE [PFSProcess]
GO


/****** Object:  FullTextCatalog [CommentArchived]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE FULLTEXT CATALOG [CommentArchived] WITH ACCENT_SENSITIVITY = ON
GO
/****** Object:  FullTextCatalog [ft]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE FULLTEXT CATALOG [ft] WITH ACCENT_SENSITIVITY = ON
AS DEFAULT
GO
/****** Object:  FullTextCatalog [PFSProcess]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE FULLTEXT CATALOG [PFSProcess] WITH ACCENT_SENSITIVITY = OFF
GO
/****** Object:  UserDefinedTableType [dbo].[RecordId]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE TYPE [dbo].[RecordId] AS TABLE(
	[Id] [int] NOT NULL,
	PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (IGNORE_DUP_KEY = OFF)
)
GO

USE PFSProcess
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Assignments](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[InstanceID] [int] NOT NULL,
	[GroupID] [int] NOT NULL,
	[DtAssigned] [datetime] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_Assignments] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Index [gid]    Script Date: 3/26/2024 2:14:32 PM ******/
CREATE NONCLUSTERED INDEX [gid] ON [dbo].[QCheck_Assignments]
(
	[ID] ASC,
	[GroupID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [igi]    Script Date: 3/26/2024 2:14:32 PM ******/
CREATE NONCLUSTERED INDEX [igi] ON [dbo].[QCheck_Assignments]
(
	[InstanceID] ASC,
	[GroupID] ASC,
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
ALTER TABLE [dbo].[QCheck_Assignments] ADD  CONSTRAINT [DF_QCheck_Assignments_DtAssigned]  DEFAULT (getdate()) FOR [DtAssigned]
GO
ALTER TABLE [dbo].[QCheck_Assignments] ADD  CONSTRAINT [DF_QCheck_Assignments_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO

/****** Object:  StoredProcedure [dbo].[xp_smtp_sendmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[xp_smtp_sendmail]
	@From NVARCHAR (MAX) = '', 
	@Message NVARCHAR (MAX)='', 
	@To NVARCHAR (MAX)='', 
	@Subject NVARCHAR (MAX)='', 
	@Server NVARCHAR (MAX)='', 
	@Type NVARCHAR (MAX)='text/html', 
	@CC NVARCHAR (MAX)='', 
	@BCC NVARCHAR (MAX)='', 
	@Attachment NVARCHAR (MAX)='', 
	@Attachment_Name NVARCHAR (MAX)='',
	@MessageFile NVARCHAR (MAX)='', 
	@From_Name NVARCHAR (MAX)='',
	@replyto NVARCHAR (MAX)=''
AS
BEGIN
	SET NOCOUNT ON
	IF LEN(@From) = 0
		SET @From =	(SELECT TOP 1 'sqlmail@dnr.' + BaseDomain FROM QCheck_AppSettings)
	/*
	EXEC master.dbo.xp_smtp_sendmail
		@From = @From, 
		@Message = @Message, 
		@To = @To, 
		@Subject = @Subject, 
		@Server = @Server, 
		@Type = @Type, 
		@CC = @CC, 
		@BCC = @BCC, 
		@Attachment = @Attachment, 
		@Attachment_Name = @Attachment_Name,
		@MessageFile = @MessageFile, 
		@From_Name = @From_Name,
		@replyto = @replyto
	*/
	SET NOCOUNT OFF
END
GO

---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[APP_SpecificPermissions] AS
	SELECT [specificPermissionID]-- [int] IDENTITY(1,1) NOT NULL,
    		,[appID]-- [varchar](15) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
	   		,[userID]-- [varchar](500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
    		,[permissionType]-- [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
    		,[permissionValue]-- [varchar](500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
	FROM ( --[SECURESQL_APPSEC].[_acmesec_appsec].[dbo].[app_specificpermissions]
	SELECT '' specificPermissionID,
	'' appID,
	'' userID,
	'' permissionType,
	'' permissionValue,
	)
	WHERE 1=0
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vwEmail2DB] AS
	SELECT [AccountID]-- [char](10) NOT NULL,
		,[Source]-- [char](10) NOT NULL,
		,[UID]-- [varchar](250) NOT NULL,
		,[RecordNo]-- [int] IDENTITY(1,1) NOT NULL,
		,[FolderID]-- [char](10) NULL,
		,[Subject]-- [nvarchar](1000) NULL,
		,[FromAddress]-- [varchar](250) NULL,
		,[ToAddress]-- [varchar](250) NULL,
		,[Importance]-- [char](1) NULL,
		,[Sensitivity]-- [char](1) NULL,
		,[MessageDate]-- [datetime] NULL,
		,[MessageFlags]-- [int] NULL,
		,[POP3Removed]-- [bit] NULL,
		,[ProcessedDate]-- [datetime] NULL,
		,[TriggerID]-- [char](10) NOT NULL,
		,[TriggerMatch]-- [bit] NULL,
		,[TriggerSuccess]-- [bit] NULL,
		,[TriggerError]-- [varchar](250) NULL,
		,[Attachments]-- [bit] NULL,
		,[Headers]-- [text] NULL,
		,[Email]-- [text] NULL,
		,[Html]-- [text] NULL
	FROM-- [awsc-sql-02].[email2db].[dbo].[Email2DB]
	(	SELECT '' AS [AccountID]-- [char](10) NOT NULL,
			,'' AS [Source]-- [char](10) NOT NULL,
			,'' AS [UID]-- [varchar](250) NOT NULL,
			,1 AS [RecordNo]-- [int] IDENTITY(1,1) NOT NULL,
			,'' AS [FolderID]-- [char](10) NULL,
			,'' AS [Subject]-- [nvarchar](1000) NULL,
			,'' AS [FromAddress]-- [varchar](250) NULL,
			,'' AS [ToAddress]-- [varchar](250) NULL,
			,'' AS [Importance]-- [char](1) NULL,
			,'' AS [Sensitivity]-- [char](1) NULL,
			,GETDATE() AS [MessageDate]-- [datetime] NULL,
			,0 AS [MessageFlags]-- [int] NULL,
			,0 AS [POP3Removed]-- [bit] NULL,
			,GETDATE() AS [ProcessedDate]-- [datetime] NULL,
			,'' AS [TriggerID]-- [char](10) NOT NULL,
			,0 AS [TriggerMatch]-- [bit] NULL,
			,0 AS [TriggerSuccess]-- [bit] NULL,
			,'' AS [TriggerError]-- [varchar](250) NULL,
			,0 AS [Attachments]-- [bit] NULL,
			,'' AS [Headers]-- [text] NULL,
			,'' AS [Email]-- [text] NULL,
			,'' AS [Html]-- [text] NULL
	) t
	WHERE 1=0
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vwVacation] AS
	SELECT [ID]-- [int] IDENTITY(1,1) NOT NULL,
		,[EmployeeID]-- [int] NOT NULL,
		,[VacationDay]-- [datetime] NOT NULL,
		,[Note]-- [varchar](1000) NULL,
		,[VacationTypeID]-- [int] NOT NULL,
		,[HalfDay]-- [bit] NOT NULL,
		,[HalfDayIn]-- [varchar](50) NULL,
		,[HalfDayOut]-- [varchar](50) NULL,
		,[ReferenceYear]-- [int] NULL,
		,[ThresholdNotification]-- [bit] NOT NULL,
		,[Entered]-- [datetime] NULL,
		,[CreatedBy]-- [int] NOT NULL,
		,[CreatedDt]-- [datetime] NULL,
		,[ModifiedBy]-- [int] NULL,
		,[ModifiedDt]-- [datetime] NULL
	FROM --[awsc-sql-02].[MyVacation].[dbo].[Vacation]
	(	SELECT 1 AS [ID]-- [int] IDENTITY(1,1) NOT NULL,
			,0 AS [EmployeeID]-- [int] NOT NULL,
			,GETDATE() AS [VacationDay]-- [datetime] NOT NULL,
			,'' AS [Note]-- [varchar](1000) NULL,
			,0 AS [VacationTypeID]-- [int] NOT NULL,
			,0 AS [HalfDay]-- [bit] NOT NULL,
			,'' AS [HalfDayIn]-- [varchar](50) NULL,
			,'' AS [HalfDayOut]-- [varchar](50) NULL,
			,0 AS [ReferenceYear]-- [int] NULL,
			,0 AS [ThresholdNotification]-- [bit] NOT NULL,
			,GETDATE() AS [Entered]-- [datetime] NULL,
			,0 AS [CreatedBy]-- [int] NOT NULL,
			,GETDATE() AS [CreatedDt]-- [datetime] NULL,
			,0 AS [ModifiedBy]-- [int] NULL,
			,GETDATE() AS [ModifiedDt]-- [datetime] NULL
	) t
	WHERE 1=0
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vw_empEmployees] AS
	SELECT [EmpID]-- [int] IDENTITY(365,1) NOT FOR REPLICATION NOT NULL,
		,[FirstName]-- [varchar](25) NULL,
		,[LastName]-- [varchar](25) NULL,
		,[MiddleName]-- [varchar](25) NULL,
		,[Alias]-- [varchar](25) NULL,
		,[OfficeExtension]-- [char](50) NULL,
		,[SupervisorID]-- [int] NULL,
		,[DepartmentID]-- [int] NULL,
		,[Address]-- [varchar](40) NULL,
		,[City]-- [varchar](40) NULL,
		,[State]-- [char](15) NULL,
		,[Zip]-- [varchar](20) NULL,
		,[HomePhone]-- [varchar](20) NULL,
		,[CellPhone]-- [varchar](20) NULL,
		,[DirectConnect]-- [varchar](20) NULL,
		,[QEmailAddress]-- [varchar](75) NULL,
		,[HomeEmailAddress]-- [varchar](75) NULL,
		,[AlternateEmailAddress]-- [varchar](75) NULL,
		,[HireDate]-- [smalldatetime] NULL,
		,[ContractDate]-- [smalldatetime] NULL,
		,[PartTimeDate]-- [smalldatetime] NULL,
		,[InternDate]-- [smalldatetime] NULL,
		,[TerminationDate]-- [smalldatetime] NULL,
		,[Status]-- [bit] NULL,
		,[Agency]-- [varchar](5000) NULL,
		,[BirthDate]-- [datetime] NULL,
		,[Gender]-- [varchar](6) NULL,
		,[USCitizen]-- [bit] NULL,
		,[ForeignCitizen]-- [bit] NULL,
		,[USWorkPermit]-- [varchar](50) NULL,
		,[USWorkPermitExp]-- [smalldatetime] NULL,
		,[DL_Number]-- [varchar](20) NULL,
		,[DL_State]-- [varchar](50) NULL,
		,[DL_Expiration]-- [smalldatetime] NULL,
		,[W4]-- [bit] NULL,
		,[I9]-- [bit] NULL,
		,[GPR_Confi_Agreement]-- [bit] NULL,
		,[Hourly]-- [bit] NULL,
		,[SalaryTest]-- [bit] NULL,
		,[Professional_Exemption]-- [bit] NULL,
		,[Administrative_Exemption]-- [bit] NULL,
		,[Executive_Exemption]-- [bit] NULL,
		,[Computer_Profession_Exemption]-- [bit] NULL,
		,[Exemption_Status]-- [bit] NULL,
		,[InsuranceCoverageAccepted]-- [bit] NULL,
		,[BCBS_ID]-- [int] NULL,
		,[HF_VoluntaryLTD]-- [bit] NULL,
		,[HF_SupplementalLifeADD]-- [bit] NULL,
		,[HF_SupplementalLifeEmployee]-- [bit] NULL,
		,[HF_SupplementalLifeSpouse]-- [bit] NULL,
		,[HF_SupplementalLifeChildren]-- [bit] NULL,
		,[TimeOffAllotment]-- [char](5) NULL,
		,[TypeID]-- [int] NULL,
		,[GenChecklist]-- [bit] NULL,
		,[SEC_Address]-- [varchar](40) NULL,
		,[SEC_City]-- [varchar](40) NULL,
		,[SEC_State]-- [char](15) NULL,
		,[SEC_Zip]-- [varchar](20) NULL,
		,[Suffix]-- [varchar](5) NULL,
		,[PIC]-- [varchar](50) NULL,
		,[PayrollEntityId]-- [int] NULL,
		,[Country]-- [varchar](5) NULL,
		,[SEC_Country]-- [varchar](5) NULL,
		,[IsActive]-- [bit] NULL,
		,[IsSupervisor]-- [bit] NULL,
		,[TerminationReason]-- [varchar](50) NULL,
		,[CobraAccepted]-- [bit] NULL,
		,[CobraAcceptedDate]-- [datetime] NULL,
		,[Initials]-- [varchar](10) NULL,
		,[NetworkLogin]-- [varchar](50) NULL,
		,[Picture]-- [varchar](50) NULL,
		,[WorkStartTime]-- [datetime] NULL,
		,[WorkStopTime]-- [datetime] NULL,
		,[FlagLunch]-- [bit] NULL,
		,[FlagPolicy]-- [bit] NULL,
		,[FlagAppreciation]-- [bit] NULL,
		,[CreateUser]-- [varchar](50) NULL,
		,[UpdateUser]-- [varchar](50) NULL,
		,[DateCreated]-- [datetime] NULL,
		,[DateUpdated]-- [datetime] NULL,
		,[FullName]-- [varchar](255) NULL,
		,[EmployeePath]-- [varchar](255) NULL,
		,[FlagInOffice]-- [bit] NULL,
		,[FlagPCAccess]-- [bit] NULL,
		,[FlagWOAppreciation]-- [bit] NULL,
		,[SocialSecurityEncrypted]-- [varbinary](128) NULL,
		,[FlagVotingRequired]-- [bit] NOT NULL,
		,[FlagWOVotingRequired]-- [bit] NOT NULL,
		,[FlagWOLunch]-- [bit] NULL,
		,[FlagIncProd]-- [bit] NOT NULL,
		,[FlagPartnerMtg]-- [bit] NOT NULL,
		,[LinkedIn]-- [varchar](2048) NULL,		
	FROM --[awsc-sql-02].[AcmeDotNet].[dbo].[empEmployees]
	(	SELECT 1 AS [EmpID]-- [int] IDENTITY(365,1) NOT FOR REPLICATION NOT NULL,
			,'' AS [FirstName]-- [varchar](25) NULL,
			,'' AS [LastName]-- [varchar](25) NULL,
			,'' AS [MiddleName]-- [varchar](25) NULL,
			,'' AS [Alias]-- [varchar](25) NULL,
			,'' AS [OfficeExtension]-- [char](50) NULL,
			,0 AS [SupervisorID]-- [int] NULL,
			,0 AS [DepartmentID]-- [int] NULL,
			,'' AS [Address]-- [varchar](40) NULL,
			,'' AS [City]-- [varchar](40) NULL,
			,'' AS [State]-- [char](15) NULL,
			,'' AS [Zip]-- [varchar](20) NULL,
			,'' AS [HomePhone]-- [varchar](20) NULL,
			,'' AS [CellPhone]-- [varchar](20) NULL,
			,'' AS [DirectConnect]-- [varchar](20) NULL,
			,'' AS [QEmailAddress]-- [varchar](75) NULL,
			,'' AS [HomeEmailAddress]-- [varchar](75) NULL,
			,'' AS [AlternateEmailAddress]-- [varchar](75) NULL,
			,GETDATE() AS [HireDate]-- [smalldatetime] NULL,
			,GETDATE() AS [ContractDate]-- [smalldatetime] NULL,
			,GETDATE() AS [PartTimeDate]-- [smalldatetime] NULL,
			,GETDATE() AS [InternDate]-- [smalldatetime] NULL,
			,GETDATE() AS [TerminationDate]-- [smalldatetime] NULL,
			,0 AS [Status]-- [bit] NULL,
			,'' AS [Agency]-- [varchar](5000) NULL,
			,GETDATE() AS [BirthDate]-- [datetime] NULL,
			,'' AS [Gender]-- [varchar](6) NULL,
			,0 AS [USCitizen]-- [bit] NULL,
			,0 AS [ForeignCitizen]-- [bit] NULL,
			,'' AS [USWorkPermit]-- [varchar](50) NULL,
			,GETDATE() AS [USWorkPermitExp]-- [smalldatetime] NULL,
			,'' AS [DL_Number]-- [varchar](20) NULL,
			,'' AS [DL_State]-- [varchar](50) NULL,
			,GETDATE() AS [DL_Expiration]-- [smalldatetime] NULL,
			,0 AS [W4]-- [bit] NULL,
			,0 AS [I9]-- [bit] NULL,
			,0 AS [GPR_Confi_Agreement]-- [bit] NULL,
			,0 AS [Hourly]-- [bit] NULL,
			,0 AS [SalaryTest]-- [bit] NULL,
			,0 AS [Professional_Exemption]-- [bit] NULL,
			,0 AS [Administrative_Exemption]-- [bit] NULL,
			,0 AS [Executive_Exemption]-- [bit] NULL,
			,0 AS [Computer_Profession_Exemption]-- [bit] NULL,
			,0 AS [Exemption_Status]-- [bit] NULL,
			,0 AS [InsuranceCoverageAccepted]-- [bit] NULL,
			,0 AS [BCBS_ID]-- [int] NULL,
			,0 AS [HF_VoluntaryLTD]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeADD]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeEmployee]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeSpouse]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeChildren]-- [bit] NULL,
			,'' AS [TimeOffAllotment]-- [char](5) NULL,
			,0 AS [TypeID]-- [int] NULL,
			,0 AS [GenChecklist]-- [bit] NULL,
			,'' AS [SEC_Address]-- [varchar](40) NULL,
			,'' AS [SEC_City]-- [varchar](40) NULL,
			,'' AS [SEC_State]-- [char](15) NULL,
			,'' AS [SEC_Zip]-- [varchar](20) NULL,
			,'' AS [Suffix]-- [varchar](5) NULL,
			,'' AS [PIC]-- [varchar](50) NULL,
			,0 AS [PayrollEntityId]-- [int] NULL,
			,'' AS [Country]-- [varchar](5) NULL,
			,'' AS [SEC_Country]-- [varchar](5) NULL,
			,0 AS [IsActive]-- [bit] NULL,
			,0 AS [IsSupervisor]-- [bit] NULL,
			,'' AS [TerminationReason]-- [varchar](50) NULL,
			,0 AS [CobraAccepted]-- [bit] NULL,
			,GETDATE() AS [CobraAcceptedDate]-- [datetime] NULL,
			,'' AS [Initials]-- [varchar](10) NULL,
			,'' AS [NetworkLogin]-- [varchar](50) NULL,
			,'' AS [Picture]-- [varchar](50) NULL,
			,GETDATE() AS [WorkStartTime]-- [datetime] NULL,
			,GETDATE() AS [WorkStopTime]-- [datetime] NULL,
			,0 AS [FlagLunch]-- [bit] NULL,
			,0 AS [FlagPolicy]-- [bit] NULL,
			,0 AS [FlagAppreciation]-- [bit] NULL,
			,'' AS [CreateUser]-- [varchar](50) NULL,
			,'' AS [UpdateUser]-- [varchar](50) NULL,
			,GETDATE() AS [DateCreated]-- [datetime] NULL,
			,GETDATE() AS [DateUpdated]-- [datetime] NULL,
			,'' AS [FullName]-- [varchar](255) NULL,
			,'' AS [EmployeePath]-- [varchar](255) NULL,
			,0 AS [FlagInOffice]-- [bit] NULL,
			,0 AS [FlagPCAccess]-- [bit] NULL,
			,0 AS [FlagWOAppreciation]-- [bit] NULL,
			,CONVERT(VARBINARY(128), 0) AS [SocialSecurityEncrypted]-- [varbinary](128) NULL,
			,0 AS [FlagVotingRequired]-- [bit] NOT NULL,
			,0 AS [FlagWOVotingRequired]-- [bit] NOT NULL,
			,0 AS [FlagWOLunch]-- [bit] NULL,
			,0 AS [FlagIncProd]-- [bit] NOT NULL,
			,0 AS [FlagPartnerMtg]-- [bit] NOT NULL,
			,'' AS[LinkedIn]-- [varchar](2048) NULL
	) t
	WHERE 1=0
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vw_empFormerEmployees] AS
	SELECT [EmpID]-- [int] NOT NULL,
		,[FirstName]-- [varchar](25) NULL,
		,[LastName]-- [varchar](25) NULL,
		,[MiddleName]-- [varchar](25) NULL,
		,[Alias]-- [varchar](25) NULL,
		,[FullName]-- [varchar](50) NULL,
		,[OfficeExtension]-- [char](50) NULL,
		,[SupervisorID]-- [int] NULL,
		,[DepartmentID]-- [int] NULL,
		,[Address]-- [varchar](40) NULL,
		,[City]-- [varchar](40) NULL,
		,[State]-- [char](15) NULL,
		,[Zip]-- [varchar](20) NULL,
		,[HomePhone]-- [varchar](20) NULL,
		,[CellPhone]-- [varchar](20) NULL,
		,[DirectConnect]-- [varchar](20) NULL,
		,[QEmailAddress]-- [varchar](75) NULL,
		,[HomeEmailAddress]-- [varchar](75) NULL,
		,[AlternateEmailAddress]-- [varchar](75) NULL,
		,[SocialSecurity]-- [char](12) NULL,
		,[HireDate]-- [smalldatetime] NULL,
		,[ContractDate]-- [smalldatetime] NULL,
		,[PartTimeDate]-- [smalldatetime] NULL,
		,[InternDate]-- [smalldatetime] NULL,
		,[TerminationDate]-- [smalldatetime] NULL,
		,[Status]-- [bit] NULL,
		,[Agency]-- [varchar](50) NULL,
		,[BirthDate]-- [datetime] NULL,
		,[Gender]-- [varchar](6) NULL,
		,[USCitizen]-- [bit] NULL,
		,[ForeignCitizen]-- [bit] NULL,
		,[USWorkPermit]-- [varchar](50) NULL,
		,[USWorkPermitExp]-- [smalldatetime] NULL,
		,[DL_Number]-- [varchar](20) NULL,
		,[DL_State]-- [varchar](50) NULL,
		,[DL_Expiration]-- [smalldatetime] NULL,
		,[W4]-- [bit] NULL,
		,[I9]-- [bit] NULL,
		,[GPR_Confi_Agreement]-- [bit] NULL,
		,[Hourly]-- [bit] NULL,
		,[SalaryTest]-- [bit] NULL,
		,[Professional_Exemption]-- [bit] NULL,
		,[Administrative_Exemption]-- [bit] NULL,
		,[Executive_Exemption]-- [bit] NULL,
		,[Computer_Profession_Exemption]-- [bit] NULL,
		,[Exemption_Status]-- [bit] NULL,
		,[InsuranceCoverageAccepted]-- [bit] NULL,
		,[BCBS_ID]-- [int] NULL,
		,[HF_VoluntaryLTD]-- [bit] NULL,
		,[HF_SupplementalLifeADD]-- [bit] NULL,
		,[HF_SupplementalLifeEmployee]-- [bit] NULL,
		,[HF_SupplementalLifeSpouse]-- [bit] NULL,
		,[HF_SupplementalLifeChildren]-- [bit] NULL,
		,[TimeOffAllotment]-- [char](5) NULL,
		,[TypeID]-- [int] NULL,
		,[EmployeePath]-- [varchar](50) NULL,
		,[GenChecklist]-- [bit] NULL,
		,[SEC_Address]-- [varchar](40) NULL,
		,[SEC_City]-- [varchar](40) NULL,
		,[SEC_State]-- [char](15) NULL,
		,[SEC_Zip]-- [varchar](20) NULL,
		,[Suffix]-- [char](5) NULL,
		,[PIC]-- [varchar](50) NULL
	FROM-- [awsc-sql-02].[AcmeDotNet].[dbo].[empFormerEmployees]
	(	SELECT 0 AS [EmpID]-- [int] NOT NULL,
			,'' AS [FirstName]-- [varchar](25) NULL,
			,'' AS [LastName]-- [varchar](25) NULL,
			,'' AS [MiddleName]-- [varchar](25) NULL,
			,'' AS [Alias]-- [varchar](25) NULL,
			,'' AS [FullName]-- [varchar](50) NULL,
			,'' AS [OfficeExtension]-- [char](50) NULL,
			,0 AS [SupervisorID]-- [int] NULL,
			,0 AS [DepartmentID]-- [int] NULL,
			,'' AS [Address]-- [varchar](40) NULL,
			,'' AS [City]-- [varchar](40) NULL,
			,'' AS [State]-- [char](15) NULL,
			,'' AS [Zip]-- [varchar](20) NULL,
			,'' AS [HomePhone]-- [varchar](20) NULL,
			,'' AS [CellPhone]-- [varchar](20) NULL,
			,'' AS [DirectConnect]-- [varchar](20) NULL,
			,'' AS [QEmailAddress]-- [varchar](75) NULL,
			,'' AS [HomeEmailAddress]-- [varchar](75) NULL,
			,'' AS [AlternateEmailAddress]-- [varchar](75) NULL,
			,'' AS [SocialSecurity]-- [char](12) NULL,
			,GETDATE() AS [HireDate]-- [smalldatetime] NULL,
			,GETDATE() AS [ContractDate]-- [smalldatetime] NULL,
			,GETDATE() AS [PartTimeDate]-- [smalldatetime] NULL,
			,GETDATE() AS [InternDate]-- [smalldatetime] NULL,
			,GETDATE() AS [TerminationDate]-- [smalldatetime] NULL,
			,0 AS [Status]-- [bit] NULL,
			,'' AS [Agency]-- [varchar](50) NULL,
			,GETDATE() AS [BirthDate]-- [datetime] NULL,
			,'' AS [Gender]-- [varchar](6) NULL,
			,0 AS [USCitizen]-- [bit] NULL,
			,0 AS [ForeignCitizen]-- [bit] NULL,
			,'' AS [USWorkPermit]-- [varchar](50) NULL,
			,GETDATE() AS [USWorkPermitExp]-- [smalldatetime] NULL,
			,'' AS [DL_Number]-- [varchar](20) NULL,
			,'' AS [DL_State]-- [varchar](50) NULL,
			,GETDATE() AS [DL_Expiration]-- [smalldatetime] NULL,
			,0 AS [W4]-- [bit] NULL,
			,0 AS [I9]-- [bit] NULL,
			,0 AS [GPR_Confi_Agreement]-- [bit] NULL,
			,0 AS [Hourly]-- [bit] NULL,
			,0 AS [SalaryTest]-- [bit] NULL,
			,0 AS [Professional_Exemption]-- [bit] NULL,
			,0 AS [Administrative_Exemption]-- [bit] NULL,
			,0 AS [Executive_Exemption]-- [bit] NULL,
			,0 AS [Computer_Profession_Exemption]-- [bit] NULL,
			,0 AS [Exemption_Status]-- [bit] NULL,
			,0 AS [InsuranceCoverageAccepted]-- [bit] NULL,
			,0 AS [BCBS_ID]-- [int] NULL,
			,0 AS [HF_VoluntaryLTD]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeADD]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeEmployee]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeSpouse]-- [bit] NULL,
			,0 AS [HF_SupplementalLifeChildren]-- [bit] NULL,
			,'' AS [TimeOffAllotment]-- [char](5) NULL,
			,0 AS [TypeID]-- [int] NULL,
			,'' AS [EmployeePath]-- [varchar](50) NULL,
			,0 AS [GenChecklist]-- [bit] NULL,
			,'' AS [SEC_Address]-- [varchar](40) NULL,
			,'' AS [SEC_City]-- [varchar](40) NULL,
			,'' AS [SEC_State]-- [char](15) NULL,
			,'' AS [SEC_Zip]-- [varchar](20) NULL,
			,'' AS [Suffix]-- [char](5) NULL,
			,'' AS [PIC]-- [varchar](50) NULL		
	) t
	WHERE 1=0
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE dbo.[APP_SpecificPermissions_SELECT]
	@UserID varchar(20),
	@AppID varchar(50) = 'ProcessPFS',
	@PermissionType varchar(50)
AS
BEGIN
	SELECT * FROM dbo.APP_SpecificPermissions
	WHERE appID = @AppID
	AND userID = @UserID
	AND permissionType = @PermissionType
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fnLastFirstName]
(
	@empID INT
)
RETURNS VARCHAR(50)
AS
BEGIN

DECLARE @FN VARCHAR(50)

if exists (select 1 from vw_empEmployees where empID = @empID) begin
	SET @FN = 
		(SELECT LastName + case isnull(Suffix, '') when '' then '' else ' ' + Suffix end + ', ' + FirstName 
		FROM vw_empEmployees
		WHERE empID = @empID)
end
else begin
	SET @FN = 
		(SELECT LastName + case isnull(Suffix, '') when '' then '' else ' ' + Suffix end + ', ' + FirstName 
		FROM vw_empFormerEmployees
		WHERE empID = @empID)
end
RETURN @FN
END
GO
CREATE FUNCTION [dbo].[fnCreditLimitIntern] (
	@empID INT,
	@nowDate datetime
) RETURNS MONEY AS
BEGIN

DECLARE 
	@CreditLimit MONEY,
	@empDate DATETIME,
	@internDate DATETIME

SET @empdate = (
	SELECT (
		SELECT MAX(d)
		FROM (
			SELECT Hiredate UNION ALL
			SELECT ContractDate UNION ALL
			SELECT ParttimeDate UNION ALL
			SELECT InternDate
		) AS D(d)
	)
	FROM vw_empemployees
	WHERE empID = @EmpID
)

SELECT @interndate = interndate
FROM vw_empEmployees
WHERE empID = @EmpID

IF ISNULL(@interndate, @nowdate) < ISNULL(@empdate, @nowdate) SET @empdate = @interndate

SET @CreditLimit = 
(
SELECT	
'CreditLimit' = 
	CASE 
		WHEN @empid in (43,56,59,151) then 500 -- Adam D, Nelson H, Tim G, William H
		WHEN @empid in (5389) then 300 -- Erik Anderson - special case, went to bank then returned
		WHEN DATEDIFF(dd, @empDate, @nowDate) / 365.00 < 1 THEN 100 
		WHEN DATEDIFF(dd, @empDate, @nowDate) / 365.00 between 1 and 3 THEN 200 
		WHEN DATEDIFF(dd, @empDate, @nowDate) / 365.00 > 3 THEN 300
		ELSE 0
	END
FROM 
	vw_empEmployees
WHERE
	EmpID = @empID)

RETURN ISNULL(@CreditLimit,0)
END
GO
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[CreditBalance]
(
	@empID INT
)
RETURNS MONEY
AS
BEGIN

DECLARE @CreditBalance MONEY

SET @CreditBalance = 
	(
	SELECT 
		(ISNULL(CreditLimit,0) - ISNULL(CurrentBalance,0))
	FROM 
		vw_empPersonalCharges 
	WHERE empiD = @empID		
	)

RETURN @CreditBalance
END
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vw_empIncidentals] AS
	SELECT [IncidentalID]-- [int] IDENTITY(1,1) NOT NULL,
		,[PChargesID]-- [int] NULL,
		,[CategoryID]-- [int] NULL,
		,[DateSent]-- [datetime] NULL,
		,[Amount]-- [money] NULL,
		,[Description]-- [varchar](200) NULL
	FROM-- [awsc-sql-02].[AcmeDotNet].[dbo].[empIncidentals]
	(	SELECT 1 AS [IncidentalID]-- [int] IDENTITY(1,1) NOT NULL,
			,0 AS [PChargesID]-- [int] NULL,
			,0 AS [CategoryID]-- [int] NULL,
			,GETDATE() AS [DateSent]-- [datetime] NULL,
			,0 AS [Amount]-- [money] NULL,
			,'' AS [Description]-- [varchar](200) NULL
	) t
	WHERE 1=0
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vw_empFines] AS
	SELECT [Id]-- [int] IDENTITY(1,1) NOT NULL,
		,[SourceId]-- [int] NULL,
		,[EmpId]-- [int] NULL,
		,[Charge]-- [float] NULL,
		,[ChargeSource]-- [varchar](100) NULL,
		,[ChargeDesc]-- [varchar](max) NULL,
		,[ChargeDate]-- [datetime] NULL,
		,[CreatedDate]-- [datetime] NULL,
		,[IsProcessed]-- [bit] NULL,
		,[ProcessedDate]-- [datetime] NULL,
		,[ProcessedBy]-- [varchar](500) NULL
	FROM-- [awsc-sql-02].[AcmeDotNet].[dbo].[empFines]
	(	SELECT 1 AS [Id]-- [int] IDENTITY(1,1) NOT NULL,
			,0 AS [SourceId]-- [int] NULL,
			,0 AS [EmpId]-- [int] NULL,
			,0 AS [Charge]-- [float] NULL,
			,'' AS [ChargeSource]-- [varchar](100) NULL,
			,'' AS [ChargeDesc]-- [varchar](max) NULL,
			,GETDATE() AS [ChargeDate]-- [datetime] NULL,
			,GETDATE() AS [CreatedDate]-- [datetime] NULL,
			,0 AS [IsProcessed]-- [bit] NULL,
			,GETDATE() AS [ProcessedDate]-- [datetime] NULL,
			,'' AS [ProcessedBy]-- [varchar](500) NULL
	) t
	WHERE 1=0
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fnTotalExpenses]
(
	@PChargesID INT
)
RETURNS MONEY
AS
BEGIN
DECLARE 
	@CurrentBalance MONEY,
	@PersonalBalances MONEY,
	@IncidentalBalances MONEY,
	@Fines Money

SET @PersonalBalances = (SELECT ISNULL(ParkingBalance,0) + ISNULL(PhoneBalance,0)  FROM vw_empPersonalCharges WHERE PChargesID = @PChargesID)
SET @IncidentalBalances =  (SELECT ISNULL(SUM(AMOUNT),0) FROM vw_empIncidentals WHERE PChargesID = @PChargesID)

select @Fines = Sum(Charge) 
from vw_empFines 	
where EmpId in (
	select isnull(EmpID, 0) from vw_empPersonalCharges where PChargesID = @pChargesID
) 
and Isnull(IsProcessed,0)=0 

SELECT @Fines = Isnull(@Fines, 0)

SET @CurrentBalance = (@PersonalBalances + @IncidentalBalances+@Fines)

RETURN @CurrentBalance
END
GO
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[vw_empPersonalCharges] AS
	SELECT [PChargesID]-- [int] IDENTITY(1,1) NOT NULL,
		,[empID]-- [int] NULL,
		,[FullName]--  AS ([dbo].[fnLastFirstName]([empID])),
		,[ParkingAssignmentID]-- [int] NULL,
		,[ParkingFee]-- [money] NULL,
		,[ParkingBalance]-- [money] NULL,
		,[PhonePlanID]-- [int] NULL,
		,[PhoneFee]-- [money] NULL,
		,[PhoneBalance]-- [money] NULL,
		,[LunchBalance]-- [money] NULL,
		,[FedExBalance]-- [money] NULL,
		,[CreditLimit]-- = ([dbo].[fnCreditLimitIntern]([empID],getdate())),
		,[CreditRemaining]-- = ([dbo].[CreditBalance]([empID])),
		,[BalancePaid]-- [bit] NULL,
		,[DatePaid]-- [datetime] NULL,
		,[DataPlanFee]-- [money] NOT NULL,
		,[QprocessLateFee]-- [money] NULL,
		,[QprocessOverdueTaskFee]-- [money] NULL,
		,[CurrentBalance]-- = ([dbo].[fnTotalExpenses]([PChargesID]))
	FROM --[awsc-sql-02].[AcmeDotNet].[dbo].[empPersonalCharges]
	(	SELECT 1 AS [PChargesID]-- [int] IDENTITY(1,1) NOT NULL,
			,0 AS [empID]-- [int] NULL,
			,'' AS [FullName]--  AS ([dbo].[fnLastFirstName]([empID])),
			,0 AS [ParkingAssignmentID]-- [int] NULL,
			,0 AS [ParkingFee]-- [money] NULL,
			,0 AS [ParkingBalance]-- [money] NULL,
			,0 AS [PhonePlanID]-- [int] NULL,
			,0 AS [PhoneFee]-- [money] NULL,
			,0 AS [PhoneBalance]-- [money] NULL,
			,0 AS [LunchBalance]-- [money] NULL,
			,0 AS [FedExBalance]-- [money] NULL,
			,0 AS [CreditLimit]-- = ([dbo].[fnCreditLimitIntern]([empID],getdate())),
			,0 AS [CreditRemaining]-- = ([dbo].[CreditBalance]([empID])),
			,0 AS [BalancePaid]-- [bit] NULL,
			,GETDATE() AS [DatePaid]-- [datetime] NULL,
			,0 AS [DataPlanFee]-- [money] NOT NULL,
			,0 AS [QprocessLateFee]-- [money] NULL,
			,0 AS [QprocessOverdueTaskFee]-- [money] NULL,
			,0 AS [CurrentBalance]-- = ([dbo].[fnTotalExpenses]([PChargesID]))
	) t
	WHERE 1=0
GO
/****** Object:  Synonym [dbo].[EmailLog]    Script Date: 3/22/2024 4:20:57 PM ******/
---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[EmailLog] AS 
	SELECT [ID] --int identity(1,1) - PK
		  ,[DT] --datetime - timestamp
		  ,[SPID] --int - SQL process ID
		  ,[Pre] --bit - indicates pre-send log
		  ,[Post] --bit - indicates post-send log
		  ,[From] --nvarchar(4000) - email address of sender
		  ,[MessageLenChars] -- int
		  ,[To] --nvarchar(4000)
		  ,[Subject] --nvarchar(4000)
		  ,[Server] --nvarchar(4000) - SMTP server used, optional
		  ,[Type] --MIME type of email content, usually text/html or text/plain
		  ,[CC] --nvarchar(4000)
		  ,[BCC] --nvarchar(4000)
		  ,[Attachment] --nvarchar(4000)
		  ,[Attachment_Name] --nvarchar(4000)
		  ,[MessageFile] --nvarchar(4000)
		  ,[From_Name] --nvarchar(4000) - Display name of sender
		  ,[replyto] --nvarchar(4000)
	  FROM-- [awsc-sql-02].[_Util].[dbo].[EmailLog]
	  (		SELECT 1 AS [ID] --int identity(1,1) - PK
				,GETDATE() AS [DT] --datetime - timestamp
				,0 AS [SPID] --int - SQL process ID
				,0 AS [Pre] --bit - indicates pre-send log
				,0 AS [Post] --bit - indicates post-send log
				,'' AS [From] --nvarchar(4000) - email address of sender
				,0 AS [MessageLenChars] -- int
				,'' AS [To] --nvarchar(4000)
				,'' AS [Subject] --nvarchar(4000)
				,'' AS [Server] --nvarchar(4000) - SMTP server used, optional
				,'' AS [Type] --MIME type of email content, usually text/html or text/plain
				,'' AS [CC] --nvarchar(4000)
				,'' AS [BCC] --nvarchar(4000)
				,'' AS [Attachment] --nvarchar(4000)
				,'' AS [Attachment_Name] --nvarchar(4000)
				,'' AS [MessageFile] --nvarchar(4000)
				,'' AS [From_Name] --nvarchar(4000) - Display name of sender
				,'' AS [replyto] --nvarchar(4000)
	  ) t
	  WHERE 1=0
GO

/****** Object:  UserDefinedFunction [dbo].[FloatToTime]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[FloatToTime] (
	@Time FLOAT
) RETURNS VARCHAR(10) AS

BEGIN

	DECLARE @out VARCHAR(10)

	SET @out = LTRIM(RIGHT(CONVERT(VARCHAR(20), CONVERT(DATETIME, '1/1/1900 ' + CONVERT(VARCHAR(2), CONVERT(INT, @Time)) + CASE WHEN CONVERT(INT, @Time) = @Time THEN ':00' ELSE ':30' END)), 7))

	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[fn_GetOverdueTasks_MultipleAssignees]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE  FUNCTION [dbo].[fn_GetOverdueTasks_MultipleAssignees] 
	(
	 @startDateParam datetime=null
    ,@endDateParam datetime=null
     
	)
RETURNS 
	@OverdueTasks TABLE 
		(
		[ActiveChecklistId] [bigint] NULL,
		TaskName varchar(max),
		Duetime datetime
		
		
		)
AS
BEGIN

	

	/*
    declare @enddate datetime 
	declare @startdate datetime
	--select @enddate = convert(varchar, dateadd(day, -1 * (datepart(dw, getdate()) - 2), getdate()), 101)
	--select @startdate = dateadd(day, -13, @enddate)
	--select @enddate = Isnull(@endDateParam,convert(varchar, dateadd(day,   -5, getdate()), 101))
	--select @startdate = Isnull(@startDateParam,dateadd(day, -1, @enddate))
	select @enddate = Isnull(@endDateParam,dateadd(day, datediff(day,'19000101',getdate()-1), CAST('23:59' AS DATETIME)))
	select @startdate = Isnull(@startDateParam,dateadd(day, datediff(day,'19000101',getdate()-1), CAST('00:00' AS DATETIME)))
	declare @overduedays int = 0
	--select @enddate as EndDate,@startdate as StartDate,@overduedays OverdueDays
  
	DECLARE @GPRUserID INT
	SELECT @GPRUserID = GPRUserID FROM QCheck_AppSettings WHERE ID = 1
	declare @people1 table(
		id int,
		name varchar(1000),
		email varchar(1000),
		tasks int default 0,
		overdue3 int default 0
	)



  insert into @people1 (id, name, email) 
   select U.[ID], U.FullName, U.email from QCheck_Users U
   inner join [tblEmployees] emp on emp.EmployeeId=U.empID
   Inner join [tbldepartment] dep on dep.DepartmentID=emp.DepartmentID
    where emp.IsActive=1 and U.IsDeleted = 0 
	and dep.Department in ('Risk Control','Strategic Planning','Foundation/PAC'
                                                                 ,'Compliance','Project Management','NNN','Real Estate'
																 ,'Trading','IT','Talent Architect', 'Q Development'
																 ,'Credit','Financial Control','Project Manager/10 Westover','10 Westover')
	and U.id not in  (@GPRUserID)--excluding GPR 
	and u.id not in (select userid from qcheck_overdue_exclude)
	and u.id not in (select userid from qcheck_bonususers 
						where isnull(startdt, '1/1/2021') < getdate()
							and isnull(enddt, '1/1/2500') > getdate()
					)

	declare @pendingExtensionRequests table
	(
	  activechecklistId int,
	  instanceId int,
	  extensionRequestDate datetime,
	  NewDueTime datetime
	)
	
	Insert into @pendingExtensionRequests(activechecklistId,instanceId,extensionRequestDate,NewDueTime)
	SELECT 
	chk.activechecklistId 
	,chk.InstanceID
	,CR.RequestDate
	,chk.DueTime
	
	FROM 
		QCheck_Approval_ChangeRequests CR
		inner join (
			SELECT 
				ac.ChangeRequestID, c.id, c.name, ci.ID AS InstanceID,AC.DueTime, ac.activechecklistid
			FROM  
				QCheck_Approval_ActiveChecklists AC
				INNER JOIN QCheck_ChecklistInstances CI
					ON AC.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
									
			UNION 

			SELECT
				I.ChangeRequestID,  I.ChecklistID, I.Name, -1 AS InstanceID,'', ac.ID
			FROM 
				QCheck_Approval_Checklists I
				INNER JOIN QCheck_ChecklistInstances CI
					ON I.ChecklistID = CI.[ChecklistID]
				INNER JOIN QCheck_ActiveChecklists AC
					ON AC.InstanceID = CI.ID
			where I.IsDeleted=1
		
		) AS chk
			ON chk.ChangeRequestID = cr.id
	WHERE
		CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		AND (CR.Approved = 0 or CR.ApprovedDate > @startdate)
		
	ORDER BY
		RequestDate


  declare @actable table(
		activechecklistid int
		,InstanceID int
	)
	insert into @actable
		select distinct dd.activechecklistid,aa.InstanceID from QStatus_DueDateChanges dd
		left join QCheck_ActiveChecklists_All aa on aa.ID=dd.ActiveChecklistID
		where DueDateOld between @startdate and @enddate
  

	insert into @actable
		select distinct id,InstanceID
		from QCheck_ActiveChecklists_All
		where DueTime between @startdate and @enddate
		and ID not in (select activechecklistid from @actable)


INSERT INTO  @OverdueTasks
           (
           [ActiveChecklistId],
		   TaskName,
		   Duetime
           )

select tasks.activechecklistid,tasks.Name,tasks.DueTime from
(select distinct u.ID as EmpId, at.activechecklistid ,ac.Name,dbo.[QCheck_ExplodedManagersList](ac.ID) as Controllers,dbo.[QCheck_AssigneesList_WithExplodedMembers](aca.InstanceID) as Assignees,
Isnull(ddc.DueDateOld,aca.DueTime) as DueTime,aca.CompletedDate,@enddate as EndDate,getdate() as RunDate,5 as Charge,1 as IsActive,0 as IsPaid

		from QCheck_Users u
		inner join QCheck_GroupMembership gm
			on gm.UserID = u.ID --and u.ID=652
		inner join QCheck_Groups g
			on g.ID = gm.GroupID --and g.SingleMemberGroup=1
		inner join QCheck_Assignments_All aa
			on aa.GroupID = g.ID
			and aa.IsDeleted=0
			and aa.DtAssigned < @startdate--need to uncomment
			and  aa.GroupID not in (select groupId from Qcheck_groups_nofines)--added by venkat 08/27/2018
		inner join QCheck_ActiveAssignments_All aaa
			on aaa.AssignmentsID = aa.ID
			
		inner join @actable at
			on at.activechecklistid = aaa.ActiveChecklistID
		inner join QCheck_ActiveChecklists_All aca
			on at.activechecklistid = aca.ID
		inner join QCheck_ChecklistInstances_All aci
			on at.InstanceID = aci.ID
			and aci.IsDeleted=0
			and aci.ID not in (select distinct ci.id from QCheck_ChecklistInstances ci
       inner join QCheck_Assignments a
              on ci.ID = a.InstanceID
              and a.IsDeleted = 0
       inner join qcheck_groups g
              on g.id = a.GroupID
       inner join QCheck_GroupMembership gm
              on gm.GroupID = g.id
       inner join qcheck_checklists cl
              on cl.id = ci.ChecklistID
              and cl.IsDeleted = 0
              and ci.IsDeleted = 0
       inner join QCheck_ChecklistManagers cm
              on cm.ChecklistID = cl.id
              and cm.IsDeleted = 0
       inner join qcheck_groups manGrp
              on manGrp.id = cm.ManagerGroupID
       inner join QCheck_GroupMembership manGM
              on manGm.GroupID = manGrp.id
              and manGm.UserID = gm.UserID
          )--added by venkat 07/13/2018 -- this condition is for controller not part of assignee
		inner join QCheck_Checklists_All ac
			on aci.ChecklistID = ac.ID
			and ac.IsDeleted=0
		LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = ac.id --and count(dbo.Util_Split(isnull(ccl.controllers, ''),','))=1
		--inner join  QCheck_Groups g1 on g1.Name=ccl.controllers --and g1.SingleMemberGroup=1
        LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on aa.InstanceID=al.InstanceID
		left outer join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID = aca.ID
				and ddc.UpdateDt > @startdate and (ddc.DueDateOld between @startdate and @enddate)
	  where 
	 -- CHARINDEX(',',isnull(ccl.controllers, ''))=0 --single controller
	 -- and isnull(Replace(al.assignees,'&nbsp;',' '),'')!=isnull(ccl.controllers, '')
	  --and 
	  ccl.controllers is not null and al.assignees is not null
	  and( (
			aca.CompletedDate is null
			and aca.DueTime < (@enddate - @overduedays)
			and aa.DtAssigned < (@enddate - @overduedays)
			and aca.archivedt is null
		) 
			or
		--completed more than x days after deadline
		(
			aca.DueTime < (aca.CompletedDate - @overduedays)
			and aa.DtAssigned < (aca.CompletedDate - @overduedays)
		)
	     or
		--deadline changed when x days overdue
		(
			ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
			and aa.DtAssigned < (ddc.UpdateDt - @overduedays)
		)
		)
	   and u.ID in(select id from @people1)
	   and at.activechecklistid not in (select activechecklistID from @pendingExtensionRequests where extensionRequestDate<=Isnull(ddc.DueDateOld,aca.DueTime))
	) tasks 
		order by tasks.Name


		*/
		
		


	RETURN 

END







GO
/****** Object:  UserDefinedFunction [dbo].[fn_MimeTextToBase64Images]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE function [dbo].[fn_MimeTextToBase64Images]
(
	@mimetext varchar(max)
)
RETURNS 
	@out TABLE 
		(
		imghtml varchar(max)
		)
as
begin
	select @mimetext = ltrim(rtrim(@mimetext))

	if len(@mimetext) = 0
	begin
		return 
	end

		declare @pointer int = 0
		declare @nextpointer int = 0
		declare @length int 
		declare @contenttype varchar(100) = ''
		declare @encoding varchar(100) = ''
		declare @imagedata varchar(max) = ''
		select @length = len(@mimetext)
  
		while @pointer < @length
		begin
			select @pointer = charindex('Content-Type: image', @mimetext, @pointer)
			if @pointer = 0 break;
	
			select @nextpointer = charindex(';',  @mimetext, @pointer)
			if @nextpointer = 0 break;
	
			select @contenttype = substring(@mimetext, @pointer + 14, @nextpointer-@pointer - 13)

			select @pointer = charindex('Content-Transfer-Encoding', @mimetext, @pointer)
			if @pointer = 0 break;

			select @nextpointer = charindex(char(13),  @mimetext, @pointer) 
			if @nextpointer = 0 break;

			select @encoding = substring(@mimetext, @pointer + 27, @nextpointer-@pointer-27)

			if @encoding = 'base64'
			begin
				select @pointer = charindex(char(13) + char(10) + char(13) + char(10),  @mimetext, @pointer) 
				if @pointer = 0 break;

				select @nextpointer = charindex(char(13) + char(10) + char(13) + char(10),  @mimetext, @pointer+4) 
				if @nextpointer = 0 set @nextpointer = @length

				select @imagedata =  substring(@mimetext, @pointer + 4, @nextpointer-@pointer-4)

				insert into @out select '<img src="data:'+@contenttype+@encoding+','+@imagedata+'"/>'
		
			end
		end



	/*declare @tablestring table (id int, data varchar(max))

	insert into @tablestring
	select id, replace(data, char(10), '') from dbo.Util_Split(@mimetext, char(13))

	declare @mode varchar(100) = 'searching for content type'

	declare @i int = 0
	declare @max int = (select max(id) from @tablestring)
	declare @thisline varchar(max) = ''
	declare @contenttype varchar(1000)
	declare @encoding varchar(1000)
	declare @imagedata varchar(max) = ''

	while @i <= @max
	begin
		select @i = @i + 1
		--select @thisline, @mode
		select @thisline = data from @tablestring
		where id = @i

		if @mode = 'searching for content type'
		begin
			if @thisline like '%Content-Type:%image%'
			begin	
				--select 'got content type'
				select @contenttype = replace(left(@thisline, charindex(';', @thisline)), 'Content-Type: ', '')
				select @mode = 'searching for encoding'
			end
		end
		else
		begin
			if @mode = 'searching for encoding' begin
				if @thisline like '%Content-Transfer-Encoding%'
				begin
					--select 'got encoding'
					select @encoding = replace(@thisline, 'Content-Transfer-Encoding: ', '')
					select @mode = 'searching for data'
				end
			end
			else
			begin
				if @mode = 'searching for data' begin
					--select @thisline, len(@thisline)
					if (ltrim(rtrim(replace(@thisline, char(10), ''))) = '')
					begin
						--select 'got blank'
						--if we already have data, then this is the end of the data, otherwise we have not started (there is a blank line)
						if @imagedata <> ''
						begin
							--start over
							--select @contenttype,@encoding,@imagedata, len(@imagedata)
							if @encoding = 'base64'
							begin
								insert into @out
								select '<img src="data:'+@contenttype+@encoding+','+@imagedata+'"/>'

							end
							select @mode =  'searching for content type'
							select @imagedata = ''
							select @contenttype = ''
							select @encoding = ''
						end
					end
					else
					begin
						select @imagedata = @imagedata + @thisline
					end
				end
			end
		end
	end*/

	return
end
GO
/****** Object:  UserDefinedFunction [dbo].[Grading_Daily_DeductionsTable]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
























CREATE            function [dbo].[Grading_Daily_DeductionsTable]
	(
	@UserID int,
	@GradingPeriodID int = null,
	@StartDt datetime = 0,
	@EndDt datetime = 0,
	@Now datetime
	)
RETURNS 
	@out TABLE 
		(
		dt datetime,
		reason varchar(2000),
		points float
		)
as
begin

	IF @GradingPeriodID is not null
	BEGIN
		SELECT @StartDt = StartDt,
			@EndDt = EndDt
		FROM Grading_Daily_GradingPeriod
		WHERE ID = @GradingPeriodID
	END
	ELSE
	BEGIN
		IF @EndDt = 0
			SELECT @StartDt = convert(varchar, @Now - day(@Now) + 1, 101),
				@EndDt = convert(varchar, @Now, 101)
	END


	DECLARE @ControllerDeduction float
	DECLARE @NonSupervisorControllerDeduction float
	DECLARE @SupervisorDeduction float
	DECLARE @InterestedParty float
	DECLARE @ControllerReportDeduction float
	DECLARE @SupervisorReportDeduction float
	DECLARE @OverdueDeduction float
	DECLARE @ChecklistOverdueDeduction float

	SELECT @NonSupervisorControllerDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'NonSupervisorController'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @ControllerDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'SupervisorController'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @SupervisorDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'Supervisor'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @ControllerReportDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'ControllerReportDeduction'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @SupervisorReportDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'SupervisorReportDeduction'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @OverdueDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'Overdue'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @ChecklistOverdueDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'ChecklistOverdue'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @InterestedParty = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'InterestedParty'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	INSERT INTO @out (dt, reason, points)
	SELECT  d.dt, 'Overdue Task On Status Report: ' + d.Description, @OverdueDeduction
	FROM Grading_Daily d
	left outer join Grading_Daily d2
	on d.userID = d2.userID
	AND d.Type = d2.type
	AND d.KeyID = d2.KeyID	
	AND d.dt = d2.dt + 1
	--AND d2.dt >= @StartDt
	--AND d2.dt <= @EndDt
	WHERE d2.ID is null
	AND d.UserID = @UserID
	AND d.Type = 'Status Overdue'
	AND d.dt >= @StartDt
	AND d.dt <= @EndDt

	INSERT INTO @out (dt, reason, points)
	SELECT d.dt, 'Overdue Checklist: ' + d.Description, @ChecklistOverdueDeduction
	FROM Grading_Daily d
	left outer join Grading_Daily d2
	on d.userID = d2.userID
	AND d.Type = d2.type
	AND d.KeyID = d2.KeyID	
	AND d.dt = d2.dt + 1
	--AND d2.dt >= @StartDt
	--AND d2.dt <= @EndDt
	WHERE d2.ID is null
	AND d.UserID = @UserID
	AND d.Type = 'Checklist Overdue'
	AND d.dt >= @StartDt
	AND d.dt <= @EndDt

	
	--controller deductions
	--look 2 days back from the start
	DECLARE @dt datetime
	SET @dt = @StartDt - 2

	--hold all the daily misses
	DECLARE @ALL table(
		dt datetime
	)
	
	--find how many consecutive
	DECLARE @CONS table(
		dt datetime,
		consecutive int,
		points float NULL
	)

	

	INSERT INTO @ALL 
	SELECT dt from Grading_Daily d
	left outer join Grading_Vacations v --dont include vacation days
	ON d.UserID = v.UserID
	AND d.dt <= v.EndDt
	AND d.dt >=v.StartDt
	AND v.Approved = 1
	WHERE d.Type = 'No Controller Comments'
	AND Dt >=@dt
	AND Dt <= @EndDt
	AND d.UserID = @UserID
	AND v.ID is null
	
	DECLARE @Pts float

	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN

		SET @Pts = @NonSupervisorControllerDeduction
		SELECT @Pts = @ControllerDeduction
		FROM Grading_Daily_UserReport
		WHERE UserID = @UserID
		AND dt = @dt
		AND Role = 'Supervisor'

		INSERT INTO @CONS (dt, consecutive, points)
		SELECT a.dt, isnull(c.consecutive, 0) + 1, @Pts
		FROM @All a
		LEFT OUTER JOIN @Cons c
		on c.dt = a.dt - 1
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	

	--only count the last one
	DELETE  @Cons
	FROM @Cons c
	INNER JOIN @All a
	ON c.dt = a.dt - 1

	DECLARE @ControllerDeductionsPts float
	SET @ControllerDeductionsPts = 0

	DELETE FROM @Cons Where Consecutive < 3

	INSERT INTO @OUT (dt, reason, points)
	SELECT 
		c.dt, 'No Controller Comments from ' + convert(varchar, dt - consecutive + 1, 101) + 
			' to ' +  convert(varchar, dt, 101), consecutive/3 * isnull(points, @ControllerDeduction)
	FROM @Cons c

	DELETE FROM @CONS
	DELETE FROM @ALL

	--same for supervisors

	SET @dt = @StartDt - 2

	
	INSERT INTO @ALL 
	SELECT d.dt from Grading_Daily d
	left outer join Grading_Vacations v --dont include vacation days
	ON d.UserID = v.UserID
	AND d.dt <= v.EndDt
	AND d.dt >=v.StartDt
	AND v.Approved = 1
	WHERE d.Type = 'No Supervisor Comments'
	AND d.Dt >=@dt
	AND d.Dt <= @EndDt
	AND d.UserID = @UserID
	AND v.ID is null

	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN
		INSERT INTO @CONS (dt, consecutive)
		SELECT a.dt, isnull(c.consecutive, 0) + 1
		FROM @All a
		LEFT OUTER JOIN @Cons c
		on c.dt = a.dt - 1
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	--only count the last one
	DELETE  @Cons
	FROM @Cons c
	INNER JOIN @All a
	ON c.dt = a.dt - 1

	DELETE FROM @Cons Where Consecutive < 3

	DECLARE @SupervisorDeductions int
	SET @SupervisorDeductions = 0


	INSERT INTO @OUT (dt, reason, points)
	SELECT 
		c.dt, 'No Supervisor Comments from ' + convert(varchar, dt - consecutive + 1, 101) + 
			' to ' +  convert(varchar, dt, 101), consecutive/3 * @SupervisorDeduction
	FROM @Cons c

	DELETE FROM @CONS
	DELETE FROM @ALL

	DECLARE @InterestedPartyComments int
	SET @InterestedPartyComments = 0

	insert into @out (dt, reason, points)
	SELECT c.commentDt, 'Interested Party Comment ('+r.Name+')',
		@InterestedParty
		FROM Grading_Daily_UserReport ur
		INNER JOIN Grading_Daily_Comments c
		ON c.UserReportID = ur.ID
		AND ur.dt >= @StartDt
		AND ur.dt <= @EndDt
		AND ur.Role = 'InterestedParty'
		AND ur.UserID = @UserID	
		INNER JOIN QStatus_Report r
		ON r.ID = ur.ReportID

	

	--controller report
	SET @dt = @StartDt - 9

	--hold all the daily misses
	DECLARE @ALLREPORT table(
		dt datetime,
		reportID int
	)
	
	--find how many consecutive
	DECLARE @CONSREPORT table(
		dt datetime,
		consecutive int,
		reportID int
	)

	INSERT INTO @ALLREPORT 
	SELECT d.dt, d.keyID from Grading_Daily d
	left outer join Grading_OnHold oh --reports on hold
	on (oh.UserID = d.UserID or oh.UserID is null)
	and oh.reportID = d.keyID
	and d.dt <= oh.EndDt
	and d.dt >= oh.StartDt
	AND oh.Approved = 1
	WHERE d.Type = 'No Controller Report Comments'
	AND d.Dt >=@dt
	AND d.Dt <= @EndDt
	AND d.UserID = @UserID
	AND oh.ID is null

	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN

		INSERT INTO @CONSREPORT (dt, consecutive, reportID)
		SELECT a.dt, isnull(c.consecutive, 0) + 1, a.reportID
		FROM @ALLREPORT a
		LEFT OUTER JOIN @CONSREPORT c
		on c.dt = a.dt - 1
		and a.reportID = c.reportID
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	--only count the last one
	DELETE  @CONSREPORT
	FROM @CONSREPORT c
	INNER JOIN @ALLREPORT a
	ON c.dt = a.dt - 1
	and a.reportID = c.reportID

	
	DELETE FROM @CONSREPORT 
	WHERE consecutive < 10

	INSERT INTO @OUT (dt, reason, points)
	SELECT 
		c.dt, 'No Controller Comments On Report ('+r.name+') from ' + convert(varchar, dt - consecutive + 1, 101) + 
			' to ' +  convert(varchar, dt, 101), (consecutive-9) * @SupervisorReportDeduction
	FROM @CONSREPORT c
	inner join qstatus_report r
	on r.id = c.reportID



	DELETE FROM @CONSREPORT
	DELETE FROM @ALLREPORT


	
	--supervisor report
	SET @dt = @StartDt - 9


	INSERT INTO @ALLREPORT 
	SELECT d.dt, d.keyID from Grading_Daily d
	left outer join Grading_OnHold oh --reports on hold
	on (oh.UserID = d.UserID or oh.UserID is null)
	and oh.reportID = d.keyID
	and d.dt <= oh.EndDt
	and d.dt >= oh.StartDt
	AND oh.Approved = 1
	WHERE Type = 'No Report Supervisor Comments'
	AND d.Dt >=@dt
	AND d.Dt <= @EndDt
	AND d.UserID = @UserID
	AND oh.ID is null

	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN

		INSERT INTO @CONSREPORT (dt, consecutive, reportID)
		SELECT a.dt, isnull(c.consecutive, 0) + 1, a.reportID
		FROM @ALLREPORT a
		LEFT OUTER JOIN @CONSREPORT c
		on c.dt = a.dt - 1
		and a.reportID = c.reportID
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	

	--only count the last one
	DELETE  @CONSREPORT
	FROM @CONSREPORT c
	INNER JOIN @ALLREPORT a
	ON c.dt = a.dt - 1
	and a.reportID = c.reportID
	
	DELETE FROM @CONSREPORT 
	WHERE consecutive < 10

	INSERT INTO @OUT (dt, reason, points)
	SELECT 
		c.dt, 'No Supervisor Comments On Report ('+r.name+') from ' + convert(varchar, dt - consecutive + 1, 101) + 
			' to ' +  convert(varchar, dt, 101), (consecutive-9) * @SupervisorReportDeduction
	FROM @CONSREPORT c
	inner join qstatus_report r
	on r.id = c.reportID
	
	RETURN

end
























GO
/****** Object:  UserDefinedFunction [dbo].[NextDue_ByChecklistID]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




create  FUNCTION [dbo].[NextDue_ByChecklistID] (
	@ChecklistID INT,
	@Now DATETIME
) RETURNS DATETIME AS

BEGIN

	DECLARE @NextDue AS DATETIME
	
	SELECT
		@NextDue = MIN(ac.DueTime)
	FROM
		qcheck_checklists c
		INNER JOIN qcheck_checklistinstances ci
			ON c.id = ci.checklistid
		INNER JOIN qcheck_activechecklists ac
			ON ac.instanceid = ci.id
	WHERE
		ac.DUETIME > @Now
		AND ac.CompletedDate IS NULL
		AND c.IsDeleted = 0
		AND ci.IsDeleted = 0
		AND c.id = @ChecklistID
	
	IF @NextDue IS NULL BEGIN
	
		SELECT
			@NextDue = MIN(udt.DueTime) 
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON c.id = ci.checklistid
			INNER JOIN QCheck_UpcomingDueTimes udt
					ON udt.instanceid = ci.id
		WHERE
			udt.DueTime > @Now
			AND c.IsDeleted = 0
			AND ci.IsDeleted = 0
			AND c.id = @ChecklistID
	
	END
	
	RETURN @NextDue

END





GO
/****** Object:  UserDefinedFunction [dbo].[OCCURS]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE function [dbo].[OCCURS]  (@cSearchExpression nvarchar(4000), @cExpressionSearched nvarchar(4000))
returns smallint
as
    begin
      declare @start_location smallint,  @occurs  smallint
      select  @start_location = charindex(@cSearchExpression COLLATE Latin1_General_BIN, @cExpressionSearched COLLATE Latin1_General_BIN),   @occurs = 0

     while @start_location > 0
          select  @occurs = @occurs + 1,  @start_location  = charindex(@cSearchExpression COLLATE Latin1_General_BIN, @cExpressionSearched COLLATE Latin1_General_BIN, @start_location+1)
    
     return  @occurs
    end
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ActiveAssigneeUserIDList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_ActiveAssigneeUserIDList] (
	@ActiveChecklistID INT
) RETURNS VARCHAR(1000) AS

BEGIN

	DECLARE @Out VARCHAR(1000)
	SET @Out = '|'

	SELECT 
		@Out = @Out + CONVERT(VARCHAR(20), u.ID) + '|'
	FROM 
		QCheck_ActiveAssignments aa
		INNER JOIN QCheck_Assignments a
			ON aa.AssignmentsID = a.ID
		INNER JOIN QCheck_Groups g
			ON a.GroupID = g.ID
			AND a.IsDeleted = 0
		INNER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.ID
			AND u.IsDeleted = 0
	WHERE 
		aa.ActiveChecklistID = @ActiveChecklistID

	RETURN @Out
	
END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AlerteesList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

















CREATE         FUNCTION [dbo].[QCheck_AlerteesList]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM
(SELECT DISTINCT g.Name
FROM 
	QCheck_Alerts a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.AlerteeGroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID) a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)
--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END


















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AlertString]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_AlertString] (
	@ID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN AlertType = 'Reminder' AND AlertTime >= 0 THEN 'Reminder to assignees ' + CONVERT(VARCHAR(10), DaysBefore) + ' day(s) before due at ' + dbo.FloatToTime(AlertTime)
			WHEN AlertType = 'Reminder' AND AlertTime < 0 THEN 'Reminder to assignees ' + CONVERT(VARCHAR(10), AlertTime * -1) + ' hour(s) before due'
			WHEN AlertType = 'Complete' THEN 'Email ' + G.[Name] + ' when complete'
			WHEN AlertType = 'Assignment' THEN 'Email ' + G.[Name] + ' when assignments are changed'
			WHEN AlertType = 'Overdue' THEN 'Email ' + G.[Name] + ' when task goes overdue'
			WHEN AlertType = 'Hours' AND CHARINDEX('.', CONVERT(VARCHAR(20), AlertTime)) > 0 THEN 'Email ' + G.[Name] + ' every ' + CONVERT(VARCHAR(10), CONVERT(INT, AlertTime * 60)) + ' minutes after task goes overdue' + CASE WHEN LEN(ISNULL(AlertText, '')) > 0 THEN ' with the message "' + AlertText + '"' ELSE '' END
			WHEN AlertType = 'Hours' AND CHARINDEX('.', CONVERT(VARCHAR(20), AlertTime)) = 0 THEN 'Email ' + G.[Name] + ' every ' + CONVERT(VARCHAR(10), CONVERT(INT, AlertTime)) + ' hours after task goes overdue' + CASE WHEN LEN(ISNULL(AlertText, '')) > 0 THEN ' with the message "' + AlertText + '"' ELSE '' END
			WHEN AlertType = 'Schedule' THEN 'Email ' + G.[Name] + ' when the schedule is edited'
			WHEN AlertType = 'Custom' THEN 'Email ' + G.[Name] + ' ' + CONVERT(VARCHAR(10), DaysBefore) + ' day(s) before due at ' + dbo.FloatToTime(AlertTime) + ' with the message "' + ISNULL(AlertText, '') + '"'
		END
	FROM 
		QCheck_Alerts A
		LEFT OUTER JOIN QCheck_Groups G
			ON A.AlerteeGroupID = G.[ID]
	WHERE
		A.[ID] = @ID
	
	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_AlertString]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_Approval_AlertString] (
	@ID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN AlertType = 'Reminder' AND AlertTime >= 0 THEN 'Reminder to assignees ' + CONVERT(VARCHAR(10), DaysBefore) + ' day(s) before due at ' + dbo.FloatToTime(AlertTime)
			WHEN AlertType = 'Reminder' AND AlertTime < 0 THEN 'Reminder to assignees ' + CONVERT(VARCHAR(10), AlertTime * -1) + ' hour(s) before due'
			WHEN AlertType = 'Complete' THEN 'Email ' + G.[Name] + ' when complete'
			WHEN AlertType = 'Assignment' THEN 'Email ' + G.[Name] + ' when assignments are changed'
			WHEN AlertType = 'Overdue' THEN 'Email ' + G.[Name] + ' when task goes overdue'
			WHEN AlertType = 'Hours' AND CHARINDEX('.', CONVERT(VARCHAR(20), AlertTime)) > 0 THEN 'Email ' + G.[Name] + ' every ' + CONVERT(VARCHAR(10), CONVERT(INT, AlertTime * 60)) + ' minutes after task goes overdue' + CASE WHEN LEN(ISNULL(AlertText, '')) > 0 THEN ' with the message "' + AlertText + '"' ELSE '' END
			WHEN AlertType = 'Hours' AND CHARINDEX('.', CONVERT(VARCHAR(20), AlertTime)) = 0 THEN 'Email ' + G.[Name] + ' every ' + CONVERT(VARCHAR(10), CONVERT(INT, AlertTime)) + ' hours after task goes overdue' + CASE WHEN LEN(ISNULL(AlertText, '')) > 0 THEN ' with the message "' + AlertText + '"' ELSE '' END
			WHEN AlertType = 'Schedule' THEN 'Email ' + G.[Name] + ' when the schedule is edited'
			WHEN AlertType = 'Custom' THEN 'Email ' + G.[Name] + ' ' + CONVERT(VARCHAR(10), DaysBefore) + ' day(s) before due at ' + dbo.FloatToTime(AlertTime) + ' with the message "' + ISNULL(AlertText, '') + '"'
		END
	FROM 
		QCheck_Approval_Alerts A
		LEFT OUTER JOIN QCheck_Groups G
			ON A.AlerteeGroupID = G.[ID]
	WHERE
		A.[ID] = @ID
	
	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_AssigneesList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[QCheck_Approval_AssigneesList]
(
	@ChangeID INT,
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
(
	SELECT DISTINCT g.Name
	FROM QCheck_Assignments a
	LEFT JOIN QCheck_Approval_Assignments aa
		ON aa.ChangeRequestID = @ChangeID
		AND aa.AssignmentID = a.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = a.GroupID
	INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = g.ID
	WHERE a.IsDeleted = 0
		AND (aa.IsDeleted IS NULL OR aa.IsDeleted = 0)
		AND a.InstanceID = @InstanceID
	UNION
	SELECT DISTINCT g.Name
	FROM QCheck_Approval_Assignments aa
	INNER JOIN QCheck_Groups g
		ON g.ID = aa.GroupID
	INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = g.ID
	WHERE aa.ChangeRequestID = @ChangeID
		AND aa.IsDeleted = 0
		AND aa.AssignmentID = -1 --new
		AND aa.InstanceID = @InstanceID
)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_CRChecklistID]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  FUNCTION [dbo].[QCheck_Approval_CRChecklistID] (
	@ChangeID INT
) RETURNS INT AS

BEGIN

	DECLARE @ChecklistID INT

	-- If the change request was a simple due date change, there will be row(s) in QCheck_Approval_ActiveChecklists	
	SELECT
		@ChecklistID = C.[ID]
	FROM 
		QCheck_Approval_ActiveChecklists AC
		INNER JOIN QCheck_ChecklistInstances CI
			ON AC.InstanceID = CI.[ID]
		INNER JOIN QCheck_Checklists C
			ON CI.ChecklistID = C.[ID]
	WHERE
		AC.ChangeRequestID = @ChangeID	
	

	
	
	-- If the change request came from the Tasks I Control tab, the QCheck_Approval_Items table will contain rows for the change.
	IF @ChecklistID IS NULL BEGIN

		SELECT
			@ChecklistID = C.[ID]
		FROM 
			QCheck_Approval_Items I
			INNER JOIN QCheck_Checklists C
				ON I.ChecklistID = C.[ID]
		WHERE 
			I.ChangeRequestID = @ChangeID

	END
	
	
	-- If the change request was a simple assignment change, there will be row(s) in QCheck_Approval_Assignments
	IF @ChecklistID IS NULL BEGIN
	
		SELECT
			@ChecklistID = C.[ID]
		FROM 
			QCheck_Approval_Assignments A
			INNER JOIN QCheck_ChecklistInstances CI
				ON A.InstanceID = CI.[ID]
			INNER JOIN QCheck_Checklists C
				ON CI.ChecklistID = C.[ID]
		WHERE
			A.ChangeRequestID = @ChangeID
	
	END

	-- Return the checklist ID
	RETURN @ChecklistID

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_CRChecklistName]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_Approval_CRChecklistName] (
	@ChangeID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @ChecklistName VARCHAR(500)
	
	-- If the change request came from the Tasks I Control tab, the QCheck_Approval_Items table will contain rows for the change.
	SELECT
		@ChecklistName = C.[Name]
	FROM 
		QCheck_Approval_Items I
		INNER JOIN QCheck_Checklists C
			ON I.ChecklistID = C.[ID]
	WHERE 
		I.ChangeRequestID = @ChangeID
	
	-- If the change request was a simple due date change, there will be row(s) in QCheck_Approval_ActiveChecklists
	IF @ChecklistName IS NULL BEGIN
	
		SELECT
			@ChecklistName = C.[Name]
		FROM 
			QCheck_Approval_ActiveChecklists AC
			INNER JOIN QCheck_ChecklistInstances CI
				ON AC.InstanceID = CI.[ID]
			INNER JOIN QCheck_Checklists C
				ON CI.ChecklistID = C.[ID]
		WHERE
			AC.ChangeRequestID = @ChangeID	
	
	END
	
	-- If the change request was a simple assignment change, there will be row(s) in QCheck_Approval_Assignments
	IF @ChecklistName IS NULL BEGIN
	
		SELECT
			@ChecklistName = C.[Name]
		FROM 
			QCheck_Approval_Assignments A
			INNER JOIN QCheck_ChecklistInstances CI
				ON A.InstanceID = CI.[ID]
			INNER JOIN QCheck_Checklists C
				ON CI.ChecklistID = C.[ID]
		WHERE
			A.ChangeRequestID = @ChangeID
	
	END

	-- Return the checklist name
	RETURN @ChecklistName

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_CRInstanceID]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_Approval_CRInstanceID] (
	@ChangeID INT
) RETURNS INT AS

BEGIN

	DECLARE @InstanceID INT

	-- First check the obvious, see if there's a row in QCheck_Approval_ChecklistInstances
	SELECT 
		@InstanceID = InstanceID
	FROM
		QCheck_Approval_ChecklistInstances
	WHERE
		ChangeRequestID = @ChangeID

	-- If the change request was a simple due date change, there will be row(s) in QCheck_Approval_ActiveChecklists	
	IF @InstanceID IS NULL BEGIN

		SELECT
			@InstanceID = CI.[ID]
		FROM 
			QCheck_Approval_ActiveChecklists AC
			INNER JOIN QCheck_ChecklistInstances CI
				ON AC.InstanceID = CI.[ID]
		WHERE
			AC.ChangeRequestID = @ChangeID		

	END
	
	-- If the change request was a simple assignment change, there will be row(s) in QCheck_Approval_Assignments
	IF @InstanceID IS NULL BEGIN
	
		SELECT
			@InstanceID = CI.[ID]
		FROM 
			QCheck_Approval_Assignments A
			INNER JOIN QCheck_ChecklistInstances CI
				ON A.InstanceID = CI.[ID]
		WHERE
			A.ChangeRequestID = @ChangeID

	END

	-- Check for an instance ID on an alert change
	IF @InstanceID IS NULL BEGIN

		SELECT
			@InstanceID = A.InstanceID
		FROM
			QCheck_Approval_Alerts A
		WHERE
			A.ChangeRequestID = @ChangeID

	END

	-- If the change request came from the Tasks I Control tab, the QCheck_Approval_Items table will contain rows for the change.  Grab an
	-- instance ID off the checklist -- at this point there's no indicator of which instance the change was for, it was at the checklist level
	IF @InstanceID IS NULL BEGIN

		SELECT
			@InstanceID = CI.[ID]
		FROM 
			QCheck_Approval_Items I
			INNER JOIN QCheck_Checklists C
				ON I.ChecklistID = C.[ID]
			INNER JOIN QCheck_ChecklistInstances CI
				ON C.ID = CI.ChecklistID
		WHERE 
			I.ChangeRequestID = @ChangeID

	END

	-- Return the instance ID
	RETURN @InstanceID

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_ExtensionCount]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[QCheck_Approval_ExtensionCount] 
(
	@Crid int
) returns int
as
begin

	declare @count int 

	select @count = count(cr2.id) 
	from QCheck_Approval_ChangeRequests cr
		left outer join QCheck_Approval_ActiveChecklists ac
			on ac.ChangeRequestID = cr.ID
		left outer join QCheck_Approval_ActiveChecklists ac2
			on ac2.id <= ac.id
			and ac2.ActiveChecklistID = ac.ActiveChecklistID
		left outer join QCheck_Approval_ChangeRequests cr2
			on cr2.id = ac2.ChangeRequestID
			and (
				cr.id = cr2.id
				or
				(
					cr2.approved = 1
					and cr2.approveddate < cr.requestdate
				)
			)
	where cr.id = @crid

	return @count

end
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_ExtensionLength]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[QCheck_Approval_ExtensionLength]
(
	@Crid int
) returns int
as
begin

	declare @days int = 0

	select @days = datediff(day, origduetime, duetime) 
	from QCheck_Approval_ActiveChecklists
	where ChangeRequestID = @crid

	return @days

end
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_Approval_ScheduleString]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  FUNCTION [dbo].[QCheck_Approval_ScheduleString] (
	@ChangeID INT,
	@ScheduleID INT, 
	@InstanceID INT = NULL
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN FreqType = 1 THEN 'One Time'
			ELSE
				CASE
					WHEN FreqType = 2 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' day(s)'
					WHEN FreqType = 3 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' week(s) on ' + dbo.QCheck_WeeklyIntervalString(FreqInterval)
					WHEN FreqType = 4 THEN 
						CASE
							WHEN FreqRecurrance = 3 THEN 'Quarterly'
							ELSE 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' month(s)'
						END
					WHEN FreqType = 5 THEN 'Yearly in ' + dbo.QCheck_YearlyIntervalString(FreqInterval)
				END
		END +
		CASE
			WHEN LastDueDate IS NULL THEN CASE WHEN FreqType <> 1 THEN ' starting' ELSE '' END + ' on ' + CONVERT(VARCHAR(10), FirstDueDate, 101) 
			ELSE ' from ' + CONVERT(VARCHAR(10), FirstDueDate, 101) + ' to ' + CONVERT(VARCHAR(10), LastDueDate, 101)
		END +
		' at ' + dbo.FloatToTime(DueTime) +
		CASE
			WHEN BusDayBehavior = 0 AND FreqType <> 1 THEN ', due weekends/holidays'
			WHEN BusDayBehavior = 1 AND FreqType <> 1 THEN ', skip weekends/holidays'
			WHEN BusDayBehavior = 2 AND FreqType <> 1 THEN ', prev bus. day for weekends/holidays'
			WHEN BusDayBehavior = 3 AND FreqType <> 1 THEN ', next bus. day for weekends/holidays'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(SoftDueOffsetDays, 0) > 0 THEN ', soft due ' + CONVERT(VARCHAR(5), SoftDueOffsetDays) + ' days before deadline'
			ELSE ''
		END
	FROM 
		QCheck_Approval_Schedule
	WHERE
		ChangeRequestID = @ChangeID
		AND ScheduleID = @ScheduleID
		AND (InstanceID = @InstanceID OR @InstanceID IS NULL OR @ScheduleID <> -1)
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneeCountByInstance]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create          FUNCTION [dbo].[QCheck_AssigneeCountByInstance]
(
	@instanceid INT
)
RETURNS int
AS
BEGIN

	return (
		select COUNT(distinct u.ID) from QCheck_Assignments a
		inner join QCheck_GroupMembership gm
			on a.IsDeleted = 0
			and a.GroupID = gm.GroupID
		inner join QCheck_Groups g
			on g.ID = gm.GroupID
		inner join QCheck_Users u
			on u.IsDeleted = 0
			and u.ID = gm.UserID
		inner join QCheck_ChecklistInstances ci
			on ci.ID = a.InstanceID
			and ci.IsDeleted = 0
		inner join QCheck_Checklists c
			on c.ID = ci.ChecklistID
			and c.IsDeleted = 0
		where ci.ID = @instanceid
	)

END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesEmailList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















create          FUNCTION [dbo].[QCheck_AssigneesEmailList]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + email + ';'
FROM 
(SELECT DISTINCT u.Email
FROM
	QCheck_Assignments a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.GroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
INNER JOIN QCheck_Users u
	on gm.userid = u.id
	and u.IsDeleted = 0
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID)  a

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















CREATE          FUNCTION [dbo].[QCheck_AssigneesList]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_Assignments a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.GroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesList_One]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




















CREATE            FUNCTION [dbo].[QCheck_AssigneesList_One]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = fullName 
FROM 
(SELECT DISTINCT u.fullName 
FROM
	QCheck_Assignments a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.GroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
INNER JOIN QCheck_Users u
	on u.id = gm.userid
	and u.isdeleted = 0
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
--SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END





















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesList_WithArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















CREATE          FUNCTION [dbo].[QCheck_AssigneesList_WithArchive]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_Assignments_All a
INNER JOIN
	(select * from QCheck_Groups union all select * from QCheck_GroupArchive) g
ON
	g.ID = a.GroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesList_WithExplodedMembers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















Create          FUNCTION [dbo].[QCheck_AssigneesList_WithExplodedMembers]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + [dbo].[QCheck_GroupMemberList_With_GroupName] (Name) + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_Assignments a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.GroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesList_WithOverdueLinks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_AssigneesList_WithOverdueLinks]
(
	@InstanceID INT,
	@AppURL VARCHAR(50)
)
RETURNS VARCHAR(2000)
AS
BEGIN


DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
	(
		SELECT DISTINCT 
			CASE
				WHEN g.SingleMemberGroup = 1 THEN '<a href="' + ISNULL(@AppURL, '') + '/Reports.aspx?oid=' + CONVERT(VARCHAR(10), gm.UserID) + '">' + g.Name + '</a>'
				ELSE g.Name 
			END AS Name
		FROM
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
		WHERE
			a.IsDeleted = 0
			AND a.InstanceID = @InstanceID
	)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_AssigneesListSplitGroups]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















create          FUNCTION [dbo].[QCheck_AssigneesListSplitGroups]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
(SELECT DISTINCT dbo.qcheck_groupsplit(g.ID) as name
FROM
	QCheck_Assignments a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.GroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID)  a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ChecklistControllerEmails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_ChecklistControllerEmails] (
	@ChecklistID INT,
	@ControllerUserID INT = NULL
) RETURNS VARCHAR(5000) AS

BEGIN

	DECLARE @EmailList VARCHAR(5000)
	
	SET @EmailList = ''
	
	SELECT 
		@EmailList = @EmailList + ISNULL(u.Email + ';', '')
	FROM
		QCheck_ChecklistManagers cm
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.[ID] <> ISNULL(@ControllerUserID, -1) -- Match all when no user ID is passed in
	
	RETURN @EmailList

END


GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ChecklistControllerEmailsWithoutDuplicates]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[QCheck_ChecklistControllerEmailsWithoutDuplicates] (
	@ChecklistID INT,
	@ControllerUserID INT = NULL,
	@Duplicates varchar(1000) = ''
) RETURNS VARCHAR(5000) AS

BEGIN

	DECLARE @EmailList VARCHAR(5000)
	
	SET @EmailList = ''
	
	SELECT 
		@EmailList = @EmailList + ISNULL(u.Email + ';', '')
	FROM
		QCheck_ChecklistManagers cm
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.[ID] <> ISNULL(@ControllerUserID, -1) -- Match all when no user ID is passed in
		AND @Duplicates not like '%' + u.Email + '%' -- check to make sure that this isn't sending to an email that is already in the email chain
	
	RETURN @EmailList

END


GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ChecklistExtensionControllerEmails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[QCheck_ChecklistExtensionControllerEmails] (
	@ChecklistID INT,
	@ControllerUserID INT = NULL
) RETURNS VARCHAR(5000) AS

BEGIN

	DECLARE @EmailList VARCHAR(5000)
	
	SET @EmailList = ''
	
	SELECT 
		@EmailList = @EmailList + ISNULL(u.Email + ';', '')
	FROM
		QCheck_ChecklistManagers cm
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.[ID]
		LEFT OUTER JOIN QCheck_ExtensionRequest_Exclude e
			on u.ID = e.ID
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.[ID] <> ISNULL(@ControllerUserID, -1) -- Match all when no user ID is passed in
		AND e.ID is null --for those who do not get extension request emails
	
	RETURN @EmailList

END


GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_DueDateAsOf]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO















create        FUNCTION [dbo].[QCheck_DueDateAsOf]
(
	@AsOfDate datetime,
	@ActiveChecklistID INT
)
RETURNS datetime
AS
BEGIN

	DECLARE @MinNextUpdated datetime
	DECLARE @DueDate datetime

	SELECT @MinNextUpdated = min(updatedt)
	FROM QStatus_DueDateChanges
	WHERE ActiveChecklistID = @ActiveChecklistID
	AND UpdateDt > @AsOfDate

	IF @MinNextUpdated is not null
	BEGIN
		
		SELECT @DueDate = DueDateOld
		FROM QStatus_DueDateChanges
		WHERE ActiveChecklistID = @ActiveChecklistID
		AND UpdateDt = @MinNextUpdated
	END
	ELSE
	BEGIN
		SELECT @DueDate = DueTime
		FROM QCheck_ActiveChecklists
		WHERE ID = @ActiveChecklistID
	END
	
	IF @DueDate is null
		SELECT @DueDate = DueTime
		FROM QCheck_ActiveChecklistArchive
		WHERE ID = @ActiveChecklistID

	RETURN @DueDate

END
















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ExplodedManagersList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO















CREATE          FUNCTION [dbo].[QCheck_ExplodedManagersList]
(
	@ChecklistID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
		@members = @members + [dbo].[QCheck_GroupMemberList_With_GroupName] (Name) + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_ChecklistManagers a
INNER JOIN
	--(select * from QCheck_Groups union all select * from QCheck_GroupArchive)  g
	(select * from QCheck_Groups)  g
ON
	g.ID = a.ManagerGroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.ChecklistID = @ChecklistID) a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)
--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END




















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_FullAssigneesList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE            FUNCTION [dbo].[QCheck_FullAssigneesList]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + replace(g.Name, ' ', '&nbsp;') + ', '
FROM 
	QCheck_Groups g
INNER JOIN
	QCheck_Assignments a
ON
	a.GroupID = g.ID
AND
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID


SELECT 
	@members = @members + replace(g.Name, ' ', '&nbsp;') + ', '
FROM 
	QCheck_Groups g
INNER JOIN
	QCheck_AssignmentArchive a
ON
	a.GroupID = g.ID
AND
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID 


IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

RETURN @members
END





















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_FullAssigneesList_new]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




















CREATE             FUNCTION [dbo].[QCheck_FullAssigneesList_new]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @members varchar(2000)
set @members = ''

SELECT @members = @members + g.name + '; '
FROM Qcheck_Assignments a
INNER JOIN QCheck_Groups g
ON a.groupid = g.ID
AND a.InstanceID = @InstanceID

RETURN @members
END





















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_FullAssigneesListArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE function [dbo].[QCheck_FullAssigneesListArchive]
(
	@instanceId int
)
returns varchar(2000)
as
begin
	declare @members varchar(2000) = ''

	select 
		@members = @members + replace(g.Name, ' ', '&nbsp;') + ', '
	from 
		QCheck_GroupArchive g with (nolock)
	inner join
		QCheck_AssignmentArchive a with (nolock)
	on
		a.GroupID = g.ID and
		a.InstanceID = @InstanceID

	if @members = ''
		set @members = dbo.QCheck_FullAssigneesList(@instanceId)

	return @members
end
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_FullAssigneesListWithSpaces]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create            FUNCTION [dbo].[QCheck_FullAssigneesListWithSpaces]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + g.Name + ', '
FROM 
	QCheck_Groups g
INNER JOIN
	QCheck_Assignments a
ON
	a.GroupID = g.ID
AND
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID


SELECT 
	@members = @members + g.Name + ', '
FROM 
	QCheck_Groups g
INNER JOIN
	QCheck_AssignmentArchive a
ON
	a.GroupID = g.ID
AND
	a.IsDeleted = 0
AND
	a.InstanceID = @InstanceID 


IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)

RETURN @members
END





















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_FullCommentsListByChecklistID]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  FUNCTION [dbo].[QCheck_FullCommentsListByChecklistID]
(
	@checklistid int
)
RETURNS VARCHAR(max)
AS
BEGIN

	declare @comments varchar(max) = ''
	
	select @comments = @comments +  
	case when tabin > 0 then '   ' else '' end +
	case when tabin > 1 then '   ' else '' end +
	case when tabin > 2 then '   ' else '' end +
	case when tabin > 3 then '   ' else '' end +
	case when tabin > 4 then '   ' else '' end +
	case when tabin > 5 then '   ' else '' end +
	case when tabin > 6 then '   ' else '' end +
	case when tabin > 7 then '   ' else '' end +
	case when tabin > 8 then '   ' else '' end +
	case when tabin > 9 then '   ' else '' end +
	case when tabin > 10 then '   ' else '' end +

	'[' +convert(varchar, commentdt, 101)+ '] '+
	'[' +c.initials+ '] '+
	replace(comments, '<br>', CHAR(13)+CHAR(10)) + CHAR(13)+CHAR(10)
	from qstatus_comments_all c
		inner join qcheck_activechecklists_all ac
			on c.foreignkeyid = ac.id
			and c.specialtask = 0
		inner join qcheck_checklistinstances_all i
			on i.id = ac.instanceid
			and i.checklistid = @checklistid
	where commentdt > '1/1/2017'
	and commentdt < '7/1/2017'
	order by ac.id, displayorder


RETURN @comments
END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_FullCommentsListByForeignKeyID]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create  FUNCTION [dbo].[QCheck_FullCommentsListByForeignKeyID]
(
	@foreignkeyid int,
	@specialtask bit
)
RETURNS VARCHAR(max)
AS
BEGIN

	declare @comments varchar(max) = ''
	
	select @comments = @comments +  
	case when tabin > 0 then '   ' else '' end +
	case when tabin > 1 then '   ' else '' end +
	case when tabin > 2 then '   ' else '' end +
	case when tabin > 3 then '   ' else '' end +
	case when tabin > 4 then '   ' else '' end +
	case when tabin > 5 then '   ' else '' end +
	case when tabin > 6 then '   ' else '' end +
	case when tabin > 7 then '   ' else '' end +
	case when tabin > 8 then '   ' else '' end +
	case when tabin > 9 then '   ' else '' end +
	case when tabin > 10 then '   ' else '' end +

	'[' +convert(varchar, commentdt, 101)+ '] '+
	'[' +c.initials+ '] '+
	comments + CHAR(13)+CHAR(10)
	from qstatus_comments_all c
	where foreignkeyid = @foreignkeyid
	and specialtask = @specialtask
	order by displayorder

RETURN @comments
END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GetChecklistAssignees]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  FUNCTION [dbo].[QCheck_GetChecklistAssignees] (
	@ChecklistID INT
) RETURNS VARCHAR(1000) AS

BEGIN

	DECLARE @ReturnString VARCHAR(1000)
	SET @ReturnString = ''
	
	SELECT 
		@ReturnString = @ReturnString + g.[Name] + ', '
	from 
	(SELECT Distinct g.Name 
	FROM
		QCheck_Assignments a
		INNER JOIN QCheck_Groups g
			ON g.ID = a.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
		INNER JOIN QCheck_ChecklistInstances ci
			ON a.InstanceID = ci.[ID]
	WHERE
		a.IsDeleted = 0
		AND ci.IsDeleted = 0
		AND ci.ChecklistID = @ChecklistID) g
	
	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)	
	RETURN @ReturnString

END


GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GetDaysFromInterval]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE          FUNCTION [dbo].[QCheck_GetDaysFromInterval]
(
	@Interval INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @IntString VARCHAR(2000)

SET @IntString = CASE WHEN @Interval & 1 = 1 THEN 'Sunday' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 2 = 2 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'Monday' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 4 = 4 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'Tuesday' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 8 = 8 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'Wednesday' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 16 = 16 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'Thursday' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 32 = 32 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'Friday' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 64 = 64 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'Saturday' ELSE '' END

RETURN @IntString
END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GetMonthsFromInterval]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE          FUNCTION [dbo].[QCheck_GetMonthsFromInterval]
(
	@Interval INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @IntString VARCHAR(2000)

SET @IntString = CASE WHEN @Interval & 1 = 1 THEN 'January' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 2 = 2 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'February' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 4 = 4 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'March' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 8 = 8 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'April' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 16 = 16 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'May' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 32 = 32 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'June' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 64 = 64 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'July' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 128 = 128 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'August' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 256 = 256 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'September' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 512 = 512 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'October' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 1024 = 1024 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'November' ELSE '' END
SET @IntString = @IntString + CASE WHEN @Interval & 2048 = 2048 THEN CASE WHEN len(@IntString) > 0 THEN ', ' ELSE '' END + 'December' ELSE '' END

RETURN @IntString
END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GroupMemberList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_GroupMemberList] (
	@GroupID INT
) RETURNS VARCHAR(8000) AS

BEGIN

	DECLARE @out VARCHAR(8000)
	
	SET @out = ''
	SELECT
		@out = @out + U.FullName + ', '
	FROM
		QCheck_GroupMembership GM
		INNER JOIN QCheck_Users U
			ON U.[ID] = GM.UserID
	WHERE
		GM.GroupID = @GroupID
	ORDER BY
		U.FullName
	
	IF LEN(@out) > 2 SET @out = LEFT(@out, LEN(@out) - 1)
	
	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GroupMemberList_With_GroupName]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create FUNCTION [dbo].[QCheck_GroupMemberList_With_GroupName] (
	@GroupName varchar(100)
) RETURNS VARCHAR(8000) AS

BEGIN

	DECLARE @out VARCHAR(8000)
	
	SET @out = ''
	SELECT
		@out = @out + U.FullName + ', '
	FROM
		QCheck_GroupMembership GM
		INNER JOIN QCheck_Users U
			ON U.[ID] = GM.UserID
	WHERE
		GM.GroupID = (select ID from QCheck_Groups where Name=@GroupName)
	ORDER BY
		U.FullName
	
	IF LEN(@out) > 2 SET @out = LEFT(@out, LEN(@out) - 1)
	
	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GroupMemberList_WithIDs]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[QCheck_GroupMemberList_WithIDs] (
	@GroupID INT
) RETURNS VARCHAR(8000) AS

BEGIN

	DECLARE @out VARCHAR(8000)
	
	SET @out = ''
	SELECT
		@out = @out + U.FullName + ' - ' + convert(varchar(10), u.id) + ', '
	FROM
		QCheck_GroupMembership GM
		INNER JOIN QCheck_Users U
			ON U.[ID] = GM.UserID
	WHERE
		GM.GroupID = @GroupID
	ORDER BY
		U.FullName
	
	IF LEN(@out) > 2 SET @out = LEFT(@out, LEN(@out) - 1)
	
	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_GroupSplit]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE          FUNCTION [dbo].[QCheck_GroupSplit](
	@groupid int	
)
RETURNS VARCHAR(2000)
AS
BEGIN
	DECLARE @name varchar(2000) = ''
	DECLARE @members varchar(2000) = ''
	DECLARE @SingleMember bit = 1
	
	SELECT @name = name, @SingleMember = SingleMemberGroup
	FROM QCheck_Groups
	WHERE ID = @groupid
	
	IF @SingleMember = 0
	BEGIN
		
		SELECT @name = @name + ' ('
		
		SELECT @members = @members + fullname + ', '
		FROM
		(
			SELECT Distinct u.fullname 
			FROM QCheck_Users u
			INNER JOIN QCheck_GroupMembership gm
				on gm.UserID = u.ID	
				and gm.GroupID = @groupid
				and u.IsDeleted = 0
		) a
		
		SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)
		
		SELECT @name = @name + @members + ')'
	END
	
	RETURN @Name
END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_IsDailyChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_IsDailyChecklist] (
	@ActiveChecklistID INT
) RETURNS BIT AS 

BEGIN

	DECLARE @IsDaily BIT
	
	SELECT @IsDaily =  CASE
			WHEN	
				(freqType = 2 AND freqRecurrance = 1) -- Daily every 1 day (doesn't matter about weekends or holidays)
				OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) -- Weekly tasks that fall on M-F
				THEN 1 
			ELSE 0
		END
	FROM
		QCheck_ActiveChecklists_All ac
		INNER JOIN QCheck_ChecklistInstances_All ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Schedule_All s
			ON ci.ScheduleID = s.ID
	WHERE
		ac.ID = @ActiveChecklistID
		
	RETURN @IsDaily

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ManagersList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















CREATE          FUNCTION [dbo].[QCheck_ManagersList]
(
	@ChecklistID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_ChecklistManagers a
INNER JOIN
	QCheck_Groups g
ON
	g.ID = a.ManagerGroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.ChecklistID = @ChecklistID) a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)
--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ManagersList_Full]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO














CREATE          FUNCTION [dbo].[QCheck_ManagersList_Full]
(
	@ChecklistID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + Name + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_ChecklistManagers a
INNER JOIN
	(select * from QCheck_Groups union all select * from QCheck_GroupArchive)  g
ON
	g.ID = a.ManagerGroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.ChecklistID = @ChecklistID) a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)
--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ManagersList_FullNames]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO














Create          FUNCTION [dbo].[QCheck_ManagersList_FullNames]
(
	@ChecklistID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @member varchar(100)
DECLARE @members varchar(2000)

SELECT @members = ''

SELECT 
	@members = @members + [dbo].[QCheck_GroupMemberList_With_GroupName] (Name) + ', '
FROM 
(SELECT DISTINCT g.Name
FROM
	QCheck_ChecklistManagers a
INNER JOIN
	(select * from QCheck_Groups union all select * from QCheck_GroupArchive)  g
ON
	g.ID = a.ManagerGroupID
INNER JOIN 
	QCheck_GroupMembership gm
ON
	gm.GroupID = g.ID
WHERE
	a.IsDeleted = 0
AND
	a.ChecklistID = @ChecklistID) a

--IF LEN(@members) > 0 SET @members = left(@members, len(@members)-1)
--changed by spaul on 6-29-10 to solve appsendmail error we seem to get almost every day
SET @members = left(isnull(@members,''), CASE WHEN len(@members)-1 < 0 then 0 else len(@members)-1 end)

RETURN @members
END



















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_OverdueControlledTasksCount]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_OverdueControlledTasksCount] (
	@UserID VARCHAR(50),
	@Now DATETIME
) RETURNS INT AS

BEGIN

	DECLARE @count INT

	SELECT 
		@count = COUNT(*)
	FROM 
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.[ID]
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.[ID]
		INNER JOIN QCheck_ChecklistManagers cm
			ON cm.ChecklistID = ci.ChecklistID
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_Users u
			ON g.[Owner] = u.[ID]
			AND g.SingleMemberGroup = 1
	WHERE
		ac.DueTime < @Now
		AND ac.CompletedDate IS NULL
		AND u.[ID] = @UserID
		AND ci.IsDeleted = 0
		AND c.IsDeleted = 0
		AND cm.IsDeleted = 0
		AND u.IsDeleted = 0
		
	RETURN @count
	
END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_OverThreeOverdue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
















create         FUNCTION [dbo].[QCheck_OverThreeOverdue]
(
	@AsOfDate datetime,
	@ActiveChecklistID INT
)
RETURNS bit
AS
BEGIN

	DECLARE @IsThreeOverdue bit
	
	SET @IsThreeOverdue = 0

	DECLARE @DueDate datetime
	SET @DueDate = dbo.QCheck_DueDateAsOf (@AsOfDate, @ActiveChecklistID)

	IF DateDiff(day, @DueDate, @AsOfDate) > 2
		SET @IsThreeOverdue = 1

	RETURN @IsThreeOverdue
END

















GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ScheduleString]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  FUNCTION [dbo].[QCheck_ScheduleString] (
	
	@ScheduleID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN FreqType = 1 THEN 'One Time'
			ELSE
				CASE
					WHEN FreqType = 2 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' day(s)'
					WHEN FreqType = 3 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' week(s) on ' + dbo.QCheck_WeeklyIntervalString(FreqInterval)
					WHEN FreqType = 4 THEN 
						CASE
							WHEN FreqRecurrance = 3 THEN 'Quarterly'
							ELSE 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' month(s)'
						END
					WHEN FreqType = 5 THEN 'Yearly in ' + dbo.QCheck_YearlyIntervalString(FreqInterval)
				END
		END +
		CASE
			WHEN LastDueDate IS NULL THEN CASE WHEN FreqType <> 1 THEN ' starting' ELSE '' END + ' on ' + CONVERT(VARCHAR(10), FirstDueDate, 101) 
			ELSE ' from ' + CONVERT(VARCHAR(10), FirstDueDate, 101) + ' to ' + CONVERT(VARCHAR(10), LastDueDate, 101)
		END +
		' at ' + dbo.FloatToTime(DueTime) +
		CASE
			WHEN BusDayBehavior = 0 AND FreqType <> 1 THEN ', due weekends/holidays'
			WHEN BusDayBehavior = 1 AND FreqType <> 1 THEN ', skip weekends/holidays'
			WHEN BusDayBehavior = 2 AND FreqType <> 1 THEN ', prev bus. day for weekends/holidays'
			WHEN BusDayBehavior = 3 AND FreqType <> 1 THEN ', next bus. day for weekends/holidays'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(SoftDueOffsetDays, 0) > 0 THEN ', soft due ' + CONVERT(VARCHAR(5), SoftDueOffsetDays) + ' days before deadline'
			ELSE ''
		END
	FROM 
		QCheck_Schedule
	WHERE
		[ID] = @ScheduleID
	
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ScheduleStringAll]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_ScheduleStringAll] (
	@ScheduleID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN FreqType = 1 THEN 'One Time'
			ELSE
				CASE
					WHEN FreqType = 2 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' day(s)'
					WHEN FreqType = 3 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' week(s) on ' + dbo.QCheck_WeeklyIntervalString(FreqInterval)
					WHEN FreqType = 4 THEN 
						CASE
							WHEN FreqRecurrance = 3 THEN 'Quarterly'
							ELSE 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' month(s)'
						END
					WHEN FreqType = 5 THEN 'Yearly in ' + dbo.QCheck_YearlyIntervalString(FreqInterval)
				END
		END +
		CASE
			WHEN LastDueDate IS NULL THEN CASE WHEN FreqType <> 1 THEN ' starting' ELSE '' END + ' on ' + CONVERT(VARCHAR(10), FirstDueDate, 101) 
			ELSE ' from ' + CONVERT(VARCHAR(10), FirstDueDate, 101) + ' to ' + CONVERT(VARCHAR(10), LastDueDate, 101)
		END +
		' at ' + dbo.FloatToTime(DueTime) +
		CASE
			WHEN BusDayBehavior = 0 AND FreqType <> 1 THEN ', due weekends/holidays'
			WHEN BusDayBehavior = 1 AND FreqType <> 1 THEN ', skip weekends/holidays'
			WHEN BusDayBehavior = 2 AND FreqType <> 1 THEN ', prev bus. day for weekends/holidays'
			WHEN BusDayBehavior = 3 AND FreqType <> 1 THEN ', next bus. day for weekends/holidays'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(SoftDueOffsetDays, 0) > 0 THEN ', soft due ' + CONVERT(VARCHAR(5), SoftDueOffsetDays) + ' days before deadline'
			ELSE ''
		END
	FROM 
		QCheck_Schedule_All
	WHERE
		[ID] = @ScheduleID
	
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ScheduleStringArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  FUNCTION [dbo].[QCheck_ScheduleStringArchive] (
	
	@ScheduleID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN FreqType = 1 THEN 'One Time'
			ELSE
				CASE
					WHEN FreqType = 2 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' day(s)'
					WHEN FreqType = 3 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' week(s) on ' + dbo.QCheck_WeeklyIntervalString(FreqInterval)
					WHEN FreqType = 4 THEN 
						CASE
							WHEN FreqRecurrance = 3 THEN 'Quarterly'
							ELSE 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' month(s)'
						END
					WHEN FreqType = 5 THEN 'Yearly in ' + dbo.QCheck_YearlyIntervalString(FreqInterval)
				END
		END +
		CASE
			WHEN LastDueDate IS NULL THEN CASE WHEN FreqType <> 1 THEN ' starting' ELSE '' END + ' on ' + CONVERT(VARCHAR(10), FirstDueDate, 101) 
			ELSE ' from ' + CONVERT(VARCHAR(10), FirstDueDate, 101) + ' to ' + CONVERT(VARCHAR(10), LastDueDate, 101)
		END +
		' at ' + dbo.FloatToTime(DueTime) +
		CASE
			WHEN BusDayBehavior = 0 AND FreqType <> 1 THEN ', due weekends/holidays'
			WHEN BusDayBehavior = 1 AND FreqType <> 1 THEN ', skip weekends/holidays'
			WHEN BusDayBehavior = 2 AND FreqType <> 1 THEN ', prev bus. day for weekends/holidays'
			WHEN BusDayBehavior = 3 AND FreqType <> 1 THEN ', next bus. day for weekends/holidays'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(SoftDueOffsetDays, 0) > 0 THEN ', soft due ' + CONVERT(VARCHAR(5), SoftDueOffsetDays) + ' days before deadline'
			ELSE ''
		END
	FROM 
		QCheck_ScheduleArchive with (nolock)
	WHERE
		[ID] = @ScheduleID
	
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_ScheduleStringShort]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create  FUNCTION [dbo].[QCheck_ScheduleStringShort] (
	
	@ScheduleID INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SELECT @out =
		CASE
			WHEN FreqType = 1 THEN 'One Time'
			ELSE
				CASE
					WHEN FreqType = 2 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' day(s)'
					WHEN FreqType = 3 THEN 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' week(s) on ' + dbo.QCheck_WeeklyIntervalString(FreqInterval)
					WHEN FreqType = 4 THEN 
						CASE
							WHEN FreqRecurrance = 3 THEN 'Quarterly'
							ELSE 'Every ' + CONVERT(VARCHAR(5), FreqRecurrance) + ' month(s)'
						END
					WHEN FreqType = 5 THEN 'Yearly in ' + dbo.QCheck_YearlyIntervalString(FreqInterval)
				END
		END
	FROM 
		QCheck_Schedule
	WHERE
		[ID] = @ScheduleID
	
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_WeeklyIntervalString]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_WeeklyIntervalString](
	@Interval INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SET @out = ''
	
	IF @Interval & 1 > 0 SET @out = @out + 'Sun, '
	IF @Interval & 2 > 0 SET @out = @out + 'Mon, '
	IF @Interval & 4 > 0 SET @out = @out + 'Tue, '
	IF @Interval & 8 > 0 SET @out = @out + 'Wed, '
	IF @Interval & 16 > 0 SET @out = @out + 'Thu, '
	IF @Interval & 32 > 0 SET @out = @out + 'Fri, '
	IF @Interval & 64 > 0 SET @out = @out + 'Sat, '
	
	IF LEN(@out) > 2 SET @out = LEFT(@out, LEN(@out) - 1)
	
	RETURN @out

END
GO
/****** Object:  UserDefinedFunction [dbo].[QCheck_YearlyIntervalString]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QCheck_YearlyIntervalString](
	@Interval INT
) RETURNS VARCHAR(500) AS

BEGIN

	DECLARE @out VARCHAR(500)
	
	SET @out = ''
	
	IF @Interval & 1 > 0 SET @out = @out + 'Jan, '
	IF @Interval & 2 > 0 SET @out = @out + 'Feb, '
	IF @Interval & 4 > 0 SET @out = @out + 'Mar, '
	IF @Interval & 8 > 0 SET @out = @out + 'Apr, '
	IF @Interval & 16 > 0 SET @out = @out + 'May, '
	IF @Interval & 32 > 0 SET @out = @out + 'Jun, '
	IF @Interval & 64 > 0 SET @out = @out + 'Jul, '
	IF @Interval & 128 > 0 SET @out = @out + 'Aug, '
	IF @Interval & 256 > 0 SET @out = @out + 'Sep, '
	IF @Interval & 512 > 0 SET @out = @out + 'Oct, '
	IF @Interval & 1024 > 0 SET @out = @out + 'Nov, '
	IF @Interval & 2048 > 0 SET @out = @out + 'Dec, '
	
	IF LEN(@out) > 2 SET @out = LEFT(@out, LEN(@out) - 1)
	
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_ActiveChecklistReportLinks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QStatus_ActiveChecklistReportLinks] (
	@ActiveChecklistID INT,
	@UserID INT,
	@Delimiter VARCHAR(50)
) RETURNS VARCHAR(5000) AS

BEGIN

	DECLARE @AppPath VARCHAR(500),
		@out VARCHAR(5000)
	
	SELECT @AppPath = app.AppURL
	FROM
		QCheck_AppSettings app
		INNER JOIN QCheck_Users u
			ON app.[ID] = u.App
	WHERE
		u.[ID] = @UserID
	
	SET @out = ''
	
	SELECT 
		@out = @out + ISNULL('<a href="' + @AppPath + '/MyStatus.aspx?reportid=' + CONVERT(VARCHAR(50), r.[ID]) + '&taskid=' + CONVERT(VARCHAR(50),@ActiveChecklistID) + '">' + R.[Name] + '</a>' + @Delimiter, '')
	FROM 
		QStatus_ActiveChecklistTaskType actt
		INNER JOIN QStatus_TaskTypes tt
			ON actt.TaskType = tt.[ID]
		INNER JOIN QStatus_Report r
			ON tt.ReportID = r.[ID]
		INNER JOIN QStatus_GroupReport gr
			ON r.[ID] = gr.ReportID
		INNER JOIN QCheck_GroupMembership gm
			ON gr.GroupID = gm.GroupID
	WHERE 
		ActiveChecklistID = @ActiveChecklistID
		AND r.IsDeleted = 0
		AND gm.UserID = @UserID
	
	
	SELECT 
		@out = @out + ISNULL('<a href="' + @AppPath + '/MyInbox.aspx?reportid=' + CONVERT(VARCHAR(50), r.[ID]) + '&taskid=' + CONVERT(VARCHAR(50),@ActiveChecklistID) + '">' + R.[Name] + '</a>' + @Delimiter, '')
	FROM 
		QStatus_ActiveChecklistTaskType actt
		INNER JOIN QStatus_TaskTypes tt
			ON actt.TaskType = tt.[ID]
		INNER JOIN QStatus_Report r
			ON tt.ReportID = r.[ID]
		INNER JOIN QStatus_Supervisors s
			ON r.[ID] = s.ReportID
		INNER JOIN QCheck_GroupMembership gm
			ON s.SupervisorGroupID = gm.GroupID
	WHERE 
		ActiveChecklistID = @ActiveChecklistID
		AND r.IsDeleted = 0
		AND gm.UserID = @UserID

	SELECT @out = CASE 
			WHEN LEN(@out) > LEN(@Delimiter) THEN LEFT(@out, LEN(@out)- LEN(@Delimiter)) 
			ELSE @out
		END
	
	RETURN @out

END

GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_AllCommentsByInstance]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE            FUNCTION [dbo].[QStatus_AllCommentsByInstance]
(
	@InstanceID INT
)
RETURNS VARCHAR(max)
AS
BEGIN

DECLARE @comments varchar(max)

SELECT @comments = ''

SELECT 
	@comments = @comments + comment
FROM 
(
	select '[' + c.Initials + '] ' + c.comments + '; ' as comment
	from 
	qstatus_comments c
	inner join QCheck_ActiveChecklists_All ac
		on c.ForeignKeyID = ac.id
	inner join QCheck_ChecklistInstances_All ci
		on ac.InstanceID = ci.ID
		and ci.ID = @InstanceID
	where c.SpecialTask = 0
) a

IF LEN(@comments) > 0 
	SET @comments = left(@comments, len(@comments)-1)
ELSE
	SET @comments = 'None'


RETURN @comments
END




















GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_Approval_GetChecklistControllers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QStatus_Approval_GetChecklistControllers] (
	@ID INT,
	@ChangeID INT
) RETURNS VARCHAR(1000) AS

BEGIN

	DECLARE @ReturnString VARCHAR(1000)
	SET @ReturnString = ''

	DECLARE @Out TABLE (
		[ID] INT,
		FullName VARCHAR(50),
		Existing BIT
	)

	-- Get the existing checklist managers
	INSERT INTO @Out	
		SELECT 
			m.[ID], 
			g.[Name] As FullName,
			1 As Existing
		FROM
			QCheck_ChecklistManagers m
			INNER JOIN QCheck_Groups g
				ON g.ID = m.ManagerGroupID
		WHERE
			m.ChecklistID = @ID
			AND m.IsDeleted = 0
	
	-- Get any checklist managers that were added in the given change request
	INSERT INTO @Out
		SELECT 
			m.[ID], 
			g.[Name] As FullName,
			0 As Existing
		FROM
			QCheck_Approval_ChecklistManagers m
			INNER JOIN QCheck_Groups g
				ON g.ID = m.ManagerGroupID
		WHERE
			m.ChecklistID = @ID
			AND m.IsDeleted = 0
			AND m.ChangeRequestID = @ChangeID

	-- Remove any existing checklist managers that were removed in the given change request
	DELETE FROM @Out
	WHERE 
		[ID] IN (
			SELECT ChecklistManagerID
			FROM QCheck_Approval_ChecklistManagers
			WHERE
				ChangeRequestID = @ChangeID
				AND IsDeleted = 1
		)
		AND Existing = 1

	-- Get the output string
	SELECT @ReturnString = @ReturnString + FullName +', ' FROM @out

	IF len(@ReturnString) > 0 SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString

END

GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetActiveChecklistControllers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE                              FUNCTION [dbo].[QStatus_GetActiveChecklistControllers]
	(
		@ID int
	)
RETURNS VARCHAR(1000)
AS
BEGIN

	DECLARE @ChecklistID int
	SELECT @ChecklistID = c.ID
	FROM QCheck_ActiveChecklists ac INNER JOIN QCheck_ChecklistInstances ci 
		ON ac.InstanceID = ci.ID INNER JOIN QCheck_Checklists c ON ci.ChecklistID = c.ID
	WHERE ac.ID = @ID

	RETURN dbo.QStatus_GetChecklistControllers(@ChecklistID)

END


GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetChecklistControllerArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[QStatus_GetChecklistControllerArchive]
(
	@instanceId int
)
returns varchar(2000)
as
begin
	DECLARE @ReturnString VARCHAR(1000)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName +', '
	FROM(
	SELECT m.ID, g.Name as FullName
	FROM
		QCheck_ChecklistManagerArchive m
	INNER JOIN
		QCheck_GroupArchive g
	ON 
		g.ID = m.ManagerGroupID
	WHERE
		m.ChecklistID = @instanceId
	
	AND
		m.IsDeleted = 0	) u
	


	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)



		if @ReturnString = ''
			set @ReturnString = dbo.QStatus_GetChecklistControllers(@instanceId) 

	return @ReturnString
end
GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetChecklistControllers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE                             FUNCTION [dbo].[QStatus_GetChecklistControllers]
	(
		@ID int
	)
RETURNS VARCHAR(1000)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(1000)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName +', '
	FROM(
	SELECT m.ID, g.Name as FullName
	FROM
		QCheck_ChecklistManagers m
	INNER JOIN
		QCheck_Groups g
	ON 
		g.ID = m.ManagerGroupID
	--INNER JOIN QCheck_ChecklistInstances i ON m.ChecklistID = i.ChecklistID
	--INNER JOIN QCheck_ActiveChecklists a ON i.ID = a.InstanceID
	WHERE
		m.ChecklistID = @ID
	
	AND
		m.IsDeleted = 0	) u
	


	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString



END






GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetChecklistReportArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







create                                FUNCTION [dbo].[QStatus_GetChecklistReportArchive]
	(
		@ActiveChecklistID int
	)
RETURNS VARCHAR(1000)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500) = ''

	DECLARE @reports table(
		reportID int,
		reportName varchar(100),
		type varchar(10)
	)
	
	-- archive
	INSERT INTO @reports
	SELECT 
		distinct r.Id, r.name, 'Controller'
	FROM 
		QCheck_ActiveChecklistArchive ac with (nolock)
	INNER JOIN 
		QStatus_ActiveChecklistTaskTypeArchive actt on actt.activechecklistid = ac.id
	INNER JOIN 
		QStatus_TaskTypes tt with (nolock) on actt.TaskType = tt.ID
	INNER JOIN 
		QStatus_Report r with (nolock) on r.ID = tt.reportID
	INNER JOIN 
		QStatus_GroupReport gr with (nolock) on gr.reportID = r.ID
	INNER JOIN 
		QCheck_GroupArchive g with (nolock) on g.ID = gr.GroupID
	WHERE 
		ac.ID = @ActiveChecklistID

	INSERT INTO @reports
	SELECT 
		distinct r.Id, r.name, 'Supervisor'
	FROM 
		QCheck_ActiveChecklistArchive ac with (nolock)
	INNER JOIN 
		QStatus_ActiveChecklistTaskTypeArchive actt with (nolock) on actt.activechecklistid = ac.id
	INNER JOIN 
		QStatus_TaskTypes tt with (nolock) on actt.TaskType = tt.ID
	INNER JOIN 
		QStatus_Report r with (nolock) on r.ID = tt.reportID
	INNER JOIN 
		QStatus_Supervisors s with (nolock) on s.reportID = r.ID
	INNER JOIN 
		QCheck_GroupArchive g with (nolock) on g.ID = s.SupervisorGroupID
	WHERE 
		ac.ID = @ActiveChecklistID and r.ID not in (select reportID from @reports)

	INSERT INTO @reports
	select 
		distinct r.Id, r.name, 'Other'
	FROM 
		QCheck_ActiveChecklistArchive ac with (nolock)
	INNER JOIN 
		QStatus_ActiveChecklistTaskTypeArchive actt with (nolock) on actt.activechecklistid = ac.id
	INNER JOIN 
		QStatus_TaskTypes tt with (nolock) on actt.TaskType = tt.ID
	INNER JOIN 
		QStatus_Report r with (nolock) on r.ID = tt.reportID
	WHERE 
		ac.ID = @ActiveChecklistID and r.ID not in (select reportID from @reports)



	-- current
	INSERT INTO @reports
	SELECT 
		distinct r.Id, r.name, 'Controller'
	FROM 
		QCheck_ActiveChecklistArchive ac with (nolock)
	INNER JOIN 
		QStatus_ActiveChecklistTaskType actt on actt.activechecklistid = ac.id
	INNER JOIN 
		QStatus_TaskTypes tt with (nolock) on actt.TaskType = tt.ID
	INNER JOIN 
		QStatus_Report r with (nolock) on r.ID = tt.reportID
	INNER JOIN 
		QStatus_GroupReport gr with (nolock) on gr.reportID = r.ID
	INNER JOIN 
		QCheck_Groups g with (nolock) on g.ID = gr.GroupID
	WHERE 
		ac.ID = @ActiveChecklistID

	INSERT INTO @reports
	SELECT 
		distinct r.Id, r.name, 'Supervisor'
	FROM 
		QCheck_ActiveChecklistArchive ac with (nolock)
	INNER JOIN 
		QStatus_ActiveChecklistTaskType actt with (nolock) on actt.activechecklistid = ac.id
	INNER JOIN 
		QStatus_TaskTypes tt with (nolock) on actt.TaskType = tt.ID
	INNER JOIN 
		QStatus_Report r with (nolock) on r.ID = tt.reportID
	INNER JOIN 
		QStatus_Supervisors s with (nolock) on s.reportID = r.ID
	INNER JOIN 
		QCheck_Groups g with (nolock) on g.ID = s.SupervisorGroupID
	WHERE 
		ac.ID = @ActiveChecklistID and r.ID not in (select reportID from @reports)

	INSERT INTO @reports
	select 
		distinct r.Id, r.name, 'Other'
	FROM 
		QCheck_ActiveChecklistArchive ac with (nolock)
	INNER JOIN 
		QStatus_ActiveChecklistTaskType actt with (nolock) on actt.activechecklistid = ac.id
	INNER JOIN 
		QStatus_TaskTypes tt with (nolock) on actt.TaskType = tt.ID
	INNER JOIN 
		QStatus_Report r with (nolock) on r.ID = tt.reportID
	WHERE 
		ac.ID = @ActiveChecklistID and r.ID not in (select reportID from @reports)
	
	SELECT @ReturnString = @ReturnString 
	+ case when type <> 'Other' then
		'<a href="#" onclick="javscript:gotoReport('''+convert(varchar(10), reportID)+''','''+type+''','''+convert(varchar(10), @ActiveChecklistID)+''');">' + ReportName + '</a>'
	else
		ReportName
	end
	+ ', '
	from @reports

	IF len(@ReturnString) > 0
	BEGIN
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)
		SET @ReturnString = 'Status Reports: ' + @ReturnString
	END

	RETURN @ReturnString
END





























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetChecklistReports]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                                FUNCTION [dbo].[QStatus_GetChecklistReports]
	(
		@ActiveChecklistID int,
		@UserID int
	)
RETURNS VARCHAR(1000)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	/*SELECT @ReturnString = @ReturnString 
		+ r.Name 
		+ ', '*/

	DECLARE @reports table(
		reportID int,
		reportName varchar(100),
		type varchar(10)
	)
	
	INSERT INTO @reports
	SELECT distinct r.Id, r.name, 'Controller'
	FROM QCheck_ActiveChecklists ac
	INNER JOIN QStatus_ActiveChecklistTaskType actt
	on actt.activechecklistid = ac.id
	INNER JOIN QStatus_TaskTypes tt
	on actt.TaskType = tt.ID
	INNER JOIN QStatus_Report r
	on r.ID = tt.reportID
	-- 8/4/2010 dalvarado - don't want to show deleted reports
	and r.isdeleted = 0
	INNER JOIN QStatus_GroupReport gr
	on gr.reportID = r.ID
	INNER JOIN QCheck_Groups g
	on g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	on gm.GroupID = g.ID
	and gm.UserID = @UserID
	WHERE ac.ID = @ActiveChecklistID

	
	INSERT INTO @reports
	SELECT distinct r.Id, r.name, 'Supervisor'
	FROM QCheck_ActiveChecklists ac
	INNER JOIN QStatus_ActiveChecklistTaskType actt
	on actt.activechecklistid = ac.id
	INNER JOIN QStatus_TaskTypes tt
	on actt.TaskType = tt.ID
	INNER JOIN QStatus_Report r
	on r.ID = tt.reportID
	-- 8/4/2010 dalvarado - don't want to show deleted reports
	and r.isdeleted = 0
	INNER JOIN QStatus_Supervisors s
	on s.reportID = r.ID
	INNER JOIN QCheck_Groups g
	on g.ID = s.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	on gm.GroupID = g.ID
	and gm.UserID = @UserID
	WHERE ac.ID = @ActiveChecklistID
	and r.ID not in (select reportID from @reports)

	INSERT INTO @reports
	SELECT distinct r.Id, r.name, 'Other'
	FROM QCheck_ActiveChecklists ac
	INNER JOIN QStatus_ActiveChecklistTaskType actt
	on actt.activechecklistid = ac.id
	INNER JOIN QStatus_TaskTypes tt
	on actt.TaskType = tt.ID
	INNER JOIN QStatus_Report r
	on r.ID = tt.reportID
	-- 8/4/2010 dalvarado - don't want to show deleted reports
	and r.isdeleted = 0
	WHERE ac.ID = @ActiveChecklistID
	and r.ID not in (select reportID from @reports)

	
	
	SELECT @ReturnString = @ReturnString 
	+ case when type <> 'Other' then
		'<a href="#" onclick="javscript:gotoReport('''+convert(varchar(10), reportID)+''','''+type+''','''+convert(varchar(10), @ActiveChecklistID)+''');">' + ReportName + '</a>'
	else
		ReportName
	end
	+ ', '
	from @reports

	IF len(@ReturnString) > 0
	BEGIN
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)
		SET @ReturnString = 'Status Reports: ' + @ReturnString
	END

	RETURN @ReturnString

END





























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetIPNames]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
























create                            FUNCTION [dbo].[QStatus_GetIPNames]
	(
		@ID int
	)
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName + ', '
	FROM(
	SELECT Distinct u.FullName
	FROM	QStatus_Report r
	INNER JOIN
		QStatus_Supervisors s
	ON
		r.ID = s.ReportID
	and 
		s.DirectSupervisor = 1
	and
		s.InterestedParty = 1
	INNER JOIN QCheck_Groups g
	ON
		s.SupervisorGroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE
		r.ID = @ID
	) u
	
	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString

END

























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetReportControllers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE                               FUNCTION [dbo].[QStatus_GetReportControllers]
	(
		@ID int
	)
RETURNS VARCHAR(1000)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(1000)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName +', '
	FROM(
	SELECT DISTINCT u.FullName
	FROM
		QStatus_GroupReport gr
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gr.ReportID = @ID
	INNER JOIN
		QCheck_Users u
	on 
		u.id = gm.UserID
	AND
		gr.ReportID = @ID
	AND
		u.isdeleted = 0
	) u
	


	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString
END








GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetSupervisorEmails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE                        FUNCTION [dbo].[QStatus_GetSupervisorEmails]
	(
		@ID int
	)
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.Email + ';'
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_Supervisors s
	ON
		r.ID = s.ReportID
	and 
		s.DirectSupervisor = 1
	INNER JOIN QCheck_Groups g
	ON
		s.SupervisorGroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE
		r.ID = @ID
	

	RETURN @ReturnString

END





















GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetSupervisorNames]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO






















CREATE                          FUNCTION [dbo].[QStatus_GetSupervisorNames]
	(
		@ID int
	)
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName + ', '
	FROM(
	SELECT Distinct u.FullName
	FROM	QStatus_Report r
	INNER JOIN
		QStatus_Supervisors s
	ON
		r.ID = s.ReportID
	and 
		s.DirectSupervisor = 1
	INNER JOIN QCheck_Groups g
	ON
		s.SupervisorGroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE
		r.ID = @ID
	) u
	
	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString

END























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetSupervisorOnlyNames]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
























create                            FUNCTION [dbo].[QStatus_GetSupervisorOnlyNames]
	(
		@ID int
	)
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName + ', '
	FROM(
	SELECT Distinct u.FullName
	FROM	QStatus_Report r
	INNER JOIN
		QStatus_Supervisors s
	ON
		r.ID = s.ReportID
	and 
		s.DirectSupervisor = 1
	and
		s.InterestedParty = 0
	INNER JOIN QCheck_Groups g
	ON
		s.SupervisorGroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE
		r.ID = @ID
	) u
	
	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString

END

























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetUserEmails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                          FUNCTION [dbo].[QStatus_GetUserEmails]
	(
		@ID int
	)
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.Email + ';'
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		r.ID = gr.ReportID
	INNER JOIN QCheck_Groups g
	ON
		gr.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE
		r.ID = @ID
	

	RETURN @ReturnString

END























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetUserNames]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO














CREATE                                       FUNCTION [dbo].[QStatus_GetUserNames]
	(
		@ID int
	)
RETURNS VARCHAR(500)
AS
BEGIN
	/*DECLARE @ReturnString VARCHAR(500)
	SET @ReturnString = ''

	SELECT @ReturnString = '' FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		r.ID = gr.ReportID
	INNER JOIN QCheck_Groups g
	ON
		gr.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	AND
		u.IsDeleted = 0
	WHERE
		r.ID = @ID

	IF @@RowCount = 1 
		SELECT @ReturnString = u.FullName + ' - '
		FROM
			QStatus_Report r
		INNER JOIN
			QStatus_GroupReport gr
		ON
			r.ID = gr.ReportID
		INNER JOIN QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		INNER JOIN
			QCheck_Users u
		ON
			u.ID = gm.UserID
		AND
			u.IsDeleted = 0
		AND
			u.FullName <> r.Name
		WHERE
			r.ID = @ID


	RETURN @ReturnString*/
	
	RETURN ''

END






































GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_GetUserNamesFull]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                            FUNCTION [dbo].[QStatus_GetUserNamesFull]
	(
		@ID int
	)
RETURNS VARCHAR(1000)
AS
BEGIN
	DECLARE @ReturnString VARCHAR(1000)
	SET @ReturnString = ''

	SELECT @ReturnString = @ReturnString + u.FullName +', '
	FROM(
	SELECT DISTINCT u.FullName--@ReturnString = @ReturnString + u.FullName +', '
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		r.ID = gr.ReportID
	INNER JOIN QCheck_Groups g
	ON
		gr.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE
		r.ID = @ID) u
	
	
	IF len(@ReturnString) > 0
		SET @ReturnString = left(@ReturnString, len(@ReturnString) - 1)

	RETURN @ReturnString

END

























GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_InstanceReports]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE     FUNCTION [dbo].[QStatus_InstanceReports] (@InstanceId int, @UserID int)
RETURNS varchar(1000)

AS  
BEGIN 

DECLARE @reports varchar(1000)
SET @reports = ''


IF @UserID = -1
BEGIN
	SELECT distinct @reports = @reports + '<a href="#" onclick="openReport(' + CAST(r.ID AS VARCHAR(10)) + ',' + CAST(ac.ID AS VARCHAR(10)) + ')">' + r.Name + ' / ' + tt.Description + '</a><br>'
	FROM
		QStatus_InstanceTaskType itt 
		INNER JOIN QStatus_TaskTypes tt ON itt.TaskType = tt.ID
		INNER JOIN QStatus_Report r ON tt.ReportID = r.ID and r.isdeleted = 0
		INNER JOIN QCheck_ActiveChecklists ac ON itt.InstanceID = ac.InstanceID
		
	WHERE
		itt.InstanceID = @InstanceID 
END
ELSE
BEGIN
	SELECT distinct @reports = @reports + '<a href="#" onclick="openReport(' + CAST(r.ID AS VARCHAR(10)) + ',' + CAST(ac.ID AS VARCHAR(10)) + ')">' + r.Name + ' / ' + tt.Description + '</a><br>'
	FROM
		QStatus_InstanceTaskType itt 
		INNER JOIN QStatus_TaskTypes tt ON itt.TaskType = tt.ID
		INNER JOIN QStatus_Report r ON tt.ReportID = r.ID  and r.isdeleted = 0
		INNER JOIN QStatus_GroupReport gr ON r.ID = gr.ReportID
		INNER JOIN QCheck_GroupMembership gm ON gr.GroupID = gm.GroupID
		INNER JOIN QCheck_Users u ON gm.UserID = u.ID 
		INNER JOIN QCheck_ActiveChecklists ac ON itt.InstanceID = ac.InstanceID
		
	WHERE
		itt.InstanceID = @InstanceID AND
		u.ID = @UserID
END


IF LEN(@reports) > 4
	SET @reports = LEFT(@reports, LEN(@reports)-4)

RETURN @reports
END








GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_StatusReportList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE            FUNCTION [dbo].[QStatus_StatusReportList]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @reportName varchar(100)
DECLARE @reportNames varchar(2000)

SELECT @reportNames = ''

SELECT 
	@reportNames = @reportNames + Name + ', '
FROM 
(SELECT DISTINCT r.Name
FROM
	QStatus_InstanceTaskType itt
INNER JOIN
	QStatus_TaskTypes tt
ON
	tt.ID = itt.TaskType
AND
	itt.InstanceID = @InstanceID
INNER JOIN
	QStatus_Report r
ON
	tt.ReportID = r.ID
	and r.isdeleted = 0) a

IF LEN(@reportNames) > 0 
	SET @reportNames = left(@reportNames, len(@reportNames)-1)
ELSE
	SET @reportNames = 'None'


RETURN @reportNames
END




















GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_StatusReportList_Visibility]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE            FUNCTION [dbo].[QStatus_StatusReportList_Visibility]
(
	@InstanceID INT
)
RETURNS VARCHAR(2000)
AS
BEGIN

DECLARE @reportName varchar(100)
DECLARE @reportNames varchar(2000)

SELECT @reportNames = ''

SELECT 
	@reportNames = @reportNames + Name + ', '
FROM 
(SELECT DISTINCT u.FullName as name
FROM
	QStatus_InstanceTaskType itt
INNER JOIN
	QStatus_TaskTypes tt
ON
	tt.ID = itt.TaskType
AND
	itt.InstanceID = @InstanceID
INNER JOIN
	QStatus_Report r
ON
	tt.ReportID = r.ID
INNER JOIN 
	(
	select reportid, groupid from QStatus_GroupReport
	union all 
	select reportid, SupervisorGroupID as groupid from QStatus_Supervisors
	) gr
on gr.ReportID = r.ID
INNER JOIN
	(Select * from QCheck_Groups union all select * from QCheck_GroupArchive) g
on g.ID = gr.GroupID
INNER JOIN
	QCheck_GroupMembership gm
on gm.GroupID = gr.GroupID
inner join 
	QCheck_Users u
on u.ID = gm.UserID	
	) a

IF LEN(@reportNames) > 0 
	SET @reportNames = left(@reportNames, len(@reportNames)-1)
ELSE
	SET @reportNames = 'None'


RETURN @reportNames
END




















GO
/****** Object:  UserDefinedFunction [dbo].[RemoveNonAlphaCharacters]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Function [dbo].[RemoveNonAlphaCharacters](@Temp VarChar(max))
Returns VarChar(max)
AS
Begin

    Declare @KeepValues as varchar(50)
    Set @KeepValues = '%[^a-z0-9]%'
    While PatIndex(@KeepValues, @Temp) > 0
        Set @Temp = Stuff(@Temp, PatIndex(@KeepValues, @Temp), 1, '')

    Return @Temp
End
GO
/****** Object:  UserDefinedFunction [dbo].[udf_StripHTML]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[udf_StripHTML] (@HTMLText VARCHAR(MAX))
RETURNS VARCHAR(MAX) AS
BEGIN
    DECLARE @Start INT
    DECLARE @End INT
    DECLARE @Length INT
    SET @Start = CHARINDEX('<',@HTMLText)
    SET @End = CHARINDEX('>',@HTMLText,CHARINDEX('<',@HTMLText))
    SET @Length = (@End - @Start) + 1
    WHILE @Start > 0 AND @End > 0 AND @Length > 0
    BEGIN
        SET @HTMLText = STUFF(@HTMLText,@Start,@Length,'')
        SET @Start = CHARINDEX('<',@HTMLText)
        SET @End = CHARINDEX('>',@HTMLText,CHARINDEX('<',@HTMLText))
        SET @Length = (@End - @Start) + 1
    END
    RETURN LTRIM(RTRIM(@HTMLText))
END
GO
/****** Object:  UserDefinedFunction [dbo].[Util_AddBusinessDays]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   FUNCTION [dbo].[Util_AddBusinessDays] (@InDate DATETIME, @DaysToAdd INT) RETURNS DATETIME AS
--------------------------------------------------------------------------------
--
-- NAME        : AddBusinessDays
-- PURPOSE     : Takes in a date and a number, returns the input date + n business days
--		 
-- INPUT PARMS : @InDate DATETIME
-- RETURNS     : DATETIME
-- CALLS       : N/A
-- DATA MODS   : N/A
-- HISTORY     : 
--   DATE        INITS   COMMENTS
--   2005-APR-29 DA     Initial Creation 
--------------------------------------------------------------------------------
BEGIN

DECLARE @OutDate DATETIME
DECLARE @HolidayCount INT
DECLARE @DayCounter int
--
-- INITIALIZE
--
SET @InDate = CAST(CONVERT(VARCHAR(10), @InDate, 101) AS DATETIME)  -- Strip off time
SET @OutDate = @InDate
SET @DayCounter = 0


WHILE @DayCounter < @DaysToAdd
BEGIN

	SET @DayCounter = @DayCounter + 1
	SET @OutDate = DATEADD(D,1,@OutDate)
	WHILE 
		UPPER(DATENAME(DW,@OutDate)) IN ('SATURDAY','SUNDAY') 
		OR EXISTS (SELECT 1 
					-- 10/6/2010 Sean Paul -- SQLPrimary reference is redundant and causes a hetergeneous query error on ds00 and during failover to SQLHurst. Removed
					FROM vwHolidaySchedule
					-- 4/14/2009 dalvarado - accounting for non-US holidays in the cr table
					WHERE crdate = @OutDate and cucode = 'USD')

	BEGIN
		SET @OutDate = DATEADD(D,1,@OutDate)
	END

END

RETURN @OutDate


END



GO
/****** Object:  UserDefinedFunction [dbo].[Util_AddOfficeDays]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE   FUNCTION [dbo].[Util_AddOfficeDays] (@InDate DATETIME, @DaysToAdd INT) RETURNS DATETIME AS
BEGIN

DECLARE @HolidayCount INT
DECLARE @DayCounter int
--
-- INITIALIZE
--

SET @InDate = CAST(CONVERT(VARCHAR(10), @InDate, 101) AS DATETIME)  -- Strip off time
SET @DayCounter = 0


WHILE @DayCounter < @DaysToAdd
BEGIN

	SET @DayCounter = @DayCounter + 1
	SET @InDate = DATEADD(D,1,@InDate)
	
	WHILE 
		UPPER(DATENAME(DW,@InDate)) IN ('SATURDAY','SUNDAY') 
		OR EXISTS (SELECT 1 
					FROM vwHolidaySchedule
					-- 4/14/2009 dalvarado - accounting for non-US holidays in the cr table
					WHERE crdate = @InDate and stkmkt = 1 and cucode = 'USD')

	BEGIN
		SET @InDate = DATEADD(D,1,@InDate)
	END

END

RETURN @InDate


END




GO
/****** Object:  UserDefinedFunction [dbo].[Util_ColorScale]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[Util_ColorScale] (
	@value as float,
	@minValue as float,
	@maxValue as float,
	@minColor as varchar(7),
	@maxColor as varchar(7)
)
returns varchar(7)
AS
BEGIN
	declare @color varchar(7)
	declare @scalevalue float, @r int, @g int, @b int
	declare @minRGB int, @minR int, @minG int, @minB int
	declare @maxRGB int, @maxR int, @maxG int, @maxB int
	
	select @color = @maxColor
	
	if @value >= @maxValue
	begin
		return @maxColor
	end
	
	if @value <= @minValue
	begin
		return @minColor
	end
	
	select @scalevalue = (@value - @minValue) / (@maxValue - @minValue)
	
	select @minRGB = dbo.Util_GetRGBInt(@minColor)
	select @maxRGB = dbo.Util_GetRGBInt(@maxColor)
	
	select @minR = @minRGB / power(2, 16)
	select @minG = (@minRGB % power(2, 16)) / power(2, 8)
	select @minB = @minRGB % power(2, 8) 
	
	select @maxR = @maxRGB / power(2, 16)
	select @maxG = (@maxRGB % power(2, 16)) / power(2, 8)
	select @maxB = @maxRGB % power(2, 8) 
	
	select @r = @minR +((@maxR - @minR) * @scaleValue)
	select @g = @minG +((@maxG - @minG) * @scaleValue)
	select @b = @minB +((@maxB - @minB) * @scaleValue)
	
	select @color = '#' + right(convert(varchar(10), convert(varbinary(8), @r), 2), 2) 
						+ right(convert(varchar(10), convert(varbinary(8), @g), 2), 2) 
						+ right(convert(varchar(10), convert(varbinary(8), @b), 2), 2) 
	
	return @color
END
GO
/****** Object:  UserDefinedFunction [dbo].[Util_ColorScale3]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[Util_ColorScale3] (
	@value as float,
	@minValue as float,
	@maxValue as float,
	@minColor as varchar(7),
	@midColor as varchar(7),
	@maxColor as varchar(7)
) 
returns varchar(7)
as 
begin

	declare @color varchar(7)
	declare @midValue as float = (@maxValue + @minValue) / 2.0
	
	if @value < @midValue
	begin
		select @color = dbo.Util_ColorScale (@value, @minValue, @midValue, @minColor, @midColor)
	end
	else
	begin
		select @color = dbo.Util_ColorScale (@value, @midValue, @maxValue, @midColor, @maxColor)
	end
	
	return @color

end
GO
/****** Object:  UserDefinedFunction [dbo].[Util_ColorScaleGYR]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[Util_ColorScaleGYR] (
	@value as float,
	@minValue as float,
	@maxValue as float
)
returns varchar(7)
as
begin

	declare @colorScaleRed varchar(7) = '#F8696B', @colorScaleYellow varchar(7) = '#FFEB84', @colorScaleGreen varchar(7) = '#63BE7B'
	return dbo.Util_ColorScale3(@value, @minValue, @maxValue, @colorScaleGreen, @colorScaleYellow, @colorScaleRed)

end
GO
/****** Object:  UserDefinedFunction [dbo].[Util_fn_List_DateRange]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  FUNCTION [dbo].[Util_fn_List_DateRange] 
	(
	@startDate DateTime,
	@endDate	DateTime


	)
RETURNS 
	@WeekDays TABLE 
		(
		seq	int identity(1,1),
		WeekDayDate datetime,
		Day varchar(10)
		
		)
AS
BEGIN

;WITH CTE(dt)
AS
(
      SELECT @startDate
      UNION ALL
      SELECT DATEADD(d, 1, dt) FROM CTE
      WHERE dt < @endDate
)
Insert into @WeekDays(WeekDayDate,Day)
SELECT dt,DateName(Weekday, dt) FROM CTE 
option (maxrecursion 0) ;

	RETURN 

END








GO
/****** Object:  UserDefinedFunction [dbo].[Util_fn_List_To_Table]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[Util_fn_List_To_Table] 
	(
	@list varchar(8000),
	@delim	varchar(10) 

	)
RETURNS 
	@out TABLE 
		(
		seq	int identity(1,1),
		c varchar(500),
		n decimal (20,4)
		)
AS
BEGIN

	declare @l varchar(8000)
	declare @id varchar(500)
	declare @pos int

IF @delim <> CHAR(13) + CHAR(10)
BEGIN	
	set @list = replace(@list, CHAR(13), '')
	set @list = replace(@list, CHAR(10), '')
END

	set @l = ltrim(rtrim(replace(@list, @delim, char(9))))
--	while charindex('  ', @l)  <> 0 begin
--		set @l = replace(@l, '  ', ' ')
--	end

	set @pos = charindex(char(9), @l)
	while @pos > 0 begin

		set @id = replace(ltrim(rtrim(substring(@l, 1, @pos))), char(9), '')

		if isnumeric(@id) = 1 and charindex(',', @id) = 0 and @id <> '$' and @id <> '.' begin
			insert into @out (c,n)
			select ltrim(rtrim(@id)), convert(decimal(20,4), @id)
		end 
		else begin
			insert into @out (c)
			select ltrim(rtrim(@id))
		end

		set @l = ltrim(rtrim(substring(@l, @pos, len(@l))))
		if left(@l,1) = char(9)
			SET @l = substring(@l, 2, len(@l))
		if right(@l,1) = char(9)
			SET @l = left(@l, len(@l)-1)

		
		set @pos = charindex(char(9), @l)

	end
	

	if isnumeric(@l) = 1 and charindex(',', @l) = 0 begin
		insert into @out (c,n)
		select ltrim(rtrim(@l)), convert(decimal(20,4), @l)
	end 
	else begin
		insert into @out (c)
		select ltrim(rtrim(@l))
	end


	RETURN 

END



GO
/****** Object:  UserDefinedFunction [dbo].[Util_fn_List_WeekDays_DateRange]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   FUNCTION [dbo].[Util_fn_List_WeekDays_DateRange] 
	(
	@startDate DateTime,
	@endDate	DateTime,
	@weekDay int

	)
RETURNS 
	@WeekDays TABLE 
		(
		seq	int identity(1,1),
		WeekDayDate datetime,
		Day varchar(10)
		
		)
AS
BEGIN

;WITH CTE(dt)
AS
(
      SELECT @startDate
      UNION ALL
      SELECT DATEADD(d, 1, dt) FROM CTE
      WHERE dt < @endDate
)
Insert into @WeekDays(WeekDayDate,Day)
SELECT dt,DateName(Weekday, dt) FROM CTE  where datepart ("dw", dt) = @weekDay
and DateName(Weekday, dt) not like 'S%' --weekends
and not exists (select 1 from vwHolidaySchedule where crdate = convert(varchar(10), dt, 101) AND stkmkt = 1 and cucode = 'USD') --holidays
option (maxrecursion 0) ;

	RETURN 

END









GO
/****** Object:  UserDefinedFunction [dbo].[Util_fn_Split_Count]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  FUNCTION [dbo].[Util_fn_Split_Count] (
	@RowData VARCHAR(8000),
	@SplitOn nvarchar(5)
) RETURNS INT AS

BEGIN
	DECLARE @count INT

	
	Set @count = 1

	While (Charindex(@SplitOn,@RowData)>0)
	Begin
		

		Set @RowData = Substring(@RowData,Charindex(@SplitOn,@RowData)+1,len(@RowData))
		Set @count = @count + 1
	End

	RETURN @count

END





GO
/****** Object:  UserDefinedFunction [dbo].[Util_GetRGBInt]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[Util_GetRGBInt] (
	@color varchar(7)
) returns int
as 
begin
		
	declare @return int
	declare @redstr varchar(2), @greenstr varchar(2), @bluestr varchar(2)
	declare @red int, @green int, @blue int

	select @color = replace(@color, '#', '')
	select @redstr = left(@color, 2)
	select @bluestr = right(@color, 2)
	select @greenstr = left(right(@color, 4), 2)
	
	select @red = convert(int, convert(varbinary, '0x'+@redstr, 1))
	select @green = convert(int, convert(varbinary, '0x'+@greenstr, 1))
	select @blue = convert(int, convert(varbinary, '0x'+@bluestr, 1))

	select @return = @red * power(2, 16) + @green * power(2, 8) + @blue
	
	return @return

end
GO
/****** Object:  UserDefinedFunction [dbo].[Util_IsOfficeDay]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   FUNCTION [dbo].[Util_IsOfficeDay]

	 ( @d DATETIME  ) 

RETURNS bit

AS

BEGIN


	DECLARE  @b bit
	SET @b = 1
	if @d is null Set @b = 0
	else
	begin
		if  datepart(dw, @d) = 1 or datepart(dw, @d) = 7 SET @b = 0
		-- 4/14/2009 dalvarado - accounting for non-US holidays in the cr table
		if exists (select 1 from vwHolidaySchedule where crdate = convert(varchar(10), @d, 101) AND stkmkt = 1 and cucode = 'USD') SET @b = 0
	end	
	RETURN @b

END










GO
/****** Object:  UserDefinedFunction [dbo].[Util_NextOfficeDay]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--==============================================================================
CREATE   FUNCTION [dbo].[Util_NextOfficeDay]

	 ( @d DATETIME  ) 

RETURNS datetime

AS

BEGIN


	DECLARE  @t datetime

	SET @t = dateadd(day, 1, @d)
	
	-- First check to see if @t is a weekend
		-- Sunday
		if  datepart(dw, @t) = 1
			set @t = dateadd(day, 1, @t)
		-- Saturday
		if  datepart(dw, @t) = 7
			set @t = dateadd(day, 2, @t)

	-- Now check to see if @t is a holiday and adjust (also continue to account for weekends)
	-- 4/14/2009 dalvarado - accounting for non-US holidays in the cr table
	while exists (select 1 from vwHolidaySchedule where crdate = convert(varchar(10), @t, 101) and stkmkt = 1 and cucode = 'USD') begin
		set @t = dateadd(day,1,@t)
		-- Is new date a weekend?
			-- Sunday
			if  datepart(dw, @t) = 1
				set @t = dateadd(day, 1, @t)
			-- Saturday
			if  datepart(dw, @t) = 7
				set @t = dateadd(day, 2, @t)
	end

	set @t = cast(@t as date)

	RETURN @t

END











GO
/****** Object:  UserDefinedFunction [dbo].[Util_NextOfficeDayMaintainTime]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   FUNCTION [dbo].[Util_NextOfficeDayMaintainTime]

	 ( @d DATETIME  ) 

RETURNS datetime

AS

BEGIN


	DECLARE  @t datetime

	SET @t = dateadd(day, 1, @d)
	
	-- First check to see if @t is a weekend
		-- Sunday
		if  datepart(dw, @t) = 1
			set @t = dateadd(day, 1, @t)
		-- Saturday
		if  datepart(dw, @t) = 7
			set @t = dateadd(day, 2, @t)

	-- Now check to see if @t is a holiday and adjust (also continue to account for weekends)
	-- 4/14/2009 dalvarado - accounting for non-US holidays in the cr table
	while exists (select 1 from vwHolidaySchedule where crdate = convert(varchar(10), @t, 101) and stkmkt = 1 and cucode = 'USD') begin
		set @t = dateadd(day,1,@t)
		-- Is new date a weekend?
			-- Sunday
			if  datepart(dw, @t) = 1
				set @t = dateadd(day, 1, @t)
			-- Saturday
			if  datepart(dw, @t) = 7
				set @t = dateadd(day, 2, @t)
	end

	RETURN @t

END











GO
/****** Object:  UserDefinedFunction [dbo].[Util_PriorOfficeDayMaintainTime]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--==============================================================================
CREATE   FUNCTION [dbo].[Util_PriorOfficeDayMaintainTime]

	 ( @d DATETIME  ) 

RETURNS datetime

AS

BEGIN


	DECLARE  @t datetime

	SET @t = dateadd(day, -1, @d)
	
	-- First check to see if @t is a weekend
		-- Sunday
		if  datepart(dw, @t) = 1
			set @t = dateadd(day,-2,@t)
		-- Saturday
		if  datepart(dw, @t) = 7
			set @t = dateadd(day,-1,@t)

	-- Now check to see if @t is a holiday and adjust (also continue to account for weekends)
	-- 4/13/2009 dalvarado - accounting for non-US holidays in the cr table
	while exists (select 1 from vwHolidaySchedule where crdate = convert(varchar(10), @t, 101) and stkmkt = 1 and cucode = 'USD') begin
		set @t = dateadd(day,-1,@t)
		-- Is new date a weekend?
			-- Sunday
			if  datepart(dw, @t) = 1
				set @t = dateadd(day,-2,@t)
			-- Saturday
			if  datepart(dw, @t) = 7
				set @t = dateadd(day,-1,@t)
	end

	RETURN @t

END









GO
/****** Object:  UserDefinedFunction [dbo].[Util_Split]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[Util_Split]
(
	@RowData nvarchar(max),
	@SplitOn nvarchar(5)
)  
RETURNS @RtnValue table 
(
	Id int identity(1,1),
	Data nvarchar(max)
) 
AS  
BEGIN 
	Declare @Cnt int
	Set @Cnt = 1

	While (Charindex(@SplitOn,@RowData)>0)
	Begin
		Insert Into @RtnValue (data)
		Select 
			Data = ltrim(rtrim(Substring(@RowData,1,Charindex(@SplitOn,@RowData)-1)))

		Set @RowData = Substring(@RowData,Charindex(@SplitOn,@RowData)+1,len(@RowData))
		Set @Cnt = @Cnt + 1
	End
	
	Insert Into @RtnValue (data)
	Select Data = ltrim(rtrim(@RowData))

	Return
END

GO
/****** Object:  UserDefinedFunction [dbo].[Util_StripHTML]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[Util_StripHTML] (@HTMLText VARCHAR(MAX))
RETURNS VARCHAR(MAX) AS
BEGIN
    DECLARE @Start INT
    DECLARE @End INT
    DECLARE @Length INT
    SET @Start = CHARINDEX('<',@HTMLText)
    SET @End = CHARINDEX('>',@HTMLText,CHARINDEX('<',@HTMLText))
    SET @Length = (@End - @Start) + 1
    WHILE @Start > 0 AND @End > 0 AND @Length > 0
    BEGIN
        SET @HTMLText = STUFF(@HTMLText,@Start,@Length,'')
        SET @Start = CHARINDEX('<',@HTMLText)
        SET @End = CHARINDEX('>',@HTMLText,CHARINDEX('<',@HTMLText))
        SET @Length = (@End - @Start) + 1
    END
    RETURN LTRIM(RTRIM(@HTMLText))
END


GO
/****** Object:  Table [dbo].[QCheck_Users]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Users](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ShortName] [varchar](50) NOT NULL,
	[FullName] [varchar](50) NOT NULL,
	[Email] [varchar](100) NOT NULL,
	[Password] [varchar](50) NOT NULL,
	[Admin] [bit] NOT NULL,
	[App] [int] NOT NULL,
	[empID] [int] NOT NULL,
	[DepartmentAdmin] [bit] NOT NULL,
	[Priorities] [bit] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[Beta] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_Password] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_QProcessTests]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_QProcessTests](
	[employee] [varchar](100) NULL,
	[grade] [decimal](5, 2) NULL,
	[gradeddt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_BonusTests]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[QCheck_BonusTests]
as

SELECT distinct gt.[employee], 500 - 100 * isnull(lowscores, 0) as bonus, u.empid, min(gt.gradeddt) as firstTestDt, max(gt.gradeddt) as finalTestDt
  FROM [dbo].[Grading_QProcessTests] gt
	left outer join (select employee, count(grade) as lowscores from [dbo].[Grading_QProcessTests] where grade < 90 group by employee) as l
		on l.employee = gt.employee
	left outer join [dbo].[qcheck_users] u
		on u.fullname = gt.employee
  where gt.gradeddt >= '2/1/2024'
	and gt.grade >= 90
	and isnull(lowscores, 0) < 3
   group by  gt.[employee], l.lowscores, u.empid
GO
/****** Object:  Table [dbo].[QCheck_Approval_ActiveChecklists]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_ActiveChecklists](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DueTime] [datetime] NOT NULL,
	[OrigDueTime] [datetime] NOT NULL,
	[ReminderDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[HasNaggedDue] [int] NOT NULL,
	[CompletedBy] [int] NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_ActiveChecklists] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_ChangeRequests]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_ChangeRequests](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[RequestingUser] [int] NOT NULL,
	[RequestDate] [datetime] NOT NULL,
	[ReadyForSupervisor] [bit] NOT NULL,
	[Approved] [bit] NOT NULL,
	[ApprovedUser] [int] NULL,
	[ApprovedDate] [datetime] NULL,
	[Rejected] [bit] NOT NULL,
	[RejectedUser] [int] NULL,
	[RejectedDate] [datetime] NULL,
	[IsActive] [bit] NOT NULL,
	[Comment] [varchar](1000) NULL
) ON [PRIMARY]
GO
/****** Object:  Index [pk]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [pk] ON [dbo].[QCheck_Approval_ChangeRequests]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_PendingApprovals]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create view  [dbo].[QCheck_PendingApprovals]
AS

		SELECT 
				distinct AAC.ActiveChecklistID
			FROM 
				QCheck_Approval_ChangeRequests CR
				INNER JOIN QCheck_Approval_ActiveChecklists AAC
					ON AAC.ChangeRequestID = CR.[ID]
			WHERE 
				CR.IsActive = 1
				AND CR.Approved = 0
				AND CR.Rejected = 0
				AND CR.ReadyForSupervisor = 1
GO
/****** Object:  Table [dbo].[QCheck_BonusTasks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BonusTasks](
	[userid] [int] NULL,
	[checklistid] [int] NULL,
	[activechecklistid] [int] NULL,
	[actiontype] [varchar](100) NULL,
	[dt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_BonusStatusEmails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BonusStatusEmails](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[UserID] [int] NOT NULL,
	[SentDt] [datetime] NOT NULL,
 CONSTRAINT [PK_QCheck_BonusStatusEmails] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_BonusEmailTasks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BonusEmailTasks](
	[userid] [int] NOT NULL,
	[dt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_BonusChangeRequests]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BonusChangeRequests](
	[userid] [int] NULL,
	[dt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_BonusUsers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BonusUsers](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[userid] [int] NULL,
	[bonusgroup] [varchar](100) NULL,
	[supervisoremail] [varchar](100) NULL,
	[startdt] [datetime] NULL,
	[enddt] [datetime] NULL,
 CONSTRAINT [PK_QCheck_BonusUsers] PRIMARY KEY CLUSTERED 
(
	[id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_BonusCommentsLog]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BonusCommentsLog](
	[userid] [int] NULL,
	[comments] [int] NULL,
	[dt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_BonusDatesAmounts]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE view [dbo].[QCheck_BonusDatesAmounts]
as

--original bonus plan from through 8/22/23
select u.fullname, u.empid, b.userid, b.dt, '2+ Comments' as usage, 3 as bonus, bu.bonusgroup
from QCheck_BonusCommentsLog b
inner join qcheck_users u
	on u.id = b.userid
inner join qcheck_bonususers bu
	on u.id = bu.userid
where comments >=2
and b.dt < '8/22/2023'

union 

--original bonus plan from through 8/22/23
select u.fullname, u.empid, b.userid, b.dt, 'Completed a task on time' as usage, 2, bu.bonusgroup
from QCheck_BonusTasks b
inner join qcheck_users u
	on u.id = b.userid
inner join qcheck_bonususers bu
	on u.id = bu.userid
and b.dt < '8/22/2023'

union 

-- bonus plan 8/22/23 - 2/1/24
select u.fullname, u.empid, b.userid, b.dt, 'Comments' as usage, case when comments >=3 then 3 else comments end as bonus, bu.bonusgroup
from QCheck_BonusCommentsLog b
inner join qcheck_users u
	on u.id = b.userid
inner join qcheck_bonususers bu
	on u.id = bu.userid
	and b.dt >= '8/22/2023'
	and b.dt < '2/1/24'

union 

select fullname, empid, userid, dt, usage, case when bonus > 3 then 3 else bonus end, bonusgroup
from
	(
	select u.fullname, u.empid, b.userid, b.dt, 'Completed tasks on time' as usage, count(activechecklistid) as bonus, bu.bonusgroup
	from QCheck_BonusTasks b
	inner join qcheck_users u
		on u.id = b.userid
	inner join qcheck_bonususers bu
		on u.id = bu.userid
	and b.dt >= '8/22/2023'
	and b.dt < '2/1/24'
	group by u.fullname, u.empid, b.userid, b.dt, bu.bonusgroup
	) as tasks

union 

--2/1/24 to present below
select u.fullname, u.empid, b.userid, b.sentdt as dt, 'Sent Status/Priority' as usage, 4 as bonus, bu.bonusgroup 
from [QCheck_BonusStatusEmails] b
	inner join qcheck_users u
		on u.id = b.userid
	inner join qcheck_bonususers bu
		on u.id = bu.userid
		
union 

select u.fullname, u.empid, b.userid, b.dt, 'Comments' as usage, comments as bonus, bu.bonusgroup
from QCheck_BonusCommentsLog b
inner join qcheck_users u
	on u.id = b.userid
inner join qcheck_bonususers bu
	on u.id = bu.userid
	and b.dt >= '2/1/24'

union

select fullname, empid, userid, dt, usage, bonus, bonusgroup
from
	(
	select u.fullname, u.empid, b.userid, b.dt, 'Completed tasks on time' as usage, count(activechecklistid) as bonus, bu.bonusgroup
	from QCheck_BonusTasks b
	inner join qcheck_users u
		on u.id = b.userid
	inner join qcheck_bonususers bu
		on u.id = bu.userid
	and b.dt >= '2/1/24'
	group by u.fullname, u.empid, b.userid, b.dt, bu.bonusgroup
	) as tasks

union

select u.fullname, u.empid, b.userid, b.dt, 'Created Email Task' as usage, 1 as bonus, bu.bonusgroup 
from [qcheck_bonusemailtasks] b
	inner join qcheck_users u
		on u.id = b.userid
	inner join qcheck_bonususers bu
		on u.id = bu.userid
	and b.dt >= '2/1/24'
	
union

select u.fullname, u.empid, b.userid, b.dt, 'Extension Request' as usage, 1 as bonus, bu.bonusgroup 
from QCheck_BonusChangeRequests b
	inner join qcheck_users u
		on u.id = b.userid
	inner join qcheck_bonususers bu
		on u.id = bu.userid
	and b.dt >= '2/1/24'

GO
/****** Object:  View [dbo].[QCheck_BonusMonths]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE view [dbo].[QCheck_BonusMonths]
as

select u.FullName, u.empid, bda.bonusgroup, bda.userid, datepart(year, bda.dt) as yr, datepart(month, bda.dt) as mnth, 
	sum(bonus) as bonus
from QCheck_BonusDatesAmounts bda
inner join qcheck_users u
	on u.id = bda.userid
where bda.dt < '2/1/2024'
group by u.FullName, datepart(year, bda.dt), datepart(month, bda.dt), bda.userid, bda.bonusgroup, u.empid

union all

select dailybonus.FullName, dailybonus.empid, dailybonus.bonusgroup, dailybonus.userid, datepart(year, dailybonus.dt) as yr, datepart(month, dailybonus.dt) as mnth, 
	sum(case when dailybonus.bonus > 30 then 30 else dailybonus.bonus end) as bonus
from
(
	select u.fullname, u.empid, bda.bonusgroup, bda.userid, cast(bda.dt as date) as dt, sum(bonus) as bonus
	from QCheck_BonusDatesAmounts bda
	inner join qcheck_users u
		on u.id = bda.userid
	where bda.dt >= '2/1/2024'
	group by  u.fullname, u.empid, bda.bonusgroup, bda.userid, cast(bda.dt as date)
) as dailybonus

group by dailybonus.FullName, datepart(year, dailybonus.dt), datepart(month, dailybonus.dt), dailybonus.userid, dailybonus.bonusgroup, dailybonus.empid

GO
/****** Object:  View [dbo].[vwEmployeeBonusByIndividual]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwEmployeeBonusByIndividual]
AS
	SELECT Employee	
		,TotalBonus = SUM(bonus) 
	FROM (
		SELECT Employee = FullName 
			,Bonus = SUM(bonus)
		FROM QCheck_BonusMonths
		GROUP BY FullName, empid, userid
		UNION ALL
		SELECT employee, bonus
		FROM
		[QCheck_BonusTests]
	) a
	GROUP BY employee
GO
/****** Object:  Table [dbo].[QCheck_GroupMembership]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_GroupMembership](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NOT NULL,
	[GroupID] [int] NOT NULL,
	[AsOf] [datetime] NOT NULL,
 CONSTRAINT [PK_QCheck_GroupMembership_1] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ActiveAssignments]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveAssignments](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[AssignmentsID] [int] NOT NULL,
 CONSTRAINT [PK_QCheck_ActiveAssignments] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ChecklistInstances]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistInstances](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[Name] [varchar](100) NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[ScheduleID] [int] NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreatedBy] [int] NULL,
 CONSTRAINT [PK_QCheck_ChecklistInstances] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ChecklistManagers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistManagers](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ManagerGroupID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreateDate] [datetime] NULL,
 CONSTRAINT [PK_QCheck_ChecklistManagers] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Checklists]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Checklists](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[Name] [varchar](500) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[Owner] [int] NULL,
	[Template] [bit] NOT NULL,
	[CreateDate] [datetime] NULL,
 CONSTRAINT [PK_QCheck_Checklists] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ChecklistName]    Script Date: 3/26/2024 10:44:00 AM ******/
CREATE NONCLUSTERED INDEX [ChecklistName] ON [dbo].[QCheck_Checklists]
(
	[Name] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_checklist_isdeltemplate]    Script Date: 3/26/2024 10:44:00 AM ******/
CREATE NONCLUSTERED INDEX [idx_checklist_isdeltemplate] ON [dbo].[QCheck_Checklists]
(
	[IsDeleted] ASC,
	[Template] ASC
)
INCLUDE([ID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [isdel]    Script Date: 3/26/2024 10:44:00 AM ******/
CREATE NONCLUSTERED INDEX [isdel] ON [dbo].[QCheck_Checklists]
(
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QCheck_Checklists69]    Script Date: 3/26/2024 10:44:00 AM ******/
CREATE NONCLUSTERED INDEX [QCheck_Checklists69] ON [dbo].[QCheck_Checklists]
(
	[IsDeleted] ASC,
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  FullTextIndex     Script Date: 3/26/2024 10:44:00 AM ******/
CREATE FULLTEXT INDEX ON [dbo].[QCheck_Checklists](
[Name] LANGUAGE 'English')
KEY INDEX [PK_QCheck_Checklists]ON ([PFSProcess], FILEGROUP [PRIMARY])
WITH (CHANGE_TRACKING = AUTO, STOPLIST = SYSTEM)

GO
ALTER TABLE [dbo].[QCheck_Checklists] ADD  CONSTRAINT [DF_QCheck_Checklists_IsDeleted]  DEFAULT (0) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Checklists] ADD  CONSTRAINT [DF_QCheck_Checklists_Template]  DEFAULT (0) FOR [Template]
GO
ALTER TABLE [dbo].[QCheck_Checklists] ADD  CONSTRAINT [DF_QCheck_Checklists_CreateDate]  DEFAULT (getdate()) FOR [CreateDate]
GO
/****** Object:  Table [dbo].[QCheck_ActiveChecklists]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveChecklists](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DueTime] [datetime] NOT NULL,
	[OrigDueTime] [datetime] NOT NULL,
	[ReminderDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[HasNaggedDue] [int] NOT NULL,
	[CompletedBy] [int] NULL,
	[IsNA] [bit] NULL,
	[NAReason] [varchar](max) NULL,
 CONSTRAINT [PK_QCheck_ActiveChecklists] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Groups]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Groups](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Name] [varchar](50) NOT NULL,
	[Owner] [int] NOT NULL,
	[SingleMemberGroup] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_Groups] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_OverdueTasksByController]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[QCheck_OverdueTasksByController] AS
	
	SELECT DISTINCT
		ac.ID AS ActiveChecklistID,
		ci.ID AS InstanceID,
		c.ID AS ChecklistID,
		cmgm.UserID AS ControllerID,
		c.Name AS ChecklistName,
		ac.DueTime,
		au.ID AS AssigneeID,
		au.ShortName,
		au.FullName,
		au.Email
	FROM 
		-- Tasks
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.ID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
			AND c.IsDeleted = 0
		-- Task controllers (so we can filter to @UserID)
		INNER JOIN QCheck_ChecklistManagers cm
			ON cm.ChecklistID = c.ID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups cmg
			ON cm.ManagerGroupID = cmg.ID
		INNER JOIN QCheck_GroupMembership cmgm
			ON cmgm.GroupID = cmg.ID
		-- Split out to individual assignees to get e-mail addresses
		INNER JOIN QCheck_ActiveAssignments aa
			ON aa.ActiveChecklistID = ac.ID
		INNER JOIN QCheck_Assignments a
			ON aa.AssignmentsID = a.ID
			AND a.IsDeleted = 0
		INNER JOIN QCheck_Groups ag
			ON a.GroupID = ag.ID
		INNER JOIN QCheck_GroupMembership agm
			ON ag.ID = agm.GroupID
		INNER JOIN QCheck_Users au
			ON agm.UserID = au.ID
			AND au.IsDeleted = 0
	WHERE
		ac.DueTime < GETDATE()
		AND ac.CompletedDate IS NULL
		
GO
/****** Object:  View [dbo].[vwEmployeeBonusByMonth]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwEmployeeBonusByMonth]
AS
	WITH BonusMonths AS (
		SELECT StartOfMonth = DATEFROMPARTS(yr, mnth, 1)
			,Bonus = SUM(bonus)
			,Locked = SUM(CASE WHEN bonus >= 50 THEN Bonus ELSE 0 END)
			,Pending = SUM(CASE WHEN bonus < 50 THEN Bonus ELSE 0 END)
		FROM QCheck_BonusMonths
		GROUP BY DATEFROMPARTS(yr, mnth, 1)
	)
	SELECT t2.StartOfMonth
		,t2.Bonus
		,t1.Locked
		,t1.Pending
	FROM (
		SELECT TOP 1 *
		FROM BonusMonths
		ORDER BY StartOfMonth DESC
	) t1
		RIGHT JOIN BonusMonths t2
		ON t2.StartOfMonth = t1.StartOfMonth
GO
/****** Object:  Table [dbo].[QStatus_DueDateChanges]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_DueDateChanges](
	[ActiveChecklistID] [int] NOT NULL,
	[DueDateOld] [datetime] NOT NULL,
	[UpdateDt] [datetime] NOT NULL,
	[ChangedBy] [varchar](100) NULL
) ON [PRIMARY]
GO
/****** Object:  Index [DDC_Updated]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [DDC_Updated] ON [dbo].[QStatus_DueDateChanges]
(
	[UpdateDt] ASC,
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_ActiveChecklists_DueDateChangeCount]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create view [dbo].[QCheck_ActiveChecklists_DueDateChangeCount]
AS

	select activechecklistid, count(updatedt) as duedatechanges from qstatus_duedatechanges
	group by activechecklistid
GO
/****** Object:  Table [dbo].[QCheck_Items]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Items](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[SequenceNum] [int] NOT NULL,
	[ItemTypeID] [int] NOT NULL,
	[Text] [varchar](max) NOT NULL,
	[URL] [varchar](1000) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_Items] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_MultiStep]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create view [dbo].[QCheck_MultiStep]
AS

	select checklistid 
	from qcheck_items
	where isdeleted = 0
	and itemtypeid = 1
	group by checklistid
	having count(id) > 1

GO
/****** Object:  Table [dbo].[QCheck_ActiveItemArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveItemArchive](
	[ID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[ChecklistItemID] [int] NOT NULL,
	[Text] [varchar](1000) NULL,
	[CompletedDate] [datetime] NULL,
	[CompletedBy] [int] NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ActiveItems]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveItems](
	[ID] [int] IDENTITY(1000000,1) NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[ChecklistItemID] [int] NOT NULL,
	[Text] [varchar](1000) NULL,
	[CompletedDate] [datetime] NULL,
	[CompletedBy] [int] NULL,
 CONSTRAINT [PK_QCheck_ActiveItems] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_ActiveItems_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[QCheck_ActiveItems_All] as 
	SELECT *, null as archivedt from QCheck_ActiveItems
	UNION ALL 
	SELECT * from QCheck_ActiveItemArchive

GO
/****** Object:  Table [dbo].[QCheck_ItemArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ItemArchive](
	[ID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[SequenceNum] [int] NOT NULL,
	[ItemTypeID] [int] NOT NULL,
	[Text] [varchar](max) NOT NULL,
	[URL] [varchar](1000) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_Items_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[QCheck_Items_All] as 
	SELECT *, null as archivedt from QCheck_Items
	UNION ALL 
	SELECT * from QCheck_ItemArchive

GO
/****** Object:  View [dbo].[QCheck_ControllerAssigneeInstances]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE View [dbo].[QCheck_ControllerAssigneeInstances]
as

	select ci.id 
	from QCheck_ChecklistManagers cm
	inner join qcheck_groupmembership gm1
	on gm1.groupid = cm.ManagerGroupID
	and cm.IsDeleted = 0
	inner join qcheck_checklistinstances ci
	on ci.checklistid = cm.checklistid
	and ci.isdeleted = 0
	inner join qcheck_assignments a
	on a.InstanceID = ci.id
	and a.IsDeleted = 0
	inner join QCheck_GroupMembership gm2
	on gm2.GroupID = a.groupid and
	gm2.userid = gm1.userid

GO
/****** Object:  View [dbo].[QCheck_MostRecentDeadlineRequests]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[QCheck_MostRecentDeadlineRequests] AS

SELECT 
	aac.ActiveChecklistID,
	MAX(aac.ChangeRequestID) AS ChangeRequestID
FROM 
	QCheck_Approval_ActiveChecklists aac
	INNER JOIN QCheck_Approval_ChangeRequests cr
		ON aac.ChangeRequestID = cr.ID
WHERE 
	-- Open change request
	cr.IsActive = 1 AND cr.ReadyForSupervisor = 1 AND cr.Approved = 0 AND cr.Rejected = 0
GROUP BY
	aac.ActiveChecklistID
GO
/****** Object:  Table [dbo].[QCheck_GroupArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_GroupArchive](
	[ID] [int] NOT NULL,
	[Name] [varchar](50) NOT NULL,
	[Owner] [int] NOT NULL,
	[SingleMemberGroup] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_Groups_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[QCheck_Groups_All] AS

SELECT 
	ID,
	Name,
	[Owner],
	SingleMemberGroup
FROM 
	QCheck_Groups

UNION 

SELECT 
	ID,
	Name,
	[Owner],
	SingleMemberGroup
FROM 
	QCheck_GroupArchive
GO
/****** Object:  Table [dbo].[QStatus_ActiveChecklistTaskTypeArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_ActiveChecklistTaskTypeArchive](
	[ActiveChecklistID] [int] NOT NULL,
	[TaskType] [int] NOT NULL,
	[Priority] [int] NOT NULL,
	[CreateDt] [datetime] NOT NULL,
	[ArchiveDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [actta_indx]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [actta_indx] ON [dbo].[QStatus_ActiveChecklistTaskTypeArchive]
(
	[TaskType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_ActiveChecklistTaskType]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_ActiveChecklistTaskType](
	[ActiveChecklistID] [int] NOT NULL,
	[TaskType] [int] NOT NULL,
	[Priority] [int] NOT NULL,
	[CreateDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [ACTT_Type]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [ACTT_Type] ON [dbo].[QStatus_ActiveChecklistTaskType]
(
	[TaskType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QStatus_ActiveChecklistTaskType_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[QStatus_ActiveChecklistTaskType_All] AS

SELECT 
	ActiveChecklistID,
	TaskType,
	[Priority],
	CreateDt,
	NULL AS ArchiveDt
FROM
	QStatus_ActiveChecklistTaskType

UNION

SELECT 
	ActiveChecklistID,
	TaskType,
	[Priority],
	CreateDt,
	ArchiveDt
FROM
	QStatus_ActiveChecklistTaskTypeArchive

GO
/****** Object:  Table [dbo].[QStatus_Supervisors]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_Supervisors](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ReportID] [int] NOT NULL,
	[SupervisorGroupID] [int] NOT NULL,
	[DirectSupervisor] [bit] NOT NULL,
	[InterestedParty] [bit] NOT NULL,
	[AsOf] [datetime] NOT NULL,
 CONSTRAINT [PK_QStatus_Supervisors] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_Report]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_Report](
	[ID] [int] IDENTITY(10000,1) NOT FOR REPLICATION NOT NULL,
	[Name] [varchar](50) NULL,
	[IsConfidential] [bit] NOT NULL,
	[LastReportDate] [datetime] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[IsDirty] [bit] NULL,
 CONSTRAINT [PK_QStatus_Report] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_SupervisorsList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QStatus_SupervisorsList] (
	@UserID INT = NULL,
	@Login VARCHAR(50) = NULL
) RETURNS TABLE AS

RETURN (

	SELECT DISTINCT
		G.[ID] AS GroupID,
		SU.[ID] As UserID,
		SU.empID,
		G.[Name] AS GroupName,
		SU.ShortName,
		SU.FullName,
		SU.Email
	FROM 
		QCheck_Users U
		INNER JOIN QStatus_Report R
			ON U.FullName = R.[Name]
		INNER JOIN QStatus_Supervisors S
			ON R.[ID] = S.ReportID
			AND S.DirectSupervisor = 1
			AND S.InterestedParty = 0
		INNER JOIN QCheck_Groups G
			ON S.SupervisorGroupID = G.[ID]
		INNER JOIN QCheck_Users SU
			ON G.Owner = SU.[ID]
	WHERE
		U.ShortName = ISNULL(@Login, U.ShortName)
		AND U.[ID] = ISNULL(@UserID, U.[ID])
		AND SU.IsDeleted = 0

)
GO
/****** Object:  UserDefinedFunction [dbo].[QStatus_SuperviseesList]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[QStatus_SuperviseesList] (
	@UserID INT = NULL
) RETURNS TABLE AS

RETURN (

	SELECT 
		U.[ID],
		U.FullName
	FROM 
		QCheck_Users U
		INNER JOIN QStatus_Report R
			ON U.FullName = R.[Name]
		INNER JOIN QStatus_Supervisors S
			ON R.[ID] = S.ReportID
			AND S.DirectSupervisor = 1
			AND S.InterestedParty = 0
		INNER JOIN QCheck_Groups G
			ON S.SupervisorGroupID = G.[ID]
		INNER JOIN QCheck_Users SU
			ON G.Owner = SU.[ID]
	WHERE
		SU.IsDeleted = 0
		AND U.IsDeleted = 0
		AND SU.[ID] = ISNULL(@UserID, SU.[ID])
)

GO
/****** Object:  Table [dbo].[QStatus_Comments]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_Comments](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ForeignKeyID] [int] NOT NULL,
	[Comments] [varchar](1500) NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[TabIn] [int] NOT NULL,
	[CommentDt] [datetime] NOT NULL,
	[Initials] [varchar](100) NOT NULL,
	[UserID] [int] NOT NULL,
	[ReplyID] [int] NULL,
	[SpecialTask] [bit] NOT NULL,
 CONSTRAINT [PK_QStatus_Comments] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_CommentArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_CommentArchive](
	[ArchiveID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ID] [int] NOT NULL,
	[ForeignKeyID] [int] NOT NULL,
	[Comments] [varchar](1500) NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[TabIn] [int] NOT NULL,
	[CommentDt] [datetime] NOT NULL,
	[Initials] [varchar](100) NOT NULL,
	[UserID] [int] NOT NULL,
	[ReplyID] [int] NULL,
	[SpecialTask] [bit] NOT NULL,
	[AsOfDate] [datetime] NOT NULL,
 CONSTRAINT [PK_QStatus_CommentArchive] PRIMARY KEY CLUSTERED 
(
	[ArchiveID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QStatus_Comments_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[QStatus_Comments_All] AS

SELECT 
	NULL As ArchiveID,
	ID,
	ForeignKeyID,
	Comments,
	DisplayOrder,
	TabIn,
	CommentDt,
	Initials,
	UserID,
	ReplyID,
	SpecialTask,
	NULL AS AsOfDate 
FROM 
	QStatus_Comments

UNION

SELECT 
	ArchiveID,
	ID,
	ForeignKeyID,
	Comments,
	DisplayOrder,
	TabIn,
	CommentDt,
	Initials,
	UserID,
	ReplyID,
	SpecialTask,
	AsOfDate 
FROM 
	QStatus_CommentArchive
GO
/****** Object:  Table [dbo].[QCheck_Schedule]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Schedule](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[firstDueDate] [datetime] NOT NULL,
	[lastDueDate] [datetime] NULL,
	[freqType] [int] NOT NULL,
	[freqInterval] [int] NULL,
	[freqRecurrance] [int] NULL,
	[dueTime] [float] NOT NULL,
	[busDayBehavior] [int] NOT NULL,
	[SoftDueOffsetDays] [int] NULL,
	[busDayValue] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [pkid]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE UNIQUE CLUSTERED INDEX [pkid] ON [dbo].[QCheck_Schedule]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ScheduleArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ScheduleArchive](
	[ID] [int] NOT NULL,
	[firstDueDate] [datetime] NOT NULL,
	[lastDueDate] [datetime] NULL,
	[freqType] [int] NOT NULL,
	[freqInterval] [int] NULL,
	[freqRecurrance] [int] NULL,
	[dueTime] [float] NOT NULL,
	[busDayBehavior] [int] NOT NULL,
	[SoftDueOffsetDays] [int] NULL,
	[busDayValue] [int] NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_Schedule_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[QCheck_Schedule_All] AS

SELECT 
	ID,
	firstDueDate,
	lastDueDate,
	freqType,
	freqInterval,
	freqRecurrance,
	dueTime,
	busDayBehavior,
	SoftDueOffsetDays,
	busDayValue
FROM 
	QCheck_Schedule

UNION

SELECT 
	ID,
	firstDueDate,
	lastDueDate,
	freqType,
	freqInterval,
	freqRecurrance,
	dueTime,
	busDayBehavior,
	SoftDueOffsetDays,
	busDayValue
FROM 
	QCheck_ScheduleArchive
GO
/****** Object:  Table [dbo].[QCheck_Approval_Assignments]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_Assignments](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[AssignmentID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[GroupID] [int] NOT NULL,
	[DtAssigned] [datetime] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_Assignments] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_Items]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_Items](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ItemID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[SequenceNum] [int] NOT NULL,
	[ItemTypeID] [int] NOT NULL,
	[Text] [varchar](max) NOT NULL,
	[URL] [varchar](1000) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_Items] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_Approval_ChangeRequestChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	create view [dbo].[QCheck_Approval_ChangeRequestChecklist]
	AS
		
		SELECT
			c.id, ac.ChangeRequestID
		FROM 
			QCheck_Approval_ActiveChecklists AC
			INNER JOIN QCheck_ChecklistInstances CI
				ON AC.InstanceID = CI.[ID]
			INNER JOIN QCheck_Checklists C
				ON CI.ChecklistID = C.[ID]

		union 

		SELECT
				C.[ID], I.ChangeRequestID 
			FROM 
				QCheck_Approval_Items I
				INNER JOIN QCheck_Checklists C
					ON I.ChecklistID = C.[ID]

		union 
		
		SELECT
				C.[ID], A.ChangeRequestID
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_ChecklistInstances CI
					ON A.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
GO
/****** Object:  Table [dbo].[QCheck_ActiveChecklistArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveChecklistArchive](
	[ID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DueTime] [datetime] NOT NULL,
	[OrigDueTime] [datetime] NOT NULL,
	[ReminderDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[HasNaggedDue] [int] NOT NULL,
	[CompletedBy] [int] NULL,
	[IsNA] [bit] NULL,
	[NAReason] [varchar](max) NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Index [ACA_ArchiveDate]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [ACA_ArchiveDate] ON [dbo].[QCheck_ActiveChecklistArchive]
(
	[ArchiveDate] DESC,
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_ActiveChecklists_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[QCheck_ActiveChecklists_All] as 
	SELECT *, null as archivedt from QCheck_ActiveChecklists
	UNION ALL 
	SELECT * from QCheck_ActiveChecklistArchive

GO
/****** Object:  Table [dbo].[QCheck_ChecklistArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistArchive](
	[ID] [int] NOT NULL,
	[Name] [varchar](500) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[Owner] [int] NULL,
	[Template] [bit] NOT NULL,
	[CreateDate] [datetime] NULL,
	[ArchiveDate] [datetime] NOT NULL,
 CONSTRAINT [PK_QCheck_ChecklistArchive] PRIMARY KEY NONCLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Index [ChecklistArchive_Date]    Script Date: 3/26/2024 2:48:04 PM ******/
CREATE CLUSTERED INDEX [ChecklistArchive_Date] ON [dbo].[QCheck_ChecklistArchive]
(
	[ArchiveDate] DESC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  FullTextIndex     Script Date: 3/26/2024 2:48:04 PM ******/
CREATE FULLTEXT INDEX ON [dbo].[QCheck_ChecklistArchive](
[Name] LANGUAGE 'English')
KEY INDEX [PK_QCheck_ChecklistArchive]ON ([ft], FILEGROUP [PRIMARY])
WITH (CHANGE_TRACKING = AUTO, STOPLIST = SYSTEM)

GO
ALTER TABLE [dbo].[QCheck_ChecklistArchive] ADD  CONSTRAINT [DF_QCheck_ChecklistArchive_Template]  DEFAULT ((0)) FOR [Template]
GO
/****** Object:  View [dbo].[QCheck_Checklists_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[QCheck_Checklists_All] as 
	SELECT *, null as archivedt from QCheck_Checklists
	UNION ALL 
	SELECT * from QCheck_ChecklistArchive

GO
/****** Object:  View [dbo].[QCheck_SelfManaged]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create view [dbo].[QCheck_SelfManaged]
AS

	select ci.ID from QCheck_ChecklistInstances ci
		inner join qcheck_checklists c
			on ci.checklistid = c.id
			and ci.IsDeleted = 0
			and c.IsDeleted = 0
		inner join QCheck_ChecklistManagers m
			on m.ChecklistID = c.id
			and m.IsDeleted = 0
		inner join qcheck_groups g1
			on g1.ID = m.ManagerGroupID
		inner join QCheck_GroupMembership gm1
			on gm1.GroupID = g1.id
		inner join qcheck_assignments a
			on a.InstanceID = ci.id
			and a.IsDeleted = 0
		inner join qcheck_groups g2
			on g2.id = a.GroupID
		inner join QCheck_GroupMembership gm2
			on gm2.groupid = g2.id
		inner join qcheck_users u1
			on u1.id = gm1.userid
			and u1.id = gm2.userid
			and u1.IsDeleted = 0
GO
/****** Object:  Table [dbo].[QCheck_ChecklistInstanceArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistInstanceArchive](
	[ID] [int] NOT NULL,
	[Name] [varchar](100) NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[ScheduleID] [int] NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreatedBy] [int] NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [InstanceArchive_ArchiveDate]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [InstanceArchive_ArchiveDate] ON [dbo].[QCheck_ChecklistInstanceArchive]
(
	[ArchiveDate] DESC,
	[ID] ASC,
	[ChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_ChecklistInstances_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[QCheck_ChecklistInstances_All] as 
	SELECT *, null as archivedt from QCheck_ChecklistInstances
	UNION ALL 
	SELECT * from QCheck_ChecklistInstanceArchive

GO
/****** Object:  Table [dbo].[QCheck_AssignmentArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AssignmentArchive](
	[ID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[GroupID] [int] NOT NULL,
	[DtAssigned] [datetime] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [IX_QCheck_AssignmentArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [IX_QCheck_AssignmentArchive] ON [dbo].[QCheck_AssignmentArchive]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_Assignments_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE view [dbo].[QCheck_Assignments_All] as 
	SELECT *, null as archivedt from QCheck_Assignments where IsDeleted =0
	UNION ALL 
	SELECT * from QCheck_AssignmentArchive where IsDeleted =0

GO
/****** Object:  Table [dbo].[QCheck_ActiveAssignmentArchive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveAssignmentArchive](
	[ID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[AssignmentsID] [int] NOT NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [AAssA_PK]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE CLUSTERED INDEX [AAssA_PK] ON [dbo].[QCheck_ActiveAssignmentArchive]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_ActiveAssignments_All]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[QCheck_ActiveAssignments_All] as 
	SELECT *, null as archivedt from QCheck_ActiveAssignments
	UNION ALL 
	SELECT * from QCheck_ActiveAssignmentArchive
GO
/****** Object:  View [dbo].[vwAllChecklists]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwAllChecklists] AS

SELECT [ID], [Name], [IsDeleted], [Owner], [Template], NULL AS ArchiveDate FROM [QCheck_Checklists]

UNION

SELECT [ID], [Name], [IsDeleted], [Owner], [Template], [ArchiveDate] FROM [QCheck_ChecklistArchive]
GO
/****** Object:  View [dbo].[vwAllChecklistInstances]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwAllChecklistInstances] AS

SELECT [ID], [Name], [ChecklistID], [ScheduleID], [IsDeleted], [CreatedBy], NULL AS [ArchiveDate] FROM [QCheck_ChecklistInstances]

UNION

SELECT [ID], [Name], [ChecklistID], [ScheduleID], [IsDeleted], [CreatedBy], [ArchiveDate] FROM [QCheck_ChecklistInstanceArchive]


GO
/****** Object:  View [dbo].[vwAllActiveChecklists]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vwAllActiveChecklists] AS

SELECT [ID], [InstanceID], [DueTime], [OrigDueTime], [CompletedDate], [HasNaggedDue], [CompletedBy], NULL AS [ArchiveDate] FROM [QCheck_ActiveChecklists]

UNION

SELECT [ID], [InstanceID], [DueTime], [OrigDueTime], [CompletedDate], [HasNaggedDue], [CompletedBy], [ArchiveDate] FROM [QCheck_ActiveChecklistArchive]




GO
/****** Object:  Table [dbo].[QPI_Users]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QPI_Users](
	[ID] [int] NOT NULL,
	[ShortName] [varchar](50) NOT NULL,
	[FullName] [varchar](50) NOT NULL,
	[Email] [varchar](100) NOT NULL,
	[Password] [varchar](50) NOT NULL,
	[Admin] [bit] NOT NULL,
	[App] [int] NOT NULL,
	[empID] [int] NOT NULL,
	[DepartmentAdmin] [bit] NOT NULL,
	[Priorities] [bit] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
 CONSTRAINT [PK_QPI_Users] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ItemTypes]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ItemTypes](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[Name] [varchar](50) NOT NULL,
	[NativeType] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_ItemTypes] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_UpcomingDueTimes]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_UpcomingDueTimes](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DueTime] [datetime] NOT NULL,
	[RelativeDueTime] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [pkid]    Script Date: 3/22/2024 4:20:57 PM ******/
CREATE UNIQUE CLUSTERED INDEX [pkid] ON [dbo].[QCheck_UpcomingDueTimes]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = ON, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QStatus_QPI_TaskDetails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE View [dbo].[QStatus_QPI_TaskDetails]
as
select u.ShortName, x.*
	from (

		SELECT 
		c.Name as ChecklistName, 
		gm.UserID As AssignedTo,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			-- 0 in join clause is a replacement of @recurrance from QCheck_GetUserChecklists
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and 0 = 2) and Not (s.freqType > 1 and 0 = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_Assignments f  on 
				-- f.AssignedTo = @loginID And 
				f.IsDeleted = 0 and f.InstanceID = b.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = f.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID		
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN qpi_users u on e.CompletedBy = u.ID
	        WHERE
		(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate())))
		-- AND (@activeChecklistID = 0 or a.ID = @activeChecklistID)
		-- AND @instanceID = 0
		AND a.dueTime between GetDate() and DateAdd(mm, 1, getdate())
		
	
		UNION 
	
		-- get future checklists
		SELECT 
		c.Name as ChecklistName, 
		gm.UserID AS AssignedTo,
		j.Name as ItemType, 
		d.Text, 
		d.URL, 
		null As UserText, 
		null As CompletedBy, 
		null As CompletedDate,
		d.ID as ItemID,
		b.ID As Identifier,
		upcoming1.ID as UniqueID, 
		d.SequenceNum, 
		upcoming1.DueTime as dueTime, 
		upcoming1.ID as UpcomingID,
		null As ActiveChkCompletedDate, 
		f.ID as AssignmentID, 
		'12/12/9999' As Computed, 	
		2 As ChkType, 
		0 as CompletedByID,
		upcoming1.DueTime as dueSort
		FROM
			QCheck_ChecklistInstances b
			INNER JOIN QCheck_UpcomingDueTimes upcoming1
				ON b.ID = upcoming1.instanceID
				and upcoming1.DueTime between GetDate() and DateAdd(mm, 1, getdate())
			INNER JOIN QCheck_Schedule s 
				ON b.ScheduleID = s.ID 
				-- 0 in join clause is a replacement of @recurrance from QCheck_GetUserChecklists
				and Not (s.freqType = 1 and 0 = 2) 
				and Not (s.freqType > 1 and 0 = 1)
			INNER JOIN QCheck_Checklists c 
				on b.checklistID = c.ID 
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d 
				on d.checklistID = c.ID 
				AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j 
				on d.ItemTypeID = j.ID
			INNER JOIN QCheck_Assignments f  on 
				-- f.AssignedTo = @loginID And 
				f.IsDeleted = 0 and f.InstanceID = b.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = f.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID		
			LEFT OUTER JOIN QCheck_ActiveChecklists ac
				ON ac.InstanceID = upcoming1.InstanceID
				AND ac.OrigDueTime = upcoming1.DueTime
				
			
		WHERE 
			not b.isDeleted = 1 
			--AND (0 = 0 or b.ID = 0)
			--AND @activeChecklistID = 0
			AND ac.ID is null
		) X
			inner join qpi_users U
				on u.id = X.assignedto
		
/*		ORDER BY --ChkType,
			Computed desc,
			dueSort,
			ChecklistName,
			Identifier,
			SequenceNum
*/

GO
/****** Object:  View [dbo].[vwAllActiveChecklistTaskTypes]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwAllActiveChecklistTaskTypes] AS

SELECT [ActiveChecklistID], [TaskType], [Priority], [CreateDt], NULL AS [ArchiveDt] FROM [QStatus_ActiveChecklistTaskType]

UNION

SELECT [ActiveChecklistID], [TaskType], [Priority], [CreateDt], [ArchiveDt] FROM [QStatus_ActiveChecklistTaskTypeArchive]


GO
/****** Object:  View [dbo].[vwAllComments]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwAllComments] AS

SELECT NULL AS [ArchiveID], [ID], [ForeignKeyID], [Comments], [DisplayOrder], [TabIn], [CommentDt], [Initials], [UserID], [ReplyID], [SpecialTask], NULL AS [AsOfDate] FROM [QStatus_Comments]

UNION

SELECT [ArchiveID], [ID], [ForeignKeyID], [Comments], [DisplayOrder], [TabIn], [CommentDt], [Initials], [UserID], [ReplyID], [SpecialTask], [AsOfDate] FROM [QStatus_CommentArchive]


GO
/****** Object:  View [dbo].[QStatus_QPI_AssignedTasksComingDue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[QStatus_QPI_AssignedTasksComingDue]
as
select distinct UniqueID, ShortName, AssignedTo, Checklistname, DueTime 
 from QStatus_QPI_TaskDetails

GO
/****** Object:  View [dbo].[QStatus_QPI_AssignedTaskStepsComingDue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[QStatus_QPI_AssignedTaskStepsComingDue]
as 
select *
 from QStatus_QPI_TaskDetails
where itemtype = 'Checkbox'
		

GO
/****** Object:  View [dbo].[QStatus_QPI_TaskDetailsOverdue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE View [dbo].[QStatus_QPI_TaskDetailsOverdue]
as
select u.ShortName, x.*
	from (

		SELECT 
		c.Name as ChecklistName, 
		gm.UserID as AssignedTo,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			-- 0 in join clause is a replacement of @recurrance from QCheck_GetUserChecklists
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and 0 = 2) and Not (s.freqType > 1 and 0 = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_Assignments f  on 
				-- f.AssignedTo = @loginID And 
				f.IsDeleted = 0 and f.InstanceID = b.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = f.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID			
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN qpi_users u on e.CompletedBy = u.ID
	        WHERE
		(a.CompletedDate is null)
		-- AND (@activeChecklistID = 0 or a.ID = @activeChecklistID)
		-- AND @instanceID = 0
		AND a.dueTime <= GetDate() 
		
		) X
			inner join qpi_users U
				on u.id = X.assignedto
		
/*		ORDER BY --ChkType,
			Computed desc,
			dueSort,
			ChecklistName,
			Identifier,
			SequenceNum
*/

GO
/****** Object:  View [dbo].[QStatus_QPI_AssignedTasksOverdue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[QStatus_QPI_AssignedTasksOverdue] 
as
select distinct UniqueID, ShortName, AssignedTo, Checklistname, DueTime 
from QStatus_QPI_TaskDetailsOverdue

GO
/****** Object:  View [dbo].[QCheck_CurrentBonusUsers]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create view [dbo].[QCheck_CurrentBonusUsers]
as
	select userid from qcheck_bonususers 
						where isnull(startdt, '1/1/2021') < getdate()
							and isnull(enddt, '1/1/2500') > getdate()
GO
/****** Object:  View [dbo].[QStatus_QPI_ControllerTaskDetailsOverdue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE View [dbo].[QStatus_QPI_ControllerTaskDetailsOverdue]
as
select u.ShortName, x.*
	from (

		SELECT 
		c.Name as ChecklistName, 
		gm.UserID as ManagerID,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			-- 0 in join clause is a replacement of @recurrance from QCheck_GetUserChecklists
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and 0 = 2) and Not (s.freqType > 1 and 0 = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_ChecklistManagers f  on 
				-- f.AssignedTo = @loginID And 
				f.IsDeleted = 0 and f.CheckListID = c.ID
			INNER JOIN QCheck_Groups g on g.ID = f.ManagerGroupID
			INNER JOIN QCheck_GroupMembership gm on gm. GroupID = g.ID			
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN qpi_users u on e.CompletedBy = u.ID
	        WHERE
		(a.CompletedDate is null)
		-- AND (@activeChecklistID = 0 or a.ID = @activeChecklistID)
		-- AND @instanceID = 0
		AND a.dueTime <= GetDate() 
		
		) X
			inner join qpi_users U
				on u.id = X.ManagerID
		
/*		ORDER BY --ChkType,
			Computed desc,
			dueSort,
			ChecklistName,
			Identifier,
			SequenceNum
*/

/*
select * from [QStatus_QPI_ControllerTaskDetailsOverdue]
where checklistname = 'Hurst Disaster Recovery'
*/

GO
/****** Object:  View [dbo].[QStatus_QPI_ControllerTasksOverdue]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[QStatus_QPI_ControllerTasksOverdue] 
as
select distinct UniqueID, ShortName, ManagerID, Checklistname, DueTime 
from QStatus_QPI_ControllerTaskDetailsOverdue

GO
/****** Object:  View [dbo].[QStatus_QPI_TaskDetailsCompleted]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE View [dbo].[QStatus_QPI_TaskDetailsCompleted]
as
select u.ShortName, x.*
	from (

		SELECT 
		c.Name as ChecklistName, 
		gm.UserID as AssignedTo,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			-- 0 in join clause is a replacement of @recurrance from QCheck_GetUserChecklists
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and 0 = 2) and Not (s.freqType > 1 and 0 = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_Assignments f  on 
				-- f.AssignedTo = @loginID And 
				f.IsDeleted = 0 and f.InstanceID = b.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = f.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID		
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN qpi_users u on e.CompletedBy = u.ID
	        WHERE
		(a.CompletedDate is not null)
		-- AND (@activeChecklistID = 0 or a.ID = @activeChecklistID)
		-- AND @instanceID = 0
		) X
			inner join qpi_users U
				on u.id = X.assignedto

GO
/****** Object:  View [dbo].[QCheck_ControllerAssigneeInstances_all]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE View [dbo].[QCheck_ControllerAssigneeInstances_all]
as

	select ci.id 
	from QCheck_ChecklistManagers cm
	inner join qcheck_groupmembership gm1
	on gm1.groupid = cm.ManagerGroupID
	and cm.IsDeleted = 0
	inner join qcheck_checklistinstances_all ci
	on ci.checklistid = cm.checklistid
	and ci.isdeleted = 0
	inner join qcheck_assignments_all a
	on a.InstanceID = ci.id
	and a.IsDeleted = 0
	inner join QCheck_GroupMembership gm2
	on gm2.GroupID = a.groupid and
	gm2.userid = gm1.userid

GO
/****** Object:  Table [dbo].[QStatus_SupervisorOverride]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SupervisorOverride](
	[UserID] [int] NOT NULL,
	[SupervisorID] [int] NOT NULL,
 CONSTRAINT [PK_QStatus_SupervisorOverride] PRIMARY KEY CLUSTERED 
(
	[UserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[Q_Supervisors]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  VIEW [dbo].[Q_Supervisors] AS

	SELECT DISTINCT
		G.[ID],
		G.[Name]
	FROM 
		QCheck_Users U
		INNER JOIN QStatus_Report R
			ON U.FullName = R.[Name]
		INNER JOIN QStatus_Supervisors S
			ON R.[ID] = S.ReportID
			AND S.DirectSupervisor = 1
			AND S.InterestedParty = 0
		INNER JOIN QCheck_Groups G
			ON S.SupervisorGroupID = G.[ID]
			AND g.SingleMemberGroup = 1
		INNER JOIN QCheck_GroupMembership gm
			ON gm.groupid = g.id
		INNER JOIN QCheck_GroupMembership gm2
			ON gm2.userid = u.ID
		INNER JOIN QCheck_Groups g2
			on g2.ID = gm.groupid
			and g2.singlemembergroup = 1
	WHERE
		U.IsDeleted = 0
		AND R.IsDeleted = 0
		AND gm.userID not in (SELECT SupervisorID from QStatus_SupervisorOverride)
		AND u.id not in (SELECT UserID from QStatus_SupervisorOverride)

	UNION ALL

	SELECT 
		DISTINCT
		G.[ID],
		G.[Name]	 
	FROM QCheck_Groups g
	INNER JOIN QCheck_GroupMembership gm
		ON g.id = gm.groupid
	INNER JOIN QStatus_SupervisorOverride s
		ON s.supervisorid = gm.userid
	INNER JOIN QCheck_GroupMembership gmUser
		on gmUser.userid = s.userID
	INNER JOIN QCheck_Users u
		ON s.supervisorid = u.ID
	WHERE 
		g.SingleMemberGroup = 1
		AND u.IsDeleted = 0
GO
/****** Object:  View [dbo].[QStatus_QPI_AssignedTasksCompleted]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE view [dbo].[QStatus_QPI_AssignedTasksCompleted]
as
select distinct UniqueID, ShortName, AssignedTo, Checklistname, DueTime, ActiveChkCompletedDate
from [QStatus_QPI_TaskDetailsCompleted]
GO
/****** Object:  Table [dbo].[QCheck_ChecklistManagers_Temp]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistManagers_Temp](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ManagerGroupID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[Expires] [datetime] NOT NULL,
 CONSTRAINT [PK_QCheck_ChecklistManagers_Temp] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  View [dbo].[QCheck_ChecklistManagers_WithTemp]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   VIEW [dbo].[QCheck_ChecklistManagers_WithTemp] AS

	SELECT ID, ManagerGroupID, ChecklistID, IsDeleted from QCheck_ChecklistManagers

	UNION ALL

	SELECT -1 as ID, managergroupid, checklistid, 0 as IsDeleted 
	from QCheck_ChecklistManagers_Temp
	WHERE expires > GETDATE()




GO
/****** Object:  View [dbo].[QStatus_UserSupervisors]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   VIEW [dbo].[QStatus_UserSupervisors] AS


SELECT DISTINCT
	U.[ID] AS UserID,
	UG.[ID] AS UserGroupID,
	SU.[ID] As SupervisorUserID,
	S.SupervisorGroupID
FROM 
	QCheck_Users U
	INNER JOIN QStatus_Report R
		ON U.FullName = R.[Name]
	INNER JOIN QStatus_Supervisors S
		ON R.[ID] = S.ReportID
	INNER JOIN QCheck_Groups SG
		ON S.SupervisorGroupID = SG.[ID]
	INNER JOIN QCheck_Groups UG
		ON U.[ID] = UG.Owner
	INNER JOIN QCheck_Users SU
		ON SG.Owner = SU.[ID]
WHERE
	U.IsDeleted = 0
	AND SU.IsDeleted = 0
	AND UG.SingleMemberGroup = 1
	AND S.DirectSupervisor = 1
	AND S.InterestedParty = 0
	AND R.IsDeleted = 0
	AND U.ID not in (SELECT UserID from QStatus_SupervisorOverride)

UNION ALL 

SELECT DISTINCT
	U.[ID] AS UserID,
	UG.[ID] AS UserGroupID,
	SU.[ID] As SupervisorUserID,
	S.ID as SupervisorGroupID
FROM 
	QCheck_Users U
	INNER JOIN QCheck_GroupMembership ugm
		ON ugm.UserID = u.ID
	INNER JOIN QCheck_Groups ug
		ON ug.ID = ugm.GroupID
		AND ug.SingleMemberGroup = 1 
	INNER JOIN QStatus_SupervisorOverride so
		ON u.ID = so.UserID
	INNER JOIN QCheck_Users su
		ON su.ID = so.SupervisorID
	INNER JOIN QCheck_GroupMembership sgm
		ON sgm.UserID = su.ID
	INNER JOIN QCheck_Groups s
		ON s.ID = sgm.GroupID
		AND s.SingleMemberGroup = 1 
WHERE
	U.IsDeleted = 0
	AND SU.IsDeleted = 0
GO
/****** Object:  View [dbo].[QStatus_QPI_AllActiveTaskDetails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE View [dbo].[QStatus_QPI_AllActiveTaskDetails]
as
SELECT 
		c.Name as ChecklistName, 
		gm.UserID as AssignedTo,
		UAssigned.ShortName,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID 
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_Assignments f  on 
				f.IsDeleted = 0 and f.InstanceID = b.ID
			INNER JOIN QCheck_Groups g on g.ID = f.GroupID
			INNER JOIN QCheck_GroupMembership gm on gm. GroupID = g.ID
			inner join qpi_users UAssigned on UAssigned.id = gm.UserID
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN qpi_users u on e.CompletedBy = u.ID
	        WHERE
		(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate())))

GO
/****** Object:  View [dbo].[QStatus_QPI_AllActiveTasks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[QStatus_QPI_AllActiveTasks] 
as
select distinct UniqueID, ShortName, AssignedTo, Checklistname, DueTime, ActiveChkCompletedDate
from [QStatus_QPI_AllActiveTaskDetails]

GO
/****** Object:  View [dbo].[tbldepartment]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---EXTERNAL REFERENCE---
CREATE VIEW [dbo].[tbldepartment]
AS
SELECT [DepartmentID] --int identity(1,1) - PK
      ,[Department] --varchar(50)
      ,[SupervisorId] --int - refers to employee IDs from HR/payroll
      ,[DefaultEmailDomain] --varchar(50)
 from AcmeDotNet.dbo.empDepartment
GO
/****** Object:  View [dbo].[tblEmployees]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[tblEmployees]
AS

SELECT 	EmpId as [EmployeeId], --int identity(1,1)
	[DepartmentID], --int
	[FirstName], --varchar(25)
	[LastName], --varchar(25)
	EmployeeName as [Names],  --varchar(51)
	[Initials],  --varchar(10)
	NetworkLogin as [LogInID], --varchar(25) 
	NetworkLogin, --varchar(25)
	QEmailAddress as [EMailAddress],  --varchar(75)
	[IsActive], --bit - logical delete flag
	[StartDate], --datetime
	DateCreated as [CreateDate], --datetime
	Picture as [Pic], --varchar(50), expects a filename in a known DFS share
	OfficeExtension as [ext], --varchar(5)
	[Alias], --varchar(25) - nickname 
	FlagPolicy as [IsPolicy], --bit - user is bound by standard company policy
	FlagLunch as [IsLunch], --bit - user participates in company lunch program
	FlagAppreciation as [IsAppreciation], --bit - user participates in employee-of-the-month program
	FlagPCAccess as [PCAccess], --bit - user has an AD login and reliable access to a domain-joined PC
	HireDate, --datetime
	TerminationDate, --datetime
	SupervisorID, --int
	empID, --int
	FullNameWithAlias = ISNULL(Alias, FirstName) + ' ' + LastName --varchar(52) - formula field, replaces first name with alias if specified	
FROM 	dbo.vw_empEmployees
Where  1=0 --for PFSProcess we arent pulling in employees

GO
/****** Object:  View [dbo].[vwHolidaySchedule]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   VIEW [dbo].[vwHolidaySchedule] AS
	SELECT [cucode] --Currency Code; all usages currently expect "USD"
		  ,[crdate] --Holiday Date
		  ,[crdesc] --Holiday Name
		  ,[stkmkt] --Stock Market holiday; if 1, the day is not an "office day"
		  ,[bank]   --Bank holiday; if either this field or [stkmkt] is 1, the day is not a "business day"
	  ---EXTERNAL REFERENCE---
	  FROM-- Widgets.[dbo].[vpm_cr]
	  (	SELECT 'USD' AS cucode
			,CAST('1997-01-01 00:00:00.000' as datetime) AS crdate
			,'New Year''s Day' AS crdesc
			,1 AS stkmkt
			,1 AS bank
	  ) t
	  WHERE 1=0
GO
/****** Object:  Table [dbo].[Audit_ActiveChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ActiveChecklist](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ActiveChecklistId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ActiveItem]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ActiveItem](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ActiveItemId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ApprovalChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ApprovalChecklist](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ApprovalChecklistId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ApprovalItem]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ApprovalItem](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ApprovalItemId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveActiveChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveActiveChecklist](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DueTime] [datetime] NOT NULL,
	[OrigDueTime] [datetime] NOT NULL,
	[ReminderDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[HasNaggedDue] [int] NOT NULL,
	[CompletedBy] [int] NULL,
	[IsNA] [bit] NULL,
	[NAReason] [varchar](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveActiveItem]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveActiveItem](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[ChecklistItemID] [int] NOT NULL,
	[Text] [varchar](1000) NULL,
	[CompletedDate] [datetime] NULL,
	[CompletedBy] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveApprovalChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveApprovalChecklist](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[Name] [varchar](500) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[Owner] [int] NULL,
	[Template] [bit] NOT NULL,
	[CRItemID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveApprovalItem]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveApprovalItem](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ItemID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[SequenceNum] [int] NOT NULL,
	[ItemTypeID] [int] NOT NULL,
	[Text] [varchar](max) NOT NULL,
	[URL] [varchar](1000) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[CRItemID] [int] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveChecklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveChecklist](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[Name] [varchar](500) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[Owner] [int] NULL,
	[Template] [bit] NOT NULL,
	[CreateDate] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveComment]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveComment](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[ForeignKeyID] [int] NOT NULL,
	[Comments] [varchar](1500) NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[TabIn] [int] NOT NULL,
	[CommentDt] [datetime] NOT NULL,
	[Initials] [varchar](100) NOT NULL,
	[UserID] [int] NOT NULL,
	[ReplyID] [int] NULL,
	[SpecialTask] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ArchiveItem]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ArchiveItem](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[ArchiveDt] [datetime] NOT NULL,
	[ID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[SequenceNum] [int] NOT NULL,
	[ItemTypeID] [int] NOT NULL,
	[Text] [varchar](max) NOT NULL,
	[URL] [varchar](1000) NOT NULL,
	[IsDeleted] [bit] NOT NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_ChangeRequest]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_ChangeRequest](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ChangeRequestId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_Checklist]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_Checklist](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ChecklistId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_Comment]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_Comment](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[CommentId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_CommentArchived]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_CommentArchived](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[CommentArchivedId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_Item]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_Item](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ItemId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_Report]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_Report](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[ReportId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_TaskType]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_TaskType](
	[UID] [bigint] IDENTITY(1,1) NOT NULL,
	[UserId] [int] NOT NULL,
	[TaskTypeId] [int] NOT NULL,
	[AuditTypeId] [tinyint] NOT NULL,
	[AuditDt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Audit_Type]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Audit_Type](
	[AuditTypeId] [tinyint] IDENTITY(1,1) NOT NULL,
	[Name] [varchar](255) NOT NULL,
PRIMARY KEY CLUSTERED 
(
	[AuditTypeId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[BTTemp]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BTTemp](
	[id] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[CB_Tasks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[CB_Tasks](
	[TaskID] [int] NULL,
	[MainID] [int] NULL,
	[FldID] [int] NULL,
	[BuySellMonitor] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Email2dbImageChecklists]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Email2dbImageChecklists](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[uid] [varchar](1000) NULL,
	[checklistid] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Email2dbImageChecklists_Archive]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Email2dbImageChecklists_Archive](
	[id] [int] NULL,
	[uid] [varchar](1000) NULL,
	[checklistid] [int] NULL,
	[archivedt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[EO_Tasks]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[EO_Tasks](
	[TaskID] [int] NOT NULL,
	[TransactionID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Admins]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Admins](
	[UserID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_AssigneeEmails]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_AssigneeEmails](
	[email] [varchar](max) NOT NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NOT NULL,
	[Dt] [datetime] NOT NULL,
	[Type] [varchar](50) NOT NULL,
	[Description] [varchar](1000) NOT NULL,
	[KeyID] [int] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
 CONSTRAINT [PK_Grading_Daily] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_Comments]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_Comments](
	[UserReportID] [int] NOT NULL,
	[CommentID] [int] NOT NULL,
	[CommentDt] [datetime] NOT NULL,
	[Comments] [varchar](2000) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_Criteria]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_Criteria](
	[GradingPeriodID] [int] NULL,
	[Criteria] [varchar](50) NOT NULL,
	[CriteriaValue] [float] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_Final]    Script Date: 3/22/2024 4:20:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_Final](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[GradingPeriodID] [int] NOT NULL,
	[UserID] [int] NOT NULL,
	[Dt] [datetime] NOT NULL,
	[Reason] [varchar](2000) NOT NULL,
	[Points] [float] NOT NULL,
	[IsDeleted] [int] NOT NULL,
 CONSTRAINT [PK_Grading_Daily_Final] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_Final_Deleted]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_Final_Deleted](
	[FinalID] [int] NOT NULL,
	[UserID] [int] NOT NULL,
	[Reason] [varchar](1000) NOT NULL,
	[Dt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_GradingPeriod]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_GradingPeriod](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[StartDt] [datetime] NOT NULL,
	[EndDt] [datetime] NOT NULL,
 CONSTRAINT [PK_Grading_Daily_GradingPeriod] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_Scores]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_Scores](
	[GradingPeriodID] [int] NOT NULL,
	[UserID] [int] NOT NULL,
	[Score] [float] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Daily_UserReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Daily_UserReport](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NOT NULL,
	[Dt] [datetime] NOT NULL,
	[ReportID] [int] NOT NULL,
	[Role] [varchar](20) NOT NULL,
 CONSTRAINT [PK_Grading_Daily_UserReport] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_OnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_OnHold](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[ReportID] [int] NOT NULL,
	[UserID] [int] NULL,
	[StartDt] [datetime] NOT NULL,
	[EndDt] [datetime] NOT NULL,
	[Approved] [bit] NOT NULL,
 CONSTRAINT [PK_Grading_OnHold] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Grading_Vacations]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Grading_Vacations](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NOT NULL,
	[StartDt] [datetime] NOT NULL,
	[EndDt] [datetime] NOT NULL,
	[Approved] [bit] NOT NULL,
 CONSTRAINT [PK_Grading_Vacations] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[IIS_PAGES]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IIS_PAGES](
	[page] [varchar](100) NOT NULL,
	[SupervisorPage] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[IIS_TIME]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IIS_TIME](
	[shortname] [varchar](50) NOT NULL,
	[dt] [datetime] NOT NULL,
	[totalminutes] [float] NOT NULL,
	[issupervisor] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[IISLOG]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IISLOG](
	[csUsername] [varchar](255) NULL,
	[date] [datetime] NULL,
	[time] [datetime] NULL,
	[page] [varchar](1000) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[IISLOG_CLEAN]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IISLOG_CLEAN](
	[shortname] [varchar](50) NOT NULL,
	[dt] [datetime] NOT NULL,
	[page] [varchar](1000) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[IISLOG_STARTEND]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IISLOG_STARTEND](
	[shortname] [varchar](50) NOT NULL,
	[dt] [datetime] NOT NULL,
	[IsSupervisor] [bit] NOT NULL,
	[StartEnd] [varchar](10) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[IPChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[IPChecklists](
	[ChecklistID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[JB_Tasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[JB_Tasks](
	[TaskID] [int] NOT NULL,
	[BondID] [int] NOT NULL,
	[BondTradeID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [jb_bondid]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [jb_bondid] ON [dbo].[JB_Tasks]
(
	[BondID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[JB_Tasks_Archive_Full]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[JB_Tasks_Archive_Full](
	[BondID] [int] NULL,
	[ActiveChecklistID] [int] NULL,
	[Report] [varchar](500) NULL,
	[ID] [int] NULL,
	[Checklist] [varchar](1000) NULL,
	[Comments] [varchar](5000) NULL,
	[duetime] [datetime] NULL,
	[commentdt] [datetime] NULL,
	[replyid] [int] NULL,
	[displayorder] [int] NULL,
	[tabin] [int] NULL,
	[initials] [varchar](10) NULL,
	[commentid] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[OverDueTasks_LateFee_Log]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OverDueTasks_LateFee_Log](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[ActiveChecklistId] [bigint] NULL,
	[TaskName] [varchar](max) NULL,
	[ControllerName] [varchar](500) NULL,
	[AssigneeName] [varchar](500) NULL,
	[DueDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[AsOfDate] [datetime] NULL,
	[RunDate] [datetime] NULL,
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	[IsPaid] [bit] NULL,
	[ExcusedBy] [int] NULL,
	[ExcusedDt] [datetime] NULL,
 CONSTRAINT [PK_OverDueTasks_LateFee_Log] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[OverDueTasks_LateFee_Log_bkup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OverDueTasks_LateFee_Log_bkup](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[ActiveChecklistId] [bigint] NULL,
	[TaskName] [varchar](max) NULL,
	[ControllerName] [varchar](50) NULL,
	[AssigneeName] [varchar](50) NULL,
	[DueDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[AsOfDate] [datetime] NULL,
	[RunDate] [datetime] NULL,
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	[IsPaid] [bit] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[OverDueTasks_LateFee_Log_bkup_03052018]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[OverDueTasks_LateFee_Log_bkup_03052018](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[ActiveChecklistId] [bigint] NULL,
	[TaskName] [varchar](max) NULL,
	[ControllerName] [varchar](50) NULL,
	[AssigneeName] [varchar](50) NULL,
	[DueDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	[AsOfDate] [datetime] NULL,
	[RunDate] [datetime] NULL,
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	[IsPaid] [bit] NULL,
	[ExcusedBy] [int] NULL,
	[ExcusedDt] [datetime] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PrintUserSecurityList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PrintUserSecurityList](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[PrintUserID] [int] NOT NULL,
	[CanPrintUserID] [int] NOT NULL,
	[BackgroundColor] [varchar](100) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityList](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[Priority] [int] NOT NULL,
 CONSTRAINT [PK_PriorityList] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityList_BonusSend]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityList_BonusSend](
	[userid] [int] NULL,
	[activechecklistid] [int] NULL,
	[dt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityList_Exclude]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityList_Exclude](
	[UserID] [int] NOT NULL,
	[ForUserID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [idx_ple]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [idx_ple] ON [dbo].[PriorityList_Exclude]
(
	[UserID] ASC,
	[ForUserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityList_LateFee_Log]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityList_LateFee_Log](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[LateDate] [datetime] NULL,
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	[IsPaid] [bit] NULL,
 CONSTRAINT [PK_PriorityList_LateFee_Log] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityList_LateFee_Log_Bkup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityList_LateFee_Log_Bkup](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[LateDate] [datetime] NULL,
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	[IsPaid] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityListCrossReference]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityListCrossReference](
	[UserID] [int] NOT NULL,
	[CrossReferenceID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityListSet]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityListSet](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[Name] [varchar](50) NOT NULL,
	[UserID] [int] NOT NULL,
	[PersonalSet] [bit] NOT NULL,
	[UpdatedDate] [datetime] NOT NULL,
 CONSTRAINT [PK_PriorityListSet_1] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[PriorityListUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[PriorityListUsers](
	[SetID] [int] NOT NULL,
	[UserID] [int] NOT NULL,
	[DisplayOrder] [int] NOT NULL,
 CONSTRAINT [PK_PriorityListSet] PRIMARY KEY CLUSTERED 
(
	[SetID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[processed]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[processed](
	[id] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ActiveAlertArchive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveAlertArchive](
	[ID] [int] NOT NULL,
	[AlertID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[SentTime] [datetime] NULL,
	[ArchiveDate] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [AAA_PK]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [AAA_PK] ON [dbo].[QCheck_ActiveAlertArchive]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ActiveAlerts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ActiveAlerts](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[AlertID] [int] NOT NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[SentTime] [datetime] NULL,
 CONSTRAINT [PK_QCheck_ActiveAlerts] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AlertArchive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AlertArchive](
	[ID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DaysBefore] [int] NULL,
	[AlertTime] [float] NULL,
	[AlertType] [varchar](10) NOT NULL,
	[AlertText] [varchar](250) NULL,
	[SentTime] [datetime] NULL,
	[IsDeleted] [bit] NOT NULL,
	[AlerteeGroupID] [int] NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AlertEmailWork]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AlertEmailWork](
	[ID] [int] NULL,
	[ActiveChecklistID] [int] NULL,
	[ChecklistName] [varchar](500) NULL,
	[Alertee] [int] NULL,
	[AlertText] [varchar](250) NULL,
	[AlertType] [varchar](10) NULL,
	[DueTime] [datetime] NULL,
	[CheckListId] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AlertExceptions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AlertExceptions](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ActiveAlertID] [int] NOT NULL,
	[UserID] [int] NOT NULL,
	[IsActive] [bit] NOT NULL,
PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Alerts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Alerts](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DaysBefore] [int] NULL,
	[AlertTime] [float] NULL,
	[AlertType] [varchar](10) NOT NULL,
	[AlertText] [varchar](250) NULL,
	[SentTime] [datetime] NULL,
	[IsDeleted] [bit] NOT NULL,
	[AlerteeGroupID] [int] NULL,
 CONSTRAINT [PK_QCheck_Alerts] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_Alerts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_Alerts](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[AlertID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[DaysBefore] [int] NULL,
	[AlertTime] [float] NULL,
	[AlertType] [varchar](10) NOT NULL,
	[AlertText] [varchar](250) NULL,
	[SentTime] [datetime] NULL,
	[IsDeleted] [bit] NOT NULL,
	[AlerteeGroupID] [int] NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_Alerts] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_ChangeRequestItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_ChangeRequestItems](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ChangeRequestID] [int] NULL,
	[Approved] [bit] NULL,
 CONSTRAINT [PK_QCheck_Approval_ChangeRequestItems] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_ChangeRequests_Archive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_ChangeRequests_Archive](
	[ID] [int] NOT NULL,
	[RequestingUser] [int] NOT NULL,
	[RequestDate] [datetime] NOT NULL,
	[ReadyForSupervisor] [bit] NOT NULL,
	[Approved] [bit] NOT NULL,
	[ApprovedUser] [int] NULL,
	[ApprovedDate] [datetime] NULL,
	[Rejected] [bit] NOT NULL,
	[RejectedUser] [int] NULL,
	[RejectedDate] [datetime] NULL,
	[IsActive] [bit] NOT NULL,
	[Comment] [varchar](1000) NULL,
	[ArchiveDt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_ChecklistInstances]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_ChecklistInstances](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[InstanceID] [int] NOT NULL,
	[Name] [varchar](100) NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[ScheduleID] [int] NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreatedBy] [int] NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_ChecklistInstances] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_ChecklistManagers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_ChecklistManagers](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ChecklistManagerID] [int] NOT NULL,
	[ManagerGroupID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_ChecklistManagers] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_Checklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_Checklists](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[Name] [varchar](500) NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[Owner] [int] NULL,
	[Template] [bit] NOT NULL,
	[CRItemID] [int] NULL,
 CONSTRAINT [PK_QCheck_Approval_Checklists] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Approval_Schedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Approval_Schedule](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[ScheduleID] [int] NOT NULL,
	[firstDueDate] [datetime] NOT NULL,
	[lastDueDate] [datetime] NULL,
	[freqType] [int] NOT NULL,
	[freqInterval] [int] NULL,
	[freqRecurrance] [int] NULL,
	[dueTime] [float] NOT NULL,
	[busDayBehavior] [int] NOT NULL,
	[SoftDueOffsetDays] [int] NULL,
	[CRItemID] [int] NULL,
	[busDayValue] [int] NULL,
	[instanceid] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AppSettings]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AppSettings](
	[ID] [int] NOT NULL,
	[AppURL] [varchar](50) NOT NULL,
	[ImagesURL] [varchar](50) NOT NULL,
	[ExternalURL] [varchar](50) NULL,
	[BaseDomain] [varchar](50) NULL,
	[FilterToDomain] [bit] NOT NULL,
	[FromAddress] [varchar](50) NULL,
	[AppName] [varchar](50) NULL,
	[GradingAddress] [varchar](50) NULL,
	[AutomationAddress] [varchar](50) NULL,
	[DeveloperAddress] [varchar](50) NULL,
	[ITAddress] [varchar](50) NULL,
	[MailServer] [varchar](50) NULL,
	[GPRUserID] [int] NULL,
	[CommentsAddress] [varchar](50) NULL,
	[PopupMessage] [varchar](1000) NULL,
	[PopupShort] [varchar](1000) NULL,
	[EntityToAddress] [varchar](50) NULL,
	[EntityFromAddress] [varchar](50) NULL,
	[OverdueExcusedAddress] [varchar](100) NULL,
	[GradingBCCAddress] [varchar](50) NULL,
	[PriorityExcusedAddress] [varchar](100) NULL,
	[StatusListNotUpdatedToAddress] [varchar](50) NULL,
	[Email2DBFromAddress] [varchar](50) NULL,
	[ExtendedTasksWarningFromAddress] [varchar](50) NULL,
	[ExtendedTasksWarningFromName] [varchar](30) NULL,
	[ExtendedTasksWarningCCAddress] [varchar](1000) NULL,
 CONSTRAINT [PK_QCheck_AppSettings] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AssignedEmail_Queue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AssignedEmail_Queue](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NULL,
	[GroupID] [int] NULL,
	[AssignedBy] [int] NULL,
	[ChecklistName] [varchar](500) NULL,
	[InstanceID] [int] NULL,
	[AssignedDt] [datetime] NULL,
	[SentDt] [datetime] NULL,
 CONSTRAINT [PK_QCheck_AssignedEmail_Queue] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AssigneeLookup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AssigneeLookup](
	[InstanceID] [int] NOT NULL,
	[assignees] [varchar](2000) NULL,
	[assigneecount] [int] NULL,
 CONSTRAINT [PK_QCheck_AssigneeLookup] PRIMARY KEY CLUSTERED 
(
	[InstanceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AssignmentsTemporary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AssignmentsTemporary](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ReplacingID] [int] NULL,
	[TempAssignmentsID] [int] NULL,
	[InstanceID] [int] NULL,
	[TempGroupID] [int] NULL,
	[TempAssignmentStart] [datetime] NULL,
	[TempAssignmentEnd] [datetime] NULL,
	[TempAssignmentApplied] [bit] NULL,
	[TempAssignmentRemoved] [bit] NULL,
	[AssigneesAlerted] [bit] NULL,
	[ControllersAlerted] [bit] NULL,
	[CreatedDt] [datetime] NULL,
	[CreatedBy] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_AssignmentsTemporary_History]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_AssignmentsTemporary_History](
	[ID] [int] NULL,
	[ReplacingID] [int] NULL,
	[TempAssignmentsID] [int] NULL,
	[InstanceID] [int] NULL,
	[TempGroupID] [int] NULL,
	[TempAssignmentStart] [datetime] NULL,
	[TempAssignmentEnd] [datetime] NULL,
	[TempAssignmentApplied] [bit] NULL,
	[TempAssignmentRemoved] [bit] NULL,
	[AssigneesAlerted] [bit] NULL,
	[ControllersAlerted] [bit] NULL,
	[CreatedDt] [datetime] NULL,
	[CreatedBy] [int] NULL,
	[ArchiveDt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_BulkAssigned]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_BulkAssigned](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[InstanceID] [int] NULL,
	[AssigneeGroupID] [int] NULL,
	[RequestedByUser] [int] NULL,
	[RequesteDate] [datetime] NULL,
	[IsDeleted] [bit] NULL
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[QCheck_BulkAssigned] ADD  DEFAULT ((0)) FOR [IsDeleted]
GO
/****** Object:  Table [dbo].[QCheck_ChecklistControllersList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistControllersList](
	[checklistid] [int] NULL,
	[controllers] [varchar](5000) NULL
) ON [PRIMARY]
GO
/****** Object:  Index [chklist_idindx]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [chklist_idindx] ON [dbo].[QCheck_ChecklistControllersList]
(
	[checklistid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ChecklistManagerArchive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ChecklistManagerArchive](
	[ID] [int] NOT NULL,
	[ManagerGroupID] [int] NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[ArchiveDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_CommentsOnlyChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_CommentsOnlyChecklist](
	[ChecklistID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_CompletionPopupLog]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_CompletionPopupLog](
	[userid] [int] NULL,
	[popupdt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_CompletionTriggers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_CompletionTriggers](
	[ChecklistID] [int] NULL,
	[sp] [varchar](255) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_CopiedChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_CopiedChecklists](
	[ChecklistID] [int] NULL,
	[NewChecklistID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_DailyOverdueBCC]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_DailyOverdueBCC](
	[UserID] [int] NULL,
	[BCC] [varchar](500) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_DontEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_DontEmail](
	[UserID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Emails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Emails](
	[EmailAddress] [varchar](2000) NULL,
	[Subject] [varchar](500) NULL,
	[Sent] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_EmailsReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_EmailsReport](
	[FullName] [varchar](500) NULL,
	[Email] [varchar](500) NULL,
	[Subject] [varchar](5000) NULL,
	[Sent] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_EmailTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_EmailTasks](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[TaskName] [varchar](1000) NULL,
	[CreatedBy] [int] NULL,
	[CreatedDt] [datetime] NULL,
 CONSTRAINT [PK_QCheck_EmailTasks] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_EventLog]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_EventLog](
	[EventDateTime] [datetime] NOT NULL,
	[ChecklistID] [int] NULL,
	[UserID] [int] NULL,
	[EventType] [varchar](50) NOT NULL,
	[EventDescription] [varchar](8000) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ExtendedTasksWarningEmail_Queue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ExtendedTasksWarningEmail_Queue](
	[activechecklistID] [int] NULL,
	[emailSent] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ExtensionRequest_Exclude]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ExtensionRequest_Exclude](
	[id] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_FolderChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_FolderChecklists](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[FolderID] [int] NOT NULL,
 CONSTRAINT [PK_QCheck_FolderChecklists] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Folders]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Folders](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NOT NULL,
	[FolderName] [varchar](50) NOT NULL,
	[ParentFolder] [int] NOT NULL,
 CONSTRAINT [PK_QCheck_Folders] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_FormerUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_FormerUsers](
	[UserID] [int] NOT NULL,
	[FullName] [varchar](50) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_GroupChanges]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_GroupChanges](
	[UserID] [int] NOT NULL,
	[GroupID] [int] NOT NULL,
	[Type] [varchar](20) NOT NULL,
	[dt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Groups_NoFines]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Groups_NoFines](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[GroupId] [int] NOT NULL,
 CONSTRAINT [PK_QCheck_Groups_NoFines] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Impersonate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Impersonate](
	[ImpersonationID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[UserID] [int] NULL,
	[ImpersonateUserID] [int] NULL,
	[isDeleted] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_Impersonate] PRIMARY KEY CLUSTERED 
(
	[ImpersonationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_InstanceStops]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_InstanceStops](
	[instanceid] [int] NULL,
	[stoppedby] [int] NULL,
	[stoppedDt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_LateFee]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_LateFee](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[LateCharge] [int] NULL,
	[StepupCharge] [int] NULL,
	[StartDate] [datetime] NULL,
	[EndDate] [datetime] NULL,
	[LateCount] [int] NULL,
 CONSTRAINT [PK_QCheck_LateFee] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_LoadTimes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_LoadTimes](
	[UserID] [int] NOT NULL,
	[PageName] [varchar](100) NOT NULL,
	[ServerLoadTime] [int] NOT NULL,
	[ClientLoadTime] [int] NOT NULL,
	[TotalTime]  AS ([ServerLoadTime]+[ClientLoadTime]),
	[Dt] [datetime] NOT NULL,
	[ReportName] [varchar](500) NULL,
	[LastOpened] [datetime] NULL,
	[Browser] [varchar](50) NULL
) ON [PRIMARY]
GO
/****** Object:  Index [loadtimes_dt]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [loadtimes_dt] ON [dbo].[QCheck_LoadTimes]
(
	[Dt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Log_Emails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Log_Emails](
	[LogID] [int] IDENTITY(1,1) NOT NULL,
	[FromId] [int] NULL,
	[ToId] [int] NULL,
	[Subject] [varchar](500) NULL,
	[Sent] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_OutsideUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_OutsideUsers](
	[UserID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Overdue_Exclude]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Overdue_Exclude](
	[userid] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_OverdueAdmins]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_OverdueAdmins](
	[UserID] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_OverdueControlledTasksReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_OverdueControlledTasksReport](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ControllerUserID] [int] NULL,
	[SendHour] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_PagesLoaded_BonusUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_PagesLoaded_BonusUsers](
	[UserID] [int] NOT NULL,
	[PageName] [varchar](100) NOT NULL,
	[Dt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_QueuedEmails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_QueuedEmails](
	[EmailID] [int] IDENTITY(1,1) NOT NULL,
	[UserID] [int] NOT NULL,
	[EmailFrom] [varchar](100) NOT NULL,
	[EmailTo] [varchar](1000) NOT NULL,
	[EmailReplyTo] [varchar](100) NOT NULL,
	[EmailSubject] [varchar](255) NOT NULL,
	[HasComments] [bit] NOT NULL,
	[Delivered] [bit] NOT NULL,
	[Notified] [bit] NOT NULL,
	[Errored] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_QueuedEmails] PRIMARY KEY CLUSTERED 
(
	[EmailID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Reassign_History]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Reassign_History](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ChecklistID] [int] NULL,
	[UserID] [int] NULL,
	[Controllers] [varchar](1000) NULL,
	[ViewDate] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_ReminderTasksReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_ReminderTasksReport](
	[SupervisorUserID] [int] NULL,
	[ChecklistID] [int] NULL,
	[ManagerGroupID] [int] NULL,
	[IsNew] [bit] NULL,
	[ReportTime] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_SetUpcomingTiming]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_SetUpcomingTiming](
	[id] [int] NULL,
	[startdt] [datetime] NULL,
	[enddt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Suggestions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Suggestions](
	[SuggestionID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[Suggestion] [varchar](8000) NOT NULL,
	[UserID] [int] NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[IsDeleted] [int] NOT NULL,
	[Comment] [varchar](500) NULL,
	[Dt] [datetime] NULL,
 CONSTRAINT [PK_QCheck_Suggestions] PRIMARY KEY CLUSTERED 
(
	[SuggestionID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_Suggestions_Archive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_Suggestions_Archive](
	[SuggestionID] [int] NOT NULL,
	[Suggestion] [varchar](8000) NOT NULL,
	[UserID] [int] NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[IsDeleted] [int] NOT NULL,
	[Comment] [varchar](500) NULL,
	[Dt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_SuperUserGroups]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_SuperUserGroups](
	[GroupID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_UniversalExtensionChangeRequests]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_UniversalExtensionChangeRequests](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ChangeRequestID] [int] NOT NULL,
	[IsActive] [bit] NOT NULL,
 CONSTRAINT [PK_QCheck_UniversalExtensionChangeRequests] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_UserDefaultsByLogin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_UserDefaultsByLogin](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ShortNamePattern] [varchar](100) NULL,
	[DefaultGroup] [varchar](100) NULL,
	[Supervisor] [varchar](100) NULL,
	[OutsideUser] [bit] NULL,
 CONSTRAINT [PK_QCheck_UserDefaultsByLogin] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QCheck_UserDefaultTimes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QCheck_UserDefaultTimes](
	[UserID] [int] NOT NULL,
	[DueTime] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QPI_Data]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QPI_Data](
	[ID] [int] NOT NULL,
	[FullName] [varchar](100) NOT NULL,
	[IsSupervisor] [bit] NOT NULL,
	[ControllerComments] [int] NOT NULL,
	[SupervisorComments] [int] NOT NULL,
	[IPComments] [int] NOT NULL,
	[ControllerDeductions] [int] NOT NULL,
	[SupervisorDeductions] [int] NOT NULL,
	[Overdue] [int] NOT NULL,
	[ChecklistOverdue] [int] NOT NULL,
	[ReportDeductions] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QPI_Exclude]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QPI_Exclude](
	[ID] [char](10) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QPI_Points]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QPI_Points](
	[SupervisorController] [float] NOT NULL,
	[Supervisor] [float] NOT NULL,
	[NonSupervisorController] [float] NOT NULL,
	[InterestedParty] [float] NOT NULL,
	[Overdue] [float] NOT NULL,
	[ChecklistOverdue] [float] NOT NULL,
	[ControllerDays] [int] NOT NULL,
	[SupervisorDays] [int] NOT NULL,
	[ReportDays] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[qpi_report_exclude]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[qpi_report_exclude](
	[id] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QProcess_KeyLookup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QProcess_KeyLookup](
	[LookupKey] [varchar](1000) NULL,
	[LookupVal] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_AutomationEmailPreferences]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_AutomationEmailPreferences](
	[UserID] [int] NOT NULL,
	[Assignee] [int] NOT NULL,
	[Controller] [int] NOT NULL,
	[Due] [int] NOT NULL,
	[Report] [int] NOT NULL,
	[Priority] [int] NOT NULL,
	[Alert] [int] NULL,
	[SoftDue] [int] NULL,
	[EChecklistPriority] [int] NOT NULL,
 CONSTRAINT [PK_QStatus_AutomationEmailPreferences] PRIMARY KEY CLUSTERED 
(
	[UserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_ColumnWidth]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_ColumnWidth](
	[UserID] [int] NOT NULL,
	[ReportID] [int] NOT NULL,
	[ColumnWidth] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [idx_cw]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [idx_cw] ON [dbo].[QStatus_ColumnWidth]
(
	[UserID] ASC,
	[ReportID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_CommentedReportTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_CommentedReportTasks](
	[activechecklistid] [int] NULL,
	[reportid] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [idx_report]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [idx_report] ON [dbo].[QStatus_CommentedReportTasks]
(
	[reportid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_CondensedEmails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_CondensedEmails](
	[UserID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_DontEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_DontEmail](
	[ReportID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_Favorites]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_Favorites](
	[UserID] [int] NOT NULL,
	[ReportID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_GroupReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_GroupReport](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[GroupID] [int] NOT NULL,
	[ReportID] [int] NOT NULL,
	[DefaultReport] [bit] NOT NULL,
	[AsOf] [datetime] NOT NULL,
 CONSTRAINT [PK_QStatus_GroupReport] PRIMARY KEY NONCLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Index [GroupReport_ID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [GroupReport_ID] ON [dbo].[QStatus_GroupReport]
(
	[GroupID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_InstanceTaskType]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_InstanceTaskType](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[InstanceID] [int] NOT NULL,
	[TaskType] [int] NOT NULL,
 CONSTRAINT [PK_QStatus_InstanceTaskType] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_OnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_OnHold](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[ReportID] [int] NOT NULL,
	[Startdt] [datetime] NOT NULL,
	[Enddt] [datetime] NULL,
 CONSTRAINT [PK_QStatus_OnHold] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_Preferences]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_Preferences](
	[UserID] [int] NOT NULL,
	[ReportID] [int] NOT NULL,
	[PreferenceType] [varchar](50) NOT NULL,
	[PreferenceValue] [varchar](50) NOT NULL
) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [idx_pref]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [idx_pref] ON [dbo].[QStatus_Preferences]
(
	[UserID] ASC,
	[PreferenceType] ASC,
	[PreferenceValue] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_PriorityChanges]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_PriorityChanges](
	[ActiveChecklistID] [int] NOT NULL,
	[PriorityOld] [int] NOT NULL,
	[Updatedt] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Index [PC_Updated]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [PC_Updated] ON [dbo].[QStatus_PriorityChanges]
(
	[Updatedt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_ReportFolders]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_ReportFolders](
	[ReportID] [int] NOT NULL,
	[FolderID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_ReportLastestComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_ReportLastestComments](
	[UserID] [int] NOT NULL,
	[ReportID] [int] NOT NULL,
	[Commentdt] [datetime] NULL,
 CONSTRAINT [PK_QStatus_ReportLastestComments] PRIMARY KEY CLUSTERED 
(
	[UserID] ASC,
	[ReportID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_Seed]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_Seed](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[val] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_SpecialTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SpecialTasks](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[Priority] [int] NOT NULL,
	[TaskType] [int] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[UpdatedDate] [datetime] NULL,
 CONSTRAINT [PK_QStatus_SpecialTasks] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_SupervisorColors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SupervisorColors](
	[SupervisorUserID] [int] NOT NULL,
	[ColorNum] [int] NOT NULL,
	[DepartmentID] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_SupervisorDepartments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SupervisorDepartments](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[SupervisorUserID] [int] NOT NULL,
	[DepartmentID] [int] NOT NULL,
 CONSTRAINT [PK_QStatus_SupervisorDepartments] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_SupervisorEmailDefaults]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SupervisorEmailDefaults](
	[ID] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[EmailType] [varchar](50) NOT NULL,
	[SupervisorType] [varchar](50) NOT NULL,
	[SendEmail] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_SupervisorEmailPreferences]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SupervisorEmailPreferences](
	[UserID] [int] NOT NULL,
	[Type] [int] NOT NULL,
	[SendEmail] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_SupervisorsLastViewed]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_SupervisorsLastViewed](
	[SupervisorUserID] [int] NOT NULL,
	[ReportID] [int] NOT NULL,
	[LastViewed] [datetime] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_TaskNameChanges]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TaskNameChanges](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[ChecklistID] [int] NOT NULL,
	[TaskOld] [varchar](500) NOT NULL,
	[UpdateDt] [datetime] NOT NULL,
 CONSTRAINT [PK_QStatus_TaskNameChanges] PRIMARY KEY NONCLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Index [TNC_Updated]    Script Date: 3/26/2024 2:56:27 PM ******/
CREATE CLUSTERED INDEX [TNC_Updated] ON [dbo].[QStatus_TaskNameChanges]
(
	[UpdateDt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_QStatus_TaskNameChanges_1]    Script Date: 3/26/2024 2:56:27 PM ******/
CREATE NONCLUSTERED INDEX [idx_QStatus_TaskNameChanges_1] ON [dbo].[QStatus_TaskNameChanges]
(
	[ChecklistID] ASC,
	[UpdateDt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  FullTextIndex     Script Date: 3/26/2024 2:56:27 PM ******/
CREATE FULLTEXT INDEX ON [dbo].[QStatus_TaskNameChanges](
[TaskOld] LANGUAGE 'English')
KEY INDEX [PK_QStatus_TaskNameChanges]ON ([ft], FILEGROUP [PRIMARY])
WITH (CHANGE_TRACKING = AUTO, STOPLIST = SYSTEM)

GO
/****** Object:  Table [dbo].[QStatus_TaskReportList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TaskReportList](
	[ActiveChecklistID] [int] NOT NULL,
	[UserID] [int] NOT NULL,
	[ReportsList] [varchar](5000) NULL
) ON [PRIMARY]
GO
/****** Object:  Index [trl]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [trl] ON [dbo].[QStatus_TaskReportList]
(
	[ActiveChecklistID] ASC,
	[UserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_TaskType_Relation]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TaskType_Relation](
	[TaskTypeFrom] [int] NOT NULL,
	[TaskTypeTo] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_TaskTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TaskTypes](
	[ID] [int] IDENTITY(100000,1) NOT FOR REPLICATION NOT NULL,
	[ReportID] [int] NOT NULL,
	[Description] [varchar](50) NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[NativeType] [int] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
 CONSTRAINT [PK_QStatus_TaskTypes] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Index [TT_IsDeleted]    Script Date: 3/26/2024 2:37:54 PM ******/
CREATE NONCLUSTERED INDEX [TT_IsDeleted] ON [dbo].[QStatus_TaskTypes]
(
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [TT_RID]    Script Date: 3/26/2024 2:37:54 PM ******/
CREATE NONCLUSTERED INDEX [TT_RID] ON [dbo].[QStatus_TaskTypes]
(
	[ReportID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  FullTextIndex     Script Date: 3/26/2024 2:37:54 PM ******/
CREATE FULLTEXT INDEX ON [dbo].[QStatus_TaskTypes](
[Description] LANGUAGE 'English')
KEY INDEX [PK_QStatus_TaskTypes]ON ([ft], FILEGROUP [PRIMARY])
WITH (CHANGE_TRACKING = AUTO, STOPLIST = SYSTEM)

GO
ALTER TABLE [dbo].[QStatus_TaskTypes] ADD  CONSTRAINT [DF_QStatus_TaskTypes_StatusReportID]  DEFAULT ((0)) FOR [ReportID]
GO
ALTER TABLE [dbo].[QStatus_TaskTypes] ADD  CONSTRAINT [DF_QStatus_TaskTypes_NativeType]  DEFAULT ((0)) FOR [NativeType]
GO
ALTER TABLE [dbo].[QStatus_TaskTypes] ADD  CONSTRAINT [DF_QStatus_TaskTypes_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
/****** Object:  Table [dbo].[QStatus_TaskTypesTemplate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TaskTypesTemplate](
	[Description] [varchar](50) NOT NULL,
	[DisplayOrder] [int] NOT NULL,
	[NativeType] [int] NOT NULL,
 CONSTRAINT [PK_QStatus_TaskTypesTemplate] PRIMARY KEY CLUSTERED 
(
	[DisplayOrder] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_TaxCorrespondenceFiles]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TaxCorrespondenceFiles](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[FilePath] [varchar](500) NULL,
	[TaskCreated] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[QStatus_TempTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[QStatus_TempTasks](
	[ID] [int] NOT NULL,
	[keyID] [int] NOT NULL,
	[specialTask] [bit] NOT NULL,
	[input_date] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [TempTasks_Key]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE CLUSTERED INDEX [TempTasks_Key] ON [dbo].[QStatus_TempTasks]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Schedule_PriorityList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Schedule_PriorityList](
	[ScheduleID] [int] IDENTITY(1,1) NOT NULL,
	[SupervisorID] [int] NOT NULL,
	[EmployeeID] [int] NOT NULL,
	[DaysOfWeek] [varchar](10) NOT NULL,
	[ReportDay] [varchar](10) NOT NULL,
	[TimesOfDay] [varchar](250) NULL,
	[CreatedDate] [datetime] NULL,
	[CreatedBy] [varchar](50) NULL,
	[ModifiedDate] [datetime] NULL,
	[ModifiedBy] [varchar](50) NULL,
	[IsActive] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Schedule_PriorityList_Exclude]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Schedule_PriorityList_Exclude](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NOT NULL,
	[ExcludedDate] [datetime] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[SupervisorId] [int] NULL,
	[IsActive] [bit] NULL,
 CONSTRAINT [PK_Schedule_PriorityList_Exclude] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Supervisor_PriorityList_Report_Schedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Supervisor_PriorityList_Report_Schedule](
	[ScheduleID] [int] IDENTITY(1,1) NOT NULL,
	[SupervisorID] [int] NOT NULL,
	[DaysOfWeek] [varchar](10) NOT NULL,
	[DaysOffset] [int] NOT NULL,
	[CreatedDate] [datetime] NULL,
	[CreatedBy] [varchar](50) NULL,
	[ModifiedDate] [datetime] NULL,
	[ModifiedBy] [varchar](50) NULL,
	[IsActive] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[TaskSearchCache]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[TaskSearchCache](
	[Name] [varchar](500) NULL,
	[Due] [varchar](20) NULL,
	[Completed] [varchar](10) NULL,
	[Assignees] [varchar](2000) NULL,
	[Controllers] [varchar](2000) NULL,
	[Schedule] [varchar](500) NULL,
	[LastCompletedBy] [varchar](50) NULL,
	[LastCompletedDate] [varchar](20) NULL,
	[ChecklistID] [int] NULL,
	[InstanceID] [int] NULL,
	[ActiveChecklistID] [int] NOT NULL,
	[SearchColumn] [varchar](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Index [idxTaskSearchCache_1]    Script Date: 3/25/2024 5:45:34 PM ******/
CREATE UNIQUE CLUSTERED INDEX [idxTaskSearchCache_1] ON [dbo].[TaskSearchCache]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  FullTextIndex     Script Date: 3/25/2024 5:45:34 PM ******/
CREATE FULLTEXT INDEX ON [dbo].[TaskSearchCache](
[SearchColumn] LANGUAGE 'English')
KEY INDEX [idxTaskSearchCache_1]ON ([PFSProcess], FILEGROUP [PRIMARY])
WITH (CHANGE_TRACKING = AUTO, STOPLIST = SYSTEM)

GO
USE [PFSProcess]
GO
ALTER FULLTEXT INDEX ON [dbo].[TaskSearchCache] DISABLE
GO

/****** Object:  Table [dbo].[Temp_UpdateSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Temp_UpdateSchedule](
	[InstanceID] [int] NULL,
	[PrevFreqType] [int] NULL,
	[activate] [bit] NULL,
	[dt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Util_Email2DBTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Util_Email2DBTasks](
	[AssignedGroupID] [int] NULL,
	[ControllerGroupID] [int] NULL,
	[SectionID] [int] NULL,
	[DueDaysAhead] [int] NULL,
	[TasksCreatedBy] [int] NULL,
	[AlerteeGroupID] [int] NULL,
	[triggerID] [int] NULL,
	[triggerName] [varchar](40) NULL,
	[priorityUser] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Index [IX_Grading_Daily_UserReport]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [IX_Grading_Daily_UserReport] ON [dbo].[Grading_Daily_UserReport]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [jb_taskid]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [jb_taskid] ON [dbo].[JB_Tasks]
(
	[TaskID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AAA_ActiveChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AAA_ActiveChecklistID] ON [dbo].[QCheck_ActiveAlertArchive]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AAA_AlertID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AAA_AlertID] ON [dbo].[QCheck_ActiveAlertArchive]
(
	[AlertID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AA_ACID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AA_ACID] ON [dbo].[QCheck_ActiveAlerts]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AA_AlertID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AA_AlertID] ON [dbo].[QCheck_ActiveAlerts]
(
	[AlertID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AAssA_ActiveChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AAssA_ActiveChecklistID] ON [dbo].[QCheck_ActiveAssignmentArchive]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AAssA_AssignmentsID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AAssA_AssignmentsID] ON [dbo].[QCheck_ActiveAssignmentArchive]
(
	[AssignmentsID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [Assign_ActiveChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [Assign_ActiveChecklistID] ON [dbo].[QCheck_ActiveAssignments]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QCheck_ActiveAssignments42]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QCheck_ActiveAssignments42] ON [dbo].[QCheck_ActiveAssignments]
(
	[ActiveChecklistID] ASC,
	[AssignmentsID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [ChecklistArchive_InstanceID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ChecklistArchive_InstanceID] ON [dbo].[QCheck_ActiveChecklistArchive]
(
	[InstanceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [CompletedDate]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [CompletedDate] ON [dbo].[QCheck_ActiveChecklistArchive]
(
	[CompletedDate] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_aca_duetime]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_aca_duetime] ON [dbo].[QCheck_ActiveChecklistArchive]
(
	[DueTime] ASC
)
INCLUDE([ID],[InstanceID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_acaid]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_acaid] ON [dbo].[QCheck_ActiveChecklistArchive]
(
	[DueTime] ASC
)
INCLUDE([ID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_idonly]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_idonly] ON [dbo].[QCheck_ActiveChecklistArchive]
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [ac_duetime]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ac_duetime] ON [dbo].[QCheck_ActiveChecklists]
(
	[DueTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [AC_InstanceID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [AC_InstanceID] ON [dbo].[QCheck_ActiveChecklists]
(
	[InstanceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [ACCompletedDate]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ACCompletedDate] ON [dbo].[QCheck_ActiveChecklists]
(
	[CompletedDate] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idxQCheck_ActiveChecklists_1]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxQCheck_ActiveChecklists_1] ON [dbo].[QCheck_ActiveChecklists]
(
	[CompletedDate] ASC,
	[HasNaggedDue] ASC,
	[DueTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idxQCheck_ActiveChecklists_2]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxQCheck_ActiveChecklists_2] ON [dbo].[QCheck_ActiveChecklists]
(
	[HasNaggedDue] ASC
)
INCLUDE([ID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [odt]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [odt] ON [dbo].[QCheck_ActiveChecklists]
(
	[OrigDueTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QCheck_ActiveChecklists17]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QCheck_ActiveChecklists17] ON [dbo].[QCheck_ActiveChecklists]
(
	[DueTime] ASC,
	[CompletedDate] ASC,
	[InstanceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QCheck_ActiveItems71]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QCheck_ActiveItems71] ON [dbo].[QCheck_ActiveItems]
(
	[ActiveChecklistID] ASC,
	[ChecklistItemID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [IDX_QCheck_Alerts_1]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [IDX_QCheck_Alerts_1] ON [dbo].[QCheck_Alerts]
(
	[IsDeleted] ASC
)
INCLUDE([ID],[InstanceID],[AlerteeGroupID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idxQCheck_Alerts_1]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxQCheck_Alerts_1] ON [dbo].[QCheck_Alerts]
(
	[IsDeleted] ASC
)
INCLUDE([InstanceID],[DaysBefore]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [idxQCheck_Alerts_2]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxQCheck_Alerts_2] ON [dbo].[QCheck_Alerts]
(
	[AlertType] ASC,
	[AlertTime] ASC
)
INCLUDE([ID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [idxQCheck_Alerts_3]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxQCheck_Alerts_3] ON [dbo].[QCheck_Alerts]
(
	[InstanceID] ASC,
	[IsDeleted] ASC,
	[AlertType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [ApprovalAC_CRID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ApprovalAC_CRID] ON [dbo].[QCheck_Approval_ActiveChecklists]
(
	[ChangeRequestID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_approvalassignments_CRID_ASID_DEL]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_approvalassignments_CRID_ASID_DEL] ON [dbo].[QCheck_Approval_Assignments]
(
	[ChangeRequestID] ASC,
	[AssignmentID] ASC,
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [filter]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [filter] ON [dbo].[QCheck_Approval_ChangeRequests]
(
	[ReadyForSupervisor] ASC,
	[Approved] ASC,
	[Rejected] ASC,
	[IsActive] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_cr_rurfsrej]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_cr_rurfsrej] ON [dbo].[QCheck_Approval_ChangeRequests]
(
	[RequestingUser] ASC,
	[ReadyForSupervisor] ASC,
	[Rejected] ASC
)
INCLUDE([ID],[RequestDate]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [qcheck_acr_rfsrej]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [qcheck_acr_rfsrej] ON [dbo].[QCheck_Approval_ChangeRequests]
(
	[ReadyForSupervisor] ASC,
	[Rejected] ASC
)
INCLUDE([ID],[RequestingUser],[RequestDate]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_ApprovalItems_CRID_IID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_ApprovalItems_CRID_IID] ON [dbo].[QCheck_Approval_Items]
(
	[ChangeRequestID] ASC,
	[ItemID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_approvalschedule_CRID_SID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_approvalschedule_CRID_SID] ON [dbo].[QCheck_Approval_Schedule]
(
	[ChangeRequestID] ASC,
	[ScheduleID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [igi]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [igi] ON [dbo].[QCheck_AssignmentArchive]
(
	[InstanceID] ASC,
	[GroupID] ASC,
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_QCheck_ChecklistInstanceArchive_1]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_QCheck_ChecklistInstanceArchive_1] ON [dbo].[QCheck_ChecklistInstanceArchive]
(
	[ID] ASC,
	[ArchiveDate] ASC
)
INCLUDE([ChecklistID],[ScheduleID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QCheck_ChecklistInstanceArchive59]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QCheck_ChecklistInstanceArchive59] ON [dbo].[QCheck_ChecklistInstanceArchive]
(
	[ChecklistID] ASC,
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_Instance_ScheduleID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_Instance_ScheduleID] ON [dbo].[QCheck_ChecklistInstances]
(
	[ScheduleID] ASC
)
INCLUDE([ID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [Instances_ChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [Instances_ChecklistID] ON [dbo].[QCheck_ChecklistInstances]
(
	[ChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QCheck_ChecklistInstances62]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QCheck_ChecklistInstances62] ON [dbo].[QCheck_ChecklistInstances]
(
	[ID] ASC,
	[ChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [id]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [id] ON [dbo].[QCheck_ChecklistManagers]
(
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idxIsDeletedChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxIsDeletedChecklistID] ON [dbo].[QCheck_ChecklistManagers]
(
	[ChecklistID] ASC,
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idxManagerGroupID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxManagerGroupID] ON [dbo].[QCheck_ChecklistManagers]
(
	[ManagerGroupID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [lookupkey]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [lookupkey] ON [dbo].[QCheck_ChecklistManagers]
(
	[ManagerGroupID] ASC,
	[ChecklistID] ASC,
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [cid]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [cid] ON [dbo].[QCheck_FolderChecklists]
(
	[ChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [A_ItemTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [A_ItemTypes] ON [dbo].[QCheck_ItemArchive]
(
	[ItemTypeID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [itemA_ChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [itemA_ChecklistID] ON [dbo].[QCheck_ItemArchive]
(
	[ChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_GlobalSearchIdx]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_GlobalSearchIdx] ON [dbo].[QCheck_ItemArchive]
(
	[ID] ASC
)
INCLUDE([Text]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [ch_isdel]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ch_isdel] ON [dbo].[QCheck_Items]
(
	[ChecklistID] ASC,
	[IsDeleted] ASC,
	[ItemTypeID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [item_ChecklistID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [item_ChecklistID] ON [dbo].[QCheck_Items]
(
	[ChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [ItemTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ItemTypes] ON [dbo].[QCheck_Items]
(
	[ItemTypeID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idxQCheck_Schedule_1]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idxQCheck_Schedule_1] ON [dbo].[QCheck_Schedule]
(
	[freqType] ASC
)
INCLUDE([ID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_GlobalSearchIdx2Archive]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_GlobalSearchIdx2Archive] ON [dbo].[QCheck_ScheduleArchive]
(
	[ID] ASC
)
INCLUDE([freqType],[freqInterval],[freqRecurrance]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [dt]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [dt] ON [dbo].[QCheck_UpcomingDueTimes]
(
	[DueTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_instanceid]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_instanceid] ON [dbo].[QCheck_UpcomingDueTimes]
(
	[InstanceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [ACTT_ACID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ACTT_ACID] ON [dbo].[QStatus_ActiveChecklistTaskType]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_GlobalSearchIdx]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_GlobalSearchIdx] ON [dbo].[QStatus_ActiveChecklistTaskTypeArchive]
(
	[ActiveChecklistID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [commentarchive_commentdt]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [commentarchive_commentdt] ON [dbo].[QStatus_CommentArchive]
(
	[CommentDt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [commentarchive_foreignkey]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [commentarchive_foreignkey] ON [dbo].[QStatus_CommentArchive]
(
	[ForeignKeyID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_GlobalSearchIdxArchive]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_GlobalSearchIdxArchive] ON [dbo].[QStatus_CommentArchive]
(
	[SpecialTask] ASC
)
INCLUDE([ID],[ForeignKeyID],[Comments]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [Comm_Foreign]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [Comm_Foreign] ON [dbo].[QStatus_Comments]
(
	[ForeignKeyID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_comments_replycomment]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_comments_replycomment] ON [dbo].[QStatus_Comments]
(
	[ReplyID] ASC,
	[CommentDt] ASC
)
INCLUDE([Comments]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_dt]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_dt] ON [dbo].[QStatus_Comments]
(
	[ID] ASC,
	[CommentDt] ASC,
	[UserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_special]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_special] ON [dbo].[QStatus_Comments]
(
	[SpecialTask] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_Comments60]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_Comments60] ON [dbo].[QStatus_Comments]
(
	[SpecialTask] ASC,
	[ForeignKeyID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_GlobalSearchIdx]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_GlobalSearchIdx] ON [dbo].[QStatus_Comments]
(
	[SpecialTask] ASC
)
INCLUDE([ID],[ForeignKeyID],[Comments]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [ddcidx]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ddcidx] ON [dbo].[QStatus_DueDateChanges]
(
	[DueDateOld] ASC
)
INCLUDE([ActiveChecklistID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_QStatus_DueDateChanges]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_QStatus_DueDateChanges] ON [dbo].[QStatus_DueDateChanges]
(
	[ActiveChecklistID] ASC,
	[UpdateDt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [idx_ittID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_ittID] ON [dbo].[QStatus_InstanceTaskType]
(
	[InstanceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
/****** Object:  Index [idx_QStatus_PriorityChanges_1]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [idx_QStatus_PriorityChanges_1] ON [dbo].[QStatus_PriorityChanges]
(
	[ActiveChecklistID] ASC,
	[Updatedt] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [Special_IsDeleted]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [Special_IsDeleted] ON [dbo].[QStatus_SpecialTasks]
(
	[IsDeleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [ST_TT]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [ST_TT] ON [dbo].[QStatus_SpecialTasks]
(
	[TaskType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [SC_Clustered]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [SC_Clustered] ON [dbo].[QStatus_SupervisorColors]
(
	[SupervisorUserID] ASC,
	[DepartmentID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [SC_DepartmentID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [SC_DepartmentID] ON [dbo].[QStatus_SupervisorColors]
(
	[DepartmentID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [SC_SupervisorID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [SC_SupervisorID] ON [dbo].[QStatus_SupervisorColors]
(
	[SupervisorUserID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [Super_color]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [Super_color] ON [dbo].[QStatus_SupervisorColors]
(
	[ColorNum] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [QStatus_Supervisors72]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [QStatus_Supervisors72] ON [dbo].[QStatus_Supervisors]
(
	[ReportID] ASC,
	[SupervisorGroupID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
/****** Object:  Index [Supervisors_ReportID]    Script Date: 3/22/2024 4:20:58 PM ******/
CREATE NONCLUSTERED INDEX [Supervisors_ReportID] ON [dbo].[QStatus_Supervisors]
(
	[ReportID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 80) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Audit_ActiveChecklist] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_ActiveItem] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_ApprovalChecklist] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_ApprovalItem] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveActiveChecklist] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveActiveItem] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveApprovalChecklist] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveApprovalItem] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveChecklist] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveComment] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ArchiveItem] ADD  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[Audit_ChangeRequest] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_Checklist] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_Comment] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_CommentArchived] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_Item] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_Report] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Audit_TaskType] ADD  DEFAULT (getdate()) FOR [AuditDt]
GO
ALTER TABLE [dbo].[Grading_Daily] ADD  CONSTRAINT [DF_Grading_Daily_Dt]  DEFAULT (CONVERT([varchar],getdate()-(1),(101))) FOR [Dt]
GO
ALTER TABLE [dbo].[Grading_Daily] ADD  CONSTRAINT [DF_Grading_Daily_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[Grading_Daily_Final] ADD  CONSTRAINT [DF_Grading_Daily_Final_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[Grading_OnHold] ADD  CONSTRAINT [DF_Grading_OnHold_Approved]  DEFAULT ((0)) FOR [Approved]
GO
ALTER TABLE [dbo].[Grading_Vacations] ADD  CONSTRAINT [DF_Grading_Vacations_Approved]  DEFAULT ((0)) FOR [Approved]
GO
ALTER TABLE [dbo].[PriorityListSet] ADD  CONSTRAINT [DF_PriorityListSet_PersonalSet]  DEFAULT ((0)) FOR [PersonalSet]
GO
ALTER TABLE [dbo].[PriorityListSet] ADD  CONSTRAINT [DF_PriorityListSet_UpdatedDate]  DEFAULT (getdate()) FOR [UpdatedDate]
GO
ALTER TABLE [dbo].[QCheck_ActiveChecklistArchive] ADD  CONSTRAINT [DF_QCheck_ActiveChecklistArchive_HasNaggedDue]  DEFAULT ((0)) FOR [HasNaggedDue]
GO
ALTER TABLE [dbo].[QCheck_ActiveChecklistArchive] ADD  CONSTRAINT [DF_QCheck_ActiveChecklistArchive_IsNA]  DEFAULT ((0)) FOR [IsNA]
GO
ALTER TABLE [dbo].[QCheck_ActiveChecklists] ADD  CONSTRAINT [DF_QCheck_ActiveChecklists_HasNaggedDue]  DEFAULT ((0)) FOR [HasNaggedDue]
GO
ALTER TABLE [dbo].[QCheck_ActiveChecklists] ADD  CONSTRAINT [DF_QCheck_ActiveChecklists_IsNA]  DEFAULT ((0)) FOR [IsNA]
GO
ALTER TABLE [dbo].[QCheck_Alerts] ADD  CONSTRAINT [DF_QCheck_Alerts_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Approval_ActiveChecklists] ADD  CONSTRAINT [DF_QCheck_Approval_ActiveChecklists_HasNaggedDue]  DEFAULT ((0)) FOR [HasNaggedDue]
GO
ALTER TABLE [dbo].[QCheck_Approval_Alerts] ADD  CONSTRAINT [DF_QCheck_Approval_Alerts_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Approval_Assignments] ADD  CONSTRAINT [DF_QCheck_Approval_Assignments_DtAssigned]  DEFAULT (getdate()) FOR [DtAssigned]
GO
ALTER TABLE [dbo].[QCheck_Approval_Assignments] ADD  CONSTRAINT [DF_QCheck_Approval_Assignments_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequestItems] ADD  DEFAULT ((1)) FOR [Approved]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequests] ADD  DEFAULT (getdate()) FOR [RequestDate]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequests] ADD  DEFAULT ((0)) FOR [ReadyForSupervisor]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequests] ADD  DEFAULT ((0)) FOR [Approved]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequests] ADD  DEFAULT ((0)) FOR [Rejected]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequests] ADD  DEFAULT ((1)) FOR [IsActive]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChecklistInstances] ADD  CONSTRAINT [DF_QCheck_Approval_ChecklistInstances_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Approval_ChecklistManagers] ADD  CONSTRAINT [DF_QCheck_Approval_ChecklistManagers_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Approval_Checklists] ADD  CONSTRAINT [DF_QCheck_Approval_Checklists_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Approval_Checklists] ADD  CONSTRAINT [DF_QCheck_Approval_Checklists_Template]  DEFAULT ((0)) FOR [Template]
GO
ALTER TABLE [dbo].[QCheck_Approval_Items] ADD  CONSTRAINT [DF_QCheck_Approval_Items_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_AppSettings] ADD  CONSTRAINT [DF_QCheck_AppSettings_FilterToDomain]  DEFAULT ((1)) FOR [FilterToDomain]
GO
ALTER TABLE [dbo].[QCheck_AssignedEmail_Queue] ADD  CONSTRAINT [DF_QCheck_AssignedEmail_Queue_Sent]  DEFAULT ((0)) FOR [SentDt]
GO
ALTER TABLE [dbo].[QCheck_AssignmentArchive] ADD  CONSTRAINT [DF_QCheck_AssignmentArchive_DtAssigned]  DEFAULT (getdate()) FOR [DtAssigned]
GO
ALTER TABLE [dbo].[QCheck_ChecklistInstances] ADD  CONSTRAINT [DF_QCheck_ChecklistInstances_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_ChecklistManagers] ADD  CONSTRAINT [DF_QCheck_ChecklistManagers_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_GroupChanges] ADD  CONSTRAINT [df_qcheck_groups_dt]  DEFAULT (getdate()) FOR [dt]
GO
ALTER TABLE [dbo].[QCheck_GroupMembership] ADD  CONSTRAINT [DF_QCheck_GroupMembership_AsOf]  DEFAULT (getdate()) FOR [AsOf]
GO
ALTER TABLE [dbo].[QCheck_Groups] ADD  CONSTRAINT [DF_QCheck_Groups_SingleMemberGroup]  DEFAULT ((0)) FOR [SingleMemberGroup]
GO
ALTER TABLE [dbo].[QCheck_Impersonate] ADD  CONSTRAINT [DF_QCheck_Impersonate_isDeleted]  DEFAULT ((0)) FOR [isDeleted]
GO
ALTER TABLE [dbo].[QCheck_Items] ADD  CONSTRAINT [DF_QCheck_Items_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_ItemTypes] ADD  CONSTRAINT [DF_QCheck_ItemTypes_NativeType]  DEFAULT ((0)) FOR [NativeType]
GO
ALTER TABLE [dbo].[QCheck_QueuedEmails] ADD  CONSTRAINT [DF_QCheck_QueuedEmails_HasComments]  DEFAULT ((1)) FOR [HasComments]
GO
ALTER TABLE [dbo].[QCheck_QueuedEmails] ADD  CONSTRAINT [DF_QCheck_QueuedEmails_Delivered]  DEFAULT ((0)) FOR [Delivered]
GO
ALTER TABLE [dbo].[QCheck_QueuedEmails] ADD  CONSTRAINT [DF_QCheck_QueuedEmails_Notified]  DEFAULT ((0)) FOR [Notified]
GO
ALTER TABLE [dbo].[QCheck_QueuedEmails] ADD  CONSTRAINT [DF_QCheck_QueuedEmails_Errored]  DEFAULT ((0)) FOR [Errored]
GO
ALTER TABLE [dbo].[QCheck_Reassign_History] ADD  DEFAULT (getdate()) FOR [ViewDate]
GO
ALTER TABLE [dbo].[QCheck_Suggestions] ADD  CONSTRAINT [DF_QCheck_Suggestions_DisplayOrder]  DEFAULT ((0)) FOR [DisplayOrder]
GO
ALTER TABLE [dbo].[QCheck_Suggestions] ADD  CONSTRAINT [DF_QCheck_Suggestions_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Suggestions] ADD  CONSTRAINT [DF_QCheck_Suggestions_Dt]  DEFAULT (getdate()) FOR [Dt]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Password_Password]  DEFAULT ('QCheck') FOR [Password]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Users_Admin]  DEFAULT ((0)) FOR [Admin]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Users_App]  DEFAULT ((1)) FOR [App]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Users_empID]  DEFAULT ((0)) FOR [empID]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Users_DepartmentAdmin]  DEFAULT ((0)) FOR [DepartmentAdmin]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Users_Priorities]  DEFAULT ((1)) FOR [Priorities]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  CONSTRAINT [DF_QCheck_Users_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QCheck_Users] ADD  DEFAULT ((0)) FOR [Beta]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_IsSupervisor]  DEFAULT ((0)) FOR [IsSupervisor]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_ControllerComments]  DEFAULT ((0)) FOR [ControllerComments]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_SupervisorComments]  DEFAULT ((0)) FOR [SupervisorComments]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_IP_Bonus]  DEFAULT ((0)) FOR [IPComments]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_ControllerDeductions]  DEFAULT ((0)) FOR [ControllerDeductions]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_SupervisorDeductions]  DEFAULT ((0)) FOR [SupervisorDeductions]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_Overdue0]  DEFAULT ((0)) FOR [Overdue]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_ChecklistOverdue]  DEFAULT ((0)) FOR [ChecklistOverdue]
GO
ALTER TABLE [dbo].[QPI_Data] ADD  CONSTRAINT [DF_QPI_Data_ReportWithoutComments]  DEFAULT ((0)) FOR [ReportDeductions]
GO
ALTER TABLE [dbo].[QPI_Points] ADD  CONSTRAINT [DF_QPI_Points_ChecklistOverdue]  DEFAULT ((0)) FOR [ChecklistOverdue]
GO
ALTER TABLE [dbo].[QPI_Points] ADD  CONSTRAINT [DF_QPI_Points_ReportDays]  DEFAULT ((10)) FOR [ReportDays]
GO
ALTER TABLE [dbo].[QPI_Users] ADD  CONSTRAINT [DF_QPI_Users_Priorities]  DEFAULT ((0)) FOR [Priorities]
GO
ALTER TABLE [dbo].[QStatus_ActiveChecklistTaskType] ADD  CONSTRAINT [DF_QStatus_ActiveChecklistTaskType_CreateDt]  DEFAULT (getdate()) FOR [CreateDt]
GO
ALTER TABLE [dbo].[QStatus_ActiveChecklistTaskTypeArchive] ADD  CONSTRAINT [DF_QStatus_ActiveChecklistTaskTypeArchive_ArchiveDt]  DEFAULT (getdate()) FOR [ArchiveDt]
GO
ALTER TABLE [dbo].[QStatus_AutomationEmailPreferences] ADD  CONSTRAINT [DF_QStatus_AutomationEmailPreferences_EChecklistPriority]  DEFAULT ((-1)) FOR [EChecklistPriority]
GO
ALTER TABLE [dbo].[QStatus_CommentArchive] ADD  CONSTRAINT [DF_QStatus_CommentArchive_TabIn]  DEFAULT ((0)) FOR [TabIn]
GO
ALTER TABLE [dbo].[QStatus_Comments] ADD  CONSTRAINT [DF_QStatus_Comments_DisplayOrder]  DEFAULT ((0)) FOR [DisplayOrder]
GO
ALTER TABLE [dbo].[QStatus_Comments] ADD  CONSTRAINT [DF_QStatus_Comments_TabIn]  DEFAULT ((0)) FOR [TabIn]
GO
ALTER TABLE [dbo].[QStatus_Comments] ADD  CONSTRAINT [DF_QStatus_Comments_SpecialTask]  DEFAULT ((0)) FOR [SpecialTask]
GO
ALTER TABLE [dbo].[QStatus_GroupReport] ADD  CONSTRAINT [DF_QStatus_GroupReport_DefaultReport]  DEFAULT ((0)) FOR [DefaultReport]
GO
ALTER TABLE [dbo].[QStatus_GroupReport] ADD  CONSTRAINT [DF_QStatus_GroupReport_AsOf]  DEFAULT (getdate()) FOR [AsOf]
GO
ALTER TABLE [dbo].[QStatus_Preferences] ADD  CONSTRAINT [DF_QStatus_Preferences_ReportID]  DEFAULT ((0)) FOR [ReportID]
GO
ALTER TABLE [dbo].[QStatus_Preferences] ADD  CONSTRAINT [DF_QStatus_Preferences_PreferenceType]  DEFAULT ((1)) FOR [PreferenceType]
GO
ALTER TABLE [dbo].[QStatus_Preferences] ADD  CONSTRAINT [DF_QStatus_Preferences_PreferenceValue]  DEFAULT ((0)) FOR [PreferenceValue]
GO
ALTER TABLE [dbo].[QStatus_Report] ADD  CONSTRAINT [DF_QStatus_Report_IsConfidential]  DEFAULT ((0)) FOR [IsConfidential]
GO
ALTER TABLE [dbo].[QStatus_Report] ADD  CONSTRAINT [DF_QStatus_Report_LastReportDate]  DEFAULT (getdate()) FOR [LastReportDate]
GO
ALTER TABLE [dbo].[QStatus_Report] ADD  CONSTRAINT [DF_QStatus_Report_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QStatus_Report] ADD  DEFAULT ((0)) FOR [IsDirty]
GO
ALTER TABLE [dbo].[QStatus_SpecialTasks] ADD  CONSTRAINT [DF_QStatus_SpecialTasks_Priority]  DEFAULT ((1)) FOR [Priority]
GO
ALTER TABLE [dbo].[QStatus_SpecialTasks] ADD  CONSTRAINT [DF_QStatus_SpecialTasks_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO
ALTER TABLE [dbo].[QStatus_SpecialTasks] ADD  CONSTRAINT [DF_QStatus_SpecialTasks_UpdatedDate]  DEFAULT ((0)) FOR [UpdatedDate]
GO
ALTER TABLE [dbo].[QStatus_Supervisors] ADD  CONSTRAINT [DF_QStatus_Supervisors_ReportID]  DEFAULT ((0)) FOR [ReportID]
GO
ALTER TABLE [dbo].[QStatus_Supervisors] ADD  CONSTRAINT [DF_QStatus_Supervisors_DirectSupervisor]  DEFAULT ((1)) FOR [DirectSupervisor]
GO
ALTER TABLE [dbo].[QStatus_Supervisors] ADD  CONSTRAINT [DF_QStatus_Supervisors_InterestedParty]  DEFAULT ((0)) FOR [InterestedParty]
GO
ALTER TABLE [dbo].[QStatus_Supervisors] ADD  CONSTRAINT [DF_QStatus_Supervisors_AsOf]  DEFAULT (getdate()) FOR [AsOf]
GO
ALTER TABLE [dbo].[QStatus_TaxCorrespondenceFiles] ADD  DEFAULT ((0)) FOR [TaskCreated]
GO
ALTER TABLE [dbo].[QStatus_TempTasks] ADD  CONSTRAINT [DF_QStatus_TempTasks_specialTask]  DEFAULT ((0)) FOR [specialTask]
GO
ALTER TABLE [dbo].[QStatus_TempTasks] ADD  CONSTRAINT [DF_QStatus_TempTasks_input_date]  DEFAULT (getdate()) FOR [input_date]
GO
ALTER TABLE [dbo].[Schedule_PriorityList_Exclude] ADD  DEFAULT (getdate()) FOR [CreatedDate]
GO
ALTER TABLE [dbo].[Schedule_PriorityList_Exclude] ADD  CONSTRAINT [DF_Schedule_PriorityList_Exclude_IsActive]  DEFAULT ((1)) FOR [IsActive]
GO
ALTER TABLE [dbo].[Audit_ActiveChecklist]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_ActiveChecklist] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_ActiveChecklist] CHECK CONSTRAINT [FK_AuditType_ActiveChecklist]
GO
ALTER TABLE [dbo].[Audit_ActiveItem]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_ActiveItem] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_ActiveItem] CHECK CONSTRAINT [FK_AuditType_ActiveItem]
GO
ALTER TABLE [dbo].[Audit_ApprovalChecklist]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_ApprovalChecklist] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_ApprovalChecklist] CHECK CONSTRAINT [FK_AuditType_ApprovalChecklist]
GO
ALTER TABLE [dbo].[Audit_ApprovalItem]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_ApprovalItem] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_ApprovalItem] CHECK CONSTRAINT [FK_AuditType_ApprovalItem]
GO
ALTER TABLE [dbo].[Audit_ChangeRequest]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_ChangeRequest] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_ChangeRequest] CHECK CONSTRAINT [FK_AuditType_ChangeRequest]
GO
ALTER TABLE [dbo].[Audit_Checklist]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_Checklist] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_Checklist] CHECK CONSTRAINT [FK_AuditType_Checklist]
GO
ALTER TABLE [dbo].[Audit_Comment]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_Comment] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_Comment] CHECK CONSTRAINT [FK_AuditType_Comment]
GO
ALTER TABLE [dbo].[Audit_CommentArchived]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_CommentArchived] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_CommentArchived] CHECK CONSTRAINT [FK_AuditType_CommentArchived]
GO
ALTER TABLE [dbo].[Audit_Item]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_Item] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_Item] CHECK CONSTRAINT [FK_AuditType_Item]
GO
ALTER TABLE [dbo].[Audit_Report]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_Report] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_Report] CHECK CONSTRAINT [FK_AuditType_Report]
GO
ALTER TABLE [dbo].[Audit_TaskType]  WITH CHECK ADD  CONSTRAINT [FK_AuditType_TaskType] FOREIGN KEY([AuditTypeId])
REFERENCES [dbo].[Audit_Type] ([AuditTypeId])
GO
ALTER TABLE [dbo].[Audit_TaskType] CHECK CONSTRAINT [FK_AuditType_TaskType]
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_Get]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROC [dbo].[PriorityList_Get]
	@UserID int
AS
BEGIN
	SET NOCOUNT ON

	EXEC PriorityList_Refresh @UserID

	SELECT DISTINCT p.ID, 
		convert(varchar(10)
		, p.Priority) as Priority
		, p.ActiveChecklistID
		, c.[Name]
		, convert(varchar, ac.duetime, 101) as due
		, isnull('['+convert(varchar, qc.commentdt, 101) + '] [' + qc.initials + '] ' + replace(qc.comments, '''', ''), 'No Comments') as comments
		, @UserID as UserId
		, CASE WHEN convert(integer, p.Priority) > 0 THEN 0 ELSE 1 END AS PriorityRank --active ones first
		, convert(integer, p.Priority) AS PriorityNbr
		, ac.duetime
		, c.ID AS ChecklistId
		, qc.ID AS CommentId
	INTO #result
	FROM 
		PriorityList p
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.id = p.ActiveChecklistID
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.id = ac.instanceid
		INNER JOIN QCheck_Checklists c
			ON c.id = ci.checklistid
		LEFT OUTER JOIN
			(select foreignkeyid, max(ID) as ID from qstatus_comments
			where specialtask = 0
			group by foreignkeyid
			) com ON com.foreignkeyid = ac.ID
		LEFT OUTER JOIN qstatus_comments qc
			ON qc.ID = com.ID
	WHERE p.UserID = @UserID
	and (ac.completeddate is null
	or ac.completeddate > convert(datetime, convert(varchar, getdate() - 1, 1)))

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ActiveChecklistID FROM #result WHERE ActiveChecklistID IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveChecklist', 2

	DELETE @recordIds 
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM #result WHERE ChecklistId IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	DELETE @recordIds 
	INSERT INTO @recordIds
		SELECT DISTINCT CommentId FROM #result WHERE CommentId IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'Comment', 2

	ALTER TABLE #result DROP COLUMN ChecklistId
	ALTER TABLE #result DROP COLUMN CommentId

	SELECT *
	FROM #result
	ORDER BY PriorityRank, PriorityNbr, DueTime
END
GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_GetComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[PriorityListSet_GetComments]
	@SetID int,
	@UserID int,
	@StartTime datetime,
	@AllUsers bit = 0
AS
BEGIN
	SET NOCOUNT ON

	select 
		u.userid, 
		l.activechecklistid, 
		--'[' + c.initials + '] '+ case when c.comments like '%href%' then c.comments else replace(c.comments, '''', '''''') end as comments,--commented by venkat 11/02/2017
		'[' + c.initials + '] '+ c.comments as comments,
		l.id,
		c.id as CommentId,
		c.DisplayOrder
	into #result
	from prioritylistusers u
	inner join prioritylist l
	on l.userid = u.userid
	inner join qstatus_comments c
	on c.foreignkeyid = l.activechecklistid
	and c.specialtask = 0
	and (c.userid = @userid OR @AllUsers = 1)
	and c.commentdt > @starttime
	where u.setid = @setid
	and len(c.comments) > 0
	order by u.userid, c.displayorder

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT CommentId FROM #result WHERE CommentId IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'Comment', 2

	SELECT userid, activechecklistid, comments, id
	FROM #result
	ORDER BY UserID, DisplayOrder
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveInstanceAlert_SingleUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck_ActiveInstanceAlert_SingleUser](
	@ActiveInstanceID int,
	@ChecklistName varchar(500),
	@Alertee int,
	@AlertType varchar(10)
)
AS

BEGIN
	SET NOCOUNT ON

	DECLARE @mail_to VARCHAR(500)
	DECLARE @mail_from VARCHAR(500)
	DECLARE @mail_subject VARCHAR(500)
	
	DECLARE @imgURL VARCHAR(50)
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), 
		@FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, 
		@ImagesURL = ImagesURL, 
		@ExternalURL = ExternalURL, 
		@BaseDomain = BaseDomain, 
		@FromAddress = FromAddress, 
		@Appname = AppName, 
		@GradingAddress = GradingAddress, 
		@AutomationAddress = AutomationAddress 
		FROM QCheck_AppSettings 
		WHERE ID = 1
	
	-- 3/24/2014 dalvarado - The code above has always been buggy because @Alertee is a group id, not a user id. Instead just using
	-- the values from the app configuration section.
	SET @imgURL = @ImagesURL

	SELECT @mail_to = ''

	SELECT @mail_to = @mail_to + Email + ';' FROM QCheck_Users u
	inner join qcheck_groupmembership gm
	on gm.userid = u.id
	where gm.groupID = @Alertee AND u.IsDeleted = 0

	--If there are no recipients, don't bother sending
	if(len(@mail_to) = 0) RETURN	

	-- AUDIT BEGIN
	DECLARE @userIds AS RecordId, @recordIds AS RecordId, @userId AS INT

	INSERT INTO @userIds
		SELECT u.ID 
		FROM QCheck_Users u
		INNER JOIN qcheck_groupmembership gm ON gm.userid = u.id
		WHERE gm.groupID = @Alertee AND u.IsDeleted = 0

	SELECT DISTINCT 
		 ActiveChecklistId = a.ID
		,ChecklistId = c.ID
		,ItemId = k.ID
		,ActiveItemId = ai.ID 
	INTO #auditId
	FROM QCheck_ActiveChecklists a
	INNER JOIN QCheck_ActiveAssignments b ON b.ActiveChecklistID = a.ID
	INNER JOIN QCheck_Assignments c ON b.AssignmentsID = c.ID and c.IsDeleted = 0
	INNER JOIN QCheck_ChecklistInstances e ON a.InstanceID = e.ID and e.isDeleted = 0
	INNER JOIN QCheck_Checklists f ON e.ChecklistID = f.ID and f.isDeleted = 0
	INNER JOIN QCheck_Items k on k.checklistID = f.ID AND k.IsDeleted = 0
	LEFT OUTER JOIN QCheck_ActiveItems ai on ai.ActiveChecklistID = a.ID and ai.ChecklistItemID = k.ID
	WHERE a.ID = @ActiveInstanceID

	DECLARE oCursor CURSOR FOR
		SELECT DISTINCT Id FROM @userIds

	OPEN oCursor
	FETCH NEXT FROM oCursor INTO @userId
	WHILE @@FETCH_STATUS = 0 BEGIN
		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ChecklistId
			FROM #auditId
			WHERE ChecklistId IS NOT NULL
		EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ItemID
			FROM #auditId
			WHERE ItemID IS NOT NULL
		EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 2

		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ActiveItemId
			FROM #auditId
			WHERE ActiveItemId IS NOT NULL
		EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveItem', 2

		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ActiveChecklistId
			FROM #auditId
			WHERE ActiveChecklistId IS NOT NULL
		EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveChecklist', 2

		FETCH NEXT FROM oCursor INTO @userId
	END
	CLOSE oCursor
	DEALLOCATE oCursor
	-- AUDIT END
	
	SET @mail_from = @FromAddress
	
	If @AlertType = 'Start' SET @mail_subject = 'Alert - ' + @ChecklistName + ' has started'
	If @AlertType = 'Complete' SET @mail_subject = ' Alert - ' + @ChecklistName + ' has been completed'

	declare @html table (id int identity(1,1), html varchar(max))
	insert into @html exec QCheck_ActiveInstanceAlert_SingleUser_HTML @ActiveInstanceID, @AlertType, @appURL, @imgURL
	declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
	while exists (select 1 from @html)
	begin
		select top 1 @rowid = id from @html order by id asc
		select @onerow = html from @html where id = @rowid
		select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
		delete from @html where id = @rowid
	end
	
	exec [dbo].[xp_smtp_sendmail]
			@to = @mail_to,
			@from = @mail_from,
			@subject = @mail_subject,
			@message = @htmlstr
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveTasksAssigned]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_ActiveTasksAssigned] 
	@UserID As Int,
	@WithStatus As Bit = 0
AS
BEGIN
	SET NOCOUNT ON

	SELECT Distinct
		i.ID As instanceID,
		udt.ID As upcomingID,
		CASE WHEN ac.CompletedDate IS NULL THEN
			1
		ELSE
			2
		END AS HistoryType,
		ISNULL(ac.ID, aca.ID) As HistoryID,
		c.Name as 'Checklist Name', 
		dbo.QCheck_AssigneesList(isNull(i.ID,0)) as Assignees,
		dbo.QCheck_ManagersList(isNull(c.ID,0)) as Managers,
		CASE WHEN s.FreqType = 1 THEN
			'ONE TIME'
		WHEN s.FreqType = 2 THEN
			'DAILY'
		WHEN s.FreqType = 3 THEN
			'WEEKLY'
		WHEN s.FreqType = 4 THEN
			CASE WHEN s.FreqRecurrance = 4 THEN
				'QUARTERLY'
			ELSE
				'MONTHLY'
			END
		WHEN s.FreqType = 5 THEN
			'YEARLY'
		END As Frequency,
		isNull(ac.CompletedDate, aca.CompletedDate) as 'Last Completed',
		active.DueTime as 'Current Due Time', 
		active.ID as ActiveID,
		udt.duetime as nextduedate,
		c.ID AS ChecklistId
	INTO #result
	FROM
		QCheck_Checklists c
	LEFT OUTER JOIN
		QCheck_ChecklistInstances i 
	ON
		i.ChecklistID = c.ID
 AND
		i.IsDeleted = 0
	INNER JOIN
		(SELECT ID, DueTime, InstanceID FROM QCheck_ActiveChecklists WHERE ID IN
		(SELECT MIN(ID) as ID
		FROM 
			QCheck_ActiveChecklists
		--WHERE
			--completedDate is null
		GROUP BY InstanceID)) active
	ON
		active.InstanceID = i.ID
	LEFT OUTER JOIN
		(
			SELECT 
				actt.ActiveChecklistID
			FROM
				QStatus_GroupReport gr
			INNER JOIN
				QStatus_Report r
			ON
				r.IsDeleted = 0
			AND
				gr.ReportID = r.ID
			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = gr.GroupID
			INNER JOIN 
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID
			AND 
				gm.UserID = @UserID
			INNER JOIN
				QStatus_TaskTypes tt
			on
				tt.ReportID = r.ID
			AND
				tt.IsDeleted = 0
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			on
				actt.TaskType = tt.ID
		) mytasktypes
	ON
		mytasktypes.ActiveChecklistID = active.ID
	LEFT OUTER JOIN
		QCheck_Schedule s
	ON
		s.ID = i.ScheduleID
	LEFT OUTER JOIN
		(
		SELECT a1.ID, a1.InstanceID, a1.completedDate
		FROM
			QCheck_ActiveChecklists a1
		INNER JOIN
			(
			SELECT 
				InstanceID, MAX(completeddate) as completedDate
			FROM
				QCheck_ActiveChecklists a
			GROUP BY
				 InstanceID
			) a2
		ON a1.InstanceID = a2.InstanceID and a1.completeddate = a2.completeddate
		) ac
	ON
		ac.InstanceID = i.ID
	LEFT OUTER JOIN
		(SELECT a1.ID, a1.InstanceID, a1.completedDate
		FROM
			QCheck_ActiveChecklistArchive a1
		INNER JOIN
			(SELECT 
				InstanceID, MAX(completeddate) as completedDate
			FROM
				QCheck_ActiveChecklistArchive a
			GROUP BY
				 InstanceID
			) a2
		ON a1.InstanceID = a2.InstanceID and a1.completeddate = a2.completeddate
		) aca
	ON
		aca.InstanceID = i.ID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.UserID = @UserID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	INNER JOIN 
		QCheck_Assignments assignedTo
	ON
		assignedTo.IsDeleted = 0
	 AND 
		assignedTo.GroupID = g.ID
	 AND
		assignedTo.InstanceID = i.ID
	LEFT OUTER JOIN
		QCheck_UpcomingDueTimes udt
	ON
		udt.InstanceID = i.ID
	AND
		udt.duetime <> active.duetime
	LEFT OUTER JOIN
		QCheck_UpcomingDueTimes udt2
	ON
		udt2.InstanceID = i.ID
	AND
		udt2.duetime < udt.duetime
	WHERE
		udt2.id is null
	and 
		mytasktypes.ActiveChecklistID is null

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM #result WHERE ChecklistId IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT ActiveID FROM #result WHERE ActiveID IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveChecklist', 2

	SELECT * FROM #result ORDER BY Assignees
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveTasksManaged]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_ActiveTasksManaged] 
	@UserID As Int
AS
BEGIN
	SET NOCOUNT ON
	SELECT
		Distinct
		i.ID As instanceID,
		udt.ID As upcomingID,
		CASE WHEN ac.CompletedDate IS NULL THEN
			1
		ELSE
			2
		END AS HistoryType,
		ISNULL(ac.ID, aca.ID) As HistoryID,
		c.Name as 'Checklist Name', 
		dbo.QCheck_AssigneesList(isNull(i.ID,0)) as Assignees,
		dbo.QCheck_ManagersList(isNull(c.ID,0)) as Managers,
		CASE WHEN s.FreqType = 1 THEN
			'ONE TIME'
		WHEN s.FreqType = 2 THEN
			'DAILY'
		WHEN s.FreqType = 3 THEN
			'WEEKLY'
		WHEN s.FreqType = 4 THEN
			CASE WHEN s.FreqRecurrance = 4 THEN
				'QUARTERLY'
			ELSE
				'MONTHLY'
			END
		WHEN s.FreqType = 5 THEN
			'YEARLY'
		END As Frequency,
		isNull(ac.CompletedDate, aca.CompletedDate) as 'Last Completed',
		active.DueTime as 'Current Due Time', 
		active.ID as ActiveID,
		udt.duetime as nextduedate,
		c.ID AS ChecklistId
	INTO #result
	FROM
		QCheck_Checklists c
	LEFT OUTER JOIN
		QCheck_ChecklistInstances i 
	ON
		i.ChecklistID = c.ID
 AND
		i.IsDeleted = 0
	INNER JOIN
		(SELECT * FROM QCheck_ActiveChecklists WHERE ID IN
		(SELECT MIN(ID) as ID
		FROM 
			QCheck_ActiveChecklists
		--WHERE
			--completedDate is null
		GROUP BY InstanceID)) active
	ON
		active.InstanceID = i.ID
	LEFT OUTER JOIN
		(
			SELECT 
				actt.ActiveChecklistID
			FROM
				QStatus_GroupReport gr
			INNER JOIN
				QStatus_Report r
			ON
				r.IsDeleted = 0
			AND
				gr.ReportID = r.ID
			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = gr.GroupID
			INNER JOIN 
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID
			AND 
				gm.UserID = @UserID
			INNER JOIN
				QStatus_TaskTypes tt
			on
				tt.ReportID = r.ID
			AND
				tt.IsDeleted = 0
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			on
				actt.TaskType = tt.ID
		) mytasktypes
	ON
		mytasktypes.ActiveChecklistID = active.ID
	LEFT OUTER JOIN
		QCheck_Schedule s
	ON
		s.ID = i.ScheduleID
	LEFT OUTER JOIN
		(
		SELECT a1.ID, a1.InstanceID, a1.completedDate
		FROM
			QCheck_ActiveChecklists a1
		INNER JOIN
			(
			SELECT 
				InstanceID, MAX(completeddate) as completedDate
			FROM
				QCheck_ActiveChecklists a
			GROUP BY
				 InstanceID
			) a2
		ON a1.InstanceID = a2.InstanceID and a1.completeddate = a2.completeddate
		) ac
	ON
		ac.InstanceID = i.ID
	LEFT OUTER JOIN
		(SELECT a1.ID, a1.InstanceID, a1.completedDate
		FROM
			QCheck_ActiveChecklistArchive a1
		INNER JOIN
			(SELECT 
				InstanceID, MAX(completeddate) as completedDate
			FROM
				QCheck_ActiveChecklistArchive a
			GROUP BY
				 InstanceID
			) a2
		ON a1.InstanceID = a2.InstanceID and a1.completeddate = a2.completeddate
		) aca
	ON
		aca.InstanceID = i.ID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.UserID = @UserID
	INNER JOIN QCheck_Groups g
	ON
		g.ID = gm.GroupID
	INNER JOIN
		QCheck_ChecklistManagers m
	ON
		c.ID = m.ChecklistID
	 AND
		m.ManagerGroupID = g.ID
	 AND
		m.IsDeleted = 0
	INNER JOIN 
		QCheck_Assignments assignedTo
	ON
		assignedTo.IsDeleted = 0
	 AND 
		NOT (assignedTo.GroupID = g.ID)
	 AND
		assignedTo.InstanceID = i.ID
	LEFT OUTER JOIN
		QCheck_UpcomingDueTimes udt
	ON
		udt.InstanceID = i.ID
	AND
		udt.duetime <> active.dueTime
	LEFT OUTER JOIN
		QCheck_UpcomingDueTimes udt2
	ON
		udt2.InstanceID = i.ID
	AND
		udt2.duetime < udt.duetime
	WHERE
		
		c.IsDeleted = 0
	and
		udt2.id is null
	and 
		mytasktypes.ActiveChecklistID is null

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM #result WHERE ChecklistId IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT ActiveID FROM #result WHERE ActiveID IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveChecklist', 2

	SELECT * FROM #result ORDER BY Assignees
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC[dbo].[QCheck_AddItem]
	@ChecklistID INT,
	@SequenceNum INT = null,
	@ItemTypeID INT,
	@Text	varchar(max),
	@URL	varchar(1000),
	@UserId int
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @recordIds AS RecordId, @itemId INT

	If @SequenceNum is null 
	BEGIN
		SELECT @SequenceNum = isnull(max([SequenceNum]),0) + 1
		FROM QCheck_Items
		WHERE [ChecklistID] = @ChecklistID
		AND IsDeleted = 0	
	END
	ELSE
	BEGIN
		-- if any item exists with the current sequence, then
		-- move everything up one to put it in place
		INSERT INTO @recordIds
			SELECT ID 
			FROM QCheck_Items
			WHERE [SequenceNum] >= @SequenceNum
			AND EXISTS (
				SELECT ID FROM QCheck_Items 
				WHERE [ChecklistID] = @ChecklistID
				AND [SequenceNum] = @SequenceNum
			)
		EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 3
	
		UPDATE QCheck_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE [SequenceNum] >= @SequenceNum
		AND EXISTS
		(
			SELECT ID FROM QCheck_Items 
			WHERE [ChecklistID] = @ChecklistID
			AND [SequenceNum] = @SequenceNum
		)
	END
	

	-- now insert the new item directly into the table
	INSERT INTO QCheck_Items ([ChecklistID], [SequenceNum], [ItemTypeID], [Text], [URL])
	VALUES (@ChecklistID,@SequenceNum,@ItemTypeID,@Text,@URL)
	SET @itemId = SCOPE_IDENTITY()

	DELETE @recordIds
	INSERT INTO @recordIds VALUES(@itemId)
	EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 1
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_AddItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROC [dbo].[QCheck_Approval_AddItem]
	@ChangeID INT,
	@ChecklistID INT,
	@SequenceNum INT = null,
	@ItemTypeID INT,
	@Text	varchar(max),
	@URL	varchar(1000),
	@UserId INT,
	@ReturnID INT = NULL OUTPUT
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @recordIds AS RecordId

	IF @SequenceNum IS NULL BEGIN

		SELECT @SequenceNum = isnull(max([SequenceNum]),0) + 1
		FROM QCheck_Approval_Items
		WHERE 
			ChangeRequestID = @ChangeID
			AND [ChecklistID] = @ChecklistID
			AND IsDeleted = 0

	END ELSE BEGIN
		-- if any item exists with the current sequence, then
		-- move everything up one to put it in place	
		INSERT INTO @recordIds
			SELECT ID 
			FROM QCheck_Approval_Items
			WHERE 
				[SequenceNum] >= @SequenceNum
				AND EXISTS (
					SELECT [ID] 
					FROM QCheck_Approval_Items 
					WHERE 
						ChangeRequestID = @ChangeID
						AND ChecklistID = @ChecklistID
						AND SequenceNum = @SequenceNum
				)
		EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalItem', 3

		UPDATE QCheck_Approval_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE 
			[SequenceNum] >= @SequenceNum
			AND EXISTS (
				SELECT [ID] 
				FROM QCheck_Approval_Items 
				WHERE 
					ChangeRequestID = @ChangeID
					AND ChecklistID = @ChecklistID
					AND SequenceNum = @SequenceNum
			)
	END
	
	-- now insert the new item into the holding table
	INSERT INTO QCheck_Approval_Items (
		ChangeRequestID,
		ItemID,
		ChecklistID, 
		SequenceNum, 
		ItemTypeID, 
		[Text], 
		URL,
		IsDeleted
	) VALUES (
		@ChangeID,
		-1,
		@ChecklistID,
		@SequenceNum,
		@ItemTypeID,
		@Text,
		@URL,
		0
	)
	
	SELECT @ReturnID = @@IDENTITY

	DELETE @recordIds
	INSERT INTO @recordIds VALUES(@ReturnID)
	EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalItem', 1
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DelItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- This stored procedure will delete an item from a checklist (mark isDeleted - true).
CREATE   PROC [dbo].[QCheck_Approval_DelItem]
	@ID INT,
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON	
	
	--basic update here - checklist ID is not needed here but left for redundancy
	DECLARE @ItemID INT, @recordIds AS RecordId
	INSERT INTO @recordIds VALUES(@ID)

	SELECT @ItemID = ItemID
	FROM QCheck_Approval_Items
	WHERE [ID] = @ID

	IF @ItemID = -1 BEGIN
		EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalItem', 4

		-- This was a new item added for the change, just delete it from the change
		DELETE FROM QCheck_Approval_Items
		WHERE [ID] = @ID

	END ELSE BEGIN	
		EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalItem', 3

		-- This is an existing checklist item that is being requested to remove from the checklist
		UPDATE QCheck_Approval_Items
		SET IsDeleted = 1
		WHERE [ID] = @ID

	END
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetChecklistName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_Approval_GetChecklistName] (
	@ChangeID INT,
	@UserId INT,
	@ChecklistName VARCHAR(500) OUTPUT
) AS

BEGIN
	SET NOCOUNT ON

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds VALUES(@ChangeID)

	EXEC dbo.Audit_Set @userId, @recordIds, 'ChangeRequest', 2

	SET @ChecklistName = NULL

	SELECT 
		@ChecklistName = [Name]
	FROM 
		QCheck_Approval_Checklists c
		INNER JOIN QCheck_Approval_ChangeRequestItems CRI
			ON c.CRItemID = CRI.[ID]
			AND CRI.Approved = 1
	WHERE 
		c.ChangeRequestID = @ChangeID

	IF @ChecklistName IS NULL BEGIN

		SELECT @ChecklistName = dbo.QCheck_Approval_CRChecklistName(@ChangeID)

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetSupervisorChangeRequests]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_Approval_GetSupervisorChangeRequests] 
	@UserID INT, -- The UserID of the controller,
	@ID INT = NULL,
	@Sort int = 0 --0 = by request date, 1= by name, 2 = by new deadline
AS
BEGIN
	SET NOCOUNT ON
	-- Pulls back the list of change requests requiring the given supervisor's approval or rejection
	SELECT 
		CR.[ID],
		CR.RequestingUser,
		RU.FullName,
		Ru.Email,
		CR.RequestDate,
		CR.Comment,
		crc.ID AS ChecklistID,
		c.Name AS ChecklistName,
		'' as Controllers,--dbo.QCheck_ManagersList(crc.ID) AS Controllers,
		'' as Assignees,--dbo.QCheck_AssigneesList(ci.InstanceID) AS Assignees
		dbo.QCheck_Approval_ExtensionLength(cr.id) as extensiondays,
		dbo.QCheck_Approval_ExtensionCount(cr.id) as extensioncount,
		deadlinechecklist.completeddate,
		case when ac.id is not null and ac.duetime <> ac.origduetime and ac.duetime < getdate() 
			then 
			'** Requested deadline has passed! Upon approval, deadline will be set to ' +CONVERT(VARCHAR, dateadd(hour, datepart(hour,ac.duetime), dbo.Util_addofficedays(getdate(), 1)), 101)+ ' instead**'
			else ''
		end as DatePassedMessage,
		AC.DueTime
	INTO #result
	FROM 
		QCheck_Approval_ChangeRequests CR
		inner join qcheck_approval_changerequestchecklist crc
			on crc.changerequestid = cr.id
		inner join qcheck_checklists c
			on c.id = crc.id
		INNER JOIN QCheck_ChecklistManagers CM
			ON CM.ChecklistID = c.ID
			AND CM.IsDeleted = 0
		INNER JOIN QCheck_Groups G
			ON CM.ManagerGroupID = G.[ID]
		INNER JOIN QCheck_GroupMembership GM
			ON G.[ID] = GM.GroupID
		INNER JOIN QCheck_Users CU
			ON GM.UserID = CU.[ID]
		INNER JOIN QCheck_Users RU
			ON CR.RequestingUser = RU.[ID]
		LEFT OUTER JOIN QCheck_Approval_ActiveChecklists AC
			ON AC.ChangeRequestID = CR.ID
		OUTER APPLY 
				(
					SELECT id, completeddate FROM QCheck_ActiveChecklists_All
					WHERE id = AC.activechecklistID
				) deadlinechecklist
	WHERE
		CR.IsActive = 1
		AND CR.Approved = 0
		AND CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		AND CU.[ID] = @UserID	
		AND (CR.ID = @ID or @ID is null)

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM #result WHERE ChecklistId IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM #result WHERE ID IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'ChangeRequest', 2

	SELECT *
	FROM #result
	ORDER BY
		CASE 
		 WHEN @Sort = 0 then convert(varchar,RequestDate, 120) 
		 WHEN @Sort = 1 then FullName
		 ELSE convert(varchar, duetime, 120)
		END
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_UpdateChecklistName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_Approval_UpdateChecklistName] 
	@ChangeID INT,
	@ChecklistID INT,
	@Name VARCHAR(500),
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @recordIds AS RecordId

	IF EXISTS(SELECT * FROM QCheck_Approval_Checklists WHERE ChangeRequestID = @ChangeID AND ChecklistID = @ChecklistID) BEGIN
		INSERT INTO @recordIds 
			SELECT ID
			FROM QCheck_Approval_Checklists
			WHERE ChangeRequestID = @ChangeID AND ChecklistID = @ChecklistID
		EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalChecklist', 3

		UPDATE QCheck_Approval_Checklists
		SET [Name] = @Name
		WHERE ChangeRequestID = @ChangeID
		AND ChecklistID = @ChecklistID
	END ELSE BEGIN
		DECLARE @approvalRequestId INT

		INSERT INTO QCheck_Approval_Checklists (
			ChangeRequestID,
			ChecklistID,
			[Name],
			IsDeleted,
			Owner,
			Template
		)
			SELECT
				@ChangeID,
				@ChecklistID,
				@Name,
				IsDeleted,
				Owner,
				Template
			FROM
				QCheck_Checklists
			WHERE
				[ID] = @ChecklistID

		SET @approvalRequestId = SCOPE_IDENTITY()
		INSERT INTO @recordIds VALUES(@approvalRequestId)
		EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalChecklist', 1
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_UpdateItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_Approval_UpdateItem]
	@ChangeID INT,
	@ID INT,
	@ChecklistID INT,
	@SequenceNum INT = null,
	@ItemTypeID INT = null,
	@Text	varchar(1000) = null,
	@URL	varchar(1000) = null,
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @recordIds AS RecordId

	-- move everything up if there is already one at that sequence
	IF NOT @SequenceNum IS NULL BEGIN
		INSERT INTO @recordIds
			SELECT ID FROM QCheck_Approval_Items
			WHERE [SequenceNum] >= @SequenceNum
			AND EXISTS (
				SELECT [ID] FROM QCheck_Approval_Items 
				WHERE 
					ChangeRequestID = @ChangeID
					AND ChecklistID = @ChecklistID
					AND SequenceNum = @SequenceNum
			)
		EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalItem', 3

		UPDATE QCheck_Approval_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE [SequenceNum] >= @SequenceNum
		AND EXISTS (
			SELECT [ID] FROM QCheck_Approval_Items 
			WHERE 
				ChangeRequestID = @ChangeID
				AND ChecklistID = @ChecklistID
				AND SequenceNum = @SequenceNum
		)
	END

	-- update the item itself
	DELETE @recordIds
	INSERT INTO @recordIds VALUES(@ID)
	EXEC dbo.Audit_Set @userId, @recordIds, 'ApprovalItem', 3
	
	UPDATE QCheck_Approval_Items
	SET
		SequenceNum = IsNull(@SequenceNum, SequenceNum),
		ItemTypeID = IsNull(@ItemTypeID, ItemTypeID),
		[Text] = IsNull(@Text, [Text]),
		URL = IsNull(@URL, URL)
	WHERE 
		[ID] = @ID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_CompleteChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- This stored procedure will mark a checklist as Complete
-- ID is the checklist ID
-- if all items are not marked as complete, then it will not be completed
-- and a 0 will be returned

CREATE   PROCEDURE [dbo].[QCheck_CompleteChecklist](
	@ID INT,
	@CompletedBy int,
	@IsNA bit = 0,
	@NAReason varchar(max) = '',
	@isComplete bit output,
	@UpcomingDueTimeID INT = -1 OUTPUT,
	@NewActiveChecklistID INT = -1 OUTPUT
)
 AS

BEGIN
	SET NOCOUNT ON

	DECLARE @numChecks int,
			@numDone int,
			@numLeft int,
			@AssignedToChecklist INT,
			@ControlsChecklist INT, 
			@AlreadyComplete BIT = 0,
			@recordIds AS RecordId
			
	SET @AssignedToChecklist = 0
	SET @ControlsChecklist = 0
	
	SELECT 
		@AssignedToChecklist = gm.UserID,
		@AlreadyComplete = case when ac.CompletedDate is null then 0 else 1 end
	FROM
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_Assignments a
			ON a.InstanceID = ac.InstanceID
		INNER JOIN QCheck_Groups g
			ON g.ID = a.GroupId
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gm.UserID = @CompletedBy
			AND ac.ID = @ID
	
	SELECT
		@ControlsChecklist = gm.UserID
	FROM
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
		INNER JOIN QCheck_ChecklistManagers cm
			ON c.ID = cm.ChecklistID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.ID
		INNER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
			AND gm.UserID = @CompletedBy
			AND ac.ID = @ID
	
	SET @isComplete = 0

	--find the number of checks that must be completed
	SELECT 
		@numChecks = count(d.[ID]) 
	FROM
		QCheck_ActiveChecklists a
		INNER JOIN QCheck_ChecklistInstances b
			ON a.InstanceID = b.[ID]
		INNER JOIN QCheck_Checklists c
			ON b.ChecklistID = c.[ID]
		INNER JOIN QCheck_Items d
			ON d.ChecklistID = c.ID
	WHERE 
		a.[ID] = @ID
		AND d.ItemTypeID = 1
		AND d.IsDeleted = 0

	--find the number of checks that are done
	SELECT 
		@numDone = count(d.[ID]) 
	FROM
		QCheck_ActiveChecklists a
		INNER JOIN QCheck_ChecklistInstances b
			ON a.InstanceID = b.[ID]
		INNER JOIN QCheck_Checklists c
			ON b.ChecklistID = c.[ID]
		INNER JOIN QCheck_Items d
			ON d.ChecklistID = c.ID
		INNER JOIN QCheck_ActiveItems e
			ON d.[ID] = e.ChecklistItemID AND e.ActiveChecklistID = a.[ID]
	WHERE 
		a.[ID] = @ID
		AND d.ItemTypeID = 1
		AND d.IsDeleted = 0
		AND e.CompletedDate is not null

	--num left = total - done
	SET @numLeft = @numChecks - @numDone

	-- Mark individual checklist items complete. Assignees can mark complete if there is one step
	-- to the checklist (or one step left). Controllers can mark multiple step checklists complete
	-- per GPR 2/5/2014
	IF (@numChecks = 1 and @numLeft = 1) OR (@ControlsChecklist = 1 AND @AssignedToChecklist = 0) OR (@IsNA = 1)
	BEGIN
		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ID 
			FROM QCheck_ActiveItems
			WHERE ActiveChecklistID = @ID AND CompletedDate IS NULL

		EXEC dbo.Audit_Set @CompletedBy, @recordIds, 'ActiveItem', 3

		UPDATE 
			QCheck_ActiveItems
		SET 
			Completedby = @CompletedBy, 
			CompletedDate = getdate(),
			[Text] = CASE WHEN @IsNA = 1 THEN 'N/A' ELSE '' END
		WHERE 
			ActiveChecklistID = @ID
			AND CompletedDate IS NULL
		
		SELECT 
			ActiveChecklistID = @ID, 
			ChecklistItemID = i.ID, 
			[Text] = CASE WHEN @IsNA = 1 THEN 'N/A' ELSE '' END, 
			CompletedDate = GETDATE(), 
			CompletedBy = @CompletedBy
		INTO #tmp
		FROM 
			QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
				ON ac.InstanceID = ci.ID
			INNER JOIN QCheck_Checklists c
				ON ci.ChecklistID = c.ID
			INNER JOIN QCheck_Items i
				ON i.ChecklistId = c.ID
				AND i.ItemTypeID = 1
				AND i.IsDeleted = 0
			LEFT OUTER JOIN QCheck_ActiveItems ai
				ON ai.ActiveChecklistID = @ID
				AND ai.ChecklistItemID = i.ID
		WHERE 
			ac.ID = @ID
			AND ai.ID IS NULL

		INSERT INTO QCheck_ActiveItems
			SELECT * FROM #tmp

		IF @@ROWCOUNT > 0 BEGIN
			DELETE @recordIds
			INSERT INTO @recordIds
				SELECT DISTINCT ID
				FROM dbo.QCheck_ActiveItems a
				INNER JOIN #tmp b ON b.ActiveChecklistID = a.ActiveChecklistID 
					AND b.ChecklistItemID = a.ChecklistItemID

			EXEC dbo.Audit_Set @CompletedBy, @recordIds, 'ActiveItem', 1
		END
	END
	-- if it is zero, then update the active checklist
	If @numLeft <= 0 OR (@numChecks = 1 and @numLeft = 1) OR (@ControlsChecklist = 1 AND @AssignedToChecklist = 0) OR (@IsNA = 1)
	BEGIN
		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ID 
			FROM QCheck_ActiveChecklists
			WHERE [ID] = @ID AND CompletedDate IS NULL

		EXEC dbo.Audit_Set @CompletedBy, @recordIds, 'ActiveChecklist', 3

		UPDATE QCheck_ActiveChecklists
		SET 
			CompletedBy = @CompletedBy,
			CompletedDate = getDate(),
			IsNA = @IsNA,
			NAReason = @NAReason
		WHERE 
			[ID] = @ID
			AND CompletedDate is null

		SET @isComplete = 1

		Declare @Priority int=0
		select @Priority=[Priority] from PriorityList where ActiveChecklistID= @ID and UserID=@CompletedBy

		if @AlreadyComplete = 0
		BEGIN
			EXEC QCheck_ActiveInstanceAlert @ID, 'Complete'

			IF @ID in (select ac.id 
					from qcheck_activechecklists ac
						inner join qcheck_checklistinstances ci
							on ci.id = ac.InstanceID
						inner join QCheck_CompletionTriggers ct
							on ct.checklistid = ci.ChecklistID)
			BEGIN
			 --process any triggered sp that need to be run
 DECLARE @sp varchar(255)
 DECLARE CompletionTriggers_CURS CURSOR FOR 
 select sp 
					 from qcheck_activechecklists ac
						inner join qcheck_checklistinstances ci
							on ci.id = ac.InstanceID
						inner join QCheck_CompletionTriggers ct
							on ct.checklistid = ci.ChecklistID
 where ac.ID = @ID
 Open CompletionTriggers_CURS
 FETCH NEXT FROM CompletionTriggers_CURS INTO @sp
 WHILE @@FETCH_STATUS = 0 BEGIN

					if @sp = 'util_CT_GuardCameraCheck'
					begin
						exec [util_CT_GuardCameraCheck] @ID
					end

 FETCH NEXT FROM CompletionTriggers_CURS INTO @sp
 END
 CLOSE CompletionTriggers_CURS
 DEALLOCATE CompletionTriggers_CURS
			END
		END

		EXEC QCheck_ActivateFutureInstancesAfterCompleted @ID, @UpcomingDueTimeID OUTPUT, @NewActiveChecklistID OUTPUT

		if Exists(select 1 from PriorityList where ActiveChecklistID= @ID and UserID=@CompletedBy)--check if this taks is in PriorityList
		 Begin
		 if(select IsNull(s.freqType,0) from QCheck_ChecklistInstances ci
		 inner JOIN QCheck_Schedule s 
			ON ci.ScheduleID = s.ID 
	 where ci.ID = (select InstanceID from QCheck_ActiveChecklists where ID=@ID))>1 --check if it's recurring
		Begin
		if (@NewActiveChecklistID is not NULL)
		--Stored proc for adding task to priority
 exec PriorityList_AddTask @UserID=@CompletedBy,@ActiveChecklistID=@NewActiveChecklistID,@Priority=@Priority
		End

		 End

	END	
	--default is @isComplete = 0

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_CreateActiveItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROC [dbo].[QCheck_CreateActiveItem]
	@ActiveChecklistID INT,
	@ChecklistItemID Int,
	@IsCompleted bit = 0,
	@CompletedBy int = null,
	@UserText varchar(1000),
	@CompletedByName varchar(50) = null output,
	@CompletedOn datetime = null output
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @numChecks As Int
			,@numDone As Int
			,@numLeft As Int
			,@existID As Int
			,@prevText As VARCHAR(1000)
			,@prevIsCompleted bit 
			,@recordIds AS RecordId
	
	DECLARE @NewID INT, @CommentsInitials VARCHAR(2), @FullName VARCHAR(50), @tabin INT
	DECLARE @StatusComment varchar(1500) = 'Comment added for Step '
	DECLARE @StepNumber int
	DECLARE @CommentID int

	DECLARE @Log Table(
	Seq int identity(1,1),
	Msg varchar(1000)
	)

	DECLARE @RowNums TABLE(
	RowNum int,
	ChecklistItemID int
	)

	-- Update if it exists, insert if not
	SELECT @existID = [ID]
			,@prevText = IsNull([Text],'')
			,@prevIsCompleted = CASE WHEN [CompletedDate] IS NULL THEN 0 ELSE 1 END
	FROM QCheck_ActiveItems
	WHERE ActiveChecklistID = @ActiveChecklistID
	AND ChecklistItemID = @ChecklistItemID
	
	INSERT INTO @RowNums
	SELECT ROW_NUMBER() OVER(ORDER BY I.SequenceNum ASC) as RowNum, 
		I.ID ChecklistItemID
	FROM QCheck_Items I2
	JOIN QCheck_Items I
		ON I.ChecklistID = I2.ChecklistID
		AND I.ItemTypeID = 1
		AND I.IsDeleted = 0
	WHERE I2.ID = @ChecklistItemID

	--select * from @RowNums

	SELECT @StepNumber = RowNum
	FROM @RowNums
	WHERE ChecklistItemID = @ChecklistItemID

	--SELECT @existId existId, 
	--	@IsCompleted IsCompleted, @prevIsCompleted prevIsCompleted, 
	--	@UserText UserText, @prevText prevText, @StepNumber StepNumber

	IF @existID is not null 
	BEGIN
		INSERT INTO @Log VALUES ('Exists')

		IF NOT (@IsCompleted = ISNULL(@prevIsCompleted,0) AND ISNULL(@UserText, '') = ISNULL(@prevText, ''))
		BEGIN
			INSERT INTO @Log VALUES ('Completed or Comment Changed')

			INSERT INTO @recordIds
				SELECT @existID

			EXEC dbo.Audit_Set @CompletedBy, @recordIds, 'ActiveItem', 3

			-- If it was completed, then mark completed fields
			If @IsCompleted = 1 BEGIN
				INSERT INTO @Log VALUES ('Is Completed')

				SELECT @prevText = IsNull([Text],'')
				FROM QCheck_ActiveItems
				WHERE [ID] = @existID

				UPDATE QCheck_ActiveItems
				SET [Text] =@UserText, 
				[CompletedBy] = @CompletedBy
				WHERE [ID] = @existID
				AND (CompletedBy IS NULL OR [CompletedBy] = @CompletedBy)
			
				UPDATE QCheck_ActiveItems
				SET [CompletedDate] = getdate()
				WHERE (CompletedDate Is Null OR IsNull(@UserText,'') <> @prevText)
				AND CompletedBy = @CompletedBy
				AND [ID] = @existID

				IF ISNULL(@UserText, '') <> ISNULL(@prevText,'') 
					AND ISNULL(@UserText, '') != 'N/A' AND ISNULL(@UserText, '') != ''
				BEGIN
					INSERT INTO @Log VALUES ('Status Comment Changed')
					SET @StatusComment = @StatusComment + CAST(@StepNumber as VARCHAR(5)) + ': ' + @UserText
					INSERT INTO @Log VALUES (@StatusComment)					
					
					EXEC QStatus_CreateNewComment
						@ActiveChecklistID, @CompletedBy, @StatusComment, 
						@NewID OUTPUT, @CommentsInitials OUTPUT, @FullName OUTPUT
				END

			END ELSE BEGIN
				INSERT INTO @Log VALUES ('Not Completed')
					
				SELECT @prevText = IsNull([Text],'')
				FROM QCheck_ActiveItems
				WHERE [ID] = @existID

				UPDATE QCheck_ActiveItems
				SET [Text] = @UserText,
				[CompletedBy] = null,
				[CompletedDate] = null
				WHERE [ID] = @existID
				AND (CompletedBy IS NULL OR [CompletedBy] = @CompletedBy)

				IF ISNULL(@UserText, '') <> ISNULL(@prevText,'') 
					AND ISNULL(@UserText, '') != 'N/A' AND ISNULL(@UserText, '') != ''
				BEGIN
					INSERT INTO @Log VALUES ('Status Comment Changed')					
					SET @StatusComment = @StatusComment + CAST(@StepNumber as VARCHAR(5)) + ': ' + @UserText
					INSERT INTO @Log VALUES (@StatusComment)
					
					EXEC QStatus_CreateNewComment
						@ActiveChecklistID, @CompletedBy, @StatusComment, 
						@NewID OUTPUT, @CommentsInitials OUTPUT, @FullName OUTPUT
				END
			END
		END
	END ELSE BEGIN
		INSERT INTO @Log VALUES ('Not Exists')
					
		IF NOT (@IsCompleted = 0 AND ISNULL(@UserText, '') = '') BEGIN
			INSERT INTO @Log VALUES ('Completed Or Commented')
					
			-- insert since no record exists
			If @IsCompleted = 1 BEGIN
				INSERT INTO @Log VALUES ('Completed')
				INSERT INTO QCheck_ActiveItems
				([ActiveChecklistID],[ChecklistItemID], [Text], [CompletedBy], [CompletedDate])
				SELECT @ActiveChecklistID, @ChecklistItemID, @UserText, @CompletedBy, getdate()
				WHERE NOT EXISTS(
				SELECT ID FROM QCheck_ActiveItems
				WHERE ActiveChecklistID = @ActiveChecklistID
				AND ChecklistItemID = @ChecklistItemID
				)
				SET @existID = SCOPE_IDENTITY()

				IF ISNULL(@UserText, '') <> '' AND ISNULL(@UserText, '') != 'N/A'
				BEGIN
					INSERT INTO @Log VALUES ('Completed And Commented')
					SET @StatusComment = @StatusComment + CAST(@StepNumber as VARCHAR(5)) + ': ' + @UserText
					INSERT INTO @Log VALUES (@StatusComment)
					
					EXEC QStatus_CreateNewComment
						@ActiveChecklistID, @CompletedBy, @StatusComment, 
						@NewID OUTPUT, @CommentsInitials OUTPUT, @FullName OUTPUT
				END
			END ELSE BEGIN
				INSERT INTO @Log VALUES ('Not Completed')

				INSERT INTO QCheck_ActiveItems
				([ActiveChecklistID],[ChecklistItemID], [Text])
				SELECT @ActiveChecklistID, @ChecklistItemID, @UserText
				WHERE NOT EXISTS(
				SELECT ID FROM QCheck_ActiveItems
				WHERE ActiveChecklistID = @ActiveChecklistID
				AND ChecklistItemID = @ChecklistItemID
				)
				SET @existID = SCOPE_IDENTITY()

				IF ISNULL(@UserText, '') <> '' AND ISNULL(@UserText, '') != 'N/A'
				BEGIN
					INSERT INTO @Log VALUES ('Commented')
					SET @StatusComment = @StatusComment + CAST(@StepNumber as VARCHAR(5)) + ': ' + @UserText
					INSERT INTO @Log VALUES (@StatusComment)
					
					EXEC QStatus_CreateNewComment
						@ActiveChecklistID, @CompletedBy, @StatusComment, 
						@NewID OUTPUT, @CommentsInitials OUTPUT, @FullName OUTPUT
				END
			END

			INSERT INTO @recordIds
				SELECT @existID

			EXEC dbo.Audit_Set @CompletedBy, @recordIds, 'ActiveItem', 1
		END
	END

	--SELECT * FROM @Log

	SELECT
		@CompletedByName = isnull(QCheck_Users.[FullName], ''),
		@CompletedOn = [CompletedDate]
	FROM 
		QCheck_ActiveItems
		LEFT JOIN QCheck_Users
			ON QCheck_Users.ID = QCheck_ActiveItems.CompletedBy
	WHERE 
		QCheck_ActiveItems.ID = @existID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_CreateSimple_part1]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_CreateSimple_part1]
	@ID INT OUTPUT,
	@Name varchar(500),
	@Priority int = 1,
	@DueDate datetime,
	@CreatedBy int,
	@TaskType int = null,
	@PrevFreqType int = 0 output,
	@RowsUpdated int = 0 output,
	@NewInstanceID int output,
	@NewActiveID int output,
	@GroupID int,
	@Activate bit = 1,
	@IsReminder bit = 0,
	@ReminderDate datetime = NULL,
	@AddToPriorityList bit=0--added by venkat 04/20/2017
AS
BEGIN
	SET NOCOUNT ON
	
	if @ReminderDate is null set @ReminderDate = @DueDate

	DECLARE @UserID int,
			@FolderID int,
			@FolderName varchar(50),
			@DueTime int,
			@recordIds AS RecordId,
			@PrevSchedule bit = 0,
			@ReportID int = 0

	SELECT @DueTime = duetime FROM QCheck_UserDefaultTimes WHERE UserID = @CreatedBy

	IF @DueTime IS NULL
		SELECT @DueTime = duetime from QCheck_UserDefaultTimes WHERE UserID = -1
	
	SELECT @ReportID = reportID
	FROM QStatus_TaskTypes
	WHERE ID = @TaskType

	INSERT INTO QCheck_Checklists ([Name], Owner) VALUES (@Name, @CreatedBy)
	SELECT @ID = @@IDENTITY	

	INSERT INTO @recordIds VALUES(@ID)
	EXEC dbo.Audit_Set @CreatedBy, @recordIds, 'Checklist', 1

	-- 2011 dalvarado
	-- Changed up the rules a bit. Before, if this task was created from a status
	-- report then all report controllers were controllers of the task. Now, the
	-- rules are the same no matter where a task was created. The task creator is
	-- always the controller. If this is a supervisor controlled task, then the 
	-- task controller will be overridden by whoever was chosen in the interface.

	-- Creator is the controller
	DECLARE @ControllerGroupID int
	SELECT @ControllerGroupID = ID
	FROM QCheck_Groups
	WHERE owner = @CreatedBy
	AND SingleMemberGroup = 1

	INSERT INTO QCheck_ChecklistManagers
	(ChecklistID, ManagerGroupID)
	VALUES (@ID, @ControllerGroupID)

	-- Do the report stuff if this task was created from a status report
	IF @ReportID > 0 BEGIN

		DELETE FROM QStatus_ReportFolders
		WHERE folderid not in (SELECT ID FROM QCheck_Folders)

		DECLARE FOLDERCREATE CURSOR FOR 	
			SELECT DISTINCT 
				u.ID, 
				CASE 
					WHEN len(r.Name) > 41 THEN 'Status - ' + LEFT(r.Name, 38)+'...'
					ELSE 'Status - ' + r.Name
				END
			FROM 
				QStatus_GroupReport gr
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_Groupmembership gm
					ON gm.GroupID = g.ID
				INNER JOIN Qstatus_Report r
					ON gr.ReportID = r.ID
					AND r.ID = @ReportID
				INNER JOIN QCheck_Users u
					ON u.ID = gm.UserID 
					AND u.IsDeleted = 0
				LEFT OUTER JOIN (
					SELECT f.UserID, rf.ReportID
					FROM QCheck_Folders f
					INNER JOIN QStatus_ReportFolders rf
					ON f.ID = rf.FolderID
				) folders
					ON folders.reportID = r.ID
				AND folders.UserID = u.ID
			WHERE 
				folders.UserID is null 
		
		OPEN FOLDERCREATE

		FETCH NEXT FROM FOLDERCREATE INTO @UserID, @FolderName
		WHILE @@FETCH_STATUS = 0 BEGIN
			INSERT INTO QCheck_Folders
			SELECT @UserID, @FolderName, 0
			
			SELECT @FolderID = SCOPE_IDENTITY()

			INSERT INTO QStatus_ReportFolders
			SELECT @ReportID, @FolderID

			FETCH NEXT FROM FOLDERCREATE INTO @UserID, @FolderName
		END
		CLOSE FOLDERCREATE
		DEALLOCATE FOLDERCREATE

		INSERT INTO QCheck_FolderChecklists
			SELECT 
				@ID, rf.FolderID
			FROM 
				QStatus_ReportFolders rf
				INNER JOIN QCheck_Folders f
					ON rf.FolderID = f.ID
				INNER JOIN QCheck_Users u
					ON u.ID = f.UserID
					AND u.IsDeleted = 0
			WHERE 
				rf.ReportID = @ReportID
		
	END	

	EXEC QCheck_AddItem @ID, null, 1, @Name, '', @CreatedBy

	EXEC QCheck_CreateInstance @NewInstanceID output, @ID, '', @CreatedBy

	EXEC QCheck_AddAssignedTo @NewInstanceID, @GroupID, @CreatedBy

	---- KVS 2017-09-26 - Removing these default alerts per GPR/Nelson;
	----	Users who want them can add them manually
	---- Reminder 1 day before due
	--EXEC QCheck_AddAlert
	--		@InstanceID = @NewInstanceID, 
	--		@nagBeforeDays = 1,
	--		@nagTime = 17,
	--		@alertType = 'Reminder'
			
	---- 2/11/2014 dalvarado - Also set a reminder for 1 hour before due
	--EXEC QCheck_AddAlert
	--		@InstanceID = @NewInstanceID, 
	--		@nagBeforeDays = NULL,
	--		@nagTime = -1,
	--		@alertType = 'Reminder'
	

	EXEC QCheck_UpdateSchedule_part1 
			@InstanceID = @NewInstanceID, 
			@firstDueDate = @DueDate,
			@freqType = 1, 
			@dueTime = @DueTime,
			@PrevFreqType = @PrevFreqType output,
			@RowsUpdated = @RowsUpdated output,
			@Activate = @Activate

	IF @DueDate <> ISNULL(@ReminderDate, @DueDate) BEGIN
	
		DECLARE @SoftDueOffsetDays INT
		SELECT @SoftDueOffsetDays = DATEDIFF(DAY, @ReminderDate, @DueDate)
		
		IF @SoftDueOffsetDays > 0 BEGIN
		
			UPDATE QCheck_Schedule
			SET SoftDueOffsetDays = @SoftDueOffsetDays
			WHERE ID = (
				SELECT ScheduleID
				FROM QCheck_ChecklistInstances 
				WHERE ID = @NewInstanceID
			)
			
		END
	
	END

	SELECT @NewActiveID = ID
	FROM QCheck_ActiveChecklists
	WHERE InstanceID = @NewInstanceID

	DELETE @recordIds
	INSERT INTO @recordIds VALUES(@NewActiveID)
	EXEC dbo.Audit_Set @CreatedBy, @recordIds, 'ActiveChecklist', 3

	-- Set the reminder date to whatever was passed in, if it's not past the due time
	UPDATE QCheck_ActiveChecklists
	SET ReminderDate = @ReminderDate
	WHERE 
		[ID] = @NewActiveID
		AND @ReminderDate <= DueTime

	IF @TaskType IS NOT NULL BEGIN
		DECLARE @NewTaskTypeID int
		EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT
	END 
	

	if (@AddToPriorityList=1)
	Begin
	 
		IF OBJECT_ID('tempdb.dbo.#UserList', 'U') IS NOT NULL
		DROP TABLE #UserList;

		Create table #UserList
		(
			seq INT IDENTITY(1,1),
			UserID int	
		)
	
		Insert into #UserList
		select UserID From QCheck_GroupMembership where GroupID=@GroupID

		Declare @userListCount int
		
		SELECT @userListCount = Count(*) FROM #UserList
		
		Declare @counter int=1
		Declare @AssignedToUserID int
		
		WHILE @counter <= @userListCount
		BEGIN
			set @AssignedToUserID=(select UserID from #UserList where seq=@counter)
			exec PriorityList_AddTask @UserID=@AssignedToUserID,@ActiveChecklistID=@NewActiveID
	 		
			SET @counter=@counter+1
		End		
	End
	--If the task isn't going on every assignee's priority list, if Brandon is an assignee, put it on his.
	ELSE IF EXISTS (
			SELECT 'Y' from QCheck_Users u 
				JOIN QCheck_GroupMembership gm ON gm.UserID = u.ID AND gm.GroupID = @GroupID
			WHERE u.ID = 10
		) AND @NewActiveID IS NOT NULL
	BEGIN
		exec PriorityList_AddTask 10, @NewActiveID
	END
	
	-- rebuild cache
 EXEC QCheck_ChecklistControllersList_Refresh @ID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_DelItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_DelItem]
	@ItemID INT,
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds VALUES(@ItemID)
	EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 3

	Update
		QCheck_Items
	Set 
		IsDeleted = 1
	WHERE
		[ID] = @ItemID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetActiveChecklistTaskTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_GetActiveChecklistTaskTypes]
	@taskId int,
	@userId int = 0
AS
BEGIN
	SET NOCOUNT ON

	SELECT 
		tt.ID, r.Name as Report, tt.Description as TaskType, r.ID as ReportID
	INTO #result
	FROM
		QStatus_ActiveChecklistTaskType actt
		INNER JOIN QStatus_TaskTypes tt
			ON actt.TaskType = tt.ID
		INNER JOIN QStatus_Report r
			ON r.ID = tt.ReportID
		INNER JOIN QCheck_ActiveChecklists ac
			ON actt.activechecklistID = ac.ID
	WHERE ac.ID = @taskId
	
	UNION

	SELECT 
		st.ID, r.Name as Report, tt.Description as TaskType, r.ID as ReportID
	FROM
		QStatus_SpecialTasks st
		INNER JOIN
			QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
		INNER JOIN QStatus_Report r
			ON r.ID = tt.ReportID
	WHERE st.ID = @taskId
	
	IF @userId <> 0 BEGIN
		DECLARE @recordIds AS RecordId
		INSERT INTO @recordIds
			SELECT DISTINCT ID FROM #result

		EXEC dbo.Audit_Set @userId, @recordIds, 'TaskType', 2

		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ReportID FROM #result

		EXEC dbo.Audit_Set @userId, @recordIds, 'Report', 2
	END

	SELECT * FROM #result
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetCalendarChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_GetCalendarChecklists]
	@UserID int,
	@startDate datetime,
	@endDate datetime,
	@ID varchar(8000),
	@ShowStatusCalendar bit = 0,
	@ShowAlertEmails bit = 1
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @IDs table(
		ID int
	)

	INSERT INTO @IDs SELECT CAST(Data as int) FROM dbo.Util_Split(@ID,',')
	
	DECLARE @tblAssigned table(
		ID int
	)

	DECLARE @tblAssignee table(
		ID int
	)

	DECLARE @tblManaged table(
		ID int
	)
	
	DECLARE @tblStatusControlled table(
		ID int
	)	

	DECLARE @tblStatusSupervised table(
		ID int
	)

	DECLARE @tblScheduledAlerts table(
		ID int,
		AlertID int
	)

	DECLARE @tblPendingChanges table(
		ActiveChecklistID INT,
		ChangeID INT,
		NewDeadline DATETIME
	)
	
	DECLARE @tblResults table(
		objID int, 
		ChecklistID int, 
		ChecklistName varchar(500), 
		DueTime datetime, 
		ReminderDate datetime,
		type int,
		active int,
		assignedto int,
		ismanager int,
		isRecurring bit,
		PendingChange bit,
		ChangeID int,
		NewDeadline datetime,
		IsNA bit,
		isAlert bit,
		AlertID int,
		isEmailScheduled bit,
		MultiStep bit,
		IsPriority bit,
		OriginalDeadline datetime
	)
	
	IF @UserID <> 5000 BEGIN

		INSERT INTO @tblPendingChanges (
			ActiveChecklistID,
			ChangeID,
			NewDeadline
		)
			SELECT 
				AAC.ActiveChecklistID,
				CR.[ID],
				AAC.DueTime
			FROM 
				QCheck_Approval_ChangeRequests CR
				INNER JOIN QCheck_Approval_ActiveChecklists AAC
					ON AAC.ChangeRequestID = CR.[ID]
				-- 3/25/2013 dalvarado - Created this view and joined it here to eliminate duplicate entries
				-- on the calendar view when you have multiple outstanding change requests for a task.
				INNER JOIN QCheck_MostRecentDeadlineRequests MRDR
					ON AAC.ActiveChecklistID = MRDR.ActiveChecklistID
					AND CR.ID = MRDR.ChangeRequestID
			WHERE 
				CR.IsActive = 1
				AND CR.Approved = 0
				AND CR.Rejected = 0
				AND CR.ReadyForSupervisor = 1
	
		INSERT INTO @tblAssigned
		SELECT a.InstanceID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				on g.ID = a.GroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID
		WHERE a.IsDeleted = 0

		INSERT INTO @tblAssignee
		SELECT a.InstanceID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				on g.ID = a.GroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID IN (SELECT ID FROM @IDs)
			--Failsafe against query string hacking; @UserID and @ID must have a supervisor/report relationship
			INNER JOIN (
				SELECT u.ID
				FROM QCheck_Users U
					INNER JOIN QStatus_Report R
						ON U.FullName = R.[Name]	
						AND r.IsDeleted = 0
					INNER JOIN QStatus_Supervisors S
						ON R.[ID] = S.ReportID			
						AND s.AsOf < GETDATE()
						AND (s.DirectSupervisor = 1 OR s.InterestedParty = 1)
					INNER JOIN QCheck_Groups G
						ON S.SupervisorGroupID = G.[ID]			
					INNER JOIN QCheck_Users SU
						ON G.Owner = SU.[ID]
						AND su.IsDeleted = 0
						AND SU.[ID] = @UserID
					WHERE
						U.IsDeleted = 0
						AND U.ID IN (SELECT ID FROM @IDs)
			) X ON x.ID = gm.UserID
		WHERE a.IsDeleted = 0		
	
		INSERT INTO @tblManaged
		SELECT ci.ID
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN QCheck_Checklists c
				on c.ID = ci.ChecklistID
				and c.IsDeleted = 0
				and ci.IsDeleted = 0
			INNER JOIN QCheck_ChecklistManagers cm
				on cm.ChecklistID = c.ID
				and cm.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				on g.ID = cm.ManagerGroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID

		INSERT INTO @tblStatusControlled
		SELECT r.ID 
		FROM 
			QStatus_Report r
			INNER JOIN QStatus_GroupReport gr
				ON gr.ReportID = r.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = gr.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID			
		WHERE
			r.IsDeleted = 0
			AND (
				r.ID IN (SELECT ID FROM @IDs)
				or -1 IN (SELECT ID FROM @IDs)		
			)
	
		INSERT INTO @tblStatusSupervised
		SELECT r.ID 
		FROM 
			QStatus_Report r
			INNER JOIN QStatus_Supervisors sup
				ON sup.ReportID = r.ID
				AND sup.DirectSupervisor = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sup.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
		WHERE
			r.IsDeleted = 0
			AND EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, r.ID))			

		--KVS 2017-10-30 - Adding alerts as a viewable calendar item
		INSERT INTO @tblScheduledAlerts
		SELECT a.InstanceID,
			al.ID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Alerts al
				ON al.InstanceID = a.InstanceID
				AND al.IsDeleted = 0				
			INNER JOIN QCheck_Groups g
				ON (al.AlerteeGroupID IS NULL AND g.ID = a.GroupID)
				OR al.AlerteeGroupID = g.ID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID
		WHERE a.IsDeleted = 0 
		
		-- ****************************************
		-- All or assigned to me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 
		BEGIN

			-- Current tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime,
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN a.ID IS NULL OR @ShowAlertEmails = 0 THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID	
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 

			-- Future tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				NULL AS ReminderDate,
				3 AS type, --meaning future
				1 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 As IsNA,
				0 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN a.ID IS NULL OR @ShowAlertEmails = 0 THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime BETWEEN @startDate and @endDate
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 
	
			-- Past tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime,
				ac.ReminderDate,
				2 AS type, --meaning past
				0 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				a.ID as AlertID,
				CASE WHEN a.ID IS NULL OR @ShowAlertEmails = 0 THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID 
					AND CAST(GETDATE() as date) > @startDate
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 
		END

		-- ****************************************
		-- Managed by me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
			OR (EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) and @ShowStatusCalendar = 0)
		BEGIN

			-- IF @ID = -2, *only* show tasks controlled by the user (ignore supervisor or group membership)
			-- IF ID > 0, show any task where the assignee's status report is visible to the user
			
			-- Current tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QCheck_ActiveAssignments aa
					on aa.ActiveChecklistID = ac.ID
				INNER JOIN QCheck_Assignments a
					on a.ID = aa.AssignmentsID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssignee ta2
					on ta2.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm 
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID	
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))
	
			-- Future tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				NULL AS ReminderDate,
				3 AS type, --meaning current
				1 as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime BETWEEN @startDate and @endDate
				INNER JOIN QCheck_Assignments a
					on a.InstanceID = ci.ID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssignee ta2
					on ta2.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm 
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))	

			-- Past tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				2 AS type, --meaning past
				0 as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID 
					AND CAST(GETDATE() as date) > @startDate			
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QCheck_Assignments a
					on a.InstanceID = ci.ID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssigned ta2
					on ta2.ID = ci.ID
				left outer JOIN @tblManaged tm 
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))	

		END
	
		-- ****************************************
		-- Status
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID = -1) OR @ShowStatusCalendar = 1
		BEGIN
			
			-- Current tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QStatus_ActiveChecklistTaskType actt
					on actt.ActiveChecklistID = ac.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = actt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE 
				NOT (
					tc.ID is null 
					and tss.ID is null
				)
	
			-- Future tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				NULL AS ReminderDate,
				3 AS type, --meaning future
				1 as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.DueTime BETWEEN @startDate and @endDate
					)
				INNER JOIN QStatus_InstanceTaskType itt
					on itt.InstanceID = ci.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = itt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE 
				NOT (
					tss.ID is null 
					and tc.ID is null
				)
	
			-- Past tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				2 AS type, --meaning past
				0 as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID
					AND CAST(GETDATE() as date) > @startDate		
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QStatus_InstanceTaskType itt
					on itt.InstanceID = ci.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = itt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		 
			WHERE 
				NOT (
					tss.ID is null 
					and tc.ID is null
				)

		END

		-- ****************************************
		-- Overdue tasks
		
		-- All or assigned to me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) BEGIN

			-- Overdue tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime,
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN a.ID IS NULL THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime < @startDate
					AND ac.DueTime < GETDATE() -- Only overdue stuff, not active tasks in future weeks
					AND ac.CompletedDate IS NULL
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))
				
		END
		
		-- Managed by me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
			OR (EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) and @ShowStatusCalendar = 0)		
		BEGIN
			-- Overdue tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				NULL as AlertID,
				0 as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime < @startDate
					AND ac.DueTime < GETDATE() -- Only overdue stuff, not active tasks in future weeks
					AND ac.CompletedDate IS NULL
				INNER JOIN QCheck_ActiveAssignments aa
					on aa.ActiveChecklistID = ac.ID
				INNER JOIN QCheck_Assignments a
					on a.ID = aa.AssignmentsID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssignee ta2
					on ta2.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))		
		END
		
		-- Status
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID = -1) OR @ShowStatusCalendar = 1
		BEGIN
			
			-- Overdue tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				NULL as AlertID,
				0 as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime < @startDate
					AND ac.DueTime < GETDATE() -- Only overdue stuff, not active tasks in future weeks
					AND ac.CompletedDate IS NULL
				INNER JOIN QStatus_ActiveChecklistTaskType actt
					on actt.ActiveChecklistID = ac.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = actt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID	
			WHERE 
				NOT (
					tc.ID is null 
					and tss.ID is null
				)
				
		END

		-- ****************************************
		-- Email reminders - Assigned ONLY
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) and @ShowAlertEmails = 1 BEGIN
			-- Current tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name + (CASE WHEN a.AlertText IS NOT NULL AND a.AlertText <> '' THEN ' - ' + a.AlertText
							WHEN a.AlertType IN ('Reminder') THEN ' - Reminder'
							WHEN a.AlertType IN ('Hours') THEN ' - Overdue Reminder' 
							ELSE ' - Alert' END) as ChecklistName, 
				CASE
					WHEN a.AlertType = 'Hours' OR a.AlertTime < 0 
						THEN DATEADD(minute, IsNull(a.AlertTime * 60, 0), ac.DueTime)
					ELSE DATEADD(minute, IsNull(a.AlertTime * 60, 0),
							DATEADD(day, IsNull(a.DaysBefore, 0) * -1, 
								DateAdd(day, DATEDIFF(day, 0, ac.DueTime),0)))
				END as DueTime,
				NULL as ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				1 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN ae.ID IS NULL THEN 1 ELSE 0 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				INNER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				INNER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType IN ('Reminder', 'Custom', 'Hours')
				INNER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID
				LEFT OUTER JOIN QCheck_AlertExceptions ae
					ON ae.ActiveAlertID = aa.ID
					AND ae.UserID = @UserID
					AND ae.IsActive = 1		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID							
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))

			-- Future tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name + IsNull(' - ' + a.AlertText, (CASE 
							WHEN a.AlertType IN ('Reminder') THEN ' - Reminder'
							WHEN a.AlertType IN ('Hours') THEN ' - Overdue Reminder' 
							ELSE ' - Alert' END)) as ChecklistName, 
				CASE 
					WHEN a.AlertType = 'Hours' OR a.AlertTime < 0 
						THEN DATEADD(hour, IsNull(a.AlertTime, 0), ac.DueTime)
					ELSE DATEADD(hour, IsNull(a.AlertTime, 0),
							DATEADD(day, IsNull(a.DaysBefore, 0) * -1, 
								DateAdd(day, DATEDIFF(day, 0, ac.DueTime),0)))
				END as DueTime,
				NULL AS ReminderDate,
				3 AS type, --meaning future
				1 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 As IsNA,
				1 as IsAlert,
				a.ID as AlertID,
				CASE WHEN ae.ID IS NULL THEN 1 ELSE 0 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime BETWEEN @startDate and @endDate
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				INNER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				INNER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType IN ('Reminder', 'Custom', 'Hours')
				INNER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID
				LEFT OUTER JOIN QCheck_AlertExceptions ae
					ON ae.ActiveAlertID = aa.ID
					AND ae.UserID = @UserID
					AND ae.IsActive = 1		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID					
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))
	
			-- Past tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name + IsNull(' - ' + a.AlertText, (CASE 
							WHEN a.AlertType IN ('Reminder') THEN ' - Reminder'
							WHEN a.AlertType IN ('Hours') THEN ' - Overdue Reminder' 
							ELSE ' - Alert' END)) as ChecklistName, 
				CASE 
					WHEN a.AlertType = 'Hours' OR a.AlertTime < 0 
						THEN DATEADD(hour, IsNull(a.AlertTime, 0), ac.DueTime)
					ELSE DATEADD(hour, IsNull(a.AlertTime, 0),
							DATEADD(day, IsNull(a.DaysBefore, 0) * -1, 
								DateAdd(day, DATEDIFF(day, 0, ac.DueTime),0)))
				END as DueTime,
				NULL as ReminderDate,
				2 AS type, --meaning past
				0 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				1 as IsAlert,
				a.ID as AlertID,
				CASE WHEN ae.ID IS NULL THEN 1 ELSE 0 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID 
					AND CAST(GETDATE() as date) > @startDate
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				INNER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				INNER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType IN ('Reminder', 'Custom', 'Hours')
				INNER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID
				LEFT OUTER JOIN QCheck_AlertExceptions ae
					ON ae.ActiveAlertID = aa.ID
					AND ae.UserID = @UserID
					AND ae.IsActive = 1		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID				
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))
		END
	END
	
	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM @tblResults WHERE ChecklistId IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT objID FROM @tblResults WHERE objID IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveChecklist', 2

	-- Get the output
	SELECT DISTINCT * 
	FROM 
		@tblResults
	ORDER BY 
		DueTime,
		objID, 
		ChecklistName
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetChecklistItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_GetChecklistItems]
	@ChecklistID INT,
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON
	
	--retrieve from items and itemtypes by checklistID. Ensure isDeleted = 0 for deleted items
	SELECT a.[ID],[SequenceNum], b.[ID] as [TypeID], [Name] as [Type], [Text],[URL]
	INTO #result
	FROM
		QCheck_Items a, QCheck_ItemTypes b
	WHERE
		a.ItemTypeID = b.ID
	AND
		a.ChecklistID = @ChecklistID
	AND 	
		a.IsDeleted = 0

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds 
		SELECT DISTINCT ID FROM #result
	EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 2

	SELECT * FROM #result ORDER BY SequenceNum
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetMyChecklistsByFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_GetMyChecklistsByFolder](
	@UserID int,
	@memberGroupID int = 0,
	@managerGroupID int = 0,
	@isAdmin bit = 0,
	@search varchar(200) = ''
) AS

BEGIN

	SET NOCOUNT ON
	DECLARE @recordIds AS RecordId
	DECLARE @tblResults TABLE(
		ID int
	)

	DECLARE @tblAssigned TABLE(
		ID int
	)

	DECLARE @tblManaged TABLE(
		ID int
	)

	DECLARE @tblActive TABLE(
		ID int
	)

	-- Get all the ChecklistIDs the user is assigned to
	INSERT INTO @tblAssigned
		SELECT DISTINCT 
			c.ID
		FROM	
			QCheck_Checklists c (nolock)
			INNER JOIN QCheck_ChecklistInstances ci (nolock)
				ON c.[ID] = ci.ChecklistID
				AND c.IsDeleted = 0
				AND ci.IsDeleted = 0
			INNER JOIN QCheck_Assignments a (nolock)
				ON ci.[ID] = a.InstanceID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups g (nolock)
				ON a.GroupID = g.[ID]
			INNER JOIN QCheck_GroupMembership gm (nolock)
				ON g.[ID] = gm.GroupID
				AND (
					gm.UserID = @UserID 
					OR @isAdmin = 1
				)

	-- Get all the ChecklistIDs the user controls
	INSERT INTO @tblManaged
		SELECT DISTINCT 
			c.[ID]
		FROM	
			QCheck_Checklists c (nolock)
			INNER JOIN QCheck_ChecklistManagers cm (nolock)
				ON cm.ChecklistID = c.[ID]
				AND cm.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Groups g (nolock)
				ON g.[ID] = cm.ManagerGroupID
			INNER JOIN QCheck_GroupMembership gm (nolock)
				ON gm.GroupID = g.[ID]
				AND (
					gm.UserID = @UserID 
					OR @isAdmin = 1
				)
				

	-- Get all active checklists
	INSERT INTO @tblActive
		SELECT DISTINCT 
			c.id
		FROM 
			qcheck_checklists c (nolock)
		INNER JOIN qcheck_checklistinstances ci (nolock)
			ON ci.checklistid = c.id
		INNER JOIN qcheck_activechecklists ac (nolock)
			ON ac.instanceid = ci.id

	-- If no group filter was supplied, the result set is everything assigned/managed through any group
	IF @memberGroupID = 0 AND @managergroupID = 0 BEGIN

		INSERT INTO @tblResults
			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN @tblAssigned tm
					ON tm.ID = c.ID

			UNION

			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN @tblManaged tm
					ON tm.ID = c.ID

	-- If a group filter was supplied, the result set is everything assigned to the user through that group
	END ELSE BEGIN

		INSERT INTO @tblResults
			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN (select ID from @tblManaged union all select ID from @tblAssigned) tm
					ON tm.ID = c.ID
				LEFT OUTER JOIN QCheck_ChecklistInstances ci (nolock)
					ON ci.ChecklistID = c.ID
					AND ci.IsDeleted = 0
				LEFT OUTER JOIN QCheck_Assignments a (nolock)
					ON a.InstanceID = ci.ID
					AND a.IsDeleted = 0
					AND a.GroupID = @memberGroupID
			WHERE
				(
					@memberGroupID = 0 OR
					a.ID IS NOT NULL
				)
				AND 
				(
					@managerGroupID = 0 OR
					c.id in (
					 select cm.checklistid from 
						QCheck_ChecklistManagers cm (nolock)
					 inner JOIN QCheck_Groups managerg (nolock)
								 ON managerg.ID = cm.ManagerGroupID
					 inner join QCheck_GroupMembership managergm (nolock)
								 ON managergm.GroupID = managerg.ID
								 AND managergm.GroupID = @managergroupID
					 where cm.IsDeleted = 0) 
				)

	END
		
	-- If no search string was supplied, return the full result set with folders
	IF LEN(LTRIM(RTRIM(@search))) = 0 BEGIN

		SELECT DISTINCT 
			c.Name as NodeName, 
			c.ID,
			c.ID as FolderID,
			isNull(fc.FolderID, 0) as ParentID,
			1 as Type,
			case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
			c.Template
		INTO #result
		FROM 
			@tblResults tr
			INNER JOIN qcheck_checklists c (nolock)
				ON tr.ID = c.ID
			LEFT OUTER JOIN @tblActive ac
				ON ac.ID = c.ID
			LEFT OUTER JOIN QCheck_FolderChecklists fc (nolock)
				ON fc.ChecklistID = c.ID
				AND fc.FolderID IN (
					SELECT ID 
					FROM QCheck_Folders 
					WHERE UserID = @UserID
				)
		
		UNION ALL
		
		SELECT 
			'All Tasks' as NodeName, 
			0 As ID,
			0 as FolderID,
			null as ParentID,
			2 as Type,
			0 as Active,
			0 as Template
	
		UNION ALL
			
		SELECT 
			FolderName as NodeName,
			ID,
			ID as FolderID,
			ParentFolder as ParentID,
			3 as Type,
			0 as Active,
			0 as Template
		FROM
			QCheck_Folders (nolock)
		WHERE
			UserID = @UserID		

	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM #result WHERE ID > 0
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	SELECT * FROM #result ORDER BY [Type] DESC, NodeName
	-- If a search string was supplied, filter the result set by that search string
	END ELSE BEGIN

		SELECT DISTINCT 
			c.Name as NodeName, 
			c.ID,
			c.ID as FolderID,
			isNull(fc.FolderID, 0) as ParentID,
			1 as Type,
			case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
			c.Template
		INTO #result2
		FROM 
			@tblResults tr
			INNER JOIN qcheck_checklists c (nolock)
				ON tr.ID = c.ID
			LEFT OUTER JOIN	QCheck_Items i (nolock)
				ON i.ChecklistID = c.ID
			LEFT OUTER JOIN @tblActive ac
				ON ac.ID = c.ID
			LEFT OUTER JOIN QCheck_FolderChecklists fc (nolock)
				ON fc.ChecklistID = c.ID
				AND fc.FolderID IN (
					SELECT ID 
					FROM QCheck_Folders 
					WHERE UserID = @UserID
				)
		WHERE
			c.Name LIKE ('%'+@search+'%') 
			OR i.Text like ('%'+@search+'%')
		
		UNION ALL
		
		SELECT 
			'All Tasks' as NodeName, 
			0 As ID,
			0 as FolderID,
			null as ParentID,
			2 as Type,
			0 as Active,
			0 as Template
	
		UNION ALL
			
		SELECT 
			FolderName as NodeName,
			ID,
			ID as FolderID,
			ParentFolder as ParentID,
			3 as Type,
			0 as Active,
			0 as Template
		FROM
			QCheck_Folders (nolock)
		WHERE
			UserID = @UserID		

		INSERT INTO @recordIds
			SELECT DISTINCT ID FROM #result2 WHERE ID > 0
		EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

		SELECT * FROM #result2 ORDER BY [Type] DESC, NodeName
	END
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_GetName]
	@ChecklistID int,
	@UserId int
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds VALUES(@ChecklistID)

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	SELECT [Name] FROM QCheck_Checklists
	WHERE ID = @ChecklistID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetOverdueTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_GetOverdueTasks]
@userId int
AS
BEGIN
	SET NOCOUNT ON

	SELECT 
		a.DueTime,
		c.[Name] AS ChecklistName,
		MAX(c.ID) AS ChecklistId
	INTO #result
	FROM
		QCheck_ActiveChecklists a 
		INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
		INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID 
		INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
		INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
		INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
		INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
		INNER JOIN QCheck_GroupMembership gm on gm. UserID = @userId
		INNER JOIN QCheck_Groups g on g.ID = gm.GroupID
		INNER JOIN QCheck_Assignments f on f.GroupID = gm.GroupID And f.IsDeleted = 0 and f.InstanceID = b.ID
		LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID
		LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
	WHERE
		a.CompletedDate is null
		AND a.dueTime < getdate()
	GROUP BY 
		c.[Name], a.dueTime

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId
		FROM #result
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	-- return result
	SELECT DueTime, ChecklistName
	FROM #result
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetPotentialNATasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_GetPotentialNATasks]
	@controller int,
	@start datetime,
	@end datetime,
	@assigned int
AS
BEGIN
	SET NOCOUNT ON

	select ac.id, c.name, ac.duetime, dbo.QCheck_AssigneesList(ci.id) as assignees, c.ID AS ChecklistId
	INTO #result
	from
	qcheck_checklists c
	inner join qcheck_checklistmanagers cm
		on cm.isdeleted = 0
		and cm.checklistid = c.id
	inner join qcheck_groupmembership gm
		on gm.groupid = cm.managergroupid
		and gm.userid = @controller
	inner join qcheck_checklistinstances ci
		on ci.checklistid = c.id
		and ci.id not in (
			select ci.id from qcheck_assignments a
			inner join qcheck_checklistinstances ci
				on a.instanceid = ci.id
			inner join qcheck_groupmembership gm
				on gm.groupid = a.groupid
				and gm.userid = @controller
		)
	inner join qcheck_activechecklists ac
		on ac.instanceid = ci.id
		and ac.duetime between @start and dateadd(day, 1, @end)
		and ac.completeddate is null
	where (
		@assigned = -1
		or 
		ci.id in (
			select ci.id from qcheck_assignments a
			inner join qcheck_checklistinstances ci
				on a.instanceid = ci.id
				and a.groupid = @assigned
		)
	)

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM #result WHERE ChecklistId IS NOT NULL

	EXEC dbo.Audit_Set @controller, @recordIds, 'Checklist', 2 

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM #result WHERE ID IS NOT NULL

	EXEC dbo.Audit_Set @controller, @recordIds, 'ActiveChecklist', 2

	SELECT * FROM #result ORDER BY [Name]
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetSingleChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck_GetSingleChecklist](
	@loginID int,
	@type int, 
	@id int
)
 AS

BEGIN

	SET NOCOUNT ON

	DECLARE @tblAssigned table(
			InstanceID int,
			AssignmentID int,
			AssignedTo int
		)
	INSERT INTO @tblAssigned
	SELECT a.InstanceID, a.ID, @loginID
	FROM QCheck_Assignments a
	INNER JOIN QCheck_Groups g
		on
			g.ID = a.GroupID
	INNER JOIN QCheck_Groupmembership gm
		on
			gm.GroupID = g.ID
			and gm.UserID = @loginID
	WHERE a.IsDeleted = 0
	
	
	IF @type = 1
	BEGIN
		-- get current checklists
		SELECT Distinct c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, u.FullName As CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0), charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID as UniqueID
			, d.SequenceNum
			, a.DueTime
			, a.ReminderDate
			, a.CompletedDate As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 1 As ChkType
			, e.CompletedBy as CompletedByID
			, ta.AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, CASE WHEN s.freqType = 1 THEN 'One Time' 
				 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
				 WHEN s.freqType = 3 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Weekly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
						END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
				 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' months' END
				 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 				 WHEN s.freqType = 5 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Yearly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
						END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
				ELSE '' END as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, dbo.QStatus_GetChecklistReports(a.ID, @loginID) as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
			, case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee
			, isnull(a.isna, 0) as isna
			, isnull(a.nareason, '') as nareason
			, case when aac.DueTime IS NOT NULL THEN 1 ELSE 0 END PendingChange
			, aac.DueTime NewDeadline
			, e.ID AS ActiveItemId
		INTO #result
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			LEFT JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			LEFT OUTER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta on ta.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
			LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
			LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
			LEFT OUTER JOIN QCheck_MostRecentDeadlineRequests mrdr
					ON a.ID = mrdr.ActiveChecklistID
			LEFT OUTER JOIN QCheck_Approval_ChangeRequests cr
				ON cr.ID = mrdr.ChangeRequestID
			LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aac
					ON aac.ChangeRequestID = CR.[ID]
					AND aac.ActiveChecklistID = mrdr.ActiveChecklistID
			WHERE
			a.ID = @id
		ORDER BY 
			SequenceNum

		DECLARE @recordIds AS RecordId
		INSERT INTO @recordIds
			SELECT DISTINCT ChecklistId
			FROM #result
			WHERE ChecklistId IS NOT NULL
		EXEC dbo.Audit_Set @loginID, @recordIds, 'Checklist', 2

		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ItemID
			FROM #result
			WHERE ItemID IS NOT NULL
		EXEC dbo.Audit_Set @loginID, @recordIds, 'Item', 2

		DELETE @recordIds
		INSERT INTO @recordIds
			SELECT DISTINCT ActiveItemId
			FROM #result
			WHERE ActiveItemId IS NOT NULL
		EXEC dbo.Audit_Set @loginID, @recordIds, 'ActiveItem', 2

		-- return result
		SELECT * FROM #result ORDER BY SequenceNum
	END

	IF @type = 2
	BEGIN
		SELECT distinct c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, uu.FullName AS CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0),charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID As UniqueID
			, d.SequenceNum
			, CASE WHEN a.ArchiveDate IS NULL Then a.dueTime Else NULL End As DueTime
			, CASE WHEN a.ArchiveDate IS NULL Then a.ReminderDate Else NULL End As ReminderDate
			, a.CompletedDate As ActiveChkCompletedDate
			, null as AssignmentID
			, 1 As ChkType
			, null As Members
			, 0 as CompletedByID
			, 0 As AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, CASE WHEN s.freqType = 1 THEN 'One Time' 
				 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
				 WHEN s.freqType = 3 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Weekly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
						END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
				 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
				 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 				 WHEN s.freqType = 5 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Yearly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
						END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
				ELSE '' END as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
			, case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee
			, isnull(a.isna, 0) as isna
			, isnull(a.nareason, '') as nareason
	FROM
		QCheck_ActiveChecklistArchive a 
		INNER JOIN 
			(
			SELECT 
				ID, ChecklistID, ScheduleID, null as ArchiveDate
			FROM QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT 
				ID, ChecklistID, ScheduleID, ArchiveDate
			FROM 
				QCheck_ChecklistInstanceArchive 

			) b
		 ON a.InstanceID = b.ID 
		INNER JOIN QCheck_Checklists_All c
		 on b.checklistID = c.ID 
		LEFT JOIN 
			QCheck_Items d
		 on d.checklistID = c.ID 
		LEFT JOIN 
			QCheck_ItemTypes j 
		 on d.ItemTypeID = j.ID
		left outer JOIN QCheck_ActiveItemArchive e
			
		 on 
			e.ActiveChecklistID = a.ID 
			and e.ChecklistItemID = d.ID 
		LEFT OUTER JOIN QCheck_Users uu 
			ON 
			uu.ID = e.CompletedBy
		LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
		LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
 WHERE
		a.ID = @ID
 ORDER BY 
		SequenceNum
	END

	IF @type = 3
	BEGIN
		-- get future checklists
		SELECT Distinct 
			c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, null As UserText
			, null As CompletedBy
			, null As CompletedDate
			, d.ID as ItemID
			, b.ID As Identifier
			, uc.ID As UniqueID
			, d.SequenceNum
			, uc.DueTime
			, NULL AS ReminderDate
			, null As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 2 As ChkType
			, 0 As AssignedTo
			, uc.ID as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, CASE WHEN s.freqType = 1 THEN 'One Time' 
				 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
				 WHEN s.freqType = 3 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Weekly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
						END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
				 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
				 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 				 WHEN s.freqType = 5 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Yearly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
						END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
				ELSE '' END as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
			, case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee
			, 0 as isna
			, '' as nareason
		FROM
			QCheck_ChecklistInstances b
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			LEFT JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			LEFT JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta on ta.InstanceID = b.ID
			INNER JOIN QCheck_UpcomingDueTimes uc on uc.InstanceID = b.ID and uc.ID = @id
			LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
			LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
		ORDER BY 
			SequenceNum
	END
	
	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck_GetUserChecklists](
	@UserID int,
	@activeChecklistID int = 0,
	@instanceID int = 0,
	@startDate datetime = null,
	@endDate datetime = null,
	@recurrance int = 0
) AS
BEGIN
	SET NOCOUNT ON
	
	-- get current checklists
	SELECT 
		c.ID as ChecklistID,
		c.Name as ChecklistName, 
		c.CreateDate,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetActiveChecklistControllers(a.ID) AS Controllers,
		--dbo.QStatus_GetChecklistReports(a.ID, @UserID) as StatusReportString
		isnull(ccl.controllers, '') as Controllers,
		isnull(trl.reportslist, '') as StatusReportString,
		isnull(al.assignees,'') as Assignees,
		case when ms.checklistid is null then 0 else 1 end as MultiStep,
		case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee,
		al.assigneecount,
		case when aac.ActiveChecklistID is null then 0 else 1 end as PendingChange, 
		aac.DueTime as NewDeadline,
		isnull(a.isna, 0) as isna, 
		isnull(a.nareason, '') as nareason,
		e.ID AS ActiveItemId
	INTO #result
	FROM
		QCheck_ActiveChecklists a 
		INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
		INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and @recurrance = 2) and Not (s.freqType > 1 and @recurrance = 1)
		INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
		INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
		INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
		INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
		INNER JOIN QCheck_GroupMembership gm on gm. UserID = @UserID
		INNER JOIN QCheck_Groups g on g.ID = gm.GroupID
		INNER JOIN QCheck_Assignments f on f.GroupID = gm.GroupID And f.IsDeleted = 0 and f.InstanceID = b.ID
		LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
		LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
		LEFT OUTER JOIN QStatus_TaskReportList trl on trl.activechecklistid = a.id and trl.userid = @UserID
	 LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
		LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
		LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
		--LEFT OUTER JOIN QCheck_PendingApprovals pa on pa.activechecklistid = a.id
		LEFT OUTER JOIN QCheck_MostRecentDeadlineRequests mrdr
				ON a.ID = mrdr.ActiveChecklistID
		LEFT OUTER JOIN QCheck_Approval_ChangeRequests cr
			ON cr.ID = mrdr.ChangeRequestID
		LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aac
				ON aac.ChangeRequestID = CR.[ID]
				AND aac.ActiveChecklistID = mrdr.ActiveChecklistID
	 WHERE
		-- 3/30/2016 dalvarado - removing this filter so you can see past completed items
		--(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate()))) AND 
		(@activeChecklistID = 0 or a.ID = @activeChecklistID)
		AND @instanceID = 0
		AND a.dueTime between @startDate and @endDate

	UNION 
	
	-- get future checklists
	SELECT 
		c.ID As ChecklistID,
		c.Name as ChecklistName, 
		c.CreateDate,
		j.Name as ItemType, 
		d.Text, 
		d.URL, 
		null As UserText, 
		null As CompletedBy, 
		null As CompletedDate,
		d.ID as ItemID,
		b.ID As Identifier,
		upcoming1.ID as UniqueID, 
		d.SequenceNum, 
		upcoming1.DueTime as dueTime, 
		upcoming1.ID as UpcomingID,
		null As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		'12/12/9999' As Computed, 	
		2 As ChkType, 
		0 as CompletedByID,
		upcoming1.DueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers,
		isnull(ccl.controllers, '') as Controllers,
		'' as StatusReportString,
		isnull(al.assignees,'') as Assignees,
		case when ms.checklistid is null then 0 else 1 end as MultiStep,
		case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee,
		AL.assigneecount,
		0 as PendingChange, 
		null as NewDeadline,
		0 as isna, 
		'' as nareason,
		CAST(NULL AS INT) AS ActiveItemId
	FROM
		QCheck_ChecklistInstances b
		INNER JOIN QCheck_UpcomingDueTimes upcoming1
			ON b.ID = upcoming1.instanceID
			and upcoming1.DueTime between @StartDate and @EndDate
		INNER JOIN QCheck_Schedule s 
			ON b.ScheduleID = s.ID 
			and Not (s.freqType = 1 and @recurrance = 2) 
			and Not (s.freqType > 1 and @recurrance = 1)
		INNER JOIN QCheck_Checklists c 
			on b.checklistID = c.ID 
			AND c.IsDeleted = 0
		INNER JOIN QCheck_Items d 
			on d.checklistID = c.ID 
			AND d.IsDeleted = 0
		INNER JOIN QCheck_ItemTypes j 
			on d.ItemTypeID = j.ID
		INNER JOIN QCheck_GroupMembership gm 
			on gm. UserID = @UserID
		INNER JOIN QCheck_Groups g
			on g.ID = gm.GroupID
		INNER JOIN QCheck_Assignments f 
			on f.GroupID = gm.GroupID
			And f.IsDeleted = 0 
			and f.InstanceID = b.ID
		LEFT OUTER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = upcoming1.InstanceID
			AND ac.OrigDueTime = upcoming1.DueTime
		LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
		LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
		LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
	WHERE 
		not b.isDeleted = 1 
		AND (@instanceID = 0 or b.ID = @instanceID)
		AND @activeChecklistID = 0
		AND ac.ID is null
		AND @recurrance < 3
		
	ORDER BY --ChkType,
		Computed desc,
		dueSort,
		ChecklistName,
		Identifier,
		SequenceNum

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId
		FROM #result
		WHERE ChecklistId IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT ItemID
		FROM #result
		WHERE ItemID IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT ActiveItemId
		FROM #result
		WHERE ActiveItemId IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveItem', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT UniqueID
		FROM #result
		WHERE UniqueID IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'ActiveChecklist', 2

	-- return result
	SELECT * FROM #result
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateChecklistName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_UpdateChecklistName]
	@ID INT,
	@Name VARCHAR(500),
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds VALUES(@ID)
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 3

	UPDATE
		QCheck_Checklists
	SET
		Name = @Name
	WHERE [ID] = @ID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_UpdateItem]
	@ID INT,
	@ChecklistID INT,
	@SequenceNum INT = null,
	@ItemTypeID INT = null,
	@Text	varchar(max) = null,
	@URL	varchar(1000) = null,
	@UserId INT
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @recordIds AS RecordId

	-- move everything up if there is already one at that sequence
	If Not @SequenceNum is null
	BEGIN
		INSERT INTO @recordIds
			SELECT ID FROM QCheck_Items
			WHERE [SequenceNum] >= @SequenceNum
			AND EXISTS (
				SELECT ID FROM QCheck_Items 
				WHERE [ChecklistID] = @ChecklistID
				AND [SequenceNum] = @SequenceNum
			)
		EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 3

		UPDATE QCheck_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE [SequenceNum] >= @SequenceNum
		AND EXISTS
		(
			SELECT ID FROM QCheck_Items 
			WHERE [ChecklistID] = @ChecklistID
			AND [SequenceNum] = @SequenceNum
		)
	END

	-- update the item itself
	DELETE @recordIds
	INSERT INTO @recordIds VALUES(@ID)
	EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 3

	UPDATE
			QCheck_Items
		SET
			SequenceNum = IsNull(@SequenceNum, SequenceNum),
			ItemTypeID = IsNull(@ItemTypeID, ItemTypeID),
			[Text] = IsNull(@Text, [Text]),
			URL = IsNull(@URL, URL)
		WHERE [ID] = @ID	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_AddItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- This stored procedure will Add an item to a checklist
--ChecklistID identifies the checklist
--SequenceNum is the order they show up in
--ItemTypeID is the foreign key to the itemtype table
-- which identifies what type of item this is
--Text is the text that is shown for this item
--URL is the more info link that will appear

CREATE   PROCEDURE [dbo].[QCheck2_AddItem]
	@ChecklistID INT,
	@SequenceNum INT = null,
	@ItemTypeID INT,
	@Text	varchar(max),
	@URL	varchar(1000),
	@UserId INT,
	@ReturnID INT OUTPUT
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @recordIds AS RecordId

	If @SequenceNum is null 
	BEGIN
		SELECT @SequenceNum = isnull(max([SequenceNum]),0) + 1
		FROM QCheck_Items
		WHERE [ChecklistID] = @ChecklistID
		AND IsDeleted = 0	
	END
	ELSE
	BEGIN
		-- if any item exists with the current sequence, then
		-- move everything up one to put it in place
		INSERT INTO @recordIds
			SELECT ID 
			FROM QCheck_Items
			WHERE [SequenceNum] >= @SequenceNum
			AND EXISTS (
				SELECT ID FROM QCheck_Items 
				WHERE [ChecklistID] = @ChecklistID
				AND [SequenceNum] = @SequenceNum
			)
		EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 3
	
		UPDATE QCheck_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE [SequenceNum] >= @SequenceNum
		AND EXISTS
		(
			SELECT ID FROM QCheck_Items 
			WHERE [ChecklistID] = @ChecklistID
			AND [SequenceNum] = @SequenceNum
		)
	END
	
	-- now insert the new item directly into the table
	INSERT INTO
		QCheck_Items
	([ChecklistID], [SequenceNum], [ItemTypeID], [Text], [URL])
	VALUES
	(@ChecklistID,@SequenceNum,@ItemTypeID,@Text,@URL)
	SELECT @ReturnID = @@IDENTITY

	DELETE @recordIds
	INSERT INTO @recordIds VALUES(@ReturnID)
	EXEC dbo.Audit_Set @userId, @recordIds, 'Item', 1
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetArchive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetArchive]
	@ReportID int,
	@UserId int
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @Seed int
	INSERT INTO QStatus_Seed
	SELECT 1

	SELECT @Seed = scope_identity()

	DELETE FROM QStatus_Seed

	INSERT INTO QStatus_TempTasks (ID, keyID, specialTask)
	SELECT @Seed, t.id, 0
	FROM
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ActiveChecklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ActiveChecklistArchive 
			--where archivedate > dateadd(day, -56, getdate())
		) t
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QStatus_ActiveChecklistTaskType 
			UNION
			SELECT *, 1 as deleted FROM 
				QStatus_ActiveChecklistTaskTypeArchive 
		) actt
	ON
		actt.ActiveChecklistID = t.ID
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		tt.ID = actt.TaskType
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ChecklistInstances 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistInstanceArchive 
		) i
	ON
		i.ID = t.InstanceID
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_Checklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistArchive 
		) c
	ON
		c.ID = i.ChecklistID
	WHERE
		tt.ReportID = @ReportID
	AND
		(t.deleted = 1 or i.deleted = 1 or c.deleted = 1)

	--START HEADER
	SELECT
		r.ID as ID, 
		'Archive - ' + r.Name as Description,
		dateadd(day, -1, getdate()) as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		1 As ReturnOrder,
		'0' as TaskType,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily,
		CAST(NULL AS INT) AS ChecklistId 
	INTO #result
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	
	--END OF HEADER

	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		2 As ReturnOrder,
		'0' as TaskType,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily,
		NULL AS ChecklistId

	UNION ALL

	-- SECTION HEADS
	SELECT null as ID, 
		'Archive' as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		0 As NativeType,
		3 As ReturnOrder,
		'0' as TaskType,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily,
		NULL AS ChecklistId
	--END SECTION HEADS

	UNION ALL

	--START SECTION HEADINGS
	SELECT null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		0 As NativeType,
		4 As ReturnOrder,
		'0' as TaskType,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily,
		NULL AS ChecklistId
	--END SECTION HEADINGS

	UNION ALL

	--START SECTION ENDERS
	SELECT null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		0 As NativeType,
		99999 As ReturnOrder,
		'0' as TaskType,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily,
		NULL AS ChecklistId
	--END SECTION ENDERS

	UNION ALL
	
	--START SECTION
	SELECT 
		t.ID, 
		c.Name as Description,
		Convert(varchar, DueTime, 101) as DueDate,
		Convert(varchar, t.ReminderDate, 101) as ReminderDate,
		Convert(varchar, ISNULL(t.ReminderDate, t.DueTime), 101) as SortDate,
		actt.Priority,
		t.ID as Comments,
		null as UpdatedDate,
		'Archive' As Type,
		3 As NativeType,
		100 + cast(duetime as integer) as ReturnOrder, 
		'0' as TaskType,
		dbo.QCheck_FullAssigneesList(i.id) as AssignedTo,
		isnull(dbo.QCheck_ManagersList(c.[id]), '') as Controllers,
		null as isRecurring,
		null as IsDaily,
		c.ID AS ChecklistId
	FROM
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ActiveChecklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ActiveChecklistArchive 
			--where archivedate > dateadd(day, -56, getdate())
		) t
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QStatus_ActiveChecklistTaskType 
			UNION
			SELECT *, 1 as deleted FROM 
				QStatus_ActiveChecklistTaskTypeArchive 
		) actt
	ON
		actt.ActiveChecklistID = t.ID
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		tt.ID = actt.TaskType
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ChecklistInstances 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistInstanceArchive 
		) i
	ON
		i.ID = t.InstanceID
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_Checklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistArchive 
		) c
	ON
		c.ID = i.ChecklistID
	WHERE
		tt.ReportID = @ReportID
	AND
		(t.deleted = 1 or i.deleted = 1 or c.deleted = 1)
	
	--END SECTION

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId FROM #result WHERE ChecklistId IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	SELECT * FROM #result ORDER BY ReturnOrder 

	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID

	
	SELECT @Seed
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetCommentsAll]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetCommentsAll]
	@Seed int,
	@ReportID int,
	@UserId int
AS
BEGIN

	--DECLARE @HasRelatedComments bit
	--SET @HasRelatedComments = 0

	SET NOCOUNT ON

	SELECT 
		Distinct null as archiveid, C.*, null as archivedt, 
		tt.keyID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName,
		2147483647 as CommentSort
	INTO #result
	FROM
		QStatus_COMMENTS C
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		c.ForeignKeyID = abs(tt.KeyID)
	AND
		c.SpecialTask = tt.SpecialTask
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID

	union all 

	SELECT 
		Distinct C.*,
		tt.keyID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName,
		C.ArchiveID as CommentSort
	FROM
		QStatus_commentarchive C
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		c.ForeignKeyID = abs(tt.KeyID)
	AND
		c.SpecialTask = tt.SpecialTask
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM #result WHERE ID IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'Comment', 2

	DELETE @recordIds
	INSERT INTO @recordIds
		SELECT DISTINCT archiveid FROM #result WHERE archiveid IS NOT NULL

	EXEC dbo.Audit_Set @userId, @recordIds, 'CommentArchived', 2

	SELECT * FROM #result ORDER BY CommentSort, DisplayOrder

	SELECT distinct ac2.ID
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		--QCheck_ActiveChecklists
	(
		select id, instanceid from QCheck_ActiveChecklists
		union all
		select id, instanceid from QCheck_ActiveChecklistArchive
	)
	 AC
	ON
		C.ForeignKeyID = AC.ID
	INNER JOIN
		--QCheck_ChecklistInstances
		(
		select id, checklistid from QCheck_ChecklistInstances
		union all
		select id, checklistid from QCheck_ChecklistInstanceArchive
	) 
	CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID <> AC.ID
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		ac2.ID = tt.KeyID
	WHERE c.specialtask = 0
	

	--delete from QStatus_TempTasks where id = @Seed OR input_date < dateadd(mi, -1, getdate())
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetLatestComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   PROC [dbo].[QStatus_GetLatestComments]
	@ReportID int,
	@TaskID int,
	@UserID int = null,
	@selectedComments varchar(1000) = null,
	@CommentsSince DATETIME = NULL
AS

	IF @CommentsSince IS NULL SET @CommentsSince = DATEADD(HOUR, -1, GETDATE())
	If @CommentsSince > getdate() SET @CommentsSince = DATEADD(HOUR, -1, GETDATE()) --time zone issue

	--if only specific comments were requested, parse them out into a table
	DECLARE @selectedCommentsTbl TABLE (commentID int)

	IF @selectedComments IS NOT NULL BEGIN
		INSERT INTO @selectedCommentsTbl
		SELECT n from dbo.Util_fn_List_To_Table(@selectedComments,',')
		
		INSERT INTO @selectedCommentsTbl
			SELECT DISTINCT
				C2.ID
			FROM 
				@SelectedCommentsTbl st
				INNER JOIN QStatus_Comments c1
					ON st.CommentID = c1.ID
				INNER JOIN QStatus_Comments c2
					ON c1.ForeignKeyID = c2.ForeignKeyID
					AND c1.ID <> c2.ID
					AND c2.CommentDt > c1.CommentDt
	END

	DECLARE @results TABLE
	(
		ID	int,
		ForeignKeyID	int,
		Comments	varchar(1500),
		DisplayOrder	int,
		TabIn	int,
		CommentDt	datetime,
		Initials	varchar(100),
		UserID	int,
		ReplyID	int,
		SpecialTask	bit,
		TaskID	int,
		ColorNum int,
		FullName varchar(100)
	)

	INSERT INTO @results
	SELECT 
		Distinct C.*, 
		task.taskID as TaskID,
	 	CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTS C
	INNER JOIN 
	(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		c.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	WHERE
	 (
		c.ID in (
				SELECT ID FROM QStatus_comments 
				where 
					--USERID = @UserID AND 
					LEN(Comments)>0 AND 
					CommentDt > @CommentsSince
				)
			OR 
		c.ID in (
				SELECT ReplyID FROM QStatus_comments 
				where 
					--USERID = @UserID AND 
					LEN(Comments)>0 AND 
					CommentDt > @CommentsSince
				)
	)
	ORDER BY C.DisplayOrder

	IF @selectedComments IS NOT NULL
		DELETE FROM @results
		WHERE ID NOT IN (SELECT CommentID FROM @selectedCommentsTbl)

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM @results

	EXEC dbo.Audit_Set @userId, @recordIds, 'Comment', 2

	SELECT * FROM @results
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetRelatedComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetRelatedComments]
	@TaskID int,
	@UserId int,
	@OnlyCount bit = 0
AS

	SELECT Distinct C.*, u.FullName, AC.ID AS TaskID, AC.DueTime
	INTO #result
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		(
			SELECT 
				ID, InstanceID, DueTime
			FROM QCheck_ActiveChecklists
			UNION ALL
			SELECT 
				ID, InstanceID, DueTime
			FROM 
				QCheck_ActiveChecklistArchive 

		) AC
	ON
		C.ForeignKeyID = AC.ID
	AND
		AC.ID <> @TaskID
	INNER JOIN
		(
			SELECT 
				ID, ChecklistID
			FROM QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT 
				ID, ChecklistID
			FROM 
				QCheck_ChecklistInstanceArchive 

		) CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID = @TaskID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	
	IF @OnlyCount = 1 BEGIN
		SELECT COUNT(*) FROM #result		
	END
	ELSE
	BEGIN	
		DECLARE @recordIds AS RecordId
		INSERT INTO @recordIds
			SELECT DISTINCT ID FROM #result WHERE ID IS NOT NULL
	
		EXEC dbo.Audit_Set @userId, @recordIds, 'Comment', 2
		
		SELECT * FROM #result
		ORDER BY DueTime, TaskID, DisplayOrder
	END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetReport] (
	@UserID int,
	@ReportID int,
	@deletedDate datetime = null,
	@MoveCompleted bit = 0,
	@DueFilter datetime = null,
	@AssignedTo int = -1,
	@PriorityListSetID INT = -1

/*
set @UserID = 24
set @ReportID = 1100843
set @MoveCompleted = 0
set @AssignedTo = -1
set @PriorityListSetID = 149
--set @PriorityListSetID = -1
*/
) AS

BEGIN
	
	--exec sp_recompile 'QStatus_GetReport'
 
	SET NOCOUNT ON
	
	DECLARE @ReportUserID int
	DECLARE @LastReadDate datetime
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int
	DECLARE @Seed int
	DECLARE @PriorityListSetName VARCHAR(50)
	
	INSERT INTO QStatus_Seed
		SELECT 1

	SELECT @Seed = scope_identity()

	DELETE FROM QStatus_Seed
	--find all the tasks

	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY
	)

	INSERT INTO @ForeignKeyIDs 
		SELECT distinct activechecklistid 
		FROM qstatus_commentedreporttasks
		WHERE reportID = @reportID 

	--add a day to whatever was passed in (takes care of default to midnight)
	IF @DueFilter is not null
		SET @DueFilter = DateAdd(day, 1, @DueFilter)
	
	SELECT @CompletedType = 'Completed'
	--find out if they are a user or supervisor/ip

	SET @ReportUserID = 0

	SELECT 
		@ReportUserID = UserID
	FROM
		QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
			ON g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gr.ReportID = @ReportID
			AND gm.UserID = @UserID

	--default to 60 days ago
	SELECT @LastReadDate = getdate() - 60
	
	--find last time it was marked read by you if you are supervisor/ip
	SELECT 
		@LastReadDate = LastViewed
	FROM 
		QStatus_SupervisorsLastViewed
	WHERE
		ReportID = @ReportID 
		AND SupervisorUserID = @UserID
	
	--if it is your report, just use yesterday
	IF @ReportUserID = @UserID
		SELECT @LastReadDate = dateadd(day, -1, getdate())

	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		ReminderDate datetime,
		InstanceID int,
		assignees varchar(1000),
		controllers VARCHAR(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit,
		isDeleted bit,
		isRecurring bit,
		isPriority bit,
		isDaily bit
	)

	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int,
		isRecurring bit
	)

	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)

	-- 02/23/2011 dalvarado - priorities section
	declare @priorities table (
		ID int PRIMARY KEY IDENTITY(1,1),
		InstanceID INT,
		Priority INT
	)

	INSERT INTO @priorities (
		InstanceID,
		Priority
	)
		SELECT 
			ac.InstanceID,
			pl.Priority
		FROM
			PriorityListUsers plu
			INNER JOIN PriorityList pl
				ON plu.UserID = pl.UserID
			INNER JOIN QCheck_ActiveChecklists ac
				ON pl.ActiveChecklistID = ac.[ID]
		WHERE 
			PLU.[SetID] = @PriorityListSetID

	SELECT @PriorityListSetName = [Name]
	FROM PriorityListSet
	WHERE [ID] = @PriorityListSetID

	insert into @tasks (
		ID ,
		DueTime,
		ReminderDate,
		InstanceID ,
		assignees ,
		controllers,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived,
		IsDeleted,
		IsPriority,
		IsDaily
	)
		SELECT distinct
			ac.ID, 
			ac.DueTime,
			CASE WHEN CONVERT(VARCHAR(10), ac.ReminderDate, 101) <> CONVERT(VARCHAR(10), ac.DueTime, 101) THEN ac.ReminderDate ELSE NULL END,
			ac.InstanceID,
			isnull(al.assignees, ''),
			isnull(dbo.QCheck_ManagersList(c.[id]), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END as NewTask,
			CompletedDate, 
			0,
			c.IsDeleted,
			CASE WHEN p.InstanceID IS NULL THEN 0 ELSE 1 END AS IsPriority,
			CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				AND
					tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists ac
				ON ac.ID = actt.ActiveChecklistID
			INNER JOIN qcheck_checklistinstances ci
				ON ci.ID = ac.InstanceID
			INNER JOIN qcheck_checklists c
				ON ci.ChecklistID = c.ID
			INNER JOIN QCheck_Assignments a
				ON a.instanceID = ci.ID
				AND (
					a.GroupID = @AssignedTo 
					or @AssignedTo = -1
				)
				AND a.IsDeleted = 0
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
			left outer join QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
			left outer join @Priorities p
				ON ac.InstanceID = p.InstanceID
			
		WHERE
			tt.ReportID = @ReportID
			AND (
				@DueFilter is null 
				OR ac.DueTime < @DueFilter
				OR isnull(ac.ReminderDate, ac.DueTime) < @DueFilter
				OR ac.ID in (
					SELECT ForeignKeyID 
					FROM @ForeignKeyIDs
				)
			)

	insert into @tasks (
		ID ,
		DueTime,
		ReminderDate,
		InstanceID ,
		assignees ,
		controllers,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived ,
		IsPriority,
		IsDaily
	)
		SELECT distinct 
			ac.ID, 
			ac.DueTime,
			CASE WHEN CONVERT(VARCHAR(10), ac.ReminderDate, 101) <> CONVERT(VARCHAR(10), ac.DueTime, 101) THEN ac.ReminderDate ELSE NULL END,
			ac.InstanceID, 
			isnull(al.assignees, ''),
			isnull(dbo.QCheck_ManagersList(ISNULL(cia.ChecklistID, ci.ChecklistID)), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END as NewTask,
			CompletedDate, 
			1,
			0,
			0
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				AND tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklistArchive ac
				ON ac.ID = actt.ActiveChecklistID
				AND ac.archivedate > @deleteddate 
				AND @deleteddate is not null
			INNER JOIN QCheck_ActiveAssignmentArchive aa
				ON aa.ActiveChecklistID = ac.ID
			LEFT OUTER JOIN QCheck_ChecklistInstanceArchive cia
				ON ac.InstanceID = cia.[ID]
			-- 2/26/2013 dalvarado - found cases where the instance wasn't archived with the active checklist, so need to look
			-- in both checklistinstances and checklistinstancearchive.
			left outer join qcheck_checklistinstances ci
				ON ac.InstanceID = ci.ID
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
		WHERE
			tt.ReportID = @ReportID
			AND (
				@DueFilter is null 
				OR ac.DueTime < @DueFilter 
				OR isnull(ac.ReminderDate, ac.DueTime) < @DueFilter 
				OR ac.ID in (
					SELECT ForeignKeyID 
					FROM @ForeignKeyIDs
				)
			)
			AND (
				@AssignedTo = -1
				OR aa.AssignmentsID in (
					SELECT ID 
					FROM QCheck_Assignments
					WHERE 
						GroupID = @AssignedTo 
						and isdeleted = 0
				)
				OR aa.AssignmentsID in (
					SELECT ID 
					FROM QCheck_AssignmentArchive
					WHERE 
						GroupID = @AssignedTo 
						and isdeleted = 0
				)
			)

	update 
		@tasks
	set 
		DueDateChanged = 1
	from 
		@tasks t
		inner join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID =t.ID
			AND ddc.UpdateDt > @deletedDate
	
	update 
		@tasks
	set 
		PriorityChanged = 1
	from 
		@tasks t
		inner join QStatus_PriorityChanges pc
			on pc.ActiveChecklistID =t.ID
			AND pc.UpdateDt > @deletedDate

	-- 02/23/2011 dalvarado
	IF @PriorityListSetID <> -1 BEGIN

		UPDATE 
			@tasks
		SET 
			TaskType = -1000,
			TaskDescription = 'Top Priorities' + ISNULL(' - ' + @PriorityListSetName, ''),
			TaskTypeOrder = 10,
			Priority = p.Priority
		FROM 
			@tasks t
			inner join @priorities p
				on t.InstanceID = p.InstanceID

	END

	insert into @instances

		SELECT distinct
			ci.ID,
			ci.ChecklistID,
			CASE 
				WHEN s.freqType > 1 THEN 1 
				ELSE 0 
			END as isRecurring
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN @tasks t
				ON t.InstanceID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
		WHERE
			ci.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT distinct
			ci.ID,
			ci.ChecklistID,
			CASE 
				WHEN s.freqType > 1 THEN 1 
				ELSE 0 
			END as isRecurring
		FROM 
			QCheck_ChecklistInstanceArchive ci
			INNER JOIN @tasks t
				ON t.InstanceID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
		WHERE
			(
				ci.IsDeleted = 0 
				OR @deleteddate is not null
			)
			AND ci.archivedate > @deleteddate 
			AND @deleteddate is not null
	

	insert into @checklists

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE 
				WHEN tnc.ChecklistID IS NULL THEN 0 
				ELSE 1 
			END as TaskNameChanged
		FROM 
			QCheck_Checklists c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE 
				WHEN tnc.ChecklistID IS NULL THEN 0 
				ELSE 1 
			END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			(
				c.IsDeleted = 0 
				OR @deleteddate is not null
			)
			AND c.archivedate > @deleteddate 
			AND @deleteddate is not null

	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)

	update @tasks
	set 
		description = c.description,
		tasknamechanged = c.tasknamechanged,
		isRecurring = i.isRecurring
	from 
		@tasks t
		inner join @instances i
			on i.id = t.instanceid
		inner join @checklists c
			on c.id = i.checklistid

	INSERT INTO QStatus_TempTasks (
		ID, 
		keyID, 
		specialTask
	)
		SELECT 
			@Seed, 
			id, 
			0
		FROM 
			@Tasks
	
	INSERT INTO QStatus_TempTasks (
		ID, 
		keyID, 
		specialTask
	)
		SELECT 
			@Seed, 
			-1 * st.id, 
			1
		FROM
			QStatus_SpecialTasks st
			INNER JOIN QStatus_TaskTypes tt
				ON st.TaskType = tt.ID
				AND tt.IsDeleted = 0
				AND tt.ReportID = @ReportID
				AND st.IsDeleted = 0

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM @checklists

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	--START HEADER
	SELECT
		null as ID, 
		dbo.QStatus_GetUserNames(r.ID) + 
			r.Name + ' - Status Report - '
			+ CASE 
				WHEN r.LastReportDate = 0 THEN 
					'No Status'
				ELSE 
					ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
					+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
					+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
			END as Description,
		@LastReadDate as DueDate,
		@LastReadDate AS ReminderDate,
		@LastReadDate AS SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		'0' as TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER
	
	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder, 
		'0' As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as isDaily

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN t.CompletedDate IS Not Null then Null ELSE t.TaskType END AS ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType +' - '+ taskdescription ELSE taskdescription END AS Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL
	
	
	UNION ALL

	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END + 1 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskdescription end as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END + 999 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	--END SECTION ENDERS

	UNION ALL
	
	--START SECTION
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		Convert(varchar, t.ReminderDate, 101) as ReminderDate,
		Convert(varchar, ISNULL(t.ReminderDate, t.DueTime), 101) as SortDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskDescription end As Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else
			CASE WHEN t.archived = 1 THEN
				3
			ELSE
				t.NativeType
			END
		END as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo,
		Controllers,
		t.isRecurring as isRecurring,
		t.IsDaily as isDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL

	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		Convert(varchar, t.ReminderDate, 101) as ReminderDate,
		Convert(varchar, ISNULL(t.ReminderDate, t.DueTime), 101) as SortDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		'Comments' As Type,
		999 as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo,
		Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL
 
	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 As ReturnOrder,
		CAST(tt.ID As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION HEADS SPECIAL 

	UNION ALL

	-- SECTION ENDERS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 999 As ReturnOrder,
		CAST(tt.ID AS varchar) AS TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring, 
		null as IsDaily
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION ENDERS SPECIAL 
	
	UNION ALL

	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID, -- negative for special sections
		tt.Description,
		0 as DueDate,
		0 as ReminderDate,
		0 as SortDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		tt.Description as Type,
		tt.NativeType ,
		0 as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		CAST(tt.ID AS varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION SPECIAL 
	
	ORDER BY 
		ReturnOrder,
		SortDate asc,
		ReminderDate asc, 
		DueDate asc, 
		description, 
		NativeType asc

	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID

	SELECT @Seed
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportLatestComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetReportLatestComments]
	@UserID int,
	@ReportID int,
	@deletedDate datetime = null,
	@MoveCompleted bit = 0,
	@selectedComments varchar(1000) = null,
	@CommentsSince DATETIME = NULL,
	@IncludeAllTasks BIT = 0
/*
set @UserID = 50
set @ReportID = 1100996
set @deletedDate = null
set @MoveCompleted = 0
set @selectedComments = null
set @CommentsSince = '4/10/2016 10:00'
set @IncludeAllTasks = 1
*/
AS

BEGIN
	SET NOCOUNT ON
	
	IF @CommentsSince IS NULL SET @CommentsSince = DATEADD(HOUR, -1, GETDATE())
	If @CommentsSince > getdate() SET @CommentsSince = DATEADD(HOUR, -1, GETDATE()) --time zone issue

	DECLARE @CompletedType varchar(10)
	
	SELECT @CompletedType = 'Completed'
	
	--waitfor delay '00:00:10'

	--if only specific comments were requested, parse them out into a table
	DECLARE @selectedCommentsTbl TABLE (commentID int)

	IF @selectedComments IS NOT NULL
		INSERT INTO @selectedCommentsTbl
		SELECT n from dbo.Util_fn_List_To_Table(@selectedComments,',')

	--find all the tasks
	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY,
		SpecialTask int
	)

	IF @selectedComments IS NOT NULL
	BEGIN
		INSERT INTO @ForeignKeyIDs 
			SELECT distinct 
				actt.activechecklistid, 
				specialTask 
			FROM 
				QStatus_ActiveChecklistTaskType actt
				inner join qstatus_tasktypes tt
					on tt.id = actt.tasktype
					and tt.reportID = @reportID
				inner join qstatus_comments c
					on c.foreignkeyid = actt.activechecklistid
					and c.specialtask = 0
					and c.UserID = @UserID
					AND LEN(Comments)>0 
					AND CommentDT > @CommentsSince
				INNER JOIN @selectedCommentsTbl sc 
					ON c.id = sc.commentID

		INSERT INTO @ForeignKeyIDs
			SELECT distinct 
				st.ID, 1
			FROM 
				QStatus_SpecialTasks st
				inner join qstatus_tasktypes tt
					ON tt.ID = st.TaskType
					AND tt.ReportID = @ReportID
				inner join qstatus_comments c
					on c.foreignkeyid = st.ID
					AND LEN(Comments)>0 
					AND CommentDT > @CommentsSince
					and specialtask=1
					and c.UserID = @UserID
				INNER JOIN @selectedCommentsTbl sc 
					ON c.id = sc.commentID
	END
	ELSE
	BEGIN
		INSERT INTO @ForeignKeyIDs 
			SELECT distinct 
				actt.activechecklistid, 
				ISNULL(specialTask, 0)
			FROM 
				QStatus_ActiveChecklistTaskType actt
				INNER JOIN qstatus_tasktypes tt
					ON tt.id = actt.tasktype
					AND tt.reportID = @reportID
				LEFT OUTER JOIN qstatus_comments c
					ON c.foreignkeyid = actt.activechecklistid
					AND c.specialtask = 0
			WHERE
				(c.UserID = @UserID OR @IncludeAllTasks = 1)
				AND (LEN(Comments) > 0 OR @IncludeAllTasks = 1)
				AND ISNULL(CommentDT, '12/31/2199') > @CommentsSince
				AND (c.ID IS NOT NULL OR @IncludeAllTasks = 1) --Basically want an inner join if not showing all tasks

			UNION

			-- If we're showing all tasks, make sure every task on the status report is included. The query above will only pull
			-- tasks that have active comments within the date range or don't have comments from the user at all.
			SELECT distinct 
				actt.activechecklistid,
				0
			FROM 
				QStatus_ActiveChecklistTaskType actt
				INNER JOIN qstatus_tasktypes tt
					ON tt.id = actt.tasktype
					AND tt.reportID = @reportID
			WHERE
				@IncludeAllTasks = 1 

		INSERT INTO @ForeignKeyIDs
			SELECT distinct 
				st.ID, 
				1
			FROM 
				QStatus_SpecialTasks st
				INNER JOIN qstatus_tasktypes tt
					ON tt.ID = st.TaskType
					AND tt.ReportID = @ReportID
				LEFT OUTER JOIN qstatus_comments c
					ON c.foreignkeyid = st.ID
					AND specialtask=1
			WHERE
				(LEN(Comments) > 0 OR @IncludeAllTasks = 1)
				AND ISNULL(CommentDT, '12/31/2199') > @CommentsSince
				AND (c.UserID = @UserID OR @IncludeAllTasks = 1)
				AND (c.ID IS NOT NULL OR @IncludeAllTasks = 1) --Basically want an inner join if not showing all tasks

			UNION

			SELECT distinct 
				st.ID, 
				1
			FROM 
				QStatus_SpecialTasks st
				INNER JOIN qstatus_tasktypes tt
					ON tt.ID = st.TaskType
					AND tt.ReportID = @ReportID
			WHERE
				@IncludeAllTasks = 1

	END

	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		InstanceID int,
		assignees varchar(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit
	)

		
	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int
	)
	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)
	
	insert into @tasks (
		ID ,
		DueTime,
		InstanceID ,
		assignees ,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived 
	)
		SELECT distinct
			ac.ID, 
			ac.DueTime,
			ac.InstanceID,
			isnull(REPLACE(al.assignees, '&nbsp;', ' '), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END as NewTask,
			CompletedDate, 
			0
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				AND tt.IsDeleted = 0
				AND tt.ReportID = @ReportID
			INNER JOIN QCheck_ActiveChecklists ac
				ON ac.ID = actt.ActiveChecklistID
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
			inner join @ForeignKeyIDs f
				ON f.ForeignKeyID = ac.ID
				AND f.SpecialTask = 0	

	
	insert into @tasks (
		ID ,
		DueTime,
		InstanceID ,
		assignees ,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived 
	)
		SELECT distinct 
			ac.ID, 
			ac.DueTime,
			ac.InstanceID, 
			isnull(REPLACE(al.assignees, '&nbsp;', ' '), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END as NewTask,
			CompletedDate, 
			1
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				AND tt.ReportID = @ReportID
				AND tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklistArchive ac
				ON ac.ID = actt.ActiveChecklistID
				--AND ac.archivedate > @deleteddate 
				--AND @deleteddate is not null
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
			inner join @ForeignKeyIDs f
				ON f.ForeignKeyID = ac.ID
				AND f.SpecialTask = 0	

	
	update @tasks
	set DueDateChanged = 1
	from 
		@tasks t
		inner join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID =t.ID
			AND ddc.UpdateDt > @deletedDate

	
	update @tasks
	set PriorityChanged = 1
	from 
		@tasks t
		inner join QStatus_PriorityChanges pc
			on pc.ActiveChecklistID =t.ID
			AND pc.UpdateDt > @deletedDate
	
	insert into @instances
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN @tasks t
			ON t.InstanceID = ci.ID
		WHERE
			ci.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstanceArchive ci
			INNER JOIN @tasks t
			ON t.InstanceID = ci.ID
		WHERE
			(ci.IsDeleted = 0 OR @deleteddate is not null)
			AND ci.archivedate > @deleteddate 
			AND @deleteddate is not null
	
	insert into @checklists
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_Checklists c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			(c.IsDeleted = 0 OR	@deleteddate is not null)
			AND c.archivedate > @deleteddate 
			AND @deleteddate is not null

	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)

	update @tasks
	set 
		description = c.description,
		tasknamechanged = c.tasknamechanged
	from 
		@tasks t
		inner join @instances i
			on i.id = t.instanceid
		inner join @checklists c
			on c.id = i.checklistid

	DECLARE @specialtasks table(
		ID int,
		priority int,
		tasktypeid int,
		tasktypedescription varchar(1000), 
		tasktypenativetype int,
		tasktypedisplayorder int
	)

	insert into @specialtasks
		select st.ID,
			st.priority,
			tt.id,
			tt.description,
			tt.nativetype,
			tt.displayorder
		from 
			QStatus_SpecialTasks st
			INNER JOIN QStatus_TaskTypes	tt
				ON st.TaskType = tt.ID
				AND tt.IsDeleted = 0
				AND st.IsDeleted = 0
				AND tt.ReportID = @ReportID
			INNER JOIN @ForeignKeyIDs f
				ON f.ForeignKeyID = st.ID
				AND f.SpecialTask = 1

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM @checklists

	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	--START HEADER
	SELECT
		null as ID, 
		dbo.QStatus_GetUserNames(r.ID) + r.Name + ' - Status Report - '
		+ CASE WHEN r.LastReportDate = 0 THEN
			'No Status'
		ELSE
			ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
			+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
			+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
		END 
		as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		'0' as TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER

	
	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder, 
		'0' As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN t.CompletedDate IS Not Null then Null ELSE t.TaskType END AS ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType +' - '+ taskdescription ELSE taskdescription END AS Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t
		
	UNION ALL

	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END + 1 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t

	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskdescription end as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END + 999 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t

	--END SECTION ENDERS

	UNION ALL
	
	--START SECTION
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.archived = 1 THEN
			--' (DELETED)'
			''
		ELSE
			''
		END
		 as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskDescription end As Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo
	FROM
		@tasks t
		
	UNION ALL
/*	
	-- COMMENTS
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		'Comments' As Type,
		999 as NativeType,
		0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo
	FROM
		@tasks t

	UNION ALL
*/ 
	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tasktypedescription as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tasktypenativetype as NativeType ,
		null as IsDeleted,
		tasktypedisplayorder * 1000 * 2 As ReturnOrder,
		CAST(tasktypeid As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION HEADS SPECIAL 
	
	UNION ALL
	
	-- COLUMN HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tasktypedescription as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Special Headings Row' as Type,
		tasktypenativetype as NativeType ,
		null as IsDeleted,
		tasktypedisplayorder * 1000 * 2 + 1 As ReturnOrder,
		CAST(tasktypeid As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION HEADS SPECIAL 

	UNION ALL

	-- SECTION ENDERS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tasktypedescription as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tasktypenativetype as NativeType ,
		null as IsDeleted,
		tasktypedisplayorder * 1000 * 2 + 999 As ReturnOrder,
		CAST(tasktypeid AS varchar) AS TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION ENDERS SPECIAL 
	
	
	
	UNION ALL

	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID, -- negative for special sections
		st.tasktypedescription as description,
		null as DueDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		st.tasktypedescription as Type,
		st.tasktypenativetype as NativeType ,
		0 as IsDeleted,
		st.tasktypedisplayorder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		CAST(st.tasktypeid AS varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION SPECIAL 
	

	ORDER BY 
		ReturnOrder,
		DueDate asc, 
		description, 
		NativeType asc

	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetReportList]
	@UserID int,
	@IncludeDefault bit = 1
AS
BEGIN
	SET NOCOUNT ON

		SELECT 
			DISTINCT r.[ID],
				r.name,
		 	replace(replace(r.Name, '&', '&amp;'),'"', '&quot;') 
			+ case when @IncludeDefault = 0 then '' else 	isnull(
				' (' + 
				
				case (datediff(day, convert(datetime, convert(varchar, commentdt, 101)), convert(datetime, convert(varchar, getdate(), 101))))
				when 0 then 'today'
				when 1 Then '1 day ago'
				else
					convert(varchar, datediff(day, convert(datetime, convert(varchar, commentdt, 101)), convert(datetime, convert(varchar, getdate(), 101)))) + ' days ago'
				end
				+ ')'
				, '') end
			AS [Description]
		INTO #result
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		LEFT OUTER JOIN QStatus_ReportLastestComments lastcomment
			on lastcomment.reportID = r.ID
			and lastcomment.userID = @UserID
		WHERE
			r.IsDeleted = 0

		DECLARE @recordIds AS RecordId
		INSERT INTO @recordIds
			SELECT DISTINCT ID FROM #result

		EXEC dbo.Audit_Set @userId, @recordIds, 'Report', 2
		
		SELECT * FROM #result 
		ORDER BY [Name]
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportList_Supervised]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetReportList_Supervised]
	@UserID int,
	@InterestedParty bit = 0,
	@NamesOnly bit = 0
AS
BEGIN
	SET NOCOUNT ON

		SELECT 
			DISTINCT r.[ID],
				r.name,
		 	replace(replace(r.Name, '&', '&amp;'),'"', '&quot;') 
			+	CASE WHEN @NamesOnly = 0 THEN isnull(
				' (' + 
				
				case (datediff(day, convert(datetime, convert(varchar, commentdt, 101)), convert(datetime, convert(varchar, getdate(), 101))))
				when 0 then 'today'
				when 1 Then '1 day ago'
				else
					convert(varchar, datediff(day, convert(datetime, convert(varchar, commentdt, 101)), convert(datetime, convert(varchar, getdate(), 101)))) + ' days ago'
				end
				+ ')'
				, '') ELSE '' END as [description],
				g.Name as GroupName,
				gr.ID as QStatusSupervisorID
		INTO #result
		FROM 
			QStatus_Report r
			INNER JOIN QStatus_Supervisors gr
				ON gr.ReportID = r.ID
				AND gr.InterestedParty = @InterestedParty
			INNER JOIN QCheck_Groups g
				ON g.ID = gr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID
			LEFT OUTER JOIN QStatus_ReportLastestComments lastcomment
				ON lastcomment.reportID = r.ID
				AND lastcomment.userID = @UserID
		WHERE 
			r.IsDeleted = 0
		
		DECLARE @recordIds AS RecordId
		INSERT INTO @recordIds
			SELECT DISTINCT ID FROM #result

		EXEC dbo.Audit_Set @userId, @recordIds, 'Report', 2
		
		SELECT * FROM #result ORDER BY [Name]
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetReportName]
	@ReportID int,
	@UserId int,
	@ReportName varchar(100) output
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds VALUES(@ReportID)

	EXEC dbo.Audit_Set @userId, @recordIds, 'Report', 2
	
	SELECT @ReportName = dbo.QStatus_GetUserNames(r.ID) + r.Name
	FROM
		QStatus_Report r
	WHERE r.ID = @ReportID
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportTaskListByUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetReportTaskListByUser]
	@UserID int
AS
BEGIN
	SET NOCOUNT ON
	
	--START HEADER
	SELECT distinct
		null as ID, 
			dbo.QStatus_GetUserNames(r.ID) + r.Name + ' - Status Report - '
			+ CASE WHEN r.LastReportDate = 0 THEN
				'No Status'
			ELSE
				ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
				+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
				+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
			END 
		as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
	INTO #result
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	AND
		r.IsDeleted = 0
	
	--END OF HEADER

	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	AND
		r.IsDeleted = 0

	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'SpacerType' as Type,
		-1,
		null as IsDeleted,
		999999 As ReturnOrder,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	AND
		r.IsDeleted = 0

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN AC.CompletedDate IS Not Null then Null ELSE tt.ID END AS ID, 
		CASE WHEN AC.CompletedDate IS Not Null then 'Completed - '+ tt.Description ELSE tt.Description END AS Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder * 1000 * 2 + 1000 Else tt.DisplayOrder * 1000 * 2 END As ReturnOrder,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
		--0 As ShowSupervisor
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ChecklistInstances ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0)
	INNER JOIN
		QCheck_Checklists c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0)
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0

	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = tt.ReportID
	INNER JOIN
		QCheck_Groups grg
	ON
		grg.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership grgm
	ON
		grgm.GroupID = grg.ID
	AND
		grgm.UserID = @UserID
	INNER JOIN
		QStatus_Report r
	ON
		gr.ReportID = r.ID
	AND
		r.IsDeleted = 0
	INNER JOIN
		QCheck_Assignments a
	ON
		a.InstanceID = ci.ID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = a.GroupID
	AND
		gm.UserID = @UserID
	INNER JOIN 
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	
	--END SECTION HEADS

	UNION ALL

	-- SECTION HEADS Not Shown
	SELECT DISTINCT
		tt.ID, 
		tt.Description,
		--'blah' as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType as NativeType,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 As ReturnOrder,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
	FROM
		QStatus_TaskTypes tt
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = tt.ReportID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	AND
		tt.NativeType = 0
	AND
		tt.IsDeleted = 0
	INNER JOIN
		QStatus_Report r
	ON
		gr.ReportID = r.ID
	AND
		r.IsDeleted = 0
	WHERE
		tt.ID NOT IN
	(
		SELECT tt.ID
		FROM
			QStatus_ActiveChecklistTaskType actt
		INNER JOIN
			QCheck_ActiveChecklists ac
		ON
			ac.ID = actt.ActiveChecklistID
		INNER JOIN
			QCheck_ChecklistInstances ci
		ON
			ci.ID = ac.InstanceID
		AND
			(ci.IsDeleted = 0)
		INNER JOIN
			QCheck_Checklists c
		ON	
			c.ID = ci.ChecklistID
		AND 
			(c.IsDeleted = 0)
		INNER JOIN
			QStatus_TaskTypes	tt
		ON
			actt.TaskType = tt.ID
		AND
			tt.IsDeleted = 0

		INNER JOIN
			QStatus_GroupReport rgr
		ON
			rgr.ReportID = tt.ReportID
		INNER JOIN
			QCheck_Groups rg
		ON
			rg.ID = rgr.GroupID
		INNER JOIN
			QCheck_GroupMembership rgm
		ON
			rgm.GroupID = rg.ID
		AND
			rgm.UserID = @UserID

		INNER JOIN
			QCheck_Assignments a
		ON
			a.InstanceID = ci.ID
		AND
			ac.CompletedDate is null
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = a.GroupID
		AND
			gm.UserID = @UserID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gm.GroupID
		
	)
	--END SECTION HEADS Not Shown

	
	UNION ALL

	--START SECTION HEADINGS
	SELECT DISTINCT
		tt.ID as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder * 1000 * 2 + 1000 Else tt.DisplayOrder * 1000 * 2 END + 1 As ReturnOrder--,
		,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ChecklistInstances ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0 )
	INNER JOIN
		QCheck_Checklists c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0)
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0

	INNER JOIN
		QStatus_GroupReport rgr
	ON
		rgr.ReportID = tt.ReportID
	INNER JOIN
		QCheck_Groups rg
	ON
		rg.ID = rgr.GroupID
	INNER JOIN
		QCheck_GroupMembership rgm
	ON
		rgm.GroupID = rg.ID
	AND
		rgm.UserID = @UserID

	INNER JOIN
		QStatus_Report r
	ON
		rgr.ReportID = r.ID
	AND
		r.IsDeleted = 0
	INNER JOIN
		QCheck_Assignments a
	ON
		a.InstanceID = ci.ID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = a.GroupID
	AND
		gm.UserID = @UserID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	--END SECTION HEADINGS

	
	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN AC.CompletedDate IS Not Null then 'Completed' else tt.Description end as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder * 1000 * 2 + 1000 Else tt.DisplayOrder * 1000 * 2 END + 999 As ReturnOrder--,
		,
		r.ID as ReportID,
		null As InstanceID,
		null As Assignees,
		null As Managers,
		null As Frequency,
		null As [Last Completed],
		null As nextduedate,
		null As UpcomingID,
		null As HistoryType,
		null As HistoryID
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ChecklistInstances ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0)
	INNER JOIN
		QCheck_Checklists c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0)
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0

	
	INNER JOIN
		QStatus_GroupReport rgr
	ON
		rgr.ReportID = tt.ReportID
	INNER JOIN
		QCheck_Groups rg
	ON
		rg.ID = rgr.GroupID
	INNER JOIN
		QCheck_GroupMembership rgm
	ON
		rgm.GroupID = rg.ID
	AND
		rgm.UserID = @UserID

	INNER JOIN
		QStatus_Report r
	ON
		rgr.ReportID = r.ID
	AND
		r.IsDeleted = 0
	INNER JOIN
		QCheck_Assignments a
	ON
		a.InstanceID = ci.ID
	
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = a.GroupID
	AND
		gm.UserID = @UserID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	
	UNION ALL
	
	--START SECTION
	SELECT DISTINCT
		ac.ID, 
		 c.Name as Description,
		--Convert(varchar, ac.DueTime, 101) as DueDate,
		ac.DueTime as DueDate,
		actt.Priority,
		CAST(itt.ID as varchar) As Comments,
		--Convert(varchar, UpdatedDate, 101) 
		0 as UpdatedDate,
		CAST(tt.ID as varchar) As Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		0 as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder * 1000 * 2 + 1000 Else tt.DisplayOrder * 1000 * 2 END + 100 + actt.Priority As ReturnOrder--,
		,
		r.ID as ReportID,
		ci.ID As InstanceID,
		dbo.QCheck_AssigneesList(isNull(ci.ID,0)) as Assignees,
		dbo.QCheck_ManagersList(isNull(c.ID,0)) as Managers,
		CASE 
			WHEN s.FreqType = 1 THEN
				'ONE TIME'
			WHEN s.FreqType = 2 THEN
				'DAILY'
			WHEN s.FreqType = 3 THEN
				'WEEKLY'
			WHEN s.FreqType = 4 THEN
				CASE WHEN s.FreqRecurrance = 4 THEN
					'QUARTERLY'
				ELSE
					'MONTHLY'
				END
			WHEN s.FreqType = 5 THEN
				'YEARLY'
		END As Frequency,
		isNull(ac.CompletedDate, aca.CompletedDate) as 'Last Completed',
		udt.duetime
		As nextduedate,
		udt.ID as upcomingID,
		CASE WHEN ac.CompletedDate IS NULL THEN
			2
		ELSE
			1
		END AS HistoryType,
		CASE WHEN ac.CompletedDate is null then
			aca.ID 
		ELSE
			ac.ID
		END As HistoryID
		--actt.ShowSupervisor
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ChecklistInstances ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0)
	INNER JOIN
		QCheck_Schedule s
	ON
		s.ID = ci.ScheduleID
	LEFT OUTER JOIN
		(SELECT a1.ID, a1.InstanceID, a1.completedDate
		FROM
			QCheck_ActiveChecklistArchive a1
		INNER JOIN
			(SELECT 
				InstanceID, MAX(completeddate) as completedDate
			FROM
				QCheck_ActiveChecklistArchive a
			GROUP BY
				 InstanceID
			) a2
		ON a1.InstanceID = a2.InstanceID and a1.completeddate = a2.completeddate
		) aca
	ON
		aca.InstanceID = ci.ID
	LEFT OUTER JOIN
		QCheck_UpcomingDueTimes udt
	ON
		udt.InstanceID = ci.ID
	AND
		udt.duetime <> ac.duetime
	LEFT OUTER JOIN
		QCheck_UpcomingDueTimes udt2
	ON
		udt2.InstanceID = ci.ID
	AND
		udt2.duetime < udt.duetime
	
	-- AND
		--udt.StartTime = ci.NextStartTime
	INNER JOIN
		QCheck_Checklists c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0)
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	INNER JOIN
		QStatus_InstanceTaskType itt
	ON
		itt.InstanceID = ci.ID
	AND
		itt.TaskType = tt.ID

	
	INNER JOIN
		QStatus_GroupReport rgr
	ON
		rgr.ReportID = tt.ReportID
	INNER JOIN
		QCheck_Groups rg
	ON
		rg.ID = rgr.GroupID
	INNER JOIN
		QCheck_GroupMembership rgm
	ON
		rgm.GroupID = rg.ID
	AND
		rgm.UserID = @UserID

	INNER JOIN
		QStatus_Report r
	ON
		rgr.ReportID = r.ID
	AND
		r.IsDeleted = 0
	INNER JOIN
		QCheck_Assignments a
	ON
		a.InstanceID = ci.ID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = a.GroupID
	AND
		gm.UserID = @UserID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	WHERE
		udt2.id is null
	--WHERE
		--tt.ReportID = @ReportID
	--AND (@showPersonalTasks = 1 OR actt.ShowSupervisor = 1)
	--END SECTION

	
	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ReportID FROM #result

	EXEC dbo.Audit_Set @userId, @recordIds, 'Report', 2
	

	SELECT * FROM #result ORDER BY ReportId, ReturnOrder
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetTaskTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetTaskTypes]
	@ReportID int,
	@userId int
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ID FROM QStatus_TaskTypes WHERE ReportId = @ReportID

	EXEC dbo.Audit_Set @userId, @recordIds, 'TaskType', 2

	SELECT 
		ID As ValStr,
		Replace(Replace(Replace(Replace(Description, '&', '&amp;'), '"', '&quot;'), '>', '&gt;'), '<', '&lt;') As KeyStr
	FROM
		QStatus_TaskTypes tt
	WHERE
		ReportID = @ReportID
	AND
		tt.IsDeleted = 0
	AND
		tt.NativeType = 0
	ORDER BY DisplayOrder
END
GO
/****** Object:  StoredProcedure [dbo].[Audit_Set]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROC [dbo].[Audit_Set]
	@userId INT,
	@recordIds RecordId READONLY,
	@recordType VARCHAR(50),
	@auditTypeId TINYINT
AS
BEGIN
	SET NOCOUNT ON

	IF @recordType = 'ActiveItem' BEGIN
		INSERT INTO dbo.Audit_ActiveItem (UserId, ActiveItemId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveActiveItem (
			 ID
			 ,ActiveChecklistID
			 ,ChecklistItemID
			 ,[Text]
			 ,CompletedDate
			 ,CompletedBy
			)
			SELECT 
			 itm.ID
			 ,ActiveChecklistID
			 ,ChecklistItemID
			 ,[Text]
			 ,CompletedDate
			 ,CompletedBy
			FROM dbo.QCheck_ActiveItems itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'ActiveChecklist' BEGIN
		INSERT INTO dbo.Audit_ActiveChecklist (UserId, ActiveChecklistId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveActiveChecklist (
			 ID
			 ,InstanceID
			 ,DueTime
			 ,OrigDueTime
			 ,ReminderDate
			 ,CompletedDate
			 ,HasNaggedDue
			 ,CompletedBy
			 ,IsNA
			 ,NAReason
			)
			SELECT 
			 itm.ID
			 ,InstanceID
			 ,DueTime
			 ,OrigDueTime
			 ,ReminderDate
			 ,CompletedDate
			 ,HasNaggedDue
			 ,CompletedBy
			 ,IsNA
			 ,NAReason
			FROM dbo.QCheck_ActiveChecklists itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'Item' BEGIN
		INSERT INTO dbo.Audit_Item (UserId, ItemId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveItem (
			 ID
			 ,ChecklistID
			 ,SequenceNum
			 ,ItemTypeID
			 ,[Text]
			 ,[URL]
			 ,IsDeleted
			)
			SELECT 
			 itm.ID
			 ,ChecklistID
			 ,SequenceNum
			 ,ItemTypeID
			 ,[Text]
			 ,[URL]
			 ,IsDeleted
			FROM dbo.QCheck_Items itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'Checklist' BEGIN
		INSERT INTO dbo.Audit_Checklist (UserId, ChecklistId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveChecklist (
			 ID
			 ,[Name]
			 ,IsDeleted
			 ,[Owner]
			 ,Template
			 ,CreateDate
			)
			SELECT 
			 itm.ID
			 ,[Name]
			 ,IsDeleted
			 ,[Owner]
			 ,Template
			 ,CreateDate
			FROM dbo.QCheck_Checklists itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'Comment' BEGIN
		INSERT INTO dbo.Audit_Comment (UserId, CommentId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveComment(
			 ID
			 ,ForeignKeyID
			 ,Comments
			 ,DisplayOrder
			 ,TabIn
			 ,CommentDt
			 ,Initials
			 ,UserID
			 ,ReplyID
			 ,SpecialTask
			)
			SELECT 
			 itm.ID
			 ,ForeignKeyID
			 ,Comments
			 ,DisplayOrder
			 ,TabIn
			 ,CommentDt
			 ,Initials
			 ,UserID
			 ,ReplyID
			 ,SpecialTask
			FROM dbo.QStatus_Comments itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'ApprovalChecklist' BEGIN
		INSERT INTO dbo.Audit_ApprovalChecklist(UserId, ApprovalChecklistId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveApprovalChecklist(
			 ID
			 ,ChangeRequestID
			 ,ChecklistID
			 ,[Name]
			 ,IsDeleted
			 ,[Owner]
			 ,Template
			 ,CRItemID
			)
			SELECT 
			 itm.ID
			 ,ChangeRequestID
			 ,ChecklistID
			 ,[Name]
			 ,IsDeleted
			 ,[Owner]
			 ,Template
			 ,CRItemID
			FROM dbo.QCheck_Approval_Checklists itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'ApprovalItem' BEGIN
		INSERT INTO dbo.Audit_ApprovalItem (UserId, ApprovalItemId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds

		IF @auditTypeId IN (3, 4) BEGIN
			INSERT INTO dbo.Audit_ArchiveApprovalItem(
			 ID
			 ,[ChangeRequestID]
			 ,[ItemID]
			 ,[ChecklistID]
			 ,[SequenceNum]
			 ,[ItemTypeID]
			 ,[Text]
			 ,[URL]
			 ,[IsDeleted]
			 ,[CRItemID]
			)
			SELECT 
			 itm.ID
			 ,[ChangeRequestID]
			 ,[ItemID]
			 ,[ChecklistID]
			 ,[SequenceNum]
			 ,[ItemTypeID]
			 ,[Text]
			 ,[URL]
			 ,[IsDeleted]
			 ,[CRItemID]
			FROM dbo.QCheck_Approval_Items itm
			INNER JOIN @recordIds src ON src.Id = itm.ID
		END
	END ELSE IF @recordType = 'TaskType' BEGIN
		INSERT INTO dbo.Audit_TaskType(UserId, TaskTypeId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds
	END ELSE IF @recordType = 'Report' BEGIN
		INSERT INTO dbo.Audit_Report(UserId, ReportId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds
	END ELSE IF @recordType = 'CommentArchived' BEGIN
		INSERT INTO dbo.Audit_CommentArchived(UserId, CommentArchivedId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds
	END ELSE IF @recordType = 'ChangeRequest' BEGIN
		INSERT INTO dbo.Audit_ChangeRequest(UserId, ChangeRequestId, AuditTypeId)
			SELECT @userId, Id, @auditTypeId FROM @recordIds
	END
END
GO
/****** Object:  StoredProcedure [dbo].[DailyApprovalChangeRequestSummary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[DailyApprovalChangeRequestSummary] as
begin

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @CRChecklists TABLE (
		CRID INT,
		ChecklistID INT
	)

	INSERT INTO @CRChecklists (CRID, ChecklistID)
		SELECT CR.[ID],
		dbo.QCheck_Approval_CRChecklistID(CR.[ID])
	FROM
		QCheck_Approval_ChangeRequests CR
	WHERE
		CR.IsActive = 1
		AND CR.Approved = 0
		AND CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		
	DELETE FROM @CRChecklists WHERE ChecklistID IS NULL

	SELECT 
		RU.FullName,
		CONVERT(varchar(100),CR.RequestDate,100) As RequestDate,
		CR.Comment,
		dbo.QCheck_Approval_CRChecklistName(CR.[ID]) AS ChecklistName,
		CU.Email as ApproverEmail
	INTO #tmpListOfChanges
	FROM 
		QCheck_Approval_ChangeRequests CR (nolock)
		INNER JOIN @CRChecklists CRC
			ON CR.[ID] = CRC.CRID
		INNER JOIN QCheck_ChecklistManagers CM (nolock)
			ON CM.ChecklistID = CRC.ChecklistID
			AND CM.IsDeleted = 0
		INNER JOIN QCheck_Groups G (nolock)
			ON CM.ManagerGroupID = G.[ID]
		INNER JOIN QCheck_GroupMembership GM (nolock)
			ON G.[ID] = GM.GroupID
		INNER JOIN QCheck_Users CU (nolock)
			ON GM.UserID = CU.[ID]
		INNER JOIN QCheck_Users RU (nolock)
			ON CR.RequestingUser = RU.[ID]
	WHERE
		CR.IsActive = 1
		AND CR.Approved = 0
		AND CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
	ORDER BY
		CU.Email, 
		RequestDate

declare csr cursor for
	select FullName,RequestDate,Comment,ChecklistName,ApproverEmail from #tmpListOfChanges

declare @MailBody varchar(8000)
declare @MailFrom varchar(1000)
declare @MailSubject varchar(5000)
declare @TableHeader varchar(1000)
declare @Link varchar(1000)

declare @FullName varchar(100)
declare @RequestDate varchar(100)
declare @Comment varchar(1000)
declare @ChecklistName varchar(1000)
declare @ApproverEmail varchar(100)
declare @CurrentApprover varchar(100)

set @CurrentApprover = ''
set @MailFrom = @FromAddress
set @TableHeader = '<tr style="background-color:#eee"><th style="width:200px">Requestor</th><th style="width:130px">Request Date</th><th style="width:400px">Task</th><th style="width:300px">Comment</th></tr>'
set @Link = 'To view the requested change(s), click <a href="' + @AppURL + '/ChangeRequests.aspx">here</a>.<br/><br/>'
set @MailBody = ''
set @MailSubject = @AppName + ' changes requiring approval'
SET @MailFrom = @AppName + '-ChangeRequest<' + REPLACE(@FromAddress, @AppName, @AppName + '-ChangeRequest') + '>'

open csr
fetch next from csr into @FullName,@RequestDate,@Comment,@ChecklistName,@ApproverEmail
while @@fetch_status=0
	begin
		if @CurrentApprover <> @ApproverEmail and @CurrentApprover <> ''
			begin
				set @MailBody = @Link + '<table border="1">' + @TableHeader + @MailBody + '</table>'
				EXEC [dbo].[XPSendEmail]
					@from = @MailFrom, 
					@to = @CurrentApprover,
					@subject = @MailSubject,
					@message = @MailBody, 
					@type = 'text/html', 
					@server = @MailServer

				set @MailBody = ''
			end

		set @MailBody = @MailBody + '<tr><td>' + @FullName + '</td>' +
						'<td>' + @RequestDate + '</td>' +
						'<td>' + @ChecklistName + '</td>' +
						'<td>' + @comment + '</td></tr>'
		set @CurrentApprover = @ApproverEmail

		fetch next from csr into @FullName,@RequestDate,@Comment,@ChecklistName,@ApproverEmail
	end
close csr
deallocate csr

-- send out the last email
if @MailBody <> ''
	begin
		set @MailBody = @Link + '<table border="1">' + @TableHeader + @MailBody + '</table>'
		EXEC dbo.xp_smtp_sendmail 
			@from = @MailFrom, 
			@to = @CurrentApprover,
			@subject = @MailSubject,
			@message = @MailBody, 
			@type = 'text/html', 
			@server = @MailServer
	end

drop table #tmpListOfChanges
end
GO
/****** Object:  StoredProcedure [dbo].[DeletePrioritySchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[DeletePrioritySchedule] 
	 @scheduleId int
AS
BEGIN
	Update Schedule_PriorityList set IsActive=0,ModifiedDate=GETDATE()
	where ScheduleID=@scheduleId
END

GO
/****** Object:  StoredProcedure [dbo].[DeleteSupervisorPriorityReportSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[DeleteSupervisorPriorityReportSchedule] 
	 @scheduleId int
AS
BEGIN
	Update Supervisor_PriorityList_Report_Schedule set IsActive=0,ModifiedDate=GETDATE()
	where ScheduleID=@scheduleId
END

GO
/****** Object:  StoredProcedure [dbo].[Email2dbImageChecklists_Process]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Email2dbImageChecklists_Process]
as
begin

	if exists (select 1 from [dbo].[Email2dbImageChecklists])
	begin
		declare @id int, @uid varchar(1000), @checklistid int, @email2dbmimetext varchar(max)
		
		declare @process table
		(
			id int,
			uid varchar(1000),
			checklist int,
			email2dbmimetext varchar(max)
		)

		declare @imagetable table(
			imageid int identity(1,1),
			imagehtml varchar(max)
		)

		insert into @process
			select e.id, e.uid, e.checklistid, convert(varchar(max), ee.email)
			from [Email2dbImageChecklists] e
				inner join vwEmail2DB ee
					on e.uid = ee.uid

		while exists (select 1 from @process)
		begin
			select top 1 @id= id, @uid= uid, @checklistid = checklist, @email2dbmimetext = email2dbmimetext 
			from @process

			if len(@email2dbmimetext) > 0
			begin

				delete from @imagetable
				insert into @imagetable select imghtml from dbo.fn_MimeTextToBase64Images(@email2dbmimetext)
				declare @imageid int = 0
				declare @imagehtml varchar(max)
				while exists (select imageid from @imagetable) begin
					select top 1 @imageid = imageid, @imagehtml = imagehtml from @imagetable
		
					EXEC [dbo].[QCheck_AddItem] @ChecklistID = @ChecklistID, @ItemTypeID = 5, @Text = @imagehtml, @URL = ''
			
					delete from @imagetable where imageid = @imageid
				end
			end

			delete from @process where id = @id
			delete from [Email2dbImageChecklists] where id = @id
		end
	end
end
GO
/****** Object:  StoredProcedure [dbo].[EmailPriorityScheduleChange]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[EmailPriorityScheduleChange]
	
AS
BEGIN

SET DATEFIRST 1;

Create table #ScheduleChangedEmployees
(
  seq int identity(1,1),
  EmpEmail varchar(100),
  EmpID int
)

insert into #ScheduleChangedEmployees(EmpEmail,EmpID)
select distinct qu.Email,pl.EmployeeID from Schedule_PriorityList pl
inner join QCheck_Users qu on qu.id=pl.EmployeeID
 where Convert(date,CreatedDate)=Convert(date,Getdate()) and IsActive=1

Declare @counter int=1
declare @ScheduleChangeCount int=1;
   
declare @appname varchar(100), @mailfrom varchar(100)
select top 1 @appname = appname, @mailfrom = 'sqlmail@' + basedomain from QCheck_AppSettings
declare @emailsubject varchar(1000) = @appname + ' Priority Schedule Change'

select @ScheduleChangeCount=count(*) from #ScheduleChangedEmployees

while(@counter<=@ScheduleChangeCount)
Begin
DECLARE @body NVARCHAR(MAX)
SET @body ='<html><body><H3>'+@appname+' Priority Scheduling has changed</H3><br>
            <table border = 1>
			<tr>
            <th> Day </th> <th> Time </th></tr>'
Declare @EmpEmail varchar(100);
Declare @EmpID int;
select @EmpEmail=EmpEmail,@EmpID=EmpID from #ScheduleChangedEmployees where Seq=@counter
DECLARE @xml NVARCHAR(MAX)

SET @xml = CAST(( SELECT (Case when DaysOfWeek=1
                          THen 'Monday'
						   when DaysOfWeek=2
						   Then 'Tuesday'
						   when DaysOfWeek=3
						   Then 'Wednesday'
						   when DaysOfWeek=4
						   Then 'Thursday'
						   when DaysOfWeek=5
						   Then 'Friday'
						   when DaysOfWeek=6
						   Then 'Saturday'
						   when DaysOfWeek=7
						   Then 'Sunday'
						   End)AS 'td','',CONVERT(varchar(15),CAST(TimesOfDay AS TIME),100) AS 'td'
FROM  Schedule_PriorityList where EmployeeID=@EmpID and IsActive=1 order by DaysOfWeek 
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))

SET @body = @body + @xml +'</table></body></html>'
exec dbo.xp_smtp_sendmail
				@FROM       = @mailfrom,
				@FROM_NAME  = @appname,
				@TO         = @EmpEmail,
				@CC         = '',
				@subject    = @emailsubject,
				@message    = @body,
				@type       = 'text/html'
set @counter=@counter+1
End


END

GO
/****** Object:  StoredProcedure [dbo].[Entity_UpcomingActionItems_EMAIL]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE     PROCEDURE [dbo].[Entity_UpcomingActionItems_EMAIL] AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @today VARCHAR(20)
	DECLARE @sub VARCHAR(100)
	DECLARE @To_List VARCHAR(250) = (SELECT TOP 1 EntityToAddress FROM QCheck_AppSettings)
	DECLARE @FromAddress VARCHAR(50) = (SELECT TOP 1 EntityFromAddress FROM QCheck_AppSettings)

	SET @sub = 'Upcoming Action Items'
	
	DECLARE @Count INT
	SELECT 
		@Count = COUNT(*) 
	FROM 
		QCheck_Checklists C
		INNER JOIN QCheck_ChecklistInstances CI
			ON C.ID = CI.ChecklistID
		INNER JOIN QCheck_Schedule Sch
			ON Sch.ID = CI.ScheduleID
		INNER JOIN (
			SELECT InstanceID, MIN(DueTime) AS DueTime
			FROM (
				SELECT InstanceID, MIN(DueTime) AS DueTime
				FROM QCheck_ActiveChecklists
				WHERE CompletedDate IS NULL
				GROUP BY InstanceID
		
				UNION	
		
				SELECT InstanceID, MIN(DueTime) AS DueTime
				FROM QCheck_UpcomingDueTimes
				GROUP BY InstanceID		
			) A
			GROUP BY InstanceID
		) DT
			ON CI.ID = DT.InstanceID
		INNER JOIN QStatus_InstanceTaskType ITT
			ON ITT.InstanceID = CI.ID
		INNER JOIN QStatus_TaskTypes TT
			ON ITT.TaskType = TT.ID
		INNER JOIN QStatus_Report R
			ON TT.ReportID = R.ID
		INNER JOIN QCheck_Assignments A
			ON A.InstanceID = CI.ID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = A.GroupID
		INNER JOIN QCheck_Users U
			ON U.ID = gm.UserID
	WHERE
		A.IsDeleted = 0
		AND R.Name LIKE '%Entity Compliance Status%'
		AND DT.DueTime < DATEADD(d, 14, GETDATE())
	
	IF @Count > 0 BEGIN

	    declare @html table (id int identity(1,1), html varchar(max))
		insert into @html exec Entity_UpcomingActionItems_HTML
		declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end
		
		exec [dbo].[xp_smtp_sendmail]
			@to = @to_list,
			@from = @FromAddress,
			@subject = @sub,
			@message = @htmlstr
	END

	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[Entity_UpcomingActionItems_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE    PROCEDURE [dbo].[Entity_UpcomingActionItems_HTML] AS

DECLARE @work TABLE (
	seq INT IDENTITY(1,1),
	FullName VARCHAR(100),
	ChecklistName VARCHAR(500),
	DueTime VARCHAR(10)
)

DECLARE @out TABLE (
	seq INT IDENTITY(1,1),
	row VARCHAR(1000)
)

DECLARE @i INT,
	@count INT,
	@cname VARCHAR(100),
	@FullName VARCHAR(100),
	@ChecklistName VARCHAR(500),
	@DueTime VARCHAR(10)

INSERT INTO @work (
	FullName,
	ChecklistName,
	DueTime
)
	SELECT 
		U.FullName,
		C.Name,
		CONVERT(VARCHAR(10), DT.DueTime, 101) AS DueTime
	FROM 
		QCheck_Checklists C
		INNER JOIN QCheck_ChecklistInstances CI
			ON C.ID = CI.ChecklistID
		INNER JOIN QCheck_Schedule Sch
			ON Sch.ID = CI.ScheduleID
		INNER JOIN (
			SELECT InstanceID, MIN(DueTime) AS DueTime
			FROM (
				SELECT InstanceID, MIN(DueTime) AS DueTime
				FROM QCheck_ActiveChecklists
				WHERE CompletedDate IS NULL
	--			AND DueTime > GETDATE()
				GROUP BY InstanceID
		
				UNION	
		
				SELECT InstanceID, MIN(DueTime) AS DueTime
				FROM QCheck_UpcomingDueTimes
	--			WHERE DueTime > GETDATE()
				GROUP BY InstanceID		
			) A
			GROUP BY InstanceID
		) DT
			ON CI.ID = DT.InstanceID
		INNER JOIN QStatus_InstanceTaskType ITT
			ON ITT.InstanceID = CI.ID
		INNER JOIN QStatus_TaskTypes TT
			ON ITT.TaskType = TT.ID
		INNER JOIN QStatus_Report R
			ON TT.ReportID = R.ID
		INNER JOIN QCheck_Assignments A
			ON A.InstanceID = CI.ID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = A.GroupID
		INNER JOIN QCheck_Users U
			ON U.ID = gm.UserID
	WHERE
		A.IsDeleted = 0
		AND R.Name LIKE '%Entity Compliance Status%'
		AND DT.DueTime < DATEADD(d, 14, GETDATE())
	ORDER BY
		U.FullName, DueTime

SET @count = @@IDENTITY
SET @i = 1
SET @cname = ''

INSERT INTO @out (row) VALUES ('<h1>Entity Action Items</h1>')
INSERT INTO @out (row) VALUES ('<table width="80%">')
INSERT INTO @out (row) VALUES ('<tr><td colspan="2" style="background-color:#DDDDDD;"><b>All Action Items due or coming due next 14 days</b></td></tr>')
INSERT INTO @out (row) VALUES ('<tr><td align="center"><b>Item</b></td><td align="center" width="100px"><b>Due Date</b></td>')

WHILE @i < @count BEGIN
	
	SELECT
		@FullName = FullName,
		@ChecklistName = ChecklistName,
		@DueTime = DueTime
	FROM
		@work
	WHERE
		seq = @i

	IF @cname <> @FullName BEGIN
		--Write a new name header row into the output
		INSERT INTO @out (row) VALUES ('<tr><td colspan="2" style="background-color:#DDDDDD;"><b>' + @FullName + '</b></td></tr>')
		SET @cname = @FullName
	END

	INSERT INTO @out (row) VALUES ('<tr><td>' + @ChecklistName + '</td><td align="center">' + @DueTime + '</td></tr>')
	
	SET @i = @i + 1
END

INSERT INTO @out (row) VALUES ('</table>')

SELECT row FROM @out ORDER BY seq





GO
/****** Object:  StoredProcedure [dbo].[Excuse_OverdueTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[Excuse_OverdueTask] 
	@Id int
    ,@excusedBy int
	,@comment varchar(5000)='' --added by venkat 04/16/2018
	,@DueDate datetime=''--added by venkat 05/11/2018
AS
BEGIN

	declare @appname varchar(100)
	select top 1 @appname = appname from QCheck_AppSettings


	/*
	--Update OverDueTasks_LateFee_Log set IsActive=0,ExcusedDt=GetDate(),ExcusedBy=@excusedBy where Id=@Id --updated by venkat on 02/23/2018
	INSERT INTO    [AcmeDotNet].[dbo].[empFines]
           ([SourceId]
           ,[EmpId]
           ,[Charge]
           ,[ChargeSource]
           ,[ChargeDesc]
           ,[ChargeDate]
           ,[CreatedDate]
           )
	select 
	Id
	,(select empid from qcheck_users where id=OVL.EmpID)
	,-5
	,@appname + '-Overdue'
	,@appname + '-Overdue-Excuse-'+TaskName
	,DueDate
	,GetDate()
    from 
	OverDueTasks_LateFee_Log OVL
	--where ActiveChecklistId=@Id and Convert(date,DueDate)=Convert(Date,@DueDate)
	where Id=@Id and Convert(date,DueDate)=Convert(Date,@DueDate)--added by venkat 10/01/2018

	--Update OverDueTasks_LateFee_Log set IsActive=0,ExcusedDt=GetDate(),ExcusedBy=@excusedBy where ActiveChecklistId=@Id and Convert(date,DueDate)=Convert(Date,@DueDate) --updated by venkat on 05/11/2018
	Update OverDueTasks_LateFee_Log set IsActive=0,ExcusedDt=GetDate(),ExcusedBy=@excusedBy where Id=@Id and Convert(date,DueDate)=Convert(Date,@DueDate) --added by venkat 10/01/2018
	
	

	

	DECLARE @BodyController varchar(max), @Subject varchar(100),@MailServer VARCHAR(50),@assigneeEmailAddress VARCHAR(1000)

	SELECT @MailServer = MailServer 
		FROM QCheck_AppSettings WHERE ID = 1

	--select @assigneeEmailAddress=Email from QCheck_Users where id=(select EmpId from OverDueTasks_LateFee_Log where Id=@id )
	

	    SET @assigneeEmailAddress = CAST(( SELECT distinct email as [text()] ,';'
    --FROM  OverDueTasks_LateFee_Log where Id =@Id 
	--from QCheck_Users where id in (select EmpId from OverDueTasks_LateFee_Log where ActiveChecklistId=@id and Convert(date,DueDate)=COnvert(date,@DueDate)) --updated by venkat 05/11/2018
	from QCheck_Users where id in (select EmpId from OverDueTasks_LateFee_Log where Id=@id and Convert(date,DueDate)=COnvert(date,@DueDate)) --added by venkat 10/01/2018
    FOR XML PATH(''), ELEMENTS ) AS NVARCHAR(MAX))

	SET @bodyController ='<html><body><H3>Below task has been Excused</H3>
            <table border = 1>
			<tr>
            <th> Task </th>
			<th>Assignee</th>
			<th>Due Date</th>
			<th>Comment</th></tr>'
	DECLARE @xml NVARCHAR(MAX)

	Declare @assignee varchar(100)=''
	select @assignee=FullName from QCheck_Users U where U.Id=(select empID from OverDueTasks_LateFee_Log where Id=@id)--added by venkat 10/01/2018

    SET @xml = CAST(( SELECT distinct TaskName AS 'td','',(select FullName from QCheck_Users U where U.ID=OVL.EmpID) AS 'td','',Convert(varchar,DueDate,100) AS 'td','',@comment AS 'td',''
    --FROM  OverDueTasks_LateFee_Log where Id =@Id 
	--FROM  OverDueTasks_LateFee_Log where ActiveChecklistId =@Id and Convert(Date,DueDate)=Convert(date,@DueDate) --updated by venkat 05/11/2018
	FROM  OverDueTasks_LateFee_Log OVL where Id =@Id and Convert(Date,DueDate)=Convert(date,@DueDate)--added by venkat 10/01/2018
    FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))

    SET @bodyController = @bodyController + @xml +'</table></body></html>'

	EXEC dbo.xp_smtp_sendmail --this email is for Assignee
		@from = 'overdueExcused@automation.acmenetwork.com', 
		@to = @assigneeEmailAddress, 
		
		@subject = 'Overdue Task Excused',
		@message = @bodyController, 
		@type = 'text/html', 
		@server = @MailServer
		*/
END


GO
/****** Object:  StoredProcedure [dbo].[Excuse_OverdueTaskCharges_Email]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Excuse_OverdueTaskCharges_Email] 
	@IsExcused VARCHAR(10),
	@TaskIds VARCHAR(100),
    @fromEmailAddress VARCHAR(400),
	@toEmailAddress VARCHAR(400),
	@comment VARCHAR(5000)='', 
    @DueDate DATETIME=''
AS
  BEGIN
      IF( Upper(@IsExcused) = 'ALL'
           OR Upper(@IsExcused) = 'Y' )--only process if its get these values
        BEGIN
            DECLARE @AppURL            VARCHAR(50),
                    @ImagesURL         VARCHAR(50),
                    @ExternalURL       VARCHAR(50),
                    @BaseDomain        VARCHAR(50),
                    @AppFromAddress    VARCHAR(50),
                    @AppName           VARCHAR(50),
                    @GradingAddress    VARCHAR(50),
                    @AutomationAddress VARCHAR(50),
                    @DeveloperAddress  VARCHAR(50),
                    @ITAddress         VARCHAR(50),
                    @MailServer        VARCHAR(50),
					@OverdueExcusedFromAddress VARCHAR(100) = (SELECT TOP 1 OverdueExcusedAddress FROM QCheck_AppSettings)

            SELECT @AppURL = appurl,
                   @ImagesURL = imagesurl,
                   @ExternalURL = externalurl,
                   @BaseDomain = basedomain,
                   @AppFromAddress = fromaddress,
                   @Appname = appname,
                   @GradingAddress = gradingaddress,
                   @AutomationAddress = automationaddress,
                   @DeveloperAddress = developeraddress,
                   @ITAddress = itaddress,
                   @MailServer = mailserver
            FROM   qcheck_appsettings
            WHERE  id = 1

            DECLARE @Body    VARCHAR(max),
                    @Subject VARCHAR(100)
            DECLARE @ExcuseEmailAdditionalToList VARCHAR(500)

            SELECT @ExcuseEmailAdditionalToList = permissionvalue
            FROM [app_specificpermissions]
            WHERE  appid = @Appname
                   AND permissiontype = 'overdueexcuseemail'

            DECLARE @processExcuse BIT=1
            DECLARE @isSupervisor BIT=0

            IF EXISTS(SELECT 1
                      FROM   qcheck_users
                      WHERE  id IN (SELECT gm2.userid
                                    FROM   qstatus_report r
                                           INNER JOIN qstatus_groupreport gr
                                                   ON gr.reportid = r.id
                                                      AND gr.defaultreport = 1
                                           INNER JOIN qcheck_groups g
                                                   ON g.id = gr.groupid
                                           INNER JOIN qcheck_groupmembership gm
                                                   ON gm.groupid = g.id
                                           --and gm.userID = 652
                                           INNER JOIN qstatus_supervisors s
                                                   ON r.id = s.reportid
                                                      AND s.interestedparty = 0
                                           --and r.isdeleted = 0
                                           INNER JOIN qcheck_groups g2
                                                   ON
                                           g2.id = s.supervisorgroupid
                                           INNER JOIN qcheck_groupmembership gm2
                                                   ON gm2.groupid = g2.id)
                             AND isdeleted = 0
                             AND email = @fromEmailAddress)
              BEGIN
                  SET @isSupervisor=1
              END

            IF( @isSupervisor = 0 )
              BEGIN
                  IF NOT EXISTS(SELECT 1
                                FROM   dbo.Util_Split(@toEmailAddress, ',')
                                WHERE  data IN
                                (SELECT data
                                 FROM
                         dbo.Util_Split(@ExcuseEmailAdditionalToList, ';')))
                    --if non supervisor did not include partners in the to list don't process it
                    BEGIN
                        SET @processExcuse=0
                    END
              END

            IF( @processExcuse = 1 )
              BEGIN
                  SET @DueDate=CONVERT(DATETIME, @DueDate, 120)
                  --added by venkat 05/11/2018
                  CREATE TABLE #overduetasks
                    (
                       id     INT,
                       taskid INT
                    )

                  DECLARE @controller VARCHAR(100)

                  SELECT @controller = fullname
                  FROM   qcheck_users
                  WHERE  email = @fromEmailAddress
                         AND isdeleted = 0

                  INSERT INTO #overduetasks
                              (id,
                               taskid)
                  SELECT Row_number()
                           OVER (
                             ORDER BY id),
                         data
                  FROM   dbo.Util_Split(@TaskIds, ',')

                  DECLARE @overdueTaskCount INT=1
                  DECLARE @overdueTaskCounter INT=1
                  DECLARE @taskId INT=0

                  SELECT @overdueTaskCount = Count(*)
                  FROM   #overduetasks

                  --edge case, using ALL within a single task cell means excusing all the tasks for that person
                  IF( Upper(@IsExcused) = 'ALL' )
                    AND @overdueTaskCount = 1
                    BEGIN
                        SELECT @taskId = taskid
                        FROM   #overduetasks

                        DELETE FROM #overduetasks

                        DECLARE @assignee INT

                        SELECT @assignee = empid
                        FROM   overduetasks_latefee_log
                        WHERE  id = @taskId

                        INSERT INTO #overduetasks
                                    (id,
                                     taskid)
                        SELECT Row_number()
                                 OVER (
                                   ORDER BY id),
                               id
                        FROM   overduetasks_latefee_log
                        WHERE  empid = @assignee
                               AND isactive = 1
                               AND CONVERT(DATE, duedate) =
                                   CONVERT(DATE, @DueDate)

                        SELECT @overdueTaskCount = Count(*)
                        FROM   #overduetasks
                    END

                  WHILE ( @overdueTaskCounter <= @overdueTaskCount )
                    BEGIN
                        SELECT @taskId = taskid
                        FROM   #overduetasks
                        WHERE  id = @overdueTaskCounter

                        IF( EXISTS(SELECT 1
                                   FROM   overduetasks_latefee_log
                                   WHERE  id = @taskId
                                          AND controllername LIKE '%' +
                                              @controller +
                                                                  '%'
                                          AND isactive = 1
                                          AND CONVERT(DATE, duedate) =
                                              CONVERT(DATE, @DueDate)
                                  ) )
                          --added by venkat 10/01/2018
                          BEGIN
                              DECLARE @excusedBy INT

                              SELECT @excusedBy = id
                              FROM   qcheck_users
                              WHERE  email = @fromEmailAddress
                                     AND isdeleted = 0
                              --added by venkat 02/23/2018

                              EXEC Excuse_overduetask
                                @Id=@taskId,
                                @excusedBy=@excusedBy,
                                @comment=@comment,
                                @DueDate=@DueDate --added by venkat 02/23/2018
                          END

                        SET @overdueTaskCounter=@overdueTaskCounter + 1
                    END

                  SET @body ='<html><body><H3>Below tasks have been successfully overridden</H3><br> <table border = 1> <tr> <th>Tasks</th> <th>Assignee</th> <th>Due Date</th> <th>Comment</th> </tr>'

                  DECLARE @xml NVARCHAR(max)

                  SET @xml = Cast((SELECT DISTINCT taskname
                                                   AS
                                                   'td',
                                                   '',
                                                   (SELECT fullname
                                                    FROM   qcheck_users U
                                                    WHERE  U.id = OVL.empid)
                                                   AS
                                                   'td',
                                                   '',
                                                   CONVERT(VARCHAR, duedate, 100
                                                   )
                                                   AS
                                                   'td',
                                                   '',
                                                   @comment
                                                   AS
                                                   'td',
                                                   ''
                                   FROM   overduetasks_latefee_log OVL
                                   WHERE  id IN(SELECT taskid
                                                FROM   #overduetasks)
                                          AND controllername LIKE '%' +
                                              @controller +
                                                                  '%'
                                          AND CONVERT(DATE, duedate) =
                                              CONVERT(DATE, @DueDate)
                                   --added by venkat 10/01/2018
                                   FOR xml path('tr'), elements) AS
                                  NVARCHAR(max))

                  IF Len(@xml) > 0
                    BEGIN
                        SET @body = @body + @xml + '</table></body></html>'

                        EXEC dbo.Xp_smtp_sendmail
                          --this email is for Controller
                          @from = @OverdueExcusedFromAddress,
                          @to = @fromEmailAddress,
                          @subject = 'Overdue Tasks Excused',
                          @message = @Body,
                          @type = 'text/html',
                          @server = @MailServer
                    END
              END
            ELSE
              BEGIN
                  -- Get app configuration
                  DECLARE @ExcuseEmail VARCHAR(500)

                  SELECT @ExcuseEmail = permissionvalue
                  FROM [app_specificpermissions]
				  WHERE  appid = @Appname
				  AND permissiontype = 'excuseemail'

				  SET @Body = 'Unable to record overdue excuse sent from '
							  + @fromEmailAddress + ' to ' + @toEmailAddress
							  +
				  '.<br/><br/>Please make sure to also include partners('
							  + @ExcuseEmailAdditionalToList
							  + ') in the To address list'
				  SET @Subject = 'Overdue Excuse Email Failed'

				  EXEC dbo.xp_smtp_sendmail
					@from = @AppFromAddress,
					@to = @fromEmailAddress,
					@cc = @ExcuseEmail,
					@subject = @Subject,
					@message = @Body,
					@type = 'text/html',
					@server = @MailServer
			  END
        END
  END 
GO
/****** Object:  StoredProcedure [dbo].[FirmWideStatus_Get]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  proc [dbo].[FirmWideStatus_Get] AS

select ac.duetime, g.name, completeddate from
qcheck_activechecklists ac
inner join qcheck_activeassignments aa
on ac.id = aa.activechecklistid
inner join qcheck_assignments a
on a.id = aa.assignmentsid
inner join qcheck_groups g
on a.groupid = g.id
where ac.instanceid in (
	select id from qcheck_checklistinstances where checklistid = 117561
)
and ac.duetime > getdate()
order by 2, 1

GO
/****** Object:  StoredProcedure [dbo].[FirmWideStatus_Set]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  proc [dbo].[FirmWideStatus_Set]
	
 @newduedate datetime

AS
BEGIN
	--9/19/2014
	--concepts too complicated for admins to understand - simplifying this - 
	--get rid of all recurrances other than the NEXT one.  Move the NEXT one to the date specified.
	
	--9/14/2015 - admins still having trouble with this - this time someone manually moved a deadline
	--and also tried to use the automated tool, and they conflicted so simplified it further - hopefully fool proof now.
	--instead of looking for 1 due date and moving all of them that are on that 1 date, 
	--just move all the ones that are greater than @today
	
	declare @checklistid int = 117561
	declare @meetinghour int = 11
	declare @today datetime = convert(varchar, getdate(), 101)
	
	--set the recurrance time to midnight
	select @newduedate = convert(varchar, @newduedate, 101)
	
	--set the bi-weekly recurring component to the next due date
	update qcheck_schedule
	set firstduedate = @newduedate
	where id in (
		select scheduleID from qcheck_checklistinstances where checklistid = @checklistid
	)
	
	--get rid of extra appointments in the future
	delete qcheck_activechecklists
	from qcheck_activechecklists ac
		inner join (select * from qcheck_activechecklists) ac2
			on ac2.instanceid = ac.instanceid
			and (ac2.duetime < ac.duetime or (ac2.duetime = ac.duetime and ac2.ID < ac.ID))
			and ac2.duetime > @today and ac.duetime > @today
	where ac.instanceid in (
		select id from qcheck_checklistinstances where checklistid = @checklistid
	)
	
	--set the meeting time
	select @newduedate = dateadd(hour, @meetinghour, @newduedate)
	
	--set it to the new due date
	update  qcheck_activechecklists
	set duetime = @newduedate, reminderdate = @newduedate, completeddate = null, completedby = null, hasnaggeddue = 0
	where duetime > @today
	and instanceid in (
		select id from qcheck_checklistinstances where checklistid = @checklistid
	)
END

GO
/****** Object:  StoredProcedure [dbo].[GetEmpCurrentBalanceFromPersonalExpenses]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetEmpCurrentBalanceFromPersonalExpenses] 
	@employeeId int
AS
BEGIN
	SELECT 
        Convert(Decimal(5,2),[CurrentBalance]) as CurrentBalance,Convert(Decimal(5,2),CreditLimit) as CreditLimit
  FROM [vw_empPersonalCharges] where empID=(select empID from QCheck_Users where Id=@employeeId and IsDeleted=0)
  and 1=0
END
GO
/****** Object:  StoredProcedure [dbo].[GetEmployeePrioritySchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetEmployeePrioritySchedule] 
@employeeId int
As	
BEGIN
--Declare @userId int=0;

--SELECT @userId=p.userid
--	FROM PriorityListUsers p
--	INNER JOIN QCheck_Users u
--	ON p.UserID = u.ID
--	WHERE p.SetID = (select Max(PreferenceValue) from QStatus_Preferences where UserID=@employeeId and PreferenceType='LastPrioritySet')
--	ORDER BY DisplayOrder

--if(@userId=@employeeId)
--Begin

SELECT 
       (Select FullName from QCheck_Users where ID=SupervisorID) as SupervisorName
      ,(Select FullName from QCheck_Users where ID=EmployeeID) as EmployeeName
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
     
  FROM [dbo].[Schedule_PriorityList] where IsActive=1 and EmployeeID=@employeeId
  order by EmployeeName,DaysOfWeek
  --End
END
GO
/****** Object:  StoredProcedure [dbo].[GetMisssedPriorityLists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetMisssedPriorityLists] 
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null
--@supervisor int
AS
BEGIN

set @ReportStartDate=ISNULL(@ReportStartDate,'01/01/1900')
set @ReportEndDate=ISNULL(@ReportEndDate,Convert(Date,Getdate()))
SELECT  lateFeeLog.Id
      ,lateFeeLog.EmpID
	  ,users.FullName as Employee
      ,Convert(Date,LateDate) as LateDate
      ,[LateCharge]
      ,[IsActive]
      ,[IsPaid]
  FROM [PriorityList_LateFee_Log] lateFeeLog
  Inner join QCheck_Users users on lateFeeLog.EmpID=users.ID
  where IsActive=1 and lateFeeLog.LateDate>=@ReportStartDate and lateFeeLog.LateDate<=@ReportEndDate
  order by Employee
END
GO
/****** Object:  StoredProcedure [dbo].[GetOverdueTaskChargesReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetOverdueTaskChargesReport]
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null
--@supervisor int
AS
BEGIN
select Sum(LateCharge) as LateCharge,Count(*) as LateCount,AssigneeName  from OverDueTasks_LateFee_Log latefee 
where IsActive=1 and Convert(Date,AsofDate)>=Convert(Date,@ReportStartDate) and Convert(Date,AsofDate)<=Convert(Date,@ReportEndDate)
group by AssigneeName

END



GO
/****** Object:  StoredProcedure [dbo].[GetOverdueTasks_EmployeeList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetOverdueTasks_EmployeeList]
	@ReportDate datetime
AS
BEGIN

declare @appname varchar(100)
select top 1 @appname = appname from QCheck_AppSettings

select latefee.*,controller.Email as ControllerEmail,Assignee.Email as AssigneeEmail,(case when supervisorsList.fullname is null then 0 else 1 End) as IsControllerSupervisor  
,(SELECT PermissionValue from [APP_SpecificPermissions]
		WHERE appID = @appname and permissiontype = 'overdueexcuseemail')ExcuseAdditionalEmail
from OverDueTasks_LateFee_Log latefee
left join QCheck_Users Controller on latefee.ControllerName=Controller.FullName and Controller.IsDeleted=0
--inner join QCheck_Users Assignee on latefee.AssigneeName=Assignee.FullName--commented by venkat 04/17/2018
inner join QCheck_Users Assignee on latefee.EmpID=Assignee.ID--added by venkat 04/17/2018 
and Assignee.IsDeleted=0

left join
 (select fullname, email from
	qcheck_users
	where id in
	(
		
		select gm2.userid from qstatus_report r
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g
		on g.id = gr.groupid
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		--and gm.userID = 652
		inner join qstatus_supervisors s
		on r.id = s.reportid
		and s.interestedparty = 0
		--and r.isdeleted = 0
		inner join qcheck_groups g2
		on g2.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id

	)
	and isdeleted = 0
	) supervisorsList  on Controller.FullName=supervisorsList.fullname
where latefee.IsActive=1 
and Convert(Date,@ReportDate)=Convert(Date,AsofDate) 

END



GO
/****** Object:  StoredProcedure [dbo].[GetOverdueTasks_EmployeeList_Controller]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetOverdueTasks_EmployeeList_Controller]
	@ReportDate datetime
AS
BEGIN

declare @appname varchar(100)
select top 1 @appname = appname from QCheck_AppSettings

CREATE TABLE #OverDueTasks_LateFee_Temp(
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[ActiveChecklistId] [bigint] NULL,
	[TaskName] [varchar](max) NULL,
	[ControllerName] [varchar](500) NULL,
	[AssigneeName] [varchar](500) NULL,
	[DueDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	
	
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	TaskId bigint null
	)
	
CREATE TABLE #OverDueTasks_LateFee_Temp_MultiController(
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[EmpID] [int] NULL,
	[ActiveChecklistId] [bigint] NULL,
	[TaskName] [varchar](max) NULL,
	[ControllerName] [varchar](500) NULL,
	[AssigneeName] [varchar](500) NULL,
	[DueDate] [datetime] NULL,
	[CompletedDate] [datetime] NULL,
	
	
	[LateCharge] [float] NULL,
	[IsActive] [bit] NULL,
	TaskId bigint null
	)
Insert into #OverDueTasks_LateFee_Temp
(
     [EmpID]
           ,[ActiveChecklistId]
           ,[TaskName]
           ,[ControllerName]
           ,[AssigneeName]
           ,[DueDate]
           ,[CompletedDate]
          
           ,[LateCharge]
           ,[IsActive] 
		   ,TaskId
)
     select [EmpID]
           ,[ActiveChecklistId]
           ,[TaskName]
           ,[ControllerName]
           ,[AssigneeName]
           ,[DueDate]
           ,[CompletedDate]
          
           ,[LateCharge]
           ,[IsActive]
		   ,Id
		    from OverDueTasks_LateFee_Log where IsActive=1 
and Convert(Date,@ReportDate)=Convert(Date,AsofDate) 
and  dbo.[Util_fn_Split_Count](ControllerName,',')=1--insert records with one controller

Insert into #OverDueTasks_LateFee_Temp_MultiController
(
     [EmpID]
           ,[ActiveChecklistId]
           ,[TaskName]
           ,[ControllerName]
           ,[AssigneeName]
           ,[DueDate]
           ,[CompletedDate]
          
           ,[LateCharge]
           ,[IsActive] 
		   ,TaskId
)
     select [EmpID]
           ,[ActiveChecklistId]
           ,[TaskName]
           ,[ControllerName]
           ,[AssigneeName]
           ,[DueDate]
           ,[CompletedDate]
          
           ,[LateCharge]
           ,[IsActive]
		   ,Id
		    from OverDueTasks_LateFee_Log where IsActive=1 
and Convert(Date,@ReportDate)=Convert(Date,AsofDate)
and  dbo.[Util_fn_Split_Count](ControllerName,',')>1--insert records with more than one controller

Declare @counter int=1
Declare @recordCount int =0

select @recordCount=count(*) from #OverDueTasks_LateFee_Temp_MultiController

while (@counter<=@recordCount)
Begin
Declare @controller varchar(500)
select @controller=ControllerName from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter
Create table #ControllerList
([Id] [bigint] IDENTITY(1,1) NOT NULL,
  Name varchar(100) NULL
 )
 Insert into #ControllerList(Name)
 select c from dbo.Util_fn_List_To_Table(@controller,',')
 Declare @controllerCounter int =1
 Declare @controllerCount int =0
 select @controllerCount=count(*) from #ControllerList
 while(@controllerCounter<=@controllerCount)
 Begin
 Insert into #OverDueTasks_LateFee_Temp
(
     [EmpID]
           ,[ActiveChecklistId]
           ,[TaskName]
           ,[ControllerName]
           ,[AssigneeName]
           ,[DueDate]
           ,[CompletedDate]
          
           ,[LateCharge]
           ,[IsActive] 
		   ,TaskId
)
Values((select EmpId from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
       ,(select ActiveChecklistId from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter) 
	   ,(select TaskName from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
	   ,(select Name from #ControllerList where Id=@controllerCounter)
	   ,(select AssigneeName from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
	   ,(select DueDate from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
	   ,(select CompletedDate from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
	   ,(select LateCharge from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
	   ,(select IsActive from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)
	    ,(select TaskId from #OverDueTasks_LateFee_Temp_MultiController where Id=@counter)




)

 set @controllerCounter=@controllerCounter+1
 End
 Drop table #ControllerList
set @counter=@counter+1
End



select distinct 
--latefee.ActiveChecklistId
latefee.TaskID as ActiveChecklistId -- added by ken 4/10/19
,latefee.TaskId as Id--added by venkat 10/02/2018
,latefee.TaskName,latefee.LateCharge,latefee.DueDate,latefee.ControllerName
--,latefee.AssigneeName
,Assignee.FullName as AssigneeName
,controller.Email as ControllerEmail,(case when supervisorsList.fullname is null then 0 else 1 End) as IsControllerSupervisor  
,(SELECT PermissionValue from dbo.[APP_SpecificPermissions]
		WHERE appID = @appname and permissiontype = 'overdueexcuseemail')ExcuseAdditionalEmail
from #OverDueTasks_LateFee_Temp latefee
inner join QCheck_Users Controller on latefee.ControllerName=Controller.FullName and Controller.IsDeleted=0
--inner join QCheck_Users Assignee on latefee.AssigneeName=Assignee.FullName--commented by venkat 04/17/2018
inner join QCheck_Users Assignee on latefee.EmpID=Assignee.ID--added by venkat 04/17/2018

left join
 (select fullname, email from
	qcheck_users
	where id in
	(
		
		select gm2.userid from qstatus_report r
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g
		on g.id = gr.groupid
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		--and gm.userID = 652
		inner join qstatus_supervisors s
		on r.id = s.reportid
		and s.interestedparty = 0
		--and r.isdeleted = 0
		inner join qcheck_groups g2
		on g2.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id

	)
	and isdeleted = 0
	) supervisorsList  on Controller.FullName=supervisorsList.fullname
--where latefee.IsActive=1 
--and Convert(Date,@ReportDate)=Convert(Date,AsofDate) 
END



GO
/****** Object:  StoredProcedure [dbo].[GetOverdueTasks_LateCount_Charge]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetOverdueTasks_LateCount_Charge]
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null
--@supervisor int
AS
BEGIN
 --select Latetable.LateCount,Latetable.LateCharge,u.FullName,Convert(date,Latetable.LastLateDate) as LastLateDate,DATEDIFF(Day,Convert(date,Latetable.LastLateDate),COnvert(Date,Getdate())) as DaysSinceLastLate
 --from
 -- (select count(*)as LateCount,Sum(LateCharge) LateCharge,EmpID,Max(DueDate) LastLateDate from OverDueTasks_LateFee_Log 
 --where Convert(date,AsOfDate)>=@ReportStartDate and Convert(date,AsOfDate)<=@ReportEndDate and IsActive=1
 --group by EmpID ) Latetable
 --Inner Join QCheck_Users u on Latetable.EmpID=u.ID
 --order by Latetable.LateCharge desc

 Create table #LateCharges 
 (
   LateCount int,
   LateCharge float,
   FullName varchar(50),
   LastLateDate date,
   DaysSinceLastLate int,
   PenaltyTasks int,
   AllTasks int



 )
 Insert into #LateCharges
 (
   LateCount ,
   LateCharge ,
   FullName ,
   LastLateDate ,
   DaysSinceLastLate ,
   PenaltyTasks ,
   AllTasks 
 )
 select Latetable.LateCount,Latetable.LateCharge,u.FullName,Convert(date,Latetable.LastLateDate) as LastLateDate,DATEDIFF(Day,Convert(date,Latetable.LastLateDate),COnvert(Date,Getdate())) as DaysSinceLastLate,
 (select count(distinct aca.ID)
              from QCheck_Users u
              inner join QCheck_GroupMembership gm
                     on gm.UserID = u.ID 
              inner join QCheck_Groups g
                     on g.ID = gm.GroupID
              inner join QCheck_Assignments_All aa
                     on aa.GroupID = g.ID and aa.IsDeleted=0
              
              inner join QCheck_ActiveAssignments_All aaa
                     on aaa.AssignmentsID = aa.ID
       
              inner join QCheck_ActiveChecklists_All aca
                     on aaa.ActiveChecklistID = aca.ID
              inner join QCheck_ChecklistInstances_All aci
                     on aca.InstanceID = aci.ID
                     and aci.IsDeleted=0
                                  and aci.ID not in (select distinct ci.id from QCheck_ChecklistInstances ci
       inner join QCheck_Assignments a
              on ci.ID = a.InstanceID
              and a.IsDeleted = 0
       inner join qcheck_groups g
              on g.id = a.GroupID
       inner join QCheck_GroupMembership gm
              on gm.GroupID = g.id
       inner join qcheck_checklists cl
              on cl.id = ci.ChecklistID
              and cl.IsDeleted = 0
              and ci.IsDeleted = 0
       inner join QCheck_ChecklistManagers cm
              on cm.ChecklistID = cl.id
              and cm.IsDeleted = 0
       inner join qcheck_groups manGrp
              on manGrp.id = cm.ManagerGroupID
       inner join QCheck_GroupMembership manGM
              on manGm.GroupID = manGrp.id
              and manGm.UserID = gm.UserID
          )
              inner join QCheck_Checklists_All ac
                     on aci.ChecklistID = ac.ID
                     and ac.IsDeleted=0
              LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = ac.id 
            -- inner join  QCheck_Groups g1 on g1.Name=ccl.controllers 
        LEFT OUTER JOIN    dbo.QCheck_AssigneeLookup AL on aa.InstanceID=al.InstanceID
         
         where 
       
    
               ccl.controllers is not null and al.assignees is not null
    
           and 
                 aca.DueTime >=@ReportStartDate and aca.DueTime <=@ReportEndDate 
		     and u.ID =Latetable.EmpID) as SubjectToPenaltyTasks,
      (select count(distinct aca.ID)
              from QCheck_Users u
              inner join QCheck_GroupMembership gm
                     on gm.UserID = u.ID 
              inner join QCheck_Groups g
                     on g.ID = gm.GroupID
              inner join QCheck_Assignments_All aa
                     on aa.GroupID = g.ID and aa.IsDeleted=0
              
              inner join QCheck_ActiveAssignments_All aaa
                     on aaa.AssignmentsID = aa.ID
       
              inner join QCheck_ActiveChecklists_All aca
                     on aaa.ActiveChecklistID = aca.ID
              inner join QCheck_ChecklistInstances_All aci
                     on aca.InstanceID = aci.ID
                     and aci.IsDeleted=0
    
              inner join QCheck_Checklists_All ac
                     on aci.ChecklistID = ac.ID
                     and ac.IsDeleted=0
              LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = ac.id 
            -- inner join  QCheck_Groups g1 on g1.Name=ccl.controllers 
        LEFT OUTER JOIN    dbo.QCheck_AssigneeLookup AL on aa.InstanceID=al.InstanceID
         
         where 
       
    
               ccl.controllers is not null and al.assignees is not null
    
           and 
                 aca.DueTime >=@ReportStartDate and aca.DueTime <=@ReportEndDate
		     and u.ID =Latetable.EmpID)AllTasks
 from
  (select count(*)as LateCount,Sum(LateCharge) LateCharge,EmpID,Max(DueDate) LastLateDate from OverDueTasks_LateFee_Log 
 where Convert(date,AsOfDate)>=@ReportStartDate and Convert(date,AsOfDate)<=@ReportEndDate and IsActive=1
 group by EmpID ) Latetable
 Inner Join QCheck_Users u on Latetable.EmpID=u.ID
 order by Latetable.LateCharge desc

 select LateCount ,
   LateCharge ,
   FullName ,
   LastLateDate ,
   DaysSinceLastLate ,
   PenaltyTasks ,
   AllTasks
   ,Cast(cast (LateCount as FLoat)/cast (PenaltyTasks as Float)*100 as numeric(10,0)) as 'PercentPenaltyTasksOverdue'
   , Cast(cast (LateCount as FLoat)/cast (AllTasks as Float)*100 as numeric(10,0)) as 'PercentAllTasksOverdue'
   
     from #LateCharges
	 where PenaltyTasks>0 
	 order by latecharge desc
END



GO
/****** Object:  StoredProcedure [dbo].[GetOverdueTasks_LateCount_Charge_Employee]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetOverdueTasks_LateCount_Charge_Employee]
	@ReportStartDate datetime
	,@ReportEndDate datetime
	,@Assignee varchar(100)=''
	,@empId int
AS
BEGIN
select sum(latefee.LateCharge) as TotalLateCharge,count(*) as TotalLateCount from OverDueTasks_LateFee_Log latefee
where IsActive=1 
and Convert(Date,AsofDate)>=Convert(Date,@ReportStartDate) and Convert(Date,AsofDate)<=Convert(Date,@ReportEndDate) 
-- and AssigneeName=@Assignee--commented by venkat on 04/17/2018
and EmpID=@empId--added by venkat on 04/17/2018

select latefee.LateCharge as LateCharge,latefee.TaskName,Convert(Date,AsofDate) as LateDate from OverDueTasks_LateFee_Log latefee
where IsActive=1 
and Convert(Date,AsofDate)>=Convert(Date,@ReportStartDate) and Convert(Date,AsofDate)<=Convert(Date,@ReportEndDate)  
--and AssigneeName=@Assignee--commented by venkat on 04/17/2018
and EmpID=@empId--added by venkat on 04/17/2018 
order by LateDate desc

END
GO
/****** Object:  StoredProcedure [dbo].[GetOverdueTasks_Report]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetOverdueTasks_Report]
	@ReportStartDate datetime
	,@ReportEndDate datetime
	,@Assignee varchar(100)='All'
AS
BEGIN

if(@Assignee='All')
Begin

select latefee.Id,latefee.TaskName,latefee.ControllerName,u.fullname as AssigneeName,latefee.DueDate,latefee.CompletedDate,latefee.ActiveChecklistId
from OverDueTasks_LateFee_Log latefee
	inner join QCheck_Users u
		on u.id = latefee.empID
where IsActive=1 
and Convert(Date,AsofDate)>=Convert(Date,@ReportStartDate) and Convert(Date,AsofDate)<=Convert(Date,@ReportEndDate)  
order by latefee.AssigneeName
End
else
Begin
select latefee.Id, latefee.TaskName,latefee.ControllerName, @Assignee as AssigneeName,latefee.DueDate,latefee.CompletedDate,latefee.ActiveChecklistId
from OverDueTasks_LateFee_Log latefee
	inner join QCheck_Users u
		on u.id = latefee.empID
		and u.fullname = @Assignee
where IsActive=1 
and Convert(Date,AsofDate)>=Convert(Date,@ReportStartDate) and Convert(Date,AsofDate)<=Convert(Date,@ReportEndDate) 
order by latefee.AssigneeName
End
END




GO
/****** Object:  StoredProcedure [dbo].[GetPriorityList_Late_EmployeeList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetPriorityList_Late_EmployeeList]
@ReportDate Datetime=NULL


--@supervisor int
AS
BEGIN
select P.Id
      ,P.EmpID
	  ,U.FullName
	  ,U.Email
      ,Convert(Date,P.LateDate)
      ,P.LateCharge
	  
	  from PriorityList_LateFee_Log P
	  inner join QCheck_Users U on U.ID=P.EmpID
	  where P.LateDate>=Convert(Date,@ReportDate) and P.IsActive=1--changed from = to >= to account for GPR's request of analysing Carmel time shift priority lists

END



GO
/****** Object:  StoredProcedure [dbo].[GetPriorityList_LateCount_Charge]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetPriorityList_LateCount_Charge]
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null
--@supervisor int
AS
BEGIN
 select Latetable.LateCount,Latetable.LateCharge,u.FullName,Convert(date,Latetable.LastLateDate) as LastLateDate
  ,DATEDIFF(Day,Convert(date,Latetable.LastLateDate),COnvert(Date,Getdate())) as DaysSinceLastLate
 from
  (select count(*)as LateCount,Sum(LateCharge) LateCharge,EmpID,Max(LateDate) LastLateDate from [PriorityList_LateFee_Log] 
 where LateDate>=@ReportStartDate and LateDate<=@ReportEndDate and IsActive=1
 group by EmpID ) Latetable
 Inner Join QCheck_Users u on Latetable.EmpID=u.ID
 order by Latetable.LateCharge desc

END


GO
/****** Object:  StoredProcedure [dbo].[GetPriorityList_LateCount_Charge_Employee]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetPriorityList_LateCount_Charge_Employee]
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null,
@employeeId int=null
--@supervisor int
AS
BEGIN
 --select Latetable.LateCount,Latetable.LateCharge,u.FullName,u.Email
 --from
 -- (select count(*)as LateCount,Sum(LateCharge) LateCharge,EmpID from [PriorityList_LateFee_Log] 
 --where LateDate>=@ReportStartDate and LateDate<=@ReportEndDate and EmpID=@employeeId
 --group by EmpID ) Latetable
 --Inner Join QCheck_Users u on Latetable.EmpID=u.ID
 --order by u.FullName

 select Sum(LateCharge) as TotalLateCharge from PriorityList_LateFee_Log where LateDate>=@ReportStartDate and LateDate<=@ReportEndDate and EmpID=@employeeId and IsActive=1

 select [Id]
      ,[EmpID]
      ,Convert(date,LateDate) as LateDate
      ,[LateCharge] from PriorityList_LateFee_Log where LateDate>=@ReportStartDate and LateDate<=@ReportEndDate and EmpID=@employeeId and IsActive=1 order by LateDate desc

END



GO
/****** Object:  StoredProcedure [dbo].[GetPriorityList_ScheduleReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetPriorityList_ScheduleReport]
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null,
@supervisor int,
@employee varchar(20)
AS
BEGIN
SET DATEFIRST 1;
--Declare @EmpID int=0;
--Declare @DayOfWeek int =0
--Declare @StartDate Datetime
--Declare @ReportStartDate
Declare @OrigReportEndDate datetime;
select @ReportStartDate=IsNUll(@ReportStartDate,'01/01/1900')

--select @ReportEndDate=IsNUll(@ReportEndDate,'01/01/9999')
--select @ReportEndDate=IsNUll(@ReportEndDate,GetDate()-1)
select @ReportEndDate=IsNUll(@ReportEndDate,GetDate())
select @OrigReportEndDate=@ReportEndDate


Declare @EndDate Datetime=Convert(Date,GetDate()-1)

Create table #Schedule
(
  seq int identity(1,1),
  ScheduleId int,
  SupervisorID int,
  EmpID int,
  DaysOfWeek varchar(10),
  ReportDay varchar(10),
  TimesOfday varchar(10),
  CreatedDate datetime,
  ModifiedDate datetime,
  IsActive bit

)


Create table #ScheduleReport
(
  seq int identity(1,1),
  ScheduleId int,
  Supervisor varchar(100),
  Employee varchar(100),
  ReportDate varchar(50),
  ScheduledDate datetime, 
  SentDate datetime,
  ReportsPerWeek int ,
  IsLate varchar(5),
  IsExcludedReason varchar(100)

)

Create table #Employees
(
  
 
  ID int,
  EmpName varchar(100),
  LastPrioritySet bit
 

)

if(@employee='All')
Begin
INSERT INTO #Employees
EXEC PriorityList_GetSets @UserID = @supervisor,@IsPerson = 0
End
Else
Begin
INSERT INTO #Employees(ID,EmpName,LastPrioritySet)
values(0,@employee,1)
End


declare @Counter int=1
declare @ScheduleCount int=1;

Insert into #Schedule(ScheduleId,SupervisorID,EmpID,DaysOfWeek,ReportDay,TimesOfday,CreatedDate,ModifiedDate,IsActive)--load the schedules
select [ScheduleID]
      ,[SupervisorID]
      ,[EmployeeID]
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
      ,[CreatedDate]
	  ,ModifiedDate
	  ,IsActive
	  From Schedule_PriorityList  where IsActive=1 
	  --and SupervisorID=@supervisor
	  and EmployeeID in (select ID from QCheck_users where FullName in (select EmpName from #Employees) and ID <>@supervisor)

--get inactive schedules -added on 10/25/2017
Insert into #Schedule(ScheduleId,SupervisorID,EmpID,DaysOfWeek,ReportDay,TimesOfday,CreatedDate,ModifiedDate,IsActive)--load the schedules
select [ScheduleID]
      ,[SupervisorID]
      ,[EmployeeID]
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
      ,[CreatedDate]
	  ,ModifiedDate
	  ,IsActive
	  From Schedule_PriorityList  where IsActive=0
	 -- and ModifiedDate>= @ReportStartDate and ModifiedDate<=@ReportEndDate
	  --and SupervisorID=@supervisor
	  and EmployeeID in (select ID from QCheck_users where FullName in (select EmpName from #Employees) and ID <>@supervisor)
	   and Convert(date,CreatedDate)<>Convert(date,ModifiedDate)


select @ScheduleCount=count(*) from #Schedule

while(@Counter<=@ScheduleCount)
Begin

Declare @EmpID int=0;
Declare @SupervisorID int=0;
Declare @DayOfWeek int =0
Declare @ReportDay int =0
Declare @StartDate Datetime
Declare @ScheduledTime time;
Declare @ReportsPerWeek int=0;
Declare @IsActive bit=1;
--set @EmpID=715;
set @ReportEndDate=@OrigReportEndDate
select @IsActive=IsActive from #Schedule where Seq=@Counter
if(@IsActive=0)
Begin
--select @ReportEndDate=Convert(Date,ModifiedDate) from #Schedule where Seq=@Counter and @ReportEndDate>=Convert(Date,ModifiedDate)
select @ReportEndDate=ModifiedDate from #Schedule where Seq=@Counter and @ReportEndDate>=Convert(Date,ModifiedDate)
End


select @SupervisorID=SupervisorID, @EmpID=EmpID, @DayOfWeek=DaysofWeek,@ReportDay=ReportDay,@StartDate=Convert(Date,CreatedDate),@ScheduledTime=TimesOfday from #Schedule where Seq=@Counter
select @ReportsPerWeek=count(*) from Schedule_PriorityList where EmployeeID=@EmpID and IsActive=1

Create table #ScheduleDates
(
 seq int identity(1,1),
 ScheduledDate datetime
)

Create table #ReportDates
(
 seq int identity(1,1),
 ReportDate datetime
)

--select @StartDate,@EndDate,@ScheduledTime
Insert Into #ScheduleDates(ScheduledDate)--this stores the list of all scheduled dates per schedule
SELECT dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(@ScheduledTime AS DATETIME))
 from [dbo].[Util_fn_List_WeekDays_DateRange](@StartDate,@ReportEndDate,@DayOfWeek) dt
 where 
 dt.WeekDayDate>=@ReportStartDate 
 and dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(@ScheduledTime AS DATETIME))<=@ReportEndDate
 --and dt.WeekDayDate<=@ReportEndDate
Insert Into #ReportDates(ReportDate)--this stores the list of all scheduled dates per schedule
SELECT dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST('00:00' AS DATETIME))
 from [dbo].[Util_fn_List_WeekDays_DateRange](@StartDate,@ReportEndDate,@ReportDay) dt
  where

 dt.WeekDayDate>=@ReportStartDate 
 and dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(@ScheduledTime AS DATETIME))<=@ReportEndDate
 --and dt.WeekDayDate<=@ReportEndDate
--select * from #ScheduleDates

Declare @ScheduledDatesCounter int=1;

Declare @ScheduledDatesCount int=0;

select @ScheduledDatesCount=count(*) from #ScheduleDates

while (@ScheduledDatesCounter<=@ScheduledDatesCount)
Begin

Declare @ScheduledDate Datetime;
Declare @ReportDate Datetime;
select @ScheduledDate=ScheduledDate from #ScheduleDates where Seq=@ScheduledDatesCounter 
select @ReportDate=ReportDate from #ReportDates where Seq=@ScheduledDatesCounter 

if(@ReportsPerWeek=1)--this is for weekly reports
Begin
Insert into #ScheduleReport(Supervisor,Employee,ReportDate,ScheduledDate,SentDate,IsLate,ReportsPerWeek,IsExcludedReason)
values
((select FullName from QCheck_Users where ID=@SupervisorID)
,(select FullName from QCheck_Users where ID=@EmpID)
,(select ReportDate from #ReportDates where Seq=@ScheduledDatesCounter)
,(select ScheduledDate from #ScheduleDates where Seq=@ScheduledDatesCounter)
,(select Max(Sent) from QCheck_Log_Emails 
   where 
  -- Convert(Date,Sent)=Convert(Date,@ScheduledDate) and 
  -- Sent>dateadd(day, datediff(day,'19000101', Convert(Date,@ScheduledDate)), CAST('00:00' AS DATETIME)) and
  Sent>@ReportDate-2 and
   (Sent<= @ScheduledDate or  Convert(Date,Sent)=Convert(Date,@ScheduledDate))
   and FromId=@EmpID 
   and ToId <> FromId
   --and ToId=@SupervisorID
   )
,null
,@ReportsPerWeek
,case when Exists(select 1 from  Schedule_PriorityList_Exclude where EmpID=@EmpID and IsActive=1 and ExcludedDate<=@ScheduledDate and Convert(Date,ExcludedDate)=Convert(Date,@ScheduledDate))
 Then 'Excused'
 when Exists(select 1 from vwVacation where EmployeeID=(select EmpID from Qcheck_Users where ID=@EmpID) and Convert(Date,VacationDay)=Convert(Date,@ScheduledDate))
 Then 'Vacation'
 End

)
End
else
Begin
Insert into #ScheduleReport(Supervisor,Employee,ReportDate,ScheduledDate,SentDate,IsLate,ReportsPerWeek,IsExcludedReason)
values
((select FullName from QCheck_Users where ID=@SupervisorID)
,(select FullName from QCheck_Users where ID=@EmpID)
,(select ReportDate from #ReportDates where Seq=@ScheduledDatesCounter)
,(select ScheduledDate from #ScheduleDates where Seq=@ScheduledDatesCounter)
,(select Max(Sent) from QCheck_Log_Emails 
   where 
  -- Convert(Date,Sent)=Convert(Date,@ScheduledDate) and 
  -- Sent>dateadd(day, datediff(day,'19000101', Convert(Date,@ScheduledDate)), CAST('00:00' AS DATETIME)) and
  Sent>@ReportDate and
   (Sent<= @ScheduledDate or  Convert(Date,Sent)=Convert(Date,@ScheduledDate))
   and FromId=@EmpID 
   and ToId <> FromId
   --and ToId=@SupervisorID
   )
,null
,@ReportsPerWeek
,case when Exists(select 1 from  Schedule_PriorityList_Exclude where EmpID=@EmpID and IsActive=1 and ExcludedDate<=@ScheduledDate and Convert(Date,ExcludedDate)=Convert(Date,@ScheduledDate))
 Then 'Excused'
 when Exists(select 1 from vwVacation where EmployeeID=(select EmpID from Qcheck_Users where ID=@EmpID) and Convert(Date,VacationDay)=Convert(Date,@ScheduledDate))
 Then 'Vacation'
 End

)

End


set @ScheduledDatesCounter=@ScheduledDatesCounter+1
End

Drop table #ScheduleDates 
Drop table #ReportDates 
--select @DayOfWeek=DaysofWeek,@StartDate=CreatedDate from [Schedule_PriorityList] where EmployeeID=@EmpID
--EmployeeID=@EmpID

--SELECT dt.*,EmpData.Sent,EmpData.SupervisorID,EmpData.EmployeeID,dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(EmpData.TimesOfDay AS DATETIME)),@StartDate
-- from [dbo].[Util_fn_List_WeekDays_DateRange](@StartDate,@EndDate,@DayOfWeek) dt
--left join ( select EmailLog.*,PriList.* from QCheck_Log_Emails  EmailLog 
--left join Schedule_PriorityList PriList on PriList.EmployeeID=EmailLog.FromId
--where EmailLog.FromId=@EmpID) 
--EmpData on Convert(Date,EmpData.Sent)=dt.WeekDayDate
----and cast(EmpData.Sent as time) <=EmpData.TimesOfDay
--and EmpData.Sent <=dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(EmpData.TimesOfDay AS DATETIME))
--where dt.WeekDayDate>=@StartDate

set @Counter=@Counter+1

End

--with x as (
--	select * from #ScheduleReport
-- order by Employee Desc
--	)
--	select * from x order by ScheduledDate Desc

--select * from #Schedule

Drop table #Employees
select distinct * from #ScheduleReport
 order by Employee 

END






GO
/****** Object:  StoredProcedure [dbo].[GetPriorityList_ScheduleReport_All]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetPriorityList_ScheduleReport_All]
@ReportStartDate Datetime=NULL,
@ReportEndDate Datetime=null
--@supervisor int
AS
BEGIN
SET DATEFIRST 1;
--Declare @EmpID int=0;
--Declare @DayOfWeek int =0
--Declare @StartDate Datetime
Declare @OrigReportEndDate datetime;
select @ReportStartDate=IsNUll(@ReportStartDate,'01/01/1900')

--select @ReportEndDate=IsNUll(@ReportEndDate,'01/01/9999')
--select @ReportEndDate=IsNUll(@ReportEndDate,GetDate()-1)
select @ReportEndDate=IsNUll(@ReportEndDate,GetDate())
select @OrigReportEndDate=@ReportEndDate

Declare @EndDate Datetime=Convert(Date,GetDate()-1)

Create table #Schedule
(
  seq int identity(1,1),
  ScheduleId int,
  SupervisorID int,
  EmpID int,
  DaysOfWeek varchar(10),
  ReportDay varchar(10),
  TimesOfday varchar(10),
  CreatedDate datetime,
  ModifiedDate datetime,
  IsActive bit

)



Create table #ScheduleReport
(
  seq int identity(1,1),
  ScheduleId int,
  Supervisor varchar(100),
  Employee varchar(100),
  ReportDate varchar(50),
  ScheduledDate datetime, 
  SentDate datetime,
  ReportsPerWeek int ,
  IsLate varchar(5),
  IsExcludedReason varchar(100)

)



declare @Counter int=1
declare @ScheduleCount int=1;

Insert into #Schedule(ScheduleId,SupervisorID,EmpID,DaysOfWeek,ReportDay,TimesOfday,CreatedDate,ModifiedDate,IsActive)--load the schedules
select [ScheduleID]
      ,[SupervisorID]
      ,[EmployeeID]
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
      ,[CreatedDate]
	  ,ModifiedDate
	  ,IsActive
	  From Schedule_PriorityList  where IsActive=1 
	  --and SupervisorID=@supervisor
	  --and EmployeeID in (select ID from QCheck_users where FullName in (select EmpName from #Employees) and ID <>@supervisor)


--get inactive schedules -added on 10/25/2017
Insert into #Schedule(ScheduleId,SupervisorID,EmpID,DaysOfWeek,ReportDay,TimesOfday,CreatedDate,ModifiedDate,IsActive)--load the schedules
select [ScheduleID]
      ,[SupervisorID]
      ,[EmployeeID]
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
      ,[CreatedDate]
	  ,ModifiedDate
	  ,IsActive
	  From Schedule_PriorityList  where IsActive=0
	   and Convert(date,CreatedDate)<>Convert(date,ModifiedDate)

select @ScheduleCount=count(*) from #Schedule

while(@Counter<=@ScheduleCount)
Begin

Declare @EmpID int=0;
Declare @SupervisorID int=0;
Declare @DayOfWeek int =0
Declare @ReportDay int =0
Declare @StartDate Datetime
Declare @ScheduledTime time;
Declare @ReportsPerWeek int=0;

Declare @IsActive bit=1;
--set @EmpID=715;
set @ReportEndDate=@OrigReportEndDate
select @IsActive=IsActive from #Schedule where Seq=@Counter
if(@IsActive=0)
Begin
--select @ReportEndDate=Convert(Date,ModifiedDate) from #Schedule where Seq=@Counter and @ReportEndDate>=Convert(Date,ModifiedDate)
select @ReportEndDate=ModifiedDate from #Schedule where Seq=@Counter and @ReportEndDate>=Convert(Date,ModifiedDate)
End
--set @EmpID=715;
select @SupervisorID=SupervisorID, @EmpID=EmpID, @DayOfWeek=DaysofWeek,@ReportDay=ReportDay,@StartDate=Convert(Date,CreatedDate),@ScheduledTime=TimesOfday from #Schedule where Seq=@Counter
select @ReportsPerWeek=count(*) from Schedule_PriorityList where EmployeeID=@EmpID and IsActive=1

Create table #ScheduleDates
(
 seq int identity(1,1),
 ScheduledDate datetime
)

Create table #ReportDates
(
 seq int identity(1,1),
 ReportDate datetime
)

--select @StartDate,@EndDate,@ScheduledTime
Insert Into #ScheduleDates(ScheduledDate)--this stores the list of all scheduled dates per schedule
SELECT dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(@ScheduledTime AS DATETIME))
 from [dbo].[Util_fn_List_WeekDays_DateRange](@StartDate,@ReportEndDate,@DayOfWeek) dt
 where 

 dt.WeekDayDate>=@ReportStartDate 
 and  dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(@ScheduledTime AS DATETIME))<=@ReportEndDate
 --and dt.WeekDayDate<=@ReportEndDate
Insert Into #ReportDates(ReportDate)--this stores the list of all scheduled dates per schedule
SELECT dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST('00:00' AS DATETIME))
 from [dbo].[Util_fn_List_WeekDays_DateRange](@StartDate,@ReportEndDate,@ReportDay) dt
  where
 
 dt.WeekDayDate>=@ReportStartDate 
 and  dateadd(day, datediff(day,'19000101',dt.WeekDayDate), CAST(@ScheduledTime AS DATETIME))<=@ReportEndDate
 --and dt.WeekDayDate<=@ReportEndDate
--select * from #ScheduleDates

Declare @ScheduledDatesCounter int=1;

Declare @ScheduledDatesCount int=0;

select @ScheduledDatesCount=count(*) from #ScheduleDates

while (@ScheduledDatesCounter<=@ScheduledDatesCount)
Begin

Declare @ScheduledDate Datetime;
Declare @ReportDate Datetime;
select @ScheduledDate=ScheduledDate from #ScheduleDates where Seq=@ScheduledDatesCounter 
select @ReportDate=ReportDate from #ReportDates where Seq=@ScheduledDatesCounter 

if(@ReportsPerWeek=1)--this is for weekly reports
Begin
Insert into #ScheduleReport(Supervisor,Employee,ReportDate,ScheduledDate,SentDate,IsLate,ReportsPerWeek,IsExcludedReason)
values
((select FullName from QCheck_Users where ID=@SupervisorID)
,(select FullName from QCheck_Users where ID=@EmpID)
,(select ReportDate from #ReportDates where Seq=@ScheduledDatesCounter)
,(select ScheduledDate from #ScheduleDates where Seq=@ScheduledDatesCounter)
,(select Max(Sent) from QCheck_Log_Emails 
   where 
  -- Convert(Date,Sent)=Convert(Date,@ScheduledDate) and 
  -- Sent>dateadd(day, datediff(day,'19000101', Convert(Date,@ScheduledDate)), CAST('00:00' AS DATETIME)) and
  Sent>@ReportDate-2 and
   (Sent<= @ScheduledDate or  Convert(Date,Sent)=Convert(Date,@ScheduledDate))
   and FromId=@EmpID 
   and ToId <> FromId
   --and ToId=@SupervisorID
   )
,null
,@ReportsPerWeek
,case when Exists(select 1 from  Schedule_PriorityList_Exclude where EmpID=@EmpID and IsActive=1 and ExcludedDate<=@ScheduledDate and Convert(Date,ExcludedDate)=Convert(Date,@ScheduledDate))
 Then 'Excused'
 when Exists(select 1 from vwVacation where EmployeeID=(select EmpID from Qcheck_Users where ID=@EmpID) and Convert(Date,VacationDay)=Convert(Date,@ScheduledDate))
 Then 'Vacation'
 End

)
End
else
Begin
Insert into #ScheduleReport(Supervisor,Employee,ReportDate,ScheduledDate,SentDate,IsLate,ReportsPerWeek,IsExcludedReason)
values
((select FullName from QCheck_Users where ID=@SupervisorID)
,(select FullName from QCheck_Users where ID=@EmpID)
,(select ReportDate from #ReportDates where Seq=@ScheduledDatesCounter)
,(select ScheduledDate from #ScheduleDates where Seq=@ScheduledDatesCounter)
,(select Max(Sent) from QCheck_Log_Emails 
   where 
  -- Convert(Date,Sent)=Convert(Date,@ScheduledDate) and 
  -- Sent>dateadd(day, datediff(day,'19000101', Convert(Date,@ScheduledDate)), CAST('00:00' AS DATETIME)) and
  Sent>@ReportDate and
   (Sent<= @ScheduledDate or  Convert(Date,Sent)=Convert(Date,@ScheduledDate))
   and FromId=@EmpID 
   and ToId <> FromId
   --and ToId=@SupervisorID
   )
,null
,@ReportsPerWeek
,case when Exists(select 1 from  Schedule_PriorityList_Exclude where EmpID=@EmpID and IsActive=1 and ExcludedDate<=@ScheduledDate and Convert(Date,ExcludedDate)=Convert(Date,@ScheduledDate))
 Then 'Excused'
 when Exists(select 1 from vwVacation where EmployeeID=(select EmpID from Qcheck_Users where ID=@EmpID) and Convert(Date,VacationDay)=Convert(Date,@ScheduledDate))
 Then 'Vacation'
 End

)

End


set @ScheduledDatesCounter=@ScheduledDatesCounter+1
End

Drop table #ScheduleDates 
Drop table #ReportDates 

set @Counter=@Counter+1

End




select * from #ScheduleReport
 order by Employee 

END


GO
/****** Object:  StoredProcedure [dbo].[GetPriorityListSchedules]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetPriorityListSchedules] 
	@supervisorId int,
	@subOrdinateId int
AS
BEGIN
	select * from Schedule_PriorityList where
	-- SupervisorID=@supervisorId and 
	 EmployeeId=@subOrdinateId and IsActive=1
	order by DaysOfWeek
END


GO
/****** Object:  StoredProcedure [dbo].[GetSupervisorPriorityReportSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetSupervisorPriorityReportSchedule] 
	@supervisorId int
AS
BEGIN
	select * from Supervisor_PriorityList_Report_Schedule where SupervisorID=@supervisorId and IsActive=1 order by DaysOfWeek 
END
GO
/****** Object:  StoredProcedure [dbo].[GetSupervisorsPriorityReportSchedules]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetSupervisorsPriorityReportSchedules] 
	
AS
BEGIN
SET DATEFIRST 1;
SELECT [SupervisorID]
      ,convert(date, (getdate()-1)) as ReportEndDate
      ,convert(date, (getdate()-1-DaysOffset)) as ReportStartDate
      ,(select Email from QCheck_Users where ID=SupervisorID)SupervisorEmail
  FROM [dbo].[Supervisor_PriorityList_Report_Schedule] where DaysOfWeek=datepart ("dw", getdate()) and IsActive=1
END

GO
/****** Object:  StoredProcedure [dbo].[GetSupervisorsPrioritySchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetSupervisorsPrioritySchedule] 
@supervisorId int
,@employeeId int=0
As	
BEGIN
Create table #Employees
(
  
 
  ID int,
  EmpName varchar(100),
  LastPrioritySet bit
 

)

INSERT INTO #Employees
EXEC PriorityList_GetSets @UserID = @supervisorId,@IsPerson = 0

if(@employeeId=0)--get all
Begin
if(@supervisorId=68)--this is for Nelson to see all the employees schedules.Will have to change it to use AppSecurity
begin
SELECT 
       (Select FullName from QCheck_Users where ID=SupervisorID) as SupervisorName
      ,(Select FullName from QCheck_Users where ID=EmployeeID) as EmployeeName
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
     
  FROM [dbo].[Schedule_PriorityList] where IsActive=1
  -- and SupervisorID=@supervisorId
 --  and EmployeeID in (select ID from QCheck_users where FullName in (select EmpName from #Employees) and ID <>@supervisorId)
   
  order by EmployeeName ,DaysOfWeek
End
else
begin
SELECT 
       (Select FullName from QCheck_Users where ID=SupervisorID) as SupervisorName
      ,(Select FullName from QCheck_Users where ID=EmployeeID) as EmployeeName
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
     
  FROM [dbo].[Schedule_PriorityList] where IsActive=1
  -- and SupervisorID=@supervisorId
   and EmployeeID in (select ID from QCheck_users where FullName in (select EmpName from #Employees) and ID <>@supervisorId)
   
  order by EmployeeName ,DaysOfWeek
  End
  End
  else
  Begin
  SELECT 
       (Select FullName from QCheck_Users where ID=SupervisorID) as SupervisorName
      ,(Select FullName from QCheck_Users where ID=EmployeeID) as EmployeeName
      ,[DaysOfWeek]
      ,[ReportDay]
      ,[TimesOfDay]
     
  FROM [dbo].[Schedule_PriorityList] where IsActive=1
  -- and SupervisorID=@supervisorId
   and EmployeeID=@employeeId
     order by DaysOfWeek

  End
END

GO
/****** Object:  StoredProcedure [dbo].[Grading_AssigneeEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Grading_AssigneeEmail] 
as
begin

	set nocount on 
	
	declare @enddate datetime 
	declare @startdate datetime
	select @enddate = convert(varchar, dateadd(day, -1 * (datepart(dw, getdate()) - 2), getdate()), 101)
	select @startdate = dateadd(day, -13, @enddate)
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50), @GPRUserID INT
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer, @GPRUserID = GPRUserID FROM QCheck_AppSettings WHERE ID = 1

	declare @overduedays int = 3

	declare @actable table(
		activechecklistid int
	)

	declare @people table(
		id int,
		name varchar(1000),
		email varchar(1000),
		tasks int default 0,
		overdue3 int default 0
	)

	insert into @people (id, name, email) select [ID], FullName, email from QCheck_Users where IsDeleted = 0 and id <> @GPRUserID

	insert into @actable
		select distinct activechecklistid from QStatus_DueDateChanges
		where DueDateOld between @startdate and @enddate
		
	insert into @actable
		select distinct id
		from QCheck_ActiveChecklists_All
		where DueTime between @startdate and @enddate
		and ID not in (select activechecklistid from @actable)
		
	update @people
		set tasks = t.tasks	
	from @people p
	inner join 
	(
	select u.ID, COUNT(distinct at.activechecklistid) as tasks
		from QPI_Users u
		inner join QCheck_GroupMembership gm
			on gm.UserID = u.ID
		inner join QCheck_Groups g
			on g.ID = gm.GroupID
		inner join QCheck_Assignments_All aa
			on aa.GroupID = g.ID
			and aa.DtAssigned < (@enddate - @overduedays)
		inner join QCheck_ActiveAssignments_All aaa
			on aaa.AssignmentsID = aa.ID
		inner join @actable at
			on at.activechecklistid = aaa.ActiveChecklistID
	group by u.ID
	) t on t.ID = p.id


	update @people
		set overdue3 = t.tasks	
	from @people p
	inner join 
	(
	select u.ID, COUNT(distinct at.activechecklistid) as tasks
		from QPI_Users u
		inner join QCheck_GroupMembership gm
			on gm.UserID = u.ID
		inner join QCheck_Groups g
			on g.ID = gm.GroupID
		inner join QCheck_Assignments_All aa
			on aa.GroupID = g.ID
		inner join QCheck_ActiveAssignments_All aaa
			on aaa.AssignmentsID = aa.ID
		inner join @actable at
			on at.activechecklistid = aaa.ActiveChecklistID
		inner join QCheck_ActiveChecklists_All aca
			on aca.ID = at.activechecklistid
		left outer join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID = aca.ID
				and ddc.UpdateDt > @startdate
	where 
		--currently open tasks that were due prior to 3 days before end of period
		(
			aca.CompletedDate is null
			and aca.DueTime < (@enddate - @overduedays)
			and aa.DtAssigned < (@enddate - @overduedays)
			and aca.archivedt is null
		) 
			or
		--completed more than 3 days after deadline
		(
			aca.DueTime < (aca.CompletedDate - @overduedays)
			and aa.DtAssigned < (aca.CompletedDate - @overduedays)
		)
			or
		--deadline changed when 3 days overdue
		(
			ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
			and aa.DtAssigned < (ddc.UpdateDt - @overduedays)
		)
	group by  u.ID
	) t on t.ID = p.id
		
		
	declare @email varchar(max) = '
	<html>
	<head>
	<style>
	body   {font-family:Calibri;}  
	p, li, div, td   {margin:0in;   margin-bottom:.0001pt;   font-size:11.0pt; border:solid windowtext 1.0pt;border-top:none;padding:0in 5.4pt 0in 5.4pt; }  
	tr {height:16pt;}
	</style>
	</head>
	<body>

	<table border=0 cellspacing=0 cellpadding=0 style=''width:462.0pt;margin-left:-.75pt;border-collapse:collapse''>
	<tr><td nowrap colspan=5 style=''width:100%;height:16pt;font-weight:bold;font-size:14.0pt;border:none;''>Q Process Grading Report as of '+convert(varchar, @enddate ,101)+'</td></tr>
	<tr><td nowrap colspan=5 style=''width:100%;height:16pt;font-weight:bold;font-size:14.0pt;border:none;''>Based on tasks due from '+convert(varchar, @startdate ,101)+' to '+convert(varchar, @enddate ,101)+'</td></tr>
	<tr><td colspan=5 style=''border:none;''>&nbsp;</td></tr>
	<tr><td nowrap colspan=5 style=''text-align:center;width:100%;font-weight:bold;font-size:14.0pt;border:none;''>Assignees</td></tr>

	<tr>
		<td nowrap style=''width:28pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Rank</td>
		<td nowrap style=''width:122pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Name</td>
		<td nowrap style=''width:128pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>% Overdue 3 days</td>
		<td nowrap style=''width:120pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Total # of Tasks Due</td>
		<td nowrap style=''width:112pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Overdue By 3 days</td>
	</tr>
	'

	declare @employeerows varchar(max) = ''

	declare @html table(
		id int identity,
		html varchar(max)
	)
		
	insert into @html (html)
	select '<tr><td nowrap style=''text-align:right;''>'+convert(varchar(10), ROW_NUMBER() over (order by overdue3/(tasks*1.0) asc, tasks desc, name asc))+'</td>'
		+'<td>'+name+'</td>'
		+'<td style=''text-align:right;background-color:'+dbo.Util_ColorScaleGYR(100* overdue3/(tasks*1.0), 0, 30)+';''>'+convert(varchar(10), convert(int, 100.0 * overdue3/(tasks*1.0))) + '%'+'</td>'
		+'<td style=''text-align:right;''>'+convert(varchar(10), tasks) +'</td>'
		+'<td style=''text-align:right;''>'+convert(varchar(10), overdue3) +'</td></tr>'
	from @people 
	where tasks > 4
	order by overdue3/(tasks*1.0) desc, tasks asc, name desc


	select @employeerows = @employeerows + html
		from @html
		order by [id] asc
		

	select @email = @email + @employeerows + '
	</table>
	</body>
	</html>'

	declare @subject varchar(500)
	select @subject = @appname + ' Overdue Grading Report As Of '+convert(varchar, @enddate ,101)+' - Assignees '

--	declare @emailto varchar(max) = 'graynor1@acmewidget.com;'
	declare @emailto varchar(100) = (SELECT TOP 1 GradingBCCAddress FROM QCheck_AppSettings)
	select @emailto = @emailto + email + ';'
	from @people 
	where tasks > 4
	and @emailto not like '%' + email + '%'

	update grading_assigneeemails set email = @emailto

--	declare @emailfrom varchar(1000) = @appname + 'Grading@acmewidget.com'
	declare @emailfrom varchar(1000) = (SELECT TOP 1 GradingAddress FROM QCheck_AppSettings)
	declare @emailfromname varchar(1000) = @appname + '-Grading'

	exec dbo.xp_smtp_sendmail 
			@from = @emailfrom, 
			@from_name = @emailfromname,
			@to='', 
			@bcc=@emailto,
			@subject=@subject,
			@message = @email
			
		
		
	set nocount off
end



GO
/****** Object:  StoredProcedure [dbo].[Grading_ControllerEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Grading_ControllerEmail] 
as
begin

	set nocount on 
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50), @GPRUserID INT
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer, @GPRUserID = GPRUserID FROM QCheck_AppSettings WHERE ID = 1

	declare @enddate datetime 
	declare @startdate datetime
	select @enddate = convert(varchar, dateadd(day, -1 * (datepart(dw, getdate()) - 2), getdate()), 101)
	select @startdate = dateadd(day, -13, @enddate)

	declare @overduedays int = 3

	declare @actable table(
		activechecklistid int
	)

	declare @people table(
		id int,
		name varchar(1000),
		email varchar(1000),
		tasks int default 0,
		overdue3 int default 0
	)

	insert into @people (id, name, email) select [ID], FullName, email from QCheck_Users where IsDeleted = 0 and ID <> @GPRUserID

	insert into @actable
		select distinct activechecklistid from QStatus_DueDateChanges
		where DueDateOld between @startdate and @enddate
		
	insert into @actable
		select distinct id
		from QCheck_ActiveChecklists_All
		where DueTime between @startdate and @enddate
		and ID not in (select activechecklistid from @actable)
		
	update @people
		set tasks = t.tasks	
	from @people p
	inner join 
	(
	select u.ID, COUNT(distinct at.activechecklistid) as tasks
		from QPI_Users u
		inner join QCheck_GroupMembership gm
			on gm.UserID = u.ID
		inner join QCheck_Groups g
			on g.ID = gm.GroupID
		inner join QCheck_ChecklistManagers cm
			on cm.ManagerGroupID = g.ID and cm.IsDeleted = 0
		inner join QCheck_Checklists_All c
			on c.ID = cm.ChecklistID
		inner join QCheck_ChecklistInstances_All ci
			on ci.ChecklistID = c.id
		inner join QCheck_ActiveChecklists_All ac
			on ac.InstanceID = ci.ID
		inner join @actable at
			on at.activechecklistid = ac.ID
		inner join QCheck_ActiveAssignments_All aaa
			on aaa.ActiveChecklistID = ac.ID
		inner join QCheck_Assignments_All aa
			on aa.ID = aaa.AssignmentsID
		left outer join (
				select aa1.InstanceID, gm.UserID  from QCheck_Assignments_All aa1
					inner join QCheck_GroupMembership gm
						on gm.GroupID = aa1.GroupID
		) assignee on assignee.InstanceID = ci.ID and assignee.UserID = u.ID
		where assignee.UserID is null
	group by u.ID
	) t on t.ID = p.id


	update @people
		set overdue3 = t.tasks	
	from @people p
	inner join 
	(
	select u.ID, COUNT(distinct at.activechecklistid) as tasks
		from QPI_Users u
		inner join QCheck_GroupMembership gm
			on gm.UserID = u.ID
		inner join QCheck_Groups g
			on g.ID = gm.GroupID
		inner join QCheck_ChecklistManagers cm
			on cm.ManagerGroupID = g.ID and cm.IsDeleted = 0
		inner join QCheck_Checklists_All c
			on c.ID = cm.ChecklistID
		inner join QCheck_ChecklistInstances_All ci
			on ci.ChecklistID = c.id
		inner join QCheck_ActiveChecklists_All aca
			on aca.InstanceID = ci.ID
		inner join @actable at
			on at.activechecklistid = aca.id
		inner join QCheck_ActiveAssignments_All aaa
			on aaa.ActiveChecklistID = aca.ID
		inner join QCheck_Assignments_All aa
			on aa.ID = aaa.AssignmentsID
		left outer join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID = aca.ID
				and ddc.UpdateDt > @startdate
		left outer join (
				select aa1.InstanceID, gm.UserID  from QCheck_Assignments_All aa1
					inner join QCheck_GroupMembership gm
						on gm.GroupID = aa1.GroupID
		) assignee on assignee.InstanceID = ci.ID and assignee.UserID = u.ID
		where assignee.UserID is null and
		(
			--currently open tasks that were due prior to 3 days before end of period
			(
				aca.CompletedDate is null
				and aca.DueTime < (@enddate - @overduedays)
				and aa.DtAssigned < (@enddate - @overduedays)
				and aca.archivedt is null
			) 
				or
			--completed more than 3 days after deadline
			(
				aca.DueTime < (aca.CompletedDate - @overduedays)
				and aa.DtAssigned < (aca.CompletedDate - @overduedays)
			)
				or
			--deadline changed when 3 days overdue
			(
				ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
				and aa.DtAssigned < (ddc.UpdateDt - @overduedays)
			)
		)
	group by  u.ID
	) t on t.ID = p.id

	declare @email varchar(max) = '
	<html>
	<head>
	<style>
	body   {font-family:Calibri;}  
	p, li, div, td   {margin:0in;   margin-bottom:.0001pt;   font-size:11.0pt; border:solid windowtext 1.0pt;border-top:none;padding:0in 5.4pt 0in 5.4pt; }  
	tr {height:16pt;}
	</style>
	</head>
	<body>

	<table border=0 cellspacing=0 cellpadding=0 style=''width:462.0pt;margin-left:-.75pt;border-collapse:collapse''>
	<tr><td nowrap colspan=5 style=''width:100%;height:16pt;font-weight:bold;font-size:14.0pt;border:none;''>Q Process Grading Report as of '+convert(varchar, @enddate ,101)+'</td></tr>
	<tr><td nowrap colspan=5 style=''width:100%;height:16pt;font-weight:bold;font-size:14.0pt;border:none;''>Based on tasks due from '+convert(varchar, @startdate ,101)+' to '+convert(varchar, @enddate ,101)+'</td></tr>
	<tr><td colspan=5 style=''border:none;''>&nbsp;</td></tr>
	<tr><td nowrap colspan=5 style=''text-align:center;width:100%;font-weight:bold;font-size:14.0pt;border:none;''>Controllers</td></tr>

	<tr>
		<td nowrap style=''width:28pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Rank</td>
		<td nowrap style=''width:122pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Name</td>
		<td nowrap style=''width:128pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>% Overdue 3 days</td>
		<td nowrap style=''width:120pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Total # of Tasks Due</td>
		<td nowrap style=''width:112pt;border:solid windowtext 1.0pt;background:#D8E4BC;font-weight:bold;''>Overdue By 3 days</td>
	</tr>
	'

	declare @employeerows varchar(max) = ''

	declare @html table(
		id int identity,
		html varchar(max)
	)
		
	insert into @html (html)
	select '<tr><td nowrap style=''text-align:right;''>'+convert(varchar(10), ROW_NUMBER() over (order by overdue3/(tasks*1.0) asc, tasks desc, name asc))+'</td>'
		+'<td>'+name+'</td>'
		+'<td style=''text-align:right;background-color:'+dbo.Util_ColorScaleGYR(100* overdue3/(tasks*1.0), 0, 30)+';''>'+convert(varchar(10), convert(int, 100.0 * overdue3/(tasks*1.0))) + '%'+'</td>'
		+'<td style=''text-align:right;''>'+convert(varchar(10), tasks) +'</td>'
		+'<td style=''text-align:right;''>'+convert(varchar(10), overdue3) +'</td></tr>'
	from @people 
	where tasks > 4
	order by overdue3/(tasks*1.0) desc, tasks asc, name desc


	select @employeerows = @employeerows + html
		from @html
		order by [id] asc
		

	select @email = @email + @employeerows + '
	</table>
	</body>
	</html>'

	declare @subject varchar(500)
	select @subject = @AppName + ' Overdue Grading Report As Of '+convert(varchar, @enddate ,101)+' - Controllers '

	declare @emailto varchar(max)

	select @emailto = email
	from grading_assigneeemails
	
	select @emailto = @emailto + email + ';'
	from @people 
	where tasks > 4
	and @emailto not like '%' + email + '%'
	
	declare @emailfromname varchar(1000) = @appname + '-Grading'
	
	exec dbo.xp_smtp_sendmail 
			@from = @GradingAddress, 
			@from_name = @emailfromname,
			@to='', 
			@bcc=@emailto,
			@subject=@subject,
			@message = @email
			
	set nocount off
end
GO
/****** Object:  StoredProcedure [dbo].[Grading_ControllerIPChecks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[Grading_ControllerIPChecks]
AS

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

DECLARE @Fullname varchar(50)
DECLARE @mailTo varchar(50)
DECLARE @ReportName varchar(100)
DECLARE @IP bit
DECLARE @body varchar(8000)

DECLARE UserCurs CURSOR
FOR 
SELECT    u.email, u.fullname,  r.Name AS ReportName, s.InterestedParty
FROM         	QStatus_GroupReport gr INNER JOIN
                QStatus_Supervisors s ON gr.GroupID = s.SupervisorGroupID AND gr.ReportID = s.ReportID INNER JOIN
                QCheck_Groups g ON g.ID = gr.GroupID INNER JOIN
                QStatus_Report r ON gr.ReportID = r.ID INNER JOIN
		QCheck_GroupMembership gm on g.ID = gm.GroupID INNER JOIN
		QCheck_Users u ON gm.UserID = u.ID
WHERE     (r.IsDeleted = 0) AND g.SingleMemberGroup = 1

OPEN UserCurs
FETCH NEXT FROM UserCurs INTO @mailTo, @Fullname, @ReportName, @IP
WHILE @@FETCH_STATUS = 0 BEGIN

	Set @body = '<html><head><style>body {font-family:arial;font-weight:bold;font-size:12pt}</style></head><body><p>You are currently listed both as a controller and as a'
	If @IP = 1 
		Set @body = @body + 'n interested party '
	else
		Set @body = @body + ' supervisor '

	Set @body = @body + 'on the ' + @AppName + ' status report "' + @ReportName + '".  '

	Set @body = @body + 'As you cannot be both on the same report, one of the two roles will need to be removed.</p>'

	Set @body = @body + '<p>Please do one of the following:<br>'

	Set @body = @body + '1. Go to the My Status tab and open the report.  Select Report/Controllers from the top menu, and click the X next to your name to remove yourself as a controller.</p>'

	Set @body = @body + '<p>OR</p>'

	Set @body = @body + '2. Send an email to <a href="mailto:' + @GradingAddress + '">' + @GradingAddress + '</a> and request to have yourself removed as a'

	If @IP = 1 
		Set @body = @body + 'n interested party.</p>'
	else
		Set @body = @body + ' supervisor.</p>'

	Set @body = @body + '<p>Thanks for your prompt attention.</p></body></html>'
	
	DECLARE @MailFromName VARCHAR(5000) = @AppName + ' Grading',
			@MailSubject VARCHAR(5000) = @Appname + ' status report'

	EXEC XPSendEmail
	    @FROM       = @GradingAddress,
	    @FROM_NAME  = @MailFromName,
	    @TO         = @mailTo,
	    @subject    = @MailSubject,
	    @message    = @body,
	    @type       = 'text/html',
	    @server     = @MailServer


print @mailTo
print @body

	FETCH NEXT FROM UserCurs INTO @mailTo, @Fullname, @ReportName, @IP
	END
	CLOSE UserCurs
	DEALLOCATE UserCurs
GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_AddAdjustment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE               procedure [dbo].[Grading_Daily_AddAdjustment]
	@UserID int,
	@GradingPeriodID int,
	@Reason varchar(1000),
	@Points float
	
as
begin
	set nocount on

		INSERT INTO Grading_Daily_Final
		(GradingPeriodID, UserID, Dt, Reason, Points)
		SELECT @GradingPeriodID, @UserID, getDate()
		, 'Adjustment: '+@Reason, @Points
		WHERE NOT EXISTS
			(SELECT 1 FROM Grading_Daily_Final
			WHERE GradingPeriodID = @GradingPeriodID
			AND UserID = @UserID
			AND Reason like 'Adjustment%'
			AND isDeleted = 0)

	
		exec Grading_Daily_SetScore @GradingPeriodID, @UserID


	set nocount off
end






















GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_AddOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








create                   procedure [dbo].[Grading_Daily_AddOnHold]
	@ReportID int,
	@UserID int = null,
	@StartDt datetime,
	@EndDt datetime,
	@Approved bit = 0
	
as
begin
	set nocount on

		INSERT INTO grading_onhold (ReportID, UserID, StartDt, EndDt, Approved)
		SELECT @ReportID, @UserID, @StartDt, @EndDt, @Approved
		WHERE NOT EXISTS
			(
				SELECT 1 FROM grading_onhold
				WHERE ReportID = @ReportID
					AND StartDt = @StartDt
					AND EndDt = @EndDt
					AND (
						UserID = @UserID 
						or UserID is null
					)	
			)

	set nocount off
end


























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_AddVacation]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                  procedure [dbo].[Grading_Daily_AddVacation]
	@UserID int,
	@StartDt datetime,
	@EndDt datetime,
	@Approved bit = 0
	
as
begin
	set nocount on

		INSERT INTO Grading_Vacations (UserID, StartDt, EndDt, Approved)
		SELECT @UserID, @StartDt, @EndDt, @Approved
		WHERE NOT EXISTS
			(SELECT 1 FROM Grading_Vacations
			WHERE UserID = @UserID
			AND StartDt = @StartDt
			AND EndDt = @EndDt)
		

	set nocount off
end

























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_ApproveOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








create                   procedure [dbo].[Grading_Daily_ApproveOnHold]
	@ID int
	
as
begin
	set nocount on

		Update Grading_OnHold
		SET Approved = 1
		WHERE ID = @ID
		

	set nocount off
end


























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_ApproveVacation]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







create                  procedure [dbo].[Grading_Daily_ApproveVacation]
	@ID int
	
as
begin
	set nocount on

		Update Grading_Vacations 
		SET Approved = 1
		WHERE ID = @ID
		

	set nocount off
end

























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_CalcOverdueDeductions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




















CREATE                                 procedure [dbo].[Grading_Daily_CalcOverdueDeductions]
	@dt datetime = null
as
begin
	set nocount on
			

	if @dt is null 
		SET @dt = getdate() - 1

	set @dt = convert(varchar, @dt, 101)

	delete from grading_daily
	WHERE (type = 'Status Overdue' or type = 'Checklist Overdue')
	and dt = @dt
	
		
			insert into grading_daily (userID, dt, type, description, keyID)
			select distinct d.id, @dt, 'Status Overdue', 
				c.name + ' due ' + convert(varchar,ac.duetime,101), ac.id
			from
				qcheck_activechecklists ac
			inner join qcheck_activeassignments aa
				on aa.activechecklistid = ac.id
				and ac.completeddate is null and ac.duetime < getdate() - 3
			inner join qcheck_assignments a
				on a.id = aa.assignmentsid
			inner join qcheck_groups g
				on g.id = a.GroupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				--and a.dtassigned > gm.asof
			inner join qpi_users d
				on d.id = gm.userID
			inner join qstatus_groupreport gr
				on gr.GroupID = g.ID
			inner join qstatus_report r
				on r.Id = gr.ReportID
				and r.isdeleted = 0
			inner join qstatus_tasktypes tt
				on tt.reportID = r.ID
				and tt.isdeleted = 0
			inner join qstatus_activechecklisttasktype actt
				on actt.tasktype = tt.ID
				AND actt.ActiveChecklistID = ac.id
			inner join qcheck_checklistinstances ci
				on ci.id = ac.instanceid
			inner join qcheck_checklists c
				on c.id = ci.checklistid



			insert into grading_daily (userID, dt, type, description, keyID)
			select distinct d.id, @dt, 'Checklist Overdue', 
				c.name + ' due ' + convert(varchar,ac.duetime,101), ac.id
			from
				qcheck_activechecklists ac
			inner join qcheck_activeassignments aa
				on aa.activechecklistid = ac.id
				and ac.completeddate is null and ac.duetime < getdate() - 3
			inner join qcheck_assignments a
				on a.id = aa.assignmentsid
			inner join qcheck_groups g
				on g.id = a.GroupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				--and a.dtassigned > gm.asof
			inner join qpi_users d
				on d.id = gm.userID
			inner join qcheck_checklistinstances ci
				on ci.id = ac.instanceid
			inner join qcheck_checklists c
				on c.id = ci.checklistid
			left outer join Grading_Daily gd
				on gd.dt = @dt
				and Type = 'Status Overdue'
				and keyID = ac.ID
				and gd.UserID = d.ID
			WHERE gd.keyID is null


			

	set nocount off
end

















GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_Calculate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                          procedure [dbo].[Grading_Daily_Calculate]
as
begin
	set nocount on
	
	declare @dt datetime
	SET @dt = convert(varchar, getdate() - 1, 101)

	delete from grading_daily where dt = @dt
	delete from grading_daily_comments where userreportid in
		(select id from grading_daily_userreport where dt = @dt)
	delete from grading_daily_userreport where dt = @dt
	

	DECLARE @UserID int

	EXEC Grading_Daily_CalcOverdueDeductions

	DECLARE USERCURS CURSOR
		FOR 
	SELECT DISTINCT ID
	FROM QPI_Users
	
	
	OPEN USERCURS

	FETCH NEXT FROM USERCURS INTO @UserID
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		exec Grading_Daily_CalcUser @UserID
		--print @UserID		

		FETCH NEXT FROM USERCURS INTO @UserID 
	END
	CLOSE USERCURS
	DEALLOCATE USERCURS

	exec Grading_Daily_Calculate_NoComments
	

	set nocount off
end










GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_Calculate_NoComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                                    procedure [dbo].[Grading_Daily_Calculate_NoComments]
as
begin
	set nocount on

	declare @dt datetime
	SET @dt = convert(varchar, getdate() - 1, 101)

	Insert into Grading_Daily (UserID, dt, Type, Description, KeyID)
	
	SELECT
		 a.userid, @dt, 'No Controller Comments', '', a.UserID
	FROM 
		(
			SELECT 
				ur.UserID
			FROM
				Grading_Daily_UserReport ur
			Left Outer Join
				Grading_Daily_Comments c
			ON 
				ur.ID = c.UserReportID
			WHERE
				ur.Role = 'Controller'
			AND
				ur.dt = @dt
			Group By ur.UserID
			Having count(c.CommentID) = 0
		) as a
	/*left outer join 
		Grading_Vacations v
	on
		a.userid = v.userid
	and
		v.StartDt <=@dt
	and
		v.EndDt >= @dt
	
	WHERE v.UserID is null*/

	Insert into Grading_Daily (UserID, dt, Type, Description, KeyID)
	
	SELECT
		 a.userid, @dt, 'No Supervisor Comments', '', a.UserID
	FROM 
		(
			SELECT 
				ur.UserID
			FROM
				Grading_Daily_UserReport ur
			Left Outer Join
				Grading_Daily_Comments c
			ON 
				ur.ID = c.UserReportID
			WHERE
				ur.Role = 'Supervisor'
			AND
				ur.dt = @dt
			Group By ur.UserID
			Having count(c.CommentID) = 0
		) as a
	/*left outer join 
		Grading_Vacations v
	on
		a.userid = v.userid
	and
		v.StartDt <=@dt
	and
		v.EndDt >= @dt
	WHERE v.UserID is null*/

	
	Insert into Grading_Daily (UserID, dt, Type, Description, KeyID)
	
	SELECT
		 a.userid, @dt, 'No Controller Report Comments', a.Name, a.ReportID
	FROM 
		(
			SELECT 
				ur.UserID, ur.ReportID, r.Name
			FROM
				Grading_Daily_UserReport ur
			INNER JOIN
				QStatus_Report r
			ON
				r.ID = ur.ReportID
			Left Outer Join
				Grading_Daily_Comments c
			ON 
				ur.ID = c.UserReportID
			WHERE
				ur.Role = 'Controller'
			AND
				ur.dt = @dt
			Group By ur.UserID, ur.ReportID, r.Name
			Having count(c.CommentID) = 0
		) as a
	/*left outer join 
		Grading_Vacations v
	on
		a.userid = v.userid
	and
		v.StartDt <=@dt
	and
		v.EndDt >= @dt
	and	
		v.approved = 1
	left outer join 
		Grading_OnHold h
	on
		(h.userid is null or h.userid = a.userid)
	and
		h.StartDt <=@dt
	and
		h.EndDt >= @dt
	and
		h.reportID = a.reportID
	and	
		h.approved = 1
	WHERE v.UserID is null and h.reportID is null*/


	Insert into Grading_Daily (UserID, dt, Type, Description, KeyID)
	
	SELECT
		 a.userid, @dt, 'No Report Supervisor Comments', a.Name, a.ReportID
	FROM 
		(
			SELECT 
				ur.UserID, ur.ReportID, r.Name
			FROM
				Grading_Daily_UserReport ur
			INNER JOIN
				QStatus_Report r
			ON
				r.ID = ur.ReportID
			Left Outer Join
				Grading_Daily_Comments c
			ON 
				ur.ID = c.UserReportID
			WHERE
				ur.Role = 'Supervisor'
			AND
				ur.dt = @dt
			Group By ur.UserID, ur.ReportID, r.Name
			Having count(c.CommentID) = 0
		) as a
	/*left outer join 
		Grading_Vacations v
	on
		a.userid = v.userid
	and
		v.StartDt <=@dt
	and
		v.EndDt >= @dt
	and	
		v.approved = 1
	left outer join 
		Grading_OnHold h
	on
		(h.userid is null or h.userid = a.userid)
	and
		h.StartDt <=@dt
	and
		h.EndDt >= @dt
	and
		h.reportID = a.reportID
	and	
		h.approved = 1
	WHERE v.UserID is null and h.reportID is null*/




	Insert into Grading_Daily (UserID, dt, Type, Description, KeyID)
	
	SELECT
		 distinct a.userid, @dt, 'Supervisor Unread', a.Name + ' last read ' + a.lastread, a.ReportID
	FROM 
		(

			SELECT 
				ur.UserID, ur.ReportID, r.Name, isNull(convert(varchar, lv2.lastviewed, 101), 'Never') as lastread
			FROM
				Grading_Daily_UserReport ur
			INNER JOIN
				QStatus_Report r
			ON
				r.ID = ur.ReportID
			left outer join 
				qstatus_supervisorslastviewed lv
			on 
				lv.reportID = r.ID
			and 
				lv.supervisoruserid = ur.userid
			and 
				lv.lastviewed > getdate() - 1
			left outer join 
				qstatus_supervisorslastviewed lv2
			on 
				lv2.reportID = r.ID
			and 
				lv2.supervisoruserid = ur.userid
			WHERE
				ur.Role = 'Supervisor'
			and 	
				lv.reportID is null
			AND
				ur.dt = @dt
			) as a
	/*left outer join 
		Grading_Vacations v
	on
		a.userid = v.userid
	and
		v.StartDt <=@dt
	and
		v.EndDt >= @dt
	and	
		v.approved = 1
	left outer join 
		Grading_OnHold h
	on
		(h.userid is null or h.userid = a.userid)
	and
		h.StartDt <=@dt
	and
		h.EndDt >= @dt
	and
		h.reportID = a.reportID
	and	
		h.approved = 1
	WHERE v.UserID is null and h.reportID is null*/

	set nocount off
end




















GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_CalcUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                                                 procedure [dbo].[Grading_Daily_CalcUser]
	@UserID int
as
begin
	set nocount on

	declare @dt datetime
	SET @dt = convert(varchar, getdate() - 1, 101)
		
	--insert into grading_daily (userID, dt, type, description, keyID, number)
			
	
	--insert a controller record for each report the user is a controller on
	INSERT INTO Grading_Daily_UserReport
		(dt, UserID, ReportID, Role)
	SELECT 
		@dt, @UserID, r.ID, 'Controller'
	FROM
		QCheck_GroupMembership gm
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QStatus_GroupReport gr
		ON gr.GroupID = g.ID
	INNER JOIN QStatus_Report R
		ON r.ID = gr.ReportID
		AND r.IsDeleted = 0
	WHERE
		gm.UserID = @UserID

	--insert a supervisor record for each report the user is a supervisor on
	INSERT INTO Grading_Daily_UserReport
		(dt, UserID, ReportID, Role)
	SELECT 
		@dt, @UserID, r.ID, 'Supervisor'
	FROM
		QCheck_GroupMembership gm
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QStatus_Supervisors s
		ON s.SupervisorGroupID = g.ID
		AND s.InterestedParty = 0
		AND s.DirectSupervisor = 1
	INNER JOIN QStatus_Report R
		ON r.ID = s.ReportID
		AND r.IsDeleted = 0
	WHERE
		gm.UserID = @UserID
	
	
	--insert an ip record for each report the user is an ip on
	INSERT INTO Grading_Daily_UserReport
		(dt, UserID, ReportID, Role)
	SELECT 
		@dt, @UserID, r.ID,  'InterestedParty'
	FROM
		QCheck_GroupMembership gm
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QStatus_Supervisors s
		ON s.SupervisorGroupID = g.ID
		AND s.InterestedParty = 1
		AND s.DirectSupervisor = 1
	INNER JOIN QStatus_Report R
		ON r.ID = s.ReportID
		AND r.IsDeleted = 0
	WHERE
		gm.UserID = @UserID
		
	--find all the comments for each report
	INSERT INTO Grading_Daily_Comments (UserReportID, CommentID, CommentDt, Comments)
	select distinct ur.ID, c.ID, c.commentdt, c.comments
		from QStatus_Comments C
		INNER JOIN QCheck_ActiveChecklists AC
			on c.foreignkeyID = ac.id
			and c.SpecialTask = 0	
		INNER JOIN qstatus_ActiveChecklistTaskType ACTT
			on ACTT.activechecklistid = ac.id
		INNER JOIN QStatus_TaskTypes TT
			on TT.ID = ACTT.TaskType
		INNER JOIN Grading_Daily_UserReport ur
			ON ur.dt = @dt
			AND ur.UserID = @UserID
			AND ur.UserID = c.UserID
			AND ur.ReportID = tt.ReportID
			AND convert(varchar, c.commentdt, 101) = @dt

	
	UNION ALL

	--general comments

	select distinct ur.ID, c.ID, c.commentdt, c.comments
		from QStatus_Comments C
		INNER JOIN qstatus_specialtasks st
			on c.foreignkeyID = st.id
			and c.SpecialTask = 1	
		INNER JOIN QStatus_TaskTypes TT
			on TT.ID = st.TaskType
		INNER JOIN Grading_Daily_UserReport ur
			ON ur.dt = @dt
			AND ur.UserID = @UserID
			AND ur.UserID = c.UserID
			AND ur.ReportID = tt.ReportID
			AND convert(varchar, c.commentdt, 101) = @dt

	UNION ALL

	-- archive

	select distinct ur.ID, c.ID, c.commentdt, c.comments
		from QStatus_Comments C
		INNER JOIN QCheck_ActiveChecklistArchive AC
			on c.foreignkeyID = ac.id
			and c.SpecialTask = 0	
		INNER JOIN qstatus_ActiveChecklistTaskType ACTT
			on ACTT.activechecklistid = ac.id
		INNER JOIN QStatus_TaskTypes TT
			on TT.ID = ACTT.TaskType
		INNER JOIN Grading_Daily_UserReport ur
			ON ur.dt = @dt
			AND ur.UserID = @UserID
			AND ur.UserID = c.UserID
			AND ur.ReportID = tt.ReportID
			AND convert(varchar, c.commentdt, 101) = @dt

	DELETE  Grading_Daily_Comments
	FROM  Grading_Daily_Comments gc
	INNER JOIN Grading_Daily_UserReport ur
	ON ur.ID = gc.UserReportID
	AND ur.UserID = @UserID
	AND ur.dt = @dt
	AND ur.Role = 'InterestedParty'
	and gc.CommentID in
		(SELECT gc.CommentID
		FROM Grading_Daily_Comments gc
		INNER JOIN Grading_Daily_UserReport ur
		ON ur.ID = gc.UserReportID
		AND ur.UserID = @UserID
		AND ur.dt = @dt
		AND ur.Role = 'Controller')



	set nocount off
end










GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_CalcUserScore]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                                                    procedure [dbo].[Grading_Daily_CalcUserScore]
	
	@UserID int,
	@GradingPeriodID int = null,
	@StartDt datetime = 0,
	@EndDt datetime = 0
as
begin
	set nocount on

	IF @GradingPeriodID is not null
		SELECT @StartDt = StartDt,
			@EndDt = EndDt
		FROM Grading_Daily_GradingPeriod
		WHERE ID = @GradingPeriodID

	DECLARE @Score float

	SET @Score = 100
	
	DECLARE @ControllerDeduction float
	DECLARE @NonSupervisorControllerDeduction float
	DECLARE @SupervisorDeduction float
	DECLARE @InterestedParty float
	DECLARE @ControllerReportDeduction float
	DECLARE @SupervisorReportDeduction float
	DECLARE @OverdueDeduction float
	DECLARE @ChecklistOverdueDeduction float

	SELECT @NonSupervisorControllerDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'NonSupervisorController'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @ControllerDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'SupervisorController'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @SupervisorDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'Supervisor'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @ControllerReportDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'ControllerReportDeduction'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @SupervisorReportDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'SupervisorReportDeduction'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @OverdueDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'Overdue'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @ChecklistOverdueDeduction = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'ChecklistOverdue'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	SELECT @InterestedParty = CriteriaValue
	FROM Grading_Daily_Criteria
	WHERE Criteria = 'InterestedParty'
	AND IsNull(GradingPeriodID, 0) = IsNull(@GradingPeriodID, 0)

	DECLARE @StatusOverdueDeductions int
	SELECT @StatusOverdueDeductions = Count(d.ID)
	FROM Grading_Daily d
	left outer join Grading_Daily d2
	on d.userID = d2.userID
	AND d.Type = d2.type
	AND d.KeyID = d2.KeyID	
	AND d.dt = d2.dt + 1
	AND d2.dt >= @StartDt
	AND d2.dt <= @EndDt
	WHERE d2.ID is null
	AND d.UserID = @UserID
	AND d.Type = 'Status Overdue'
	AND d.dt >= @StartDt
	AND d.dt <= @EndDt

	
	DECLARE @ChecklistOverdueDeductions int
	SELECT @ChecklistOverdueDeductions = Count(d.ID)
	FROM Grading_Daily d
	left outer join Grading_Daily d2
	on d.userID = d2.userID
	AND d.Type = d2.type
	AND d.KeyID = d2.KeyID	
	AND d.dt = d2.dt + 1
	AND d2.dt >= @StartDt
	AND d2.dt <= @EndDt
	WHERE d2.ID is null
	AND d.UserID = @UserID
	AND d.Type = 'Checklist Overdue'
	AND d.dt >= @StartDt
	AND d.dt <= @EndDt

	--controller deductions
	--look 2 days back from the start
	DECLARE @dt datetime
	SET @dt = @StartDt - 2

	--hold all the daily misses
	DECLARE @ALL table(
		dt datetime
	)
	
	--find how many consecutive
	DECLARE @CONS table(
		dt datetime,
		consecutive int,
		points float NULL
	)

	

	INSERT INTO @ALL 
	SELECT dt from Grading_Daily
	WHERE Type = 'No Controller Comments'
	AND Dt >=@dt
	AND Dt <= @EndDt
	AND UserID = @UserID
	
	DECLARE @Pts float

	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN

		SET @Pts = @NonSupervisorControllerDeduction
		SELECT @Pts = @ControllerDeduction
		FROM Grading_Daily_UserReport
		WHERE UserID = @UserID
		AND dt = @dt
		AND Role = 'Supervisor'

		INSERT INTO @CONS (dt, consecutive, points)
		SELECT a.dt, isnull(c.consecutive, 0) + 1, @Pts
		FROM @All a
		LEFT OUTER JOIN @Cons c
		on c.dt = a.dt - 1
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	

	--only count the last one
	DELETE  @Cons
	FROM @Cons c
	INNER JOIN @All a
	ON c.dt = a.dt - 1

	DECLARE @ControllerDeductionsPts float
	SET @ControllerDeductionsPts = 0

	SELECT @ControllerDeductionsPts = 
			isnull(SUM(consecutive/3 * isnull(points, @ControllerDeduction)), 0)
			--isnull(SUM(consecutive/3),0)
	FROM @CONS

	
	DELETE FROM @CONS
	DELETE FROM @ALL

	--same for supervisors

	SET @dt = @StartDt - 2

	
	INSERT INTO @ALL 
	SELECT dt from Grading_Daily
	WHERE Type = 'No Supervisor Comments'
	AND Dt >=@dt
	AND Dt <= @EndDt
	AND UserID = @UserID
	
	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN
		INSERT INTO @CONS (dt, consecutive)
		SELECT a.dt, isnull(c.consecutive, 0) + 1
		FROM @All a
		LEFT OUTER JOIN @Cons c
		on c.dt = a.dt - 1
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	--only count the last one
	DELETE  @Cons
	FROM @Cons c
	INNER JOIN @All a
	ON c.dt = a.dt - 1

	DECLARE @SupervisorDeductions int
	SET @SupervisorDeductions = 0


	SELECT @SupervisorDeductions = ISNULL(SUM(consecutive/3), 0)
	FROM @CONS

	

	DELETE FROM @CONS
	DELETE FROM @ALL


	DECLARE @InterestedPartyComments int
	SET @InterestedPartyComments = 0

	SELECT @InterestedPartyComments = 
		 count(*)
		FROM Grading_Daily_UserReport ur
		INNER JOIN Grading_Daily_Comments c
		ON c.UserReportID = ur.ID
		AND ur.dt >= @StartDt
		AND ur.dt <= @EndDt
		AND ur.Role = 'InterestedParty'
		AND ur.UserID = @UserID	


	--controller report
	SET @dt = @StartDt - 9

	--hold all the daily misses
	DECLARE @ALLREPORT table(
		dt datetime,
		reportID int
	)
	
	--find how many consecutive
	DECLARE @CONSREPORT table(
		dt datetime,
		consecutive int,
		reportID int
	)

	INSERT INTO @ALLREPORT 
	SELECT dt, keyID from Grading_Daily
	WHERE Type = 'No Controller Report Comments'
	AND Dt >=@dt
	AND Dt <= @EndDt
	AND UserID = @UserID
	
	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN

		INSERT INTO @CONSREPORT (dt, consecutive, reportID)
		SELECT a.dt, isnull(c.consecutive, 0) + 1, a.reportID
		FROM @ALLREPORT a
		LEFT OUTER JOIN @CONSREPORT c
		on c.dt = a.dt - 1
		and a.reportID = c.reportID
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	

	--only count the last one
	DELETE  @CONSREPORT
	FROM @CONSREPORT c
	INNER JOIN @ALLREPORT a
	ON c.dt = a.dt - 1
	and a.reportID = c.reportID

	DELETE FROM @CONSREPORT 
	WHERE consecutive < 10

	DECLARE @ReportControllerDeductions int
	SET @ReportControllerDeductions = 0

	SELECT @ReportControllerDeductions = 
			isnull(SUM(consecutive-9), 0)
			--isnull(SUM(consecutive/3),0)
	FROM @CONSREPORT



	DELETE FROM @CONSREPORT
	DELETE FROM @ALLREPORT



	--supervisor report
	SET @dt = @StartDt - 9


	INSERT INTO @ALLREPORT 
	SELECT dt, keyID from Grading_Daily
	WHERE Type = 'No Supervisor Report Comments'
	AND Dt >=@dt
	AND Dt <= @EndDt
	AND UserID = @UserID
	
	--loop through and find the consecutive
	WHILE @dt <= @EndDt
	BEGIN

		INSERT INTO @CONSREPORT (dt, consecutive, reportID)
		SELECT a.dt, isnull(c.consecutive, 0) + 1, a.reportID
		FROM @ALLREPORT a
		LEFT OUTER JOIN @CONSREPORT c
		on c.dt = a.dt - 1
		and a.reportID = c.reportID
		WHERE a.dt = @dt

		SET @dt = @dt + 1
	END

	

	--only count the last one
	DELETE  @CONSREPORT
	FROM @CONSREPORT c
	INNER JOIN @ALLREPORT a
	ON c.dt = a.dt - 1
	and a.reportID = c.reportID

	DELETE FROM @CONSREPORT 
	WHERE consecutive < 10
	
	DECLARE @SupervisorControllerDeductions int
	SET @SupervisorControllerDeductions = 0

	SELECT @SupervisorControllerDeductions = 
			isnull(SUM(consecutive-9), 0)
			--isnull(SUM(consecutive/3),0)
	FROM @CONSREPORT

	--SELECT * From @CONSREPORT


	
	SELECT @Score = @Score + @StatusOverdueDeductions * @OverdueDeduction
			+ @ChecklistOverdueDeductions * @ChecklistOverdueDeduction
			+ @ControllerDeductionsPts --* @ControllerDeduction
			+ @SupervisorDeductions * @SupervisorDeduction
			+ @InterestedPartyComments * @InterestedParty
			+ @ReportControllerDeductions * @ControllerReportDeduction
			+ @SupervisorControllerDeductions * @SupervisorReportDeduction
	SELECT @Score

	/*,
		@StatusOverdueDeductions,
		@ChecklistOverdueDeductions,
		@ControllerDeductionsPts,
		@SupervisorDeductions,
		@InterestedPartyComments*/
	

	set nocount off
end













GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_CreateLastGradingPeriod]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                    procedure [dbo].[Grading_Daily_CreateLastGradingPeriod]
as
begin
	set nocount on

		DECLARE @ID int
		
		DECLARE @StartDt datetime
		DECLARE @EndDt datetime
		
		SET @EndDt = convert(
			varchar,
			dateadd(day, -1 * datepart(day, getdate()), getdate()),
			101
		)

		
		set @StartDt = convert(
			varchar,
			dateadd(day, -1 * datepart(day, @EndDt), @EndDt) + 1,
			101
		)

		Insert into Grading_Daily_GradingPeriod
			(StartDt, EndDt)
		SELECT @StartDt, @EndDt
		WHERE NOT EXISTS
			(SELECT 1 FROM Grading_Daily_GradingPeriod
			WHERE StartDt = @StartDt
			AND EndDt = @EndDt
			)


		IF @@Rowcount > 0
		BEGIN
			SELECT @ID = @@IDENTITY

			INSERT INTO Grading_Daily_Criteria
			SELECT @ID, Criteria, CriteriaValue
			FROM Grading_Daily_Criteria
			WHERE GradingPeriodID is null
		END

		EXEC Grading_Daily_Finalize @ID 

	set nocount off
end



























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_DeleteDeduction]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE               procedure [dbo].[Grading_Daily_DeleteDeduction]
	@ID int,	
	@UserID int,
	@Reason varchar(1000)
	
as
begin
	set nocount on

		DECLARE @GradingPeriodID int, @FinalUserID int


		SELECT @GradingPeriodID = GradingPeriodID, @FinalUserID = UserID
		FROM Grading_Daily_Final
		WHERE ID = @ID

		UPDATE Grading_Daily_Final
		SET isDeleted = 1
		WHERE id = @ID
	
		exec Grading_Daily_SetScore @GradingPeriodID, @FinalUserID

		
		DELETE FROM Grading_Daily_Final_Deleted
		WHERE FinalID = @ID
		
		INSERT INTO Grading_Daily_Final_Deleted
		(FinalID, UserID, Reason, Dt)
		SELECT @ID, @UserID, @Reason, getdate()

	set nocount off
end






















GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_DeleteOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create                   procedure [dbo].[Grading_Daily_DeleteOnHold]
	@ID int
	
as
begin
	set nocount on

		DELETE FROM Grading_OnHold
		WHERE ID = @ID
		

	set nocount off
end


GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_DeleteVacation]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                  procedure [dbo].[Grading_Daily_DeleteVacation]
	@ID int
	
as
begin
	set nocount on

		DELETE FROM Grading_Vacations
		WHERE ID = @ID
		

	set nocount off
end

GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_Finalize]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO












CREATE                       procedure [dbo].[Grading_Daily_Finalize]
	@GradingPeriodID int
as
begin
	set nocount on

	delete from Grading_Daily_Final 
	where gradingperiodid = @GradingPeriodID

	delete from Grading_Daily_Scores
	where gradingperiodid = @GradingPeriodID

	DECLARE @UserID int

	DECLARE GradingCurs CURSOR
		FOR 
	SELECT ID
	FROM QPI_Users
	
	
	OPEN GradingCurs

	FETCH NEXT FROM GradingCurs INTO @UserID
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		exec Grading_Daily_FinalizeUser @GradingPeriodID, @UserID

		FETCH NEXT FROM GradingCurs INTO @UserID
	END
	CLOSE GradingCurs
	DEALLOCATE GradingCurs
	
	

	set nocount off
end






























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_FinalizeUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                        procedure [dbo].[Grading_Daily_FinalizeUser]
	@GradingPeriodID int,
	@UserID int
as
begin
	set nocount on

	declare @now datetime
	set @now = getdate()

	--might want to change this later to not delete adjustments
	DELETE from Grading_Daily_Final
	WHERE GradingPeriodID = @GradingPeriodID
	AND UserID = @UserID

	insert into Grading_Daily_Final (GradingPeriodID, UserID, Dt,
					Reason, Points)
	SELECT @GradingPeriodID, @UserID, dt, reason, isnull(points, 0) from 
	dbo.Grading_Daily_DeductionsTable (@UserID, @GradingPeriodID,
						null, null, @Now)

	exec Grading_Daily_SetScore @GradingPeriodID, @UserID

	set nocount off
end































GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetDeductions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                       procedure [dbo].[Grading_Daily_GetDeductions]
	
	@UserID int,
	@GradingPeriodID int = null,
	@StartDt datetime = 0,
	@EndDt datetime = 0,
	@ShowDeleted bit = 0
as
begin
	set nocount on

	
	declare @out table(
		id int,
		dt datetime,
		reason varchar(2000),
		points float,
		coltype int null,
		isdeleted bit	
	)

	declare @now datetime
	set @now = getdate()

	if @GradingPeriodID is null
		insert into @out (id, dt, reason, points, isdeleted)
			SELECT -1, dt, reason, points, 0 from 
			dbo.Grading_Daily_DeductionsTable ( @UserID, @GradingPeriodID,
								@StartDt, @EndDt, @Now)
	else
		insert into @out (id, dt, reason, points, isdeleted)
			SELECT 
				f.id, 
				f.dt,
				case when d.finalID is null then 
					f.reason 
				else
					f.reason + '<br>Removed by '+ u.fullname + ' on '+convert(varchar, d.dt, 101)+
					'<br>Reason Given: '+d.reason
				end as reason,
				f.points, 
				f.isdeleted 
			from grading_daily_final f
			left outer join grading_daily_final_deleted d
			on d.finalID = f.ID
			and f.isdeleted = 1
			left outer join qcheck_users u
			on u.id = f.UserID
			where f.gradingperiodid = @GradingPeriodID
			and f.userID = @UserID
			and (f.isDeleted = 0
			or @ShowDeleted = 1)

	DECLARE @outholding table (
		dt datetime,
		reason varchar(2000),
		points float,
		isdeleted bit)

	insert into @outholding (dt, reason, points, isdeleted) select dt, reason, points, isdeleted from @out


	insert into @out
	select -1, @EndDt, 'Total Deductions', isnull(abs(sum(points)), 0), -1, 0
	FROM @outholding
	where points < 0
	and isdeleted = 0

	
	insert into @out
	select -1, @EndDt, 'Bonus / Adjustments', isnull(sum(points), 0), 1, 0
	FROM @outholding
	where points > 0
	and isdeleted = 0

	insert into @out
	select -1, @EndDt, 'Score', 100 + isnull(sum(points), 0), 2, 0
	FROM @outholding
	where isdeleted = 0


	select 
		id, 
		convert(varchar, dt, 101) as date, reason, 
		points
		, isNull(coltype, 0) as type 
		, isdeleted
	from @out 
	order by isnull(coltype, -99), date

	
	

	set nocount off
end






























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetGradingPeriods]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





















CREATE              procedure [dbo].[Grading_Daily_GetGradingPeriods]
	
	
as
begin
	set nocount on

		SELECT ID, Convert(varchar, startdt, 101)
			+ ' to '
			+ Convert(varchar, enddt, 101)
		FROM Grading_Daily_GradingPeriod
		ORDER by 1 desc

	set nocount off
end





















GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetGrid]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                         procedure [dbo].[Grading_Daily_GetGrid]
	
	@GradingPeriodID int = null
as
begin
	set nocount on

	DECLARE @StartDt datetime
	DECLARE @EndDt datetime
	If @GradingPeriodID is not null
	BEGIN
		SELECT @StartDt = StartDt, @EndDt = EndDt
		FROM Grading_Daily_GradingPeriod
		WHERE ID = @GradingPeriodID

		DECLARE @currentusers table (
			UserID int
		)


		insert into @currentusers
		select gm.userID from qcheck_groupmembership gm
		inner join qcheck_groups g
		on g.id = gm.groupid
		and g.singlemembergroup = 1
		and gm.asof <= @StartDt
		--and convert(varchar, gm.asof,101) <= convert(varchar, @StartDt,101)

		SELECT u.id, Fullname, 
			ABS(	
				SUM(
					CASE WHEN f.Reason like 'No Controller Comments from%' THEN f.Points
					ELSE 0
					END
				)
			) AS ControllerDeductions,
			ABS(	
				SUM(
					CASE WHEN f.Reason like 'No Supervisor Comments from%' THEN f.Points
					ELSE 0
					END
				)
			) AS SupervisorDeductions,
			ABS(	
				SUM(
					CASE WHEN f.Reason like 'Overdue Task On Status Report%' THEN f.Points
					ELSE 0
					END
				)
			) AS StatusOverdue,
			ABS(	
				SUM(
					CASE WHEN f.Reason like 'Overdue Checklist%' THEN f.Points
					ELSE 0
					END
				)
			) AS ChecklistOverdue,
			ABS(	
				SUM(
					CASE WHEN f.Reason like 'Interested Party Comment%' THEN f.Points
					ELSE 0
					END
				)
			) AS IPBonus,
			ABS(	
				SUM(
					CASE WHEN f.Reason like 'No % Comments On Report%' THEN f.Points
					ELSE 0
					END
				)
			) AS TenDayDeduction,

		s.Score,
		CASE WHEN s.Score >= 90 Then 'A'
			WHEN s.Score >= 75 THEN 'C'
			ELSE 'F'
		END as Grade
		,CASE WHEN sPrev.Score is null then '-'
			WHEN sPrev.Score >= 90 Then 'A'
			WHEN sPrev.Score >= 75 THEN 'C'
			ELSE 'F'
		END as GradePrevious
		, isnull(comm.TotalComments, 0) as TotalComments
		, isnull(comm.ControllerComments, 0) as ControllerComments
		, isnull(comm.IPComments, 0) as IPComments
		, isnull(comm.SupervisorComments, 0) as SupervisorComments
		, isnull(comm.TotalCharacters, 0) as TotalCharacters
		, cast(isnull(t.controller, 0) as decimal(5,2)) 
		 + cast(isnull(t.supervisorip, 0) as decimal(5,2)) as totaltime
		, cast(isnull(t.controller, 0) as decimal(5,2)) as controllertime
		, cast(isnull(t.supervisorip, 0) as decimal(5,2)) as supervisortime
		, isnull(comm.ControllerCharacters, 0) as ControllerCharacters
		, isnull(comm.IPCharacters, 0) as IPCharacters
		, isnull(comm.SupervisorCharacters, 0) as SupervisorCharacters
		, isnull(fAdj.Points, 0) as AdjustmentPoints
		, isnull(Replace(fAdj.Reason, 'Adjustment: ', ''), '') as AdjustmentReason
		FROM Grading_Daily_Scores s
		INNER JOIN QPI_Users u
		ON u.ID = s.UserID
		INNER JOIN @currentusers cu
		on cu.userid = u.id
		INNER JOIN Grading_Daily_GradingPeriod gp
		ON gp.ID = @GradingPeriodID
		LEFT OUTER JOIN Grading_Daily_Final f
		ON f.UserID = u.ID
		AND f.GradingPeriodID = @GradingPeriodID
		AND f.isDeleted = 0
		LEFT OUTER JOIN Grading_Daily_Final fAdj
		ON fAdj.UserID = u.ID
		AND fAdj.GradingPeriodID = @GradingPeriodID
		AND fAdj.isDeleted = 0
		AND fAdj.Reason like 'Adjustment%'
		LEFT OUTER JOIN Grading_Daily_Scores sPrev
		ON sPrev.GradingPeriodID < s.GradingPeriodID 
		AND sPrev.UserID = s.UserID	
		LEFT OUTER JOIN Grading_Daily_Scores sPrev2
		ON sPrev2.GradingPeriodID < s.GradingPeriodID 
		AND sPrev2.UserID = s.UserID	
		AND sPrev2.GradingPeriodID > sPrev.GradingPeriodID
		LEFT OUTER JOIN
		(
			SELECT ur.UserID
			,count(distinct dc.commentID) as TotalComments
			,count(distinct
				case when ur.Role = 'Controller' Then dc.commentID
				else null
				end) as ControllerComments
			,count(distinct
				case when ur.Role = 'InterestedParty' Then dc.commentID
				else null
				end) as IPComments
			,count(distinct
				case when ur.Role = 'Supervisor' Then dc.commentID
				else null
				end) as SupervisorComments
			,sum(isnull(len(dc.comments), 0)) as TotalCharacters
			,sum(isnull(
					case when ur.Role = 'Controller' Then len(dc.comments)
					else 0
					end	

					, 0)) as ControllerCharacters
			,sum(isnull(
					case when ur.Role = 'InterestedParty' Then len(dc.comments)
					else 0
					end	

					, 0)) as IPCharacters
			,sum(isnull(
					case when ur.Role = 'Supervisor' Then len(dc.comments)
					else 0
					end	

					, 0)) as SupervisorCharacters
			FROM Grading_Daily_GradingPeriod gp
			LEFT OUTER JOIN	Grading_Daily_UserReport ur
			ON ur.Dt >= gp.StartDt AND ur.Dt <= gp.EndDt 
			LEFT OUTER JOIN Grading_Daily_Comments dc
			ON dc.UserReportID = ur.ID
			Where gp.ID = @GradingPeriodID
			Group by ur.UserID
		) comm on comm.UserID = u.ID	
		left outer join
		(
			select u.ID, 
				sum(case when i.issupervisor = 0 then 
					i.totalminutes
					else 0
					end) as controller, 
				sum(case when i.issupervisor = 1 then 
					i.totalminutes
					else 0
					end) as supervisorip
			 from qcheck_users u
			left outer join iis_time i
			on u.shortname = i.shortname
			where dt >= @StartDt and dt <=@EndDt
			group by u.id
		) t on t.id = u.id
		
		WHERE s.GradingPeriodID = @GradingPeriodID
		AND sPrev2.GradingPeriodID is null
		Group By u.ID, u.FullName, s.Score, sPrev.Score, comm.TotalComments, comm.TotalCharacters
			, t.controller, t.supervisorip,
			ControllerComments,IPComments,SupervisorComments,
			ControllerCharacters,IPCharacters,SupervisorCharacters,
			fAdj.Points, fAdj.Reason
		ORDER by s.Score desc, Fullname asc
	END
	

	set nocount off
end
































GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                      procedure [dbo].[Grading_Daily_GetOnHold]
	@UserID int = 0,
	@StartDt datetime,
	@EndDt datetime
	
as
begin
	set nocount on

		SELECT
			DISTINCT IsNull(u.Fullname, 'All') as [User],
			r.name as report,
			oh.ID, 
			CONVERT(varchar, oh.StartDt, 101) as StartDt,
			CONVERT(varchar, oh.EndDt, 101) as EndDt,
			CASE WHEN oh.Approved = 1 THEN 'Approved'
			ELSE 'Awaiting Approval'
			END as status
		FROM Grading_OnHold oh
		LEFT OUTER JOIN QCheck_Users u
		ON u.ID = oh.UserID
		INNER JOIN Grading_Daily_UserReport ur
		on ur.ReportID = oh.ReportID
		and (ur.UserID = @UserID or @UserID = 0)
		and ur.dt >= @StartDt
		and ur.dt <= @EndDt
		INNER JOIN QStatus_Report r
		on r.ID = oh.ReportID
		WHERE (oh.UserID = @UserID or @UserID = 0 or oh.UserID is null)
		AND (
			(oh.StartDt <=  @EndDt)
			and
			(oh.EndDt >= @StartDt)
		)
		ORDER BY 3, 1

	set nocount off
end





























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetUserReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








create                     procedure [dbo].[Grading_Daily_GetUserReports]
	
	@UserID int
as
begin
	set nocount on

	select distinct ur.reportID, r.name 
	from grading_daily_userreport ur
	inner join qstatus_report r
	on r.id = ur.reportID
	where ur.userID = @UserID
	order by r.name
	

	set nocount off
end




























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create             procedure [dbo].[Grading_Daily_GetUsers]
	
	
as
begin
	set nocount on

		SELECT ID, FullName
		FROM QPI_Users
		ORDER by 2

	set nocount off
end




















GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_GetVacations]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                   procedure [dbo].[Grading_Daily_GetVacations]
	@UserID int = 0,
	@StartDt datetime,
	@EndDt datetime
	
as
begin
	set nocount on

		SELECT
			u.Fullname,
			v.ID, 
			CONVERT(varchar, StartDt, 101) as StartDt,
			CONVERT(varchar, EndDt, 101) as EndDt,
			CASE WHEN Approved = 1 THEN 'Approved'
			ELSE 'Awaiting Approval'
			END as status
		FROM Grading_Vacations v
		INNER JOIN QCheck_Users u
		ON u.ID = v.UserID
		WHERE (UserID = @UserID or @UserID = 0)
		AND (
			(StartDt <=  @EndDt)
			and
			(EndDt >= @StartDt)
		)
		ORDER BY 1, 3

	set nocount off
end


























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_RestoreDeduction]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





create                procedure [dbo].[Grading_Daily_RestoreDeduction]
	@ID int
	
as
begin
	set nocount on

		DECLARE @GradingPeriodID int, @FinalUserID int


		SELECT @GradingPeriodID = GradingPeriodID, @FinalUserID = UserID
		FROM Grading_Daily_Final
		WHERE ID = @ID

		UPDATE Grading_Daily_Final
		SET isDeleted = 0
		WHERE id = @ID
	
		exec Grading_Daily_SetScore @GradingPeriodID, @FinalUserID

		DELETE FROM Grading_Daily_Final_Deleted
		WHERE FinalID = @ID
		

	set nocount off
end























GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_SetScore]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













create                        procedure [dbo].[Grading_Daily_SetScore]
	@GradingPeriodID int,
	@UserID int
as
begin
	set nocount on

	
	DELETE FROM Grading_Daily_Scores
		WHERE GradingPeriodID = @GradingPeriodID
		AND UserID = @UserID

	INSERT INTO Grading_Daily_Scores
		(GradingPeriodID, UserID, Score)
	SELECT @GradingPeriodID, @UserID, 100 + isnull(sum(points), 0)
	FROM Grading_Daily_Final
	WHERE GradingPeriodID = @GradingPeriodID
	AND UserID = @UserID
	AND IsDeleted = 0
	

	set nocount off
end































GO
/****** Object:  StoredProcedure [dbo].[Grading_Daily_UpdateCurrentGradingPeriod]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE                    procedure [dbo].[Grading_Daily_UpdateCurrentGradingPeriod]
as
begin
	set nocount on
	DECLARE @ID int
	
	DECLARE @StartDt datetime
	DECLARE @EndDt datetime
	DECLARE @endstring varchar(20)
	DECLARE @startstring varchar(20)

	set @endstring = cast(datepart(month,getdate()) as varchar(2)) + '/' + cast(datepart(day,getdate()) as varchar(2)) + '/' + cast(datepart(year,getdate()) as varchar(4))
	set @startstring = cast(datepart(month,getdate()) as varchar(2)) + '/1/' + cast(datepart(year,getdate()) as varchar(4))
	
	SET @EndDt = dateadd(dd,-2,(cast( @endstring as datetime)))
	SET @StartDt = cast(@startstring as datetime)

	-- If we're on the 2nd of the month, then don't increment the current period; it's done already.
	-- Just create a new one for the current month.
	if datepart(day,getdate()) != 2
	BEGIN
		SELECT @ID = ID
		FROM Grading_Daily_GradingPeriod
		WHERE StartDt = @StartDt
		AND EndDt = @EndDt
		
		UPDATE Grading_Daily_GradingPeriod
		SET EndDt = dateadd(dd,1,EndDt)
		WHERE ID = @ID
	END
	ELSE
	BEGIN
		INSERT INTO Grading_Daily_GradingPeriod (StartDt,EndDt)
		VALUES(@startdt,@startdt)
		SELECT @ID = @@IDENTITY
	END

	IF NOT EXISTS (SELECT 1 FROM Grading_Daily_Criteria WHERE GradingPeriodID = @ID)
		INSERT INTO Grading_Daily_Criteria
		SELECT @ID, Criteria, CriteriaValue
		FROM Grading_Daily_Criteria
		WHERE GradingPeriodID is null

	IF @ID IS NOT NULL 
		EXEC Grading_Daily_Finalize @ID 

	set nocount off
end
GO
/****** Object:  StoredProcedure [dbo].[Grading_GetFirstDateInRole]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE   PROCEDURE [dbo].[Grading_GetFirstDateInRole] 
@startdate datetime,
@enddate datetime

AS

IF @enddate > getdate()
	SET @enddate = cast(convert(varchar(10),getdate(),101) as datetime) - 2

SELECT     u.FullName, r.Name, up.Role, MIN(up.Dt) 
FROM         Grading_Daily_UserReport up INNER JOIN
                      QCheck_Users u ON up.UserID = u.ID INNER JOIN
                      QStatus_Report r ON up.ReportID = r.ID
WHERE     (up.Dt < @enddate + 1) AND (up.Dt > @startdate - 1) -- and (role = 'Controller' or role = 'Supervisor')
GROUP BY u.FullName, r.Name, up.Role
HAVING      (MIN(up.Dt) <> @startdate ) 
ORDER BY MIN(up.dt) desc, u.fullname
GO
/****** Object:  StoredProcedure [dbo].[Grading_GetLastDateInRole]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[Grading_GetLastDateInRole] 
@startdate datetime,
@enddate datetime

AS

IF @enddate + 2 > getdate() 
	SET @enddate = cast(convert(varchar(10),getdate(),101) as datetime) - 2

SELECT     u.FullName, r.Name, up.Role, MAX(up.Dt) 
FROM         Grading_Daily_UserReport up INNER JOIN
                      QCheck_Users u ON up.UserID = u.ID INNER JOIN
                      QStatus_Report r ON up.ReportID = r.ID
WHERE     (up.Dt < @enddate + 2) AND (up.Dt > @startdate -1) -- and (role = 'Controller' or role = 'Supervisor')
GROUP BY u.FullName, r.Name, up.Role
HAVING      (MAX(up.Dt) <> @enddate + 1) 
ORDER BY max(up.dt) desc,u.FullName
GO
/****** Object:  StoredProcedure [dbo].[Grading_IsAdmin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE               procedure [dbo].[Grading_IsAdmin]
	@UserID int,
	@IsAdmin bit output
	
as
begin
	set nocount on

		SELECT @IsAdmin = 0

		SELECT @IsAdmin = 1
		FROM Grading_Admins
		WHERE UserID = @UserID


	set nocount off
end






















GO
/****** Object:  StoredProcedure [dbo].[Grading_StartEnd]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create                      procedure [dbo].[Grading_StartEnd]
	@GradingPeriodID int,
	@StartDt datetime output,
	@EndDt datetime output
as
begin
	SELECT @StartDt = StartDt, @EndDt = EndDt
	FROM Grading_Daily_GradingPeriod
	WHERE ID = @GradingPeriodID

end
GO
/****** Object:  StoredProcedure [dbo].[InsertEmailLog]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InsertEmailLog] 
	@fromId int,
	@toAddress varchar(255),
	@subject varchar(Max)
AS
BEGIN
 declare @toId int=-1;

 select @toId=ID from QCheck_Users where email=@toAddress and empID>0


	INSERT INTO [dbo].[QCheck_Log_Emails]
           ([FromId]
           ,[ToId]
           ,[Subject]
           ,[Sent])
     VALUES
           (@fromId
           ,@toId
           ,@subject
           ,Getdate())

	if @fromId in (select userid from QCheck_CurrentBonusUsers) and @subject = 'PriorityList' and @fromId <> @toId
	begin
		insert into PriorityList_BonusSend
		select pl.userid, pl.activechecklistid, getdate() 
		from prioritylist pl
			left outer join PriorityList_BonusSend plb
				on plb.userid = pl.userid and plb.activechecklistid = pl.activechecklistid and plb.dt > cast(getdate() as date)
		where pl.userid = @fromId
		and plb.dt is null
	end
END


GO
/****** Object:  StoredProcedure [dbo].[InsertPrioritySchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InsertPrioritySchedule] 
	@supervisorId int,
	@subOrdinateId int,
	@daysOfWeek varchar(10),
	@timesOfDay varchar(250),
	@reportDay varchar(10)

AS
BEGIN
if Exists( select 1 from Schedule_PriorityList where EmployeeID=@subOrdinateId and DaysOfWeek=@daysOfWeek  and IsActive=1)

Begin


Update [dbo].[Schedule_PriorityList] set IsActive=0,ModifiedDate=GETDATE(),ModifiedBy=@supervisorId
where DaysOfWeek=@daysOfWeek and EmployeeID=@subOrdinateId and IsActive=1

End

	INSERT INTO [dbo].[Schedule_PriorityList]
           ([SupervisorID]
           ,[EmployeeID]
           ,[DaysOfWeek]
           ,[TimesOfDay]
		   ,ReportDay
           ,[CreatedDate]
           ,[CreatedBy]
           ,[ModifiedDate]
           ,[ModifiedBy]
           ,[IsActive])
     VALUES
           (@supervisorId
           ,@subOrdinateId
           ,@daysOfWeek
           ,@timesOfDay
		   ,@reportDay
           ,GetDate()
           ,@supervisorId
           ,null
           ,null
           ,1)

END



GO
/****** Object:  StoredProcedure [dbo].[InsertSupervisorsPrioritiesReportSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InsertSupervisorsPrioritiesReportSchedule] 
	@userId int,
	
	@daysOfWeek varchar(10),
	
	@offsetDays varchar(10)

AS
BEGIN
	INSERT INTO [dbo].[Supervisor_PriorityList_Report_Schedule]
           ([SupervisorID]
           ,[DaysOfWeek]
           ,[DaysOffset]
           ,[CreatedDate]
           ,[CreatedBy]
           ,[ModifiedDate]
           ,[ModifiedBy]
           ,[IsActive])
     VALUES
           (@userId
           ,@daysOfWeek
           ,@offsetDays
           ,GETDATE()
           ,@userId
           ,null
           ,null
           ,1)
END



GO
/****** Object:  StoredProcedure [dbo].[JB_Tasks_Archive_Full_Populate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   proc [dbo].[JB_Tasks_Archive_Full_Populate]
AS
	
	Truncate table JB_Tasks_Archive_Full
	
	Insert into JB_Tasks_Archive_Full
		SELECT  
			jbt.BondId, actt.activechecklistid, r.name as Report, r.id, ck.name as Checklist, 
			c.comments, ac.duetime, c.commentdt, c.replyid, c.displayorder, c.tabin, c.initials, c.id
		FROM 
			QStatus_ActiveChecklistTaskTypeArchive actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_commentArchive c on c.foreignkeyid = actt.activechecklistid inner join
			qcheck_ActivechecklistArchive ac on actt.activechecklistid = ac.id inner join
			qcheck_checklistinstanceArchive ci on ac.instanceid = ci.id	inner join 
			qcheck_ChecklistArchive ck on ci.checklistid = ck.id inner join
			qstatus_report r on tt.reportid = r.id INNER JOIN
			JB_Tasks jbt ON actt.ActiveChecklistID = jbt.TaskID
		WHERE
			CAST(CONVERT(varchar(10),c.CommentDt,101) AS Datetime) >= CAST(CONVERT(varchar(10),DATEADD(dd, 9999 * -1,getdate()),101) AS Datetime)



GO
/****** Object:  StoredProcedure [dbo].[Mobile_GetInboxView]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Mobile_GetInboxView]
	@UserID int
as
begin

		SELECT distinct s.ReportID, 
			LastReportDate, 
			CASE WHEN LastViewed > 0 THEN LastViewed ELSE NULL END AS LastViewed,
			dbo.QStatus_GetUserNames(r.ID) + r.Name as fullname
			,CASE WHEN f.ReportID IS NULL THEN 'non' ELSE '' END as IsFav,
			s.InterestedParty
		FROM
		
			QStatus_Report r
		LEFT OUTER JOIN
			QStatus_SupervisorsLastViewed lv
		ON
			lv.SupervisorUserID = @UserID
		AND
			lv.ReportID = r.ID
		INNER JOIN
			QStatus_Supervisors s
		ON
			r.ID = s.ReportID
		AND
			s.DirectSupervisor = 1

		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = s.SupervisorGroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		LEFT OUTER JOIN 
				QStatus_Favorites f
			ON
				f.UserID = @UserID
			AND
				f.ReportID = r.ID
		WHERE
			r.IsDeleted = 0
			and not 
				r.id in (select reportID from 
						QStatus_GroupReport gr
					 INNER JOIN
						QCheck_Groups g
					ON
						g.ID = gr.GroupID
					INNER JOIN
						QCheck_GroupMembership gm
					ON
						gm.GroupID = g.ID
					AND
						gm.UserID = @UserID)
		ORDER BY FullName,LastReportDate desc
		
end
GO
/****** Object:  StoredProcedure [dbo].[Mobile_GetReportList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                                   PROCEDURE [dbo].[Mobile_GetReportList]
	@UserID int,
	@IncludeDefault bit = 1
AS
BEGIN

		SELECT 
			DISTINCT r.[ID],
		     	replace(replace(r.Name, '&', '&amp;'),'"', '&quot;') AS [Description],
			 case when @IncludeDefault = 0  then '' else 	isnull(
				' (' + 
				
				case (datediff(day, convert(datetime, convert(varchar, commentdt, 101)), convert(datetime, convert(varchar, getdate(), 101))))
				when 0 then 'today'
				when 1 Then '1 day ago'
				else
					convert(varchar, datediff(day, convert(datetime, convert(varchar, commentdt, 101)), convert(datetime, convert(varchar, getdate(), 101)))) + ' days ago'
				end
				+ ')'
				, '')  end
			AS [LastCommented]
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		LEFT OUTER JOIN QStatus_ReportLastestComments lastcomment
			on lastcomment.reportID = r.ID
			and lastcomment.userID = @UserID
		WHERE
			r.IsDeleted = 0
END



GO
/****** Object:  StoredProcedure [dbo].[Mobile_GetUserChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- Mobile_GetUserChecklists @UserID=471, @startDate='4/1/2013', @endDate='5/1/2013'

CREATE	PROCEDURE [dbo].[Mobile_GetUserChecklists](
	@UserID int,
	@activeChecklistID int = 0,
	@instanceID int = 0,
	@startDate datetime = null,
	@endDate datetime = null,
	@recurrance int = 0,
	@taskID int = null
)
 AS
BEGIN
	SET NOCOUNT ON
	
		-- get current checklists
		SELECT DISTINCT
		c.Name as ChecklistName, 
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		e.CompletedDate,
		d.ID as ItemID, 
		a.ID As Identifier, 
		--a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetActiveChecklistControllers(a.ID) AS Controllers,
		--dbo.QStatus_GetChecklistReports(a.ID, @UserID) as StatusReportString
		isnull(ccl.controllers, '') as Controllers,
		isnull(trl.reportslist, '') as StatusReportString,
		isnull(al.assignees,'') as Assignees
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and @recurrance = 2) and Not (s.freqType > 1 and @recurrance = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_GroupMembership gm on gm. UserID = @UserID
			INNER JOIN QCheck_Groups g on g.ID = gm.GroupID
			INNER JOIN QCheck_Assignments f on f.GroupID = gm.GroupID And f.IsDeleted = 0 and f.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
			LEFT OUTER JOIN QStatus_TaskReportList trl on trl.activechecklistid = a.id and trl.userid = @UserID
	        LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
	     	WHERE
		(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate())))
		AND (@activeChecklistID = 0 or a.ID = @activeChecklistID)
		AND @instanceID = 0
		AND a.dueTime between @startDate and @endDate
		AND a.CompletedDate IS NULL
		AND a.ID = ISNULL(@taskID, a.ID)

		ORDER BY --ChkType,
			Computed desc,
			dueSort,
			ChecklistName,
			Identifier,
			SequenceNum
		
	SET NOCOUNT OFF
END

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[MonthlyCheck]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[MonthlyCheck] (
	@Clean BIT = 0
) AS

-- Get app configuration
DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50)		
SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress FROM QCheck_AppSettings WHERE ID = 1

select 'GROUPS WITHOUT OWNERS'
select g.name, u.fullname, g.id, dbo.[QCheck_GroupMemberList_WithIDs](g.id) 
from qcheck_groups g
	left outer join qcheck_users u
		 on g.owner = u.id
where g.singlemembergroup = 0
	and (u.id is null or u.isdeleted = 1)
order by 1


select 'USERS WITHOUT SUPERVISORS'
select * from qcheck_users where isdeleted = 0 and id not in
(select userid from qstatus_usersupervisors)


--users who need to be outprocessed
select 'USERS WHO NEED TO BE OUTPROCESSED'
select g.name, @AppURL + '/reassign.aspx?r='+
	convert(varchar(10), u.id) + '&q='+
	convert(varchar(10), u.id-5) + '&s='+
	convert(varchar(10), u.id+2) + '&t='+
	convert(varchar(10), u.id*2-4) as url,
	'exec Outprocessing ' + convert(varchar(10), u.id) 
from qcheck_groups g
inner join qcheck_groupmembership gm
on gm.groupid = g.id
and g.singlemembergroup = 1
inner join qcheck_users u
on u.id = gm.userid
and u.isdeleted = 1
order by 1

--users who supervise themselves
select 'USERS WHO SUPERVISE THEMSELVES - SEND TO NELSON'
SELECT DISTINCT u.FullName, u.id, case when o.userid is null then '' else 'override' end
FROM QStatus_UserSupervisors us
INNER JOIN QCheck_Users u ON us.UserID = u.ID
left outer join QStatus_SupervisorOverride o
	on o.userid = u.id
left outer join [tblEmployees] e
	on e.networklogin = u.shortname
WHERE us.UserID = us.SupervisorUserID
	and isnull(e.hiredate, 0) < getdate() - 7
ORDER BY u.FullName


--groups who have inactive users
select 'GROUPS WITH INACTIVE USERS Or No Users'
select g.*, u.fullname
from qcheck_groups g
left outer join qcheck_groupmembership gm
on gm.groupid = g.id
left outer join qcheck_users u
on u.id = gm.userid
and u.isdeleted = 0
where u.id is null

--reports with deleted groups assigned
select 'REPORTS WITH DELETED GROUPS ASSIGNED'
select groupid, r.name, gr.id, r.id from qstatus_groupreport gr
inner join qstatus_report r
on r.id = gr.reportid
and r.isdeleted = 0
where groupid not in (select id from qcheck_groups)

--reports with no group assigned
select 'REPORTS WITH NO GROUP ASSIGNED'
select * from qstatus_report r
where r.id not in (select reportID from qstatus_groupreport) 
and r.isdeleted = 0

IF @Clean = 1 BEGIN
	update qstatus_report
	set isdeleted = 1
	where id not in (select reportID from qstatus_groupreport) 
	and isdeleted = 0
END

--reports who have an inactive user assigned
select 'REPORTS WITH INACTIVE USERS ASSIGNED'
select r.id, r.name, g.name, grp.userid, u.* from qstatus_report r
left outer join qstatus_groupreport gr
on r.id = gr.reportid
left outer join qcheck_groups g
on g.id = gr.groupid
left outer join qcheck_groupmembership grp
on grp.groupid = g.id
left outer join qcheck_users u
on u.id = grp.userid
and u.isdeleted = 0
where r.isdeleted = 0
and u.id is null
order by g.name, r.name

IF @Clean = 1 BEGIN
	DELETE QStatus_GroupReport
	select gr.*
	from qstatus_report r
	left outer join qstatus_groupreport gr
	on r.id = gr.reportid
	left outer join qcheck_groups g
	on g.id = gr.groupid
	left outer join qcheck_groupmembership grp
	on grp.groupid = g.id
	left outer join qcheck_users u
	on u.id = grp.userid
	and u.isdeleted = 0
	where r.isdeleted = 0
	and u.id is null
END

--check for reports older than 90 days
select 'REPORTS OLDER THAN 90 DAYS'
select * from qstatus_report
where isdeleted = 0
and dateadd(day, 90, lastreportdate) < getdate()


select 'USERS WITH NO COMMENTS IN 90 DAYS'
select u.fullname from qcheck_users u
left outer join qstatus_comments c
on u.id = c.userid
and c.commentdt> getdate() -90
where u.isdeleted = 0
and c.userid is null
order by 1








GO
/****** Object:  StoredProcedure [dbo].[Outprocessing]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROC [dbo].[Outprocessing] (
--	DECLARE
	@username VARCHAR(50)-- = '800'
) AS

-- Get app configuration
DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50)		
SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress FROM QCheck_AppSettings WHERE ID = 1

DECLARE @id INT,
	@count INT

IF IsNumeric(@username) = 1 BEGIN

	SET @id = CONVERT(INT, @username)
	select * from QCheck_Users where ID = @id

END ELSE BEGIN

	select * from QCheck_Users where Shortname = @username

	SET @count = 0
	SELECT @count = COUNT([id]) 
	FROM QCheck_Users
	WHERE ShortName = @username

	IF @count = 0 OR @count > 1 BEGIN
		SELECT CONVERT(VARCHAR(10), @count) + ' IDs FOUND FOR THIS USERNAME!!!'
		SELECT * FROM QCheck_Users WHERE ShortName = @username
	END

	SELECT @id = [ID]
	FROM QCheck_Users
	WHERE ShortName = @username

END

select g.name as 'Shared Groups' from qcheck_groupmembership gm
inner join qcheck_groups g
on gm.groupid = g.id
where gm.userID = @id
and g.singlemembergroup = 0
and gm.groupid in (select gm2.groupid from qcheck_groupmembership gm2
		inner join qcheck_users u2
		on gm2.userid = u2.id
		and gm2.userid <> @id
		and gm2.groupid = gm.groupid
		and u2.isdeleted = 0)
order by 1

select g.name as 'Unshared Groups' from qcheck_groupmembership gm
inner join qcheck_groups g
on gm.groupid = g.id
where gm.userID = @id
and gm.groupid not in( select gm2.groupid from qcheck_groupmembership gm2
		inner join qcheck_users u2
		on gm2.userid = u2.id
		and gm2.userid <> @id
		and gm2.groupid = gm.groupid
		and u2.isdeleted = 0)
order by 1


declare @url varchar(1000)

select @url = @AppURL + '/reassign.aspx?r='+
	convert(varchar(10), @id) + '&q='+
	convert(varchar(10), @id-5) + '&s='+
	convert(varchar(10), @id+2) + '&t='+
	convert(varchar(10), @id*2-4)

select @url [Outprocessing Link]

Select s.FullNameWithAlias [Supervisor Name] from Qcheck_Users u
JOIN tblemployees e ON u.empID = e.EmpId
JOIN tblemployees s ON e.SupervisorID = s.EmpId
WHERE u.ID = @id

GO

/****** Object:  StoredProcedure [dbo].[PriorityList_AddDefault]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE proc [dbo].[PriorityList_AddDefault]
	@UserID int,
	@Days int = 7
AS
BEGIN
	
	DECLARE @MaxPriority int

	SELECT @MaxPriority = max(priority)
	FROM PriorityList
	WHERE UserID = @UserID

	IF isnull(@MaxPriority, 0) <= 0 SET @MaxPriority = 0
	
	DECLARE @newtasks table
	(
		priority int identity(1,1),
		activechecklistid int,
		duetime datetime
	)	


	insert into @newtasks (activechecklistid, duetime)
	select distinct activechecklistid, ac.duetime from qcheck_activechecklists ac
	inner join qcheck_activeassignments aa
	on ac.id = aa.activechecklistid
	inner join qcheck_assignments a
	on a.id = aa.assignmentsid
	and a.isdeleted = 0
	inner join qcheck_groups g
	on g.id = a.groupid
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	where gm.userid = @UserID
	and ac.duetime < convert(datetime, convert(varchar, getdate() + @Days, 101))
	and ac.duetime >= convert(datetime, convert(varchar, getdate(), 101))
	and ac.completeddate is null
	and activechecklistid not in (select activechecklistid from prioritylist where userid = @userid)
	order by ac.duetime asc	

	insert into PriorityList (UserID, ActiveChecklistID, Priority)
	select @UserID, activechecklistid, priority + isnull(@MaxPriority, 0)
	from @newtasks
	
END













GO
/****** Object:  StoredProcedure [dbo].[PriorityList_AddTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE    proc [dbo].[PriorityList_AddTask]
	@UserID int,
	@ActiveChecklistID int,
	@Priority int = 0
AS
BEGIN
	
	DECLARE @ID int
	DECLARE @MaxPriority int
	SET @MaxPriority = 0

	SELECT @MaxPriority = max(priority)
	FROM PriorityList
	WHERE UserID = @UserID
	
	INSERT INTO PriorityList (UserID, ActiveChecklistID, Priority)
	SELECT @UserID, @ActiveChecklistID, isnull(@MaxPriority, 0) + 1 
	WHERE NOT EXISTS (Select 1 from PriorityList where userid = @userid and activechecklistid = @activechecklistid)
	
	SELECT @ID = SCOPE_IDENTITY()
	
	IF @Priority > 0 AND @Priority < (@MaxPriority + 1)
	BEGIN
		EXEC [PriorityList_MoveTask] @ID, @Priority
	END
	
END





GO
/****** Object:  StoredProcedure [dbo].[PriorityList_AddTask_ByName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[PriorityList_AddTask_ByName] (
	@UserID INT,
	@TaskName VARCHAR(500),
	@Priority INT = 0
) AS

BEGIN

	DECLARE @ActiveChecklistID INT
	
	SELECT TOP 1
		@ActiveChecklistID = ac.ID
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON c.ID = ci.ChecklistID
		INNER JOIN QCheck_ActiveChecklists ac
			ON ci.ID = ac.InstanceID
	WHERE
		c.Name = @TaskName
		AND c.[Owner] = @UserID
		AND c.IsDeleted = 0
		AND ci.CreatedBy = @UserID
		AND ci.IsDeleted = 0
	ORDER BY
		ac.DueTime
		
	EXEC PriorityList_AddTask @UserID, @ActiveChecklistID, @Priority

END
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_AddTask_ForGroup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[PriorityList_AddTask_ForGroup] 
	@SupervisorID int,
	@GroupID int,
	@ActiveChecklistID int,
	@Priority int = 0
AS
BEGIN

	DECLARE @UserID int
	DECLARE @IsSupervisor bit = 0
	DECLARE GroupCurs CURSOR FOR 
		SELECT UserID From QCheck_GroupMembership
		WHERE GroupID = @GroupID

	OPEN GroupCurs

	FETCH NEXT FROM GroupCurs INTO @UserID
	WHILE @@FETCH_STATUS = 0 BEGIN

		IF @UserID in (select UserID from QStatus_UserSupervisors where SupervisorUserID = @SupervisorID or UserID = @UserID)
		BEGIN
			EXEC [PriorityList_AddTask] @UserID, @ActiveChecklistID, @Priority
		END
		
		FETCH NEXT FROM GroupCurs INTO @UserID

	END

	CLOSE GroupCurs
	DEALLOCATE GroupCurs
END
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_AddTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE     proc [dbo].[PriorityList_AddTasks]
	@UserID int,
	@ActiveChecklistIDs varchar(1000)
AS
BEGIN
	DECLARE @ID_list TABLE
	(
		ID int IDENTITY(1,1),
		ActiveChecklistID int
	)
	DECLARE @rowcount int, @i int, @ActiveChecklistID int


	INSERT INTO @ID_list
	SELECT n FROM dbo.Util_fn_List_To_Table(@ActiveChecklistIDs,';')
	where n is not null

	SELECT @rowcount = @@ROWCOUNT
	SELECT @i = 1
	
	WHILE @i <= @rowcount
	BEGIN
		SELECT @ActiveChecklistID = ActiveChecklistID
		FROM @ID_list
		WHERE [ID] = @i
		
		EXEC PriorityList_AddTask @UserID, @ActiveChecklistID

		SET @i = @i + 1
	END

	
END






GO
/****** Object:  StoredProcedure [dbo].[PriorityList_Clear]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







create      proc [dbo].[PriorityList_Clear]
	@UserID int
AS
BEGIN
	
	DELETE
	FROM PriorityList
	WHERE UserID = @UserID
	
END







GO
/****** Object:  StoredProcedure [dbo].[PriorityList_EmailTest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PriorityList_EmailTest] 
	@employee varchar(100)
	,@supervisorId int
	,@excludedDate datetime
AS
BEGIN
    Declare @empID int=0

	select @empID=u.ID from QCheck_Users u where FullName=@employee and IsDeleted=0
	if(NOT Exists(select 1 from [Schedule_PriorityList_Exclude] where EmpID=@empID  and ExcludedDate=@excludedDate and IsActive=1))
	Begin
	--INSERT INTO [dbo].[Schedule_PriorityList_Exclude]
 --          ([EmpID]
	--	   ,SupervisorId
 --          ,[ExcludedDate]
	--	   ,IsActive)
 --    VALUES
 --          (@empID
	--	   ,@supervisorId
 --          ,@excludedDate
	--	   ,1)
   
    if(Exists(select 1 from PriorityList_LateFee_Log where EmpID=@empID and LateDate=@excludedDate and IsActive=1 ))
	Begin
	Declare @currentLateCharge money=0
	select @currentLateCharge=Isnull(Sum(LateCharge),0) from PriorityList_LateFee_Log where EmpID=@empID and Convert(Date,LateDate)>=Convert(Date,@excludedDate) and IsActive=1
	
	Create table #ReRunDates
   (
    seq int identity(1,1),
    RunDate datetime
   )

   declare @startDate Datetime=Convert(Date,@excludedDate+1)
     declare @endDate Datetime=Convert(Date,GETDATE()-1)

   Insert into #ReRunDates(RunDate)
   SELECT dateadd(day, datediff(day,'19000101',dt.WeekDayDate), '23:59')
   from [dbo].[Util_fn_List_DateRange](@startDate,@endDate) dt 

   Declare @runDatesCounter int=1
   Declare @runDatesCount int=0
   select * from #ReRunDates
   select @startDate,@endDate
   select @runDatesCount=count(*) from #ReRunDates
   while(@runDatesCounter<=@runDatesCount)
   Begin
   Declare @runDate datetime;
   select @runDate=RunDate from #ReRunDates where Seq=@runDatesCounter
  -- EXEC	[dbo].[PriorityList_Record_LateFee_Employee] @ReportEndDate = @runDate,@employeeId=@empID
		
   set @runDatesCounter=@runDatesCounter+1
   End



   Drop table #ReRunDates


    DECLARE @BodyController varchar(max), @Subject varchar(1000),@MailServer VARCHAR(50),@assigneeEmailAddress VARCHAR(100),@supervisorEmailAddress varchar(100)

	SELECT @MailServer = MailServer 
		FROM QCheck_AppSettings WHERE ID = 1

    select @assigneeEmailAddress=u.Email from QCheck_Users u where FullName=@employee and IsDeleted=0

	select @supervisorEmailAddress=u.Email from QCheck_Users u where u.ID=@supervisorId and IsDeleted=0


	SET @bodyController ='<html><body><H3>Missed Priority List for '+CAST(@excludedDate as varchar(12))+' has been Excused</H3></body></html>'
            
	DECLARE @FromAddress VARCHAR(100) = (SELECT TOP 1 PriorityExcusedAddress FROM QCheck_AppSettings)

	EXEC dbo.xp_smtp_sendmail --this email is for Assignee
		@from = @FromAddress, 
		@to = @assigneeEmailAddress, 
		--@cc= 'vkanakamedala@acmewidget.com',
		@subject = 'Missed Priority List Excused',
		@message = @bodyController, 
		@type = 'text/html', 
		@server = @MailServer

	End

	End

 


END

GO
/****** Object:  StoredProcedure [dbo].[PriorityList_Exclude_Insert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PriorityList_Exclude_Insert] 
--DECLARE
	 @FromAddress varchar(500) --= 'kcroft@acmewidget.com'
	,@ToAddress varchar(8000) --= 'kshannon@acmewidget.com,nholm@acmewidget.com,priorityexcused@automation.acmenetwork.com,bteague@acmewidget.com,,,,'
	,@excludedDate datetime --= '2020-01-24'
	,@answer varchar(50) --= 'NO'
AS
BEGIN
    DECLARE  @isSupervisorToAddress bit=0
	DECLARE  @isSupervisorFromAddress bit=0
	DECLARE	 @sendproblememail bit = 0 
	DECLARE @PriorityExcusedAddress VARCHAR(100) = (SELECT TOP 1 PriorityExcusedAddress FROM QCheck_AppSettings)
	set @ToAddress=REPLACE(@ToAddress,@PriorityExcusedAddress,'')--added this so that priorityexcused email address can be included in the To or CC list
	--set @ToAddress=REPLACE(@ToAddress,',','')--added this so that priorityexcused email address can be included in the To or CC list
			
	DECLARE @addresses TABLE (seq int IDENTITY(1,1), address varchar(500))
	DECLARE @supervisorAddress varchar(500), @firstToAddress varchar(500)

	INSERT INTO @addresses SELECT c FROM dbo.Util_fn_List_To_Table(@ToAddress, ',') WHERE c IS NOT NULL AND LEN(c) > 0
	
	--check for TO address matching an individual in 		
	select TOP 1 @isSupervisorToAddress=1, @supervisorAddress = a.address
	from qstatus_supervisors s
	inner join qstatus_report r
	on r.id = s.reportid
	--and r.isdeleted = 0
	inner join qcheck_groups g
	on g.id = s.supervisorgroupid
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	--and gm.userid = (select ID from QCheck_Users where Email=@ToAddress and IsDeleted=0)
	INNER JOIN QCheck_Users u 
	ON u.ID = gm.UserID and u.IsDeleted = 0
	INNER JOIN @addresses a
	ON a.address = u.Email
	inner join qstatus_groupreport gr
	on gr.reportid = r.id
	and gr.defaultreport = 1
	inner join qcheck_groups g2
	on g2.id = gr.groupid
	inner join qcheck_groupmembership gm2
	on gm2.groupid = g2.id
	and gm2.UserID = (select ID from QCheck_Users where Email=@FromAddress and IsDeleted=0)
	where s.interestedparty = 0
	ORDER BY a.seq

	--To be treated as a response from a supe, the supe must supervise the requestor's report (not just any report)
	--In a Reply All to the original request, the first addressed recipient should be the requestor.
	SELECT TOP 1 @firstToAddress = address FROM @addresses ORDER BY seq

	select @isSupervisorFromAddress=1, @supervisorAddress = @FromAddress from 
	qstatus_supervisors s
	inner join qstatus_report r
	on r.id = s.reportid
	--and r.isdeleted = 0
	inner join qcheck_groups g
	on g.id = s.supervisorgroupid
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	and gm.userid = (select ID from QCheck_Users where Email=@FromAddress and IsDeleted=0)
	inner join qstatus_groupreport gr
	on gr.reportid = r.id
	and gr.defaultreport = 1
	inner join qcheck_groups g2
	on g2.id = gr.groupid
	inner join qcheck_groupmembership gm2
	on gm2.groupid = g2.id
	and gm2.UserID = (select ID from QCheck_Users where Email=@firstToAddress and IsDeleted=0)
	where s.interestedparty = 0

	if not exists (select 1 from QCheck_Users where Email=@supervisorAddress and IsDeleted=0)
	begin
		set @sendproblememail = 1
	end

	--SELECT * from @addresses

	--SELECT @isSupervisorFromAddress isSupervisorFromAddress, 
	--@isSupervisorToAddress isSupervisorToAddress, 
	--@supervisorAddress supervisorAddress, 
	--@FromAddress FromAddress,
	--@firstToAddress firstToAddress,
	--@sendproblememail sendproblememail
	
	if(@FromAddress<>@ToAddress)
	Begin
		if(@isSupervisorFromAddress=1)
		Begin
			if(UPPER(RTRIM(LTRIM(@answer)))='N' OR UPPER(RTRIM(LTRIM(@answer)))='NO')
			Begin
				
				Update [Schedule_PriorityList_Exclude]
				set IsActive=0 where EmpID=(select u.ID from QCheck_Users u where u.Email=@firstToAddress and IsDeleted=0)
				and SupervisorId=(select u.ID from QCheck_Users u where u.Email=@FromAddress and IsDeleted=0)
				--and Convert(date,ExcludedDate)=Convert(date,@excludedDate)
				and Convert(date,ExcludedDate)=Convert(date,getdate())--this assumes supervisor declines the request on the same day of when it was submitted
		 
			End
		End
		ELSE if(@isSupervisorToAddress=1)
		Begin
			INSERT INTO [dbo].[Schedule_PriorityList_Exclude]
				   ([EmpID]
				   ,SupervisorId
				   ,[ExcludedDate])
			 VALUES
				   ((select u.ID from QCheck_Users u where u.Email=@FromAddress and IsDeleted=0)
				   ,(select u.ID from QCheck_Users u where u.Email=@supervisorAddress and IsDeleted=0)
				   ,(case 
					 when Convert (date,@excludedDate)='01/01/1900'
					Then getdate()
					else dateadd(day, datediff(day,'19000101',@excludedDate), Cast(COnvert(Time,GetDate()) as Datetime  ))
					End))
			 
		End
		Else
		Begin
			set @sendproblememail = 1
		End
	End
	
	if @sendproblememail = 1
	begin
	
		-- Get app configuration
		DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @AppFromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
		SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @AppFromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer 
		FROM QCheck_AppSettings WHERE ID = 1
		
		DECLARE @ExcuseEmail varchar(500)
		SELECT @ExcuseEmail = PermissionValue from dbo.[APP_SpecificPermissions]
		WHERE appID = @Appname and permissiontype = 'excuseemail'
		
		DECLARE @Body varchar(max), @Subject varchar(100)
		SET @Body = 'Unable to record priority excuse sent from ' + @FromAddress + ' to ' + COALESCE(@supervisorAddress, @ToAddress, '(none specified)') + '.<br/><br/>Please make sure your supervisor''s email is the only address in the TO line (and just 1 supervisor, if you have multiple you can include them in the CC line).'
		SET @Subject = 'Priority Excuse Email Failed'
		
		
		EXEC dbo.xp_smtp_sendmail 
		@from = @AppFromAddress, 
		@to = @FromAddress, 
		@cc = @ExcuseEmail,
		@subject = @Subject,
		@message = @Body, 
		@type = 'text/html', 
		@server = @MailServer
		
		--select @AppFromAddress, @FromAddress, @ExcuseEmail, @Subject, @Body, @MailServer
	end
	
	
END

GO
/****** Object:  StoredProcedure [dbo].[PriorityList_ExcludeTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE       proc [dbo].[PriorityList_ExcludeTasks]
	@UserID int,
	@ForUserID int,
	@ActiveChecklistIDs varchar(1000)
AS
BEGIN
	INSERT INTO PriorityList_Exclude
	SELECT @UserID, @ForUserID, n FROM dbo.Util_fn_List_To_Table(@ActiveChecklistIDs,';')
	where n is not null

END









GO
/****** Object:  StoredProcedure [dbo].[PriorityList_GetAvailableTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE        PROC [dbo].[PriorityList_GetAvailableTasks]
	@UserID int,
	@SourceUserID int
AS

	select distinct activechecklistid, c.name, convert(varchar, ac.duetime, 101) as duetime, cast(ac.duetime as datetime)
	from qcheck_activechecklists ac
	inner join qcheck_checklistinstances ci
	on ci.id = ac.instanceid
	inner join qcheck_checklists c
	on c.id = ci.checklistid
	inner join qcheck_activeassignments aa
	on ac.id = aa.activechecklistid
	inner join qcheck_assignments a
	on a.id = aa.assignmentsid
	inner join qcheck_groups g
	on g.id = a.groupid
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	left outer join PriorityListCrossReference cr
	on cr.crossreferenceid = gm.userid
	where (gm.userid = @UserID or cr.userID = @UserID)
	and (ac.completeddate is null or ac.completedby is null)
	and c.isdeleted =0
	and ci.isdeleted = 0
	and a.isdeleted = 0
	and activechecklistid not in (select activechecklistid from prioritylist where userid = @UserID)
	and activechecklistid not in
		(Select activechecklistID from PriorityList_Exclude
			Where UserID = @SourceUserID
			AND ForUserID = @UserID)
	order by cast(ac.duetime as datetime) asc	









GO
/****** Object:  StoredProcedure [dbo].[PriorityList_GetInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[PriorityList_GetInfo] (
	@SetID INT,
	@UserID INT OUTPUT,
	@SetName VARCHAR(50) OUTPUT
) AS

BEGIN

	SELECT
		@UserID = UserID,
		@SetName = Name
	FROM
		PriorityListSet
	WHERE
		ID = @SetID

END
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_GetLastComment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[PriorityList_GetLastComment] 
@UserID int,
@taskID int,
@StartTime datetime
AS
BEGIN
select comments from QStatus_Comments where ForeignKeyID=@taskID and UserID=@UserID and CommentDt>@StartTime
 and ID=(select max(ID) from QStatus_Comments where ForeignKeyID=@taskID and UserID=@UserID and CommentDt>@StartTime)
END
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_GetSets]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE            proc [dbo].[PriorityList_GetSets]
	@UserID int
	,@IsPerson int =-1
AS
BEGIN
	
	EXEC PriorityList_Init @UserID
	EXEC PriorityList_InitSupervisor @UserID
	
	DECLARE @GPR bit = 0
	SELECT @GPR = 1 where @UserID in (select GPRUserID from Qcheck_AppSettings where [ID] = 1)

	DECLARE @PreferenceValue varchar(50)

	EXEC QStatus_GetPreference @UserID, 0, 'LastPrioritySet', @PreferenceValue output

	declare @employees table(id int)

	insert into @employees
		select gm2.userid from 
		qstatus_supervisors s
		inner join qstatus_report r
		on r.id = s.reportid
		--and r.isdeleted = 0
		inner join qcheck_groups g
		on g.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		and gm.userid = @UserID
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g2
		on g2.id = gr.groupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id
		--where s.interestedparty = 0 -- change per GPR 1/11/2022
		
		union
		
		select userid from QStatus_UserSupervisors
			where SupervisorUserID = @userid	

	SELECT p.[ID], 
		CASE WHEN p.UserID = @UserID or p.personalset= 1 THEN
			p.[Name]
		ELSE
			p.[Name] + ' (' + isnull(u.fullname, '') + ') '
		END as [Name],
		CASE WHEN CAST(p.ID as varchar(50)) = @PreferenceValue THEN
			1
		ELSE
			0
		END as LastPrioritySet
	FROM PriorityListSet p
	INNER JOIN QCheck_Users u
		on u.id = p.userID  and p.PersonalSet>@IsPerson
	WHERE p.UserID = @UserID
	OR p.UserID in (select id from @employees
					union all
					select id from qcheck_users where isdeleted = 0 and @GPR = 1 --GPR sees all
					)
   
	ORDER BY Case when p.UserID = @UserID and p.personalset= 1 then 1
		      when p.UserID = @UserID then 2
		      when p.personalset = 0 then 3
			else 4
		end asc,
		p.name,
		p.updateddate desc


END
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_GetSupervisorsForEmployee]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PriorityList_GetSupervisorsForEmployee]
	@employeeId int
AS
BEGIN
	select fullname, email from
	qcheck_users
	where id in
	(
		
	
		
		
		select gm2.userid from qstatus_report r
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g
		on g.id = gr.groupid
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		and gm.userID = @employeeId
		inner join qstatus_supervisors s
		on r.id = s.reportid
		and s.interestedparty = 0
		--and r.isdeleted = 0
		inner join qcheck_groups g2
		on g2.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id

	)
	and isdeleted = 0
	order by 1
END

GO
/****** Object:  StoredProcedure [dbo].[PriorityList_Init]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE   proc [dbo].[PriorityList_Init]
	@UserID int
AS
BEGIN
	
	DECLARE @Count int
	DECLARE @Name varchar(100)
	DECLARE @SetID int

	SET @Count = 0

	SELECT @Count = count([id])
	FROM PriorityListSet
	WHERE UserID = @UserID

	IF @Count = 0
	BEGIN
		
		SELECT @Name = Fullname
		FROM QCheck_Users
		WHERE ID = @UserID

		exec PriorityListSet_Add @UserId, @Name, 1, @SetID output

		exec PriorityListSet_AddUser @SetID, @UserId
	END
END




GO
/****** Object:  StoredProcedure [dbo].[PriorityList_InitSupervisor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE     proc [dbo].[PriorityList_InitSupervisor]
	@UserID int
AS
BEGIN
	
	DECLARE @UserID_list TABLE
	(
		ID int IDENTITY(1,1),
		UserID int
	)

	DECLARE @rowcount int, @i int, @SubUserID int

	INSERT INTO @UserID_list
	select gm2.userid from 
	qstatus_supervisors s
	inner join qstatus_report r
	on r.id = s.reportid
	--and r.isdeleted = 0
	inner join qcheck_groups g
	on g.id = s.supervisorgroupid
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	and gm.userid = @UserID
	inner join qstatus_groupreport gr
	on gr.reportid = r.id
	and gr.defaultreport = 1
	inner join qcheck_groups g2
	on g2.id = gr.groupid
	inner join qcheck_groupmembership gm2
	on gm2.groupid = g2.id
	where s.interestedparty = 0
	and gm2.userid not in 
		(select userid from prioritylistset
		where personalset = 1)

	SELECT @rowcount = @@ROWCOUNT
	SELECT @i = 1
	
	WHILE @i <= @rowcount
	BEGIN
		SELECT @SubUserID = UserID
		FROM @UserID_list
		WHERE [ID] = @i
		
		EXEC PriorityList_Init @SubUserID

		SET @i = @i + 1
	END
END






GO
/****** Object:  StoredProcedure [dbo].[PriorityList_MissedReport_Excuse]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PriorityList_MissedReport_Excuse] 
	@fromAddress varchar(100),
	
	@priorrityListLateId int,
	@response varchar(10)
AS
BEGIN


--select * from PriorityList_LateFee_Log where Id=@priorrityListLateId
Declare @fromAddressId int=0
Declare @employeeId int=0
Declare @lateDate datetime;
Declare @empName varchar(100);
select @fromAddressId=Id from QCheck_Users where Email=@fromAddress and IsDeleted=0

select @employeeId=EmpId,@lateDate=LateDate from PriorityList_LateFee_Log where Id=@priorrityListLateId and IsActive=1

select @empName=FullName from QCheck_Users where Id=@employeeId and IsDeleted=0

select @empName,@fromAddressId,@lateDate
/*
if(RTRIM(LTRIM(Lower(@response)))='y')
Begin
 if Exists(select 1 from qstatus_report r
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g
		on g.id = gr.groupid
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		and gm.userID = @employeeId
		inner join qstatus_supervisors s
		on r.id = s.reportid
		and s.interestedparty = 0
		--and r.isdeleted = 0
		inner join qcheck_groups g2
		on g2.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id
		where gm2.UserID=@fromAddressId and IsDeleted=0)

Begin
EXEC   [dbo].[PriorityList_Exclude_Supervisor_Excuse_Insert]
		@employee = @empName,
		@supervisorId = @fromAddressId,
		@excludedDate = @lateDate


End

End
*/

END
GO
/****** Object:  StoredProcedure [dbo].[PriorityList_MoveDown]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  proc [dbo].[PriorityList_MoveDown]
	@ID int
AS
BEGIN
	
	--check current priority
	DECLARE @Priority int, @MaxPriority int, @UserID int
	
	SELECT @Priority = Priority, @UserID = UserID
	FROM PriorityList
	WHERE [ID] = @ID

	SELECT @MaxPriority = Max(Priority)
	FROM PriorityList WHERE UserID = @UserID
	
	IF @Priority < isnull(@MaxPriority, 0)
	BEGIN
		SET @Priority = @Priority + 1
		EXEC PriorityList_MoveTask @ID, @Priority
	END

END



GO
/****** Object:  StoredProcedure [dbo].[PriorityList_MoveTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE    proc [dbo].[PriorityList_MoveTask]
	@ID int,
	@Priority int
AS
BEGIN
	
	--check current priority
	DECLARE @CurrentPriority int
	DECLARE @UserID int
	SET @UserID = 0

	SELECT 	@CurrentPriority = Priority, @UserID= UserID
	FROM PriorityList
	WHERE ID = @ID
	
	IF @Priority > @CurrentPriority and @CurrentPriority > 0 and @Priority > 0
		UPDATE PriorityList
		SET Priority = Priority - 1
		WHERE UserID = @UserID
		AND Priority > @CurrentPriority
		AND Priority <= @Priority

	IF @Priority < @CurrentPriority and @CurrentPriority > 0 and @Priority > 0
		UPDATE PriorityList
		SET Priority = Priority + 1
		WHERE UserID = @UserID
		AND Priority >= @Priority
		AND Priority < @CurrentPriority


	UPDATE PriorityList
	SET Priority = @Priority
	WHERE ID = @ID

	SELECT @UserID
	

END





GO
/****** Object:  StoredProcedure [dbo].[PriorityList_MoveUp]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE   proc [dbo].[PriorityList_MoveUp]
	@ID int
AS
BEGIN
	
	--check current priority
	DECLARE @Priority int
	
	SELECT @Priority = Priority
	FROM PriorityList
	WHERE [ID] = @ID
	
	IF @Priority > 1
	BEGIN
		SET @Priority = @Priority - 1
		EXEC PriorityList_MoveTask @ID, @Priority
	END

END




GO
/****** Object:  StoredProcedure [dbo].[PriorityList_Refresh]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE    proc [dbo].[PriorityList_Refresh]
	@UserID int
AS
BEGIN

	--update recurring itmes
	update PriorityList
	set activechecklistid = newlist.newacid
	from PriorityList p
	inner join (
	select a.id, min(ac2.id) as newacid 
	from PriorityList a
	inner join qcheck_activechecklists ac
	on a.activechecklistid = ac.id
	inner join qcheck_checklistinstances ci
	on ci.id = ac.instanceid
	inner join qcheck_activechecklists ac2
	on ac2.instanceid = ci.id
	and ac2.completeddate is null
	where a.priority > 0
	and ac.completeddate is not null
	and ac2.duetime < getdate() + 8
	and a.UserID = @UserID
	group by a.id) newlist 
	on newlist.id = p.id
	and p.UserID = @UserID

	--move off the completed tasks
	UPDATE PriorityList
	SET Priority = -1
	FROM PriorityList p
	INNER JOIN QCheck_ActiveChecklists ac
	ON p.activechecklistid = ac.id
	AND completeddate is not null
	AND p.UserID = @UserID

	--return any reopened tasks
	UPDATE PriorityList
	SET Priority = 99
	FROM PriorityList p
	INNER JOIN QCheck_ActiveChecklists ac
	ON p.activechecklistid = ac.id
	AND completeddate is  null
	AND p.Priority = -1
	AND p.UserID = @UserID

	--remove deleted tasks
	DELETE FROM PriorityList
	WHERE UserID = @UserID
	AND ActiveChecklistID not in (
		SELECT ac.ID 
		FROM QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
		AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
		AND c.IsDeleted = 0		
	)

	--remove dupes
	DELETE PriorityList
	FROM PriorityList p
	INNER JOIN (select * from PriorityList where UserID = @UserID) p2
	ON p.activechecklistid = p2.activechecklistid
	AND p.UserID = p2.UserID
	AND p.ID > p2.ID

	--reprioritize
	DECLARE @Prioritytemp Table
	(
		ActiveChecklistID int,
		P int identity(1,1)
	)
	
	INSERT INTO @Prioritytemp (ActiveChecklistID)
	SELECT ActiveChecklistID From PriorityList
	WHERE UserID = @UserID
	AND Priority >= 0
	ORDER BY Priority asc

	UPDATE PriorityList
	SET Priority = P
	FROM PriorityList p
	INNER JOIN @Prioritytemp t
	ON p.ActiveChecklistID = t.Activechecklistid
	AND p.UserID = @UserID
	
END





GO
/****** Object:  StoredProcedure [dbo].[PriorityList_RemoveTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE    proc [dbo].[PriorityList_RemoveTask]
	@ID int
AS
BEGIN
	
	--check priority
	DECLARE @Priority int
	DECLARE @UserID int
	SET @UserID = 0

	SELECT 	@Priority = Priority, @UserID = UserID
	FROM PriorityList
	WHERE [ID] = @ID

	--remove from list
	DELETE FROM PriorityList
	WHERE [ID] = @ID

	-- move up lower priorities
	IF (IsNull(@Priority, 0)) > 0 and (IsNull(@UserID, 0)) > 0 
		UPDATE PriorityList
		SET Priority = Priority -1
		WHERE UserID = @UserID
		AND Priority > @Priority

	SELECT @UserID as "userID"

END





GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_Add]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  proc [dbo].[PriorityListSet_Add]
	@UserID int,
	@Name varchar(100),
	@PersonalSet bit = 0,
	@SetID int output
AS
BEGIN
	
	INSERT INTO PriorityListSet (Name, UserID, PersonalSet)
	SELECT @Name, @UserID, @PersonalSet

	SELECT @SetID = @@Identity


END



GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_AddUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE        proc [dbo].[PriorityListSet_AddUser]
	@SetID int,
	@UserID int,
	@Refresh bit = 1
AS
BEGIN
	
	UPDATE PriorityListUsers
	SET DisplayOrder = DisplayOrder + 1
	WHERe SetID = @SetID

	INSERT INTO PriorityListUsers 
	SELECT @SetID, @UserID, 1
	WHERE NOT EXISTS (Select 1 from PriorityListUsers where setid = @setid and userid = @userid)

	IF @Refresh = 1
		exec PriorityListSet_RefreshOrder @SetID

END









GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_AddUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE         proc [dbo].[PriorityListSet_AddUsers]
	@SetID int,
	@UserIDs varchar(1000)
AS
BEGIN
	DECLARE @UserID_list TABLE
	(
		ID int IDENTITY(1,1),
		UserID int
	)
	DECLARE @rowcount int, @i int, @UserID int


	INSERT INTO @UserID_list
	SELECT n FROM dbo.Util_fn_List_To_Table(@UserIDs,';')
	where n is not null

	SELECT @rowcount = @@ROWCOUNT
	SELECT @i = 1
	
	WHILE @i <= @rowcount
	BEGIN
		SELECT @UserID = UserID
		FROM @UserID_list
		WHERE ID = @i
		
		EXEC PriorityListSet_AddUser @SetID, @UserID, 0

		SET @i = @i + 1
	END

	exec PriorityListSet_RefreshOrder @SetID


END










GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_Delete]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    proc [dbo].[PriorityListSet_Delete]
	@SetID int output
AS
BEGIN
	
	--The list being deleted is usually set as the default for the deleting user, which causes errors;
	--change it to the user's personal priority list before deleting
	UPDATE pref
	SET PreferenceValue = pers.ID
	FROM QStatus_Preferences pref
		JOIN PriorityListSet toDel ON CAST(toDel.ID as varchar(20)) = pref.PreferenceValue
		JOIN PriorityListSet pers ON pers.UserID = toDel.UserID AND pers.PersonalSet = 1
	WHERE pref.PreferenceType = 'LastPrioritySet'
		AND pref.PreferenceValue = @SetID

	DELETE FROM PriorityListSet
	WHERE ID = @SetID
	AND PersonalSet = 0

	IF @@Rowcount = 1
		DELETE FROM PriorityListUsers
		WHERE SetID = @SetID	

END





GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_GetAvailableUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE      proc [dbo].[PriorityListSet_GetAvailableUsers]
	@SetID int,
	@UserID int
AS
BEGIN
	
	SELECT u.id, u.fullname
	FROM QCheck_Users u
	WHERE (
		(u.id in
			(
				select gm2.userid from 
				qstatus_supervisors s
				inner join qstatus_report r
				on r.id = s.reportid
				--and r.isdeleted = 0
				inner join qcheck_groups g
				on g.id = s.supervisorgroupid
				inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userid = @userid
				inner join qstatus_groupreport gr
				on gr.reportid = r.id
				and gr.defaultreport = 1
				inner join qcheck_groups g2
				on g2.id = gr.groupid
				inner join qcheck_groupmembership gm2
				on gm2.groupid = g2.id
				where s.interestedparty = 0
		
				union
				
				select userid from QStatus_UserSupervisors
					where SupervisorUserID = @userid
						
				
			)
			and @setid not in
				(select id from PriorityListSet
				where PersonalSet = 1)
			and u.IsDeleted = 0
		)
		OR 
		(
			u.ID = @UserID
			AND
			(
				u.ID in (SELECT UserID from PriorityListSet
					where id = @setid)
				OR 
				@setid not in
				(select id from PriorityListSet
				where PersonalSet = 1)
			)
			and u.IsDeleted = 0
		)
		OR 
		(
			u.ID in
			(
				select u2.id from qcheck_users u1
				inner join qcheck_users u2
					on u1.email = u2.email
				where u1.id = @UserID
			)
			and u.IsDeleted = 0
		)
		OR
		(
			@UserID in (select GPRUserID from Qcheck_AppSettings where [ID] = 1)
			and u.IsDeleted = 0
		)
		OR
		(
			u.ID in (select userid from PriorityListCrossReference where CrossReferenceID = @UserID)
			--allowing deleted users here
		)
	)
	AND u.id not in
		(
			select userid from PriorityListUsers
			where setid = @setid
		)
	
	order by 2


END







GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_GetEmails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE   proc [dbo].[PriorityListSet_GetEmails]
	@SetID int,
	@UserID int
AS

	select fullname, email, case when id = @UserID then 1 else 0 end as LoggedInUser from
	qcheck_users
	where id in
	(
		
		select UserID from PriorityListSet
		where ID = @SetID
		
		UNION ALL
		
		SELECT @UserID
		
		UNION ALL
		
		SELECT UserID FROM PriorityListUsers
		WHERE SetID = @SETID
		
		UNION ALL
		
		select gm2.userid from qstatus_report r
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g
		on g.id = gr.groupid
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		and gm.userID = @UserID
		inner join qstatus_supervisors s
		on r.id = s.reportid
		and s.interestedparty = 0
		--and r.isdeleted = 0
		inner join qcheck_groups g2
		on g2.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id

		UNION ALL  -- add in supervisors of the cross reference
		
		select gm2.userid from qstatus_report r
		inner join qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		inner join qcheck_groups g
		on g.id = gr.groupid
		inner join prioritylistcrossreference cr
		on cr.crossreferenceid = @UserID
		inner join prioritylistset pls
		on pls.userid = cr.userid
		and pls.id = @setID
		inner join qcheck_groupmembership gm
		on gm.groupid = g.id
		and gm.userID = cr.userid
		inner join qstatus_supervisors s
		on r.id = s.reportid
		and s.interestedparty = 0
		--and r.isdeleted = 0
		inner join qcheck_groups g2
		on g2.id = s.supervisorgroupid
		inner join qcheck_groupmembership gm2
		on gm2.groupid = g2.id

	)
	and id not in (select userid from prioritylistcrossreference)
	and isdeleted = 0
	order by 1



GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_GetInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE           proc [dbo].[PriorityListSet_GetInfo]
	@SetID int,
	@UserID int,
	@persistPrioritySet bit=1
AS
BEGIN
	
	IF (@SetID > 0 and @persistPrioritySet=1) BEGIN
		exec QStatus_AddPreference @UserID, 0, 'LastPrioritySet', @SetID
	END

	SELECT top 1 convert(varchar, p.UpdatedDate, 100) as dt,
		u.fullname,
		p.UserID,
		p.name,
		u.email
	 from PriorityListSet p
	inner join qcheck_users u
	on u.id = p.userid
	WHERE (p.[ID] = @SetID or (@setID = 0 and p.userid = @UserID))

	DECLARE @isSingleUserList bit, @isSupervisor bit, @isMyList bit

	SELECT @isSingleUserList = 0, @isSupervisor = 0, @isMyList = 0

	SELECT @isSingleUserList = 1 
	FROM 
		PriorityListSet 
	WHERE PersonalSet = 1 AND ID = @SetID

	select @isSupervisor = 1 from 
	qstatus_supervisors s
	inner join qstatus_report r
	on r.id = s.reportid
	--and r.isdeleted = 0
	inner join qcheck_groups g
	on g.id = s.supervisorgroupid
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	and gm.userid = @userid
	inner join qstatus_groupreport gr
	on gr.reportid = r.id
	and gr.defaultreport = 1
	inner join qcheck_groups g2
	on g2.id = gr.groupid
	inner join qcheck_groupmembership gm2
	on gm2.groupid = g2.id
	where s.interestedparty = 0
	
	select @isSupervisor = 1
	from QStatus_SupervisorOverride
	where UserID <> SupervisorID
		and SupervisorID = @userid

	SELECT @isMyList = 1
	FROM PriorityListSet
	WHERE UserID = @UserID AND ID = @SetID
	
	/*select @isMyList = 1
    from PriorityListSet s
	inner join qcheck_users u
		on s.userid = u.id
	inner join qcheck_users u2
		on u.email = u2.email
	WHERE u2.id = @UserID AND s.ID = @SetID*/

	declare @dependencies varchar(1000)
	set @dependencies = ''
	
	select @dependencies = @dependencies + '*' + cast(a.setid as varchar(10)) + '*'
	from 
	(select distinct u2.setid 
	from PriorityListUsers u1
	inner join PriorityListUsers u2
	on u2.userid = u1.userid
	inner join PriorityListSet s
	on u2.setid = s.id
	where u1.setid = @SetID

	union

	select @SetID

	) a


	SELECT @isSingleUserList, @isSupervisor, @isMyList, @dependencies
	

END












GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_GetPersonalByUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[PriorityListSet_GetPersonalByUser] (
	@UserID INT
) AS

BEGIN

	SELECT 
		ID,
		Name,
		UserID,
		PersonalSet,
		UpdatedDate
	FROM
		PriorityListSet
	WHERE
		UserID = @UserID
		AND PersonalSet = 1
		
END
GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_GetUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE     proc [dbo].[PriorityListSet_GetUsers]
	@SetID int
AS
BEGIN
	
	SELECT p.userid, u.fullname, p.displayorder, u.email
	FROM PriorityListUsers p
	INNER JOIN QCheck_Users u
	ON p.UserID = u.ID
	WHERE p.SetID = @SetID
	ORDER BY DisplayOrder


END






GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_MoveUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE          proc [dbo].[PriorityListSet_MoveUser]
	@SetID int,
	@UserID int,
	@DisplayOrder int
AS
BEGIN
	
	--check current DisplayOrder
	DECLARE @CurrentDisplayOrder int

	SELECT 	@CurrentDisplayOrder = DisplayOrder
	FROM PriorityListUsers
	WHERE UserID = @UserID
	AND SetID = @SetID

	
	IF @DisplayOrder > @CurrentDisplayOrder and @CurrentDisplayOrder > 0 and @DisplayOrder > 0
		UPDATE PriorityListUsers
		SET DisplayOrder = DisplayOrder - 1
		WHERE SetID = @SetID
		AND DisplayOrder > @CurrentDisplayOrder
		AND DisplayOrder <= @DisplayOrder

	IF @DisplayOrder < @CurrentDisplayOrder and @CurrentDisplayOrder > 0 and @DisplayOrder > 0
		UPDATE PriorityListUsers
		SET DisplayOrder = DisplayOrder + 1
		WHERE SetID = @SetID
		AND DisplayOrder >= @DisplayOrder
		AND DisplayOrder < @CurrentDisplayOrder

	UPDATE PriorityListUsers
	SET DisplayOrder = @DisplayOrder
	WHERE UserID = @UserID
	AND SetID = @SetID


	exec PriorityListSet_RefreshOrder @SetID

END











GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_Redirect]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  proc [dbo].[PriorityListSet_Redirect]
	@UserID int,
	@ReportUserID int,
	@TaskID int = null
AS
BEGIN

	DECLARE @Controller bit
	DECLARE @ReportID int

	-- report only mode
	IF @TaskID is null
	BEGIN
		--find the default report
		SELECT @ReportID = r.ID
		FROM qstatus_report r
		INNER JOIN qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		and r.isdeleted = 0 --4/28/2014 dalvarado
		INNER JOIN qcheck_groupmembership gm
		on gm.groupid = gr.groupid
		and gm.UserID = @ReportUserID
	END
	ELSE
	BEGIN

		--first try the default report
		SELECT @ReportID = r.ID
		FROM qstatus_report r
		INNER JOIN qstatus_groupreport gr
		on gr.reportid = r.id
		and gr.defaultreport = 1
		and r.isdeleted = 0 --4/28/2014 dalvarado
		LEFT OUTER JOIN qcheck_groupmembership gm
		on gm.groupid = gr.groupid
		and gm.UserID = @UserID
		INNER JOIN QStatus_TaskTypes tt
		ON tt.reportid = r.ID
		INNER JOIN QStatus_ActiveChecklistTaskType actt
		on actt.tasktype = tt.ID
		and actt.activechecklistid = @TaskID
		order by isnull(gm.UserID, 0) asc

		--if not found, try the others
		IF @ReportID is null
			SELECT @ReportID = r.ID
			FROM qstatus_report r
			LEFT OUTER JOIN qstatus_groupreport gr
			on gr.reportid = r.id
			and r.isdeleted = 0 --4/28/2014 dalvarado
			LEFT OUTER JOIN qcheck_groupmembership gm
			on gm.groupid = gr.groupid
			and gm.UserID = @ReportUserID
			INNER JOIN QStatus_TaskTypes tt
			ON tt.reportid = r.ID
			INNER JOIN QStatus_ActiveChecklistTaskType actt
			on actt.tasktype = tt.ID
			and actt.activechecklistid = @TaskID
			order by isnull(gm.UserID, 0) asc
	END
	
	--check if you are a controller on the report
	SET @Controller = 0
		
	SELECT @Controller = 1
	FROM qstatus_report r
	INNER JOIN qstatus_groupreport gr
	on gr.reportid = r.id
	and gr.reportID = @ReportID
	INNER JOIN qcheck_groupmembership gm
	on gm.groupid = gr.groupid
	AND gm.UserID = @UserID

	SELECT isnull(@ReportID, 0) as ReportID, isnull(@Controller, 0) as Controller


END
GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_RefreshOrder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE      proc [dbo].[PriorityListSet_RefreshOrder]
	@SetID int
AS
BEGIN
	
	DECLARE @Ordertemp Table
	(
		UserID int,
		DispOrder int identity(1,1)
	)

	INSERT INTO @Ordertemp (UserID)
	SELECT UserID
	FROM PriorityListUsers
	WHERE SetID = @SetID
	order by displayorder

	UPDATE PriorityListUsers
	SET DisplayOrder = DispOrder
	FROM PriorityListUsers u
	INNER JOIN @Ordertemp t
	ON  u.UserID = t.UserID
	AND u.setID = @SetID

END







GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_RemoveUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE    proc [dbo].[PriorityListSet_RemoveUser]
	@SetID int,
	@UserID int
AS
BEGIN
	
	
	--remove from list
	DELETE FROM PriorityListUsers
	WHERE SetID = @SetID AND UserID = @UserID
	
	exec PriorityListSet_RefreshOrder @SetID


END





GO
/****** Object:  StoredProcedure [dbo].[PriorityListSet_Update]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




create   proc [dbo].[PriorityListSet_Update]
	@SetID int
AS
BEGIN
	
	UPDATE PriorityListSet 
	SET UpdatedDate = getdate()

END




GO
/****** Object:  StoredProcedure [dbo].[Q_GetAllSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Q_GetAllSupervisors] AS

BEGIN

	SELECT 
		[ID],
		[Name]
	FROM
		Q_Supervisors
	ORDER BY
		[Name]

END
GO
/****** Object:  StoredProcedure [dbo].[Q_IsSupervisor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Q_IsSupervisor] (
	@UserID INT,
	@IsSupervisor BIT OUTPUT
) AS

BEGIN

	SET @IsSupervisor = 0
	
	SELECT @IsSupervisor = 1
	FROM QStatus_UserSupervisors s
	WHERE SupervisorUserID = @UserID
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Assn_2Wk_Detail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Assn_2Wk_Detail] AS

DECLARE @startdate DATETIME = DATEADD(DAY, -14, GETDATE()),
		@enddate DATETIME = GETDATE(),
		@overduedays int = 3

SELECT DISTINCT
	u.FullName AS Person, 
	c.Name AS Checklist,
	dbo.QCheck_AssigneesList(cia.ID) AS Assignees,
	at.Due
FROM 
	QPI_Users u
	INNER JOIN QCheck_GroupMembership gm
		ON gm.UserID = u.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Assignments_All aa
		ON aa.GroupID = g.ID
	INNER JOIN QCheck_ActiveAssignments_All aaa
		ON aaa.AssignmentsID = aa.ID
	INNER JOIN (
		SELECT DISTINCT activechecklistid, DueDateOld AS Due
		FROM QStatus_DueDateChanges
		WHERE DueDateOld BETWEEN @startdate AND @enddate
	
		UNION
		
		SELECT DISTINCT id AS ActiveChecklistID, DueTime AS Due
		FROM QCheck_ActiveChecklists_All
		WHERE DueTime BETWEEN @startdate AND @enddate
	) at
		ON at.activechecklistid = aaa.ActiveChecklistID
	INNER JOIN QCheck_ActiveChecklists_All aca
		ON aca.ID = at.activechecklistid
	INNER JOIN QCheck_ChecklistInstances_All cia
		ON aca.InstanceID = cia.ID
	INNER JOIN QCheck_Checklists c
		ON cia.ChecklistID = c.ID
	LEFT OUTER JOIN QStatus_DueDateChanges ddc
		ON ddc.ActiveChecklistID = aca.ID
		AND ddc.UpdateDt > @startdate
WHERE
	--currently open tasks that were due prior to 3 days before end of period
	(
		aca.CompletedDate IS NULL
		AND aca.DueTime < (@enddate - @overduedays)
		AND aa.DtAssigned < (@enddate - @overduedays)
		AND aca.archivedt IS NULL
	) 
	OR
	--completed more than 3 days after deadline
	(
		aca.DueTime < (aca.CompletedDate - @overduedays)
		AND aa.DtAssigned < (aca.CompletedDate - @overduedays)
	)
	OR
	--deadline changed when 3 days overdue
	(
		ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
		AND aa.DtAssigned < (ddc.UpdateDt - @overduedays)
	)
ORDER BY
	u.FullName,
	at.Due
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Assn_2Wk_Summary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Assn_2Wk_Summary] AS

DECLARE @startdate DATETIME = DATEADD(DAY, -14, GETDATE()),
		@enddate DATETIME = GETDATE(),
		@overduedays int = 3

SELECT 
	u.FullName AS Person, 
	COUNT(distinct at.activechecklistid) AS Overdue3Days
FROM 
	QPI_Users u
	INNER JOIN QCheck_GroupMembership gm
		ON gm.UserID = u.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Assignments_All aa
		ON aa.GroupID = g.ID
	INNER JOIN QCheck_ActiveAssignments_All aaa
		ON aaa.AssignmentsID = aa.ID
	INNER JOIN (
		SELECT DISTINCT activechecklistid 
		FROM QStatus_DueDateChanges
		WHERE DueDateOld BETWEEN @startdate AND @enddate
	
		UNION
		
		SELECT DISTINCT id
		FROM QCheck_ActiveChecklists_All
		WHERE DueTime BETWEEN @startdate AND @enddate
	) at
		ON at.activechecklistid = aaa.ActiveChecklistID
	INNER JOIN QCheck_ActiveChecklists_All aca
		ON aca.ID = at.activechecklistid
	LEFT OUTER JOIN QStatus_DueDateChanges ddc
		ON ddc.ActiveChecklistID = aca.ID
		AND ddc.UpdateDt > @startdate
WHERE
	--currently open tasks that were due prior to 3 days before end of period
	(
		aca.CompletedDate IS NULL
		AND aca.DueTime < (@enddate - @overduedays)
		AND aa.DtAssigned < (@enddate - @overduedays)
		AND aca.archivedt IS NULL
	) 
	OR
	--completed more than 3 days after deadline
	(
		aca.DueTime < (aca.CompletedDate - @overduedays)
		AND aa.DtAssigned < (aca.CompletedDate - @overduedays)
	)
	OR
	--deadline changed when 3 days overdue
	(
		ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
		AND aa.DtAssigned < (ddc.UpdateDt - @overduedays)
	)
GROUP BY  
	u.FullName
ORDER BY
	2 DESC
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Assn_Now_Detail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Assn_Now_Detail] AS

SELECT 
	u.FullName AS Person,
	c.Name AS Checklist,
	dbo.QCheck_AssigneesList(ci.ID) AS Assignees,
	CONVERT(VARCHAR(10), ac.DueTime, 101) + ' ' + LTRIM(RIGHT(CONVERT(VARCHAR(20), ac.DueTime), 7)) AS Due
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
		AND ci.IsDeleted = 0
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
		AND c.IsDeleted = 0
	INNER JOIN QCheck_Assignments a
		ON ci.ID = a.InstanceID
		AND a.IsDeleted = 0
		AND a.DtAssigned < DATEADD(DAY, -3, GETDATE())
	INNER JOIN QCheck_Groups g
		ON a.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Users u
		ON gm.UserID = u.ID
WHERE
	ac.DueTime < DATEADD(DAY, -3, GETDATE())
	AND ac.CompletedDate IS NULL
ORDER BY
	u.FullName,
	ac.DueTime
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Assn_Now_Summary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Assn_Now_Summary] AS

SELECT 
	u.FullName AS Person,
	COUNT(ac.ID) AS Overdue3Days
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
		AND ci.IsDeleted = 0
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
		AND c.IsDeleted = 0
	INNER JOIN QCheck_Assignments a
		ON ci.ID = a.InstanceID
		AND a.IsDeleted = 0
		AND a.DtAssigned < DATEADD(DAY, -3, GETDATE())
	INNER JOIN QCheck_Groups g
		ON a.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Users u
		ON gm.UserID = u.ID
WHERE
	ac.DueTime < DATEADD(DAY, -3, GETDATE())
	AND ac.CompletedDate IS NULL
GROUP BY
	u.FullName
ORDER BY
	2 DESC
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Ctrl_2Wk_Detail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Ctrl_2Wk_Detail] AS

DECLARE @startdate DATETIME = DATEADD(DAY, -14, GETDATE()),
		@enddate DATETIME = GETDATE(),
		@overduedays int = 3

SELECT DISTINCT
	cu.FullName AS Person, 
	c.Name AS Checklist,
	dbo.QCheck_AssigneesList(cia.ID) AS Assignees,
	at.Due
FROM 
	QPI_Users u
	INNER JOIN QCheck_GroupMembership gm
		ON gm.UserID = u.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Assignments_All aa
		ON aa.GroupID = g.ID
	INNER JOIN QCheck_ActiveAssignments_All aaa
		ON aaa.AssignmentsID = aa.ID
	INNER JOIN (
		SELECT ActiveChecklistID, MIN(Due) AS Due
		FROM (
			SELECT DISTINCT activechecklistid, MAX(DueDateOld) AS Due
			FROM QStatus_DueDateChanges
			WHERE DueDateOld BETWEEN @startdate AND @enddate
			GROUP BY activechecklistid
		
			UNION
			
			SELECT DISTINCT id AS ActiveChecklistID, MAX(DueTime) AS Due
			FROM QCheck_ActiveChecklists_All
			WHERE DueTime BETWEEN @startdate AND @enddate
			GROUP BY ID
		) z
		GROUP BY ActiveChecklistID
	) at
		ON at.activechecklistid = aaa.ActiveChecklistID
	INNER JOIN QCheck_ActiveChecklists_All aca
		ON aca.ID = at.activechecklistid
	INNER JOIN QCheck_ChecklistInstances_All cia
		ON aca.InstanceID = cia.ID
	INNER JOIN QCheck_Checklists c
		ON cia.ChecklistID = c.ID
	INNER JOIN QCheck_ChecklistManagers cm
		ON c.ID = cm.ChecklistID
		AND cm.IsDeleted = 0
	INNER JOIN QCheck_Groups cg
		ON cm.ManagerGroupID = cg.ID
	INNER JOIN QCheck_GroupMembership cgm
		ON cg.ID = cgm.GroupID
	INNER JOIN QCheck_Users cu
		ON cgm.UserID = cu.ID
	LEFT OUTER JOIN QCheck_GroupMembership agm
		ON aa.GroupID = agm.GroupID
	LEFT OUTER JOIN QStatus_DueDateChanges ddc
		ON ddc.ActiveChecklistID = aca.ID
		AND ddc.UpdateDt > @startdate
WHERE
	agm.UserID <> cu.ID
	AND (
		--currently open tasks that were due prior to 3 days before end of period
		(
			aca.CompletedDate IS NULL
			AND aca.DueTime < (@enddate - @overduedays)
			AND aa.DtAssigned < (@enddate - @overduedays)
			AND aca.archivedt IS NULL
		) 
		OR
		--completed more than 3 days after deadline
		(
			aca.DueTime < (aca.CompletedDate - @overduedays)
			AND aa.DtAssigned < (aca.CompletedDate - @overduedays)
		)
		OR
		--deadline changed when 3 days overdue
		(
			ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
			AND aa.DtAssigned < (ddc.UpdateDt - @overduedays)
		)
	)
ORDER BY
	cu.FullName,
	at.Due
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Ctrl_2Wk_Summary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Ctrl_2Wk_Summary] AS

DECLARE @startdate DATETIME = DATEADD(DAY, -14, GETDATE()),
		@enddate DATETIME = GETDATE(),
		@overduedays int = 3
		
DECLARE @ControlledTasks TABLE (
	UserID INT,
	Tasks INT
)

INSERT INTO @ControlledTasks (
	UserID,
	Tasks
)
	SELECT 
		cu.ID,
		COUNT(distinct at.activechecklistid)
	FROM 
		QPI_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON gm.UserID = u.ID
		INNER JOIN QCheck_Groups g
			ON g.ID = gm.GroupID
		INNER JOIN QCheck_Assignments_All aa
			ON aa.GroupID = g.ID
		INNER JOIN QCheck_ActiveAssignments_All aaa
			ON aaa.AssignmentsID = aa.ID
		INNER JOIN (
			SELECT DISTINCT activechecklistid 
			FROM QStatus_DueDateChanges
			WHERE DueDateOld BETWEEN @startdate AND @enddate
		
			UNION
			
			SELECT DISTINCT id
			FROM QCheck_ActiveChecklists_All
			WHERE DueTime BETWEEN @startdate AND @enddate
		) at
			ON at.activechecklistid = aaa.ActiveChecklistID
		INNER JOIN QCheck_ActiveChecklists_All aca
			ON aca.ID = at.activechecklistid
		INNER JOIN QCheck_ChecklistInstances_All cia
			ON aca.InstanceID = cia.ID
		INNER JOIN QCheck_Checklists c
			ON cia.ChecklistID = c.ID
		INNER JOIN QCheck_ChecklistManagers cm
			ON c.ID = cm.ChecklistID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups cg
			ON cm.ManagerGroupID = cg.ID
		INNER JOIN QCheck_GroupMembership cgm
			ON cg.ID = cgm.GroupID
		INNER JOIN QCheck_Users cu
			ON cgm.UserID = cu.ID
		LEFT OUTER JOIN QStatus_DueDateChanges ddc
			ON ddc.ActiveChecklistID = aca.ID
			AND ddc.UpdateDt > @startdate
		LEFT OUTER JOIN QCheck_Assignments_All a
			ON cia.ID = a.InstanceID
		LEFT OUTER JOIN QCheck_GroupMembership agm
			ON a.GroupID = agm.GroupID
	WHERE
		cu.ID <> agm.UserID
	GROUP BY  
		cu.ID
	
-- Get the output
SELECT 
	cu.FullName AS Person, 
	COUNT(distinct at.activechecklistid) AS Overdue3Days,
	ct.Tasks AS TotalControlledTasks,
	CONVERT(DECIMAL(10, 4), COUNT(distinct at.activechecklistid)) / CONVERT(DECIMAL(10,4), ct.Tasks) * 100 AS Pct
FROM 
	QPI_Users u
	INNER JOIN QCheck_GroupMembership gm
		ON gm.UserID = u.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Assignments_All aa
		ON aa.GroupID = g.ID
	INNER JOIN QCheck_ActiveAssignments_All aaa
		ON aaa.AssignmentsID = aa.ID
	INNER JOIN (
		SELECT DISTINCT activechecklistid 
		FROM QStatus_DueDateChanges
		WHERE DueDateOld BETWEEN @startdate AND @enddate
	
		UNION
		
		SELECT DISTINCT id
		FROM QCheck_ActiveChecklists_All
		WHERE DueTime BETWEEN @startdate AND @enddate
	) at
		ON at.activechecklistid = aaa.ActiveChecklistID
	INNER JOIN QCheck_ActiveChecklists_All aca
		ON aca.ID = at.activechecklistid
	INNER JOIN QCheck_ChecklistInstances_All cia
		ON aca.InstanceID = cia.ID
	INNER JOIN QCheck_Checklists c
		ON cia.ChecklistID = c.ID
	INNER JOIN QCheck_ChecklistManagers cm
		ON c.ID = cm.ChecklistID
		AND cm.IsDeleted = 0
	INNER JOIN QCheck_Groups cg
		ON cm.ManagerGroupID = cg.ID
	INNER JOIN QCheck_GroupMembership cgm
		ON cg.ID = cgm.GroupID
	INNER JOIN QCheck_Users cu
		ON cgm.UserID = cu.ID
	LEFT OUTER JOIN QStatus_DueDateChanges ddc
		ON ddc.ActiveChecklistID = aca.ID
		AND ddc.UpdateDt > @startdate
	LEFT OUTER JOIN QCheck_Assignments_All a
		ON cia.ID = a.InstanceID
	LEFT OUTER JOIN QCheck_GroupMembership agm
		ON a.GroupID = agm.GroupID
	INNER JOIN @ControlledTasks ct
		ON cu.ID = ct.UserID
WHERE
	cu.ID <> agm.UserID
	AND (
		--currently open tasks that were due prior to 3 days before end of period
		(
			aca.CompletedDate IS NULL
			AND aca.DueTime < (@enddate - @overduedays)
			AND aa.DtAssigned < (@enddate - @overduedays)
			AND aca.archivedt IS NULL
		) 
		OR
		--completed more than 3 days after deadline
		(
			aca.DueTime < (aca.CompletedDate - @overduedays)
			AND aa.DtAssigned < (aca.CompletedDate - @overduedays)
		)
		OR
		--deadline changed when 3 days overdue
		(
			ddc.DueDateOld < (ddc.UpdateDt - @overduedays)
			AND aa.DtAssigned < (ddc.UpdateDt - @overduedays)
		)
	)
GROUP BY  
	cu.FullName,
	ct.Tasks
ORDER BY
	2 DESC
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Ctrl_Now_Detail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Ctrl_Now_Detail] AS

SELECT 
	cu.FullName AS Person,
	c.Name AS Checklist,
	dbo.QCheck_AssigneesList(ci.ID) AS Assignees,
	CONVERT(VARCHAR(10), ac.DueTime, 101) + ' ' + LTRIM(RIGHT(CONVERT(VARCHAR(20), ac.DueTime), 7)) AS Due
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
		AND ci.IsDeleted = 0
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
		AND c.IsDeleted = 0
	INNER JOIN QCheck_ChecklistManagers cm
		ON c.ID = cm.ChecklistID
		AND cm.IsDeleted = 0
	INNER JOIN QCheck_Groups cg
		ON cm.ManagerGroupID = cg.ID
	INNER JOIN QCheck_GroupMembership cgm
		ON cg.ID = cgm.GroupID
	INNER JOIN QCheck_Users cu
		ON cgm.UserID = cu.ID
	LEFT OUTER JOIN QCheck_Assignments a
		ON ci.ID = a.InstanceID
	LEFT OUTER JOIN QCheck_GroupMembership agm
		ON a.GroupID = agm.GroupID
WHERE
	ac.DueTime < DATEADD(DAY, -3, GETDATE())
	AND ac.CompletedDate IS NULL
	AND cu.ID <> agm.UserID
ORDER BY
	1,
	ac.DueTime
GO
/****** Object:  StoredProcedure [dbo].[QCheck_3DayODRpt_Ctrl_Now_Summary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_3DayODRpt_Ctrl_Now_Summary] AS

SELECT 
	cu.FullName AS Person,
	COUNT(ac.ID) AS Overdue3Days
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
		AND ci.IsDeleted = 0
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
		AND c.IsDeleted = 0
	INNER JOIN QCheck_ChecklistManagers cm
		ON c.ID = cm.ChecklistID
		AND cm.IsDeleted = 0
	INNER JOIN QCheck_Groups cg
		ON cm.ManagerGroupID = cg.ID
	INNER JOIN QCheck_GroupMembership cgm
		ON cg.ID = cgm.GroupID
	INNER JOIN QCheck_Users cu
		ON cgm.UserID = cu.ID
	LEFT OUTER JOIN QCheck_Assignments a
		ON ci.ID = a.InstanceID
	LEFT OUTER JOIN QCheck_GroupMembership agm
		ON a.GroupID = agm.GroupID
WHERE
	ac.DueTime < DATEADD(DAY, -3, GETDATE())
	AND ac.CompletedDate IS NULL
	AND cu.ID <> agm.UserID
GROUP BY
	cu.FullName
ORDER BY
	2 DESC
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateFuture]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActivateFuture](
	@InstanceID INT,
	@UpcomingID INT,
	@NewID INT output
) AS

BEGIN

	BEGIN TRAN -- We don't want pieces of this to screw up, it needs to be all or nothing.

	SET NOCOUNT ON
	
	DECLARE @startDate datetime
	DECLARE @dueDate datetime 
	DECLARE @nextStart datetime 
	DECLARE @relativeStart datetime
	DECLARE @startDateOrig datetime
	DECLARE @count int
	DECLARE @assignmentID int
	DECLARE @iRow int
	DECLARE @ID int
	DECLARE @busDayBehavior int
	DECLARE @SoftDueOffsetDays INT
	
	/*DECLARE @ScheduleID int
	SELECT @ScheduleID = ScheduleID
	FROM QCheck_ChecklistInstances
	WHERE ID = @InstanceID
	
	SELECT @busDayBehavior = busDayBehavior
	FROM QCheck_Schedule
	WHERE [ID] = @ScheduleID
	*/
	
	--Calculate the relevant dates through this sp
	--EXEC [QCheck_CalculateStartDates]  @ScheduleID, @startDate output, @dueDate output, @nextStart output, @relativeStart output, @startDateOrig, @busDayBehavior, @AsOfDate
	
	SELECT 
		@dueDate = u.DueTime,
		@SoftDueOffsetDays = ISNULL(s.SoftDueOffsetDays, 0),
		@InstanceID = InstanceID
	FROM 
		qcheck_upcomingduetimes u
		INNER JOIN qcheck_checklistinstances ci
			ON u.InstanceID = ci.[id]
		INNER JOIN qcheck_schedule s
			ON ci.ScheduleID = s.[ID]
	WHERE 
		u.[ID] = @UpcomingID
	
	--If the start date is null, then do not activate
	--If @startDate is not null and ISNull(@dueDate, 0) > getdate()
	--BEGIN
	
	DECLARE @tmptbl TABLE (	
		RowID INT IDENTITY(1, 1),
		assignmentID Int
	)
	
	-- send an email of the instance ID with null duetime
	IF @dueDate is null BEGIN
		RETURN
	END

	--activate the checklist
	INSERT INTO QCheck_ActiveChecklists (
		InstanceID, 
		DueTime, 
		OrigDueTime,
		ReminderDate
	) VALUES (
		@InstanceID, 
		@dueDate, 
		@dueDate,
		DATEADD(DAY, -1 * @SoftDueOffsetDays, @DueDate)
	)
	
	SELECT @ID = @@IDENTITY	
	
	-- gather the assignments
	INSERT INTO @tmptbl
		SELECT [ID]
		FROM QCheck_Assignments
		WHERE InstanceID = @InstanceID
		AND IsDeleted = 0
	
	SET @count = @@ROWCOUNT
	--initialize index counter
	SET @iRow = 1
	--establish loop structure
	WHILE @iRow <= @count
	BEGIN
		--get row values
		SELECT @assignmentID = assignmentID
		FROM @tmptbl
		WHERE RowID = @iRow
		
		--activate the assignment
		INSERT INTO QCheck_ActiveAssignments (
			ActiveChecklistID, 
			AssignmentsID
		) VALUES (
			@ID, 
			@assignmentID
		)
		
		Set @iRow = @iRow + 1
	
	END
	
	EXEC QCheck_ActivateStatus @InstanceID, @ID
	
	DELETE FROM qcheck_upcomingduetimes
	WHERE ID = @UpcomingID

	SET @NewID = @ID
	
	--EXEC QCheck_ActiveInstanceAlert @ID, 'Start'
	--END
	
	--set the next start time
	/*UPDATE QCheck_ChecklistInstances
	SET NextStartTime = @nextstart,
	RelativeStartTime = @relativeStart
	WHERE [ID] = @InstanceID*/
	
	exec QCheck_CreateActiveAlerts @InstanceID

	COMMIT TRAN
		
	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateFutureInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                        PROCEDURE [dbo].[QCheck_ActivateFutureInstance]
	@InstanceID int
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @count int
	DECLARE @iRow int
	DECLARE @ID int
	DECLARE @UpcomingID int
	DECLARE @NewID int

	DECLARE @tmptbl TABLE(	
	  RowID INT IDENTITY(1, 1),
          instanceID Int, 
          upcomingID Int)

	-- find all checklist instances that are ready to be rescheduled
	INSERT INTO @tmptbl (instanceID, upcomingID)
	SELECT a.[ID], b.[ID]
	FROM QCheck_ChecklistInstances a
	INNER JOIN qcheck_upcomingduetimes b 
	ON a.id = b.instanceid
	WHERE cast(convert(varchar, b.duetime, 101) as datetime) <= cast(convert(varchar, getdate(), 101) as datetime)
	AND a.isDeleted = 0
	AND a.id = @instanceID
		
	SET @count = @@ROWCOUNT
	/*initialize index counter*/
	SET @iRow = 1
	/*establish loop structure*/
	WHILE @iRow <= @count
	BEGIN
		--get the instance id and schedule id
		SELECT @InstanceID = instanceID, @UpcomingID = upcomingID
		FROM @tmptbl
		WHERE RowID = @iRow
	
		EXEC [QCheck_ActivateFuture]  @instanceID, @UpcomingID, @NewID
		
		Set @iRow = @iRow + 1

	END

	SET NOCOUNT OFF

END







































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateFutureInstances]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                          PROCEDURE [dbo].[QCheck_ActivateFutureInstances]
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @count int
	DECLARE @iRow int
	DECLARE @ID int
	DECLARE @InstanceID int
	DECLARE @UpcomingID int
	DECLARE @NewID int

	DECLARE @tmptbl TABLE(	
	  RowID INT IDENTITY(1, 1),
          instanceID Int, 
          upcomingID Int)

	-- find all checklist instances that are ready to be rescheduled
	INSERT INTO @tmptbl (instanceID, upcomingID)
	SELECT a.[ID], b.[ID]
	FROM QCheck_ChecklistInstances a
	INNER JOIN qcheck_upcomingduetimes b 
	ON a.id = b.instanceid
	INNER JOIN qcheck_schedule s
	ON s.ID = a.ScheduleID
	AND s.freqType > 1
	WHERE cast(convert(varchar, b.duetime, 101) as datetime) <= cast(convert(varchar, getdate(), 101) as datetime)
	AND a.isDeleted = 0
		
	SET @count = @@ROWCOUNT
	/*initialize index counter*/
	SET @iRow = 1
	/*establish loop structure*/
	WHILE @iRow <= @count
	BEGIN
		--get the instance id and schedule id
		SELECT @InstanceID = instanceID, @UpcomingID = upcomingID
		FROM @tmptbl
		WHERE RowID = @iRow
	
		EXEC [QCheck_ActivateFuture]  @instanceID, @UpcomingID, @NewID
		
		Set @iRow = @iRow + 1

	END

	SET NOCOUNT OFF

END









































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateFutureInstancesAfterCompleted]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActivateFutureInstancesAfterCompleted]
	@ActiveChecklistID int,
	@UpcomingDueTimeID INT = NULL OUTPUT,
	@NewActiveChecklistID INT = NULL OUTPUT
 AS

BEGIN

	SET NOCOUNT ON
	
	-- Used in the calendar tab to find the next item to show as active.
	SET @UpcomingDueTimeID = -1
	
	DECLARE @InstanceID int
	DECLARE @UpcomingID int
	DECLARE @newID int
	DECLARE @freqType int
	DECLARE @origDueTime datetime
	DECLARE @nextDueTime datetime
	
	DECLARE @PreviousAC int
	SET @PreviousAC = 0

	SELECT @InstanceID = ci.ID,
		@freqType = s.freqType,
		@origDueTime = ac.origDueTime
	FROM 
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.ID
			AND ac.ID = @ActiveChecklistID
		INNER JOIN QCheck_Schedule s
			ON ci.ScheduleID = s.ID

	IF @freqType > 1
	BEGIN
		
		SELECT
			@UpcomingID = udt1.id,
			@nextDueTime = udt1.duetime
		FROM
			qcheck_upcomingduetimes udt1
			inner join (
				SELECT min(DueTime) as duetime
				FROM qcheck_upcomingduetimes
				WHERE instanceID = @InstanceID
			) udt2
				ON udt2.duetime = udt1.duetime
				AND udt1.instanceID = @InstanceID


		SELECT 
			@PreviousAC = ac.ID
		FROM 
			QCheck_ActiveChecklists ac
		WHERE
			(
				ac.origDueTime < @origDueTime 
				OR ac.origDueTime < @nextDueTime
			)
			AND ac.CompletedDate is null
			AND ac.InstanceID = @InstanceID

		If @PreviousAC = 0 and @UpcomingID is not null
		BEGIN

			EXEC [QCheck_ActivateFuture]  @instanceID, @UpcomingID, @newID OUTPUT
			SET @UpcomingDueTimeID = @UpcomingID
			SET @NewActiveChecklistID = @newID

		END
		
	END

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateFutureInstancesAfterDue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActivateFutureInstancesAfterDue]
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @count int
	DECLARE @iRow int
	DECLARE @ID int
	DECLARE @InstanceID int
	DECLARE @UpcomingID int
	DECLARE @newID int

	DECLARE @tmptbl TABLE(	
	  RowID INT IDENTITY(1, 1),
          instanceID Int, 
          upcomingID Int)

	delete from qcheck_upcomingduetimes
	where instanceid not in (select id from qcheck_checklistinstances)

	-- find all checklist instances that are ready to be rescheduled
	INSERT INTO @tmptbl (instanceID, upcomingID)
	select distinct udt2.instanceid, udt2.id
	from
		(select udt.instanceID, min(udt.DueTime) as duetime
		FROM
			qcheck_upcomingduetimes udt
		left outer join
			qcheck_activechecklists ac
		on
			ac.origduetime = udt.duetime
		and
			ac.instanceid = udt.instanceid
		where 
			ac.id is null
		group by udt.instanceid) udt
	inner join qcheck_upcomingduetimes udt2
	on udt2.instanceid = udt.instanceid
	and udt2.duetime = udt.duetime
	left outer join qcheck_activechecklists ac
		on ac.instanceid = udt.instanceid
		and ac.origduetime >= getdate()
		and ac.origduetime < udt2.duetime
	left outer join qcheck_activechecklistarchive aca
		on aca.instanceid = udt.instanceid
		and aca.origduetime >= getdate()
		and aca.origduetime < udt2.duetime
	left outer join qcheck_activechecklists ac2
		on ac2.instanceid = udt.instanceid
		and ac2.origduetime <= getdate()
	left outer join qcheck_activechecklistarchive aca2
		on aca2.instanceid = udt.instanceid
		and aca2.origduetime <= getdate()
	where 
		aca.id is null 
		and ac.id is null
		and (ac2.id is not null or aca2.id is not null)
		
	SET @count = @@ROWCOUNT
	/*initialize index counter*/
	SET @iRow = 1
	/*establish loop structure*/
	WHILE @iRow <= @count
	BEGIN
		--get the instance id and schedule id
		SELECT @InstanceID = instanceID, @UpcomingID = upcomingID
		FROM @tmptbl
		WHERE RowID = @iRow
	
		EXEC [QCheck_ActivateFuture]  @instanceID, @UpcomingID, @newID
		
		Set @iRow = @iRow + 1

	END

	SET NOCOUNT OFF

END












































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateFutureInstancesForReminders]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_ActivateFutureInstancesForReminders] AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @count int
	DECLARE @iRow int
	DECLARE @ID int
	DECLARE @InstanceID int
	DECLARE @UpcomingID int
	DECLARE @newID int

	DECLARE @tmptbl TABLE(	
	  RowID INT IDENTITY(1, 1),
          instanceID Int, 
          upcomingID Int)

	-- find all checklist instances that are ready to be rescheduled
	INSERT INTO @tmptbl (instanceID, upcomingID)
		SELECT DISTINCT 
			ci.[ID], 
			udt.[ID] 
		FROM 
			QCheck_Alerts a
			INNER JOIN qcheck_upcomingduetimes udt
				ON a.instanceid = udt.instanceid
				AND cast(convert(varchar, dateadd(day, -1 * DaysBefore, udt.duetime), 101) as datetime) <= getdate()
			INNER JOIN qcheck_checklistinstances ci
				ON ci.id = a.instanceid
				AND a.isdeleted = 0
				AND ci.isdeleted = 0
			INNER JOIN qcheck_schedule s
				ON s.ID = ci.ScheduleID
				AND s.freqType > 1
			-- You can have a deleted checklist but not deleted instance, so double-check that
			-- this really is an active checklist before trying to send alerts on it.
			INNER JOIN QCheck_Checklists c
				ON ci.ChecklistID = c.ID
				AND c.IsDeleted = 0
		
	SET @count = @@ROWCOUNT
	/*initialize index counter*/
	SET @iRow = 1
	/*establish loop structure*/
	WHILE @iRow <= @count
	BEGIN
		--get the instance id and schedule id
		SELECT @InstanceID = instanceID, @UpcomingID = upcomingID
		FROM @tmptbl
		WHERE RowID = @iRow
	
		EXEC [QCheck_ActivateFuture]  @instanceID, @UpcomingID, @newID
		
		Set @iRow = @iRow + 1

	END

	SET NOCOUNT OFF

END








































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











-- This stored procedure will Activate a Checklist Instance by creating records in the 
-- Active checklist and Active Assignments tables
CREATE                                        PROCEDURE [dbo].[QCheck_ActivateInstance](
	@InstanceID INT,
	@AsOfDate datetime
)
 AS

BEGIN
	
	SET NOCOUNT ON
	
	DECLARE @dueDate datetime 
	DECLARE @relativeDue datetime
	DECLARE @count int
	DECLARE @assignmentID int
	DECLARE @iRow int
	DECLARE @ID int
	
	--Calculate the relevant dates through this sp
	EXEC [QCheck_CalculateNextDueTime]  @InstanceID, @AsofDate, @dueDate output, @relativeDue output

	
	If IsNull(@dueDate, 0) > getdate()
	and not exists (
			select 1 from QCheck_ActiveChecklists 
			where instanceID = @InstanceID
			and OrigDueTime = @dueDate
			and DueTime = @dueDate
	)
	BEGIN
	
		DECLARE @tmptbl TABLE(	
		  RowID INT IDENTITY(1, 1),
	          assignmentID Int)
	
		
		--activate the checklist
		INSERT INTO QCheck_ActiveChecklists
		(InstanceID, DueTime, OrigDueTime)
		VALUES
		(@InstanceID, @dueDate, @dueDate)
	
		SELECT @ID = @@IDENTITY	

		-- gather the assignments
		INSERT INTO @tmptbl
		SELECT [ID]
		FROM QCheck_Assignments
		WHERE InstanceID = @InstanceID
		AND IsDeleted = 0
			
		SET @count = @@ROWCOUNT
		--initialize index counter
		SET @iRow = 1
		--establish loop structure
		WHILE @iRow <= @count
		BEGIN
			--get row values
			SELECT @assignmentID = assignmentID
			FROM @tmptbl
			WHERE RowID = @iRow
		
			
			
			--activate the assignment
			INSERT INTO QCheck_ActiveAssignments
			(ActiveChecklistID, AssignmentsID)
			VALUES
			(@ID, @assignmentID)
			
			Set @iRow = @iRow + 1
	
		END

		EXEC QCheck_ActivateStatus @InstanceID, @ID
	
		exec QCheck_CreateActiveAlerts @InstanceID

		EXEC QCheck_ActiveInstanceAlert @ID, 'Start'
	END


	SET NOCOUNT OFF

END




































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateInstanceStatus]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE             PROCEDURE [dbo].[QCheck_ActivateInstanceStatus](
	@InstanceID int
)
 AS

BEGIN
	DECLARE @ActiveChecklistID int
	
	DECLARE ACTIVECHECK_CURS CURSOR FOR
	SELECT ac.ID
	FROM QCheck_ActiveChecklists ac
	WHERE ac.InstanceID = @InstanceID 
	AND ac.CompletedDate is null
	
	
	OPEN ACTIVECHECK_CURS
	FETCH NEXT FROM ACTIVECHECK_CURS INTO @ActiveChecklistID
	WHILE @@FETCH_STATUS = 0 BEGIN

		EXEC QCheck_ActivateStatus @InstanceID, @ActiveChecklistID
	

	FETCH NEXT FROM ACTIVECHECK_CURS INTO @ActiveChecklistID
	END
	CLOSE ACTIVECHECK_CURS
	DEALLOCATE ACTIVECHECK_CURS


END







GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will Activate a New Schedule
CREATE  PROCEDURE [dbo].[QCheck_ActivateSchedule](
	@InstanceID INT,
	@PreviousFreqType INT = 0,
	@activateNow bit = 0
) AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @relativeDue datetime,
		@freqType int,
		@dueDate datetime,
		@activeid int,
		@asofdate datetime

	select @freqType = freqType
	FROM qcheck_schedule s
	inner join qcheck_checklistinstances ci
	on ci.scheduleid = s.id
	and ci.id = @InstanceID

	Set @asofdate = getdate()
				
	If @activateNow = 1
	BEGIN
		EXEC [QCheck_ActivateInstance] @InstanceID, @asofdate
	END
	ELSE
	BEGIN
		If @freqType = 1
		BEGIN
			SELECT @activeid = MAX(ID)
			FROM QCheck_ActiveChecklists a
			WHERE a.InstanceID = @InstanceID
			
			IF @activeid IS NULL OR @PreviousFreqType <> 1
			BEGIN
				EXEC [QCheck_ActivateInstance] @InstanceID, @asofdate
			END
			ELSE
			BEGIN
				EXEC [QCheck_CalculateNextDueTime]  @InstanceID, @AsofDate, @dueDate output, @relativeDue output

				INSERT INTO QCheck_ActiveChecklistArchive
				SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
				WHERE InstanceID = @InstanceID
				AND ID <> @activeid

				DELETE FROM QCheck_ActiveChecklists
				WHERE InstanceID = @InstanceID
				AND ID <> @activeid

				UPDATE 
					QCheck_ActiveChecklists
				SET 
					DueTime = isnull(@dueDate, ac.DueTime),
					ReminderDate = CASE
						-- Only want to modify the reminder date if it is still the default, i.e. the same as the due date.  Otherwise leave it alone--somebody
						-- has changed it for a reason.
						WHEN ISNULL(ac.ReminderDate, ac.DueTime) = ac.DueTime THEN DATEADD(DAY, -1 * ISNULL(s.SoftDueOffsetDays, 0), ISNULL(@DueDate, ac.DueTime))
						ELSE ac.ReminderDate
					END
				FROM
					QCheck_ActiveChecklists ac
					INNER JOIN qcheck_checklistinstances ci
						ON ac.InstanceID = ci.[id]
					INNER JOIN qcheck_schedule s
						ON ci.ScheduleID = s.[ID]
				WHERE 
					ac.InstanceID = @InstanceID

			END
		END
	END
	
	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActivateStatus]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                  PROCEDURE [dbo].[QCheck_ActivateStatus](
	@InstanceID int,
	@ActiveChecklistID int
)
 AS

BEGIN

	Insert into QStatus_ActiveChecklistTaskType
	(ActiveChecklistID, TaskType, Priority)--, ShowSupervisor)
	SELECT 	@ActiveChecklistID, t.TaskType, 1--i.Priority--, t.ShowSupervisor
	FROM QStatus_InstanceTaskType t
	INNER JOIN QCheck_ChecklistInstances i
	ON i.ID = t.InstanceID 
	AND i.ID = @InstanceID
	WHERE NOT EXISTS (
		Select 1 
		FROM QStatus_ActiveChecklistTaskType
		WHERE ActiveChecklistID = @ActiveChecklistID
	)

	

	if @@RowCount > 0 
	BEGIN
		
		UPDATE QStatus_Report
		SET LastReportDate = GetDate()
		WHERE ID IN
			(
				SELECT tt.ReportID
				FROM QStatus_InstanceTaskType t
				INNER JOIN QCheck_ChecklistInstances i
				ON i.ID = t.InstanceID 
				AND i.ID = @InstanceID
				INNER JOIN QStatus_TaskTypes tt
				on t.TaskType = tt.ID
			)
	END

END
































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveAlertSent]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                    PROCEDURE [dbo].[QCheck_ActiveAlertSent] 
	@ActiveAlertID int
AS
BEGIN
	SET NOCOUNT ON
		
			UPDATE QCheck_ActiveAlerts
			SET SentTime = getDate()
			WHERE [ID] = @ActiveAlertID

	SET NOCOUNT OFF
END























GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveChecklistInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActiveChecklistInfo] (
	@ActiveChecklistID INT,
	@UserID INT
) AS

BEGIN

	DECLARE @IsController BIT = 0

	-- Get whether the user is a controller
	SELECT 
		@IsController = 1
	FROM
		QCheck_ActiveChecklists_All ac
		INNER JOIN QCheck_ChecklistInstances_All ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists_All c
			ON ci.ChecklistID = c.ID
		INNER JOIN QCheck_ChecklistManagers_WithTemp cm
			ON c.ID = cm.ChecklistID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.ID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
	WHERE
		ac.ID = @ActiveChecklistID
		AND gm.UserID = @UserID
	
	-- Get the active checklist info
	SELECT 
		c.ID AS ChecklistID,
		ci.ID AS InstanceID,
		ac.ID AS ActiveChecklistID,
		c.Name AS ChecklistName,
		ac.DueTime,
		MIN(udt.DueTime) AS NextDue,
		ac.CompletedDate,
		ac.CompletedBy,
		@IsController AS IsController
	FROM
		QCheck_ActiveChecklists_All ac
		INNER JOIN QCheck_ChecklistInstances_All ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists_All c
			ON ci.ChecklistID = c.ID
		LEFT OUTER JOIN QCheck_UpcomingDueTimes udt
			ON ac.InstanceID = udt.InstanceID
	WHERE
		ac.ID = @ActiveChecklistID
	GROUP BY
		c.ID,
		ci.ID,
		ac.ID,
		c.Name,
		ac.DueTime,
		ac.CompletedDate,
		ac.CompletedBy
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveChecklistName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActiveChecklistName] (
	@ActiveChecklistID INT,
	@ChecklistName VARCHAR(500) OUTPUT
) AS

SELECT 
	@ChecklistName = c.Name
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
WHERE
	ac.ID = @ActiveChecklistID
	
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveInstanceAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE               PROCEDURE [dbo].[QCheck_ActiveInstanceAlert]
(
	@ActiveInstanceID int,
	@AlertType varchar(10)

) AS
BEGIN

	DECLARE @ID int
	DECLARE @ChecklistName VARCHAR(500)
	DECLARE @Alertee int

	DECLARE AIA_CHK_CURS CURSOR FOR
	SELECT
		distinct a.ID, d.[Name], a.AlerteeGroupID
	FROM 
		QCheck_Alerts a
	INNER JOIN
		QCheck_ChecklistInstances b
	   ON 
		a.InstanceID = b.ID
	INNER JOIN
		QCheck_ActiveChecklists c
	   ON
		c.InstanceID = b.ID
	   AND
		c.ID = @ActiveInstanceID
	INNER JOIN
		QCheck_Checklists d
	   ON 
		b.ChecklistID = d.[ID]
	WHERE
		a.AlertType = @AlertType
	and
		a.isdeleted = 0

		OPEN AIA_CHK_CURS
		FETCH NEXT FROM AIA_CHK_CURS INTO @ID, @ChecklistName, @Alertee
		WHILE @@FETCH_STATUS = 0 BEGIN
	
		EXEC QCheck_ActiveInstanceAlert_SingleUser @ActiveInstanceID, @ChecklistName, @Alertee, @AlertType
		
		UPDATE QCheck_Alerts
		SET SentTime = getDate()
		WHERE [ID] = @ID

		FETCH NEXT FROM AIA_CHK_CURS INTO @ID, @ChecklistName, @Alertee
		END
		CLOSE AIA_CHK_CURS
		DEALLOCATE AIA_CHK_CURS
END





































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveInstanceAlert_SingleUser_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActiveInstanceAlert_SingleUser_HTML]
	@activeChecklistID int,
	@AlertType varchar(10),
	@AppURL varchar(50),
	@ImagesURL varchar(50)
	
AS

BEGIN
	SET NOCOUNT ON

	DECLARE @tmpBody VARCHAR(max)
	DECLARE @DueTime DATETIME
	DECLARE @ChecklistName VARCHAR(500)
	DECLARE @ItemType INT
	DECLARE @ChkText VARCHAR(max)
	DECLARE @URL VARCHAR(1000)
	DECLARE @SequenceNum int
	DECLARE @UserText VARCHAR(1000)
	DECLARE @CompletedBy VARCHAR(50)
	DECLARE @CompletedDate DATETIME
	DECLARE @rowNum int
	DECLARE @supervisors VARCHAR(1000)
	DECLARE @supervisor varchar(50)
	DECLARE @assignees VARCHAR(1000)
	DECLARE @assignee VARCHAR(50)
	DECLARE @alertees VARCHAR(1000)
	DECLARE @alertee VARCHAR(50)
	DECLARE @commentsonly bit = 0

	DECLARE @InstanceID int
	DECLARE @ChecklistID int
	
	SELECT @InstanceID = IsNull(i.ID, 0),
		@ChecklistID = IsNull(i.ChecklistID, 0)
	FROM
		QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances i
	ON	
		i.ID = ac.InstanceID
	AND ac.ID = @activeChecklistID

	SELECT @commentsonly = 1 
	FROM QCheck_CommentsOnlyChecklist
	where Checklistid = @ChecklistID

	select @alertees = dbo.QCheck_AlerteesList(@InstanceID)
	select @supervisors = dbo.QCheck_ManagersList(@ChecklistID)
	select @assignees = dbo.QCheck_AssigneesList(@InstanceID)

	-- Get app configuration
	DECLARE @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1


	SET @rowNum = 0
	
	-- table that will hold the html
	
	DECLARE @html_output TABLE (
		seq INT IDENTITY(1,1),
		row_html VARCHAR(max)
	)

	
	
	-- get each row of data from the checklists
	-- find only data from the active checklist specified

	DECLARE InstanceAlert_CHK_CURS CURSOR FOR

	SELECT DISTINCT a.DueTime, 
			f.Name, it.ID As ItemType, k.Text, k.URL, k.SequenceNum, ai.text As UserText,
			u.FullName, ai.CompletedDate
		FROM 
			QCheck_ActiveChecklists a
		INNER JOIN
			QCheck_ActiveAssignments b
		   ON 	
			b.ActiveChecklistID = a.ID
		INNER JOIN
			QCheck_Assignments c
		   ON
			b.AssignmentsID = c.ID and c.IsDeleted = 0
		INNER JOIN
			QCheck_ChecklistInstances e 
		   ON
			a.InstanceID = e.ID and e.isDeleted = 0
		INNER JOIN
			QCheck_Checklists f
		   ON
			e.ChecklistID = f.ID and f.isDeleted = 0
		INNER JOIN QCheck_Items k on k.checklistID = f.ID AND k.IsDeleted = 0
		INNER JOIN QCheck_ItemTypes it on k.ItemTypeID = it.ID
		LEFT OUTER JOIN QCheck_ActiveItems ai on ai.ActiveChecklistID = a.ID and ai.ChecklistItemID = k.ID
		LEFT OUTER JOIN QCheck_Users u on ai.CompletedBy = u.ID
		WHERE
			a.ID = @activeChecklistID
		ORDER BY 
			k.SequenceNum
			
	
-- apply the style sheet and header information
	INSERT INTO @html_output (row_html) 
			SELECT
		'
<LINK href="'+@ImagesURL+'Styles.css" type="text/css" rel="stylesheet">'

	
	
	OPEN InstanceAlert_CHK_CURS
	FETCH NEXT FROM InstanceAlert_CHK_CURS INTO @DueTime, @ChecklistName, @ItemType, @ChkText, @URL, @SequenceNum, @UserText, @CompletedBy, @CompletedDate
	WHILE @@FETCH_STATUS = 0 BEGIN

	SET @tmpBody = ''
	-- first time through the loop
	If @rownum = 0
		BEGIN
			
			SET @tmpBody = @tmpBody +  '<table><tr><td>This is an ALERT from <a href='''+@appURL+'''>'+@AppName +'</a>.</td></tr><tr><td height=25>&nbsp;</td></tr></table>'

			SET @tmpBody = @tmpBody +  '<table><tr><td>Managers: '+@supervisors+'</td></tr><tr><td>Assigned To: '+@assignees+'</td></tr><tr><td>Alert Recipients: '+@alertees+'</td></tr><tr><td height=25>&nbsp;</td></tr></table>'

			SET @tmpBody = @tmpBody +  '<table width="100%" cellpadding=0 cellspacing=0>'
			SET @tmpBody = @tmpBody +  '<tr><td colspan=5 style="vertical-align:top;" width=100%><table cellspacing=0 cellpadding=0 width=100%><tr><td style="width:4px;"><img src="'+@ImagesURL+'tab_start.gif" alt="" border="0"/></td><td class="SubHeadOverdue" style="white-space:nowrap;">&nbsp;&nbsp;'+  isNull(@ChecklistName,'&nbsp;') + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="tabcenter" width="80%"><img src="'+@ImagesURL+'tab_center.gif" alt="" border="0" /></td><td class="tabcenter" style="text-align:right;"><img src="'+@ImagesURL+'tab_end.gif" alt="" border="0" /></td>
				</tr></table></td></tr><tr><td class="both" colspan="5"><span class=due>'
			If @CompletedDate IS NULL BEGIN
			-- if its overdue, use overdue (red)
			If @DueTime < getDate() BEGIN
				SET @tmpBody = @tmpBody + '<span class=overdue>Overdue </span>'
			END
			SET @tmpBody = @tmpBody + 'Due '+CONVERT(varchar, @DueTime, 100)+'</span><td></td></tr>'
			END
			ELSE
			BEGIN
				SET @tmpBody = @tmpBody + '<span class=completed>Completed </span>' +CONVERT(varchar, @CompletedDate, 100)+'</span><td></td></tr>'
			END
			SET @tmpBody = @tmpBody + '<tr class="SubHead2InCompleteMiddle">
						<td class="SubHead2InCompleteLeft">&nbsp;</td><td class="SubHead2InCompleteMiddle">&nbsp;</td><td class="SubHead2InComplete" style="width:10%;">Comments</td><td class="SubHead2InComplete" style="width:10%;">Completed&nbsp;By</td><td class="SubHead2InCompleteRight" style="width:10%;">Completed&nbsp;On</td><td></td>
						</tr>'
		END
	
	-- this is a checkbox item
	If @ItemType = 1 and (@commentsonly = 0 or len(isNull(@UserText, '')) > 0)  BEGIN
		-- completed check
		If NOT @CompletedDate IS NULL 
		BEGIN
			SET @tmpBody = @tmpBody + '<tr class="CheckboxCompleted"><td class="left" style="width:5%;" ><input type="checkbox" disabled="disabled" '
		
			SET @tmpBody = @tmpBody + ' checked ></td><td width="65%">'
			SET @tmpBody = @tmpBody + isNull(@ChkText,'&nbsp;') 
			-- append the link
			If isNull(@URL,'') <> '' SET @tmpBody = @tmpBody + '(<a href = "' + @URL + '"><font color=#AAAAAA>More Info</font></a>)'
			SET @tmpBody = @tmpBody + '</td><td>'+isNull(@UserText,'&nbsp;')+'</td><td nowrap="nowrap">'+isNull(@CompletedBy,'&nbsp;')+'</td><td class="right" nowrap="nowrap">'+isNull(CAST(@CompletedDate AS VARCHAR),'&nbsp;')+'</td></tr>'--CheckBox Checked
		END
		Else 
		-- incomplete check
		BEGIN
			SET @tmpBody = @tmpBody + '<tr class="CheckboxInComplete"><td class="left" style="width:5%;" ><input type="checkbox" disabled="disabled" '
		
			SET @tmpBody = @tmpBody + '></td><td width="65%">'
			SET @tmpBody = @tmpBody + isNull(@ChkText,'&nbsp;') 
			-- append the link
			If isNull(@URL,'') <> '' SET @tmpBody = @tmpBody + '(<a href = "' + @URL + '">More Info</a>)'
			SET @tmpBody = @tmpBody + '</td><td>'+isNull(@UserText,'&nbsp;')+'</td><td nowrap="nowrap">'+isNull(@CompletedBy,'&nbsp;')+'</td><td class="right" nowrap="nowrap">'+isNull(CAST(@CompletedDate AS VARCHAR),'&nbsp;')+'</td></tr>'--CheckBox
		END
	END
	--Heading item
	If @ItemType = 2 BEGIN
		SET @tmpBody = @tmpBody + '<tr class="HeadingInComplete"><td class="both" colspan = "5">'+isNull(@ChkText,'&nbsp;') 
		-- append link
		If isNull(@URL,'') <> '' SET @tmpBody = @tmpBody + '(<a href = "' + @URL + '">More Info</a>)'
		SET @tmpBody = @tmpBody + '</td></tr>'--Heading
	END
	--SubHeading item
	If @ItemType = 3 BEGIN
		SET @tmpBody = @tmpBody + '<tr class="SubHeadingInComplete"><td class="both" colspan = "5">&nbsp;&nbsp;&nbsp;&nbsp;'+isNull(@ChkText,'&nbsp;') 
		-- append link
		If isNull(@URL,'') <> '' SET @tmpBody = @tmpBody + '(<a href = "' + @URL + '">More Info</a>)'
		SET @tmpBody = @tmpBody + '</td></tr>'--SubHeading
	END
	--Spacer - do nothing
	If @ItemType = 4 SET @tmpBody = @tmpBody + '<tr><td class="checklistspacer" colspan="5" height="15">&nbsp;</td></tr>'--Spacer
	
	-- notes - italic
	If @ItemType = 5 BEGIN
		SET @tmpBody = @tmpBody + '<tr class="NotesInComplete"><td class="both" colspan = "5">&nbsp;&nbsp;&nbsp;'+isNull(@ChkText,'&nbsp;') 
		-- append link
		If isNull(@URL,'') <> '' SET @tmpBody = @tmpBody + '(<a href = "' + @URL + '">More Info</a>)'
		SET @tmpBody = @tmpBody + '</td></tr>'--Notes
	END


	INSERT INTO @html_output (row_html) SELECT @tmpBody
	
	SET @rownum = @rownum + 1
		
		FETCH NEXT FROM InstanceAlert_CHK_CURS INTO @DueTime, @ChecklistName, @ItemType, @ChkText, @URL, @SequenceNum, @UserText, @CompletedBy, @CompletedDate
	END
	CLOSE InstanceAlert_CHK_CURS
	DEALLOCATE InstanceAlert_CHK_CURS

	If @rownum > 0 INSERT INTO @html_output (row_html) SELECT '<tr><td class="bottom" height="15" colspan=5>&nbsp;</td></tr></table>'

	SELECT row_html FROM @html_output ORDER BY seq

	SET NOCOUNT OFF
END































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ActiveTaskSearch]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ActiveTaskSearch] (
	@Search VARCHAR(5000),
	@UserID INT
) AS

BEGIN

	-- Clean up the search terms, this prevents errors with full text search.  Bear with me, it's a lot of different
	-- criteria because there are a lot of edge cases when you start using the boolean operators.
	
	-- Blank searches return nothing
	IF LTRIM(RTRIM(ISNULL(@Search, ''))) = '' SET @Search = '@@@***###' 
	
	-- Clean up double spaces (do this a couple times in case there were 3 or 4 spaces)
	SET @Search = REPLACE(@Search, '  ', ' ')
	SET @Search = REPLACE(@Search, '  ', ' ')
	SET @Search = REPLACE(@Search, '  ', ' ')
	
	-- Handle special characters
	SET @Search = REPLACE(@Search, '&', 'AND')
	
	-- If you didn't include quotes, go ahead and assume each separate word is a different search term
	IF CHARINDEX('"', @Search) = 0 SET @Search = REPLACE(@Search, ' ', ' AND ')
	SET @Search = REPLACE(@Search, 'AND AND AND', 'AND') -- Fixes if you included AND
	SET @Search = REPLACE(@Search, 'AND OR AND', 'OR') -- Fixes if you included OR
	
	-- Wrap search terms in quotes, this is necessary for the wildcards further down
	SET @Search = '"' + @Search + '"' -- Wrap terms in quotes
	SET @Search = REPLACE(@Search, ' and ', '" and "') -- AND keyword goes outside quotes
	SET @Search = REPLACE(@Search, ' or ', '" or "') -- OR keyword goes outside quotes
	SET @Search = REPLACE(@Search, '""', '"') -- Fix any double quotes created above
	IF RIGHT(@Search, 5) = ' and"' SET @Search = LEFT(@Search, LEN(@Search) - 5) + '"' -- Special case if you send in "foo and"
	IF RIGHT(@Search, 6) = ' and "' SET @Search = LEFT(@Search, LEN(@Search) - 6) -- Special case if you send in "foo and "
	IF RIGHT(@Search, 4) = ' or"' SET @Search = LEFT(@Search, LEN(@Search) - 4) + '"' -- Special case if you send in "foo or"
	IF RIGHT(@Search, 5) = ' or "' SET @Search = LEFT(@Search, LEN(@Search) - 5) -- Special case if you send in "foo or "
	
	-- Put wildcards on both sides of each search term, so you can do partial word matching
	SET @Search = ' ' + @Search + ' '
	SET @Search = REPLACE(@Search, ' "', ' "*') -- Wildcard at the beginning of the word
	SET @Search = REPLACE(@Search, '" ', '*" ') -- Wildcard at the end of the word
	SET @Search = LTRIM(RTRIM(@Search)) -- Take away the spaces created above

	DECLARE @Tasks TABLE (
		ActiveChecklistID INT,
		InstanceID INT,
		DueTime DATETIME,
		CompletedDate DATETIME
	)
	
	DECLARE @TasksToShow TABLE (
		ActiveChecklistID INT,
		InstanceID INT
	)
	
	DECLARE @UserTasks TABLE (
		ActiveChecklistID INT
	)
	
	DECLARE @IsAdmin BIT = 0
	
	SELECT @IsAdmin = [Admin] FROM QCheck_Users WHERE ID = @UserID
	
	-- Get all the tasks whose checklist names match the search criteria
	INSERT INTO @Tasks (
		ActiveChecklistID,
		InstanceID,
		DueTime,
		CompletedDate
	)
		SELECT 
			ac.ID,
			ac.InstanceID,
			ac.DueTime,
			ac.CompletedDate
		FROM
			TaskSearchCache c
			INNER JOIN QCheck_ActiveChecklists ac
				ON c.ActiveChecklistID = ac.ID
		WHERE
			CONTAINS(c.SearchColumn, @Search)

	IF @IsAdmin = 0 BEGIN
		-- ******************************************************************************************
		-- @UserTasks is a list of tasks the user is attached to, via being assigned, controlling
		-- the task, or seeing it on a status report.
		-- ******************************************************************************************
		
		-- Assigned tasks
		INSERT INTO @UserTasks (
			ActiveChecklistID
		)
			SELECT DISTINCT
				aa.ActiveChecklistID
			FROM
				QCheck_ActiveAssignments aa
				INNER JOIN QCheck_Assignments a
					ON aa.AssignmentsID = a.ID
					AND a.IsDeleted = 0
				INNER JOIN QCheck_Groups g
					ON a.GroupID = g.ID
				INNER JOIN QCheck_GroupMembership gm
					ON g.ID = gm.GroupID
				INNER JOIN QCheck_Users u
					ON gm.UserID = u.ID
			WHERE
				u.ID = @UserID
				
		-- Controlled tasks
		INSERT INTO @UserTasks (
			ActiveChecklistID
		)
			SELECT DISTINCT
				ac.ID
			FROM
				QCheck_ChecklistManagers cm
				INNER JOIN QCheck_Checklists c
					ON cm.ChecklistID = c.ID
					AND cm.IsDeleted = 0
					AND c.IsDeleted = 0
				INNER JOIN QCheck_ChecklistInstances ci
					ON c.ID = ci.ChecklistID
					AND ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac
					ON ci.ID = ac.InstanceID 
				INNER JOIN QCheck_Groups g
					ON cm.ManagerGroupID = g.ID
				INNER JOIN QCheck_GroupMembership gm
					ON g.ID = gm.GroupID
				INNER JOIN QCheck_Users u
					ON gm.UserID = u.ID
				LEFT OUTER JOIN @UserTasks ut
					ON ac.ID = ut.ActiveChecklistID
			WHERE
				u.ID = @UserID
				AND ut.ActiveChecklistID IS NULL

		-- Tasks from controlled status reports
		INSERT INTO @UserTasks (
			ActiveChecklistID
		)
			SELECT DISTINCT
				actt.ActiveChecklistID
			FROM 
				QStatus_GroupReport gr
				INNER JOIN QStatus_Report r
					ON gr.ReportID = r.ID
					AND r.IsDeleted = 0
				INNER JOIN QStatus_TaskTypes tt
					ON gr.ReportID = tt.ReportID
					AND tt.IsDeleted = 0
				INNER JOIN QStatus_ActiveChecklistTaskType actt
					ON tt.ID = actt.TaskType
				INNER JOIN QCheck_Groups g
					ON gr.GroupID = g.ID
				INNER JOIN QCheck_GroupMembership gm
					ON g.ID = gm.GroupID
				INNER JOIN QCheck_Users u
					ON gm.UserID = u.ID
				LEFT OUTER JOIN @UserTasks ut
					ON actt.ActiveChecklistID = ut.ActiveChecklistID
			WHERE
				u.ID = @UserID
				AND ut.ActiveChecklistID IS NULL
					
		-- Supervised / Interested Party reports
		INSERT INTO @UserTasks (
			ActiveChecklistID
		)
			SELECT DISTINCT
				actt.ActiveChecklistID
			FROM 
				QStatus_Supervisors s
				INNER JOIN QStatus_Report r
					ON s.ReportID = r.ID
					AND r.IsDeleted = 0
				INNER JOIN QStatus_TaskTypes tt
					ON r.ID = tt.ReportID
					AND tt.IsDeleted = 0
				INNER JOIN QStatus_ActiveChecklistTaskType actt
					ON tt.ID = actt.TaskType
				INNER JOIN QCheck_Groups g
					ON s.SupervisorGroupID = g.ID
				INNER JOIN QCheck_GroupMembership gm
					ON g.ID = gm.GroupID
				INNER JOIN QCheck_Users u
					ON gm.UserID = u.ID
				LEFT OUTER JOIN @UserTasks ut
					ON actt.ActiveChecklistID = ut.ActiveChecklistID
			WHERE
				u.ID = @UserID
				AND ut.ActiveChecklistID IS NULL

		-- Clear anything that isn't a user task out of the list we got back from the 
		-- free text search
		DELETE FROM @Tasks
		WHERE
			ActiveChecklistID NOT IN (
				SELECT ActiveChecklistID FROM @UserTasks
			)
			
	END -- @IsAdmin = 0

	-- Filter down the list, first include the active checklist with the earliest due time
	-- that has NOT been completed for each instance.  The idea here is that if you have a
	-- recurring task that has been completed multiple times but one or more occurrences have
	-- not been completed, show the earliest incomplete one.
	INSERT INTO @TasksToShow (
		ActiveChecklistID,
		InstanceID
	)
		SELECT 
			t.ActiveChecklistID,
			t.InstanceID
		FROM	
			@Tasks t
			INNER JOIN (
				SELECT
					InstanceID,
					MIN(DueTime) AS MinDueTime
				FROM
					@Tasks
				WHERE
					CompletedDate IS NULL
				GROUP BY
					InstanceID
			) m
				ON t.InstanceID = m.InstanceID
				AND t.DueTime = m.MinDueTime

	-- Next grab the latest due occurrence of a task for instances that were not included above.
	INSERT INTO @TasksToShow (
		ActiveChecklistID,
		InstanceID
	)
		SELECT 
			t.ActiveChecklistID,
			t.InstanceID
		FROM	
			@Tasks t
			INNER JOIN (
				SELECT
					InstanceID,
					MAX(DueTime) AS MaxDueTime
				FROM
					@Tasks
				GROUP BY
					InstanceID
			) m
				ON t.InstanceID = m.InstanceID
				AND t.DueTime = m.MaxDueTime
			LEFT OUTER JOIN @TasksToShow s
				ON t.InstanceID = s.InstanceID
		WHERE
			s.InstanceID IS NULL



	-- Catch-all, include active checklists for any instances that were not included above.
	INSERT INTO @TasksToShow (
		ActiveChecklistID,
		InstanceID
	)
		SELECT
			t.ActiveChecklistID,
			t.InstanceID
		FROM
			@Tasks t
			LEFT OUTER JOIN @TasksToShow s
				ON t.InstanceID = s.InstanceID
		WHERE
			s.InstanceID IS NULL
			
	-- Pull all the info for the tasks we filtered down above.
	SELECT TOP 100
		c.Name,
		c.Due,
		c.Completed,
		c.Assignees,
		c.Controllers,
		c.Schedule,
		c.LastCompletedBy,
		c.LastCompletedDate,
		c.ChecklistID,
		c.InstanceID,
		c.ActiveChecklistID
	FROM
		TaskSearchCache c
		INNER JOIN @TasksToShow s
			ON c.ActiveChecklistID = s.ActiveChecklistID
	ORDER BY
		CONVERT(DATETIME, c.Due)
		
	SELECT 
		COUNT(*)
	FROM
		TaskSearchCache c
		INNER JOIN @TasksToShow s
			ON c.ActiveChecklistID = s.ActiveChecklistID

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddActiveTaskType]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE               PROCEDURE [dbo].[QCheck_AddActiveTaskType](
	@ID int,
	@TaskType int
)
 AS

BEGIN
	DECLARE @InstanceID int
	DECLARE @TaskTypeOld int

	SELECT @TaskTypeOld = TaskType, @InstanceID = InstanceID
	FROM QStatus_InstanceTaskType
	WHERE ID = @ID


	UPDATE QStatus_InstanceTaskType
		SET TaskType = @TaskType
		WHERE InstanceID = @InstanceID
		AND TaskType = @TaskTypeOld

	UPDATE QStatus_ActiveChecklistTaskType
		SET TaskType = @TaskType
		WHERE TaskType = @TaskTypeOld
		AND ActiveChecklistID IN
		(SELECT ID
		FROM
			QCheck_ActiveChecklists
		WHERE
			instanceID = @InstanceID)

	
END




























GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




















-- This stored procedure will update a schedule for a specified instance


CREATE                 PROCEDURE [dbo].[QCheck_AddAlert](
	@InstanceID INT,
	@nagBeforeDays int = null,
	@nagTime float = null,
	@alerteegroupid int = null,
	@alertType varchar(10),
	@alertText varchar(250) = null
)
 AS

BEGIN

	SET NOCOUNT ON
	
	Insert Into QCheck_Alerts
	(InstanceID, DaysBefore, AlertTime, AlerteeGroupID, AlertType, AlertText)
	Values
	(@InstanceID, @nagBeforeDays, @nagTime, @AlerteeGroupID, @alertType, @alertText)



	SET NOCOUNT OFF

END















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddAssignedTo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_AddAssignedTo](
--DECLARE
	@InstanceID INT,-- = 1857455,
	@GroupID	int,-- = 10,
	@AssignedBy int,-- = 715,
	@Email		bit = 1
) AS
BEGIN

	SET NOCOUNT ON
	DECLARE @AssignmentsID int
	DECLARE @ScheduleID int
	DECLARE @ActiveChecklistID int
	
	DECLARE @startDate datetime
	DECLARE @dueDate datetime
	DECLARE @nextStart datetime
	DECLARE @checklistName varchar(500)
	DECLARE @relativeStart datetime
	DECLARE @ActiveAssignments int
	DECLARE @Now datetime

	--Create the assignment
	INSERT INTO
		QCheck_Assignments
	([InstanceID],  [GroupID])
	SELECT @InstanceID, @GroupID
	WHERE NOT EXISTS
	(SELECT [ID] FROM QCheck_Assignments
	WHERE InstanceID = @InstanceID
	AND GroupID = @GroupID
	and IsDeleted = 0)

	SELECT @AssignmentsID = @@IDENTITY	
	
	--Only do this if they are not already assigned to the checklist	
	IF @AssignmentsID is not null 
	BEGIN

		SELECT Distinct @ActiveChecklistID = MIN(b.ID)
		FROM QCheck_ActiveChecklists b
		LEFT OUTER JOIN
			QCheck_ActiveAssignments newassign
		on
			newassign.AssignmentsID = @AssignmentsID AND newassign.ActiveChecklistID = b.ID--a.ActiveChecklistID
		WHERE 
			newassign.ID is null
		AND
			b.InstanceID = @InstanceID
		AND
			b.CompletedDate is null

		--Select @ActiveChecklistID
		
		INSERT INTO QCheck_ActiveAssignments
		SELECT Distinct b.ID, @AssignmentsID--a.ActiveChecklistID, @AssignmentsID
		FROM
			QCheck_ActiveChecklists b
		LEFT OUTER JOIN
			QCheck_ActiveAssignments newassign
		on
			newassign.AssignmentsID = @AssignmentsID AND newassign.ActiveChecklistID = b.ID--a.ActiveChecklistID
		WHERE 
			newassign.ID is null
		AND
			b.InstanceID = @InstanceID
		AND
			b.CompletedDate is null
		--SELECT @ActiveAssignments = @@rowcount

		/*Notify the assignee*/
		SELECT 
			@checklistName = b.[Name]
		FROM
			QCheck_ChecklistInstances a
		INNER JOIN
			QCheck_Checklists b
		   ON
			a.ChecklistID = b.[ID]
		WHERE
			a.[ID] = @InstanceID

		
		DECLARE @SendEmail bit
		SET @SendEmail = 1
		
		SELECT @SendEmail = 0
		FROM QCheck_GroupMembership gm
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		WHERE gm.GroupID = @GroupID 
		AND gm.UserID = @AssignedBy
		AND g.SingleMemberGroup = 1

		if @SendEmail =1 and @Email = 1
			exec QCheck_AssignedEmail_AddToQueue @GroupID, @AssignedBy, @checklistName, @InstanceID
		
		exec QCheck_InstanceChangeAlert @InstanceID, 'Assignment', 'Add'
	END

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddAssignedTo_Temp]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create                                                 PROCEDURE [dbo].[QCheck_AddAssignedTo_Temp](
	@InstanceID INT,
	@GroupID	int,
	@AssignedBy 	int = 50
)
 AS

BEGIN

	SET NOCOUNT ON
	DECLARE @AssignmentsID int
	DECLARE @ScheduleID int
	DECLARE @ActiveChecklistID int
	DECLARE @startDate datetime
	DECLARE @dueDate datetime
	DECLARE @nextStart datetime
	DECLARE @checklistName varchar(500)
	DECLARE @relativeStart datetime
	DECLARE @ActiveAssignments int
	DECLARE @Now datetime

	--Create the assignment
	INSERT INTO
		QCheck_Assignments
	([InstanceID],  [GroupID])
	SELECT @InstanceID, @GroupID
	WHERE NOT EXISTS
	(SELECT [ID] FROM QCheck_Assignments
	WHERE InstanceID = @InstanceID
	AND GroupID = @GroupID
	and IsDeleted = 0)

	SELECT @AssignmentsID = @@IDENTITY	
	
	--Only do this if they are not already assigned to the checklist	
	IF @AssignmentsID is not null 
	BEGIN
		
		INSERT INTO QCheck_ActiveAssignments
		SELECT Distinct b.ID, @AssignmentsID--a.ActiveChecklistID, @AssignmentsID
		FROM
			QCheck_ActiveChecklists b
		LEFT OUTER JOIN
			QCheck_ActiveAssignments newassign
		on
			newassign.AssignmentsID = @AssignmentsID AND newassign.ActiveChecklistID = b.ID--a.ActiveChecklistID
		WHERE 
			newassign.ID is null
		AND
			b.InstanceID = @InstanceID
		AND
			b.CompletedDate is null
		--SELECT @ActiveAssignments = @@rowcount
	END

	SET NOCOUNT OFF

END






































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddAssignedToByActiveChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


-- This stored procedure will Assign a member to a checklist
-- InstanceID is the instance being assigned to
-- AssignedTo is the member being assigned
-- AssignedBy is the member who assigned the checklist out
CREATE                                                 PROCEDURE [dbo].[QCheck_AddAssignedToByActiveChecklist]
(
	@ActiveChecklistID INT,
	@GroupID	int,
	@AssignedBy 	int,
	@Email		bit = 1
)
 AS
BEGIN
	SET NOCOUNT ON
	DECLARE @AssignmentsID int
	DECLARE @ScheduleID int
	--DECLARE @ActiveChecklistID int
	DECLARE @startDate datetime
	DECLARE @dueDate datetime
	DECLARE @nextStart datetime
	DECLARE @checklistName varchar(500)
	DECLARE @relativeStart datetime
	DECLARE @ActiveAssignments int
	DECLARE @Now datetime
	DECLARE @InstanceID int

	SELECT @InstanceID = InstanceID
	FROM QCheck_ActiveChecklists
	WHERE ID = @ActiveChecklistID

	--Create the assignment
	INSERT INTO
		QCheck_Assignments
	([InstanceID],  [GroupID])
	SELECT @InstanceID, @GroupID
	WHERE NOT EXISTS
	(SELECT [ID] FROM QCheck_Assignments
	WHERE InstanceID = @InstanceID
	AND GroupID = @GroupID
	and IsDeleted = 0)
	SELECT @AssignmentsID = @@IDENTITY	
	
	--Only do this if they are not already assigned to the checklist	
	IF @AssignmentsID is not null 
	BEGIN
		
		INSERT INTO QCheck_ActiveAssignments
		SELECT Distinct b.ID, @AssignmentsID--a.ActiveChecklistID, @AssignmentsID
		FROM
			QCheck_ActiveChecklists b
		LEFT OUTER JOIN
			QCheck_ActiveAssignments newassign
		on
			newassign.AssignmentsID = @AssignmentsID AND newassign.ActiveChecklistID = b.ID--a.ActiveChecklistID
		WHERE 
			newassign.ID is null
		AND
			b.InstanceID = @InstanceID
		AND
			b.CompletedDate is null
		--SELECT @ActiveAssignments = @@rowcount
		/*Notify the assignee*/
		SELECT 
			@checklistName = b.[Name]
		FROM
			QCheck_ChecklistInstances a
		INNER JOIN
			QCheck_Checklists b
		   ON
			a.ChecklistID = b.[ID]
		WHERE
			a.[ID] = @InstanceID
		
		DECLARE @SendEmail bit
		SET @SendEmail = 1
		
		SELECT @SendEmail = 0
		FROM QCheck_GroupMembership gm
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		WHERE gm.GroupID = @GroupID 
		AND gm.UserID = @AssignedBy
		AND g.SingleMemberGroup = 1
		if @SendEmail =1 and @Email = 1
			exec QCheck_AssignedEmail_AddToQueue @GroupID, @AssignedBy, @checklistName, @InstanceID
		
		exec QCheck_InstanceChangeAlert @InstanceID, 'Assignment', 'Add'
	END
	SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [dbo].[Qcheck_AddComplexTaskToPriorities]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[Qcheck_AddComplexTaskToPriorities] 
	@userID int,
	@instanceId int
AS
BEGIN
DECLARE @GroupID int
		SELECT @GroupID = ID
		FROM QCheck_Groups
		WHERE Owner = @userID
		AND SingleMemberGroup = 1
	Declare @AssignedToUserID int=(select UserID From QCheck_GroupMembership where GroupID=@GroupID)--added by venkat 04/20/2017
	Declare @ActiveCheckListId int=(select ID from QCheck_ActiveChecklists_All where InstanceID=@instanceId)
	exec PriorityList_AddTask @UserID=@AssignedToUserID,@ActiveChecklistID=@ActiveCheckListId
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddGroup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                       PROCEDURE [dbo].[QCheck_AddGroup]
	@UserID int,
	@Name varchar(50)
 AS

BEGIN

	SET NOCOUNT ON
	

		Insert into QCheck_Groups (Name, Owner)
		select @Name, @UserID
		WHERE NOT EXISTS
			(SELECT 1 FROM QCheck_Groups WHERE Name = @Name)


	SET NOCOUNT OFF

End
































GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddGroupUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO












CREATE                         PROCEDURE [dbo].[QCheck_AddGroupUser]
	@UserID int,
	@GroupID int
 AS

BEGIN

	SET NOCOUNT ON

		Insert Into QCheck_GroupMembership (GroupID, UserID)
		SELECT @GroupID, @UserID
		WHERE NOT EXISTS
			(SELECT 1 FROM QCheck_GroupMembership
			WHERE GroupID = @GroupID
			AND UserID = @UserID)
		
		EXEC QCheck_GroupEmail 'added', @GroupID, @UserID

	SET NOCOUNT OFF

End












GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddInstanceTaskType]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                PROCEDURE [dbo].[QCheck_AddInstanceTaskType](
	@InstanceID int,
	@TaskType int,
	@Priority int = 1,
	@ID int output
)
 AS

BEGIN
	DECLARE @ReportID int

	SELECT @ReportID = ReportID FROM QStatus_TaskTypes
	WHERE ID = @TaskType
	
	SELECT @ID = ID
	FROM QStatus_InstanceTaskType
	WHERE InstanceID = @InstanceID
	AND
		TaskType IN
	(SELECT ID FROM QStatus_TaskTypes
	WHERE ReportID = @ReportID)
		
	IF @ID IS NOT NULL 
	BEGIN
		EXEC QCheck_AddActiveTaskType @ID, @TaskType
	END
	ELSE
		BEGIN
	
		
		Insert INTO QStatus_InstanceTaskType
		(InstanceID, TaskType)
		SELECT @InstanceID, @TaskType
		WHERE NOT EXISTS
			(SELECT ID FROM QStatus_InstanceTaskType
			WHERE InstanceID = @InstanceID
			AND TaskType = @TaskType)
			
		SELECT @ID = scope_identity()
	
		
		INSERT INTO QStatus_ActiveChecklistTaskType
		(ActiveChecklistID, TaskType, Priority)
		SELECT ID, @TaskType, @Priority
		FROM
			QCheck_ActiveChecklists
		WHERE
			instanceID = @InstanceID
		AND ID NOT IN
		(SELECT ActiveChecklistID FROM QStatus_ActiveChecklistTaskType
		WHERE TaskType = @TaskType)

		if @@RowCount > 0 
		BEGIN
			
			UPDATE QStatus_Report
			SET LastReportDate = GetDate()
			WHERE ID IN
				(SELECT tt.ReportID
				FROM QStatus_TaskTypes tt
				WHERE ID = @TaskType)
		END
	END
	
	EXEC QCheck_RefreshCachedReportsByReportId @ReportID
	
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddInstanceTaskTypeOutput]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE                PROCEDURE [dbo].[QCheck_AddInstanceTaskTypeOutput]
(
	@InstanceID int,
	@TaskType int,
	@acId int OUTPUT
)
 AS
BEGIN
	DECLARE @Priority int
	DECLARE @ID int
	DECLARE @ReportID int

	SET @Priority = 1

	SELECT @ReportID = ReportID FROM QStatus_TaskTypes
	WHERE ID = @TaskType
	
	SELECT @ID = ID
	FROM QStatus_InstanceTaskType
	WHERE InstanceID = @InstanceID
	AND
		TaskType IN
	(SELECT ID FROM QStatus_TaskTypes
	WHERE ReportID = @ReportID)
		
	IF @ID IS NOT NULL 
	BEGIN
		EXEC QCheck_AddActiveTaskType @ID, @TaskType
	END
	ELSE
		BEGIN
	
		Insert INTO QStatus_InstanceTaskType
		(InstanceID, TaskType)
		SELECT @InstanceID, @TaskType
		WHERE NOT EXISTS
			(SELECT ID FROM QStatus_InstanceTaskType
			WHERE InstanceID = @InstanceID
			AND TaskType = @TaskType)
	
		
		INSERT INTO QStatus_ActiveChecklistTaskType
		(ActiveChecklistID, TaskType, Priority)
		SELECT ID, @TaskType, @Priority
		FROM
			QCheck_ActiveChecklists
		WHERE
			instanceID = @InstanceID
		AND ID NOT IN
		(SELECT ActiveChecklistID FROM QStatus_ActiveChecklistTaskType
		WHERE TaskType = @TaskType)
		if @@RowCount > 0 
		BEGIN
			
			UPDATE QStatus_Report
			SET LastReportDate = GetDate()
			WHERE ID IN
				(SELECT tt.ReportID
				FROM QStatus_TaskTypes tt
				WHERE ID = @TaskType)
		END
	END

	SELECT @acId = ID
	FROM
		QCheck_ActiveChecklists
	WHERE
		instanceID = @InstanceID	
		
	UPDATE QStatus_Report SET IsDirty = 1 WHERE ID = @ReportID
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddManager]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                PROCEDURE [dbo].[QCheck_AddManager] (
	@GroupID Int,
	@ChecklistID Int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	UPDATE QCheck_ChecklistManagers
	SET IsDeleted = 0
	WHERE
		IsDeleted = 1
	AND
		ManagerGroupID = @GroupID
	AND
		ChecklistID = @ChecklistID
	
	INSERT INTO QCheck_ChecklistManagers
	(ChecklistID, ManagerGroupID)
	SELECT @ChecklistID, @GroupID
	WHERE NOT EXISTS
	(
	SELECT ID FROM QCheck_ChecklistManagers
	WHERE
		ManagerGroupID = @GroupID
	AND
		ChecklistID = @ChecklistID
	)

	SET NOCOUNT OFF

END































GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddReminder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- This stored procedure will update a schedule for a specified instance


CREATE              PROCEDURE [dbo].[QCheck_AddReminder](
	@InstanceID INT,
	@nagBeforeDays int,
	@nagTime int

)
 AS

BEGIN

	SET NOCOUNT ON
	
	Insert Into QCheck_Alerts
	(InstanceID, DaysBefore, AlertTime, AlertType)
	Values
	(@InstanceID, @nagBeforeDays, @nagTime, 'Reminder')


	SET NOCOUNT OFF

END
























GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddSubFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                                      PROCEDURE [dbo].[QCheck_AddSubFolder](
	@UserID int,
	@FolderID int,
	@NewID int output
)
 AS

BEGIN

	SET NOCOUNT ON
	

	INSERT INTO QCheck_Folders
	(UserID, FolderName, ParentFolder)
	VALUES
	(@UserID, 'New Folder', @FolderID)

	SELECT @NewID = SCOPE_IDENTITY( )
	
	SET NOCOUNT OFF

END















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddSuggestion]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_AddSuggestion]
	@Suggestion varchar(8000),
	@UserID int
 AS
BEGIN

	SET NOCOUNT ON

	DECLARE @mailFrom VARCHAR(100)
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)

	DECLARE @DisplayOrder int
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	SELECT @DisplayOrder = max(DisplayOrder) + 1
	FROM
		QCheck_Suggestions

	SELECT @DisplayOrder = IsNull(@DisplayOrder,0)
	
	IF LEN(LTRIM(RTRIM(@Suggestion))) > 0 BEGIN

		INSERT INTO Qcheck_Suggestions
		(Suggestion, UserID, DisplayOrder)
		VALUES
		(@Suggestion, @UserID, @DisplayOrder)
	
		SELECT @mailFrom = email
		FROM
			QCheck_users
		WHERE
			ID = @UserID
	
		SELECT @mailFrom = @FromAddress
	
		SELECT @AppURL = a.AppURL
		FROM
			QCheck_AppSettings a
		INNER JOIN
			QCheck_Users u
		ON
			a.ID = u.App
		AND
			u.ID = @UserID
			
		SET @mailTo = @DeveloperAddress
		--SET @mailTo = 'kcroft@acmewidget.com'
		SET @mailSubject = 'Suggestion'
		SET @mailType = 'text/html'
	
		SET @mailBody = @Suggestion + '<br><a href='''+@AppURL+'/Suggestion.aspx?admin=1''>Suggestions</a>'
		EXEC XPSendEmail
					@FROM       = @mailFrom,
				    @TO         = @mailTo,
				    @subject    = @mailSubject,
				    @message    = @mailBody,
				    @type       = @mailType,
				    @server     = @mailServer
				    
	END

	SET NOCOUNT OFF

END








































GO
/****** Object:  StoredProcedure [dbo].[QCheck_AddUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                 PROCEDURE [dbo].[QCheck_AddUser]
(
	@Login varchar(50),
	@Name varchar(50),
	@Email varchar(50),
	@Password varchar(50),
	@Admin	bit,
	@Beta bit = 0
)
AS
BEGIN
	SET NOCOUNT ON

		Insert Into QCheck_Users (ShortName, FullName, Email, Password, Admin, Beta, empID)
		SELECT @Login, @Name, @Email, @Password, @Admin, @Beta, -1
		WHERE NOT EXISTS
		(SELECT ID FROM QCheck_Users where ShortName = @Login)

		insert into QCheck_Groups
		(name, owner, singlemembergroup)
		select u.fullname, u.ID, 1
		FROM QCheck_Users u
		LEFT OUTER JOIN QCheck_Groups g
		on u.id = g.owner
		and g.singlemembergroup = 1
		where g.id is null
		and u.isdeleted = 0
		
		insert into qcheck_groupmembership (UserID, GroupID)
		select distinct u.id, g.id
		from qcheck_users u
		inner join qcheck_groups g
		on u.id = g.owner
		and g.singlemembergroup = 1
		left outer join qcheck_groupmembership gm
		on u.id = gm.UserID
		and gm.groupid = g.id
		WHERE gm.id is null
		and u.isdeleted = 0
		
		exec QStatus_DefaultStatus_All

		exec QCheck_HandlePatternDefaults

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AlertEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_AlertEmail] AS

BEGIN

	SET DEADLOCK_PRIORITY HIGH
	
	SET NOCOUNT ON

	UPDATE QCheck_Alerts
	SET alerttime = 0.25
	WHERE 
		alerttype = 'Hours'
		AND alerttime < 0.25


	EXEC QCheck_ActivateFutureInstancesForReminders

	DECLARE @Alertee INT
		
	-- set hasnaggeddue = 2 for those in progress
	UPDATE QCheck_ActiveChecklists
	SET HasNaggedDue = 2
	WHERE 
		DueTime <= getDate()
		AND HasNaggedDue = 0
		AND CompletedDate is null



/* -- 11/16/2012 dalvarado - removed per GPR
	-- set hasnaggeddue = 3 for things that went overdue 24, 48, 72, 96, etc. hours ago
	UPDATE QCheck_ActiveChecklists
	SET HasNaggedDue = 3
	WHERE 
		DueTime <= getDate()
		AND HasNaggedDue = 1
		AND DATEPART(HOUR, DueTime) = DATEPART(HOUR, GETDATE())
		AND ABS(DATEPART(MINUTE, DueTime) - DATEPART(MINUTE, GETDATE())) <= 20
		AND CompletedDate is null
*/

	-- Make sure there is an active alert row
	INSERT INTO QCheck_ActiveAlerts (
		AlertID, 
		ActiveChecklistID
	)
		SELECT DISTINCT 
			a.ID, c.ID
		FROM
			QCheck_Alerts a
			INNER JOIN QCheck_ChecklistInstances b
				ON a.InstanceID = b.ID
				AND b.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists c
				ON b.ID = c.InstanceID
				AND c.CompletedDate IS NULL
			INNER JOIN QCheck_Checklists d
				ON b.ChecklistID = d.[ID]
				AND d.IsDeleted = 0
			LEFT OUTER JOIN QCheck_ActiveAlerts aa
				ON aa.AlertID = a.ID
				AND aa.ActiveChecklistID = c.ID
		WHERE
			a.IsDeleted = 0
			AND (
				a.AlertType = 'Overdue'
				OR a.AlertType = 'Hours'
				OR a.AlertType = 'Custom'
				OR a.AlertType = 'Reminder'
			)
			AND aa.ID Is NULL
			
	Truncate table QCheck_AlertEmailWork

	INSERT INTO QCheck_AlertEmailWork (
		[ID],
		ActiveChecklistID,
		ChecklistName,
		Alertee,
		AlertText,
		AlertType,
		DueTime,
		CheckListId --added by venkat 04/24/2018
	)
		SELECT DISTINCT
			aa.[ID], 
			c.[ID], 
			d.[Name], 
			u.[ID] AS Alertee, 
			ISNULL(a.AlertText,''), 
			a.AlertType,
			c.DueTime,
			d.ID --added by venkat 04/24/2018
		FROM 
			QCheck_Alerts a
			INNER JOIN QCheck_ActiveAlerts aa
				ON aa.AlertID = a.ID
			INNER JOIN QCheck_ChecklistInstances b
				ON a.InstanceID = b.ID
				AND b.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists c
				ON b.ID = c.InstanceID
				AND c.CompletedDate IS NULL
				AND (
					c.DueTime <= getDate() 
					OR NOT(
						AlertType = 'Overdue' 
						OR AlertType='Hours'
					)
				)
				AND aa.ActiveChecklistID = c.ID
			INNER JOIN QCheck_ActiveAssignments aasn
				ON aasn.ActiveChecklistID = c.ID
			INNER JOIN QCheck_Assignments asn
				ON asn.ID = aasn.AssignmentsID
				AND asn.IsDeleted = 0
				AND asn.InstanceID = b.ID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = a.AlerteeGroupID
				OR (
					a.AlerteeGroupID IS NULL 
					AND gm.GroupID = asn.GroupID
				)
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_Checklists d
				ON b.ChecklistID = d.[ID]
				AND d.IsDeleted = 0
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID 
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do 
				ON u.ID = do.UserID
			LEFT OUTER JOIN QCheck_AlertExceptions ae
				ON ae.ActiveAlertID = aa.ID
				AND ae.UserID = u.ID
				AND ae.IsActive = 1				
		WHERE
			(
				(
					(a.AlertType = 'Reminder' or a.AlertType = 'Custom')
					AND a.DaysBefore = DateDiff(day, getDate(), c.DueTime)
					AND a.alertTime <= ((datepart(hh,getDate()) * 60.0) + datepart(mi,getDate()))/60.0
					AND aa.SentTime IS NULL
					AND a.alertTime >= 0
				)
				-- 2/12/2014 dalvarado - handles reminder for X hours before due
				OR (
					a.AlertType = 'Reminder'
					--AND DATEDIFF(HOUR, c.DueTime, GETDATE()) >= a.AlertTime
					AND DATEDIFF(MINUTE, c.DueTime, GETDATE()) >= a.AlertTime * 60
					AND aa.SentTime IS NULL
					AND a.AlertTime < 0
				)
				OR (
					CASE
						WHEN  a.AlertType = 'Hours'
						-- 1/7/2014 dalvarado - fixing a bug where if you set an alert to every 30 minutes after a task goes overdue, it doesn't
						-- fire on the first 30 minute interval.  So if a task is due at 8:00am and it alerts every 0.5 hours after it's due, you'll
						-- get the initial 8:00 am overdue alert, then nothing at 8:30, then alerts at 9:00, 9:30, 10:00, 10:30, etc.  Changing the
						-- line below to check minutes instead of hours fixes that.
						--AND DateDiff(hour, getDate(), c.DueTime) < 0
						AND DateDiff(minute, getDate(), c.DueTime) < -10
						AND ((DateDiff(mi, c.DueTime, getDate())/60.0)/a.AlertTime - CAST((DateDiff(mi, c.DueTime, getDate())/60.0)/a.AlertTime as int)) *  a.AlertTime < 0.1
						THEN 1
					ELSE 0
					END = 1
				)
				OR (
					a.AlertType = 'Overdue'
					AND aa.SentTime IS NULL
					--AND C.ID not in(select ActiveChecklistId from [fn_GetOverdueTasks_SingleAssigneeController](null,null))--added by venkat 03/13/2018
				)
			)
			AND a.IsDeleted = 0
			-- dont email if the user is on the Do-Not-Email list
			AND do.UserID is null
			-- don't e-mail if there is an exception for this alert and user
			AND ae.ID IS NULL
			

		UNION

		-- Overdue alerts to assignees
		SELECT DISTINCT 
			null as ActiveAlertID, 
			a.[ID], 
			f.[Name], 
			u.[ID], 
			'', 
			'Overdue',
			a.DueTime,
			f.ID --added by venkat 04/24/2018
		FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ActiveAssignments b
				ON b.ActiveChecklistID = a.ID
			INNER JOIN QCheck_Assignments c
				ON b.AssignmentsID = c.ID
				AND c.IsDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = c.GroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID 
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do 
				ON u.ID = do.UserID				
		WHERE
			a.HasNaggedDue IN (2, 3)
			-- dont email if this is set
			AND do.UserID is null

		UNION

		-- Overdue alerts to controllers
		SELECT DISTINCT 
			null as ActiveAlertID,
			a.[ID],
			f.[Name],
			u.[ID],
			'',
			'Overdue',
			a.DueTime,
			f.Id --added by venkat 04/24/2018
		FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_ChecklistManagers cm
				ON f.[ID] = cm.ChecklistID AND cm.isDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = cm.ManagerGroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID 
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do
				ON u.ID = do.UserID
		WHERE
			a.HasNaggedDue IN (2, 3)
			-- dont email if this is set
			AND do.UserID is null
			--AND a.ID not in(select ActiveChecklistId from [fn_GetOverdueTasks_SingleAssigneeController](null,null))--added by venkat 03/15/2018--removed by venkat 04/24/2018 as per GPR


	DECLARE ALERTEECURS CURSOR FOR 
		SELECT DISTINCT w.Alertee
		FROM QCheck_AlertEmailWork w
		INNER JOIN QCheck_users u
			on u.id = w.Alertee
			and u.ShortName <> 'graynor' --remove GPR, email 12/24/19



-- #DEBUG BEGIN
--WHERE Alertee = 24
-- #DEBUG END

	OPEN ALERTEECURS

	FETCH NEXT FROM ALERTEECURS INTO @Alertee
	WHILE @@FETCH_STATUS = 0 BEGIN

		EXEC QCheck_AlertEmail_SingleUser @Alertee

		UPDATE QCheck_ActiveAlerts
		SET SentTime = getDate()
		WHERE [ID] in (
			SELECT ID FROM QCheck_AlertEmailWork
			WHERE Alertee = @Alertee
		)

		FETCH NEXT FROM ALERTEECURS INTO @Alertee

	END

	CLOSE ALERTEECURS
	DEALLOCATE ALERTEECURS
	
	-- clean up
	UPDATE QCheck_ActiveChecklists
	SET HasNaggedDue = 1
	WHERE HasNaggedDue IN (2, 3)

	SET NOCOUNT OFF

END






GO
/****** Object:  StoredProcedure [dbo].[QCheck_AlertEmail_SingleUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_AlertEmail_SingleUser](
	@Alertee int
) AS

BEGIN
	SET NOCOUNT ON

	
	DECLARE @cmd VARCHAR(500)
	DECLARE @mail_to VARCHAR(500)
	DECLARE @mail_from VARCHAR(500)
	DECLARE @mail_subject VARCHAR(500)
	DECLARE @mail_sub_subject varchar(250)
	DECLARE @ActiveChecklistID int
	DECLARE @AlertType varchar(50)
	DECLARE @ChecklistName varchar(500)
	DECLARE @fromname VARCHAR(100)
	DECLARE @i int
	SET @i = 0
	SET @mail_sub_subject = ''

	SELECT @mail_to = Email FROM QCheck_Users where ID = @Alertee
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress FROM QCheck_AppSettings WHERE ID = 1

	SET @mail_from = REPLACE(@FromAddress, @AppName, @AppName + '-alert')
	SET @fromname = @Appname + '-Alert'

	DECLARE @cnt int
	SELECT @cnt = count(*) FROM QCheck_AlertEmailWork
	WHERE Alertee = @Alertee

	SET @mail_subject = ''

	IF @cnt > 2 
		BEGIN
			SET @mail_subject = 'Alerts'
		END
	ELSE
		BEGIN
			DECLARE SUBJCURS CURSOR FOR
			SELECT ActiveChecklistID, AlertType, ChecklistName 
			FROM QCheck_AlertEmailWork
			WHERE Alertee = @Alertee

			
			OPEN SUBJCURS
	
			FETCH NEXT FROM SUBJCURS INTO @ActiveChecklistID, @AlertType, @ChecklistName
			WHILE @@FETCH_STATUS = 0 BEGIN
				
				IF @i = 1 
					SET  @mail_sub_subject = @mail_sub_subject + ', '


				IF @AlertType = 'Reminder'
				BEGIN

					SELECT @mail_sub_subject = @mail_sub_subject + 'Incomplete - ' + e.txt
					FROM(
						SELECT 
							--max(d.text) as txt
							max(c.name) as txt
						FROM
							QCheck_ActiveChecklists a
						INNER JOIN
							QCheck_ChecklistInstances b
						ON	
							a.InstanceID = b.ID
						INNER JOIN
							QCheck_Checklists c
						ON
							b.ChecklistID = c.ID
						INNER JOIN
							QCheck_Items d
						ON
							d.ChecklistID = c.ID
						AND
							d.ItemTypeID = 1
						WHERE
							a.ID = @ActiveChecklistID
						GROUP BY
							a.ID
						HAVING
							count(d.ID) = 1
					) e
				
					IF @@Rowcount = 0 
						SET @mail_sub_subject = @mail_sub_subject + 'Incomplete  - ' + @ChecklistName
			
		
					END
					IF @AlertType = 'Overdue' OR @AlertType = 'Hours' SET @mail_sub_subject = @mail_sub_subject + 'OVERDUE - ' + @ChecklistName 
					IF @AlertType = 'Custom' SET @mail_sub_subject = @mail_sub_subject + ' Alert - ' + @ChecklistName

				SET @i = 1
					
				FETCH NEXT FROM SUBJCURS INTO  @ActiveChecklistID, @AlertType, @ChecklistName
			END
			CLOSE SUBJCURS
			DEALLOCATE SUBJCURS			

			SET @mail_subject = @mail_subject + @mail_sub_subject
	
		END


	SET @mail_subject = replace(@mail_subject,'"','')

	IF @cnt > 0 BEGIN

		declare @alerts table (id int identity(1,1), html varchar(max))
		insert into @alerts exec QCheck_AlertEmail_SingleUser_HTML @Alertee
		declare @alerthtml varchar(max), @onerow varchar(max), @alertid int
		while exists (select 1 from @alerts)
		begin
			select top 1 @alertid = id from @alerts order by id asc
			select @onerow = html from @alerts where id = @alertid
			select @alerthtml = isnull(@alerthtml, '') + isnull(@onerow, '') 
			delete from @alerts where id = @alertid
		end
		
		exec [dbo].[xp_smtp_sendmail]
			@to = @mail_to,
			@from = @mail_from,
			@from_name = @fromname,
			@subject = @mail_subject,
			@message = @alerthtml

	END
	


	SET NOCOUNT OFF
END



GO
/****** Object:  StoredProcedure [dbo].[QCheck_AlertEmail_SingleUser_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_AlertEmail_SingleUser_HTML]
	@Alertee int
AS

BEGIN
	SET NOCOUNT ON
	
	
	DECLARE @ChecklistID int
	DECLARE @InstanceID int
	DECLARE @AppURL varchar(50),
	@ExtURL varchar(50),
	@ImagesURL varchar(50)
	DECLARE @Outside bit = 0

	SELECT @appURL = AppURL, @ExtURL = ExternalURL, @ImagesURL = ImagesURL
	FROM QCheck_AppSettings a
	INNER JOIN QCheck_Users u
	ON a.ID = u.App
	AND u.ID = @Alertee

	SELECT @Outside = 1 FROM QCheck_OutsideUsers WHERE UserID = @Alertee

	DECLARE @tmpBody VARCHAR(max)
	DECLARE @tmpAssigned VARCHAR(max)
	DECLARE @tmpControlled VARCHAR(max)
	DECLARE @DueTime DATETIME
	DECLARE @controllers VARCHAR(1000)
	DECLARE @supervisor varchar(50)
	DECLARE @assignees VARCHAR(1000)
	DECLARE @assigneeswithlinks VARCHAR(1000)
	DECLARE @assignee VARCHAR(50)
	DECLARE @assigneeID int
	DECLARE @isAssigned bit
	DECLARE @Reports VARCHAR(5000)

	DECLARE @ActiveChecklistID int,
	@ID int,
	@ChecklistName varchar(500),
	@AlertText varchar(max),
	@AlertType VARCHAR(10)
	
	 DECLARE @GPRUserID INT--added by venkat 04/24/2018
	SELECT @GPRUserID = GPRUserID FROM QCheck_AppSettings WHERE ID = 1

	declare @pendingExtensionRequests table
	(
	  checklistId int,
	  instanceId int,
	  extensionRequestDate datetime,
	  NewDueTime datetime
	)
	
	Insert into @pendingExtensionRequests(checklistId,instanceId,extensionRequestDate,NewDueTime)
	SELECT 
	chk.ID 
	,chk.InstanceID
	,CR.RequestDate
	,chk.DueTime
	
	FROM 
		QCheck_Approval_ChangeRequests CR
		inner join (
			SELECT 
				ac.ChangeRequestID, c.id, c.name, ci.ID AS InstanceID,AC.DueTime
			FROM  
				QCheck_Approval_ActiveChecklists AC
				INNER JOIN QCheck_ChecklistInstances CI
					ON AC.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
	
			/*UNION
			
			SELECT
				A.ChangeRequestID, C.[ID], c.name, ci.ID AS InstanceID,''
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_ChecklistInstances CI
					ON A.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]*/
									
			UNION 
	
			/*SELECT
				I.ChangeRequestID,  C.[ID], c.name, -1 AS InstanceID,''
			FROM 
				QCheck_Approval_Items I
				INNER JOIN QCheck_Checklists C
					ON I.ChecklistID = C.[ID]*/
			SELECT
				I.ChangeRequestID,  I.ChecklistID, I.Name, -1 AS InstanceID,''
			FROM 
				QCheck_Approval_Checklists I
			where I.IsDeleted=1
		
		) AS chk
			ON chk.ChangeRequestID = cr.id
		INNER JOIN QCheck_Users RU
			ON CR.RequestingUser = RU.[ID]
	WHERE
		--CR.IsActive = 1
		--AND CR.Approved = 0 
		--AND 
		CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		
		
	ORDER BY
		RequestDate


	 Declare @startDate datetime=DATEADD(minute,-25,getdate())
     Declare @endDate datetime=Getdate()
     declare @overdueTasks table--added by venkat 04/24/2018
	(
	  ActiveChecklistId int
	 
	)
	Insert into @overdueTasks(ActiveChecklistId)--added by venkat 04/24/2018
	select ActiveCheckListId from [fn_GetOverdueTasks_MultipleAssignees](@startDate,@endDate)


	-- table that will hold the html
	
	DECLARE @html_output TABLE (
		seq INT,
		row_html VARCHAR(max)
	)

	DECLARE @seqAssigned INT = 11
	DECLARE @seqControlled INT = 1001
		
	-- apply the style sheet and header information
		INSERT INTO @html_output (row_html) 
				SELECT
			'<html><head><style>TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;} .hide {display:none} TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style></head><body>'
		
		SET @tmpAssigned = ''
		SET @tmpControlled = ''

	DECLARE ALERTHTMLCURS CURSOR
	FOR
	SELECT ID, ActiveChecklistID, ChecklistName, AlertText, AlertType
	,CheckListId--added by venkat 04/24/2018
	FROM QCheck_AlertEmailWork
	WHERE Alertee = @Alertee
	ORDER BY DueTime

	OPEN ALERTHTMLCURS
	
		FETCH NEXT FROM ALERTHTMLCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType,@CheckListId --added by venkat 04/24/2018
		WHILE @@FETCH_STATUS = 0 BEGIN
			
			SELECT @controllers = dbo.QCheck_ManagersList(ci.ChecklistID),
				@assignees = dbo.QCheck_AssigneesList(ci.ID),
				@assigneeswithlinks = dbo.QCheck_AssigneesList_WithOverdueLinks(ci.ID, @AppURL),
				@DueTime = ac.DueTime
			FROM QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
			on ci.ID = ac.InstanceID
			WHERE ac.ID = @activeChecklistID

			SET @isAssigned = 0

			SELECT 
				@isAssigned = 1
			FROM 
				QCheck_ActiveChecklists ac
				INNER JOIN QCheck_ActiveAssignments aa
					ON aa.ActiveChecklistID = ac.ID
				INNER JOIN QCheck_Assignments a
					ON a.ID = aa.AssignmentsID
				INNER JOIN QCheck_Groups g
					ON g.ID = a.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.groupID = g.ID
					AND gm.UserID = @Alertee
					AND ac.ID = @ActiveChecklistID

			SELECT @Reports = dbo.QStatus_ActiveChecklistReportLinks(@ActiveChecklistID, @Alertee, '<br/>')
			IF LEN(@Reports) = 0 SET @Reports = '&nbsp;'
			 Declare @chargeStatus varchar(500)--added by venkat 04/24/2018
				 set @chargeStatus=CASE WHEN @Outside = 1 
										THEN 'Not Charged'
								   when Exists(select 1 from @overdueTasks where ActiveChecklistId=@ActiveChecklistID)
										Then 'Will be Charged-$5'
								   when Exists (select 1 from @pendingExtensionRequests where checklistId=@ChecklistId  and extensionRequestDate<=@DueTime and (NewDueTime>=@DueTime )) --added by venkat 04/23/2018
										Then 'Extension Awaiting Approval'
			                       Else 
										'Not Charged'
								   End

			IF @IsAssigned = 1 BEGIN
			
				SET @tmpAssigned = @tmpAssigned + '<tr><td><span class="hide">Task: </span><a href="'+@ExtURL+'/ManageTasks.aspx?checklistId='+CAST(@ChecklistID as varchar(20)) + '">'+@ChecklistName+'</a><span class="hide"><br><br></span></td>'
				IF @AlertType = 'Reminder' SET @AlertText = 'Reminder'
				IF @AlertType = 'Overdue' or @AlertType = 'Hours' SET @AlertText = 'Overdue' 
				
				SET @tmpAssigned = @tmpAssigned + '<td><span class="hide">Alert Type: </span>'+@AlertText+'<span class="hide"><br><br></span></td>'
				SET @tmpAssigned = @tmpAssigned + '<td><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=0&daily=' + convert(char(1), dbo.QCheck_IsDailyChecklist(@ActiveChecklistID)) + '">Complete</a><span class="hide"><br><br></span></td>'
				SET @tmpAssigned = @tmpAssigned + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=1">N/A&nbsp;-&nbsp;Close&nbsp;Task</a><span class="hide"><br><br></span></td>'
				SET @tmpAssigned = @tmpAssigned + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/ExtensionRequest.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'">Extend&nbsp;Deadline&nbsp;2&nbsp;Days</a><span class="hide"><br><br></span></td>'
				
				SET @tmpAssigned = @tmpAssigned + 
					'<td><span class="hide">Due Date: </span>'+CAST(@DueTime as varchar(20))+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Reports: </span>'+@reports+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Assigned To: </span>'+@assignees+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Controllers: </span>'+@controllers+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Charge Status: </span>'+@chargeStatus+'<span class="hide"><br><br></span></td></tr>'--added by venkat 04/24/2018
					
				INSERT INTO @html_output (seq, row_html) VALUES (@seqAssigned, @tmpAssigned)
				SET @tmpAssigned = ''
				SET @seqAssigned = @seqAssigned + 1
	
			END ELSE BEGIN
			
				SET @tmpControlled = @tmpControlled + '<tr><td><span class="hide">Task: </span><a href="'+@ExtURL+'/ManageTasks.aspx?checklistId='+CAST(@ChecklistID as varchar(20)) + '">'+@ChecklistName+'</a><span class="hide"><br><br></span></td>'
				IF @AlertType = 'Reminder' SET @AlertText = 'Reminder'
				IF @AlertType = 'Overdue' or @AlertType = 'Hours' SET @AlertText = 'Overdue' 
				
				SET @tmpControlled = @tmpControlled + '<td><span class="hide">Alert Type: </span>'+@AlertText+'<span class="hide"><br><br></span></td>'
				SET @tmpControlled = @tmpControlled + '<td><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=0&daily=' + convert(char(1), dbo.QCheck_IsDailyChecklist(@ActiveChecklistID)) + '">Complete</a><span class="hide"><br><br></span></td>'
				SET @tmpControlled = @tmpControlled + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=1">N/A&nbsp;-&nbsp;Close&nbsp;Task</a><span class="hide"><br><br></span></td>'
				SET @tmpControlled = @tmpControlled + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/ExtensionRequest.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'">Extend&nbsp;Deadline&nbsp;2&nbsp;Days</a><span class="hide"><br><br></span></td>'
				
				SET @tmpControlled = @tmpControlled + 
					'<td><span class="hide">Due Date: </span>'+CAST(@DueTime as varchar(20))+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Reports: </span>'+@reports+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Assigned To: </span>'+@assigneeswithlinks+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Controllers: </span>'+@controllers+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Charge Status: </span>'+@chargeStatus+'<span class="hide"><br><br></span></td></tr>'--added by venkat 04/24/2018
					
				INSERT INTO @html_output (seq, row_html) VALUES (@seqControlled, @tmpControlled)
				SET @tmpControlled = ''
				SET @seqControlled = @seqControlled + 1

			END
			

		FETCH NEXT FROM ALERTHTMLCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType,@CheckListId --added by venkat 04/24/2018
	END
	CLOSE ALERTHTMLCURS
	DEALLOCATE ALERTHTMLCURS

	IF @seqAssigned > 11 BEGIN
		insert into @html_output (seq, row_html) values (10, '<h2>Tasks Assigned To You</h2><table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Alert</th><th>Complete</th><th style="font-size:12.0pt;width:150px;white-space:nowrap;">N/A&nbsp;-&nbsp;Close&nbsp;Task</th><th style="width:180px;white-space:nowrap;">Extension</th><th>Due</th><th>Reports</th><th>Assigned To</th><th>Controllers</th><th>Charge Status<span class="hide"><br></span></th></tr>')--added by venkat 04/26/2018
		insert into @html_output (seq, row_html) values (@seqAssigned + 1, '</table><br/><br/>')
	END

	IF @seqControlled > 1001 BEGIN
		insert into @html_output (seq, row_html) values (1000, '<h2>Alerts You Have Been Elected To Receive</h2><table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Alert</th><th>Complete</th><th style="font-size:12.0pt;width:150px;white-space:nowrap;">N/A&nbsp;-&nbsp;Close&nbsp;Task</th><th style="width:180px;white-space:nowrap;">Extension</th><th>Due</th><th>Reports</th><th>Assigned To</th><th>Controllers</th><th>Charge Status<span class="hide"><br></span></th></tr>')--added by venkat 04/17/2018
		insert into @html_output (seq, row_html) values (@seqControlled + 1, '</table><br/><br/>')
	END

	insert into @html_output (seq, row_html) values (@seqControlled + 2, '<a href="' + ISNULL(@ExtURL, '') + '">' + ISNULL(@AppURL, '') + '</a></body></html>')

	SELECT row_html FROM @html_output ORDER BY seq


	SET NOCOUNT OFF
END



GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_AddAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_AddAlert](
	@ChangeID INT,
	@InstanceID INT,
	@nagBeforeDays int = null,
	@nagTime float = null,
	@alerteegroupid int = null,
	@alertType varchar(10),
	@alertText varchar(250) = null
) AS

BEGIN

	SET NOCOUNT ON
	
	INSERT INTO QCheck_Approval_Alerts (
		ChangeRequestID,
		AlertID,
		InstanceID, 
		DaysBefore, 
		AlertTime, 
		AlerteeGroupID, 
		AlertType, 
		AlertText
	) VALUES (
		@ChangeID,
		-1,
		@InstanceID, 
		@nagBeforeDays, 
		@nagTime, 
		@AlerteeGroupID, 
		@alertType, 
		@alertText
	)

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_AddAssignedTo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_AddAssignedTo] (
	@ChangeID INT,
	@InstanceID INT,
	@GroupID int
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @AssignmentID INT

	SELECT @AssignmentID = [ID] 
	FROM QCheck_Assignments
	WHERE
		GroupID = @GroupID
		AND InstanceID = @InstanceID

	--Create the assignment
	INSERT INTO QCheck_Approval_Assignments (
		ChangeRequestID,
		AssignmentID,
		InstanceID,  
		GroupID,
		DtAssigned,
		IsDeleted
	)
		SELECT 
			@ChangeID,
			ISNULL(@AssignmentID, -1),
			@InstanceID,
			@GroupID,
			GETDATE(),
			0
		WHERE 
			NOT EXISTS (
				SELECT [ID] 
				FROM QCheck_Assignments
				WHERE 
					InstanceID = @InstanceID
					AND GroupID = @GroupID
					and IsDeleted = 0
			)
			AND NOT EXISTS (
				SELECT [ID] 
				FROM QCheck_Approval_Assignments
				WHERE 
					InstanceID = @InstanceID
					AND GroupID = @GroupID
					AND IsDeleted = 0
					AND ChangeRequestID = @ChangeID
			)	

	SELECT TOP 1 ID
	FROM QCheck_Approval_Assignments
	ORDER BY ID DESC

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_AddManager]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_AddManager] (
	@ChangeID INT,
	@GroupID INT,
	@ChecklistID INT
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @ChecklistManagerID INT

	SELECT @ChecklistManagerID = [ID] 
	FROM QCheck_ChecklistManagers
	WHERE
		ManagerGroupID = @GroupID
		AND ChecklistID = @ChecklistID
	
	INSERT INTO QCheck_Approval_ChecklistManagers (
		ChangeRequestID,
		ChecklistManagerID,
		ManagerGroupID,
		ChecklistID,
		IsDeleted
	) VALUES (
		@ChangeID,
		ISNULL(@ChecklistManagerID, -1),
		@GroupID,
		@ChecklistID,
		0
	)

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_ApplyChange]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_ApplyChange] (
	@ChangeID INT
) AS

BEGIN

	BEGIN TRAN

	DECLARE @UserID INT,
		@InstanceID INT,
		@GroupID INT,
		@ID INT,
		@FirstDueDate DATETIME,
		@LastDueDate DATETIME,
		@FreqType INT,
		@FreqInterval INT,
		@FreqRecurrance INT,
		@DueTime FLOAT,
		@BusDayBehavior INT,
		@PrevFreqType INT,
		@RowsUpdated INT,
		@Activate BIT,
		@SoftDueOffsetDays INT,
		@ApproverUserName VARCHAR(100)
	
	SELECT @UserID = cr.RequestingUser, @ApproverUserName = isnull(u.shortname, '')
	FROM QCheck_Approval_ChangeRequests cr
		LEFT OUTER JOIN QCheck_Users u
			on u.id = cr.ApprovedUser
	WHERE cr.[ID] = @ChangeID

	-- ============================================================================
	-- Active Checklists
	
	-- Needed for grading--this logs due date changes
	INSERT INTO QStatus_DueDateChanges (
		ActiveChecklistID, 
		DueDateOld, 
		UpdateDT,
		changedBy
	)
		SELECT
			C.ID,
			C.DueTime,
			GETDATE(),
			@ApproverUserName
		FROM 	
			QCheck_Approval_ActiveChecklists R
			INNER JOIN QCheck_ActiveChecklists C
				ON R.ActiveChecklistID = C.[ID]
 			INNER JOIN QCheck_Approval_ChangeRequestItems cri
	 			ON R.CRItemID = cri.[ID]
		WHERE	
			R.ChangeRequestID = @ChangeID
			AND cri.Approved = 1
			AND CONVERT(VARCHAR(10), C.DueTime, 101) <> CONVERT(VARCHAR(10), R.DueTime, 101)
	
	UPDATE 	
		QCheck_ActiveChecklists
	SET	
		DueTime =case when Getdate()>R.DueTime 
					 then dateadd(hour, datepart(hour,R.DueTime), dbo.Util_addofficedays(getdate(), 1)) 
					 else R.DueTime 
				 End
	FROM 	
		QCheck_Approval_ActiveChecklists R
		INNER JOIN QCheck_ActiveChecklists C
			ON R.ActiveChecklistID = C.[ID]
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
	WHERE	
		R.ChangeRequestID = @ChangeID
		AND cri.Approved = 1
	
	INSERT INTO QCheck_ActiveChecklists (
		InstanceID,
		DueTime,
		OrigDueTime,
		ReminderDate,
		CompletedDate,
		HasNaggedDue,
		CompletedBy
	)
		SELECT
			InstanceID,
			DueTime,
			OrigDueTime,
			ReminderDate,
			CompletedDate,
			HasNaggedDue,
			CompletedBy
		FROM
			QCheck_Approval_ActiveChecklists R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND R.ActiveChecklistID = -1
			AND cri.Approved = 1
		
	
	-- ============================================================================
	-- Alerts
	
	UPDATE 	
		QCheck_Alerts
	SET	
		InstanceID = R.InstanceID,
		DaysBefore = R.DaysBefore,
		AlertTime = R.AlertTime,
		AlertType = R.AlertType,
		AlertText = R.AlertText,
		SentTime = R.SentTime,
		IsDeleted = R.IsDeleted,
		AlerteeGroupID = R.AlerteeGroupID
	FROM	
		QCheck_Approval_Alerts R
		INNER JOIN QCheck_Alerts C
			ON R.AlertID = C.[ID]
		INNER JOIN QCheck_Approval_ChangeRequestItems cri
			ON R.CRItemID = cri.[ID]
	WHERE	
		R.ChangeRequestID = @ChangeID
		AND cri.Approved = 1
	
	INSERT INTO QCheck_Alerts (
		InstanceID,
		DaysBefore,
		AlertTime,
		AlertType,
		AlertText,
		SentTime,		
		IsDeleted,
		AlerteeGroupID
	)
		SELECT
			InstanceID,
			DaysBefore,
			AlertTime,
			AlertType,
			AlertText,
			SentTime,
			IsDeleted,
			AlerteeGroupID
		FROM
			QCheck_Approval_Alerts R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND AlertID = -1
			AND cri.Approved = 1
	
	-- ============================================================================
	-- Asignments
	
	-- Deletes
	DECLARE cAssignD CURSOR FOR 
		SELECT 
			C.[ID]
		FROM
			QCheck_Assignments C
			INNER JOIN QCheck_Approval_Assignments R
				ON C.[ID] = R.AssignmentID
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND C.IsDeleted = 0
			AND R.IsDeleted = 1
			AND cri.Approved = 1
	OPEN cAssignD
	FETCH NEXT FROM cAssignD INTO @ID
	WHILE @@FETCH_STATUS = 0 BEGIN
		EXEC QCheck_DeleteAssignedTo @ID
		FETCH NEXT FROM cAssignD INTO @ID
	END
	CLOSE cAssignD
	DEALLOCATE cAssignD
	

	-- New Assignments	
	DECLARE cAssign CURSOR FOR 
		SELECT
			InstanceID,
			GroupID
		FROM
			QCheck_Approval_Assignments R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND AssignmentID = -1
			AND cri.Approved = 1
	OPEN cAssign
	FETCH NEXT FROM cAssign INTO @InstanceID, @GroupID
	WHILE @@FETCH_STATUS = 0 BEGIN
		EXEC QCheck_AddAssignedTo @InstanceID, @GroupID, @UserID
		FETCH NEXT FROM cAssign INTO @InstanceID, @GroupID
	END
	CLOSE cAssign
	DEALLOCATE cAssign
	
	-- ============================================================================
	-- Checklist Instances
	
	UPDATE 
		QCheck_ChecklistInstances
	SET
		[Name] = R.[Name],
		ChecklistID = R.ChecklistID,
		ScheduleID = R.ScheduleID,
		IsDeleted = R.IsDeleted,
		CreatedBy = R.CreatedBy
	FROM
		QCheck_ChecklistInstances C
		INNER JOIN QCheck_Approval_ChecklistInstances R
			ON C.[ID] = R.InstanceID
		INNER JOIN QCheck_Approval_ChangeRequestItems cri
			ON R.CRItemID = cri.[ID]
	WHERE
		R.ChangeRequestID = @ChangeID
		AND cri.Approved = 1
	
	INSERT INTO QCheck_ChecklistInstances (
		[Name],
		ChecklistID,
		ScheduleID,
		IsDeleted,
		CreatedBy
	)
		SELECT
			[Name],
			ChecklistID,
			ScheduleID,
			IsDeleted,
			CreatedBy
		FROM
			QCheck_Approval_ChecklistInstances R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND InstanceID = -1
			AND cri.Approved = 1
	
	-- ============================================================================
	-- Checklist Managers
	
	UPDATE 
		QCheck_ChecklistManagers
	SET
		ManagerGroupID = R.ManagerGroupID,
		ChecklistID = R.ChecklistID,
		IsDeleted = R.IsDeleted
	FROM
		QCheck_ChecklistManagers C
		INNER JOIN QCheck_Approval_ChecklistManagers R
			ON C.[ID] = R.ChecklistManagerID
		INNER JOIN QCheck_Approval_ChangeRequestItems cri
			ON R.CRItemID = cri.[ID]
	WHERE
		R.ChangeRequestID = @ChangeID
		AND cri.Approved = 1
	
	INSERT INTO QCheck_ChecklistManagers (
		ManagerGroupID,
		ChecklistID,
		IsDeleted
	)
		SELECT
			ManagerGroupID,
			ChecklistID,
			IsDeleted
		FROM
			QCheck_Approval_ChecklistManagers R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND ChecklistManagerID = -1
			AND cri.Approved = 1
	
	-- ============================================================================
	-- Checklists
	
	UPDATE
		QCheck_Checklists
	SET
		[Name] = R.[Name],
		IsDeleted = R.IsDeleted,
		Owner = R.Owner,
		Template = R.Template
	FROM
		QCheck_Checklists C
		INNER JOIN QCheck_Approval_Checklists R
			ON C.[ID] = R.ChecklistID
		INNER JOIN QCheck_Approval_ChangeRequestItems cri
			ON R.CRItemID = cri.[ID]
	WHERE
		R.ChangeRequestID = @ChangeID
		AND cri.Approved = 1
	
	INSERT INTO QCheck_Checklists (
		[Name],
		IsDeleted,
		Owner,
		Template
	)
		SELECT
			[Name],
			IsDeleted,
			Owner,
			Template
		FROM
			QCheck_Approval_Checklists R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND ChecklistID = -1
			AND cri.Approved = 1
	
	
	-- ============================================================================
	-- Items
	
	UPDATE 
		QCheck_Items
	SET
		ChecklistID = R.ChecklistID,
		SequenceNum = R.SequenceNum,
		ItemTypeID = R.ItemTypeID,
		[Text] = R.[Text],
		URL = R.URL,
		IsDeleted = R.IsDeleted
	FROM
		QCheck_Items C
		INNER JOIN QCheck_Approval_Items R
			ON C.[ID] = R.ItemID
		INNER JOIN QCheck_Approval_ChangeRequestItems cri
			ON R.CRItemID = cri.[ID]
	WHERE
		R.ChangeRequestID = @ChangeID
		AND cri.Approved = 1
	
	INSERT INTO QCheck_Items (
		ChecklistID,
		SequenceNum,	
		ItemTypeID,
		[Text],
		URL,
		IsDeleted
	)
		SELECT
			ChecklistID,
			SequenceNum,	
			ItemTypeID,
			[Text],
			URL,
			IsDeleted
		FROM
			QCheck_Approval_Items R
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON R.CRItemID = cri.[ID]
		WHERE
			R.ChangeRequestID = @ChangeID
			AND ItemID = -1
			AND cri.Approved = 1
	
	
	-- ============================================================================
	-- Schedule
	DECLARE cSch CURSOR FOR 
		SELECT 
			CI.[ID] AS InstanceID,
			S.FirstDueDate,
			S.LastDueDate,
			S.FreqType,
			S.FreqInterval,
			S.FreqRecurrance,
			S.DueTime,
			S.BusDayBehavior,
			S.SoftDueOffsetDays
		FROM 
			QCheck_ChecklistInstances CI
			INNER JOIN QCheck_Approval_Schedule S
				ON (
						CI.ScheduleID = S.ScheduleID OR 
						(
							S.ScheduleID = -1
							AND S.InstanceID = CI.ID
						)
					)
			INNER JOIN QCheck_Approval_ChangeRequestItems cri
				ON S.CRItemID = cri.[ID]
		WHERE
			S.ChangeRequestID = @ChangeID
			AND cri.Approved = 1
	OPEN cSch
	FETCH NEXT FROM cSch INTO @InstanceID, @FirstDueDate, @LastDueDate, @FreqType, @FreqInterval, @FreqRecurrance, @DueTime, @BusDayBehavior, @SoftDueOffsetDays
	WHILE @@FETCH_STATUS = 0 BEGIN
		EXEC QCheck_UpdateSchedule_Part1 @InstanceID, @FirstDueDate, @LastDueDate, @FreqType, @FreqInterval, @FreqRecurrance, @DueTime, @BusDayBehavior, @PrevFreqType OUTPUT, @RowsUpdated OUTPUT, 1, @SoftDueOffsetDays
		IF @RowsUpdated > 0 BEGIN
			EXEC QCheck_UpdateSchedule_Part2 @InstanceID, @PrevFreqType, 1
		END
		FETCH NEXT FROM cSch INTO @InstanceID, @FirstDueDate, @LastDueDate, @FreqType, @FreqInterval, @FreqRecurrance, @DueTime, @BusDayBehavior, @SoftDueOffsetDays
	END
	CLOSE cSch
	DEALLOCATE cSch
	
	-- ============================================================================
	-- Mark any affected status reports as dirty
	UPDATE
		QStatus_Report
	SET
		IsDirty = 1
	FROM 
		QStatus_Report r
		INNER JOIN QStatus_TaskTypes tt
			ON r.ID = tt.ReportID
		INNER JOIN QStatus_ActiveChecklistTaskType actt
			ON tt.ID = actt.TaskType
		INNER JOIN QCheck_ActiveChecklists_All  ac
			ON ac.ID = actt.ActiveChecklistID
		INNER JOIN QCheck_ChecklistInstances_All ci
			ON ci.ID = ac.InstanceID
	WHERE
		ci.ChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
	
	

	COMMIT TRAN

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_ApproveChange]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_ApproveChange] (
	@ChangeID INT,
	@UserID INT,
	@EmailedTo VARCHAR(500) = '',
	@EmailedCC VARCHAR(500) = ''
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ControllerFullName VARCHAR(500),
		@MailBody VARCHAR(5000),
		@RequestorEmail VARCHAR(500),
		@ControllerEmail VARCHAR(500),
		@TaskName VARCHAR(500),
		@ChecklistID INT,
		@MailTo VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000),
		@DenyCount INT,
		@ChangeChecklistID INT,
		@Changed VARCHAR(5000) = '',
		@Added VARCHAR(5000) = '',
		@Removed VARCHAR(5000) = '',
		@Controllers varchar(1000),
		@Assignees varchar(1000)


	-- Mark the change approved
	UPDATE 
		QCheck_Approval_ChangeRequests
	SET
		Approved = 1,
		ApprovedUser = @UserID,
		ApprovedDate = GETDATE(),
		IsActive = 0
	WHERE
		[ID] = @ChangeID

	-- 2/10/2012 dalvarado
	-- Delete any other outstanding changes for this checklist
	-- This change is per GPR
	SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
	
	UPDATE
		QCheck_Approval_ChangeRequests
	SET
		IsActive = 0,
		Rejected = 1,
		RejectedDate = GETDATE(),
		RejectedUser = @UserID
	WHERE
		IsActive = 1
		AND ReadyForSupervisor = 1
		AND Approved = 0
		AND Rejected = 0
		AND [ID] < @ChangeID
		AND ID in (SELECT ChangeRequestID 
					FROM QCheck_Approval_ChangeRequestChecklist 
					WHERE ID = @ChangeChecklistID)


	-- Apply the change to the live task
	EXEC QCheck_Approval_ApplyChange @ChangeID

	-- Get the requestor info
	SELECT 
		@RequestorEmail = Email 
	FROM 
		QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE
		CR.[ID] = @ChangeID

	-- Get the task name and checklist ID
	SELECT @TaskName =  dbo.QCheck_Approval_CRChecklistName(@ChangeID)
	SELECT @ChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
	SELECT @Controllers = isnull(dbo.QCheck_ManagersList(@ChecklistID), '')
	SELECT @Assignees = isnull(dbo.QCheck_GetChecklistAssignees(@ChecklistID), '')
	

	-- Get the supervisor's name
	SELECT
		@ControllerFullName = FullName,
		@ControllerEmail = Email
	FROM 
		QCheck_Users
	WHERE 
		[ID] = @UserID

	-- See if any changes were made by the controller before approving
	SELECT @DenyCount = COUNT([ID]) 
	FROM QCheck_Approval_ChangeRequestItems
	WHERE ChangeRequestID = @ChangeID AND Approved = 0

	-- Get the e-mail recipients.  E-mails go to the requestor and all controllers
	-- except the one who approved the change
	DECLARE @Duplicates VARCHAR(1000) = isnull(@EmailedTo, '') + ';' + isnull(@EmailedCC, '')
	SET @MailTo = @RequestorEmail + ';' + dbo.QCheck_ChecklistControllerEmailsWithoutDuplicates(@ChecklistID, @UserID, @Duplicates)
	
	CREATE TABLE #Changed (
		Seq INT,
		Item VARCHAR(1000),
		[Current] VARCHAR(1000),
		Requested VARCHAR(1000),
		CRItemID INT,
		Approved BIT
	)
	
	CREATE TABLE #Added (
		Seq INT,
		Item VARCHAR(1000),
		Requested VARCHAR(1000),
		CRItemID INT,
		Approved BIT
	)
	
	CREATE TABLE #Removed (
		Seq INT,
		Item VARCHAR(1000),
		Requested VARCHAR(1000),
		CRItemID INT,
		Approved BIT
	)
	
	INSERT INTO #Changed EXEC QCheck_Approval_CRChanged @ChangeID
	INSERT INTO #Added EXEC QCheck_Approval_CRAdded @ChangeID
	INSERT INTO #Removed EXEC QCheck_Approval_CRRemoved @ChangeID
	
	SELECT @Changed = @Changed + '<tr><td style="border-top: 1px solid #CCCCCC;">' + Item + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + [Current] + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + Requested + '&nbsp;</td></tr>' FROM #Changed WHERE Approved = 1
	SELECT @Added = @Added + '<tr><td style="border-top: 1px solid #CCCCCC;">' + Item + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + Requested + '&nbsp;</td></tr>' FROM #Added WHERE Approved = 1
	SELECT @Removed = @Removed + '<tr><td style="border-top: 1px solid #CCCCCC;">' + Item + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + Requested + '&nbsp;</td></tr>' FROM #Removed WHERE Approved = 1
	
	IF LEN(@Changed) > 0 SET @Changed = '<h3 style="color:#003366;">Changed</h3><table border="0" cellpadding="3" cellspacing="0"><tr><th width="200"></th><th width="400" align="left">Current</th><th width="400" align="left">Requested</th></tr>' + @Changed + '</table>'
	IF LEN(@Added) > 0 SET @Added = '<h3 style="color:#003366;">Added</h3><table border="0" cellpadding="3" cellspacing="0"><tr><th width="200"></th><th width="800" align="left">Requested</th></tr>' + @Added + '</table>'
	IF LEN(@Removed) > 0 SET @Removed = '<h3 style="color:#003366;">Removed</h3><table border="0" cellpadding="3" cellspacing="0"><tr><th width="200"></th><th width="800" align="left">Requested</th></tr>' + @Removed + '</table>'
	
	-- Set up the approved message
	IF @DenyCount > 0 BEGIN

		SET @MailSubject = 'Change(s) APPROVED WITH MODIFICATIONS for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')

		SET @MailBody = 'Your requested change has been approved WITH MODIFICATIONS.<br/><br/>
				Task: <b>' + ISNULL(@TaskName, '') + '</b><br/>
				Approved By: <b>' + ISNULL(@ControllerFullName, '') + '</b><br/>
				Assignees: <b>' + ISNULL(@Assignees, '') + '</b><br/>
				Controllers: <b>' + ISNULL(@Controllers, '') + '</b><br/><br/>' +
				@Changed +
				@Added + 
				@Removed				

	END ELSE BEGIN

		SET @MailSubject = 'Change(s) APPROVED for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')

		SET @MailBody = 'Your requested change has been approved.<br/><br/>
				Task: <b>' + ISNULL(@TaskName, '') + '</b><br/>
				Approved By: <b>' + ISNULL(@ControllerFullName, '') + '</b><br/>
				Assignees: <b>' + ISNULL(@Assignees, '') + '</b><br/>
				Controllers: <b>' + ISNULL(@Controllers, '') + '</b><br/><br/>' +
				@Changed +
				@Added + 
				@Removed				

	END
	
	SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'

	EXEC dbo.xp_smtp_sendmail 
		@from = @ControllerEmail,
		@from_name = @ControllerFullName,
		@to = @MailTo, 
		@subject = @MailSubject,
		@message = @MailBody, 
		@type = 'text/html', 
		@server = @MailServer

	DROP TABLE #Changed
	DROP TABLE #Added
	DROP TABLE #Removed

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_ApproveChangeRequestItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_ApproveChangeRequestItem] (
	@ID INT
) AS

BEGIN

	UPDATE QCheck_Approval_ChangeRequestItems
	SET Approved = 1
	WHERE [id] = @ID

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CancelRequest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_CancelRequest] (
	@ChangeID INT
) AS

BEGIN

	UPDATE QCheck_Approval_ChangeRequests
	SET IsActive = 0
	WHERE [ID] = @ChangeID

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_Cascade]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [dbo].[QCheck_Approval_Cascade](
	@ChangeID INT
)
AS
BEGIN
	DECLARE @ChangeChecklistID INT
		
	SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
	
	DECLARE @List varchar(100)
	SET @List = ''
	
		SELECT @List = @List + convert(varchar(10), ID) + ';' FROM 	
			QCheck_Approval_ChangeRequests
		WHERE
			IsActive = 1
			AND ReadyForSupervisor = 1
			AND Approved = 0
			AND Rejected = 0
			AND [ID] < @ChangeID
			AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID
	
	select @list

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_Changelist_Natural]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_Changelist_Natural] (
--DECLARE
	@ChangeID INT	
) AS

--77773 - Jackie Grant, Mobile Dog Groomers
--79495 - Keith Shannon, Increasing Productivity - IT
--78860 - Tim Germany, Petty Cash Audit

BEGIN

	DECLARE @Changes TABLE (
		Seq int,
		Item VARCHAR(500),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)	

	INSERT INTO @Changes EXECUTE QCheck_Approval_CRAdded_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRRemoved_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRChanged_Natural @ChangeID

	SELECT * FROM @Changes
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_Cleanup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[QCheck_Approval_Cleanup]
AS
BEGIN


		--delete old
		delete from QCheck_Approval_ChangeRequests where RequestDate < dateadd(year, -1, getdate())
		--delete inactive  
		delete from QCheck_Approval_ChangeRequests  where isactive = 0 and RequestDate < dateadd(month, -1, getdate())
		--delete those not ready
		delete from QCheck_Approval_ChangeRequests  where ReadyForSupervisor = 0 and RequestDate < dateadd(month, -1, getdate())
		--delete orphaned
		delete from QCheck_Approval_ChangeRequests where ReadyForSupervisor = 1 and approved = 0 and rejected = 0 and isactive = 1 and RequestDate < dateadd(month, -1, getdate())
			and id not in
			(
				SELECT 
					CR.[ID]
				FROM 
					QCheck_Approval_ChangeRequests CR
					inner join qcheck_approval_changerequestchecklist crc
						on crc.changerequestid = cr.id
					inner join qcheck_checklists c
						on c.id = crc.id
					INNER JOIN QCheck_ChecklistManagers CM
						ON CM.ChecklistID = c.ID
						AND CM.IsDeleted = 0
					INNER JOIN QCheck_Groups G
						ON CM.ManagerGroupID = G.[ID]
					INNER JOIN QCheck_GroupMembership GM
						ON G.[ID] = GM.GroupID
					INNER JOIN QCheck_Users CU
						ON GM.UserID = CU.[ID]
						and cu.IsDeleted = 0
					INNER JOIN QCheck_Users RU
						ON CR.RequestingUser = RU.[ID]
				WHERE
					CR.IsActive = 1
					AND CR.Approved = 0
					AND CR.Rejected = 0
					AND CR.ReadyForSupervisor = 1
			)

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CopyChecklistItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_CopyChecklistItems] (
	@ChangeID INT,
	@ChecklistID INT
) AS

BEGIN

	-- Clear out any existing items for the change	
	DELETE FROM QCheck_Approval_Items
	WHERE
		ChecklistID = @ChecklistID
		AND ChangeRequestID = @ChangeID
	
	-- Make a fresh copy of all the checklist items for the given checklist, tied to the given change ID
	INSERT INTO QCheck_Approval_Items (
		ChangeRequestID,
		ItemID,
		ChecklistID,
		SequenceNum,
		ItemTypeID,
		[Text],
		URL,
		IsDeleted
	)
		SELECT
			@ChangeID,
			[ID],
			ChecklistID,
			SequenceNum,
			ItemTypeID,
			[Text],
			URL,
			IsDeleted
		FROM
			QCheck_Items
		WHERE
			ChecklistID = @ChecklistID

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CopyInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_CopyInstance] (
	@ChangeID INT,
	@InstanceID INT
) AS

BEGIN
	
	DECLARE @NewInstanceID INT
	DECLARE @ScheduleID INT
	DECLARE @NewScheduleID INT
	DECLARE @NowDate DATETIME
	DECLARE @ChecklistID INT
	DECLARE @FreqType INT
	
	SELECT @NowDate = GetDate()

	-- Get the checklist and schedule from the current instance
	SELECT 
		@ScheduleID = ScheduleID, 
		@ChecklistID = ChecklistID
	FROM 
		QCheck_ChecklistInstances
	WHERE
		[ID] = @InstanceID

	-- Create a new schedule
	INSERT INTO QCheck_Schedule (
		firstDueDate, 
		lastDueDate, 
		freqType, 
		freqInterval, 
		freqRecurrance, 
		dueTime, 
		busDayBehavior,
		SoftDueOffsetDays
	)
		SELECT 
			firstDueDate, 
			lastDueDate, 
			freqType, 
			freqInterval, 
			freqRecurrance, 
			dueTime, 
			busDayBehavior,
			SoftDueOffsetDays
		FROM 
			QCheck_Schedule
		WHERE
			ID = @ScheduleID

	SELECT @NewScheduleID = @@Identity

	-- Create the new instance linked to the new schedule
	INSERT INTO QCheck_ChecklistInstances (
		[Name], 
		ChecklistID, 
		ScheduleID, 
		IsDeleted, 
		CreatedBy
	)
	SELECT 
		[Name], 
		@ChecklistID, 
		@NewScheduleID,  
		1, 
		CreatedBy
	FROM 
		QCheck_ChecklistInstances
	WHERE
		[ID] = @InstanceID
		AND IsDeleted = 0

	SELECT @NewInstanceID = @@Identity

	-- Create the approval instance linked to the new schedule
	INSERT INTO QCheck_Approval_ChecklistInstances (
		ChangeRequestID,
		InstanceID,
		[Name], 
		ChecklistID, 
		ScheduleID, 
		IsDeleted, 
		CreatedBy
	)
	SELECT 
		@ChangeID,
		@NewInstanceID,
		[Name], 
		@ChecklistID, 
		@NewScheduleID,  
		0, 
		CreatedBy
	FROM 
		QCheck_ChecklistInstances
	WHERE
		[ID] = @InstanceID
		AND IsDeleted = 0

	-- Create the approval schedule
	INSERT INTO QCheck_Approval_Schedule (
		ChangeRequestID,
		ScheduleID,
		FirstDueDate,
		LastDueDate,
		FreqType,
		FreqInterval,
		FreqRecurrance,
		DueTime,
		BusDayBehavior,
		SoftDueOffsetDays
	)
		SELECT
			@ChangeID,
			@NewScheduleID,
			FirstDueDate,
			LastDueDate,
			FreqType,
			FreqInterval,
			FreqRecurrance,
			DueTime,
			BusDayBehavior,
			SoftDueOffsetDays
		FROM
			QCheck_Schedule
		WHERE
			[ID] = @NewScheduleID

	-- Copy the assignments
	INSERT INTO QCheck_Approval_Assignments (
		ChangeRequestID,
		AssignmentID,
		InstanceID, 
		GroupID, 
		IsDeleted
	)
		SELECT 
			@ChangeID,
			-1,
			@NewInstanceID, 
			GroupID, 
			0
		FROM 
			QCheck_Assignments
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	-- Copy to any status reports
	INSERT INTO QStatus_InstanceTaskType (
		InstanceID, 
		TaskType
	)
		SELECT 
			@NewInstanceID, 
			TaskType
		FROM 
			QStatus_InstanceTaskType
		WHERE 
			InstanceID = @InstanceID
	

	-- Copy alerts
	INSERT INTO QCheck_Approval_Alerts (
		ChangeRequestID,
		AlertID,
		InstanceID, 
		DaysBefore, 
		AlertTime, 
		AlertType, 
		AlertText, 
		SentTime, 
		IsDeleted, 
		AlerteeGroupID
	)
		SELECT 
			@ChangeID,
			-1,
			@NewInstanceID, 
			DaysBefore, 
			AlertTime, 
			AlertType, 
			AlertText, 
			Null, 
			0, 
			AlerteeGroupID
		FROM 
			QCheck_Alerts
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0
	
END































GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CopySchedules]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_CopySchedules] (
	@ChangeID INT,
	@ChecklistID INT
) AS

BEGIN

	INSERT INTO QCheck_Approval_Schedule (
		ChangeRequestID,
		ScheduleID,
		firstDueDate,
		lastDueDate,
		freqType,
		freqInterval,
		freqRecurrance,
		dueTime,
		busDayBehavior,
		SoftDueOffsetDays,
		busDayValue
	)
		SELECT 
			@ChangeID,
			S.[ID],
			S.firstDueDate,
			S.lastDueDate,
			S.freqType,
			S.freqInterval,
			S.freqRecurrance,
			S.dueTime,
			S.busDayBehavior,
			S.SoftDueOffsetDays,
			S.busDayValue
		FROM 
			QCheck_Schedule S
			INNER JOIN QCheck_ChecklistInstances CI
				ON S.[ID] = CI.ScheduleID
		WHERE
			CI.ChecklistID = @ChecklistID
			AND CI.IsDeleted = 0

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CRAdded]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_CRAdded] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @Out TABLE (
		Seq INT IDENTITY(1,1),
		Item VARCHAR(max),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)
	
	-- Controllers
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Controller', G.[Name], R.CRItemID, CRI.Approved
		FROM QCheck_Approval_ChecklistManagers R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Groups G
			ON R.ManagerGroupID = G.[ID]
		LEFT OUTER JOIN QCheck_ChecklistManagers C
			ON R.ChecklistManagerID = C.[ID]
		WHERE 
			R.ChangeRequestID = @ChangeID 
			AND (
				R.ChecklistManagerID = -1
				OR (
					C.IsDeleted = 1
					AND R.IsDeleted = 0
				)
			)
	
	-- Checklist Items
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Checklist Item', '[' + IT.[Name] + '] ' + I.[Text] + CASE WHEN LEN(ISNULL(URL, '')) > 0 THEN ' <a href="' + URL + '" target="_blank">More Info</a>' ELSE '' END, I.CRItemID, CRI.Approved
		FROM QCheck_Approval_Items I
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON I.CRItemID = cri.[ID]
		INNER JOIN QCheck_ItemTypes IT
			ON I.ItemTypeID = IT.[ID]
		WHERE I.ChangeRequestID = @ChangeID AND ItemID = -1
	
	-- Checklist Instance / Schedule
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Schedule', dbo.QCheck_Approval_ScheduleString(@ChangeID, AppS.ScheduleID, CI.ID), AppS.CRItemID, CRI.Approved
		FROM QCheck_Approval_Schedule AppS
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON AppS.CRItemID = cri.[ID]
		INNER JOIN QCheck_ChecklistInstances CI
			ON (
					(AppS.InstanceID = CI.[ID] AND AppS.ScheduleID = -1)
				)
		WHERE AppS.ChangeRequestID = @ChangeID AND CI.IsDeleted = 0

	-- Assignee
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Assignee', G.[Name], A.CRItemID, CRI.Approved
		FROM QCheck_Approval_Assignments A
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON A.CRItemID = cri.[ID]
		INNER JOIN QCheck_Groups G
			ON A.GroupID = G.[ID]
		WHERE A.ChangeRequestID = @ChangeID AND AssignmentID = -1 AND A.IsDeleted = 0
	
	-- Alerts
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Alert', dbo.QCheck_Approval_AlertString(R.[ID]), R.CRItemID, CRI.Approved
		FROM QCheck_Approval_Alerts R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND AlertID = -1
	
	-- Get the final output
	SELECT 
		Seq,
		Item,
		Requested,
		CRItemID,
		Approved
	FROM 
		@Out
	ORDER BY
		Seq

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CRAdded_Natural]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_CRAdded_Natural] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @Out TABLE (
		Seq INT IDENTITY(1,1),
		Item VARCHAR(500),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)
	
	-- Controllers
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Controller', 'Adding ' + G.[Name] + ' as a Controller', R.CRItemID, CRI.Approved
		FROM QCheck_Approval_ChecklistManagers R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Groups G
			ON R.ManagerGroupID = G.[ID]
		LEFT OUTER JOIN QCheck_ChecklistManagers C
			ON R.ChecklistManagerID = C.[ID]
		WHERE 
			R.ChangeRequestID = @ChangeID 
			AND (
				R.ChecklistManagerID = -1
				OR (
					C.IsDeleted = 1
					AND R.IsDeleted = 0
				)
			)
	
	-- Checklist Items
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Checklist Item', 'Adding new ' + IT.[Name] + ' item to checklist' + CASE WHEN IT.[Name] = 'Spacer' THEN '' ELSE ' - ' END + I.[Text] + CASE WHEN LEN(ISNULL(URL, '')) > 0 THEN ' <a href="' + URL + '" target="_blank">More Info</a>' ELSE '' END, I.CRItemID, CRI.Approved
		FROM QCheck_Approval_Items I
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON I.CRItemID = cri.[ID]
		INNER JOIN QCheck_ItemTypes IT
			ON I.ItemTypeID = IT.[ID]
		WHERE I.ChangeRequestID = @ChangeID AND ItemID = -1
	
	-- Checklist Instance / Schedule
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Schedule', 'Adding new Schedule - ' + dbo.QCheck_Approval_ScheduleString(@ChangeID, AppS.ScheduleID, CI.ID), AppS.CRItemID, CRI.Approved
		FROM QCheck_Approval_Schedule AppS
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON AppS.CRItemID = cri.[ID]
		INNER JOIN QCheck_ChecklistInstances CI
			ON (
					(AppS.InstanceID = CI.[ID] AND AppS.ScheduleID = -1)
				)
		WHERE AppS.ChangeRequestID = @ChangeID AND CI.IsDeleted = 0

	-- Assignee
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Assignee', 'Adding ' + G.[Name] + ' as an Assignee', A.CRItemID, CRI.Approved
		FROM QCheck_Approval_Assignments A
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON A.CRItemID = cri.[ID]
		INNER JOIN QCheck_Groups G
			ON A.GroupID = G.[ID]
		WHERE A.ChangeRequestID = @ChangeID AND AssignmentID = -1 AND A.IsDeleted = 0
	
	-- Alerts
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Alert', 'Adding new Alert - ' + dbo.QCheck_Approval_AlertString(R.[ID]), R.CRItemID, CRI.Approved
		FROM QCheck_Approval_Alerts R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND AlertID = -1 AND R.IsDeleted = 0
	
	-- Get the final output
	SELECT 
		Seq,
		Item,
		Requested,
		CRItemID,
		Approved
	FROM 
		@Out
	WHERE Requested IS NOT NULL
	ORDER BY
		Seq

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CRChanged]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_CRChanged] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @Out TABLE (
		Seq INT IDENTITY(1,1),
		Item VARCHAR(max),
		[Current] VARCHAR(max),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)

	DECLARE @CurrentButton VARCHAR(max),
		@RequestButton VARCHAR(max)
	
	-- ===============================================================
	-- Active Checklsits			
	-- Due date
	INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved)
		SELECT 'Due Date', CONVERT(VARCHAR(20), C.DueTime), CONVERT(VARCHAR(20), R.DueTime), CRI.[ID], CRI.Approved
		FROM QCheck_Approval_ActiveChecklists R
		INNER JOIN QCheck_ActiveChecklists C
			ON R.ActiveChecklistID = C.[ID] 
			--AND R.DueTime <> C.DueTime -- Don't filter this, it needs to show in the request even if it's the current deadline
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		WHERE R.ChangeRequestID = @ChangeID
	
	
	
	-- ===============================================================
	-- Checklists
	
	-- Checklist name
	INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved)
		SELECT 'Checklist Name', C.[Name], R.[Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Checklists R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Checklists C 
			ON R.ChecklistID = C.[ID] 
			AND R.[Name] <> C.[Name]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	
	-- ===============================================================
	-- Items
	
	-- Item Type
	INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved)
		SELECT 'Item Type - ' + CASE WHEN LEN(C.[Text]) <= 20 THEN C.[Text] ELSE LEFT(C.[Text], 20) + '...' END, CT.[Name], RT.[Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.ItemTypeID <> C.ItemTypeID
		INNER JOIN QCheck_ItemTypes CT
			ON C.ItemTypeID = CT.[ID]
		INNER JOIN QCheck_ItemTypes RT
			ON R.ItemTypeID = RT.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	-- Name
	INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved)
		SELECT 'Item Text', C.[Text], R.[Text], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.[Text] <> C.[Text]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	-- URL
	INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved)
		SELECT 'Item URL', C.[URL], R.[URL], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.[URL] <> C.[URL]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	-- Sequence
	IF EXISTS (
		SELECT *
		FROM QCheck_Approval_Items R
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.[SequenceNum] <> C.[SequenceNum]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	) BEGIN

		SET @CurrentButton = '<input type="button" class="btn btn-default" value="Preview Current" onclick="DoPreview(-1, ' + CONVERT(VARCHAR(20), dbo.QCheck_Approval_CRChecklistID(@ChangeID)) + ', ''' + dbo.QCheck_Approval_CRChecklistName(@ChangeID) + ''');"/>'
		SET @RequestButton = '<input type="button" class="btn btn-default" value="Preview Requested" onclick="DoPreview(' + CONVERT(VARCHAR(20), @ChangeID) + ', ' + CONVERT(VARCHAR(20), dbo.QCheck_Approval_CRChecklistID(@ChangeID)) + ', ''' + dbo.QCheck_Approval_CRChecklistName(@ChangeID) + ''');"/>'

		INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved) VALUES ('Checklist Reordered', @CurrentButton, @RequestButton, -1, 1)

	END
	
	-- ===============================================================
	-- Schedule
	
	INSERT INTO @Out (Item, [Current], Requested, CRItemID, Approved)
		SELECT 'Schedule', isnull(dbo.QCheck_ScheduleString(C.[ID]), 'no schedule'), dbo.QCheck_Approval_ScheduleString(@ChangeID, R.ScheduleID, CI.ID), CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Schedule R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Schedule C 
			ON R.ScheduleID = C.[ID] 
			AND (
				R.FirstDueDate <> C.FirstDueDate
				OR R.LastDueDate <> C.LastDueDate
				OR R.FreqType <> C.FreqType
				OR R.FreqInterval <> C.FreqInterval
				OR R.FreqRecurrance <> C.FreqRecurrance
				OR R.DueTime <> C.DueTime
				OR R.BusDayBehavior <> C.BusDayBehavior
				OR R.SoftDueOffsetDays <> C.SoftDueOffsetDays
			)
		INNER JOIN QCheck_ChecklistInstances CI
			ON CI.ScheduleID = R.ScheduleID 
		WHERE R.ChangeRequestID = @ChangeID
	
	
	-- ===============================================================
	-- Get the output
	SELECT 
		Seq,
		Item,
		[Current],
		Requested,
		CRItemID,
		Approved
	FROM 
		@Out

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CRChanged_Natural]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_CRChanged_Natural] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @Out TABLE (
		Seq INT IDENTITY(1,1),
		Item VARCHAR(max),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)

	DECLARE @CurrentButton VARCHAR(max),
		@RequestButton VARCHAR(max),
		@ReorderCount int
	
	-- ===============================================================
	-- Active Checklists			
	-- Due date
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Due Date', 'Changing Due Date from ' + CONVERT(VARCHAR(20), C.DueTime) + ' to ' + CONVERT(VARCHAR(20), R.DueTime), CRI.[ID], CRI.Approved
		FROM QCheck_Approval_ActiveChecklists R
		INNER JOIN QCheck_ActiveChecklists C
			ON R.ActiveChecklistID = C.[ID] 
			--AND R.DueTime <> C.DueTime -- Don't filter this, it needs to show in the request even if it's the current deadline
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		WHERE R.ChangeRequestID = @ChangeID
	
	
	
	-- ===============================================================
	-- Checklists
	
	-- Checklist name
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Checklist Name', 'Changing Checklist Name from "' + C.[Name] +'" to "' + R.[Name] + '"', CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Checklists R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Checklists C 
			ON R.ChecklistID = C.[ID] 
			AND R.[Name] <> C.[Name]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	
	-- ===============================================================
	-- Items
	
	-- Item Type
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Checklist Item Type', 
		'Changing Item Type of checklist item "'+CASE WHEN LEN(C.[Text]) <= 20 THEN C.[Text] ELSE LEFT(C.[Text], 20) + '...' END
		+'" from ' + CT.[Name] + ' to ' + RT.[Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.ItemTypeID <> C.ItemTypeID
		INNER JOIN QCheck_ItemTypes CT
			ON C.ItemTypeID = CT.[ID]
		INNER JOIN QCheck_ItemTypes RT
			ON R.ItemTypeID = RT.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	-- Name
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Item Text', 'Changing text of checklist item "' + C.[Text] + '" to read "' + R.[Text] + '"', CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.[Text] <> C.[Text]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	-- URL
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Item URL', 'Changing "More Info" URL of checklist item "'+CASE WHEN LEN(C.[Text]) <= 20 THEN C.[Text] ELSE LEFT(C.[Text], 20) + '...' END
		+'" from "' + C.[URL] + '" to "' + R.[URL] + '"', CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C 
			ON R.ItemID = C.[ID] 
			AND R.[URL] <> C.[URL]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	
	
	-- Sequence reordering
	-- Old Way - doesn't work, because sequence numbers almost always change, but the order doesn't always

	--IF EXISTS (
	--	SELECT 'Y'
	--	FROM QCheck_Approval_Items R
	--	INNER JOIN QCheck_Items C 
	--		ON R.ItemID = C.[ID] 
	--		AND R.[SequenceNum] <> C.[SequenceNum]
	--	WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0
	--) BEGIN

		--SET @CurrentButton = '<input type="button" class="btn btn-default" value="Preview Current" onclick="DoPreview(-1, ' + CONVERT(VARCHAR(20), dbo.QCheck_Approval_CRChecklistID(@ChangeID)) + ', ''' + dbo.QCheck_Approval_CRChecklistName(@ChangeID) + ''');"/>'
		--SET @RequestButton = '<input type="button" class="btn btn-default" value="Preview Requested" onclick="DoPreview(' + CONVERT(VARCHAR(20), @ChangeID) + ', ' + CONVERT(VARCHAR(20), dbo.QCheck_Approval_CRChecklistID(@ChangeID)) + ', ''' + dbo.QCheck_Approval_CRChecklistName(@ChangeID) + ''');"/>'
		
		--SELECT @ReorderCount = COUNT(*)
		--FROM QCheck_Approval_Items R
		--INNER JOIN QCheck_Items C 
		--	ON R.ItemID = C.[ID] 
		--	AND R.[SequenceNum] <> C.[SequenceNum]
		--WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 0 AND C.IsDeleted = 0

		--New Way		
		--Basic idea; get all items not being added or deleted (doesn't count as a reorder),
		--then line them up row by row, and count all lines where the item IDs don't match 
		SELECT @ReorderCount = COUNT(*)
		FROM (
			SELECT ROW_NUMBER() OVER (ORDER BY i2.SequenceNum) Row, i2.ID 
				FROM QCheck_Items i2
				JOIN QCheck_Approval_Items ai2
					ON ai2.ChangeRequestID = @ChangeID
					AND ai2.ItemID = i2.ID			
				WHERE i2.IsDeleted = 0
					AND ai2.IsDeleted = 0 --no newly-deleted rows
			) i
		FULL JOIN (
			SELECT ROW_NUMBER() OVER (ORDER BY ai2.SequenceNum) Row, ai2.ItemID ID
				FROM QCheck_Approval_Items ai2
				WHERE ai2.ChangeRequestID = @ChangeID
				AND ai2.ItemID <> -1 --no newly-added rows
				AND ai2.IsDeleted = 0
			) ai
			ON ai.Row = i.Row
		WHERE ai.ID <> i.ID

		SET @ReorderCount = ISNULL(@ReorderCount, 0)

		IF(@ReorderCount > 0)
			INSERT INTO @Out (Item, Requested, CRItemID, Approved) VALUES ('Reorder', 'Reordering ' + CAST(@ReorderCount as varchar) + ' items within the checklist', -1, 1)

	--END
	
	-- ===============================================================
	-- Schedule
	
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Schedule', 'Changing schedule from "' + isnull(dbo.QCheck_ScheduleString(C.[ID]), 'no schedule') + '" to "' + dbo.QCheck_Approval_ScheduleString(@ChangeID, R.ScheduleID, CI.ID) + '"', CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Schedule R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Schedule C 
			ON R.ScheduleID = C.[ID] 
			AND (
				R.FirstDueDate <> C.FirstDueDate
				OR R.LastDueDate <> C.LastDueDate
				OR R.FreqType <> C.FreqType
				OR R.FreqInterval <> C.FreqInterval
				OR R.FreqRecurrance <> C.FreqRecurrance
				OR R.DueTime <> C.DueTime
				OR R.BusDayBehavior <> C.BusDayBehavior
				OR R.SoftDueOffsetDays <> C.SoftDueOffsetDays
			)
		INNER JOIN QCheck_ChecklistInstances CI
			ON CI.ScheduleID = R.ScheduleID 
		WHERE R.ChangeRequestID = @ChangeID
	
	
	-- ===============================================================
	-- Get the output
	SELECT 
		Seq,
		Item,
		Requested,
		CRItemID,
		Approved
	FROM 
		@Out
	WHERE Requested IS NOT NULL

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CRRemoved]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_CRRemoved] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @Out TABLE (
		Seq INT IDENTITY(1,1),
		Item VARCHAR(max),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)
	
	-- Controllers
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Controller', G.[Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_ChecklistManagers R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_ChecklistManagers C
			ON R.ChecklistManagerID = C.[ID]
		INNER JOIN QCheck_Groups G
			ON R.ManagerGroupID = G.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0
	
	-- Checklist Items
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Checklist Item', '[' + IT.[Name] + '] ' + C.[Text] + CASE WHEN LEN(ISNULL(C.URL, '')) > 0 THEN ' <a href="' + C.URL + '" target="_blank">More Info</a>' ELSE '' END, CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C
			ON R.ItemID = C.[ID]
		INNER JOIN QCheck_ItemTypes IT
			ON R.ItemTypeID = IT.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0
	
	-- Checklist Instance / Schedule
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Schedule', IsNull(dbo.QCheck_ScheduleString(CI.ScheduleID), 'Instance with no schedule'), CRI.[ID], CRI.Approved
		FROM QCheck_Approval_ChecklistInstances R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_ChecklistInstances CI
			ON R.InstanceID = CI.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND CI.IsDeleted = 0

	-- Assignmees
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Assignee', G.[Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Assignments R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Assignments C
			ON R.AssignmentID = C.[ID]
		INNER JOIN QCheck_Groups G
			ON C.GroupID = G.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0


	
	-- Alerts
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Alert', dbo.QCheck_AlertString(C.[ID]) , CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Alerts R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Alerts C
			ON R.AlertID = C.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0

	-- Delete Checklist
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Delete task', [Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Checklists R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1
	
	-- Get the final output
	SELECT 
		Seq,
		Item,
		Requested,
		CRItemID,
		Approved
	FROM 
		@Out
	ORDER BY
		Seq

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CRRemoved_Natural]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_CRRemoved_Natural] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @Out TABLE (
		Seq INT IDENTITY(1,1),
		Item VARCHAR(max),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)
	
	-- Controllers
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Controller', 'Removing ' + G.[Name] + ' as Controller', CRI.[ID], CRI.Approved
		FROM QCheck_Approval_ChecklistManagers R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_ChecklistManagers C
			ON R.ChecklistManagerID = C.[ID]
		INNER JOIN QCheck_Groups G
			ON R.ManagerGroupID = G.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0
	
	-- Checklist Items
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Checklist Item', 'Removing ' + IT.[Name] + ' from checklist - ' + C.[Text] + CASE WHEN LEN(ISNULL(C.URL, '')) > 0 THEN ' <a href="' + C.URL + '" target="_blank">More Info</a>' ELSE '' END, CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Items R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Items C
			ON R.ItemID = C.[ID]
		INNER JOIN QCheck_ItemTypes IT
			ON R.ItemTypeID = IT.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0
	
	-- Checklist Instance / Schedule
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Schedule', 'Removing ' + IsNull('Instance scheduled ' + dbo.QCheck_ScheduleString(CI.ScheduleID), 'Instance with no schedule'), CRI.[ID], CRI.Approved
		FROM QCheck_Approval_ChecklistInstances R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_ChecklistInstances CI
			ON R.InstanceID = CI.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND CI.IsDeleted = 0

	-- Assignees
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Assignee', 'Removing ' + G.[Name] + ' as an Assignee', CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Assignments R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Assignments C
			ON R.AssignmentID = C.[ID]
		INNER JOIN QCheck_Groups G
			ON C.GroupID = G.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0


	
	-- Alerts
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Alert', 'Removing Alert - ' + dbo.QCheck_AlertString(C.[ID]) , CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Alerts R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		INNER JOIN QCheck_Alerts C
			ON R.AlertID = C.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1 AND C.IsDeleted = 0

	-- Delete Checklist
	INSERT INTO @Out (Item, Requested, CRItemID, Approved)
		SELECT 'Delete task', 'Deleting entire checklist - ' + [Name], CRI.[ID], CRI.Approved
		FROM QCheck_Approval_Checklists R
 		INNER JOIN QCheck_Approval_ChangeRequestItems cri
 			ON R.CRItemID = cri.[ID]
		WHERE R.ChangeRequestID = @ChangeID AND R.IsDeleted = 1
	
	-- Get the final output
	SELECT 
		Seq,
		Item,
		Requested,
		CRItemID,
		Approved
	FROM 
		@Out
	WHERE Requested IS NOT NULL
	ORDER BY
		Seq

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CurrentAssignments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_CurrentAssignments] (
--DECLARE
	@ChangeID INT,-- = 80669,
	@ShowAll BIT = 0,
	@ControllerEmail VARCHAR(500) = NULL
) AS

--77773 - Jackie Grant, Mobile Dog Groomers
--79495 - Keith Shannon, Increasing Productivity - IT
--78860 - Tim Germany, Petty Cash Audit

BEGIN

	--Get the itemized changes (to use later)
	DECLARE @Changes TABLE (
		Seq int,
		Item VARCHAR(500),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)	

	INSERT INTO @Changes EXECUTE QCheck_Approval_CRAdded_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRRemoved_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRChanged_Natural @ChangeID

	--Get the "current" and "as requested" checklist layout

	DECLARE @CurrentAssignments TABLE
	(
		ChecklistID int,
		ChecklistName varchar(500),
		Controllers varchar(2000),
		InstanceID int,
		AssigneeList varchar(2000),
		ScheduleString varchar(2000)
	)	

	--Before - All instances with assignees and schedules
	INSERT INTO @CurrentAssignments
	(
		ChecklistID,
		ChecklistName,
		Controllers,
		InstanceID,
		AssigneeList,
		ScheduleString
	)
	SELECT DISTINCT c.ID, c.Name, 
		dbo.QStatus_GetChecklistControllers(c.ID) Controllers,
		ci.ID,
		dbo.QCheck_AssigneesList(ci.ID) AS AssigneesList, 
		dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule
	FROM QCheck_Approval_ChangeRequestChecklist crc
	JOIN QCheck_Checklists c
		ON crc.id = c.ID
	JOIN QCheck_ChecklistInstances ci
		ON ci.ChecklistID = c.ID
		AND ci.IsDeleted = 0
	LEFT JOIN QCheck_Schedule s
		ON s.ID = ci.ScheduleID		
	--These joins restrict to instances referenced by parts of the change request 
	--(instance, assignment, schedule or active checklist)
	LEFT JOIN QCheck_Approval_ChecklistInstances aci
		ON aci.InstanceID = ci.ID
		AND aci.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_Assignments aa
		ON aa.InstanceID = ci.ID
		AND aa.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_Schedule asch
		ON ((asch.InstanceID = ci.ID AND asch.ScheduleID = -1)
			OR asch.ScheduleID = s.ID)
		AND asch.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_ActiveChecklists aac
		ON aac.InstanceID = ci.ID
		AND aac.CRItemID IN (Select CRItemID From @Changes)
	WHERE crc.ChangeRequestID = @ChangeID
	--At least one of the joined CR tables must have data for the row, or else don't show it
	AND (
		@ShowAll = 1
		OR aci.ID IS NOT NULL
		OR aa.ID IS NOT NULL
		OR asch.ID IS NOT NULL
		OR aac.ID IS NOT NULL
	)
	ORDER BY ci.ID

	--Ensure that at least one row for the Checklist Name and Controllers exists
	IF (select COUNT(*) FROM @CurrentAssignments) = 0
		INSERT INTO @CurrentAssignments
		(
			ChecklistID,
			ChecklistName,
			Controllers,
			InstanceID,
			AssigneeList,
			ScheduleString
		)
		SELECT DISTINCT c.ID, c.Name, 
			dbo.QStatus_GetChecklistControllers(c.ID) Controllers,
			0, '(No Assignee Changes)', '(No Schedule Changes)'
		FROM QCheck_Approval_ChangeRequestChecklist crc
		JOIN QCheck_Checklists c
			ON crc.id = c.ID
		JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.ID
			AND ci.IsDeleted = 0
		WHERE crc.ChangeRequestID = @ChangeID

	SELECT * FROM @CurrentAssignments	

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_CurrentItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_CurrentItems] (
--DECLARE
	@ChangeID INT-- = 77773	
) AS

--77773 - Jackie Grant, Mobile Dog Groomers
--79495 - Keith Shannon, Increasing Productivity - IT
--78860 - Tim Germany, Petty Cash Audit

BEGIN

	Select c.ID ChecklistID, 
		i.ID ItemID, 
		i.SequenceNum, 
		i.ItemTypeID, 
		it.Name ItemTypeName, 
		i.Text, 
		i.URL
	FROM QCheck_Approval_ChangeRequestChecklist crc
	JOIN QCheck_Checklists c
		ON c.ID = crc.ID
	JOIN QCheck_Items i
		ON i.ChecklistID = c.ID
		AND i.IsDeleted = 0
	JOIN QCheck_ItemTypes it
		ON it.ID = i.ItemTypeID
	WHERE crc.ChangeRequestID = @ChangeID
	ORDER BY SequenceNum	

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DeadlineHistory]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DeadlineHistory] (
	@ChangeID INT
) AS

BEGIN

	DECLARE @ActiveChecklistID INT
		
	SELECT 
		@ActiveChecklistID = ActiveChecklistID
	FROM 
		QCheck_Approval_ActiveChecklists AC
	WHERE
		AC.ChangeRequestID = @ChangeID	
	
	SELECT 
		'Requested Change' AS ReqType,
		ISNULL(CONVERT(VARCHAR(20), aac.DueTime), '') AS DueTime,
		ISNULL(cr.Comment, '') AS Comment,
		ISNULL(u.FullName, '') AS RequestedBy,
		ISNULL(CONVERT(VARCHAR(20), cr.RequestDate), '') AS RequestDate,
		cr.ApprovedDate
	FROM
		QCheck_Approval_ActiveChecklists aac
		INNER JOIN QCheck_Approval_ChangeRequests cr
			ON aac.ChangeRequestID = cr.ID
		INNER JOIN QCheck_Users u
			ON cr.RequestingUser = u.ID
	WHERE
		aac.ActiveChecklistID = @ActiveChecklistID
		AND cr.ID <> @ChangeID
		AND cr.Approved = 1
	
	UNION
	
	SELECT 
		'Original Deadline',
		ISNULL(CONVERT(VARCHAR(20), OrigDueTime), ''),
		'Original Deadline',
		'',
		'',
		'1/1/1900'
	FROM QCheck_ActiveChecklists
	WHERE ID = @ActiveChecklistID
	ORDER BY 6 DESC
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DeleteAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DeleteAlert] (
	@ChangeID INT,
	@ID INT,
	@Existing BIT
) AS

BEGIN

	SET NOCOUNT ON

	IF @Existing = 1 BEGIN

		-- Requesting to delete an existing assignment
		INSERT INTO QCheck_Approval_Alerts (
			ChangeRequestID,
			AlertID,
			InstanceID,
			DaysBefore,
			AlertTime,
			AlertType,
			AlertText,
			SentTime,
			IsDeleted,
			AlerteeGroupID
		)
			SELECT
				@ChangeID,
				[ID],
				InstanceID,
				DaysBefore,
				AlertTime,
				AlertType,
				AlertText,
				SentTime,
				1,
				AlerteeGroupID
			FROM
				QCheck_Alerts
			WHERE
				[ID] = @ID

	END ELSE BEGIN

		-- Removing a requested new alert from the change request
		DELETE FROM QCheck_Approval_Alerts
		WHERE [ID] = @ID

	END

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DeleteAssignedTo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DeleteAssignedTo] (
	@ChangeID INT,
	@ID INT,
	@Existing BIT
) AS

BEGIN

	SET NOCOUNT ON

	IF @Existing = 1 BEGIN

		-- Requesting to delete an existing assignment
		INSERT INTO QCheck_Approval_Assignments (
			ChangeRequestID,
			AssignmentID,
			InstanceID,
			GroupID,
			DtAssigned,
			IsDeleted
		)
			SELECT
				@ChangeID,
				[ID],
				InstanceID,
				GroupID,
				DtAssigned,
				1
			FROM
				QCheck_Assignments
			WHERE
				[ID] = @ID

	END ELSE BEGIN

		-- Removing a requested new assignee from the change request
		DELETE FROM QCheck_Approval_Assignments
		WHERE [ID] = @ID

	END

	SET NOCOUNT OFF

END




































GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DeleteChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DeleteChecklist] (
	@ChangeID INT,
	@ChecklistID INT
) AS 

BEGIN

	INSERT INTO QCheck_Approval_Checklists (
		ChangeRequestID,
		ChecklistID,
		[Name],
		IsDeleted,
		Owner,
		Template
	)
		SELECT 
			@ChangeID,
			[ID],
			[Name],
			1,
			Owner,
			Template
		FROM
			QCheck_Checklists
		WHERE
			[ID] = @ChecklistID

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DeleteInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DeleteInstance](
	@ChangeID INT,
	@ID INT
) AS

BEGIN

	SET NOCOUNT ON
	
	--basic update here
	UPDATE
		QCheck_Approval_ChecklistInstances
	SET
		IsDeleted = 1
	WHERE 
		InstanceID = @ID
		AND ChangeRequestID = @ChangeID

	IF @@ROWCOUNT = 0 BEGIN

		INSERT INTO QCheck_Approval_ChecklistInstances (
			ChangeRequestID,
			InstanceID,
			[Name],
			ChecklistID,
			ScheduleID,
			IsDeleted,
			CreatedBy
		)
			SELECT
				@ChangeID,
				@ID,
				[Name],
				ChecklistID,
				ScheduleID,
				1,
				CreatedBy
			FROM
				QCheck_ChecklistInstances
			WHERE
				[ID] = @ID

	END

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DeleteManager]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DeleteManager] (
	@ChangeID INT,
	@ID INT,
	@Existing BIT
) AS

BEGIN

	SET NOCOUNT ON
	
	IF @Existing = 1 BEGIN

		-- Requesting to remove a controller from a status report
		INSERT INTO QCheck_Approval_ChecklistManagers (
			ChangeRequestID,
			ChecklistManagerID,
			ManagerGroupID,
			ChecklistID,
			IsDeleted
		)
			SELECT
				@ChangeID,
				@ID,
				ManagerGroupID,
				ChecklistID,
				1
			FROM
				QCheck_ChecklistManagers
			WHERE
				[ID] = @ID

	END ELSE BEGIN

		-- Removing one of the requested controllers from this change request
		DELETE FROM QCheck_Approval_ChecklistManagers
		WHERE [ID] = @ID

	END

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_DenyChangeRequestItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_DenyChangeRequestItem] (
	@ID INT
) AS

BEGIN

	UPDATE QCheck_Approval_ChangeRequestItems
	SET Approved = 0
	WHERE [id] = @ID

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetActiveDueDates]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_GetActiveDueDates] (
	@ChangeID INT,
	@InstanceID int
) AS

BEGIN

	SET NOCOUNT ON
	
	SELECT DISTINCT 
		ac.[ID], 
		ISNULL(aac.DueTime, ac.DueTime) AS DueTime
	FROM 
		QCheck_ActiveChecklists ac
		LEFT OUTER JOIN (
			SELECT a.*
			FROM 
				QCheck_Approval_ActiveChecklists a
				INNER JOIN QCheck_Approval_ChangeRequestItems CRI
					ON A.CRItemID = CRI.[ID]
					AND CRI.Approved = 1
		) aac
			ON ac.[ID] = aac.ActiveChecklistID
			AND aac.ChangeRequestID = @ChangeID
	WHERE 
		ac.InstanceID = @InstanceID
	--AND completeddate is null
	ORDER BY 2

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetChecklistItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_GetChecklistItems](
	@ChangeID INT,
	@ChecklistID INT
) AS

BEGIN

	SET NOCOUNT ON

	SELECT 
		I.[ID],
		I.SequenceNum, 
		IT.[ID] as TypeID,
		IT.[Name] as Type, 
		I.[Text],
		I.URL
	FROM
		QCheck_Approval_Items I
		INNER JOIN QCheck_Approval_ChangeRequestItems CRI
			ON I.CRItemID = CRI.[ID]
			AND CRI.Approved = 1
		INNER JOIN QCheck_ItemTypes IT
			ON I.ItemTypeID = IT.[ID]
	WHERE
		I.ChecklistID = @ChecklistID
		AND I.IsDeleted = 0
		AND I.ChangeRequestID = @ChangeID
	ORDER BY 
		I.SequenceNum

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetInstances]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_GetInstances] (
	@ChangeID INT,
	@ChecklistID INT
) AS

BEGIN

	SET NOCOUNT ON

	SELECT 
		I.[ID],
		I.[Name] 
	FROM
		QCheck_ChecklistInstances I
		LEFT OUTER JOIN (
			SELECT CI.*
			FROM QCheck_Approval_ChecklistInstances CI
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON CI.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
		) AI
			ON I.[ID] = AI.InstanceID
			AND AI.ChangeRequestID = @ChangeID

	WHERE
		I.ChecklistID = @ChecklistID
		AND I.IsDeleted = 0
		AND ISNULL(AI.IsDeleted, 0) = 0

	UNION

	SELECT
		I.InstanceID AS [ID],
		I.[Name]
	FROM
		QCheck_Approval_ChecklistInstances I
		INNER JOIN QCheck_Approval_ChangeRequestItems CRI
			ON I.CRItemID = CRI.[ID]
			AND CRI.Approved = 1
	WHERE
		I.ChecklistID = @ChecklistID
		AND I.IsDeleted = 0
		AND I.ChangeRequestID = @ChangeID
	
	ORDER BY I.[ID]
	

	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetManagers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_GetManagers] (
	@ChangeID INT,
	@ChecklistID INT
) AS

BEGIN

	SET NOCOUNT ON

	SELECT 
		I.[ID],
		g.[Name] as FullName
	FROM
		QCheck_ChecklistManagers I
		INNER JOIN QCheck_Groups g
			ON g.ID = I.ManagerGroupID
		LEFT OUTER JOIN (
			SELECT CI.*
			FROM QCheck_Approval_ChecklistManagers CI
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON CI.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
		) AI
			ON I.[ID] = AI.ChecklistManagerID
			AND AI.ChangeRequestID = @ChangeID

	WHERE
		I.ChecklistID = @ChecklistID
		AND I.IsDeleted = 0
		AND ISNULL(AI.IsDeleted, 0) = 0

	UNION

	SELECT
		I.ChecklistManagerID AS [ID],
		g.[Name] as FullName
	FROM
		QCheck_Approval_ChecklistManagers I
		INNER JOIN QCheck_Groups g
			ON g.ID = I.ManagerGroupID
		INNER JOIN QCheck_Approval_ChangeRequestItems CRI
			ON I.CRItemID = CRI.[ID]
			AND CRI.Approved = 1
	WHERE
		I.ChecklistID = @ChecklistID
		AND I.IsDeleted = 0
		AND I.ChangeRequestID = @ChangeID
	
	ORDER BY 1
	

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_GetSchedule] (
	@ChangeID INT,
	@InstanceID INT
) AS

BEGIN

	SET NOCOUNT ON

	SELECT 
		A.*
	FROM
		QCheck_Approval_Schedule A
		INNER JOIN QCheck_Approval_ChangeRequestItems CRI
			ON A.CRItemID = CRI.[ID]
			AND CRI.Approved = 1
		INNER JOIN QCheck_ChecklistInstances b
			ON b.ID = @InstanceID
			AND (b.scheduleID = a.ScheduleID
				OR
					(
						a.scheduleID = -1
						AND a.instanceID = b.ID
					)
				)
			
	WHERE
		A.ChangeRequestID = @ChangeID

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetSingleChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_GetSingleChecklist](
	@ChangeID INT,
	@loginID int,
	@type int, 
	@id int
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @tblAssigned TABLE (
		InstanceID int,
		AssignmentID int,
		AssignedTo int,
		Existing bit
	)

	DECLARE @ChecklistName VARCHAR(500)

	-- Existing assignments
	INSERT INTO @tblAssigned
	SELECT 
		a.InstanceID, a.ID, @loginID, 1
	FROM 
		QCheck_Assignments a
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @loginID
	WHERE 
		a.IsDeleted = 0

	-- Assignments added this change
	INSERT INTO @tblAssigned
	SELECT 
		a.InstanceID, a.ID, @loginID, 1
	FROM 
		QCheck_Approval_Assignments a
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @loginID
	WHERE 
		a.IsDeleted = 0
		AND a.ChangeRequestID = @ChangeID

	-- Assignments removed this change
	DELETE FROM @tblAssigned
	WHERE AssignmentID IN (
		SELECT AssignmentID
			FROM QCheck_Approval_Assignments
			WHERE
				ChangeRequestID = @ChangeID
				AND IsDeleted = 1
	)
	AND Existing = 1
	
	-- Get the checklist name for this change
	EXEC QCheck_Approval_GetChecklistName @ChangeID, @ChecklistName OUTPUT
	
	IF @type = 1
	BEGIN
		-- get current checklists
		SELECT Distinct @ChecklistName as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, u.FullName As CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0), charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID as UniqueID
			, d.SequenceNum
			, ISNULL(aa.DueTime, a.DueTime) AS DueTime
			, ISNULL(aa.ReminderDate, a.ReminderDate) AS ReminderDate
			, ISNULL(aa.CompletedDate, a.CompletedDate) As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 1 As ChkType
			, e.CompletedBy as CompletedByID
			, ta.AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, dbo.QCheck_ScheduleString(s.[ID]) as ScheduleString
			, dbo.QStatus_Approval_GetChecklistControllers(c.ID, @ChangeID) AS Controllers
			, dbo.QStatus_GetChecklistReports(a.ID, @loginID) as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b 
				ON a.InstanceID = b.ID 
				AND b.IsDeleted = 0
			INNER JOIN QCheck_Checklists c 
				on b.checklistID = c.ID 
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d 
				on d.checklistID = c.ID 
				AND d.IsDeleted = 0
			LEFT OUTER JOIN QCheck_ItemTypes j 
				on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta 
				on ta.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e 
				on e.ActiveChecklistID = a.ID 
				and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u 
				on e.CompletedBy = u.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL 
				on a.InstanceID=al.InstanceID
			LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aa 
				ON a.[id] = aa.ActiveChecklistID
				AND aa.ChangeRequestID = @ChangeID
	        WHERE
			a.ID = @id
		ORDER BY 
			SequenceNum
	END

	IF @type = 2
	BEGIN
		SELECT distinct c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, uu.FullName AS CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0),charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID As UniqueID
			, d.SequenceNum
			, CASE WHEN a.ArchiveDate IS NULL Then a.dueTime Else NULL End As DueTime
			, CASE WHEN a.ArchiveDate IS NULL Then a.ReminderDate Else NULL End As ReminderDate
			, a.CompletedDate As ActiveChkCompletedDate
			, null as AssignmentID
			, 1 As ChkType
			, null As Members
			, 0 as CompletedByID
			, 0 As AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, dbo.QCheck_ScheduleString(s.[ID]) as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
	FROM
		QCheck_ActiveChecklistArchive a 
		INNER JOIN 
			(
			SELECT    
				ID, ChecklistID, ScheduleID, null as ArchiveDate
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID, ScheduleID, ArchiveDate
			FROM         
				QCheck_ChecklistInstanceArchive 

			) b
		  ON a.InstanceID = b.ID 
		INNER JOIN QCheck_Checklists_All c 
		  on b.checklistID = c.ID  
		INNER JOIN 
			QCheck_Items d
		  on d.checklistID = c.ID 
		INNER JOIN 
			QCheck_ItemTypes j 
		  on d.ItemTypeID = j.ID
		left outer JOIN  QCheck_ActiveItemArchive e
			
		  on 
			e.ActiveChecklistID = a.ID 
			and e.ChecklistItemID = d.ID 
		LEFT OUTER JOIN QCheck_Users uu 
			ON 
			uu.ID = e.CompletedBy
		LEFT OUTER JOIN  QCheck_Schedule s ON b.ScheduleID = s.ID
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
        WHERE
		a.ID = @ID
        ORDER BY 
		SequenceNum
	END

	IF @type = 3
	BEGIN
		-- get future checklists
		SELECT Distinct 
			c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, null As UserText
			, null As CompletedBy
			, null As CompletedDate
			, d.ID as ItemID
			,  b.ID As Identifier
			,  uc.ID As UniqueID
			, d.SequenceNum
			, uc.DueTime
			, NULL AS ReminderDate
			, null As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 2 As ChkType
			, 0 As AssignedTo
			, uc.ID as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, dbo.QCheck_ScheduleString(s.[ID]) as ScheduleString
			,  dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QCheck_ChecklistInstances b
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta on ta.InstanceID = b.ID
			INNER JOIN QCheck_UpcomingDueTimes uc on uc.InstanceID = b.ID and uc.ID = @id
			LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
		ORDER BY 
			SequenceNum
	END
	
	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetSingleChecklist_AsRequested]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_GetSingleChecklist_AsRequested](
--DECLARE
	@ChangeID INT,-- = 91375,
	@loginID int,-- = 732,
	@type int,-- = 1, 
	@id int-- = 3368844
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @tblAssigned TABLE (
		InstanceID int,
		AssignmentID int,
		AssignedTo int,
		Existing bit
	)

	DECLARE @ChecklistName VARCHAR(500)

	-- Existing assignments
	INSERT INTO @tblAssigned
	SELECT 
		a.InstanceID, a.ID, @loginID, 1
	FROM 
		QCheck_Assignments a
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @loginID
	WHERE 
		a.IsDeleted = 0

	-- Assignments added this change
	INSERT INTO @tblAssigned
	SELECT 
		a.InstanceID, a.ID, @loginID, 1
	FROM 
		QCheck_Approval_Assignments a
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @loginID
	WHERE 
		a.IsDeleted = 0
		AND a.ChangeRequestID = @ChangeID

	-- Assignments removed this change
	DELETE FROM @tblAssigned
	WHERE AssignmentID IN (
		SELECT AssignmentID
			FROM QCheck_Approval_Assignments
			WHERE
				ChangeRequestID = @ChangeID
				AND IsDeleted = 1
	)
	AND Existing = 1
	
	-- Get the checklist name for this change
	EXEC QCheck_Approval_GetChecklistName @ChangeID, @ChecklistName OUTPUT
	
	IF @type = 1
	BEGIN
		-- get current checklists
		SELECT Distinct @ChecklistName as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, u.FullName As CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0), charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID as UniqueID
			, d.SequenceNum
			, ISNULL(aa.DueTime, a.DueTime) AS DueTime
			, ISNULL(aa.ReminderDate, a.ReminderDate) AS ReminderDate
			, ISNULL(aa.CompletedDate, a.CompletedDate) As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 1 As ChkType
			, e.CompletedBy as CompletedByID
			, ta.AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, dbo.QCheck_ScheduleString(s.[ID]) as ScheduleString
			, dbo.QStatus_Approval_GetChecklistControllers(c.ID, @ChangeID) AS Controllers
			, dbo.QStatus_GetChecklistReports(a.ID, @loginID) as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b 
				ON a.InstanceID = b.ID 
				AND b.IsDeleted = 0
			INNER JOIN QCheck_Checklists c 
				on b.checklistID = c.ID 
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Approval_Items d 
				on d.checklistID = c.ID
				AND d.ChangeRequestID = @ChangeID 
				AND d.IsDeleted = 0
			LEFT OUTER JOIN QCheck_ItemTypes j 
				on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta 
				on ta.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e 
				on e.ActiveChecklistID = a.ID 
				and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u 
				on e.CompletedBy = u.ID
			LEFT OUTER JOIN QCheck_Approval_Schedule s 
				ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL 
				on a.InstanceID=al.InstanceID
			LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aa 
				ON a.[id] = aa.ActiveChecklistID
				AND aa.ChangeRequestID = @ChangeID
	        WHERE
			a.ID = @id
		ORDER BY 
			SequenceNum
	END

	IF @type = 2
	BEGIN
		SELECT distinct c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, uu.FullName AS CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0),charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID As UniqueID
			, d.SequenceNum
			, CASE WHEN a.ArchiveDate IS NULL Then a.dueTime Else NULL End As DueTime
			, CASE WHEN a.ArchiveDate IS NULL Then a.ReminderDate Else NULL End As ReminderDate
			, a.CompletedDate As ActiveChkCompletedDate
			, null as AssignmentID
			, 1 As ChkType
			, null As Members
			, 0 as CompletedByID
			, 0 As AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, dbo.QCheck_ScheduleString(s.[ID]) as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
	FROM
		QCheck_ActiveChecklistArchive a 
		INNER JOIN 
			(
			SELECT    
				ID, ChecklistID, ScheduleID, null as ArchiveDate
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID, ScheduleID, ArchiveDate
			FROM         
				QCheck_ChecklistInstanceArchive 

			) b
		  ON a.InstanceID = b.ID 
		INNER JOIN QCheck_Checklists_All c 
		  on b.checklistID = c.ID  
		INNER JOIN 
			QCheck_Items d
		  on d.checklistID = c.ID 
		INNER JOIN 
			QCheck_ItemTypes j 
		  on d.ItemTypeID = j.ID
		left outer JOIN  QCheck_ActiveItemArchive e
			
		  on 
			e.ActiveChecklistID = a.ID 
			and e.ChecklistItemID = d.ID 
		LEFT OUTER JOIN QCheck_Users uu 
			ON 
			uu.ID = e.CompletedBy
		LEFT OUTER JOIN  QCheck_Schedule s ON b.ScheduleID = s.ID
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
        WHERE
		a.ID = @ID
        ORDER BY 
		SequenceNum
	END

	IF @type = 3
	BEGIN
		-- get future checklists
		SELECT Distinct 
			c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, null As UserText
			, null As CompletedBy
			, null As CompletedDate
			, d.ID as ItemID
			,  b.ID As Identifier
			,  uc.ID As UniqueID
			, d.SequenceNum
			, uc.DueTime
			, NULL AS ReminderDate
			, null As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 2 As ChkType
			, 0 As AssignedTo
			, uc.ID as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, dbo.QCheck_ScheduleString(s.[ID]) as ScheduleString
			,  dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QCheck_ChecklistInstances b
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Approval_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta on ta.InstanceID = b.ID
			INNER JOIN QCheck_UpcomingDueTimes uc on uc.InstanceID = b.ID and uc.ID = @id
			LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
		ORDER BY 
			SequenceNum
	END
	
	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetSupervisorChangeRequests_UniversalExtensions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    PROCEDURE [dbo].[QCheck_Approval_GetSupervisorChangeRequests_UniversalExtensions] (
	@UserID INT, -- The UserID of the controller,
	@ID INT = NULL,
	@Sort int = 0 --0 = by request date, 1= by name, 2 = by new deadline
) AS

BEGIN

	-- Pulls back the list of change requests requiring the given supervisor's approval or rejection
	SELECT 
		CR.[ID],
		CR.RequestingUser,
		RU.FullName,
		Ru.Email,
		CR.RequestDate,
		CR.Comment,
		chk.ID AS ChecklistID,
		chk.Name AS ChecklistName,
		dbo.QCheck_ManagersList(chk.ID) AS Controllers,
		dbo.QCheck_AssigneesList(chk.InstanceID) AS Assignees,
		deadlinechecklist.completeddate,
		case when ac.id is not null and ac.duetime <> ac.origduetime and ac.duetime < getdate() 
			then 
			'** Requested deadline has passed! Upon approval, deadline will be set to ' +CONVERT(VARCHAR, dateadd(hour, datepart(hour,ac.duetime), dbo.Util_addofficedays(getdate(), 1)), 101)+ ' instead**'
			else ''
		end as DatePassedMessage
	FROM 
		QCheck_Approval_ChangeRequests CR
		inner join 
			(
			SELECT 
				ac.ChangeRequestID, c.id, c.name, ci.ID AS InstanceID
			FROM  
				QCheck_Approval_ActiveChecklists AC
				INNER JOIN QCheck_ChecklistInstances CI
					ON AC.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
	
			UNION
			
			SELECT
				A.ChangeRequestID, C.[ID], c.name, ci.ID AS InstanceID
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_ChecklistInstances CI
					ON A.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
				--order by 1
				
			UNION 
	
			SELECT
				I.ChangeRequestID,  C.[ID], c.name, -1 AS InstanceID
			FROM 
				QCheck_Approval_Items I
				INNER JOIN QCheck_Checklists C
					ON I.ChecklistID = C.[ID]
			WHERE i.changerequestid not in 
				(
				SELECT ac.changerequestid
				FROM  
					QCheck_Approval_ActiveChecklists AC
					INNER JOIN QCheck_ChecklistInstances CI
						ON AC.InstanceID = CI.[ID]
					INNER JOIN QCheck_Checklists C
						ON CI.ChecklistID = C.[ID]
		
				UNION ALL
				
				SELECT
					a.changerequestid
				FROM 
					QCheck_Approval_Assignments A
					INNER JOIN QCheck_ChecklistInstances CI
						ON A.InstanceID = CI.[ID]
					INNER JOIN QCheck_Checklists C
						ON CI.ChecklistID = C.[ID]
				)
			) as chk
		on chk.ChangeRequestID = cr.id
		INNER JOIN QCheck_ChecklistManagers CM
			ON CM.ChecklistID = Chk.ID
			AND CM.IsDeleted = 0
		INNER JOIN QCheck_Groups G
			ON CM.ManagerGroupID = G.[ID]
		INNER JOIN QCheck_GroupMembership GM
			ON G.[ID] = GM.GroupID
		INNER JOIN QCheck_Users CU
			ON GM.UserID = CU.[ID]
		INNER JOIN QCheck_Users RU
			ON CR.RequestingUser = RU.[ID]
		LEFT OUTER JOIN QCheck_Approval_ActiveChecklists AC
			ON AC.ChangeRequestID = CR.ID
		OUTER APPLY 
				(
					SELECT id, completeddate FROM QCheck_ActiveChecklists_All
					WHERE id = AC.activechecklistID
				) deadlinechecklist
	WHERE
		CR.IsActive = 1
		AND CR.Approved = 0
		AND CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		AND CU.[ID] = @UserID	
		AND (CR.ID = @ID or @ID is null)
		and CR.ID in (select ChangeRequestID from QCheck_UniversalExtensionChangeRequests where IsActive=1)
	ORDER BY
		CASE WHEN @Sort = 0 then convert(varchar,RequestDate,  120) 
		 WHEN @Sort = 1 then RU.FullName
		 ELSE convert(varchar,AC.duetime,  120)
		END

END




GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_GetUserChangeRequests]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_GetUserChangeRequests] (
	@UserID INT, -- The UserID of the requester,
	@ID INT = NULL,
	@Sort int = 0 --0 = by request date, 1= by name, 2 = by new deadline
) AS

BEGIN

	-- Pulls back the list of change requests made by the given user that have not yet been approved or rejected
	SELECT 
		CR.[ID],
		CR.RequestingUser,
		RU.FullName,
		Ru.Email,
		CR.RequestDate,
		CR.Comment,
		chk.ID AS ChecklistID,
		chk.Name AS ChecklistName,
		dbo.QCheck_ManagersList(chk.ID) AS Controllers,
		dbo.QCheck_AssigneesList(chk.InstanceID) AS Assignees,
		dbo.QCheck_Approval_ExtensionLength(cr.id) as extensiondays,
		dbo.QCheck_Approval_ExtensionCount(cr.id) as extensioncount,
		deadlinechecklist.completeddate,
		case when ac.id is not null and ac.duetime <> ac.origduetime and ac.duetime < getdate() 
			then 
			'** Requested deadline has passed! Upon approval, deadline will be set to ' +CONVERT(VARCHAR, dateadd(hour, datepart(hour,ac.duetime), dbo.Util_addofficedays(getdate(), 1)), 101)+ ' instead**'
			else ''
		end as DatePassedMessage
	FROM 
		QCheck_Approval_ChangeRequests CR
		inner join (
			SELECT 
				ac.ChangeRequestID, c.id, c.name, ci.ID AS InstanceID
			FROM  
				QCheck_Approval_ActiveChecklists AC
				INNER JOIN QCheck_ChecklistInstances CI
					ON AC.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
	
			UNION
			
			SELECT
				A.ChangeRequestID, C.[ID], c.name, ci.ID AS InstanceID
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_ChecklistInstances CI
					ON A.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
									
			UNION 
	
			SELECT
				I.ChangeRequestID,  C.[ID], c.name, -1 AS InstanceID
			FROM 
				QCheck_Approval_Items I
				INNER JOIN QCheck_Checklists C
					ON I.ChecklistID = C.[ID]
			WHERE I.ChangeRequestID not in 
				(
				SELECT ac.ChangeRequestID
				FROM  
					QCheck_Approval_ActiveChecklists AC
		
				UNION ALL
				
				SELECT
					a.ChangeRequestID
				FROM 
					QCheck_Approval_Assignments A
				)
		) AS chk
			ON chk.ChangeRequestID = cr.id
		INNER JOIN QCheck_Users RU
			ON CR.RequestingUser = RU.[ID]
		LEFT OUTER JOIN QCheck_Approval_ActiveChecklists AC
			ON AC.ChangeRequestID = CR.ID
		OUTER APPLY 
				(
					SELECT id, completeddate FROM QCheck_ActiveChecklists_All
					WHERE id = AC.activechecklistID
				) deadlinechecklist
	WHERE
		CR.IsActive = 1
		AND CR.Approved = 0
		AND CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		AND CR.RequestingUser = @UserID	
		AND (CR.ID = @ID or @ID is null)
	ORDER BY
		CASE WHEN @Sort = 0 then convert(varchar,RequestDate,  120) 
		 WHEN @Sort = 1 then RU.FullName
		 ELSE convert(varchar,AC.duetime,  120)
		END

END




GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_HandleApprovalEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[QCheck_Approval_HandleApprovalEmail] (
	@Command VARCHAR(5000),
	@ChangeID INT,
	@ControllerEmail VARCHAR(500),
	@EmailedTo VARCHAR(500) = '',
	@EmailedCC VARCHAR(500) = ''
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ControllerUserID INT,
		@MailBody VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000),
		@RequestorEmail VARCHAR(500),
		@TaskName VARCHAR(500),
		@rowcount int, 
		@i int, 
		@MailTo VARCHAR(5000),
		@ChecklistID INT,
		@TempCount INT
	
	SET @MailFrom = @AppName + '-ChangeRequest<' + REPLACE(@FromAddress, @AppName, @AppName + '-ChangeRequest') + '>'
	
	-- Get supervisor info
	SELECT 	@ControllerUserID = [ID]
	FROM 	QCheck_Users
	WHERE	Email = @ControllerEmail
		AND IsDeleted = 0


	-- Get the requestor info
	SELECT 	@RequestorEmail = Email 
	FROM 	QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE	CR.[ID] = @ChangeID

	-- Get task info
	SELECT @ChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
	SELECT @TaskName = dbo.QCheck_Approval_CRChecklistName(@ChangeID)
	
	-- Check to see if the email is from a controller on this request
	SELECT 
		@TempCount = COUNT(*)
	FROM
		QCheck_ChecklistManagers cm (nolock)
		INNER JOIN QCheck_Groups g (nolock)
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm (nolock)
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u (nolock)
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.ID = @ControllerUserID

	--First off, is the command is "L" (long version), that doesn't require controller privileges

	IF @Command = 'L' BEGIN
		
		EXEC QCheck_Approval_SendRequest @ChangeID, 1, @ControllerEmail

	END ELSE BEGIN			
	
		IF @TempCount = 0 BEGIN
			SET @MailBody = 'You are not allowed to approve the request for the task "' + ISNULL(@TaskName, 'NULL') + '" because you are not a controller on this task.'
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = 'Unauthorized approval request',
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

			RETURN
		END

		-- Process the command
		IF @Command = 'Y' BEGIN
	
			EXEC QCheck_Approval_ApproveChange @ChangeID, @ControllerUserID, @EmailedTo, @EmailedCC

		END ELSE BEGIN

			IF @Command = 'N' BEGIN

				EXEC QCheck_Approval_RejectChange @ChangeID, @ControllerUserID, '', @EmailedTo, @EmailedCC

			END ELSE BEGIN

				-- Send the "unknown command" e-mail
				SET @MailBody = 'Your command "' + ISNULL(@Command, '') + '" was not recognized.<br/><br/>Please do not reply to this e-mail, reply to the original request.'
			
				SET @MailSubject = @AppName + ' - Requested Change'
	
				EXEC dbo.xp_smtp_sendmail 
					@from = @MailFrom,
					@to = @ControllerEmail, 
					@subject = @MailSubject,
					@message = @MailBody, 
					@type = 'text/html', 
					@server = @MailServer

			END

		END

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_MoveItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_MoveItem]
	@ChangeID INT,
	@ID int,
	@MoveTo int
 AS

BEGIN

	SET NOCOUNT ON
		
		DECLARE @NewSequenceNum int		
		DECLARE @OldSequenceNum int
		DECLARE @MinWithEmptyBefore int

		SELECT @OldSequenceNum = [SequenceNum]
		FROM QCheck_Approval_Items
		WHERE [ID] = @ID	
		
		SELECT @NewSequenceNum = [SequenceNum]
		FROM QCheck_Approval_Items
		WHERE [ID] = @MoveTo

		IF @OldSequenceNum < @NewSequenceNum  SET @NewSequenceNum = @NewSequenceNum + 1

		UPDATE QCheck_Approval_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE 
			[SequenceNum] >= @NewSequenceNum
			AND ChangeRequestID = @ChangeID
			AND EXISTS (
				SELECT [ID] FROM QCheck_Approval_Items 
				WHERE [SequenceNum] = @NewSequenceNum
				AND ChangeRequestID = @ChangeID
			)
			AND IsDeleted = 0
	
		UPDATE QCheck_Approval_Items
		SET SequenceNum = @NewSequenceNum
		WHERE ID = @ID

		SELECT @MinWithEmptyBefore = MIN(A.SequenceNum)
		FROM QCheck_Approval_Items a
		WHERE NOT EXISTS
		(
			SELECT b.ID 
			FROM QCheck_Approval_Items b
			WHERE 
				b.SequenceNum = a.SequenceNum - 1
				AND b.IsDeleted = 0
				AND b.ChangeRequestID = @ChangeID
		)
		AND a.SequenceNum > 1
		AND a.IsDeleted = 0
		AND a.ChangeRequestID = @ChangeID
		
		If IsNull(@MinWithEmptyBefore,0) > 1
		BEGIN
			UPDATE QCheck_Approval_Items
			SET [SequenceNum] = [SequenceNum] - 1
			WHERE [SequenceNum] >= @MinWithEmptyBefore
			AND IsDeleted = 0
			AND ChangeRequestID = @ChangeID
		END
		

	SET NOCOUNT OFF

END







































GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_NewAssignee_Process]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_NewAssignee_Process] (
	@Command VARCHAR(5000),
	@ChangeID INT,
	@ControllerEmail VARCHAR(500),
	@EmailedTo VARCHAR(500) = '',
	@EmailedCC VARCHAR(500) = ''
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @CurrentAssignees TABLE (
		Seq INT IDENTITY(1,1),
		[Name] VARCHAR(500)
	)

	DECLARE @NewAssignees TABLE (
		Seq INT IDENTITY(1,1),
		[Name] VARCHAR(500)
	)

	DECLARE @ControllerUserID INT,
		@ControllerFullName VARCHAR(500),
		@MailBody VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000),
		@RequestorEmail VARCHAR(500),
		@TaskName VARCHAR(500),
		@rowcount int, 
		@i int, 
		@CurrentAssigneeList VARCHAR(2000),
		@NewAssigneeList VARCHAR(2000),
		@InstanceID INT,
		@AssignmentID INT,
		@GroupID INT,
		@ActiveChecklistID INT,
		@cmd VARCHAR(500),
		@ReportID INT,
		@MailTo VARCHAR(5000),
		@ChecklistID INT,
		@TempCount INT,
		@ChangeChecklistID INT,
		@CREmail VARCHAR(500),
		@Controllers varchar(1000)
		
	SET @MailFrom = @AppName + '-ChangeRequest<' + REPLACE(@FromAddress, @AppName, @AppName + '-ChangeRequest') + '>'
		
	-- Get supervisor info
	SELECT 	@ControllerUserID = [ID],
		@ControllerFullName = FullName
	FROM 	QCheck_Users
	WHERE	Email = @ControllerEmail
		AND IsDeleted = 0

	-- Get the requestor info
	SELECT 	@RequestorEmail = Email 
	FROM 	QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE	CR.[ID] = @ChangeID

	-- Get task info
	SELECT TOP 1
		@ChecklistID = c.[ID],
		@TaskName = c.[Name],
		@InstanceID = a.InstanceID,
		@Controllers = isnull(dbo.QCheck_ManagersList(c.id), '')
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.[ID]
		INNER JOIN QCheck_Approval_Assignments a
			ON ci.[ID] = a.InstanceID
	WHERE
		a.ChangeRequestID = @ChangeID

	-- Check to see if the email is from a controller on this request
	-- added 12/28/2011 2:30PM (Son Tran)
	SELECT 
		@TempCount = COUNT(*)
	FROM
		QCheck_ChecklistManagers cm (nolock)
		INNER JOIN QCheck_Groups g (nolock)
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm (nolock)
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u (nolock)
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.Email = @ControllerEmail
	
	IF @TempCount = 0 
		BEGIN
			SET @MailBody = 'You are not allowed to approve the request for the task "' + ISNULL(@TaskName, 'NULL') + '" because you are not a controller on this task.'
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = 'Unauthorized approval request',
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

			RETURN
		END

	-- Get the e-mail recipients.  E-mails go to the requestor and all controllers
	-- except the one who sent the e-mail we're processingDECLARE @Duplicates VARCHAR(1000) = isnull(@EmailedTo, '') + ';' + isnull(@EmailedCC, '')
	DECLARE @Duplicates VARCHAR(1000) = isnull(@EmailedTo, '') + ';' + isnull(@EmailedCC, '')
	SET @MailTo = @RequestorEmail + ';' + dbo.QCheck_ChecklistControllerEmailsWithoutDuplicates(@ChecklistID, @ControllerUserID, @Duplicates)

	-- Get current assignee list
	INSERT INTO @CurrentAssignees (
		[Name]
	)
		SELECT G.[Name]
		FROM 
			QCheck_Assignments A
			INNER JOIN QCheck_Groups G
				ON A.GroupID = G.[ID]
				AND A.InstanceID = @InstanceID
		WHERE A.IsDeleted = 0
		ORDER BY G.[Name]

	SELECT @rowcount = MAX(Seq) FROM @CurrentAssignees
	SET @i = 1
	SET @CurrentAssigneeList = ''
	WHILE @i <= @rowcount BEGIN
		SELECT @CurrentAssigneeList = @CurrentAssigneeList + [Name] FROM @CurrentAssignees WHERE Seq = @i
		IF @i < @rowcount SET @CurrentAssigneeList = @CurrentAssigneeList + ', '
		SET @i = @i + 1
	END

	-- Get new assignee list
	INSERT INTO @NewAssignees (
		[Name]
	)
		SELECT 
			G.[Name]
		FROM 
			QCheck_Approval_Assignments A
			INNER JOIN QCheck_Groups G
				ON A.GroupID = G.[ID]
		WHERE
			A.IsDeleted = 0
			AND A.InstanceID = @InstanceID
			AND A.ChangeRequestID = @ChangeID

		UNION

		SELECT 
			G.[Name]
		FROM 
			QCheck_Assignments A
			INNER JOIN QCheck_Groups G
				ON A.GroupID = G.[ID]
				AND A.InstanceID = @InstanceID
			-- Join to assignments we are deleting
			LEFT OUTER JOIN QCheck_Approval_Assignments AA
				ON A.[ID] = AA.AssignmentID
				AND AA.ChangeRequestID = @ChangeID
				AND AA.InstanceID = @InstanceID
				AND AA.IsDeleted = 1
		WHERE
			A.IsDeleted = 0
			-- Make sure the assignment is not being deleted
			AND AA.[ID] IS NULL
		ORDER BY 
			G.[Name]

	SELECT @rowcount = MAX(Seq) FROM @NewAssignees
	SET @i = 1
	SET @NewAssigneeList = ''
	WHILE @i <= @rowcount BEGIN
		SELECT @NewAssigneeList = @NewAssigneeList + [Name] FROM @NewAssignees WHERE Seq = @i
		IF @i < @rowcount SET @NewAssigneeList = @NewAssigneeList + ', '
		SET @i = @i + 1
	END

	-- Process the command
	--IF @Command = 'Y' BEGIN
	SET @Command = UPPER(@Command)
	IF @Command = 'Y' OR @Command = 'YES' OR @Command = 'YS' BEGIN

		BEGIN TRAN
	
			-- Delete removed assignees
			DECLARE curs_removed CURSOR FOR
				SELECT a.AssignmentID
				FROM QCheck_Approval_Assignments a
				WHERE a.ChangeRequestID = @ChangeID AND a.IsDeleted = 1
			OPEN curs_removed
			FETCH NEXT FROM curs_removed INTO @AssignmentID
			WHILE @@FETCH_STATUS = 0 BEGIN
				-- Use the SP, it handles the removal e-mails
				EXEC QCheck_DeleteAssignedTo @AssignmentID
				FETCH NEXT FROM curs_removed INTO @AssignmentID
			END
			CLOSE curs_removed
			DEALLOCATE curs_removed

			-- Add new assignments
			DECLARE curs_added CURSOR FOR
				SELECT 	GroupID
				FROM QCheck_Approval_Assignments
				WHERE ChangeRequestID = @ChangeID AND AssignmentID = -1
			OPEN curs_added
			FETCH NEXT FROM curs_added INTO @GroupID
			WHILE @@FETCH_STATUS = 0 BEGIN
				EXEC QCheck_AddAssignedTo @InstanceID, @GroupID, @ControllerUserID
				FETCH NEXT FROM curs_added INTo @GroupID
			END
			CLOSE curs_added
			DEALLOCATE curs_added

			-- Mark the request approved
			UPDATE 
				QCheck_Approval_ChangeRequests
			SET 
				Approved = 1,
				ApprovedUser = @ControllerUserID,
				ApprovedDate = GETDATE(),
				IsActive = 0
			WHERE
				[ID] = @ChangeID

			-- 2/10/2012 dalvarado
			-- Delete any other outstanding changes for this checklist
			-- This change is per GPR
			SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
		
			UPDATE
				QCheck_Approval_ChangeRequests
			SET
				IsActive = 0,
				Rejected = 1,
				RejectedDate = GETDATE(),
				RejectedUser = @ControllerUserID
			WHERE
				IsActive = 1
				AND ReadyForSupervisor = 1
				AND Approved = 0
				AND Rejected = 0
				AND [ID] < @ChangeID
				AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID
			

		COMMIT TRAN

		-- Set any affected status reports to recache on next open
		DECLARE curs_reports CURSOR FOR
			SELECT 
				tt.ReportID
			FROM 
				QStatus_ActiveChecklistTaskType actt
				INNER JOIN QStatus_TaskTypes tt
					ON actt.TaskType = tt.ID
				INNER JOIN QCheck_ActiveChecklists ac
					ON actt.ActiveChecklistID = ac.ID
			WHERE 
				ac.InstanceID = @InstanceID
		OPEN curs_reports
		FETCH NEXT FROM curs_reports INTO @ReportID
		WHILE @@FETCH_STATUS = 0 BEGIN
			UPDATE QStatus_Report
			SET IsDirty = 1
			WHERE [ID] = @ReportID

			FETCH NEXT FROM curs_reports INTO @ReportID
		END
		CLOSE curs_reports
		DEALLOCATE curs_reports		
		
		-- Send the approved e-mail
		SET @MailBody = 'Your request for an assignment change has been approved.<br/><br/>
				Task: <b>' + ISNULL(@TaskName, '') + '</b><br/>
				New Assignees: <b>' + ISNULL(@NewAssigneeList, '') + '</b><br/>
				Controllers: <b>' + ISNULL(@Controllers, '') + '</b><br/>
				Approved By: <b>' + ISNULL(@ControllerFullName, '') + '</b>'

		SET @MailSubject = 'Assignment change APPROVED for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')
		SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
		EXEC dbo.xp_smtp_sendmail 
			@from = @ControllerEmail,
			@from_name = @ControllerFullName,
			@to = @MailTo, 
			@subject = @MailSubject,
			@message = @MailBody, 
			@type = 'text/html', 
			@server = @MailServer

	END ELSE BEGIN

		--IF @Command = 'N' BEGIN
		IF @Command = 'N' OR @Command = 'NO' BEGIN

			BEGIN TRAN

				-- Mark the request denied
				UPDATE 
					QCheck_Approval_ChangeRequests
				SET 
					Rejected = 0,
					RejectedUser = @ControllerUserID,
					RejectedDate = GETDATE(),
					IsActive = 0
				WHERE
					[ID] = @ChangeID

				-- 2/10/2012 dalvarado
				-- Delete any other outstanding changes for this checklist
				-- This change is per GPR
				SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
			
				UPDATE
					QCheck_Approval_ChangeRequests
				SET
					IsActive = 0,
					Rejected = 1,
					RejectedDate = GETDATE(),
					RejectedUser = @ControllerUserID
				WHERE
					IsActive = 1
					AND ReadyForSupervisor = 1
					AND Approved = 0
					AND Rejected = 0
					AND [ID] < @ChangeID
					AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID

			COMMIT TRAN

			-- Send the denied e-mail
			SET @MailBody = 'Your request for an assignment change has been denied.  This task must be completed by the current assignees.<br/><br/>
					Task: <b>' + ISNULL(@TaskName, '') + '</b><br/>
					Assignees: <b>' + ISNULL(@CurrentAssigneeList, '') + '</b><br/>
					Controllers: <b>' + ISNULL(@Controllers, '') + '</b><br/>
					Denied By: <b>' + ISNULL(@ControllerFullName, '') + '</b>'

			SET @MailSubject = 'Assignment change DENIED for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')
			SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
			EXEC dbo.xp_smtp_sendmail 
				@from = @ControllerEmail,
				@from_name = @ControllerFullName,
				@to = @MailTo, 
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

		END ELSE BEGIN

			-- Send the "unknown command" e-mail
			SET @MailBody = 'Your command "' + ISNULL(@Command, '') + '" was not recognized.<br/><br/>Please do not reply to this e-mail, reply to the original request.'
			SET @MailSubject = @AppName + ' - Requested Assignment Change'
	
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

		END

	END

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_NewChangeRequest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_NewChangeRequest] (
	@RequestingUserID INT,
	@Comment VARCHAR(1000),
	@ChangeID INT OUTPUT
) AS

BEGIN TRAN

	INSERT INTO QCheck_Approval_ChangeRequests ( RequestingUser, Comment ) VALUES ( @RequestingUserID, @Comment )
	SET @ChangeID = @@IDENTITY

COMMIT TRAN

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_NewChangeRequestItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_NewChangeRequestItem] (
	@ChangeRequestID INT,
	@ItemID INT OUTPUT
) AS

BEGIN

	BEGIN TRAN

		INSERT INTO QCheck_Approval_ChangeRequestItems (
			ChangeRequestID
		) VALUES (
			@ChangeRequestID
		)
	
		SET @ItemID = @@IDENTITY

	COMMIT TRAN

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_NewDeadline]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_NewDeadline] (
	@ActiveChecklistID INT,
	@NewDueTime DATETIME,
	@UserID INT,
	@Comment VARCHAR(1000) = ''
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ChangeID INT,
		@FullName VARCHAR(50),
		@TaskName VARCHAR(500),
		@CurrentDueTime DATETIME,
		@i INT,
		@count INT,
		@RequestorEmail VARCHAR(500),
		@MailFrom VARCHAR(500), 
		@MailCC VARCHAR(1000),
		@MailTo VARCHAR(5000), 
		@MailSubject VARCHAR(1000),
		@MailBody VARCHAR(5000),
		@AppPath VARCHAR(50),
		@ChecklistID INT
	
	-- Get the path 
	SELECT @AppPath = AppURL 
	FROM QCheck_AppSettings S
	INNER JOIN QCheck_Users U
		ON S.[ID] = U.App
	WHERE U.[ID] = @UserID

	-- Create a new change request
	EXEC QCheck_Approval_NewChangeRequest @UserID, @Comment, @ChangeID OUTPUT

	
	-- Add the change to ActiveChecklists
	INSERT INTO QCheck_Approval_ActiveChecklists (
		ChangeRequestID,
		ActiveChecklistID,
		InstanceID,
		DueTime,
		OrigDueTime,
		ReminderDate,
		CompletedDate,
		HasNaggedDue,
		CompletedBy
	)
		SELECT 
			@ChangeID,
			[ID],
			InstanceID,
			@NewDueTime,
			OrigDueTime,
			ReminderDate,
			CompletedDate,
			HasNaggedDue,
			CompletedBy
		FROM
			QCheck_ActiveChecklists
		WHERE
			[ID] = @ActiveChecklistID

	-- Mark the change as ready for the supervisor
	UPDATE QCheck_Approval_ChangeRequests SET ReadyForSupervisor = 1 WHERE [ID] = @ChangeID

	-- Send e-mails requesting approval for the due date change
	SELECT @FullName = FullName, @RequestorEmail = Email FROM QCheck_Users WHERE [ID] = @UserID
	SET @MailFrom = '"' + @FullName + '"' + ' <' + @RequestorEmail + '>'
	
	SELECT 
		@ChecklistID = c.[ID],
		@TaskName = c.[Name],
		@CurrentDueTime = ac.DueTime
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.[ID]
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = ci.[ID]
	WHERE
		ac.[ID] = @ActiveChecklistID
	
	
	
	SET @MailSubject = 'Extension request - ' + ISNULL(@FullName, '') + ' - "' + ISNULL(@TaskName, '') + '"'

	declare @extensioncount int = 0
	select @extensioncount = count(a.ID) 
	from QCheck_Approval_ActiveChecklists a
		inner join QCheck_Approval_ChangeRequests r
		on a.ChangeRequestID = r.id
		and (r.approved = 1 or r.id = @ChangeID)-- count prior approved + this one
		and a.ActivechecklistID = @ActiveChecklistID

	declare @OrigDueTime datetime
	select @OrigDueTime = OrigDueTime from qcheck_activechecklists
	where ID = @ActiveChecklistID

	declare @days int = datediff(day, @OrigDueTime, @NewDueTime)

	declare @extensionmessage varchar(1000) = ''


	if @days > 30 or @extensioncount > 3
	begin
		select @extensionmessage = '<span style="color:red;font-weight:bold;">'
		select @MailSubject = '*** LONG TERM EXTENSION ***' + @MailSubject
		if @days > 30 
		begin
			select @extensionmessage = @extensionmessage + '*** This task has been extended more than 30 days past its original deadline! ***<br>'
		end
		if @extensioncount > 3
		begin
			select @extensionmessage = @extensionmessage + '*** This task has been extended more than 3 times! ***'
		end
		select @extensionmessage = @extensionmessage + '</span><br><br>'
	end

	SET @MailBody = @extensionmessage + '<table border="0"><tr><td>Current Due: </td><td><b>' + ISNULL(CONVERT(VARCHAR(20), @CurrentDueTime), '') + '</b></td></tr>' +
			'<tr><td>Requested Due: </td><td><b>' + ISNULL(CONVERT(VARCHAR(20), @NewDueTime), '') + '</b></td></tr></table><br/><br/>' +
			'<table border="0"><tr><td>Comment: <b>' + ISNULL(@Comment, '') + '</b><br/><br/>' +
			'To approve this new due date, reply to this e-mail with "Y".  To reject the change, reply to this e-mail with "N".  The "Y" or "N" must be on the first line of the reply.  To set a different due date, click <a href="' + ISNULL(@AppPath, '') + '/ManageSingleChecklist.aspx?type=1&id=' + ISNULL(CONVERT(VARCHAR(20), @ActiveChecklistID), '') + '&ChangeID=' + ISNULL(CONVERT(VARCHAR(20), @ChangeID), '') + '">here</a>.<br/><br/>If you want to include a comment, copy ' + ISNULL(@Fullname, '') + ' on the reply and put your comment below the first line.</td></tr></table><br/><br/>' +
			'<span style="color: white;">ActiveChecklistID:' + ISNULL(CONVERT(VARCHAR(20), @ActiveChecklistID), '') + '|NewDueTime:' + ISNULL(CONVERT(VARCHAR(20), @NewDueTime), '') + '|ChangeID:' + ISNULL(CONVERT(VARCHAR(20), @ChangeID), '') + '|[ID1]</span>'
	
	SET @MailBody = @MailBody + '<br><br><br><h3>Deadline history for this task</h3>'
	SET @MailBody = @MailBody + '<table border="1" cellpadding="5" cellspacing="0"><tr><th>&nbsp;</th><th>Deadline</th><th>Comment</th><th>Requested By</th><th>Requested Date</th></tr>'

	SELECT @MailBody = @MailBody + 
		'<tr>' +
		'<td><b>Requested Change</b></td>' +
		'<td>' + ISNULL(CONVERT(VARCHAR(20), aac.DueTime), '&nbsp;') + '</td>' +
		'<td>' + ISNULL(cr.Comment, '&nbsp;') + '</td>' +
		'<td>' + ISNULL(u.FullName, '&nbsp;') + '</td>' +
		'<td>' + ISNULL(CONVERT(VARCHAR(20), cr.RequestDate), '&nbsp;') + '</td>' +
		'</tr>'
	FROM
		QCheck_Approval_ActiveChecklists aac
		INNER JOIN QCheck_Approval_ChangeRequests cr
			ON aac.ChangeRequestID = cr.ID
		INNER JOIN QCheck_Users u
			ON cr.RequestingUser = u.ID
	WHERE
		aac.ActiveChecklistID = @ActiveChecklistID
		AND cr.ID <> @ChangeID
		AND cr.Approved = 1
	ORDER BY
		cr.ApprovedDate DESC
	
	SELECT @MailBody = @MailBody + '<tr><td><b>Original Deadline</b></td><td>' + ISNULL(CONVERT(VARCHAR(20), OrigDueTime), '&nbsp;') + '</td><td colspan="3">&nbsp;</td></tr>'
	FROM QCheck_ActiveChecklists
	WHERE ID = @ActiveChecklistID
	
	SET @MailBody = @MailBody + '</table>'
	
	SELECT @MailTo = dbo.[QCheck_ChecklistExtensionControllerEmails](@ChecklistID, DEFAULT)

	EXEC dbo.xp_smtp_sendmail 
		@from = @RequestorEmail, 
		@From_Name = @FullName,
		@replyto = @AutomationAddress,
		@to = @MailTo, 
		@cc = @RequestorEmail,
		@subject = @MailSubject,
		@message = @MailBody, 
		@type = 'text/html', 
		@server = @MailServer

	SET @i = @i + 1

END



GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_NewDeadline_NotifyChange]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_NewDeadline_NotifyChange] (
	@ChangeID INT,
	@NewDueTime DATETIME,
	@ControllerUserID INT
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ControllerEmail VARCHAR(50),
		@ControllerFullName VARCHAR(500),
		@ActiveChecklistID INT,
		@CurrentDueTime DATETIME,
		@MailBody VARCHAR(5000),
		@RequestorEmail VARCHAR(500),
		@TaskName VARCHAR(500),
		@ChecklistID INT,
		@MailTo VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000)
		
	SET @MailFrom = @AppName + '-ChangeRequest<' + REPLACE(@FromAddress, @AppName, @AppName + '-ChangeRequest') + '>'

	-- Get supervisor info
	SELECT 
		@ControllerEmail = Email,
		@ControllerFullName = FullName
	FROM 
		QCheck_Users
	WHERE 
		[ID] = @ControllerUserID

	-- Get the requestor info
	SELECT 
		@RequestorEmail = Email 
	FROM 
		QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE
		CR.[ID] = @ChangeID

	-- Get requested change info
	SELECT 
		@ActiveChecklistID = ActiveChecklistID,
		@NewDueTime = DueTime
	FROM 
		QCheck_Approval_ActiveChecklists
	WHERE 
		ChangeRequestID = @ChangeID

	-- Get task info
	SELECT 
		@ChecklistID = c.[ID],
		@TaskName = c.[Name],
		@CurrentDueTime = ac.DueTime
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.[ID]
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = ci.[ID]
	WHERE
		ac.[ID] = @ActiveChecklistID


	-- Mark the request approved
	UPDATE 
		QCheck_Approval_ChangeRequests
	SET 
		Approved = 1,
		ApprovedUser = @ControllerUserID,
		ApprovedDate = GETDATE(),
		IsActive = 0
	WHERE
		[ID] = @ChangeID

	-- Get the e-mail recipients.  E-mails go to the requestor and all controllers
	-- except the one who approved the change
	SET @MailTo = @RequestorEmail + ';' + dbo.QCheck_ChecklistControllerEmails(@ChecklistID, @ControllerUserID)
	
	
	-- Send the approved e-mail
	SET @MailBody = 'Your request for a deadline change has been approved with changes.<br/><br/>
			Task: <b>' + ISNULL(@TaskName, '') + '</b><br/>
			New Deadline: <b>' + ISNULL(CONVERT(VARCHAR(20), @NewDueTime), '') + '</b><br/>
			Approved By: <b>' + ISNULL(@ControllerFullName, '') + '</b>'

	SET @MailSubject = 'New Due Date APPROVED WITH CHANGES for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullname, '')
	SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
	EXEC dbo.xp_smtp_sendmail 
		@from = @ControllerEmail,
		@from_name = @ControllerFullName,
		@to = @MailTo, 
		@subject = @MailSubject,
		@message = @MailBody, 
		@type = 'text/html', 
		@server = 'SMTPGATEWAY'

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_NewDeadline_Process]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_NewDeadline_Process] (
	@Command VARCHAR(5000),
	@ChangeID INT,
	@ControllerEmail VARCHAR(500),
	@EmailedTo VARCHAR(500) = '',
	@EmailedCC VARCHAR(500) = ''
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ControllerUserID INT,
		@ControllerFullName VARCHAR(500),
		@ControllerShortName VARCHAR(500),
		@ActiveChecklistID INT,
		@NewDueTime DATETIME,
		@CurrentDueTime DATETIME,
		@MailBody VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000),
		@RequestorEmail VARCHAR(500),
		@TaskName VARCHAR(500),
		@MailTo VARCHAR(5000),
		@ChecklistID INT,
		@TempCount INT,
		@ChangeChecklistID INT,
		@Controllers varchar(1000),
		@Assignees varchar(1000)
		
	SET @MailFrom = @AppName + '-ChangeRequest<' + REPLACE(@FromAddress, @AppName, @AppName + '-ChangeRequest') + '>'

	-- Get supervisor info
	SELECT 
		@ControllerUserID = [ID],
		@ControllerFullName = FullName,
		@ControllerShortName = ShortName
	FROM 
		QCheck_Users
	WHERE 
		Email = @ControllerEmail
		AND IsDeleted = 0

	-- Get the requestor info
	SELECT 
		@RequestorEmail = Email 
	FROM 
		QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE
		CR.[ID] = @ChangeID

	-- Get requested change info
	SELECT 
		@ActiveChecklistID = ActiveChecklistID,
		@NewDueTime = DueTime
	FROM 
		QCheck_Approval_ActiveChecklists
	WHERE 
		ChangeRequestID = @ChangeID

	-- Get task info
	SELECT 
		@TaskName = c.[Name],
		@CurrentDueTime = ac.DueTime,
		@ChecklistID = c.[ID],
		@Controllers = isnull(dbo.QCheck_ManagersList(c.id), ''),
		@Assignees = isnull(dbo.QCheck_AssigneesList(ci.id), '')
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.[ID]
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = ci.[ID]
	WHERE
		ac.[ID] = @ActiveChecklistID

	-- Check to see if the email is from a controller on this request
	-- added 12/28/2011 2:30PM (Son Tran)
	SELECT 
		@TempCount = COUNT(*)
	FROM
		QCheck_ChecklistManagers cm (nolock)
		INNER JOIN QCheck_Groups g (nolock)
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm (nolock)
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u (nolock)
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.Email = @ControllerEmail
	
	IF @TempCount = 0 
		BEGIN
			SET @MailBody = 'You are not allowed to approve the request for the task "' + ISNULL(@TaskName, 'NULL') + '" because you are not a controller on this task.'
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = 'Unauthorized approval request',
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

			RETURN
		END

	-- Get the e-mail recipients.  E-mails go to the requestor and all controllers
	-- except the one who sent the e-mail we're processing
	DECLARE @Duplicates VARCHAR(1000) = isnull(@EmailedTo, '') + ';' + isnull(@EmailedCC, '')
	SET @MailTo = @RequestorEmail + ';' + dbo.QCheck_ChecklistControllerEmailsWithoutDuplicates(@ChecklistID, @ControllerUserID, @Duplicates)


	-- Process the command
	SET @Command = UPPER(@Command)
	IF @Command = 'Y' OR @Command = 'YES' OR @Command = 'YS' BEGIN

		BEGIN TRAN
		
			-- Needed for grading--this logs due date changes
			INSERT INTO QStatus_DueDateChanges (
				ActiveChecklistID, 
				DueDateOld, 
				UpdateDT,
				ChangedBy
			)
				SELECT
					C.ID,
					C.DueTime,
					GETDATE(),
					@ControllerShortName
				FROM 	
					QCheck_ActiveChecklists C
				WHERE	
					[ID] = @ActiveChecklistID
		
	
			-- Change the due date
			UPDATE 
				QCheck_ActiveChecklists
			SET
				DueTime = @NewDueTime
			WHERE
				[ID] = @ActiveChecklistID
	
			-- Mark the request approved
			UPDATE 
				QCheck_Approval_ChangeRequests
			SET 
				Approved = 1,
				ApprovedUser = @ControllerUserID,
				ApprovedDate = GETDATE(),
				IsActive = 0
			WHERE
				[ID] = @ChangeID

			-- 2/10/2012 dalvarado
			-- Delete any other outstanding changes for this checklist
			-- This change is per GPR
			SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
		
			UPDATE
				QCheck_Approval_ChangeRequests
			SET
				IsActive = 0,
				Rejected = 1,
				RejectedDate = GETDATE(),
				RejectedUser = @ControllerUserID
			WHERE
				IsActive = 1
				AND ReadyForSupervisor = 1
				AND Approved = 0
				AND Rejected = 0
				AND [ID] < @ChangeID
				AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID
			

		COMMIT TRAN

		-- Send the approved e-mail
		SET @MailBody = 'Your requested for a deadline change has been approved.<br/><br/>
				Task: <b>' + ISNULL(@TaskName, 'NULL') + '</b><br/>
				New Deadline: <b>' + ISNULL(CONVERT(VARCHAR(20), @NewDueTime), '') + '</b><br/>
				Approved By: <b>' + ISNULL(@ControllerFullName, '') + '</b><br/>
				Assignees: <b>' + ISNULL(@Assignees, '') + '</b><br/>
				Controllers: <b>' + ISNULL(@Controllers, '') + '</b>'

		SET @MailSubject = 'Deadline change APPROVED for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')
		SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
		EXEC dbo.xp_smtp_sendmail 
			@from = @ControllerEmail,
			@from_name = @ControllerFullName,
			@to = @MailTo, 
			@subject = @MailSubject,
			@message = @MailBody, 
			@type = 'text/html', 
			@server = @MailServer

	END ELSE BEGIN

		IF @Command = 'N' OR @Command = 'NO' BEGIN

			-- Mark the request denied
			UPDATE 
				QCheck_Approval_ChangeRequests
			SET 
				Rejected = 0,
				RejectedUser = @ControllerUserID,
				RejectedDate = GETDATE(),
				IsActive = 0
			WHERE
				[ID] = @ChangeID

			-- 2/10/2012 dalvarado
			-- Delete any other outstanding changes for this checklist
			-- This change is per GPR
			SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
		
			UPDATE
				QCheck_Approval_ChangeRequests
			SET
				IsActive = 0,
				Rejected = 1,
				RejectedDate = GETDATE(),
				RejectedUser = @ControllerUserID
			WHERE
				IsActive = 1
				AND ReadyForSupervisor = 1
				AND Approved = 0
				AND Rejected = 0
				AND [ID] < @ChangeID
				AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID

			-- Send the denied e-mail
			SET @MailBody = 'Your requested for a deadline change has been denied.  This task must be completed by the current deadline.<br/><br/>
					Task: <b>' + ISNULL(@TaskName, 'NULL') + '</b><br/>
					Deadline: <b>' + ISNULL(CONVERT(VARCHAR(20), @CurrentDueTime), '') + '</b><br/>
					Denied By: <b>' + ISNULL(@ControllerFullName, '') + '</b><br/>
					Assignees: <b>' + ISNULL(@Assignees, '') + '</b><br/>
					Controllers: <b>' + ISNULL(@Controllers, '') + '</b>'

			SET @MailSubject = 'Deadline change DENIED for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')
			SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
			EXEC dbo.xp_smtp_sendmail 
				@from = @ControllerEmail,
				@from_name = @ControllerFullName,
				@to = @MailTo, 
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

		END ELSE BEGIN

			-- Send the "unknown command" e-mail
			SET @MailBody = 'Your command "' + ISNULL(@Command, '') + '" was not recognized.<br/><br/>Please do not reply to this e-mail, reply to the original request.'
			SET @MailSubject = @AppName + ' - Requested Due Date Change'
			
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

		END

	END

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_RejectChange]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_RejectChange] (
	@ChangeID INT,
	@UserID INT,
	@Reason VARCHAR(MAX) = '',
	@EmailedTo VARCHAR(500) = '',
	@EmailedCC VARCHAR(500) = ''
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ControllerFullName VARCHAR(500),
		@ControllerEmail VARCHAR(500),
		@MailBody VARCHAR(5000),
		@RequestorEmail VARCHAR(500),
		@RequestorFullName VARCHAR(500),
		@TaskName VARCHAR(500),
		@ChecklistID INT,
		@MailTo VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000),
		@ChangeChecklistID INT,
		@Changed VARCHAR(5000) = '',
		@Added VARCHAR(5000) = '',
		@Removed VARCHAR(5000) = ''
		
	CREATE TABLE #Changed (
		Seq INT,
		Item VARCHAR(1000),
		[Current] VARCHAR(1000),
		Requested VARCHAR(1000),
		CRItemID INT,
		Approved BIT
	)
	
	CREATE TABLE #Added (
		Seq INT,
		Item VARCHAR(1000),
		Requested VARCHAR(1000),
		CRItemID INT,
		Approved BIT
	)
	
	CREATE TABLE #Removed (
		Seq INT,
		Item VARCHAR(1000),
		Requested VARCHAR(1000),
		CRItemID INT,
		Approved BIT
	)
	
	INSERT INTO #Changed EXEC QCheck_Approval_CRChanged @ChangeID
	INSERT INTO #Added EXEC QCheck_Approval_CRAdded @ChangeID
	INSERT INTO #Removed EXEC QCheck_Approval_CRRemoved @ChangeID
	
	SELECT @Changed = @Changed + '<tr><td style="border-top: 1px solid #CCCCCC;">' + Item + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + [Current] + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + Requested + '&nbsp;</td></tr>' FROM #Changed
	SELECT @Added = @Added + '<tr><td style="border-top: 1px solid #CCCCCC;">' + Item + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + Requested + '&nbsp;</td></tr>' FROM #Added
	SELECT @Removed = @Removed + '<tr><td style="border-top: 1px solid #CCCCCC;">' + Item + '&nbsp;</td><td style="border-top: 1px solid #CCCCCC;">' + Requested + '&nbsp;</td></tr>' FROM #Removed
	
	IF LEN(@Changed) > 0 SET @Changed = '<h3 style="color:#003366;">Changed</h3><table border="0" cellpadding="3" cellspacing="0"><tr><th width="200"></th><th width="400" align="left">Current</th><th width="400" align="left">Requested</th></tr>' + @Changed + '</table>'
	IF LEN(@Added) > 0 SET @Added = '<h3 style="color:#003366;">Added</h3><table border="0" cellpadding="3" cellspacing="0"><tr><th width="200"></th><th width="800" align="left">Requested</th></tr>' + @Added + '</table>'
	IF LEN(@Removed) > 0 SET @Removed = '<h3 style="color:#003366;">Removed</h3><table border="0" cellpadding="3" cellspacing="0"><tr><th width="200"></th><th width="800" align="left">Requested</th></tr>' + @Removed + '</table>'
	

	-- Mark the change rejected
	UPDATE 
		QCheck_Approval_ChangeRequests
	SET
		Rejected = 1,
		RejectedUser = @UserID,
		RejectedDate = GETDATE(),
		IsActive = 0
	WHERE
		[ID] = @ChangeID

	-- 2/10/2012 dalvarado
	-- Delete any other outstanding changes for this checklist
	-- This change is per GPR
	SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)

	
	UPDATE
		QCheck_Approval_ChangeRequests
	SET
		IsActive = 0,
		Rejected = 1,
		RejectedDate = GETDATE(),
		RejectedUser = @UserID
	WHERE
		IsActive = 1
		AND ReadyForSupervisor = 1
		AND Approved = 0
		AND Rejected = 0
		AND [ID] < @ChangeID
		AND ID in (SELECT ChangeRequestID 
					FROM QCheck_Approval_ChangeRequestChecklist 
					WHERE ID = @ChangeChecklistID)

	-- Get the requestor info
	SELECT 
		@RequestorEmail = Email 
	FROM 
		QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE
		CR.[ID] = @ChangeID

	-- Get the task name and checklist ID
	SELECT @TaskName =  dbo.QCheck_Approval_CRChecklistName(@ChangeID)
	SELECT @ChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)

	-- Get the supervisor's name
	SELECT
		@ControllerFullName = FullName, @ControllerEmail = Email
	FROM 
		QCheck_Users
	WHERE 
		[ID] = @UserID

	-- Get the e-mail recipients.  E-mails go to the requestor and all controllers
	-- except the one who rejected the change
	DECLARE @Duplicates VARCHAR(1000) = isnull(@EmailedTo, '') + ';' + isnull(@EmailedCC, '')
	SET @MailTo = isnull(@RequestorEmail + ';', '') + ISNULL(dbo.QCheck_ChecklistControllerEmailsWithoutDuplicates(@ChecklistID, @UserID, @Duplicates), '')

	-- Set up the rejected message
	SET @MailBody = 'Your requested change has been denied.<br/><br/>
				Task: <b>' + ISNULL(@TaskName, '') + '</b><br/>
				Denied By: <b>' + ISNULL(@ControllerFullName, '') + '</b><br/>' +
				CASE WHEN @Reason = '' THEN '<br/>' ELSE 'Reason: <b>' + @Reason + '</b><br/><br/>' END +
				@Changed +
				@Added + 
				@Removed

	SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
	SET @MailSubject = 'Change(s) DENIED for task "' + ISNULL(@TaskName, '') + '" by ' + ISNULL(@ControllerFullName, '')
	
	EXEC dbo.xp_smtp_sendmail 
		@from = @ControllerEmail,
		@from_name = @ControllerFullName,
		@to = @MailTo, 
		@subject = @MailSubject,
		@message = @MailBody, 
		@type = 'text/html', 
		@server = @MailServer
		
	DROP TABLE #Changed
	DROP TABLE #Added
	DROP TABLE #Removed

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_RequestedAssignments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_RequestedAssignments] (
--DECLARE
	@ChangeID INT,-- = 77773,
	@ShowAll BIT = 0	
) AS

--77773 - Jackie Grant, Mobile Dog Groomers
--79495 - Keith Shannon, Increasing Productivity - IT
--78860 - Tim Germany, Petty Cash Audit

BEGIN

	--Get the itemized changes (to use later)
	DECLARE @Changes TABLE (
		Seq int,
		Item VARCHAR(500),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)	

	INSERT INTO @Changes EXECUTE QCheck_Approval_CRAdded_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRRemoved_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRChanged_Natural @ChangeID

	DECLARE @RequestedAssignments TABLE
	(
		ChecklistID int,
		ChecklistName varchar(500),
		Controllers varchar(2000),
		InstanceID int,
		AssigneeList varchar(2000),
		ScheduleString varchar(2000)
	)

	--After - All instances with assignees and schedules
	INSERT INTO @RequestedAssignments
	(
		ChecklistID,
		ChecklistName,
		Controllers,
		InstanceID,
		AssigneeList,
		ScheduleString
	)
	SELECT c.ID, ISNULL(ac.Name, c.Name) ChecklistName, 
		dbo.QStatus_Approval_GetChecklistControllers(c.ID, cr.ID) Controllers,
		ci.ID,
		dbo.QCheck_Approval_AssigneesList(cr.ID, ci.ID) AS AssigneesList, 
		dbo.QCheck_Approval_ScheduleString(cr.ID, ci.ScheduleID, ci.ID) AS Schedule
	FROM QCheck_Approval_ChangeRequests cr
	JOIN QCheck_Approval_ChangeRequestChecklist crc
		ON crc.ChangeRequestID = cr.ID
	LEFT JOIN QCheck_Approval_Checklists ac
		ON ac.ChangeRequestID = cr.ID
		AND ac.ChecklistID = crc.id
	JOIN QCheck_Checklists c
		ON c.ID = crc.id
	JOIN QCheck_ChecklistInstances ci
		ON ci.ChecklistID = c.ID
		AND ci.IsDeleted = 0
		AND NOT EXISTS (--do not include any instances for which we are adding a new schedule; the union statement will get those
			select 'Y' from QCheck_Approval_Schedule asch2 
			where asch2.ChangeRequestID = cr.ID
			AND asch2.ScheduleID = -1
			AND asch2.instanceid = ci.ID)
	LEFT JOIN QCheck_Approval_ChecklistInstances aci
		ON aci.ChangeRequestID = cr.ID
		AND aci.InstanceID = ci.ID
	--These joins restrict to instances referenced by parts of the change request 
	--(instance, assignment, schedule or active checklist)
	LEFT JOIN QCheck_Approval_Assignments aa
		ON aa.InstanceID = ci.ID
		AND aa.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_Schedule asch
		ON (asch.InstanceID IS NULL --only get changes to existing schedules
			AND asch.ScheduleID = ci.ScheduleID)
		AND asch.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_ActiveChecklists aac
		ON aac.InstanceID = ci.ID
		AND aac.CRItemID IN (Select CRItemID From @Changes)
	WHERE cr.ID = @ChangeID
		AND (aci.IsDeleted IS NULL OR aci.IsDeleted = 0)
		--At least one of the joined CR tables referencing an instance must have data, or else don't show it
		AND (
			@ShowAll = 1
			OR aci.ID IS NOT NULL
			OR aa.ID IS NOT NULL
			OR asch.ID IS NOT NULL
			OR aac.ID IS NOT NULL
		)				
	UNION
	SELECT crc.ID, ISNULL(ac.Name, c.Name) ChecklistName, 
		dbo.QStatus_Approval_GetChecklistControllers(c.ID, cr.ID) Controllers,
		asch.instanceid,
		dbo.QCheck_Approval_AssigneesList(cr.ID, asch.instanceid) AS AssigneesList, 
		dbo.QCheck_Approval_ScheduleString(cr.ID, asch.ScheduleID, asch.instanceid) AS Schedule		
	FROM QCheck_Approval_ChangeRequests cr
	JOIN QCheck_Approval_ChangeRequestChecklist crc
		ON crc.ChangeRequestID = cr.ID
	LEFT JOIN QCheck_Approval_Checklists ac
		ON ac.ChangeRequestID = cr.ID
		AND ac.ChecklistID = crc.id
	JOIN QCheck_Checklists c
		ON c.ID = crc.id
	JOIN QCheck_Approval_Schedule asch
		ON asch.ChangeRequestID = cr.ID
		AND asch.ScheduleID = -1
		AND asch.instanceid IS NOT NULL		
	WHERE cr.ID = @ChangeID

	--Ensure that at least one row for the Checklist Name and Controllers exists
	IF (select COUNT(*) FROM @RequestedAssignments) = 0
		INSERT INTO @RequestedAssignments
		(
			ChecklistID,
			ChecklistName,
			Controllers,
			InstanceID,
			AssigneeList,
			ScheduleString
		)
		SELECT c.ID, ISNULL(ac.Name, c.Name) ChecklistName, 
			dbo.QStatus_Approval_GetChecklistControllers(c.ID, cr.ID) Controllers,
			0, '(No Assignee Changes)', '(No Schedule Changes)'
		FROM QCheck_Approval_ChangeRequests cr
		JOIN QCheck_Approval_ChangeRequestChecklist crc
			ON crc.ChangeRequestID = cr.ID
		LEFT JOIN QCheck_Approval_Checklists ac
			ON ac.ChangeRequestID = cr.ID
			AND ac.ChecklistID = crc.id
		JOIN QCheck_Checklists c
			ON c.ID = crc.id
		JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.ID
			AND ci.IsDeleted = 0
		WHERE cr.ID = @ChangeID

	SELECT * FROM @RequestedAssignments

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_RequestedItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_Approval_RequestedItems] (
--DECLARE
	@ChangeID INT
) AS

--77773 - Jackie Grant, Mobile Dog Groomers
--79495 - Keith Shannon, Increasing Productivity - IT
--78860 - Tim Germany, Petty Cash Audit

BEGIN

	Select c.ID ChecklistID, 
		ai.ItemID ItemID, 
		ai.SequenceNum, 
		ai.ItemTypeID, 
		ait.Name ItemTypeName, 
		ai.Text, 
		ai.URL
	FROM QCheck_Approval_ChangeRequestChecklist crc
	JOIN QCheck_Checklists c
		ON c.ID = crc.id
	LEFT JOIN QCheck_Approval_Items ai
		ON ai.ChangeRequestID = crc.ChangeRequestID
		AND ai.ChecklistID = c.ID
		AND ai.IsDeleted = 0
	JOIN QCheck_ItemTypes ait
		ON ait.ID = ai.ItemTypeID
	WHERE crc.ChangeRequestID = @ChangeID
		AND (ai.IsDeleted IS NULL OR ai.IsDeleted = 0)
	ORDER BY ai.SequenceNum	

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_Schedule_UPDATE]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_Approval_Schedule_UPDATE] (
	@InstanceID INT,
	@FirstDueDate DATETIME,
	@LastDueDate DATETIME = NULL,
	@FreqType INT,
	@FreqInterval INT = NULL,
	@FreqRecurrance INT = NULL,
	@DueTime FLOAT,
	@BusDayBehavior INT = 0,
	@SoftDueOffsetDays INT = 0,
	@ChangeID INT = NULL
) AS

BEGIN
	UPDATE
		QCheck_Approval_Schedule
	SET
		FirstDueDate = @FirstDueDate,
		LastDueDate = @LastDueDate,
		FreqType = @FreqType,
		FreqInterval = @FreqInterval,
		FreqRecurrance = @FreqRecurrance,
		DueTime = @DueTime,
		BusDayBehavior = @BusDayBehavior,
		SoftDueOffsetDays = @SoftDueOffsetDays
	FROM
		QCheck_Approval_Schedule S
		INNER JOIN QCheck_ChecklistInstances CI
			ON S.ScheduleID = CI.ScheduleID
	WHERE
		CI.[ID] = @InstanceID
		
	IF @@rowcount = 0
	BEGIN
		UPDATE QCheck_Approval_Schedule
		SET
		FirstDueDate = @FirstDueDate,
		LastDueDate = @LastDueDate,
		FreqType = @FreqType,
		FreqInterval = @FreqInterval,
		FreqRecurrance = @FreqRecurrance,
		DueTime = @DueTime,
		BusDayBehavior = @BusDayBehavior,
		SoftDueOffsetDays = @SoftDueOffsetDays
		WHERE ChangeRequestID = @ChangeID
			AND InstanceID = @InstanceID
		
		IF @@rowcount = 0
		BEGIN
			INSERT INTO QCheck_Approval_Schedule
				(ChangeRequestID, scheduleID, firstduedate, lastduedate, freqtype, freqinterval, freqrecurrance, duetime, busdaybehavior, softdueoffsetdays, instanceID)
			SELECT 
				@ChangeID, -1, @FirstDueDate, @LastDueDate, @FreqType, @FreqInterval, @FreqRecurrance, @DueTime, @BusDayBehavior, @SoftDueOffsetDays, @InstanceID
		END
	END

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_SendRequest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Approval_SendRequest] (
--DECLARE
	@ChangeID INT,-- = 77773,
	@ShowAll BIT = 0,
	@ControllerEmail VARCHAR(500) = NULL,
	@Comment varchar(1000) = ''
) AS


BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @UserID INT,
		@FullName VARCHAR(50),
		@TaskName VARCHAR(500),
		@MailFrom VARCHAR(500), 
		@MailToController VARCHAR(1000), 
		@RequestorEmail VARCHAR(100),
		@MailSubject VARCHAR(1000),
		@MailBodyController VARCHAR(max),
		@MailBodyRequestor VARCHAR(max),
		@AppPath VARCHAR(50),
		@count INT,
		@i INT,
		@ChecklistID INT,
		@Changed VARCHAR(max) = '',
		@Added VARCHAR(max) = '',
		@Removed VARCHAR(max) = '',
		@ChangeCount INT = 0,
		@ReplyTo VARCHAR(max) = ''		
	
	if len(ltrim(rtrim(isnull(@Comment, '')))) > 0
	begin
		UPDATE QCheck_Approval_ChangeRequests
		SET Comment = @Comment
		WHERE [ID] = @ChangeID
	end

	-- ====================================================================================
	-- Send an e-mail to the requesting user's supervisor(s) notifying of the new change

	--New format:
	-- - Basic introduction
	-- - Current checklist
	-- - Itemized changes
	-- - New checklist (if approved)

	-- Get info about the change
	SELECT @UserID = cr.RequestingUser,
		@Comment = cr.Comment		
	FROM QCheck_Approval_ChangeRequests cr
	WHERE cr.[ID] = @ChangeID

	-- Get the path
	SELECT @AppPath = AppURL, 
		@FullName = FullName, 
		@RequestorEmail = Email
	FROM QCheck_AppSettings S
	INNER JOIN QCheck_Users U
		ON S.[ID] = U.App
	WHERE U.[ID] = @UserID

	-- Get the name of the checklist being changed
	SELECT @TaskName =  dbo.QCheck_Approval_CRChecklistName(@ChangeID)
	SELECT @ChecklistID =  dbo.QCheck_Approval_CRChecklistID(@ChangeID)
		
	-- Get the controller(s) e-mail address(es)
	SELECT @MailToController = ISNULL(@ControllerEmail, dbo.QCheck_ChecklistControllerEmails(@ChecklistID, DEFAULT))

	--Get the itemized changes (to use later)
	DECLARE @Changes TABLE (
		Seq int,
		Item VARCHAR(max),
		Requested VARCHAR(max),
		CRItemID INT,
		Approved BIT
	)	

	INSERT INTO @Changes EXECUTE QCheck_Approval_CRAdded_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRRemoved_Natural @ChangeID
	INSERT INTO @Changes EXECUTE QCheck_Approval_CRChanged_Natural @ChangeID

	IF (SELECT COUNT(*) FROM @Changes) = 0 RETURN

	--Little extra logic; only show the checklist items in the email if they have changed
	DECLARE	@ShowChecklists bit

	SELECT @ShowChecklists = CASE WHEN COUNT(*) = 0 THEN 0 ELSE 1 END
	FROM @Changes
	WHERE Requested LIKE '%item%checklist%' OR Requested LIKE '%checklist%item%'

	--Get the "current" and "as requested" checklist layout

	DECLARE @CurrentAssignments TABLE
	(
		ChecklistID int,
		ChecklistName varchar(500),
		Controllers varchar(2000),
		InstanceID int,
		AssigneeList varchar(2000),
		ScheduleString varchar(2000)
	)

	DECLARE @RequestedAssignments TABLE
	(
		ChecklistID int,
		ChecklistName varchar(500),
		Controllers varchar(2000),
		InstanceID int,
		AssigneeList varchar(2000),
		ScheduleString varchar(2000)
	)

	DECLARE @CurrentItems TABLE
	(
		ChecklistID int,
		ItemID int,
		SequenceNum int,
		ItemTypeID int,
		ItemTypeName varchar(100),
		Text varchar(max),
		URL varchar(2000)
	)

	DECLARE @RequestedItems TABLE
	(
		ChecklistID int,
		ItemID int,
		SequenceNum int,
		ItemTypeID int,
		ItemTypeName varchar(100),
		Text varchar(max),
		URL varchar(2000)
	)

	--Before - All instances with assignees and schedules
	INSERT INTO @CurrentAssignments
	(
		ChecklistID,
		ChecklistName,
		Controllers,
		InstanceID,
		AssigneeList,
		ScheduleString
	)
	SELECT DISTINCT c.ID, c.Name, 
		dbo.QStatus_GetChecklistControllers(c.ID) Controllers,
		ci.ID,
		dbo.QCheck_AssigneesList(ci.ID) AS AssigneesList, 
		dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule
	FROM QCheck_Approval_ChangeRequestChecklist crc
	JOIN QCheck_Checklists c
		ON crc.id = c.ID
	JOIN QCheck_ChecklistInstances ci
		ON ci.ChecklistID = c.ID
		AND ci.IsDeleted = 0
	LEFT JOIN QCheck_Schedule s
		ON s.ID = ci.ScheduleID		
	--These joins restrict to instances referenced by parts of the change request 
	--(instance, assignment, schedule or active checklist)
	LEFT JOIN QCheck_Approval_ChecklistInstances aci
		ON aci.InstanceID = ci.ID
		AND aci.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_Assignments aa
		ON aa.InstanceID = ci.ID
		AND aa.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_Schedule asch
		ON ((asch.InstanceID = ci.ID AND asch.ScheduleID = -1)
			OR asch.ScheduleID = s.ID)
		AND asch.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_ActiveChecklists aac
		ON aac.InstanceID = ci.ID
		AND aac.CRItemID IN (Select CRItemID From @Changes)
	WHERE crc.ChangeRequestID = @ChangeID
	--At least one of the joined CR tables must have data for the row, or else don't show it
	AND (
		@ShowAll = 1
		OR aci.ID IS NOT NULL
		OR aa.ID IS NOT NULL
		OR asch.ID IS NOT NULL
		OR aac.ID IS NOT NULL
	)
	ORDER BY ci.ID

	--Ensure that at least one row for the Checklist Name and Controllers exists
	IF (select COUNT(*) FROM @CurrentAssignments) = 0
		INSERT INTO @CurrentAssignments
		(
			ChecklistID,
			ChecklistName,
			Controllers,
			InstanceID,
			AssigneeList,
			ScheduleString
		)
		SELECT DISTINCT c.ID, c.Name, 
			dbo.QStatus_GetChecklistControllers(c.ID) Controllers,
			0, '(No Assignee Changes)', '(No Schedule Changes)'
		FROM QCheck_Approval_ChangeRequestChecklist crc
		JOIN QCheck_Checklists c
			ON crc.id = c.ID
		JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.ID
			AND ci.IsDeleted = 0
		WHERE crc.ChangeRequestID = @ChangeID

	--Before: Items
	INSERT INTO @CurrentItems
	(
		ChecklistID,
		ItemID,
		SequenceNum,
		ItemTypeID,
		ItemTypeName,
		Text,
		URL
	)
	Select c.ID ChecklistID, 
		i.ID ItemID, 
		i.SequenceNum, 
		i.ItemTypeID, 
		it.Name ItemTypeName, 
		i.Text, 
		i.URL
	FROM QCheck_Approval_ChangeRequestChecklist crc
	JOIN QCheck_Checklists c
		ON c.ID = crc.ID
	JOIN QCheck_Items i
		ON i.ChecklistID = c.ID
		AND i.IsDeleted = 0
	JOIN QCheck_ItemTypes it
		ON it.ID = i.ItemTypeID
	WHERE crc.ChangeRequestID = @ChangeID
	ORDER BY SequenceNum

	--After - All instances with assignees and schedules
	INSERT INTO @RequestedAssignments
	(
		ChecklistID,
		ChecklistName,
		Controllers,
		InstanceID,
		AssigneeList,
		ScheduleString
	)
	SELECT c.ID, ISNULL(ac.Name, c.Name) ChecklistName, 
		dbo.QStatus_Approval_GetChecklistControllers(c.ID, cr.ID) Controllers,
		ci.ID,
		dbo.QCheck_Approval_AssigneesList(cr.ID, ci.ID) AS AssigneesList, 
		dbo.QCheck_Approval_ScheduleString(cr.ID, ci.ScheduleID, ci.ID) AS Schedule
	FROM QCheck_Approval_ChangeRequests cr
	JOIN QCheck_Approval_ChangeRequestChecklist crc
		ON crc.ChangeRequestID = cr.ID
	LEFT JOIN QCheck_Approval_Checklists ac
		ON ac.ChangeRequestID = cr.ID
		AND ac.ChecklistID = crc.id
	JOIN QCheck_Checklists c
		ON c.ID = crc.id
	JOIN QCheck_ChecklistInstances ci
		ON ci.ChecklistID = c.ID
		AND ci.IsDeleted = 0
		AND NOT EXISTS (--do not include any instances for which we are adding a new schedule; the union statement will get those
			select 'Y' from QCheck_Approval_Schedule asch2 
			where asch2.ChangeRequestID = cr.ID
			AND asch2.ScheduleID = -1
			AND asch2.instanceid = ci.ID)
	LEFT JOIN QCheck_Approval_ChecklistInstances aci
		ON aci.ChangeRequestID = cr.ID
		AND aci.InstanceID = ci.ID
	--These joins restrict to instances referenced by parts of the change request 
	--(instance, assignment, schedule or active checklist)
	LEFT JOIN QCheck_Approval_Assignments aa
		ON aa.InstanceID = ci.ID
		AND aa.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_Schedule asch
		ON (asch.InstanceID IS NULL --only get changes to existing schedules
			AND asch.ScheduleID = ci.ScheduleID)
		AND asch.CRItemID IN (Select CRItemID From @Changes)
	LEFT JOIN QCheck_Approval_ActiveChecklists aac
		ON aac.InstanceID = ci.ID
		AND aac.CRItemID IN (Select CRItemID From @Changes)
	WHERE cr.ID = @ChangeID
		AND (aci.IsDeleted IS NULL OR aci.IsDeleted = 0)
		--At least one of the joined CR tables referencing an instance must have data, or else don't show it
		AND (
			@ShowAll = 1
			OR aci.ID IS NOT NULL
			OR aa.ID IS NOT NULL
			OR asch.ID IS NOT NULL
			OR aac.ID IS NOT NULL
		)				
	UNION
	SELECT crc.ID, ISNULL(ac.Name, c.Name) ChecklistName, 
		dbo.QStatus_Approval_GetChecklistControllers(c.ID, cr.ID) Controllers,
		asch.instanceid,
		dbo.QCheck_Approval_AssigneesList(cr.ID, asch.instanceid) AS AssigneesList, 
		dbo.QCheck_Approval_ScheduleString(cr.ID, asch.ScheduleID, asch.instanceid) AS Schedule		
	FROM QCheck_Approval_ChangeRequests cr
	JOIN QCheck_Approval_ChangeRequestChecklist crc
		ON crc.ChangeRequestID = cr.ID
	LEFT JOIN QCheck_Approval_Checklists ac
		ON ac.ChangeRequestID = cr.ID
		AND ac.ChecklistID = crc.id
	JOIN QCheck_Checklists c
		ON c.ID = crc.id
	JOIN QCheck_Approval_Schedule asch
		ON asch.ChangeRequestID = cr.ID
		AND asch.ScheduleID = -1
		AND asch.instanceid IS NOT NULL		
	WHERE cr.ID = @ChangeID

	--Ensure that at least one row for the Checklist Name and Controllers exists
	IF (select COUNT(*) FROM @RequestedAssignments) = 0
		INSERT INTO @RequestedAssignments
		(
			ChecklistID,
			ChecklistName,
			Controllers,
			InstanceID,
			AssigneeList,
			ScheduleString
		)
		SELECT c.ID, ISNULL(ac.Name, c.Name) ChecklistName, 
			dbo.QStatus_Approval_GetChecklistControllers(c.ID, cr.ID) Controllers,
			0, '(No Assignee Changes)', '(No Schedule Changes)'
		FROM QCheck_Approval_ChangeRequests cr
		JOIN QCheck_Approval_ChangeRequestChecklist crc
			ON crc.ChangeRequestID = cr.ID
		LEFT JOIN QCheck_Approval_Checklists ac
			ON ac.ChangeRequestID = cr.ID
			AND ac.ChecklistID = crc.id
		JOIN QCheck_Checklists c
			ON c.ID = crc.id
		JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.ID
			AND ci.IsDeleted = 0
		WHERE cr.ID = @ChangeID

	--After: Items
	INSERT INTO @RequestedItems
	(
		ChecklistID,
		ItemID,
		SequenceNum,
		ItemTypeID,
		ItemTypeName,
		Text,
		URL
	)
	Select c.ID ChecklistID, 
		ai.ItemID ItemID, 
		ai.SequenceNum, 
		ai.ItemTypeID, 
		ait.Name ItemTypeName, 
		ai.Text, 
		ai.URL
	FROM QCheck_Approval_ChangeRequestChecklist crc
	JOIN QCheck_Checklists c
		ON c.ID = crc.id
	LEFT JOIN QCheck_Approval_Items ai
		ON ai.ChangeRequestID = crc.ChangeRequestID
		AND ai.ChecklistID = c.ID
		AND ai.IsDeleted = 0
	JOIN QCheck_ItemTypes ait
		ON ait.ID = ai.ItemTypeID
	WHERE crc.ChangeRequestID = @ChangeID
		AND (ai.IsDeleted IS NULL OR ai.IsDeleted = 0)
	ORDER BY ai.SequenceNum

	DECLARE 
		@ChecklistName varchar(500),
		@Controllers varchar(2000),
		@InstanceID int,
		@AssigneeList varchar(2000),
		@ScheduleString varchar(2000),
		@ItemID int,
		@SequenceNum int,
		@ItemTypeID int,
		@ItemTypeName varchar(100),
		@Text varchar(max),
		@URL varchar(2000)
		--@ChecklistName varchar(200),
		--@CreateDate datetime,
		--@ItemType varchar(50),
		--@Text varchar(max),
		--@URL varchar(500),
		--@UserText varchar(max),
		--@CompletedBy varchar(50),
		--@CompletedDate datetime,
		--@ItemID int,
		--@UniqueID int,
		--@SequenceNum int,
		--@DueTime datetime,
		--@ReminderDate datetime,
		--@ActiveChkCompletedDate datetime,
		--@AssignmentID int,
		--@ChkType int,
		--@CompletedByID int,
		--@AssignedTo int,
		--@UpcomingID int,
		--@Recurring bit,
		--@ScheduleString varchar(500),
		--@Controllers varchar(500),
		--@StatusReportString varchar(max),
		--@Assignees varchar(500),
		--@IsDaily bit

	SET @MailBodyController = '<html><head>
	<style>
		body{
			font-family: Tahoma, Verdana;
		}

		table tbody td{
			padding: 3px;
		}

		.checklistDiv{
			border: 1px solid #808080;
			margin-left:10px;
			padding: 3px;
		}
		.indent{
			margin-left: 10px;
		}
	</style>
	</head><body>
	' 

	SET @MailBodyRequestor = @MailBodyController

	DECLARE @Line varchar(max)

	SET @MailBodyController = @MailBodyController + '<b>' + ISNULL(@FullName, '') + ' has requested a change.</b> Reply "Y" or "N" to approve or deny. '
	+ CASE WHEN @ShowAll=0 THEN '<br/>Reply "L" for a version of this email showing the complete task.' ELSE '' END
	+ '<br/><a href="' + ISNULL(@AppPath, '') + '/ChangeRequests.aspx">Click here</a> to review requested change.<br/>'
	SET @MailBodyRequestor = @MailBodyRequestor + '<b>' + ISNULL(@FullName, '') + ' has requested a change:</b><br/>'

	IF len(ltrim(rtrim(isnull(@Comment, '')))) > 0
	BEGIN
		SET @MailBodyController = @MailBodyController + '<h3>Comment:</h3>' + @Comment + '<br/><br/>'
		SET @MailBodyRequestor = @MailBodyRequestor + '<h3>Comment:</h3>' + @Comment + '<br/><br/>'
	END
	
	SET @MailBodyController = @MailBodyController + '<h2>Old:</h2><br/>'
	SET @MailBodyRequestor = @MailBodyRequestor + '<h2>Old:</h2><br/>'

	DECLARE CurrentCur CURSOR FOR
	SELECT 
		ChecklistName,
		Controllers, 
		InstanceID,
		AssigneeList,
		ScheduleString
	FROM @CurrentAssignments ORDER BY InstanceID

	OPEN CurrentCur

	FETCH CurrentCur INTO 
		@ChecklistName,
		@Controllers, 
		@InstanceID,
		@AssigneeList,
		@ScheduleString

	SET @Line = '<div class="checklistDiv"><b>' + ISNULL(@ChecklistName, '') + '</b><br/><br/>' +
			'Controllers: ' + ISNULL(@Controllers, '') + '<br/>'
	
	SET @MailBodyController = @MailBodyController + @Line
	SET @MailBodyRequestor = @MailBodyRequestor + @Line

	SET @i = 1

	WHILE(@@FETCH_STATUS = 0 AND @AssigneeList <> '(No Assignee Changes)' AND NOT (@AssigneeList = '' AND @ScheduleString IS NULL)) 
	BEGIN
		SET @Line = '<em>Assignment ' + CAST(@i AS varchar) + ': </em><br/><div class="indent">' +
		'Assigned To: ' + CASE WHEN @AssigneeList IS NULL OR @AssigneeList = '' THEN '(No Assignees)' ELSE @AssigneeList END + '<br/>' +
		'Schedule: ' + ISNULL(@ScheduleString, '(No Schedule)') + '</div><br/>'

		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line

		SET @i = @i + 1

		FETCH CurrentCur INTO 
			@ChecklistName,
			@Controllers, 
			@InstanceID,
			@AssigneeList,
			@ScheduleString
	END

	CLOSE CurrentCur
	DEALLOCATE CurrentCur
	
	SET @Line = '<br/>'

	SET @MailBodyController = @MailBodyController + @Line
	SET @MailBodyRequestor = @MailBodyRequestor + @Line

	IF(@ShowChecklists=1 OR @ShowAll=1)
	BEGIN

		SET @Line = '<table><thead><tr></tr></thead><tbody>'
		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line
	
		DECLARE CurrentItemCur CURSOR FOR
		SELECT 
			ItemID,
			SequenceNum,
			ItemTypeID,
			ItemTypeName,
			Text,
			URL
		FROM @CurrentItems ORDER BY SequenceNum

		OPEN CurrentItemCur

		FETCH CurrentItemCur INTO 
			@ItemID,
			@SequenceNum,
			@ItemTypeID,
			@ItemTypeName,
			@Text,
			@URL

		WHILE(@@FETCH_STATUS = 0) 
		BEGIN
		
			SET @Line = '<tr>'+
				--Bold and larger
				CASE WHEN @ItemTypeName = 'Heading' THEN '<td colspan="2"><h3>' + ISNULL(@Text, '') + '</h3>'
				--Bold and italic with dash
				WHEN @ItemTypeName = 'Sub Heading' THEN '<td colspan="2"><b><em>' + ISNULL(@Text, '') +'</em></b>'
				--Normal, double-indented with box
				WHEN @ItemTypeName = 'Checkbox' THEN '<td style="vertical-align: top;">&#9744;</td><td>' + ISNULL(@Text, '') +''
				--Italic
				WHEN @ItemTypeName = 'Notes' THEN '<td colspan="2"><em>'+ ISNULL(@Text, '') +'</em>'
				ELSE '<td colspan="2">' END
				+ 
				CASE WHEN @URL IS NOT NULL AND LTRIM(RTRIM(@URL)) <> ''
					THEN ' <a href="'+@URL+'">(More Info)</a>'
					ELSE '' END
			+'</td></tr>'

			SET @MailBodyController = @MailBodyController + @Line
			SET @MailBodyRequestor = @MailBodyRequestor + @Line

			FETCH CurrentItemCur INTO 
				@ItemID,
				@SequenceNum,
				@ItemTypeID,
				@ItemTypeName,
				@Text,
				@URL
		END

		CLOSE CurrentItemCur
		DEALLOCATE CurrentItemCur

		SET @Line = '</tbody></table>'
	
		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line

	END

	SET @Line = '</div><br/><br/><h2>Changes:</h2><ul>'
	SET @MailBodyController = @MailBodyController + @Line
	SET @MailBodyRequestor = @MailBodyRequestor + @Line

	DECLARE ChangeCur CURSOR FOR
		SELECT '<li>' + Requested + '</li>' FROM @Changes ORDER BY CRItemID, Item

	OPEN ChangeCur
	FETCH ChangeCur INTO @Line

	WHILE(@@FETCH_STATUS = 0) 
	BEGIN
		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line

		FETCH ChangeCur INTO @Line
	END

	CLOSE ChangeCur
	DEALLOCATE ChangeCur
	
	SET @Line = '</ul><h2>New:</h2><br/>'

	SET @MailBodyController = @MailBodyController + @Line
	SET @MailBodyRequestor = @MailBodyRequestor + @Line

	--Little tweak; if the user is requesting to delete the checklist, just show the div with "(Checklist Deleted)"
	IF EXISTS (SELECT 'Y' FROM @Changes WHERE Requested LIKE 'Deleting entire checklist - %')
	BEGIN
		SET @Line = '<div class="checklistDiv"><em>(Checklist Deleted)</em></div><span style="color: white;">ChangeID:' + CONVERT(VARCHAR(20), @ChangeID) + '|[ID3]</span>'

		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line
	END
	ELSE
	BEGIN

		DECLARE RequestedCur CURSOR FOR
		SELECT 
			ChecklistName,
			Controllers, 
			InstanceID,
			AssigneeList,
			ScheduleString
		FROM @RequestedAssignments ORDER BY InstanceID

		OPEN RequestedCur

		FETCH RequestedCur INTO 
			@ChecklistName,
			@Controllers, 
			@InstanceID,
			@AssigneeList,
			@ScheduleString

		SET @Line = '<div class="checklistDiv"><b>' + ISNULL(@ChecklistName, '') + '</b><br/><br/>' +
			'Controllers: ' + ISNULL(@Controllers, '') + '<br/>'
	
		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line

		SET @i = 1

		WHILE(@@FETCH_STATUS = 0 AND @AssigneeList <> '(No Assignee Changes)') 
		BEGIN
			SET @Line = '<em>Assignment ' + CAST(@i AS varchar) + ': </em><br/><div class="indent">' +
			'Assigned To: ' + CASE WHEN @AssigneeList IS NULL OR @AssigneeList = '' THEN '(No Assignees)' ELSE @AssigneeList END + '<br/>' +
			'Schedule: ' + ISNULL(@ScheduleString, '(No Schedule)') + '</div><br/>'

			SET @MailBodyController = @MailBodyController + @Line
			SET @MailBodyRequestor = @MailBodyRequestor + @Line

			SET @i = @i + 1

			FETCH RequestedCur INTO 
				@ChecklistName,
				@Controllers, 
				@InstanceID,
				@AssigneeList,
				@ScheduleString
		END

		CLOSE RequestedCur
		DEALLOCATE RequestedCur
	
		SET @Line = '<br/>'

		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line

		IF(@ShowChecklists=1 OR @ShowAll=1)
		BEGIN

			SET @Line = '<table><thead><tr></tr></thead><tbody>'

			SET @MailBodyController = @MailBodyController + @Line
			SET @MailBodyRequestor = @MailBodyRequestor + @Line
	
			DECLARE RequestedItemCur CURSOR FOR
			SELECT 
				ItemID,
				SequenceNum,
				ItemTypeID,
				ItemTypeName,
				Text,
				URL
			FROM @RequestedItems ORDER BY SequenceNum

			OPEN RequestedItemCur

			FETCH RequestedItemCur INTO 
				@ItemID,
				@SequenceNum,
				@ItemTypeID,
				@ItemTypeName,
				@Text,
				@URL

			WHILE(@@FETCH_STATUS = 0) 
			BEGIN
		
				SET @Line = '<tr>'+
					--Bold and larger
					CASE WHEN @ItemTypeName = 'Heading' THEN '<td colspan="2"><h3>' + ISNULL(@Text, '') + '</h3>'
					--Bold and italic with dash
					WHEN @ItemTypeName = 'Sub Heading' THEN '<td colspan="2"><b><em>' + ISNULL(@Text, '') +'</em></b>'
					--Normal, double-indented with box
					WHEN @ItemTypeName = 'Checkbox' THEN '<td style="vertical-align: top;">&#9744;</td><td>' + ISNULL(@Text, '') +''
					--Italic
					WHEN @ItemTypeName = 'Notes' THEN '<td colspan="2"><em>'+ ISNULL(@Text, '') +'</em>'
					ELSE '<td colspan="2">' END
					+ 
					CASE WHEN @URL IS NOT NULL AND LTRIM(RTRIM(@URL)) <> ''
						THEN ' <a href="'+@URL+'">(More Info)</a>'
						ELSE '' END
				+'</td></tr>'

				SET @MailBodyController = @MailBodyController + @Line
				SET @MailBodyRequestor = @MailBodyRequestor + @Line

				FETCH RequestedItemCur INTO 
					@ItemID,
					@SequenceNum,
					@ItemTypeID,
					@ItemTypeName,
					@Text,
					@URL
			END

			CLOSE RequestedItemCur
			DEALLOCATE RequestedItemCur

			SET @Line = '</tbody></table>'
		
			SET @MailBodyController = @MailBodyController + @Line
			SET @MailBodyRequestor = @MailBodyRequestor + @Line

		END

		SET @Line = '</div><span style="color: white;">ChangeID:' + CONVERT(VARCHAR(20), @ChangeID) + '|[ID3]</span>'

		SET @MailBodyController = @MailBodyController + @Line
		SET @MailBodyRequestor = @MailBodyRequestor + @Line
	END
	
	UPDATE QCheck_Approval_ChangeRequests
	SET ReadyForSupervisor = 1
	WHERE [ID] = @ChangeID

	SET @MailSubject = ISNULL(@FullName, '') + ' requests multiple changes to "' + ISNULL(@TaskName, '') + '"'

	--SET @ReplyTo = @RequestorEmail + ';' + @AutomationAddress + ';'
	SET @ReplyTo = @AutomationAddress + ';'

	-- Send e-mail to controller(s)
	EXEC dbo.xp_smtp_sendmail 
		@from = @RequestorEmail, 
		@from_name = @FullName,
		@replyto = @ReplyTo,
		@to = @MailToController, 
		@subject = @MailSubject,
		@message = @MailBodyController, 
		@type = 'text/html', 
		@server = @MailServer

	-- Send e-mail to requestor
	EXEC dbo.xp_smtp_sendmail 
		@from = @RequestorEmail, 
		@from_name = @FullName,
		@replyto = @MailToController,
		@to = @RequestorEmail, 
		@subject = @MailSubject,
		@message = @MailBodyRequestor, 
		@type = 'text/html', 
		@server = @MailServer
		
	--DROP TABLE #Changed
	--DROP TABLE #Added
	--DROP TABLE #Removed

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Approval_UniversalExtension]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_Approval_UniversalExtension] (
	@Command VARCHAR(5000),
	@ChangeID varchar(max),
	@ControllerEmail VARCHAR(500)
) AS

BEGIN

 --select * from QCheck_Approval_ChangeRequests where ID in (select t.Data from dbo.Util_Split(@ChangeID,';') t where Len(t.Data)>0)

 Create table #ChangeRequests
 (
  seq int identity(1,1)
 ,ChangeRequestID int
 
 )

 Insert Into #ChangeRequests(ChangeRequestID)
 select t.Data from dbo.Util_Split(@ChangeID,';') t where Len(t.Data)>0

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ControllerUserID INT,
		@ControllerFullName VARCHAR(500),
		@ControllerShortName VARCHAR(500),
		@ActiveChecklistID INT,
		@NewDueTime DATETIME,
		@CurrentDueTime DATETIME,
		@MailBody VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(1000),
		@RequestorEmail VARCHAR(500),
		@TaskName VARCHAR(500),
		@MailTo VARCHAR(5000),
		@ChecklistID INT,
		@TempCount INT,
		@ChangeChecklistID INT,
		@Controllers varchar(1000),
		@Assignees varchar(1000)
		
	SET @MailFrom = @AppName + '-ChangeRequest<' + REPLACE(@FromAddress, @AppName, @AppName + '-ChangeRequest') + '>'

	-- Get supervisor info
	SELECT 
		@ControllerUserID = [ID],
		@ControllerFullName = FullName,
		@ControllerShortName = ShortName
	FROM 
		QCheck_Users
	WHERE 
		Email = @ControllerEmail
		AND IsDeleted = 0

	-- Get the requestor info
	SELECT 
		@RequestorEmail = Email 
	FROM 
		QCheck_Approval_ChangeRequests CR
		INNER JOIN QCheck_Users U
			ON CR.RequestingUser = U.[ID]
	WHERE
	     CR.[ID] = (select ChangeRequestID from #ChangeRequests where Seq=1)
		--CR.[ID] = @ChangeID

	-- Get requested change info
	--SELECT 
	--	@ActiveChecklistID = ActiveChecklistID,
	--	@NewDueTime = DueTime
	--FROM 
	--	QCheck_Approval_ActiveChecklists
	--WHERE 
	--	ChangeRequestID = @ChangeID

	-- Get task info
	SELECT 
		@TaskName = c.[Name],
		@CurrentDueTime = ac.DueTime,
		@ChecklistID = c.[ID],
		@Controllers = isnull(dbo.QCheck_ManagersList(c.id), ''),
		@Assignees = isnull(dbo.QCheck_AssigneesList(ci.id), '')
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ChecklistID = c.[ID]
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = ci.[ID]
	WHERE
		--ac.[ID] = @ActiveChecklistID
		ac.[ID] =(select ActiveCheckListID from QCheck_Approval_ActiveChecklists where ChangeRequestID=(select ChangeRequestID from #ChangeRequests where Seq=1))

	-- Check to see if the email is from a controller on this request
	-- added 12/28/2011 2:30PM (Son Tran)
	SELECT 
		@TempCount = COUNT(*)
	FROM
		QCheck_ChecklistManagers cm (nolock)
		INNER JOIN QCheck_Groups g (nolock)
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm (nolock)
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u (nolock)
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID = @ChecklistID
		AND cm.IsDeleted = 0
		AND u.Email = @ControllerEmail
	
	IF @TempCount = 0 
		BEGIN
			SET @MailBody = 'You are not allowed to approve the request for the task "' + ISNULL(@TaskName, 'NULL') + '" because you are not a controller on this task.'
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = 'Unauthorized approval request',
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

			RETURN
		END

	SET @MailTo = @RequestorEmail + ';' + @ControllerEmail

 IF OBJECT_ID('tempdb.dbo.#DueTasks', 'U') IS NOT NULL
  DROP TABLE #DueTasks
 
 Create Table #DueTasks
 (
   seq int identity(1,1)
  ,ActiveCheckListId int
  ,DueTime datetime
  ,NewDueTime datetime
  ,ChecklistId int
  ,TaskName varchar(max)
  ,ControllerEmails varchar(max)
 )

 Insert into #DueTasks(ActiveCheckListId,DueTime,NewDueTime,ChecklistId,TaskName,ControllerEmails)
select  distinct a.[ID],a.DueTime,aac.DueTime,ccl.checklistid,f.Name,dbo.QCheck_ChecklistExtensionControllerEmails(ccl.checklistid, DEFAULT) as ControllerEmails
 FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ActiveAssignments b
				ON b.ActiveChecklistID = a.ID
			INNER JOIN QCheck_Assignments c
				ON b.AssignmentsID = c.ID
				AND c.IsDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = c.GroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
				AND len(u.Email) > 0
			Inner join QCheck_Approval_ActiveChecklists aac
			on aac.ActiveChecklistID=a.ID
			Inner join QCheck_Approval_ChangeRequests cr 
			on cr.ID=aac.ChangeRequestID and cr.IsActive=1 
			and cr.id in (select ChangeRequestID from #ChangeRequests) --added on 02/21/2018 to eliminate picking up other instances of the task for which an extension was submitted earlier
			LEFT OUTER JOIN QCheck_DontEmail do 
				ON u.ID = do.UserID
			LEFT OUTER JOIN QCheck_DailyOverdueBCC bcc
				ON u.ID = bcc.UserID
			 LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = f.id
			 LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on c.InstanceID=al.InstanceID
		WHERE
			a.ID in (select ActiveChecklistID from QCheck_Approval_ActiveChecklists where ChangeRequestID in(select ChangeRequestID from #ChangeRequests) and IsActive=1)
			and len(dbo.QCheck_ChecklistExtensionControllerEmails(ccl.checklistid, DEFAULT)) > 0


	-- Process the command
	SET @Command = UPPER(@Command)
	IF @Command = 'Y' OR @Command = 'YES' OR @Command = 'YS' BEGIN

	 declare @taskCounter int =1
     declare @taskCount int=0

	  select @taskCount=count(*) from #DueTasks

		BEGIN TRAN
		
			-- Needed for grading--this logs due date changes
			INSERT INTO QStatus_DueDateChanges (
				ActiveChecklistID, 
				DueDateOld, 
				UpdateDT,
				ChangedBy
			)
				SELECT
					C.ID,
					C.DueTime,
					GETDATE(),
					@ControllerShortName
				FROM 	
					QCheck_ActiveChecklists C
				WHERE	
					--[ID] = @ActiveChecklistID
					[ID] in (select ActiveChecklistID from QCheck_Approval_ActiveChecklists where ChangeRequestID in(select ChangeRequestID from #ChangeRequests))
		
	        
		  while(@taskCounter<=@taskCount)
            Begin
          
            Declare @newDueTimeUpdate DateTime
           
			Declare @activeChecklistIdUpdate int
            select @newDueTimeUpdate=NewDueTime,@activeChecklistIdUpdate=ActiveCheckListId from #DueTasks where seq=@taskCounter
			-- Change the due date
			UPDATE 
				QCheck_ActiveChecklists
			SET
				DueTime = @newDueTimeUpdate
			WHERE
				[ID] = @activeChecklistIdUpdate
				
        

           set @taskCounter=@taskCounter+1
           End

			-- Change the due date
			--UPDATE 
			--	QCheck_ActiveChecklists
			--SET
			--	DueTime = @NewDueTime
			--WHERE
			--	--[ID] = @ActiveChecklistID
			--	[ID] in (select ActiveChecklistID from QCheck_Approval_ActiveChecklists where ChangeRequestID in(select ChangeRequestID from #ChangeRequests))
	
			-- Mark the request approved
			UPDATE 
				QCheck_Approval_ChangeRequests
			SET 
				Approved = 1,
				ApprovedUser = @ControllerUserID,
				ApprovedDate = GETDATE(),
				IsActive = 0
			WHERE
				--[ID] = @ChangeID
				[ID] in (select ChangeRequestID from #ChangeRequests)

			
			UPDATE 
				QCheck_UniversalExtensionChangeRequests
			SET 
				
				IsActive = 0
			WHERE
				--[ID] = @ChangeID
				ChangeRequestID in (select ChangeRequestID from #ChangeRequests)

			-- 2/10/2012 dalvarado
			-- Delete any other outstanding changes for this checklist
			-- This change is per GPR
			--SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
		
			--UPDATE
			--	QCheck_Approval_ChangeRequests
			--SET
			--	IsActive = 0,
			--	Rejected = 1,
			--	RejectedDate = GETDATE(),
			--	RejectedUser = @ControllerUserID
			--WHERE
			--	IsActive = 1
			--	AND ReadyForSupervisor = 1
			--	AND Approved = 0
			--	AND Rejected = 0
			--	AND [ID] < @ChangeID
			--	AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID
			

		COMMIT TRAN


 set @taskCounter  =1
 set @taskCount    =0
 -- Send the approved e-mail
 SET @MailBody = 'Your requested for a deadline change has been approved.<br/><br/>'
				
 select @taskCount=count(*) from #DueTasks
 while(@taskCounter<=@taskCount)
 Begin
 Declare @currentDueTimeMail DateTime
 Declare @newDueTaskTime DateTime
 Declare @taskNameMail varchar(max)
 --Declare @changeIds varchar(max)


 select @currentDueTimeMail=DueTime,@newDueTaskTime=NewDueTime,@taskNameMail=TaskName from #DueTasks where seq=@taskCounter
 --set @newDueTaskTime=dateadd(HOUR, 2,@currentDueTime)
 SET @MailBody = @MailBody+'<table border="0">'
 SET @MailBody =@MailBody+ '<tr><td>Task Name: </td><td><b>' + ISNULL(CONVERT(VARCHAR(max), @taskNameMail), '') + '</b></td></tr>' 
                         +'<tr><td>New Deadline: </td><td><b>' + ISNULL(CONVERT(VARCHAR(20), @newDueTaskTime), '') +'</b></td></tr>'+
			              '<tr><td>Approved By: </td><td><b>' +  ISNULL(@ControllerFullName, '') + '</b></td></tr>' 
			
 set @mailBody=@mailBody+'</table>'
 set @mailBody=@mailBody+'<br><br>'

 set @taskCounter=@taskCounter+1
 End

		--SET @MailBody = 'Your requested for a deadline change has been approved.<br/><br/>'
		--set @MailBody=@MailBody+@taskDescription

		SET @MailSubject = 'Deadline change APPROVED for requested tasks ' + ' by ' + ISNULL(@ControllerFullName, '')
		SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
		EXEC dbo.xp_smtp_sendmail 
			@from = @ControllerEmail,
			@from_name = @ControllerFullName,
			@to = @MailTo, 
			@subject = @MailSubject,
			@message = @MailBody, 
			@type = 'text/html', 
			@server = @MailServer

	END 
	
	ELSE BEGIN

		IF @Command = 'N' OR @Command = 'NO' BEGIN

			-- Mark the request denied
			UPDATE 
				QCheck_Approval_ChangeRequests
			SET 
				Rejected = 0,
				RejectedUser = @ControllerUserID,
				RejectedDate = GETDATE(),
				IsActive = 0
			WHERE
				[ID] in (select ChangeRequestID from #ChangeRequests)


			UPDATE 
				QCheck_UniversalExtensionChangeRequests
			SET 
				
				IsActive = 0
			WHERE
				--[ID] = @ChangeID
				ChangeRequestID in (select ChangeRequestID from #ChangeRequests)

			-- 2/10/2012 dalvarado
			-- Delete any other outstanding changes for this checklist
			-- This change is per GPR
			--SELECT @ChangeChecklistID = dbo.QCheck_Approval_CRChecklistID(@ChangeID)
		
			--UPDATE
			--	QCheck_Approval_ChangeRequests
			--SET
			--	IsActive = 0,
			--	Rejected = 1,
			--	RejectedDate = GETDATE(),
			--	RejectedUser = @ControllerUserID
			--WHERE
			--	IsActive = 1
			--	AND ReadyForSupervisor = 1
			--	AND Approved = 0
			--	AND Rejected = 0
			--	AND [ID] < @ChangeID
			--	AND dbo.QCheck_Approval_CRChecklistID([ID]) = @ChangeChecklistID


			declare @taskCounterDenied int =1
          declare @taskCountDenied int=0

				
 select @taskCountDenied=count(*) from #DueTasks

 SET @MailBody = 'Your requested for a deadline change has been denied.  These tasks must be completed by the current deadline.<br/><br/>'
					

 while(@taskCounterDenied<=@taskCountDenied)
 Begin
 Declare @currentDueTimeMailDenied DateTime
 
 Declare @taskNameMailDenied varchar(max)
 --Declare @changeIds varchar(max)


 select @currentDueTimeMailDenied=DueTime,@taskNameMailDenied=TaskName from #DueTasks where seq=@taskCounterDenied
 --set @newDueTaskTime=dateadd(HOUR, 2,@currentDueTime)
  SET @MailBody = @MailBody+'<table border="0">'
 SET @MailBody =@MailBody+ '<tr><td>Task Name: </td><td><b>' + ISNULL(CONVERT(VARCHAR(max), @taskNameMailDenied), '') + '</b></td></tr>' 
                         +'<tr><td> Deadline: </td><td><b>' + ISNULL(CONVERT(VARCHAR(20), @currentDueTimeMailDenied), '') +'</b></td></tr>'+
			              '<tr><td>Denied By: </td><td><b>' +  ISNULL(@ControllerFullName, '') + '</b></td></tr>' 
			
   set @mailBody=@mailBody+'</table>'
    set @mailBody=@mailBody+'<br><br>'

 set @taskCounterDenied=@taskCounterDenied+1
 End

			-- Send the denied e-mail
		

			SET @MailSubject = 'Deadline change DENIED for tasks ' + ' by ' + ISNULL(@ControllerFullName, '')
			SET @MailFrom = @ControllerFullName + '<' + @ControllerEmail + '>'
			EXEC dbo.xp_smtp_sendmail 
				@from = @ControllerEmail,
				@from_name = @ControllerFullName,
				@to = @MailTo, 
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

		END ELSE BEGIN

			-- Send the "unknown command" e-mail
			SET @MailBody = 'Your command "' + ISNULL(@Command, '') + '" was not recognized.<br/><br/>Please do not reply to this e-mail, reply to the original request.'
			SET @MailSubject = @AppName + ' - Requested Due Date Change'
			
			EXEC dbo.xp_smtp_sendmail 
				@from = @MailFrom,
				@to = @ControllerEmail, 
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer

		END

	END

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Archive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- This stored procedure will archive checklist data

CREATE      PROCEDURE [dbo].[QCheck_Archive]
	@DeleteCompletedChecklists bit = 1
 AS

BEGIN

	SET NOCOUNT ON
	
	SET DEADLOCK_PRIORITY 10

DECLARE @maintainDays int
SET @maintainDays = 7

IF @DeleteCompletedChecklists = 1
	--inserts on completeddate
	INSERT INTO QCheck_ActiveChecklistArchive
		SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
		LEFT OUTER JOIN QCheck_ActiveChecklistArchive b
			ON a.[ID] = b.[ID]
		WHERE a.CompletedDate < getDate() - @maintainDays
		AND b.[ID] IS NULL
		AND a.DueTime < GETDATE()
	
INSERT INTO QCheck_ActiveChecklistArchive
	SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_Assignments c
		ON a.InstanceID = c.InstanceID
	WHERE 
	b.[ID] IS NULL
	AND c.[ID] IS NULL
	AND a.DueTime < GETDATE()

INSERT INTO QCheck_ActiveChecklistArchive
	SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ActiveAssignments c
		ON a.ID = c.ActiveChecklistID
	WHERE 
	b.[ID] IS NULL
	AND c.[ID] IS NULL
	AND a.DueTime < GETDATE()


INSERT INTO QCheck_ActiveChecklistArchive
	SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ChecklistInstances c
		ON a.InstanceID = c.ID
	WHERE 
	b.[ID] IS NULL
	AND c.[ID] IS NULL
	AND a.DueTime < GETDATE()

UPDATE QCheck_Checklists
	SET IsDeleted = 1
	WHERE Template = 0
	AND --not active
		ID not in 
			(SELECT ci.ChecklistID
			FROM QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.ID)
	AND --end date in the past
		(
			ID in
			(
				select c.id
				from qcheck_checklists c
				inner join qcheck_checklistinstances ci
				on ci.checklistid = c.id
				inner join qcheck_schedule s
				on s.id = ci.scheduleid
				group by c.id
				having  max(
						CASE WHEN freqType = 1 then isnull(firstduedate, getdate() + 1)
						ELSE isnull(lastduedate, getdate() + 1)
						END
						) 
					 < getdate()
				
			)
			OR
			-- or no schedule
			ID in
			(
				select c.id
				from qcheck_checklists c
				left outer join qcheck_checklistinstances ci
				on ci.checklistid = c.id
				and ci.isdeleted = 0
				left outer join qcheck_schedule s
				on s.id = ci.scheduleid
				group by c.id, c.name
				having count(s.id) = 0
			
			)
			
		)
	AND --nothing completed in the last month
		ID not in
			(
				SELECT ci.ChecklistID
				FROM QCheck_ActiveChecklistArchive ac
				INNER JOIN QCheck_ChecklistInstances ci
				ON ac.InstanceID = ci.ID
				WHERE completedDate > DateAdd(month, -1, getdate())
				
			)
		and isdeleted = 0


--inserts on isdeleted
INSERT INTO QCheck_ChecklistArchive
	SELECT a.*, getDate() FROM QCheck_Checklists a
	LEFT OUTER JOIN QCheck_ChecklistArchive b
		ON a.[ID] = b.[ID]
	WHERE a.IsDeleted = 1
	AND b.[ID] IS NULL

--inserts on isdeleted or checklist has been archived
INSERT INTO QCheck_ChecklistInstanceArchive
	SELECT a.*, getDate() FROM QCheck_ChecklistInstances a
	LEFT OUTER JOIN QCheck_ChecklistInstanceArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ChecklistArchive c
		ON a.ChecklistID = c.[ID]
	LEFT OUTER JOIN QCheck_Checklists c2
		ON a.ChecklistID = c2.[ID]
	WHERE (a.IsDeleted = 1 or c.[ID] IS NOT NULL OR c2.ID is null)
	AND b.[ID] IS NULL

--inserts if instance has been archived
INSERT INTO QCheck_ActiveChecklistArchive
	SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ChecklistInstanceArchive c
		ON a.InstanceID = c.[ID]
	WHERE (c.[ID] IS NOT NULL)
	AND b.[ID] IS NULL
	AND a.DueTime < GETDATE()


--inserts on isdeleted or instance is archived
INSERT INTO QCheck_AssignmentArchive
	SELECT a.*, getDate() FROM QCheck_Assignments a
	LEFT OUTER JOIN QCheck_AssignmentArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ChecklistInstanceArchive d
		ON a.InstanceID = d.[ID]
	WHERE 
		(a.IsDeleted = 1 or d.[ID] IS NOT NULL)
	AND b.[ID] IS NULL
	AND a.ID not in (
		select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate() 
	)

--inserts on isdeleted or checklists is archived
INSERT INTO QCheck_ItemArchive
	SELECT a.*, getDate() FROM QCheck_Items a
	LEFT OUTER JOIN QCheck_ItemArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ChecklistArchive c
		ON a.ChecklistID = c.[ID]
	WHERE (a.IsDeleted = 1 or c.[ID] IS NOT NULL)
	AND b.[ID] IS NULL

--inserts on isdeleted or instance is archived
INSERT INTO QCheck_ScheduleArchive
	SELECT a.*, getDate() FROM QCheck_Schedule a
	LEFT OUTER JOIN QCheck_ScheduleArchive b
		ON a.[ID] = b.[ID]
	INNER JOIN QCheck_ChecklistInstanceArchive c	
		ON a.[ID] = c.ScheduleID
	WHERE b.[ID] IS NULL


--inserts on activechecklist archived or assignment archived
INSERT INTO QCheck_ActiveAssignmentArchive
	SELECT a.*, getDate() FROM QCheck_ActiveAssignments a
	LEFT OUTER JOIN QCheck_ActiveAssignmentArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive c	
		ON a.ActiveChecklistID = c.[ID]
	LEFT OUTER JOIN QCheck_AssignmentArchive d	
		ON a.AssignmentsID = d.[ID]
	WHERE 
	(c.[ID] IS NOT NULL or d.[ID] IS NOT NULL)
	AND b.[ID] IS NULL

--inserts on activechecklist archived or item archived
INSERT INTO QCheck_ActiveItemArchive
	SELECT a.*, getDate() FROM QCheck_ActiveItems a
	LEFT OUTER JOIN QCheck_ActiveItemArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive c	
		ON a.ActiveChecklistID = c.[ID]
	LEFT OUTER JOIN QCheck_ItemArchive d	
		ON a.ChecklistItemID = d.[ID]
	WHERE 
	(c.[ID] IS NOT NULL or d.[ID] IS NOT NULL)
	AND b.[ID] IS NULL

--inserts on isdeleted or instance archived
INSERT INTO QCheck_AlertArchive
	SELECT a.*, getDate() FROM QCheck_Alerts a
	LEFT OUTER JOIN QCheck_AlertArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ChecklistInstanceArchive c	
		ON a.InstanceID = c.[ID]
	WHERE 
	(a.IsDeleted = 1 OR c.[ID] IS NOT NULL)
	AND b.[ID] IS NULL

--inserts on activechecklist archived or alert archived
INSERT INTO QCheck_ActiveAlertArchive
	SELECT a.*, getDate() FROM QCheck_ActiveAlerts a
	LEFT OUTER JOIN QCheck_ActiveAlertArchive b
		ON a.[ID] = b.[ID]
	LEFT OUTER JOIN QCheck_ActiveChecklistArchive c	
		ON a.ActiveChecklistID = c.[ID]
	LEFT OUTER JOIN QCheck_AlertArchive d	
		ON a.AlertID = d.[ID]
	WHERE 
	(c.[ID] IS NOT NULL or d.[ID] IS NOT NULL)
	AND b.[ID] IS NULL

DELETE FROM QCheck_ActiveAssignments
	FROM QCheck_ActiveAssignmentArchive
	WHERE QCheck_ActiveAssignments.[ID] = QCheck_ActiveAssignmentArchive.[ID]

DELETE FROM QCheck_ActiveChecklists
	FROM QCheck_ActiveChecklistArchive
	WHERE QCheck_ActiveChecklists.[ID] = QCheck_ActiveChecklistArchive.[ID]

DELETE FROM QCheck_ActiveItems
	FROM QCheck_ActiveItemArchive
	WHERE QCheck_ActiveItems.[ID] = QCheck_ActiveItemArchive.[ID]

DELETE FROM QCheck_Assignments
	FROM QCheck_AssignmentArchive
	WHERE QCheck_Assignments.[ID] = QCheck_AssignmentArchive.[ID]

DELETE FROM QCheck_Checklists
	FROM QCheck_ChecklistArchive
	WHERE QCheck_Checklists.[ID] = QCheck_ChecklistArchive.[ID]

DELETE FROM QCheck_ChecklistInstances
	FROM QCheck_ChecklistInstanceArchive
	WHERE QCheck_ChecklistInstances.[ID] = QCheck_ChecklistInstanceArchive.[ID]

DELETE FROM QCheck_Items
	FROM QCheck_ItemArchive
	WHERE QCheck_Items.[ID] = QCheck_ItemArchive.[ID]

DELETE FROM QCheck_Schedule
	FROM QCheck_ScheduleArchive
	WHERE QCheck_Schedule.[ID] = QCheck_ScheduleArchive.[ID]

DELETE FROM QCheck_Alerts
	FROM QCheck_AlertArchive
	WHERE QCheck_Alerts.[ID] = QCheck_AlertArchive.[ID]


DELETE FROM QCheck_ActiveAlerts
	FROM QCheck_ActiveAlertArchive
	WHERE QCheck_ActiveAlerts.[ID] = QCheck_ActiveAlertArchive.[ID]




insert into QStatus_ActiveChecklistTaskTypeArchive
	(activechecklistid, tasktype, priority, createdt)
SELECT actt.* FROM
	qstatus_activechecklisttasktype actt
inner join 
	qcheck_activechecklistarchive ac
on
	ac.id = actt.activechecklistid
and
	ac.completeddate < getdate() - 100

delete from qstatus_activechecklisttasktype
	where activechecklistid in
		(select activechecklistid from 
		qstatus_activechecklisttasktypearchive)





insert into qstatus_commentarchive
(id, foreignkeyid, comments, displayorder,
tabin, commentdt, initials, userid, replyid, specialtask, asofdate)
select distinct c.*, getdate() from qstatus_comments c
inner join 
(select distinct c.id from qstatus_comments c
where specialtask = 0
and foreignkeyid not in
(select id from
qcheck_activechecklists)
) c2
on c.id = c2.id

delete from qstatus_comments 
where id in
(select id from qstatus_commentarchive)


exec JB_Tasks_Archive_Full_Populate


truncate table qstatus_commentedreporttasks
insert into qstatus_commentedreporttasks
	SELECT actt.activechecklistid, tt.reportID
		FROM QStatus_ActiveChecklistTaskType actt
		inner join qstatus_tasktypes tt
		on tt.id = actt.tasktype
		inner join qstatus_comments c
		on c.foreignkeyid = actt.activechecklistid
		WHERE 
		c.specialtask = 0

	SET NOCOUNT OFF

END



delete from qstatus_temptasks
where input_date < getdate() - 1

delete from qcheck_upcomingduetimes
where instanceid not in (select id from qcheck_checklistinstances)


delete from qcheck_groupmembership where groupid not in (select id from qcheck_groups) or userid not in (select id from qcheck_users)


--archive old change requests that no longer apply
update qcheck_approval_changerequests 
set isactive = 0
where id in (

	select cr.id from qcheck_approval_changerequests cr
		inner join QCheck_Approval_ActiveChecklists aac
			on aac.ChangeRequestID = cr.id
		left outer join qcheck_activechecklists ac
			on ac.id = aac.ActiveChecklistID
	where cr.approved = 0 and cr.readyforsupervisor = 1 and cr.rejected = 0
	and cr.isactive = 1
	and ac.id is null

)
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssignedEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will email a message when 
-- a checklist instance is assigned to a member.

CREATE PROCEDURE [dbo].[QCheck_AssignedEmail](
		@UserID int,
		@groupID int,
		@assignedBy  	int,
		@checklistName	VARCHAR(500),
		@instanceID int
) AS

BEGIN
	SET NOCOUNT ON

	DECLARE @mailFrom VARCHAR(1000)
	DECLARE @FromName VARCHAR(500)
	DECLARE @mailTo VARCHAR(1000)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	SET @mailSubject = 'New Assignment'
	SET @mailType = 'text/html'

	SELECT @MailFrom = FullName + '<' + Email + '>'
	FROM QCheck_Users
	WHERE ID = @assignedBy
	
	SET @mailTo = ''

	SELECT 
		@mailTo = @mailTo + u.Email +';'
	FROM 
		QCheck_Users u left outer JOIN 
		QCheck_DontEmail de on u.id = de.UserID
	WHERE 
		de.UserID is null and 
		u.id <> @assignedBy AND 
		U.id = @UserID AND 
		u.isdeleted = 0
		
	
	--only email if the member is not in the dont email table
	if len(isnull(@mailTo, '')) > 0
	BEGIN
		-- call the smtp procedure
		If (Not @mailTo like 'graynor%') 
		begin

			select @checklistName = CAST(replace(@checklistName,'''', '') AS VARCHAR(500))

			declare @html table (id int identity(1,1), html varchar(max))
			insert into @html exec QCheck_AssignedEmail_HTML @UserID, @groupID, @assignedBy, @checklistName, @instanceID
			declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
			while exists (select 1 from @html)
			begin
				select top 1 @rowid = id from @html order by id asc
				select @onerow = html from @html where id = @rowid
				select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
				delete from @html where id = @rowid
			end
			
			exec [dbo].[xp_smtp_sendmail]
					@to = @mailTo,
					@from = @mailFrom,
					@subject = @mailSubject,
					@message = @htmlstr
		end
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssignedEmail_AddToQueue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE      PROCEDURE [dbo].[QCheck_AssignedEmail_AddToQueue](
		@groupID int,
		@assignedBy  	int,
		@checklistName	VARCHAR(500),
		@InstanceID int	
) AS

BEGIN
	SET NOCOUNT ON

	INSERT INTO QCheck_AssignedEmail_Queue
	(UserID, GroupID, AssignedBy, ChecklistName, InstanceID, AssignedDt, SentDt)
	SELECT userid, groupID, @assignedBy, @checklistName, @InstanceID, getdate(), null
	FROM qcheck_groupmembership
	WHERE GroupID = @groupID

	SET NOCOUNT OFF

END









GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssignedEmail_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[QCheck_AssignedEmail_HTML](
		@UserID int,
		@groupID int,
		@assignedBy  	int,
		@checklistName	VARCHAR(500),
		@instanceID int
) AS

BEGIN
	SET NOCOUNT ON
	
	DECLARE @assignedByStr VARCHAR(50)
	DECLARE @appURL VARCHAR(50)
	DECLARE @ImagesURL VARCHAR(50)
	DECLARE @appID int
	DECLARE @DueStr varchar(100)
	DECLARE @ActiveChecklistID int
		
	DECLARE  @groupname varchar(100), @single bit

	DECLARE @html_output TABLE (
		seq INT IDENTITY(1,1),
		row_html VARCHAR(8000)
	)

	SELECT @assignedByStr = FullName FROM QCheck_Users where ID = @assignedBy

	SET @appID = 1

	SELECT @appID = u.app
	FROM QCheck_Users u 
	WHERE U.ID = @UserID

	SELECT @appURL = a.appURL, @ImagesURL=ImagesURL FROM QCheck_AppSettings a
	WHERE [ID] = @appID
			
	SELECT @groupname = Name, @single = SingleMemberGroup
	FROM QCheck_Groups
	WHERE ID = @GroupID

	DECLARE @HasReports bit, @SectionName varchar(500), @ReportName varchar(500), @ReportID int, @SectionID int, @DisplayOrder int

	SELECT @HasReports = 0

	select @HasReports = 1
	from qstatus_instancetasktype itt
	inner join qstatus_tasktypes tt
	on itt.tasktype = tt.id
	inner join qstatus_report r
	on r.id = tt.reportID
	WHERE itt.instanceid = @instanceID
	and r.isdeleted = 0
	and tt.isdeleted = 0 

	select @DueStr = datename(dw, min(duetime)) + ', ' +  convert(varchar, min(duetime), 101),
		@ActiveChecklistID = min(c.ID)
	from qcheck_checklistinstances ci
	inner join qcheck_activechecklists c
	on c.instanceid = ci.id
	where ci.id = @instanceID

	INSERT INTO @html_output (row_html) 
				SELECT
			'<link href="' + @ImagesURL + '/Styles.css" type="text/css" rel="stylesheet">' +
			'<style>TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;} .hide {display:none} TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style>' +
			'<table width="100%" cellpadding=0 cellspacing=0>You have been assigned to the <b>' + isNull(@checklistName,'') + '</b> task by ' + isNull(@assignedByStr,'noname')
	
	IF @single = 0 
		INSERT INTO @html_output (row_html) 
				SELECT
			', through the ' + @groupname + ' group'

	IF @DueStr is null
		INSERT INTO @html_output (row_html) 
					SELECT
				'.<br><br>When scheduled, this task will appear at <a href="'+@appURL+'">'+@appURL + 
			'</a>.<br><br>'
	ELSE
		INSERT INTO @html_output (row_html) 
					SELECT
				'.<br><br>This task is due on ' + @DueStr + '. To view the task, go to <a href="'+@appURL+'">'+@appURL + 
			'</a>.<br><br>'
	
	IF @HasReports = 0 
	BEGIN
		INSERT INTO @html_output (row_html) 
				SELECT
			'This task is not yet on a status report.  To add the task to a status report, go to the appropriate report on your "My Status" tab.' + 
			'  On the menu, click "Add"->"Existing Task", then select in which section you would like it to appear.' + 
			'  When the dropdown appears, find "'+isNull(@checklistName,'')+'" in the list and click "Add".'
	END
	ELSE
	BEGIN
		INSERT INTO @html_output (row_html) 
				SELECT
			'This task will appear on the following reports:<br><br><table cellpadding=5 cellspacing=0><tr><th>Report</th><th>Section</th></tr>'
	
		DECLARE ALERTCURS CURSOR
			FOR 
		select r.name, tt.description
		from qstatus_instancetasktype itt
		inner join qstatus_tasktypes tt
		on itt.tasktype = tt.id
		inner join qstatus_report r
		on r.id = tt.reportID
		WHERE itt.instanceid = @instanceID
		and r.isdeleted = 0
		and tt.isdeleted = 0 
				
		OPEN ALERTCURS
	
		FETCH NEXT FROM ALERTCURS INTO @ReportName, @SectionName
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			
			INSERT INTO @html_output (row_html) 
				SELECT
			'<tr><td>'+@ReportName+'</td><td>'+@SectionName+'</td></tr>'

			FETCH NEXT FROM ALERTCURS INTO @ReportName, @SectionName
		END
		CLOSE ALERTCURS
		DEALLOCATE ALERTCURS 		
		
		INSERT INTO @html_output (row_html) 
		SELECT '</table>'
	END

	INSERT INTO @html_output (row_html) 
	SELECT '<br/><br/><a href="' + @appURL + '/ManageSingleChecklist.aspx?&taskId=' + cast(@ActiveChecklistID as varchar) + '&taskStage=1&addPriority=1">Add Task to My Priorities</a>'

	INSERT INTO @html_output (row_html) 
	SELECT '<br/><br/>Add Task to My Status Report:<br/><br/>'

	DECLARE SECTIONCURS CURSOR FOR
	SELECT 
	DISTINCT 
		tt.ID, 
		r.Name + ' - ' + tt.description, 
		r.ID, 
		tt.displayOrder
	FROM 
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	INNER JOIN 
		QStatus_TaskTypes tt
	ON
		tt.ReportID = r.ID
	AND 
		tt.IsDeleted = 0
	AND
		tt.NativeType = 0
	WHERE 
		r.IsDeleted = 0
	ORDER BY r.ID, tt.displayOrder

	OPEN SECTIONCURS	
		
	FETCH NEXT FROM SECTIONCURS INTO @SectionID, @SectionName, @ReportID, @DisplayOrder
	WHILE @@FETCH_STATUS = 0 BEGIN
			
		INSERT INTO @html_output (row_html) 
			SELECT
		'<a href="'+@appURL+'\qprocess_ajax.aspx?action=AddExistingTaskRedirect&reportId='+cast(@ReportID as varchar(20))+'&instanceId='+cast(@instanceID as varchar(20))+'&section='+cast(@SectionID as varchar(20))+'">'+@SectionName+'</a><br/>'

		FETCH NEXT FROM SECTIONCURS INTO @SectionID, @SectionName, @ReportID, @DisplayOrder
	END
	CLOSE SECTIONCURS
	DEALLOCATE SECTIONCURS
		
	SELECT row_html FROM @html_output ORDER BY seq		

END
















GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssignedEmail_ProcessQueue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO













CREATE          PROCEDURE [dbo].[QCheck_AssignedEmail_ProcessQueue]
AS

BEGIN
	SET NOCOUNT ON

		DECLARE @ID int, 
			@GroupID int, 
			@UserID int,
			@AssignedBy int, 
			@ChecklistName varchar(500), 
			@InstanceID int

		DECLARE ASSIGNCURS CURSOR
			FOR 
		SELECT ID, UserID, GroupID, AssignedBy, ChecklistName, InstanceID
		FROM QCheck_AssignedEmail_Queue
		WHERE SentDt is null
		AND AssignedDt < dateadd(minute, -1, getdate())
		
		
		OPEN ASSIGNCURS
	
		FETCH NEXT FROM ASSIGNCURS INTO @ID, @UserID, @GroupID, @AssignedBy, @ChecklistName, @InstanceID 
		WHILE @@FETCH_STATUS = 0 BEGIN
			
			EXEC QCheck_AssignedEmail @UserID, @GroupID, @AssignedBy, @ChecklistName, @InstanceID

			UPDATE QCheck_AssignedEmail_Queue set SentDt = getdate()
			WHERE ID = @ID

			FETCH NEXT FROM ASSIGNCURS INTO  @ID, @UserID, @GroupID, @AssignedBy, @ChecklistName, @InstanceID 
		END
		CLOSE ASSIGNCURS
		DEALLOCATE ASSIGNCURS 
			

	SET NOCOUNT OFF

END













GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssigneesReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[QCheck_AssigneesReport](
	@controller varchar(100),
	@maxassignees int)
AS
BEGIN

	select c.Name, dbo.QCheck_AssigneesListSplitGroups(ci.id) as Assignees, dbo.QCheck_ManagersList(c.id) as Controller
		from QCheck_Checklists c
		inner join QCheck_ChecklistInstances ci
			on c.ID = ci.ChecklistID
	where ci.ID in (
		select ci.ID
		from QCheck_ChecklistInstances ci
		inner join QCheck_Checklists c
			on ci.ChecklistID = c.ID
			and c.IsDeleted = 0
			and ci.IsDeleted = 0
		inner join QCheck_Assignments a
			on a.InstanceID = ci.ID
			and a.IsDeleted = 0
		inner join QCheck_Groups g
			on g.ID = a.GroupID
		inner join QCheck_GroupMembership gm
			on gm.GroupID = g.ID	
		inner join QCheck_Users u
			on u.ID = gm.UserID
			and u.IsDeleted = 0
		inner join QStatus_UserSupervisors us
			on us.UserID = u.ID
		inner join QCheck_Users uman
			on uman.ID = us.SupervisorUserID
			and uman.FullName = @controller
		group by ci.ID 
		having COUNT(distinct u.id) >= @maxassignees
	)
	order by 1
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssignmentsTemporary_Add]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[QCheck_AssignmentsTemporary_Add]
(
	@ReplacingID int,
	@TempGroupID int,
	@TempAssignmentStart datetime,
	@TempAssignmentEnd datetime,
	@CreatedBy int
)
AS
BEGIN

	DECLARE @InstanceID int, @ReplacingGroupID int

	SELECT @InstanceID = InstanceID 
	FROM QCheck_Assignments
	WHERE ID = @ReplacingID

	--remove existing temp assignments that have not started
	DELETE FROM QCheck_AssignmentsTemporary 
	WHERE 
		ReplacingID = @ReplacingID 
		AND TempAssignmentStart <= @TempAssignmentEnd 
		AND TempAssignmentEnd >= @TempAssignmentStart
		AND ISNULL(TempAssignmentApplied, 0) = 0 

	--if one has already started, end it
	IF EXISTS
	(
		SELECT 1
		FROM QCheck_AssignmentsTemporary 
		WHERE 
			ReplacingID = @ReplacingID 
			AND TempAssignmentStart <= @TempAssignmentEnd 
			AND TempAssignmentEnd >= @TempAssignmentStart
			AND ISNULL(TempAssignmentApplied, 0) = 1
	)
	BEGIN
		
		DECLARE @TempAssignmentID int

		SELECT @TempAssignmentID = ID
		FROM QCheck_AssignmentsTemporary 
		WHERE 
			ReplacingID = @ReplacingID 
			AND TempAssignmentStart <= @TempAssignmentEnd 
			AND TempAssignmentEnd >= @TempAssignmentStart
			AND ISNULL(TempAssignmentApplied, 0) = 1

		EXEC QCheck_ProcessTempAssignments_End @TempAssignmentID

	END

	SELECT @ReplacingGroupID = GroupID FROM QCheck_Assignments WHERE ID = @ReplacingID

	IF @TempGroupID <> @ReplacingGroupID
	BEGIN
		INSERT INTO QCheck_AssignmentsTemporary (ReplacingID, InstanceID, TempGroupID, TempAssignmentStart, TempAssignmentEnd, AssigneesAlerted, CreatedDt, CreatedBy)
		SELECT @ReplacingID, @InstanceID, @TempGroupID, @TempAssignmentStart, @TempAssignmentEnd, 0, GETDATE(), @CreatedBy
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AssignmentsTemporary_GetList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[QCheck_AssignmentsTemporary_GetList]
(
	@UserID int,
	@TempAssignmentStart datetime,
	@TempAssignmentEnd datetime,
	@AssignmentType int --1=single, 2=multi, 3=group
)
AS
BEGIN

	declare @alltasksdue table (instanceid int)

	insert into @alltasksdue
	select distinct ac.InstanceID from qcheck_activechecklists ac
	inner join qcheck_checklistinstances ci
		on ci.id = ac.InstanceID
	inner join QCheck_Schedule s
		on s.id = ci.ScheduleID
	inner join qcheck_assignments a
		on a.InstanceID = ci.ID
	inner join qcheck_groups g
		on a.groupid = g.id
	inner join QCheck_GroupMembership gm
		on gm.GroupID = g.id
		and gm.UserID = @UserID
	where 
	(
		(ac.duetime between @TempAssignmentStart and @TempAssignmentEnd)
		or
		(dateadd(day, -1 * isnull(s.SoftDueOffsetDays, 0), ac.duetime) between @TempAssignmentStart and @TempAssignmentEnd)
	)
	and ac.completeddate is null

	union

	select ci.id
	from QCheck_UpcomingDueTimes u
	inner join qcheck_checklistinstances ci
		on ci.id = u.InstanceID
	inner join QCheck_Schedule s
		on s.id = ci.ScheduleID
	inner join qcheck_assignments a
		on a.InstanceID = ci.ID
	inner join qcheck_groups g
		on a.groupid = g.id
	inner join QCheck_GroupMembership gm
		on gm.GroupID = g.id
		and gm.UserID = @UserID
	where 
	(
		(u.duetime between @TempAssignmentStart and @TempAssignmentEnd)
		or
		(dateadd(day, -1 * isnull(s.SoftDueOffsetDays, 0), u.duetime) between @TempAssignmentStart and @TempAssignmentEnd)
	)

	declare @assignments table (assignmentid int, instanceid int)

	if @AssignmentType = 1  -- look for tasks assigned only to the person
	begin

		;with others as
		(
			select a.instanceid
					from qcheck_assignments a
					inner join @alltasksdue atd
						on atd.instanceid = a.InstanceID
						and (a.IsDeleted = 0 or a.ID in (select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate()))
					inner join qcheck_groups g
						on a.groupid = g.id
					inner join QCheck_GroupMembership gm
						on gm.GroupID = g.id
					inner join qcheck_users u
						on u.id = gm.UserID
						and u.IsDeleted = 0
						and u.ID <> @userid
		)
		insert into @assignments
		select distinct a.ID, a.InstanceID 
		from qcheck_assignments a
			inner join @alltasksdue atd
				on atd.instanceid = a.InstanceID
				and (a.IsDeleted = 0 or a.ID in (select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate()))
			left outer join others o
				on o.InstanceID=a.InstanceID
			where o.InstanceID is null
	end
	if @AssignmentType = 3  -- look for tasks assigned to the person through a group with other members
	begin

		insert into @assignments
		select distinct a.ID, a.InstanceID 
		from qcheck_assignments a
			inner join @alltasksdue atd
				on atd.instanceid = a.InstanceID
				and (a.IsDeleted = 0 or a.ID in (select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate()))
			inner join qcheck_groups g
				on a.groupid = g.id
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
				and gm.UserID = @userid
			left outer join QCheck_GroupMembership gm2
				on gm2.groupid = g.id
				and gm2.UserID <> @userid
			inner join qcheck_users u --- another person in this group 
				on u.id = gm2.userid
				and u.IsDeleted = 0
			inner join qcheck_assignments a2
				on a2.InstanceID = a.InstanceID
				and (a2.IsDeleted = 0 or a2.ID in (select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate()))
			inner join qcheck_groups g2
				on g2.id = a2.groupid
			inner join QCheck_GroupMembership gm3 --task assigned to another person
				on gm3.groupid = g2.id
				and gm3.userid <> @userid
			inner join qcheck_users u2
				on u2.id = gm3.UserID
				and u2.IsDeleted = 0
	end
	if @AssignmentType = 2  -- look for tasks assigned to the person through single person group, but also assigned to others
	begin

		insert into @assignments
		select distinct a.ID, a.InstanceID 
		from qcheck_assignments a
			inner join @alltasksdue atd
				on atd.instanceid = a.InstanceID
				and (a.IsDeleted = 0 or a.ID in (select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate()))
			inner join qcheck_groups g
				on a.groupid = g.id
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
				and gm.UserID = @userid
			left outer join QCheck_GroupMembership gm2
				on gm2.groupid = g.id
				and gm2.UserID <> @userid
			left outer join qcheck_users u --- another person in this group doesn't exist (checks in the where clause
				on u.id = gm2.userid
				and u.IsDeleted = 0
			inner join qcheck_assignments a2
				on a2.InstanceID = a.InstanceID
				and (a2.IsDeleted = 0 or a2.ID in (select ReplacingID from QCheck_AssignmentsTemporary where TempAssignmentEnd > getdate()))
			inner join qcheck_groups g2
				on g2.id = a2.groupid
			inner join QCheck_GroupMembership gm3 --task assigned to another person
				on gm3.groupid = g2.id
				and gm3.userid <> @userid
			inner join qcheck_users u2
				on u2.id = gm3.UserID
				and u2.IsDeleted = 0
		where u.id is null
	end


	SELECT 
		a.assignmentid, 
		c.name as TaskName, 
		dbo.[QCheck_AssigneesList](a.instanceid) as assignees, 
		isnull(g.name, '') as TempGroup, 
		convert(varchar, isnull(atemp.TempAssignmentStart, 0), 101) as TempAssignmentStart, 
		convert(varchar, isnull(atemp.TempAssignmentEnd , 0), 101) as TempAssignmentEnd 
	FROM @assignments a
	INNER JOIN QCheck_ChecklistInstances ci
		on a.instanceid = ci.id
	INNER JOIN QCheck_Checklists c
		on ci.ChecklistID = c.id
	LEFT OUTER JOIN QCheck_AssignmentsTemporary atemp
		on atemp.ReplacingID = a.assignmentid
		and atemp.TempAssignmentStart <= @TempAssignmentEnd
		and atemp.TempAssignmentEnd >= @TempAssignmentStart
		and isnull(atemp.TempAssignmentRemoved, 0) = 0
	LEFT OUTER JOIN QCheck_Groups g
		on g.id = atemp.TempGroupID 
	order by c.name


END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_AutoComplete]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_AutoComplete](
	@ActiveChecklistID INT,
	@CompletedBy int,
	@IsNA BIT = 0,
	@NAReason VARCHAR(MAX) = ''
) AS

BEGIN

	DECLARE @AssignedToChecklist INT,
			@ControlsChecklist INT
			
	SET @AssignedToChecklist = 0
	SET @ControlsChecklist = 0

	
	SELECT 
		@AssignedToChecklist = gm.UserID
	FROM
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_Assignments a
			ON a.InstanceID = ac.InstanceID
		INNER JOIN QCheck_Groups g
			ON g.ID = a.GroupId
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gm.UserID = @CompletedBy
			AND ac.ID = @ActiveChecklistID
	
	SELECT
		@ControlsChecklist = gm.UserID
	FROM
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
		INNER JOIN QCheck_ChecklistManagers cm
			ON c.ID = cm.ChecklistID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.ID
		INNER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
			AND gm.UserID = @CompletedBy
			AND ac.ID = @ActiveChecklistID
	
	IF @AssignedToChecklist = 0 AND @ControlsChecklist = 0
	BEGIN
		RAISERROR ('NOT ASSIGNED', 16, 1)
	END
	ELSE
	BEGIN
		
		/*UPDATE QCheck_ActiveItems
		set Completedby = @CompletedBy, CompletedDate = getdate()
		Where ActiveChecklistID = @ActiveChecklistID
		AND CompletedDate is Null*/

		DECLARE @IsCompleted bit
		EXEC QCheck_CompleteChecklist @ActiveChecklistID, @CompletedBy, @IsNA, @NAReason, @IsCompleted output
	
		If @IsCompleted = 0 
			RAISERROR ('ONLY SINGLE STEP CHECKLISTS CAN BE MARKED COMPLETE FROM A BLACKBERRY.', 16, 1)
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_BonusEmail_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[QCheck_BonusEmail_HTML]
(
	@weekly bit = 1,
	@userid int = 0,
	@group varchar(100) = null,
	@includeempid bit = 1
)
AS
BEGIN
	DECLARE @out TABLE (
			seq INT IDENTITY(1,1),
			html VARCHAR(MAX)
		)
	
	if @weekly = 1
	begin

		INSERT INTO @out (html) VALUES ('<h3>Weekly Bonus Details</h3>')
		INSERT INTO @out (html) VALUES ('<h4>Note - daily totals are capped at $30 per day, however detail below includes all bonusable usage (even if it exceeds $30)</h4>')
		INSERT INTO @out (html) VALUES ('<table cellpadding="5" cellspacing="0" border="1">')
		INSERT INTO @out (html) select '<tr><td><b>Employee</b></td>' + case when @includeempid = 0 then '' else '<td><b>Badge Num</b></td>' end + '<td><b>Dt</b></td><td><b>Usage</b></td><td><b>Bonus</b></td></tr>'

		INSERT INTO @out (html)
				SELECT 
					'<tr>' + 
					'<td>' + ISNULL(a.name, '') + '</td>' +
					case when @includeempid = 0 then '' else '<td>' + ISNULL(cast(empid as varchar(10)), '') + '</td>' end +
					'<td>' + ISNULL(CONVERT(VARCHAR(20), a.dt), '') + '</td>' + 
					'<td>' + ISNULL(a.Usage, '') + '</td>' +
					'<td>' + a.BonusEarned + '</td>' +
					'</tr>'
				FROM
				(
					select fullname as name, empid, convert(varchar, dt, 101) as dt, Usage, '$' + cast(bonus as varchar(10)) as BonusEarned
					from [QCheck_BonusDatesAmounts]
					where dt >= cast(dateadd(week, -1, getdate()) as date)
					and dt < cast(getdate() as date)
					and (userid = @userid or @userid = 0)
					and (bonusgroup = @group or @group is null)
				) a
				order by a.dt desc, a.name


		INSERT INTO @out (html) VALUES ('</table>')

		INSERT INTO @out (html) VALUES ('<br><br>')

	end

	INSERT INTO @out (html) VALUES ('<h3>Monthly Totals</h3>')
	INSERT INTO @out (html) VALUES ('<h4>Reminder, minimum of $50/mo required starting 2/1/24</h4>')
	INSERT INTO @out (html) VALUES ('<table cellpadding="5" cellspacing="0" border="1">')
	INSERT INTO @out (html) VALUES ('<tr><td><b>Month</b></td><td><b>Employee</b></td>' + case when @includeempid = 0 then '' else '<td><b>Badge Num</b></td>' end + '<td><b>Bonus</b></td></tr>')
	INSERT INTO @out (html)
			SELECT 
				'<tr>' + 
				'<td>' + ISNULL(a.mnthname, '') + '</td>' + 
				'<td>' + ISNULL(a.[FullName], '') + '</td>' +
				case when @includeempid = 0 then '' else '<td>' + ISNULL(cast(a.empid as varchar(10)), '') + '</td>' end +
				'<td>$' + ISNULL(cast(a.[bonus] as varchar(100)), '') + '</td>' +
				'</tr>'
			FROM
			(
				SELECT  [FullName], empid
				  , datename(month, (cast ([mnth] as varchar(10))) + '/1/' +(cast ([yr] as varchar(10)))) + ' ' + (cast ([yr] as varchar(10))) as  mnthname
				  , [bonus]
				  , yr
				  , mnth
			  FROM [QCheck_BonusMonths]
			  where 
				(userid = @userid or @userid = 0)
				and (bonusgroup = @group or @group is null)
				and (bonus >=50 or yr < 2024 or (yr = 2024 and mnth = 1)) -- min 50 starting 2/1/2024
			) a
			ORDER by yr desc, mnth desc, bonus desc


	SELECT html FROM @out ORDER BY seq
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_BonusIndividualEmail_Email]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_BonusIndividualEmail_Email] 
AS

BEGIN

	-- Get app configuration
	DECLARE @AppName VARCHAR(50)
	SELECT @Appname = AppName
	FROM QCheck_AppSettings WHERE ID = 1

	declare
	@MailTo VARCHAR(5000) = '',
--	@MailFrom VARCHAR(5000) = 'sqlmail@acmewidget.com',
	@MailFrom VARCHAR(5000) = (SELECT TOP 1 'sqlmail@' + BaseDomain FROM QCheck_AppSettings),
	@MailFromName VARCHAR(5000) = @Appname,
	@MailSubject VARCHAR(5000) = @Appname + ' Weekly Bonus Report'

	declare @html table (id int identity(1,1), html varchar(max))
	declare @bonususers table (id int)

	insert into @bonususers
	select distinct userid
	from [QCheck_BonusDatesAmounts]
	where dt >= cast(dateadd(week, -1, getdate()) as date)

	declare @userid int, @htmlstr varchar(max), @onerow varchar(max), @rowid int

	while exists (select 1 from @bonususers)
	begin
		select top 1 @userid = id from @bonususers
		delete from @html
		select @htmlstr = '', @onerow = '', @rowid = 0


		insert into @html exec QCheck_BonusEmail_HTML @weekly=1, @userid = @userid
		
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end

		select @MailTo = u.Email
		from qcheck_users u
		where u.id = @userid

		---EXTERNAL REFERENCE---
		/*exec [master].[dbo].[xp_smtp_sendmail]
				@to = @MailTo,
				@bcc = '',
				@from = @MailFrom,
				@from_name = @MailFromName,
				@subject = @MailSubject,
				@message = @htmlstr*/-- PER GPR 11/22 do not send


		delete from @bonususers where id = @userid
	end






	

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_BonusMonthlyEmail_Email]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_BonusMonthlyEmail_Email] 
AS

BEGIN

	-- Get app configuration
	DECLARE @AppName VARCHAR(50),
		@MailTo VARCHAR(5000) = '',
		@MailBCC VARCHAR(5000) = '',
--		@MailFrom VARCHAR(5000) = 'sqlmail@acmewidget.com',
		@MailFrom VARCHAR(5000) = (SELECT TOP 1 'sqlmail@' + BaseDomain FROM QCheck_AppSettings),
		@MailFromName VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@htmlstr varchar(max), 
		@onerow varchar(max), 
		@rowid int

	declare @html table (id int identity(1,1), html varchar(max))

	declare @bonusgroups table(
		bonusgroup varchar(100),
		supervisoremail varchar(1000)
	)

	insert into @bonusgroups
	select distinct bonusgroup, supervisoremail from qcheck_bonususers

	while exists (select 1 from @bonusgroups)
	begin

		select @htmlstr = ''

		select top 1 @AppName = bonusgroup, @MailTo = supervisoremail from @bonusgroups
		select @MailFromName = @Appname + ' - PFSProcess',
			@MailSubject = @Appname + ' - PFSProcess' + ' Monthly Bonus Report'

		insert into @html exec QCheck_BonusEmail_HTML @weekly=0, @userid = 0, @group = @Appname
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end

		--select @mailto = 'kcroft@acmewidget.com'

		exec [dbo].[xp_smtp_sendmail]
				@to = @MailTo,
				@bcc = @MailBCC,
				@from = @MailFrom,
				@from_name = @MailFromName,
				@subject = @MailSubject,
				@message = @htmlstr

		delete from @bonusgroups where bonusgroup = @AppName
	end
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_BonusProcess]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_BonusProcess]
as
begin

	insert into Qcheck_BonusCommentsLog
	select comments.userid, count(comments.foreignkeyid), cast(comments.dt as date)
	from 
		(
			select distinct bu.userid, c.ForeignKeyID, c.CommentDt as dt
			from qcheck_bonususers bu
			inner join qstatus_comments c
				on c.CommentDt > dateadd(HOUR, -24, getdate())
				and len(c.comments) >= 1
				and c.userid = bu.userid
				and bu.startdt < c.CommentDt
				and (bu.enddt > c.CommentDt or bu.enddt is null)
		) comments
		left outer join Qcheck_BonusCommentsLog c
			on c.userid = comments.userid
			and c.dt = cast(comments.dt as date)
		where c.userid is null
		group by comments.userid, cast(comments.dt as date)

	insert into QCheck_BonusTasks (userid, activechecklistid, actiontype, dt)
	select bu.userid, ac.id, 'completed a task', convert(varchar, ac.CompletedDate, 101)
	from qcheck_activechecklists ac
		inner join Qcheck_BonusUsers bu
			on bu.userid = ac.CompletedBy
			and bu.startdt < ac.CompletedDate
			and (bu.enddt > ac.CompletedDate or bu.enddt is null)
	where 
		ac.CompletedDate > isnull(bu.startdt, '1/1/2021')
		and ac.CompletedDate < isnull(bu.enddt, '1/1/2500')
		and ac.CompletedDate > dateadd(day, -30, getdate())
		and ac.completedDate < ac.DueTime
		and ac.id not in (select activechecklistid from QCheck_BonusTasks where userid = bu.userid)

	DECLARE @BaseDomain VARCHAR(30) = (SELECT TOP 1 BaseDomain FROM QCheck_AppSettings)

	INSERT INTO [QCheck_BonusStatusEmails] (userid, sentdt)
	select bu.userid, [sent] as sentdt
        from QCheck_Log_Emails c 
		inner join qcheck_bonususers bu
			on bu.userid = c.fromID
		left outer join QCheck_BonusStatusEmails l
			on l.userid = bu.userid
			and l.[SentDt] = [sent]
        where subject = 'PriorityList'
        and sent > dateadd(month, -1, getdate())
		and sent >= '2/1/2024' -- new bonus program
		and fromId <> ToID
		and l.userid is null

	union

	SELECT bu.userid, el.dt
			FROM [EmailLog] el
			inner join qcheck_users u
				on el.[from] like u.fullname + '%'
			inner join qcheck_bonususers bu
				on bu.userid = u.id
				and bu.startdt < el.dt
				and (bu.enddt is null or bu.enddt > el.dt)
			left outer join QCheck_BonusStatusEmails l
				on l.userid = bu.userid
				and l.[SentDt] = el.dt
		where post = 1
			and subject like '%status%'
			and dt > dateadd(month, -1, getdate())
--			and (cc like '%pc@acmewidget.com%' or replyto like '%pc@acmewidget.com')
			and (cc like '%pc@' + @BaseDomain + '%' or replyto like '%pc@' + @BaseDomain + '%')
			and el.dt >= '2/1/2024' -- new bonus program
			and l.userid is null


			
	INSERT INTO [qcheck_bonusemailtasks] (userid, dt)
	SELECT u.id, et.createddt 
	FROM qcheck_emailtasks et
			inner join qcheck_users u
				on u.id = et.createdby
			inner join qcheck_bonususers bu
				on bu.userid = u.id
				and bu.startdt < et.createddt 
				and (bu.enddt is null or bu.enddt > et.createddt )
			left outer join [qcheck_bonusemailtasks] l
				on l.userid = bu.userid
				and l.dt = et.createddt
	where l.userid is null and
		et.createddt > dateadd(month, -1, getdate()) and
		et.createddt >= '2/1/2024'

	INSERT INTO QCheck_BonusChangeRequests (userid, dt)
	select cr.RequestingUser, cr.requestdate
	from QCheck_Approval_ChangeRequests cr
	INNER JOIN QCheck_Approval_ActiveChecklists aac ON aac.ChangeRequestID = cr.ID AND aac.DueTime IS NOT NULL AND NULLIF(cr.Comment,'') IS NOT NULL
	LEFT OUTER JOIN QCheck_ChecklistInstances_All ci ON ci.ID = aac.InstanceID
	INNER JOIN qcheck_users u ON u.id = cr.RequestingUser
	INNER JOIN  qcheck_bonususers bu ON bu.userid = u.id AND bu.startdt < cr.requestdate AND (bu.enddt is null OR bu.enddt > cr.requestdate )
	LEFT OUTER JOIN QCheck_BonusChangeRequests l ON l.userid = bu.userid AND l.dt = cr.requestdate
	WHERE  l.userid is null and
			cr.requestdate > dateadd(month, -1, getdate()) and
			cr.requestdate >= '2/1/2024'

	
end

GO
/****** Object:  StoredProcedure [dbo].[QCheck_BonusWeeklyEmail_Email]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_BonusWeeklyEmail_Email] 
AS
BEGIN
	-- Get app configuration
	DECLARE @AppName VARCHAR(50),
		@MailTo VARCHAR(5000) = '',
		@MailBCC VARCHAR(MAX) = '',
--		@MailFrom VARCHAR(5000) = 'sqlmail@acmewidget.com',
		@MailFrom VARCHAR(5000) = (SELECT TOP 1 'sqlmail@' + BaseDomain FROM QCheck_AppSettings),
		@MailFromName VARCHAR(5000),
		@MailSubject VARCHAR(5000),
		@htmlstr varchar(max), 
		@onerow varchar(max), 
		@rowid int

	declare @html table (id int identity(1,1), html varchar(max))

	declare @bonusgroups table(
		bonusgroup varchar(100),
		supervisoremail varchar(1000)
	)

	insert into @bonusgroups
	select distinct bonusgroup, supervisoremail from qcheck_bonususers where supervisoremail is not null

	while exists (select 1 from @bonusgroups)
	begin

		select @htmlstr = '', @MailBCC  = ''

		select top 1 @AppName = bonusgroup, @MailTo = supervisoremail from @bonusgroups
		select @MailFromName = @Appname + ' - PFSProcess',
			@MailSubject = @Appname + ' - PFSProcess' + ' Weekly Bonus Report'

		--supervisor email
		insert into @html exec QCheck_BonusEmail_HTML @weekly=1, @userid = 0, @group = @Appname
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end

		exec [dbo].[xp_smtp_sendmail]
				@to = @MailTo,
				@bcc = '',
				@from = @MailFrom,
				@from_name = @MailFromName,
				@subject = @MailSubject,
				@message = @htmlstr

		select @htmlstr = '', @MailBCC  = ''

		--non supervisor email
		insert into @html exec QCheck_BonusEmail_HTML @weekly=1, @userid = 0, @group = @Appname, @includeempid = 0
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end

		select @MailBCC = 'PFSProcessUsers@phiairmedical.com; PFSProcessUsers@phihelico.com; PFSProcessUsers@PHI-INT.com;'
/*
			string_agg(cast(u.email as varchar(max)), ';')  
			from qcheck_bonususers bu
			inner join qcheck_users u
			on u.id = bu.userid
			and u.isdeleted = 0
			where bonusgroup = @AppName
			and bu.supervisoremail not like '%' + u.email + '%'
			and len(isnull(u.email, '')) > 0
*/
		exec [dbo].[xp_smtp_sendmail]
				@to = '',
				@bcc = @MailBCC,
				@from = @MailFrom,
				@from_name = @MailFromName,
				@subject = @MailSubject,
				@message = @htmlstr

		delete from @bonusgroups where bonusgroup = @AppName
	end

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Bulk_AddAssignment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Bulk_AddAssignment](
	@AssignmentID int,
	@AssigneeGroupID INT,
	@AssignedBy INT,
	@Comment VARCHAR(1000) = ''
) AS

BEGIN

	DECLARE @InstanceID INT,
		@ActiveChecklistID INT,
		@Assignees VARCHAR(8000),
		@IsAssigned BIT
	
	SELECT @InstanceID = InstanceID
	FROM QCheck_Assignments
	WHERE [ID] = @AssignmentID

	-- Don't add an assignment if the person is already assigned (i.e. somebody didn't
	-- pay attention when checking the boxes)
	IF NOT EXISTS(
		SELECT *
		FROM QCheck_Assignments
		WHERE InstanceID = @InstanceID AND GroupID = @AssigneeGroupID AND IsDeleted = 0
	) BEGIN
	
		-- Need an active checklist ID for the SP we want to call, doesn't matter which one.  It's just
		-- going be turned back into an InstanceID
 		SELECT @ActiveChecklistID = [ID]
 		FROM QCheck_ActiveChecklists
 		WHERE InstanceID = @InstanceID
		
		-- Build an assignees comma-separated list including the one being sent in.
		SET @Assignees = ''
		
		SELECT @Assignees = @Assignees + CONVERT(VARCHAR(100), GroupID) + ','
		FROM QCheck_Assignments
		WHERE InstanceID = @InstanceID
		AND IsDeleted = 0
		
		SET @Assignees = @Assignees + CONVERT(VARCHAR(100), @AssigneeGroupID)

		-- This is the SP used when you change assignees on the status report tab.  It should
		-- correctly handle being a controller or not, sending out e-mail notifications, etc.
		EXEC QCheck_UpdateAssigneesForTask @ActiveChecklistID, @Assignees, @AssignedBy, @Comment

		-- Log what was requested.  This can be used at a later date to undo the request (i.e. when
		-- the user comes back from vacation
		INSERT INTO QCheck_BulkAssigned (
			InstanceID,
			AssigneeGroupID,
			RequestedByUser,
			RequesteDate
		) VALUES (
			@InstanceID,
			@AssigneeGroupID,
			@AssignedBy,
			GETDATE()
		)

	END

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Bulk_RemoveAssignment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Bulk_RemoveAssignment](
	@AssignmentID int,
	@AssigneeGroupID INT,
	@AssignedBy INT,
	@Comment VARCHAR(1000) = ''
) AS

BEGIN

	DECLARE @InstanceID INT,
		@ActiveChecklistID INT,
		@Assignees VARCHAR(8000),
		@IsAssigned BIT
	
	SELECT @InstanceID = InstanceID
	FROM QCheck_Assignments
	WHERE [ID] = @AssignmentID

	-- Don't remove an assignment if the person is not assigned (i.e. somebody didn't
	-- pay attention when checking the boxes)
	IF EXISTS(
		SELECT *
		FROM QCheck_Assignments
		WHERE InstanceID = @InstanceID AND GroupID = @AssigneeGroupID AND IsDeleted = 0
	) BEGIN
	
		-- Need an active checklist ID for the SP we want to call, doesn't matter which one.  It's just
		-- going be turned back into an InstanceID
		SELECT @ActiveChecklistID = [ID]
		FROM QCheck_ActiveChecklists
		WHERE InstanceID = @InstanceID

		-- Build an assignees comma-separated list including the one being sent in.
		SET @Assignees = ''
		
		SELECT @Assignees = @Assignees + CONVERT(VARCHAR(100), GroupID) + ','
		FROM QCheck_Assignments
		WHERE InstanceID = @InstanceID
		AND IsDeleted = 0

		IF LEN(@Assignees) > 1 SET @Assignees = LEFT(@Assignees, LEN(@Assignees) - 1)

		-- Remove the assignee
		SET @Assignees = REPLACE(@Assignees, CONVERT(VARCHAR(20), @AssigneeGroupID), '')

		-- Clean up extra commas
		SET @Assignees = REPLACE(@Assignees, ',,', ',')
		IF LEFT(@Assignees, 1) = ',' SET @Assignees = RIGHT(@Assignees, LEN(@Assignees) - 1)
		IF RIGHT(@Assignees, 1) = ',' SET @Assignees = LEFT(@Assignees, LEN(@Assignees) - 1)
	
		-- This is the SP used when you change assignees on the status report tab.  It should
		-- correctly handle being a controller or not, sending out e-mail notifications, etc.
		EXEC QCheck_UpdateAssigneesForTask @ActiveChecklistID, @Assignees, @AssignedBy, @Comment

		-- Log what was requested.  This can be used at a later date to undo the request (i.e. when
		-- the user comes back from vacation
		UPDATE QCheck_BulkAssigned
		SET IsDeleted = 1
		WHERE
			InstanceID = @InstanceID
			AND AssigneeGroupID = @AssigneeGroupID
			AND RequestedByUser = @AssignedBy
		
	END

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Bulk_RemoveHighlighting]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_Bulk_RemoveHighlighting] (
	@UserID INT
) AS

BEGIN

	UPDATE QCheck_BulkAssigned
	SET IsDeleted = 1
	WHERE RequestedByUser = @UserID

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_BulkCompletionReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[QCheck_BulkCompletionReport]
(
	@to varchar(100) = '',
	@dt datetime = null
)
as
begin

	declare @mintasks int = 10
	declare @timewindowminutes int = 5
	declare @numberoftasks int = 10
	declare @message varchar(max)
	declare @name varchar(100), @appname varchar(100), @fromaddress varchar(100)
	declare @sendemail bit = 0

	select @appname = appname, @fromaddress = fromaddress from qcheck_appsettings where id = 1

	if @dt is null set @dt = getdate() - 1

	declare @ranges table
	(	
		id int identity(1,1),
		completedby int,
		completeddate datetime,
		distinctrange bit null
	)

	-- find all ranges of time where X (@numberoftasks) tasks are completed in the next Y (@timewindowminutes) minutes
	-- this query will use lead to find what time the Xth task was completed and compare that to a Y minute range
	insert into @ranges (completedby, completeddate)
	select completedby, completeddate
	from
	(
		select completedby, 
			completeddate, 
			lead(completeddate, @numberoftasks-1) over (partition by completedby order by completeddate asc) as groupoftasks
		from qcheck_activechecklists
		where cast(completeddate as date) = cast(@dt as date)
	) a
	where groupoftasks is not null and dateadd(minute, @timewindowminutes, completeddate) > groupoftasks

	--now that we have these ranges of time we need to eliminate the overlapping ranges
	--this is an iterative process to identify the start of each range and then remove from analysis those that start within the previous range's time range
	while exists ( select 1 from @ranges where distinctrange is null )
	begin

		;with ranges as
		(
			select r1.id, r1.completedby, r1.completeddate
			from @ranges r1
			left outer join @ranges r2
				on r2.completedby = r1.completedby
				and r2.completeddate < r1.completeddate
				and r2.completeddate > dateadd(minute, -1 * @timewindowminutes, r1.completeddate)
				and r2.distinctrange is null
			where r2.completedby is null
			and r1.distinctrange is null
		)
		update @ranges set distinctrange = 1
		where id in (select id from ranges)

		update @ranges set distinctrange = 0
		from @ranges r1
		inner join (select * from @ranges) r2
			on r2.completedby = r1.completedby
			and r2.completeddate < r1.completeddate
			and r2.completeddate > dateadd(minute, -1 * @timewindowminutes, r1.completeddate)
			and r2.distinctrange = 1
		where r1.distinctrange is null
	end


	declare @results table (
		fullname varchar(50),
		dt varchar(50),
		cnt int
	)

	--now pull counts for tasks completed within the distinct ranges calculated above
	insert into @results select fullname, dt, cnt
	from
	(
		SELECT top 1000 u.fullname, FORMAT(r.completeddate, 'hh:mm tt') as dt, count(ac.id) as cnt 
		from @ranges r
		inner join qcheck_users u
			on r.completedby = u.id
		inner join qcheck_activechecklists ac
			on ac.completedby = u.id
			and ac.completeddate >= r.completeddate
			and ac.completeddate < dateadd(minute, @timewindowminutes, r.completeddate)
		where r.distinctrange = 1
		group by u.fullname, r.completeddate
		order by u.fullname, r.completeddate
	) a

	if exists (select 1 from @results where cnt > @mintasks)
	begin
		select @message =  string_agg('<tr><td>'+fullname+'</td><td>'+dt+'</td><td class="taskcount">'+cast(cnt as varchar(10))+'</td></tr>', char(13)) 
		from @results

		declare @subject varchar(1000) = @appname + ' multiple tasks completed in a short time period ' + convert(varchar, @dt, 101)

		select @message = '
		<style>
		table { border-collapse: collapse;}
		table tr td { padding-left:5px; padding-right:5px; border: solid 1px #000000; }
		.taskcount { text-align:right; }
		</style>
		<h2>' + @appname + ' - at least ' + cast(@numberoftasks as varchar(10)) + ' tasks completed within a ' + cast(@timewindowminutes as varchar(10)) + ' minute range </h2>' +
			'<table><tr><th>Employee</th><th>Time</th><th>Task Count</th></tr>' + @message + '</table>'

		EXEC dbo.xp_smtp_sendmail
			@subject   = @subject,
			@message   = @message,
			@type      = 'text/html',
			@from_name = @appname,
			@from	   = @fromaddress,
			@to		   = @to

	end

end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_CalculateNextDueTime]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                                                                     PROCEDURE [dbo].[QCheck_CalculateNextDueTime](
      @InstanceID INT,
      @AsOfDate datetime,
      @DueDate datetime output,
      @RelativeDueDate datetime output
) AS

BEGIN
SET NOCOUNT ON

      SET @AsOfDate = IsNull(@AsOfDate, getdate())

      DECLARE @freqType int
      DECLARE @freqInterval int
      DECLARE @firstDueDate datetime
      DECLARE @lastDueDate datetime
      DECLARE @dueTime float
      DECLARE @freqRecurrance int
      DECLARE @ONCE int
      DECLARE @DAILY int
      DECLARE @WEEKLY int
      DECLARE @MONTHLY int
      DECLARE @YEARLY int
      DECLARE @busDayBehavior int
      DECLARE @busDayValue int

      DECLARE @comparedate datetime
      DECLARE @tmpInt int
      DECLARE @tmpDate datetime
      DECLARE @tmpDate2 datetime
      DECLARE @tmpstr varchar(50)
      DECLARE @tmpstr2 varchar(50)
      
      SET @comparedate = @AsOfDate
      

      SET @ONCE = 1
      SET @DAILY = 2
      SET @WEEKLY = 3
      SET @MONTHLY = 4
      SET @YEARLY = 5
      
                  
      --get all the data from the schedule table based on the id passed in
      SELECT @freqType = s.freqType, 
            @dueTime = s.dueTime,
            @freqRecurrance = s.freqRecurrance,
            @firstDueDate = s.firstDueDate, 
            @freqInterval= s.freqInterval, 
            @lastDueDate = s.lastDueDate,
            @busDayBehavior = s.busDayBehavior,
            @busDayValue = s.busDayValue
      FROM 
      QCheck_Schedule s with (nolock)
      INNER JOIN QCheck_ChecklistInstances ci with (nolock)
      ON s.ID = ci.ScheduleID
      AND ci.[ID] = @InstanceID

      -- one time schedule
      If (@freqType = @ONCE)
            BEGIN
                  --this one is easy.  we just concatinate the start date and the end time and voila.  Converting to just the date because
                  -- we're going to add the hours back in later.
                  SET @DueDate = @firstDueDate
            END
      --daily schedule
      Else If (@freqType = @DAILY)
            BEGIN
                  --if we havent come to the time of day this checklist is due, we treat it as yesterday
                  If (DatePart(hh, @compareDate)) + (DatePart(mi, @compareDate)/60.0) < @dueTime
                        SET @compareDate = @compareDate - 1
                  
                  SET @tmpInt = 0
                  --find out how many times this has occurred since it started, add one,  and multiply by the number of days per occurance
                  IF @compareDate > @firstDueDate
                        SET @tmpInt = ((DateDiff(day, @firstDueDate, @compareDate)/@freqRecurrance) + 1)*@freqRecurrance
                  
                  --add that to the start date, and we have the last time it was due
                  SET @DueDate = DateAdd(day, @tmpInt, @firstDueDate)
            END
      --weekly schedule
      Else If (@freqType = @WEEKLY)
            BEGIN
                  --if we have an interval, use the complex scheduling
                  IF (@freqInterval is not null and @freqInterval > 0)
                  BEGIN
                        
                        --declare temps
                        DECLARE @tbldays Table (daysFromNow int, dayint int)
                        DECLARE @iDay int, @daysFromNow int, @DAYOFWEEK int
                        DECLARE @totDaysFromNow int

                        
                        --if we havent come to the time of day this checklist occurs on, we treat it as yesterday
                        If (DatePart(hh, @compareDate) + DatePart(mi, @compareDate)/60.0) < @DueTime 
                              SET @compareDate = @compareDate - 1

                        SET @tmpInt = 0
                        --determine the correct week offset for this period
                        --IF @compareDate > @firstDueDate
                        SET @tmpInt = ((DateDiff(day, @firstDueDate, @compareDate)/(@freqRecurrance*7)))*@freqRecurrance*7
                        
                        if @compareDate<@firstDueDate
                              set @tmpInt = @freqRecurrance*-7
      
                        SET @tmpdate = DateAdd(day, @tmpInt, @firstDueDate)
                        SET @tmpInt = DateDiff(day, @tmpdate, @compareDate)/7 * 7

                        --day of week for today
                        SET @DAYOFWEEK = DATEPART(dw,@compareDate)
      
                        
                        SET @iDay=1
                        select @daysFromNow = ((@iDay-@DAYOFWEEK) + 6)%7 + 1 - 7 - @tmpInt
                        
                        WHILE @iDay<=7
                        BEGIN
                              if (@daysFromNow > 0)
                                    SET @daysFromNow = @daysFromNow - ((@freqRecurrance) * 7)
                              INSERT INTO @tbldays VALUES(@daysFromNow, Power(2,@iDay-1))
                              SET @iDay = @iDay + 1
                              SET @daysFromNow = @daysFromNow + 1
                        END

                              
                        --get the max value that does not return a 0 bitwise
                        SELECT @totDaysFromNow = MAX(daysFromNow) 
                        FROM @tbldays 
                        WHERE @freqInterval & dayint > 0
                        

                        --clean out the table
                        delete from @tbldays
      
                        --subtract number of days from today to get last due date
                        SET @DueDate = DateAdd(day, @totDaysFromNow, @compareDate)
                        SET @DueDate = DateAdd(hh, -1 * datepart(hour,@compareDate), @DueDate)
                        SET @DueDate = DateAdd(mi, -1 * datepart(minute,@compareDate), @DueDate)
                        SET @DueDate = DateAdd(second, -1 * datepart(second,@compareDate), @DueDate)
                        SET @DueDate = DateAdd(millisecond, -1 * datepart(millisecond,@compareDate), @DueDate)


                        --day of week for last due date
                        SET @DAYOFWEEK = DATEPART(dw,@DueDate)
      
                        --insert a 'power' row for each day of the week
                        SET @iDay=1
                        WHILE @iDay<=7
                        BEGIN
                              IF (@iDay > @DAYOFWEEK)
                                    SET @daysFromNow = ((@iDay-@DAYOFWEEK) + 6)%7 + 1
                              ELSE
                                    SET @daysFromNow = ((@iDay-@DAYOFWEEK) + 6)%7 + 1 + (7 * (@freqRecurrance - 1))

                              INSERT INTO @tbldays VALUES(@daysFromNow, Power(2,@iDay-1))
                              SET @iDay = @iDay + 1
                        END
                        
                        --get the min value that does not return a 0 bitwise
                        SELECT @totDaysFromNow = MIN(daysFromNow) 
                        FROM @tbldays 
                        WHERE @freqInterval & dayint > 0
                        
                        --add number of days to last start date
                        SET @DueDate = DateAdd(day, @totDaysFromNow, @DueDate)
                  END
                  --oherwise use the simple version and just add a number of weeks
                  ELSE 
                  BEGIN
                        --if we havent come to the time of day this checklist occurs on, we treat it as yesterday
                        If (DatePart(hh, @compareDate)) + (DatePart(mi, @compareDate)/60.0) < @DueTime 
                              SET @compareDate = @compareDate - 1

                        SET @tmpInt = 0
                        --find how many week periods have passed since we started - multiply by 7 to find number of days
                        IF @compareDate > @firstDueDate
                              SET @tmpInt = ((DateDiff(day, @firstDueDate, @compareDate)/(@freqRecurrance*7)) + 1)*@freqRecurrance*7
                        
                        --add that number of days to the start date and you get the last time it should have started
                        SET @DueDate = DateAdd(day, @tmpInt, @firstDueDate)
                  END
            END
      --monthly schedule
      Else If (@freqType = @MONTHLY)
            BEGIN

                  --if we are before the day specified or on the day but before the hour then subtract one month
                  SET @tmpstr = CAST(MONTH(@compareDate) as varchar)+'/1/'+CAST(YEAR(@compareDate)as varchar) 
                  SET @tmpdate = CAST(@tmpstr as datetime)
                  SET @tmpstr = CAST(MONTH(Dateadd(m,1,@compareDate)) as varchar)+'/1/'+CAST(YEAR(Dateadd(m,1,@compareDate))as varchar) 
                  SET @tmpdate2 = CAST(@tmpstr as datetime)
                        
                  If Not (DatePart(day, @firstDueDate) > DateDiff(d, @tmpdate, @tmpdate2) AND DatePart(day, @compareDate) = DateDiff(d, @tmpdate, @tmpdate2))
                  BEGIN
                        If DatePart(day, @compareDate) < DatePart(day, @firstDueDate) or (DatePart(day, @compareDate) = DatePart(day, @firstDueDate) and (DatePart(hh, @compareDate)) + (DatePart(mi, @compareDate)/60.0) < @DueTime)
                        BEGIN
                              SET @compareDate = dateadd(mm, -1, @compareDate)
                        END   
                  END

                  SET @tmpInt = 0
                  --find out how many times this has occurred since it started and multiply by the number of months per occurrance
                  IF @compareDate > @firstDueDate
                        SET @tmpInt = ((DateDiff(month, @firstDueDate, @compareDate)/@freqRecurrance)+1)*@freqRecurrance
                  
                  --add this number to the start date and you get the last occurrance
                  SET @DueDate = DateAdd(month, @tmpInt, @firstDueDate)
            END
      --yearly schedule
      Else If (@freqType = @YEARLY)
            BEGIN
                  IF (@freqInterval is not null and @freqInterval > 0)
                  BEGIN
                        --declare temps
                        DECLARE @tmpMonths Table (monthsFromNow int, monthInt int)
                        DECLARE @iMonth int, @monthsFromNow int, @month int
                        DECLARE @totMonthsFromNow int
                        DECLARE @tmpDay int, @iter int, @tmpMonth int, @tmpDateString varchar(50)
                        set @iter = 0
                        
                        SET @tmpDay = DAY(@firstDueDate)
                        SET @tmpDateString = CAST(MONTH(@compareDate) as varchar)+'/'+CAST(@tmpDay as varchar)+'/'+CAST(YEAR(@compareDate) as varchar)+ ' ' + CAST(CAST(@dueTime as int) as varchar)+':00:00'
                        
                        while ((isdate(@tmpDateString) = 0) and (@iter < 5))
                        BEGIN
                              set @tmpDay = DAY(@firstDueDate) - @iter
                              SET @tmpDateString = CAST(MONTH(@compareDate) as varchar)+'/'+CAST(@tmpDay as varchar)+'/'+CAST(YEAR(@compareDate) as varchar)+ ' ' + CAST(CAST(@DueTime as int) as varchar)+':00:00'
                              set @iter = @iter + 1
                        END

                        
                        
                        SET @compareDate = CAST(@tmpDateString as datetime)
                        --SET @compareDate = CAST(CAST(MONTH(@compareDate) as varchar)+'/'+CAST(DAY(@firstDueDate)as varchar)+'/'+CAST(YEAR(@compareDate) as varchar)+ ' ' + CAST(CAST(@startTime as int) as varchar)+':00:00' as datetime)
                        
                        if (@compareDate > @AsOfDate) 
                                    SET @compareDate = DateAdd(month, -1, @compareDate)
                        
                        SET @tmpInt = 0
                        --determine the correct month offset for this period
                        IF @compareDate > @firstDueDate
                              SET @tmpInt = ((DateDiff(month, @firstDueDate, @compareDate)/(@freqRecurrance*12)))*@freqRecurrance*12
                        
                        SET @tmpdate = DateAdd(month, @tmpInt, @firstDueDate)
                        SET @tmpInt = DateDiff(month, @tmpdate, @compareDate)/12 * 12
                        
                        --month for today
                        SET @month = DATEPART(m, @compareDate)
      
                        --insert a 'power' row for each month
                        SET @iMonth=1
                        SET @monthsFromNow = @iMonth - @month - @tmpInt
                        WHILE @iMonth<=12
                        BEGIN
                              if @monthsFromNow > 0 
                                    SET @monthsFromNow = @monthsFromNow - ((@freqRecurrance) * 12)
                              INSERT INTO @tmpMonths VALUES(@monthsFromNow, Power(2,@iMonth-1))
                              SET @iMonth = @iMonth + 1
                              SET @monthsFromNow = @monthsFromNow + 1
                        END

                        --get the max value that does not return a 0 bitwise
                        SELECT @totMonthsFromNow = MAX(monthsFromNow) 
                        FROM @tmpMonths 
                        WHERE @freqInterval & monthInt > 0
                        
                        delete from @tmpMonths

                        --subtract number of months from today
                        SET @tmpdate = DateAdd(month, @totMonthsFromNow, @compareDate)
                        SET @tmpstr = CAST(MONTH(@tmpdate) as varchar)+'/'+CAST(DAY(@firstDueDate)as varchar)+'/'+CAST(YEAR(@tmpdate)as varchar) + ' ' + CAST(CAST(@DueTime as int) as varchar)+':00:00'
                        
                        SET @iter = 1
                        while ((isdate(@tmpstr) = 0) and (@iter < 5))
                        BEGIN
                              set @tmpDay = DAY(@firstDueDate) - @iter
                              SET @tmpstr = CAST(MONTH(@tmpdate) as varchar)+'/'+CAST(@tmpDay as varchar)+'/'+CAST(YEAR(@tmpdate)as varchar) + ' ' + CAST(CAST(@DueTime as int) as varchar)+':00:00'
                              set @iter = @iter + 1
                        END
                        
                        SET @DueDate = CAST(@tmpstr as datetime)


                        
                        --month for last due time
                        SET @month = DATEPART(m,@DueDate)
      
                        --insert a 'power' row for each month
                        SET @iMonth=1
                        WHILE @iMonth<=12
                        BEGIN
                              IF (@iMonth > @month)
                                    SET @monthsFromNow = ((@iMonth-@month) + 11)%12 + 1
                              ELSE
                                    SET @monthsFromNow = ((@iMonth-@month) + 11)%12 + 1 + (12 * (@freqRecurrance - 1))

                              INSERT INTO @tmpMonths VALUES(@monthsFromNow, Power(2,@iMonth-1))
                              SET @iMonth = @iMonth + 1
                        END

                        --get the min value that does not return a 0 bitwise
                        SELECT @totMonthsFromNow = MIN(monthsFromNow) 
                        FROM @tmpMonths 
                        WHERE @freqInterval & monthInt > 0
                        
                        --add number of months to last start date
                        SET @tmpdate = DateAdd(month, @totMonthsFromNow, @DueDate)
      
                        --set the time
                        SET @tmpstr = CAST(MONTH(@tmpdate) as varchar)+'/'+CAST(DAY(@firstDueDate)as varchar)+'/'+CAST(YEAR(@tmpdate)as varchar) 
                        SET @iter = 1
                        while ((isdate(@tmpstr) = 0) and (@iter < 5))
                        BEGIN
                              set @tmpDay = DAY(@firstDueDate) - @iter
                              SET @tmpstr = CAST(MONTH(@tmpdate) as varchar)+'/'+CAST(@tmpDay as varchar)+'/'+CAST(YEAR(@tmpdate)as varchar)
                              set @iter = @iter + 1
                        END

                        
                        SET @DueDate = CAST(@tmpstr as datetime)
                  END
                  ELSE 
                  BEGIN
                        If DatePart(month,@compareDate) < DatePart(month, @firstDueDate) or (DatePart(month,@compareDate) = DatePart(month, @firstDueDate) and DatePart(day, @compareDate) < DatePart(day, @firstDueDate)) or (DatePart(month,@compareDate) = DatePart(month, @firstDueDate) and DatePart(day, @compareDate) = DatePart(day, @firstDueDate) and (DatePart(hh, @compareDate)) + (DatePart(mi, @compareDate)/60.0) < @DueTime)
                        BEGIN
                              SET @compareDate = DateAdd(yy, -1, @compareDate)
                        END
                        SET @tmpInt = 0
                        IF @compareDate > @firstDueDate
                              SET @tmpInt = ((DateDiff(year, @firstDueDate, @compareDate)/@freqRecurrance)+1)*@freqRecurrance
                        
                        SET @DueDate = DateAdd(year, @tmpInt, @firstDueDate)
                  END
            END



      --make sure its after the first date
      if @DueDate <= @firstDueDate or @AsOfDate <= @firstDueDate
            SET @DueDate = @firstDueDate


      --set time
      SET @DueDate = DateAdd(hh, @DueTime, @DueDate)

      
      --add minutes
      If @DueTime - cast(@DueTime as int) > 0
      BEGIN
            SET @DueDate = DATEADD(mi, 30, @DueDate)
      END

                  
      DECLARE @DueDateOrig Datetime
      SET @DueDateOrig = @DueDate

      SET @RelativeDueDate = NULL

      
      --check for after lastDueDate
      If @DueDate > dateadd(day, 1, @lastDueDate) or  @DueDate < @AsOfDate or @DueDate < @firstDueDate 
            BEGIN
                  SET @DueDate = null
                  SET @RelativeDueDate = null
                  SET @DueDateOrig = null
            END

      --if its not a business day, skip it
      IF @busDayBehavior = 1 
      BEGIN 
            IF dbo.Util_IsOfficeDay(@DueDate) = 0 
            BEGIN
                  SET @DueDate = null
            END
      END

      IF @busDayBehavior = 2 
      BEGIN
            --move due date back to the previous business day
            IF dbo.Util_IsOfficeDay(@DueDate) = 0 
            BEGIN
                  SET @DueDate = dbo.Util_PriorOfficeDayMaintainTime(@DueDate)
            END 
      END

      IF @busDayBehavior = 3 
      BEGIN
            --move due date to the next business day
            IF dbo.Util_IsOfficeDay(@DueDate) = 0 
            BEGIN
                  SET @DueDate = dbo.Util_NextOfficeDayMaintainTime(@DueDate)
            END 
      END
      
      -- for Mandi IP, must happen on a specific business day, e.g., 5th business day
      IF @busDayBehavior = 4
      BEGIN
            SET @DueDate = CAST(MONTH(@DueDate) as varchar)+'/1/'+CAST(YEAR(@DueDate)as varchar) 
            --move due date to the first business day
            IF dbo.Util_IsOfficeDay(@DueDate) = 0 
            BEGIN
                  SET @DueDate = dbo.Util_NextOfficeDayMaintainTime(@DueDate)
            END 
            
            -- @DueDate currently now holds the 1st business day of the month, add more days if needed
            IF @busDayValue > 1
                  BEGIN
                        SET @DueDate = dbo.Util_AddBusinessDays(@DueDate, @busDayValue - 1)
                  END
            
            --set time
            SET @DueDate = DateAdd(hh, @DueTime, @DueDate)

            
            --add minutes
            If @DueTime - cast(@DueTime as int) > 0
            BEGIN
                  SET @DueDate = DATEADD(mi, 30, @DueDate)
            END
      END

      If IsNull(@DueDate, 0) <>  IsNull(@DueDateOrig, 0) SET @RelativeDueDate = @DueDateOrig

end


GO
/****** Object:  StoredProcedure [dbo].[QCheck_ChecklistControllersList_Refresh]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   Proc [dbo].[QCheck_ChecklistControllersList_Refresh]
	@ChecklistID int = null
AS


IF @ChecklistID is null 
BEGIN
	Truncate table QCheck_ChecklistControllersList
END
ELSE
BEGIN
	DELETE FROM QCheck_ChecklistControllersList
	WHERE ChecklistID = @ChecklistID
END

INSERT INTO QCheck_ChecklistControllersList
select 
	distinct c.id,
	dbo.QStatus_GetChecklistControllers(c.ID)
from  QCheck_ChecklistInstances b 
INNER JOIN QCheck_Checklists c
on c.id = b.checklistid
WHERE (@ChecklistID is null or @ChecklistID = c.id)
AND c.isdeleted = 0 and b.isdeleted = 0


GO
/****** Object:  StoredProcedure [dbo].[QCheck_CheckPassword]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                    PROCEDURE [dbo].[QCheck_CheckPassword](
	@login varchar(50),
	@Password varchar(50),
	@isValid bit output
)
 AS

BEGIN

	SET NOCOUNT ON
	
	set @isValid = 0

	SELECT @isValid = 1
	FROM
		QCheck_Users
	WHERE
		ShortName = @login
	AND
		CAST([Password] AS VARBINARY) = CAST(@Password AS VARBINARY)

	SET NOCOUNT OFF

END


































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ClearActive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




create                   PROCEDURE [dbo].[QCheck_ClearActive](
	@InstanceID int
)
 AS

BEGIN

	DELETE FROM QCheck_ActiveChecklists
	WHERE InstanceID = @InstanceID

END




GO
/****** Object:  StoredProcedure [dbo].[QCheck_ClearAlertException]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[QCheck_ClearAlertException](
	@ID INT = null,
	@ActiveAlertID INT = null,
	@UserID INT = null,
	@ClearAll BIT = 0
)
AS
BEGIN
	UPDATE QCheck_AlertExceptions SET IsActive = 0
	WHERE (ID = @ID)
	OR (@ID IS NULL 
		AND	ActiveAlertID = @ActiveAlertID
		AND UserID = @UserID)
	OR (@ClearAll = 1
		AND (ActiveAlertID = @ActiveAlertID OR @ActiveAlertID IS NULL)
		AND (UserID = @UserID OR @UserID IS NULL))	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ClearControllersForChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ClearControllersForChecklist] (
	@ChecklistID INT
) AS

BEGIN

	UPDATE QCheck_ChecklistManagers
	SET IsDeleted = 1
	WHERE ChecklistID = @ChecklistID

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_CompleteTodaysChecklistInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                       PROCEDURE [dbo].[QCheck_CompleteTodaysChecklistInstance](
	@instanceID INT
)

AS BEGIN

	DECLARE @ActiveChecklistID int, @Assignee int, @isComplete bit
	
	SELECT @ActiveChecklistID = ID
	 FROM qcheck_activechecklists
	 WHERE instanceid = @instanceID
	 and convert(varchar, duetime, 101) = convert(varchar, getdate(), 101)
	 
	SELECT @Assignee = gm.userid FROM qcheck_assignments a
	 INNER JOIN QCheck_GroupMembership gm
	 on gm.groupid = a.groupid
	 WHERE a.instanceid = @instanceID 
	 
	EXEC [QCheck_CompleteChecklist] @ActiveChecklistID, @Assignee, 0, '', @isComplete output
	
	
END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_CompletionPopup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[QCheck_CompletionPopup]
(
	@UserID int
)
as
begin
	declare @numberofPopupsPerDay int = 7
	declare @numberofDaysToPopup int = 3
	declare @requirepopup varchar(1000) = ''
	declare @shortmessage varchar(1000) = ''
	declare @longmessage varchar(1000) = ''
	declare @lastmonthcount int
	declare @sixmonthcount int
	declare @popupcount int
	declare @completioncount int


	--first check if there's a message

	select @longmessage = popupmessage, @shortmessage = popupshort 
	from qcheck_appsettings


	if len(@shortmessage) > 0 and getdate() >= '12/15/2023' -- @userid in (select id from qcheck_users where shortname = 'kcroft' or shortname = 'graynor')
	begin
		--check if the user has had popups within the last 6 months (not counting recent) - if so, wait until that passes before popping up again
		select @sixmonthcount = count(popupdt)
		from QCheck_CompletionPopupLog
		where userid = @UserID
		and popupdt > cast(dateadd(month, -6, getdate()) as date)
		and popupdt < cast(dateadd(month, -1, getdate()) as date)
		
		if @sixmonthcount = 0
		begin
			--check if the user has had @numberofDaysToPopup prior days in the last month where they received the popup
			select @lastmonthcount = count(distinct cast(popupdt as date))
			from QCheck_CompletionPopupLog
			where userid = @UserID
			and popupdt >= cast(dateadd(month, -1, getdate()) as date)
			and popupdt < cast(getdate() as date)

			if @lastmonthcount < @numberofDaysToPopup
			begin
				select @popupcount = count(userid) 
				from QCheck_CompletionPopupLog
				where userid = @UserID
				and popupdt >= cast(getdate() as date)

				select @completioncount = count(id) 
				from qcheck_activechecklists
				where completedby = @UserID
				and completeddate >= cast(getdate() as date)
				and isnull(isna, 0) = 0

				if @popupcount < @numberofPopupsPerDay or @completioncount < @numberofPopupsPerDay
				begin
					/*if @completioncount = 0
					begin
						select @requirepopup = @longmessage
					end
					else
					begin
						select @requirepopup = @shortmessage
					end*/
					select @requirepopup = @longmessage

					--add today to the log
					insert into QCheck_CompletionPopupLog
					select @userid, getdate()
				end
			end
		end
	end

	select @requirepopup as requirepopup
end

GO
/****** Object:  StoredProcedure [dbo].[QCheck_ControllerDailyEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ControllerDailyEmail] AS

BEGIN

	DECLARE @AppName VARCHAR(500),
			@MailFrom VARCHAR(500),
			@MailFromName VARCHAR(500),
			@MailSubject VARCHAR(500),
			@MailServer VARCHAR(500)
			
	SELECT @AppName = AppName, @MailFrom = FromAddress, @MailServer = MailServer
	FROM QCheck_AppSettings
	WHERE ID = 1
	
	SET @MailFromName = @AppName + ' Controller Report'
	SET @MailSubject = 'New Tasks Created By Others For You To Control'

	DECLARE @NewControllerRows TABLE (
		ID INT
	)

	INSERT INTO @NewControllerRows (ID)
		SELECT ID 
		FROM QCheck_ChecklistManagers 
		WHERE ISNULL(CreateDate, '1/1/1970') > DATEADD(HOUR, -24, GETDATE())

	DECLARE @Emails TABLE (
		ID INT IDENTITY(1,1),
		Email VARCHAR(100)
	)
			
	INSERT INTO @Emails (Email)
		SELECT DISTINCT
			u.Email
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistManagers cm
				ON c.ID = cm.ChecklistID
				AND cm.IsDeleted = 0
			INNER JOIN @NewControllerRows ncr
				ON cm.ID = ncr.ID
			INNER JOIN QCheck_GroupMembership gm
				ON cm.ManagerGroupID = gm.GroupID
			INNER JOIN QCheck_Users u
				ON gm.UserID = u.ID
		WHERE
			u.ID != c.[Owner]
			and u.ShortName <> 'graynor' --remove GPR, email 12/24/19
			

	DECLARE @i INT,
			@j INT,
			@count INT,
			@taskcount INT,
			@MailTo VARCHAR(100),
			@MailBody VARCHAR(MAX),
			@Creator VARCHAR(500)
			
	CREATE TABLE #Tasks (
		ID INT IDENTITY(1,1),
		Creator VARCHAR(500),
		Created VARCHAR(500),
		Task VARCHAR(500),
		Assignees VARCHAR(1000),
		DueDate VARCHAR(500)
	)

	SELECT @i = 1, @count = COUNT(*) FROM @Emails
	WHILE @i <= @count BEGIN

		SET @MailBody = 'The following tasks were created in the last 24 hours with you as a controller.<br><br>'
		SET @MailBody = @MailBody + '<table width="1000" cellpadding="5" cellspacing="0" border="1"><tr><td><b>Creator</b></td><td><b>Created</b></td><td><b>Task</b></td><td><b>Assignees</b></td><td><b>Due Date</b></td></tr>'
		SELECT @MailTo = Email FROM @Emails WHERE ID = @i
		
		TRUNCATE TABLE #Tasks
		
		INSERT INTO #Tasks (Creator, Created, Task, Assignees, DueDate)
			SELECT
				ISNULL(o.FullName, ''),
				ISNULL(CONVERT(VARCHAR(20), cm.CreateDate), ''),
				ISNULL(c.Name, ''),
				ISNULL(dbo.QCheck_AssigneesList(ci.ID), ''),
				ISNULL(REPLACE(REPLACE(dbo.QCheck_ScheduleString(ci.ScheduleID), 'One Time on ', ''), 'Every', 'Recurring every'), '')
			FROM
				QCheck_Checklists c
				INNER JOIN QCheck_ChecklistManagers cm
					ON c.ID = cm.ChecklistID
					AND cm.IsDeleted = 0
				INNER JOIN @NewControllerRows ncr
					ON cm.ID = ncr.ID
				INNER JOIN QCheck_GroupMembership gm
					ON cm.ManagerGroupID = gm.GroupID
				INNER JOIN QCheck_Users u
					ON gm.UserID = u.ID
				INNER JOIN @Emails e
					ON u.Email = e.Email
					AND e.ID = @i
				INNER JOIN QCheck_Users o
					ON o.ID = c.[Owner]
				INNER JOIN QCheck_ChecklistInstances ci
					ON c.ID = ci.ChecklistID
			WHERE
				o.Email <> @MailTo
			ORDER BY
				o.FullName
		
		SELECT @taskcount = MAX(ID) FROM #Tasks
		SET @j = 1
		
		WHILE @j <= @taskcount BEGIN
		
			SELECT @MailBody = @MailBody + '<tr><td colspan="5" style="height:2px;background-color:#ccc;"></td></tr>' FROM #Tasks WHERE ID = @j AND Creator <> @Creator
			
			SELECT @MailBody = @MailBody +
				'<tr>' +
				'<td valign="top" nowrap>' + Creator + '</td>' +
				'<td valign="top" nowrap>' + Created + '</td>' +
				'<td valign="top">' + Task + '</td>' + 
				'<td valign="top">' + Assignees + '</td>' + 
				'<td valign="top">' + DueDate + '</td>' + 
				'</tr>'
			FROM
				#Tasks
			WHERE
				ID = @j
				
			SELECT @Creator = Creator FROM #Tasks WHERE ID = @j
		
			SET @j = @j + 1
					
		END
		
		SET @MailBody = @MailBody + '</table>'

		EXEC dbo.xp_smtp_sendmail
			@From = @MailFrom,
			@From_Name = @MailFromName,
			@Message = @MailBody,
			@Subject = @MailSubject,
			@Server = @MailServer,
			@To = @MailTo

		SET @i = @i + 1

	END
	
	DROP TABLE #Tasks

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_CopyChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_CopyChecklist] (
	@ChecklistID INT,
	@NewChecklistID INT OUTPUT,
	@GroupID INT = null,
	@NewOwner INT = null,
	@NewName VARCHAR(500) = null,
	@Force BIT = 0
) AS

BEGIN

	DECLARE @InstanceID INT,
		@NewInstanceID INT,
		@ScheduleID INT,
		@NewScheduleID INT,
		@NowDate DATETIME,
		@OldName VARCHAR(500),
		@Owner INT,
		@IsDeleted BIT,
		@i INT,
		@count INT
	
	SELECT 
		@Owner = [Owner],
		@IsDeleted = IsDeleted,
		@OldName = 	CASE 
						-- This strips off 'Copy [n] of ' from the checklist name
						WHEN PATINDEX('Copy%of %', Name) > 0 THEN SUBSTRING(Name, PATINDEX('%of%', Name) + 3, LEN(Name) - PATINDEX('%of%', Name))
						ELSE Name
					END
	FROM QCheck_Checklists
	WHERE [ID] = @ChecklistID
	
	IF @NewName is null
	BEGIN
		-- 4/9/2012 dalvarado - Per GPR, copies aren't allowed to have the same name anymore.  Instead, the first
		-- copy is named "Copy of <task>"  The next will be "Copy 2 of <task>", then Copy 3 of <task>" etc.
		SET @NewName = 'Copy of ' + @OldName
	END
	
	SET @i = 2
	
	SELECT @count = COUNT(*)
	FROM QCheck_Checklists
	WHERE [Name] = @NewName AND [Owner] = @Owner AND IsDeleted = 0
	
	WHILE @count > 0 AND @i <= 200 AND @Force = 0 BEGIN
	
		SET @NewName = 'Copy ' + CONVERT(VARCHAR(3), @i) + ' of ' + @NewName
		
		SET @i = @i + 1
		
		SELECT @count = COUNT(*)
		FROM QCheck_Checklists
		WHERE [Name] = @NewName AND [Owner] = @Owner AND IsDeleted = 0

	END
	
	INSERT INTO QCheck_Checklists (
		[Name], 
		IsDeleted, 
		Owner
	) VALUES (
		@NewName,
		@IsDeleted,
		ISNULL(@NewOwner, @Owner)
	)
	
	SELECT @NewChecklistID = @@Identity
	
	INSERT INTO QCheck_ChecklistManagers (
		ManagerGroupID, 
		ChecklistID, 
		IsDeleted
	)
		SELECT 
			ManagerGroupID, 
			@NewChecklistID, 
			0
		FROM 
			QCheck_ChecklistManagers
		WHERE 
			ChecklistID = @ChecklistID
			AND IsDeleted = 0

		UNION ALL
			
		SELECT 
			groupid,
			@NewChecklistID, 
			0
		FROM (
			SELECT TOP 1 g.id as groupID
			FROM qcheck_users u
			INNER JOIN qcheck_groupmembership gm
				ON u.id = gm.userid
			INNER JOIN qcheck_groups g
				ON g.id = gm.groupid
				AND g.singlemembergroup = 1
			WHERE u.id = @NewOwner 
				AND @NewOwner IS NOT NULL
			ORDER BY g.id ASC
		) OwnerGroup
		WHERE groupID not in (SELECT ManagerGroupID FROM QCheck_ChecklistManagers WHERE ChecklistID = @ChecklistID AND IsDeleted = 0)


		
	INSERT INTO QCheck_Items (
		ChecklistID, 
		SequenceNum, 
		ItemTypeID, 
		[Text], 
		URL, 
		IsDeleted
	)
		SELECT 
			@NewChecklistID, 
			SequenceNum, 
			ItemTypeID, 
			[Text], 
			URL, 
			0
		FROM 
			QCheck_Items	
		WHERE 
			ChecklistID = @ChecklistID
			AND IsDeleted = 0

	SELECT @NowDate = GetDate()

	DECLARE INST_CURS CURSOR FOR
		SELECT [ID]
		FROM QCheck_ChecklistInstances
		WHERE ChecklistID = @ChecklistID
	OPEN INST_CURS
	FETCH NEXT FROM INST_CURS INTO @InstanceID
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		SELECT @ScheduleID = ScheduleID
		FROM QCheck_ChecklistInstances
		WHERE ID = @InstanceID

		INSERT INTO QCheck_Schedule (
			firstDueDate, 
			lastDueDate, 
			freqType, 
			freqInterval, 
			freqRecurrance, 
			dueTime, 
			busDayBehavior,
			SoftDueOffsetDays
		)
			SELECT 
				firstDueDate, 
				lastDueDate, 
				freqType, 
				freqInterval, 
				freqRecurrance, 
				dueTime, 
				busDayBehavior,
				SoftDueOffsetDays
		FROM 
			QCheck_Schedule
		WHERE
			ID = @ScheduleID

		IF @@rowcount > 0 BEGIN
			SELECT @NewScheduleID = @@Identity
		END ELSE BEGIN
			SELECT @NewScheduleID = NULL
		END
			
		INSERT INTO QCheck_ChecklistInstances (
			[Name], 
			ChecklistID, 
			ScheduleID, 
			IsDeleted, 
			CreatedBy
		)
			SELECT 
				[Name], 
				@NewChecklistID, 
				@NewScheduleID, 
				0, 
				CreatedBy
			FROM 
				QCheck_ChecklistInstances
			WHERE
				ID = @InstanceID
				AND IsDeleted = 0

		IF @@rowcount > 0 BEGIN

			SELECT @NewInstanceID = @@IDENTITY

			INSERT INTO QCheck_Assignments (
				InstanceID, 
				GroupID, 
				IsDeleted
			)
				SELECT 
					@NewInstanceID, 
					GroupID, 
					0
				FROM 
					QCheck_Assignments
				WHERE
					InstanceID = @InstanceID
					AND IsDeleted = 0
					AND EXISTS (
						SELECT [ID]
						FROM QCheck_ChecklistInstances
						WHERE [ID] = @NewInstanceID 
						AND ChecklistID = @NewChecklistID
					)
			
			INSERT INTO QStatus_InstanceTaskType (
				InstanceID, 
				TaskType
			)
				SELECT 
					@NewInstanceID, 
					TaskType
				FROM 
					QStatus_InstanceTaskType
				WHERE 
					InstanceID = @InstanceID
	
			INSERT INTO QCheck_Alerts (
				InstanceID, 
				DaysBefore, 
				AlertTime, 
				AlertType, 
				AlertText, 
				SentTime, 
				IsDeleted, 
				AlerteeGroupID
			)
				SELECT 
					@NewInstanceID, 
					DaysBefore, 
					AlertTime, 
					AlertType, 
					AlertText, 
					Null, 
					0, 
					AlerteeGroupID
				FROM 
					QCheck_Alerts
				WHERE
					InstanceID = @InstanceID
					AND IsDeleted = 0
					AND EXISTS (
						SELECT [ID] 
						FROM QCheck_ChecklistInstances
						WHERE [ID] = @NewInstanceID 
						AND ChecklistID = @NewChecklistID
					)
			
		END
	
		FETCH NEXT FROM INST_CURS INTO @InstanceID

	END
	CLOSE INST_CURS
	DEALLOCATE INST_CURS
	
	--create a temporary controller of the task
	
	IF @GroupID is not null
	BEGIN
		DELETE FROM QCheck_ChecklistManagers_Temp
		WHERE Expires < GETDATE()
		
		INSERT INTO QCheck_ChecklistManagers_Temp (ManagerGroupID, ChecklistID, Expires)
		SELECT @GroupID, @NewChecklistID, DATEADD(minute, 15, getdate())
	END
	
	INSERT INTO QCheck_CopiedChecklists (ChecklistID, NewChecklistID)
	SELECT @ChecklistID, @NewChecklistID
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_CopyInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_CopyInstance] (
	@InstanceID INT,
	@GroupID INT = -1
) AS

BEGIN
	
	DECLARE @NewInstanceID INT
	DECLARE @ScheduleID INT
	DECLARE @NewScheduleID INT
	DECLARE @NowDate DATETIME
	DECLARE @ChecklistID INT
	DECLARE @FreqType INT

	
	SELECT @NowDate = GetDate()

	SELECT 
		@ScheduleID = ScheduleID, 
		@ChecklistID = ChecklistID
	FROM 
		QCheck_ChecklistInstances
	WHERE
		[ID] = @InstanceID

	INSERT INTO QCheck_Schedule (
		firstDueDate, 
		lastDueDate, 
		freqType, 
		freqInterval, 
		freqRecurrance, 
		dueTime, 
		busDayBehavior,
		SoftDueOffsetDays
	)
		SELECT 
			firstDueDate, 
			lastDueDate, 
			freqType, 
			freqInterval, 
			freqRecurrance, 
			dueTime, 
			busDayBehavior,
			SoftDueOffsetDays
		FROM 
			QCheck_Schedule
		WHERE
			[ID] = @ScheduleID

	SELECT @NewScheduleID = @@Identity
		
	INSERT INTO QCheck_ChecklistInstances (
		[Name], 
		ChecklistID, 
		ScheduleID, 
		IsDeleted, 
		CreatedBy
	)
		SELECT 
			[Name], 
			@ChecklistID, 
			@NewScheduleID,  
			0, 
			CreatedBy
		FROM 
			QCheck_ChecklistInstances
		WHERE
			[ID] = @InstanceID
			AND IsDeleted = 0

	SELECT @NewInstanceID = @@Identity

	INSERT INTO QCheck_Assignments (
		InstanceID, 
		GroupID, 
		IsDeleted
	)
		SELECT 
			@NewInstanceID, 
			CASE WHEN @GroupID = -1 THEN GroupID ELSE @GroupID END,  
			IsDeleted
		FROM 
			QCheck_Assignments
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	INSERT INTO QStatus_InstanceTaskType (
		InstanceID, 
		TaskType
	)
		SELECT 
			@NewInstanceID, 
			TaskType
		FROM 
			QStatus_InstanceTaskType
		WHERE 
			InstanceID = @InstanceID
	
	INSERT INTO QCheck_Alerts (
		InstanceID, 
		DaysBefore, 
		AlertTime, 
		AlertType, 
		AlertText, 
		SentTime, 
		IsDeleted, 
		AlerteeGroupID
	)
		SELECT 
			@NewInstanceID, 
			DaysBefore, 
			AlertTime, 
			AlertType, 
			AlertText, 
			NULL, 
			0, 
			AlerteeGroupID
		FROM 
			QCheck_Alerts
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	SELECT 
		@FreqType = FreqType 
	FROM 
		QCheck_Schedule
	WHERE
		[ID] = @ScheduleID
	
	EXEC QCheck_SetUpcomingInstance @NewInstanceID

	IF @FreqType = 1 BEGIN

		EXEC QCheck_ActivateInstance @NewInstanceID, @NowDate

	END ELSE BEGIN

		EXEC QCheck_ActivateFutureInstance @NewInstanceID

	END
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_Create]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will ALTER  a new checklist.
-- ID is the checklist Id and it is sent back to the UI
CREATE PROCEDURE [dbo].[QCheck_Create](
	@ID INT OUTPUT,
	@Name varchar(500),
	@CreatedBy int,
	@IsReminder BIT = 0
)
 AS

BEGIN

	SET NOCOUNT ON
	
	--simple insert

	INSERT INTO QCheck_Checklists
	([Name], Owner)
	VALUES
	(@Name, @CreatedBy)

	SELECT @ID = @@IDENTITY	

	IF @IsReminder = 1 BEGIN

		-- Creator is the controller
		DECLARE @GroupID int
		SELECT @GroupID = ID
		FROM QCheck_Groups
		WHERE Owner = @CreatedBy
		AND SingleMemberGroup = 1

		INSERT INTO QCheck_ChecklistManagers
		(ChecklistID, ManagerGroupID)
		VALUES (@ID, @GroupID)

	END ELSE BEGIN

		-- Creator's manager is the controller
		INSERT INTO QCheck_ChecklistManagers (
			ChecklistID, 
			ManagerGroupID
		)	
			SELECT
				@ID,
				G.[ID]
			FROM 
				QCheck_Users U
				INNER JOIN QStatus_Report R
					ON U.FullName = R.[Name]
				INNER JOIN QStatus_Supervisors S
					ON R.[ID] = S.ReportID
					AND S.DirectSupervisor = 1
					AND S.InterestedParty = 0
				INNER JOIN QCheck_Groups G
					ON S.SupervisorGroupID = G.[ID]
			WHERE
				U.[ID] = @CreatedBy

	END

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_CreateActiveAlerts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                                         PROCEDURE [dbo].[QCheck_CreateActiveAlerts](
	@InstanceID INT
)
 AS

BEGIN
	
	SET NOCOUNT ON
	INSERT INTO QCheck_ActiveAlerts (AlertID, ActiveChecklistID)
		SELECT distinct a.ID, c.ID
		FROM
			QCheck_Alerts a
		INNER JOIN
			QCheck_ChecklistInstances b
		   ON
			a.InstanceID = b.ID
		   AND 
			b.IsDeleted = 0
		   AND 
			b.ID = @InstanceID
		INNER JOIN 
			QCheck_ActiveChecklists c
		   ON
			b.ID = c.InstanceID
		   AND
			c.CompletedDate IS NULL
		INNER JOIN
			QCheck_Checklists d
		  ON 
			b.ChecklistID = d.[ID]
		  AND
			d.IsDeleted = 0
		LEFT OUTER JOIN
			QCheck_ActiveAlerts aa
		ON
			aa.AlertID = a.ID
		AND
			aa.ActiveChecklistID = c.ID
		WHERE
			a.IsDeleted = 0
		AND
			(a.AlertType = 'Overdue'
			OR
				a.AlertType = 'Hours'
			OR
				a.AlertType = 'Custom'
			OR
				a.AlertType = 'Reminder'
			)
		AND
			aa.ID Is NULL


	

	SET NOCOUNT OFF

END





































GO
/****** Object:  StoredProcedure [dbo].[QCheck_CreateInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_CreateInstance](
	@ID INT = NULL OUTPUT,
	@ChecklistID INT,
	@Name VARCHAR(500) = '',
	@CreatedBy INT,
	@ChangeID INT = -1
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @ScheduleID INT

	BEGIN TRAN
	
	--simple insert
	INSERT INTO QCheck_ChecklistInstances (
		[Name], 
		ChecklistID, 
		CreatedBy
	) VALUES (
		@Name, 
		@ChecklistID, 
		@CreatedBy
	)

	SET @ID = @@IDENTITY

	-- If this is a requested change, we need to mark the "live" instance as deleted and
	-- put an instance into the Approval table.  Also need to create a schedule for the
	-- new instance.
	IF @ChangeID <> -1 BEGIN

		UPDATE QCheck_ChecklistInstances
		SET IsDeleted = 1
		WHERE [ID] = @ID

		INSERT INTO QCheck_Schedule (
			firstDueDate,
			lastDueDate,
			freqType,
			freqInterval,
			freqRecurrance,
			dueTime,
			busDayBehavior
		) VALUES (
			DATEADD(DAY, 1, GETDATE()),
			NULL,
			1,
			NULL,
			NULL,
			19.0,
			0
		)

		SELECT @ScheduleID = @@IDENTITY

		UPDATE QCheck_ChecklistInstances 
		SET ScheduleID = @ScheduleID
		WHERE [ID] = @ID

		INSERT INTO QCheck_Approval_ChecklistInstances (
			ChangeRequestID,
			InstanceID,
			[Name],
			ChecklistID,
			ScheduleID,
			IsDeleted,
			CreatedBy
		)
			SELECT
				@ChangeID,
				@ID,
				[Name],
				ChecklistID,
				ScheduleID,
				0,
				CreatedBy
			FROM
				QCheck_ChecklistInstances
			WHERE
				[ID] = @ID

		INSERT INTO QCheck_Approval_Schedule (
			ChangeRequestID,
			ScheduleID,
			FirstDueDate,
			LastDueDate,
			FreqType,
			FreqInterval,
			FreqRecurrance,			DueTime,
			BusDayBehavior			
		)
			SELECT
				@ChangeID,
				@ScheduleID,
				FirstDueDate,
				LastDueDate,
				FreqType,
				FreqInterval,
				FreqRecurrance,
				DueTime,
				BusDayBehavior
			FROM
				QCheck_Schedule
			WHERE
				[ID] = @ScheduleID

	END

	COMMIT TRAN

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_CreateSimpleTemplate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_CreateSimpleTemplate](
	@Name varchar(500),
	@CreatedBy varchar(100),
	@Controller varchar(100),
	@Folder varchar(100)
) AS

BEGIN

	SET NOCOUNT ON
	
	Declare @ID int
	Declare @owner int
	
	Select @owner = ID 
	from qcheck_users
	where shortname = @CreatedBy
		
	INSERT INTO QCheck_Checklists
	([Name], Owner, Template)
	VALUES
	(@Name, @owner, 1)

	SELECT @ID = @@IDENTITY	
	
	DECLARE @ControllerGroupID int
	SELECT @ControllerGroupID = ID
	FROM QCheck_Groups
	WHERE name = @Controller

	INSERT INTO QCheck_ChecklistManagers
	(ChecklistID, ManagerGroupID)
	VALUES (@ID, @ControllerGroupID)


	INSERT INTO QCheck_FolderChecklists
		SELECT 
			@ID, f.ID
		FROM 
			QCheck_Folders f
		INNER JOIN QCheck_GroupMembership gm
			on gm.groupID = @ControllerGroupID
		WHERE 
			f.userID = gm.userID
			and folderName = @Folder
		

	EXEC QCheck_AddItem @ID, null, 2, @Name, ''
	
	-- rebuild cache
    EXEC QCheck_ChecklistControllersList_Refresh @ID

	SELECT @ID

	
	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_DailyOverdueAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_DailyOverdueAlert] (
	@LateRun BIT = 0
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @Alertee INT

	CREATE TABLE ##PHIDAILYOVERDUEALERTWORK (
		[ID] int,
		ActiveChecklistID int,
		ChecklistName VARCHAR(500),
		Alertee int,
		AlertText VARCHAR(250),
		AlertType VARCHAR(10),
		DueTime DATETIME,
		Assigned BIT,
		CheckListId int--added by venkat 03/27/2018
	)

	INSERT INTO ##PHIDAILYOVERDUEALERTWORK (
		[ID],
		ActiveChecklistID,
		ChecklistName,
		Alertee,
		AlertText,
		AlertType,
		DueTime,
		Assigned,
		CheckListId--added by venkat 03/27/2018
	)
		-- Overdue alerts to assignees
		SELECT DISTINCT 
			null as ActiveAlertID, 
			a.[ID], 
			f.[Name], 
			u.[ID], 
			'', 
			'Overdue',
			a.DueTime,
			1,
			f.ID --added by venkat 03/27/2018
		FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ActiveAssignments b
				ON b.ActiveChecklistID = a.ID
			INNER JOIN QCheck_Assignments c
				ON b.AssignmentsID = c.ID
				AND c.IsDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = c.GroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do 
				ON u.ID = do.UserID
			LEFT OUTER JOIN QCheck_DailyOverdueBCC bcc
				ON u.ID = bcc.UserID
		WHERE
			-- dont email if this is set
			do.UserID is null
			AND DueTime <= getDate()
			AND CompletedDate is null
			AND (
				@LateRun = 0
				OR bcc.UserID IS NOT NULL
			)

		UNION

		-- Overdue alerts to controllers
		SELECT DISTINCT 
			null as ActiveAlertID,
			a.[ID],
			f.[Name],
			u.[ID],
			'',
			'Overdue',
			a.DueTime,
			0,
			f.ID --added by venkat 03/27/2018
		FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_ChecklistManagers cm
				ON f.[ID] = cm.ChecklistID AND cm.isDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = cm.ManagerGroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do
				ON u.ID = do.UserID
			LEFT OUTER JOIN QCheck_DailyOverdueBCC bcc
				ON u.ID = bcc.UserID
		WHERE
			-- dont email if this is set
			do.UserID is null
			AND DueTime <= getDate()
			AND CompletedDate is null
			AND (
				@LateRun = 0
				OR bcc.UserID IS NOT NULL
			)

	
	DECLARE ALERTEECURS CURSOR FOR 
		SELECT DISTINCT d.Alertee 
		FROM ##PHIDAILYOVERDUEALERTWORK  d
		INNER JOIN QCheck_users u
			on u.id = d.Alertee
			and u.ShortName <> 'graynor' --remove GPR, email 12/24/19

	OPEN ALERTEECURS

	FETCH NEXT FROM ALERTEECURS INTO @Alertee
	WHILE @@FETCH_STATUS = 0 BEGIN

		EXEC QCheck_DailyOverdueAlert_SingleUser @Alertee, @LateRun

		FETCH NEXT FROM ALERTEECURS INTO @Alertee

	END

	CLOSE ALERTEECURS
	DEALLOCATE ALERTEECURS

	DROP TABLE ##PHIDAILYOVERDUEALERTWORK

	SET NOCOUNT OFF

END























GO
/****** Object:  StoredProcedure [dbo].[QCheck_DailyOverdueAlert_SingleUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_DailyOverdueAlert_SingleUser](
	@Alertee int,
	@LateRun bit = 0
) AS

BEGIN
	SET NOCOUNT ON

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1
	
	DECLARE @mail_to VARCHAR(500)
	DECLARE @mail_from VARCHAR(500)
	DECLARE @mail_subject VARCHAR(500)
	DECLARE @mail_sub_subject varchar(250)
	DECLARE @ActiveChecklistID int
	DECLARE @AlertType varchar(50)
	DECLARE @ChecklistName varchar(500)
	DECLARE @i int
	DECLARE @mail_bcc VARCHAR(500) = ''
	DECLARE @ReportFor VARCHAR(500)
	SET @i = 0
	SET @mail_sub_subject = ''

	SELECT @mail_to = Email FROM QCheck_Users where ID = @Alertee

	SET @Mail_From = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	

	DECLARE @cnt int
	SELECT @cnt = count(*) FROM ##PHIDAILYOVERDUEALERTWORK
	WHERE Alertee = @Alertee

	SET @mail_subject = @AppName + ' Overdue Report'

	SELECT @mail_bcc = BCC
	FROM QCheck_DailyOverdueBCC
	WHERE UserID = @Alertee

	SET @mail_bcc = ISNULL(@mail_bcc, '')
	
	declare @html table (id int identity(1,1), html varchar(max))
	insert into @html exec [QCheck_DailyOverdueAlert_SingleUser_HTML] @Alertee
	declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
	while exists (select 1 from @html)
	begin
		select top 1 @rowid = id from @html order by id asc
		select @onerow = html from @html where id = @rowid
		select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
		delete from @html where id = @rowid
	end

	IF @LateRun = 0 BEGIN
	
		IF @cnt > 0 BEGIN

			exec [dbo].[xp_smtp_sendmail]
				@to = @mail_to,
				@from = @mail_from,
				@subject = @mail_subject,
				@message = @htmlstr

				
		END

	END
	
	IF @LateRun = 1 BEGIN
	
		IF LEN(@mail_bcc) > 0 BEGIN
		
			SELECT @ReportFor = FullName
			FROM QCheck_Users
			WHERE ID = @Alertee
			
			SET @mail_subject = @mail_subject + ' for ' + ISNULL(@ReportFor, '')
			
			--kc 12/14/16
			--new rules
			--only email the special email (currently to GPR/Nelson for Tim overdue)
			--if there are tasks over 7 days overdue or 
			--or if there are more than 5 tasks over 4 days overdue
			
			--first, check the count of items > 5 days overdue
			SELECT @cnt = count(*) FROM ##PHIDAILYOVERDUEALERTWORK
			WHERE Alertee = @Alertee
			AND DueTime < dateadd(day, -4, getdate())
			
			--if more than 5, remove all tasks that are less than 4 days overdue
			if @cnt > 5
			BEGIN
				DELETE FROM ##PHIDAILYOVERDUEALERTWORK 
				WHERE Alertee = @Alertee
				AND DueTime >= dateadd(day, -4, getdate())
			END
			ELSE
			BEGIN
				--remove tasks less than 7 days overdue
				DELETE FROM ##PHIDAILYOVERDUEALERTWORK 
				WHERE Alertee = @Alertee
				AND DueTime >= dateadd(day, -7, getdate())
				
				SELECT @cnt = count(*) FROM ##PHIDAILYOVERDUEALERTWORK
				WHERE Alertee = @Alertee
			END
		
			IF @cnt > 0 BEGIN
			
				exec [dbo].[xp_smtp_sendmail]
					@to = @mail_to,
					@from = @mail_from,
					@subject = @mail_subject,
					@message = @htmlstr,
					@bcc = @mail_bcc
					
			END
			
		END
		
	END
	
	SET NOCOUNT OFF
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_DailyOverdueAlert_SingleUser_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_DailyOverdueAlert_SingleUser_HTML]
	@Alertee int
AS


BEGIN
	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1
	
	DECLARE @ChecklistID int
	DECLARE @InstanceID int
	DECLARE @AppURL varchar(50),
	@ExtURL varchar(50),
	@ImagesURL varchar(50),
	@IsController BIT

	SELECT @appURL = AppURL, @ExtURL = ExternalURL, @ImagesURL = ImagesURL
	FROM QCheck_AppSettings a
	INNER JOIN QCheck_Users u
	ON a.ID = u.App
	AND u.ID = @Alertee

	DECLARE @tmpBody VARCHAR(max),
			@DueTime DATETIME,
			@supervisors VARCHAR(1000),
			@supervisor varchar(50),
			@assignees VARCHAR(1000),
			@assignee VARCHAR(50),
			@assigneeID int,
			@isAssigned bit,
			@Reports VARCHAR(5000),
			@ActiveChecklistID int,
			@ID int,
			@ChecklistName varchar(500),
			@AlertText varchar(250),
			@AlertType VARCHAR(10),
			@ATCount INT,
			@ABCount INT,
			@CTCount INT,
			@CBCount INT
	
     DECLARE @GPRUserID INT
	SELECT @GPRUserID = GPRUserID FROM QCheck_AppSettings WHERE ID = 1

	declare @pendingExtensionRequests table
	(
	  checklistId int,
	  instanceId int,
	  extensionRequestDate datetime,
	  NewDueTime datetime
	)
	
	Insert into @pendingExtensionRequests(checklistId,instanceId,extensionRequestDate,NewDueTime)
	SELECT 
	chk.ID 
	,chk.InstanceID
	,CR.RequestDate
	,chk.DueTime
	
	FROM 
		QCheck_Approval_ChangeRequests CR
		inner join (
			SELECT 
				ac.ChangeRequestID, c.id, c.name, ci.ID AS InstanceID,AC.DueTime
			FROM  
				QCheck_Approval_ActiveChecklists AC
				INNER JOIN QCheck_ChecklistInstances CI
					ON AC.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]
	
			/*UNION
			
			SELECT
				A.ChangeRequestID, C.[ID], c.name, ci.ID AS InstanceID,''
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_ChecklistInstances CI
					ON A.InstanceID = CI.[ID]
				INNER JOIN QCheck_Checklists C
					ON CI.ChecklistID = C.[ID]*/
									
			UNION 
	
			/*SELECT
				I.ChangeRequestID,  C.[ID], c.name, -1 AS InstanceID,''
			FROM 
				QCheck_Approval_Items I
				INNER JOIN QCheck_Checklists C
					ON I.ChecklistID = C.[ID]*/
			SELECT
				I.ChangeRequestID,  I.ChecklistID, I.Name, -1 AS InstanceID,''
			FROM 
				QCheck_Approval_Checklists I
			where I.IsDeleted=1
		
		) AS chk
			ON chk.ChangeRequestID = cr.id
		INNER JOIN QCheck_Users RU
			ON CR.RequestingUser = RU.[ID]
	WHERE
		--CR.IsActive = 1
		--AND CR.Approved = 0 
		--AND 
		CR.Rejected = 0
		AND CR.ReadyForSupervisor = 1
		--AND CR.RequestingUser=652
		
	ORDER BY
		RequestDate


	 Declare @startDate datetime=dateadd(day, datediff(day,'19000101',getdate()), CAST('00:00' AS DATETIME))
     Declare @endDate datetime=Getdate()
     declare @overdueTasks table--added by venkat 04/24/2018
	(
	  ActiveChecklistId int
	 
	)
	Insert into @overdueTasks(ActiveChecklistId)--added by venkat 04/24/2018
	select ActiveCheckListId from [fn_GetOverdueTasks_MultipleAssignees](@startDate,@endDate)

	-- table that will hold the html
	
	DECLARE @html_output TABLE (
		seq INT IDENTITY(1,1),
		row_html VARCHAR(5000)
	)
	
	SELECT @ATCount = COUNT(*)
		FROM ##PHIDAILYOVERDUEALERTWORK 
		WHERE Alertee = @Alertee
		AND Assigned = 1
		AND DueTime BETWEEN CONVERT(VARCHAR(10), GETDATE(), 101) AND GetDate()
		
	SELECT @ABCount = COUNT(*)
		FROM ##PHIDAILYOVERDUEALERTWORK 
		WHERE Alertee = @Alertee
		AND Assigned = 1
		AND DueTime < CONVERT(VARCHAR(10), GETDATE(), 101)
		
	SELECT @CTCount = COUNT(*)
		FROM ##PHIDAILYOVERDUEALERTWORK 
		WHERE Alertee = @Alertee
		AND Assigned = 0
		AND DueTime BETWEEN CONVERT(VARCHAR(10), GETDATE(), 101) AND GetDate()
		AND ActiveChecklistID NOT IN (
				SELECT DISTINCT ActiveChecklistID
				FROM ##PHIDAILYOVERDUEALERTWORK 
				WHERE Alertee = @Alertee
				AND Assigned = 1
			)
		
	SELECT @CBCount = COUNT(*)
		FROM ##PHIDAILYOVERDUEALERTWORK 
		WHERE Alertee = @Alertee
		AND Assigned = 0
		AND DueTime < CONVERT(VARCHAR(10), GETDATE(), 101)
		AND ActiveChecklistID NOT IN (
				SELECT DISTINCT ActiveChecklistID
				FROM ##PHIDAILYOVERDUEALERTWORK 
				WHERE Alertee = @Alertee
				AND Assigned = 1
			)
		
	-- Style sheet
	INSERT INTO @html_output (row_html) SELECT '<html><head><style>TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;} .hide {display:none} TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style></head><body>'
	
	-- Page header
	INSERT INTO @html_output (row_html) SELECT '<h1>' + @AppName + ' Daily Overdue Report</h1>'
	INSERT INTO @html_output (row_html) SELECT '<span style="font-size:14pt">The tasks below are overdue in ' + @AppName + '.  Please take a few minutes right now to take care of them.</span><br/><br/><br/><br/>'
	
	--=======================
	-- Assigned Tasks
	--=======================
	IF @ATCount + @ABCount > 0 BEGIN
		INSERT INTO @html_output (row_html) SELECT '<h2>Assigned To You</h2>'
	END
	
	IF @ATCount > 0 BEGIN
		-- Overdue today
		INSERT INTO @html_output (row_html) SELECT '<h3>Overdue Today</h3>'
		INSERT INTO @html_output (row_html) SELECT '<table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Alert</th><th>Complete</th><th style="font-size:12.0pt;width:150px;white-space:nowrap;">N/A&nbsp;-&nbsp;Close&nbsp;Task</th><th style="width:180px;;white-space:nowrap;">Extension</th><th>Due</th><th>Reports</th><th>Assigned To</th><th>Supervisors<span class="hide"><br></span></th></tr>'--addec by venkat 04/24/2018

		DECLARE ASSIGNEDTODAYCURS CURSOR FOR
			SELECT ID, ActiveChecklistID, ChecklistName, AlertText, AlertType, DueTime, Assigned,CheckListId --added by venkat 04/24/2018
			FROM ##PHIDAILYOVERDUEALERTWORK 
			WHERE Alertee = @Alertee
			AND Assigned = 1
			AND DueTime BETWEEN CONVERT(VARCHAR(10), GETDATE(), 101) AND GetDate()
			ORDER BY DueTime

		OPEN ASSIGNEDTODAYCURS
		
		FETCH NEXT FROM ASSIGNEDTODAYCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned,@CheckListId--added by venkat 04/24/2018
		WHILE @@FETCH_STATUS = 0 BEGIN
				

			SELECT @supervisors = dbo.QCheck_ManagersList(ci.ChecklistID),
				@assignees = dbo.QCheck_AssigneesList(ci.ID)
			FROM QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
			on ci.ID = ac.InstanceID
			WHERE ac.ID = @activeChecklistID
			
			SELECT @Reports = dbo.QStatus_ActiveChecklistReportLinks(@ActiveChecklistID, @Alertee, '<br/>')
			IF LEN(@Reports) = 0 SET @Reports = '&nbsp;'


			SET @tmpBody = '<tr><td><span class="hide">Task: </span>'+@ChecklistName+'<span class="hide"><br><br></span></td>'
			IF @AlertType = 'Overdue' or @AlertType = 'Hours' SET @AlertText = 'Overdue' 
			
			SET @tmpBody = @tmpBody + '<td><span class="hide">Alert Type: </span>'+@AlertText+'<span class="hide"><br><br></span></td>'
			-- Complete link
			SET @tmpBody = @tmpBody + '<td><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=0&daily=' + convert(char(1), dbo.QCheck_IsDailyChecklist(@ActiveChecklistID)) + '">Complete</a><span class="hide"><br><br></span></td>'
			-- N/A link
			SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=1">N/A&nbsp;-&nbsp;Close&nbsp;Task</a><span class="hide"><br><br></span></td>'
			-- Extension link
			SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/ExtensionRequest.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'">Extend&nbsp;Deadline&nbsp;2&nbsp;Days</a><span class="hide"><br><br></span></td>'
			
			SET @tmpBody = @tmpBody + 
				'<td><span class="hide">Due Date: </span>'+CAST(@DueTime as varchar(20))+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Reports: </span>'+@reports+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Assigned To: </span>'+@assignees+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Supervisors: </span>'+@supervisors+'<span class="hide"><br><br></span></td></tr>'--added by venkat 04/24/2018''

			insert into @html_output (row_html) select @tmpBody

			FETCH NEXT FROM ASSIGNEDTODAYCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned,@CheckListId--added by venkat 04/24/2018
		END
		CLOSE ASSIGNEDTODAYCURS
		DEALLOCATE ASSIGNEDTODAYCURS
		
		insert into @html_output (row_html) select '</table>'

		-- Spacer
		insert into @html_output (row_html) select '<br/><br/>'
	
	END
	
	IF @ABCount > 0 BEGIN
		-- Assigned overdue today header
		INSERT INTO @html_output (row_html) SELECT '<h3>Overdue Before Today</h3>'
		INSERT INTO @html_output (row_html) SELECT '<table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Alert</th><th>Complete</th><th style="font-size:12.0pt;width:150px;white-space:nowrap;">N/A&nbsp;-&nbsp;Close&nbsp;Task</th><th style="width:180px;;white-space:nowrap;">Extension</th><th>Due</th><th>Reports</th><th>Assigned To</th><th>Supervisors<span class="hide"><br></span></th></tr>'

		DECLARE ASSIGNEDOLDERCURS CURSOR
		FOR
		SELECT ID, ActiveChecklistID, ChecklistName, AlertText, AlertType, DueTime, Assigned
		FROM ##PHIDAILYOVERDUEALERTWORK 
		WHERE Alertee = @Alertee
		AND Assigned = 1
		AND DueTime < CONVERT(VARCHAR(10), GETDATE(), 101)
		ORDER BY DueTime

		OPEN ASSIGNEDOLDERCURS
		
			FETCH NEXT FROM ASSIGNEDOLDERCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned
			WHILE @@FETCH_STATUS = 0 BEGIN
			
				SELECT @supervisors = dbo.QCheck_ManagersList(ci.ChecklistID),
					@assignees = dbo.QCheck_AssigneesList(ci.ID)
				FROM QCheck_ActiveChecklists ac
				INNER JOIN QCheck_ChecklistInstances ci
				on ci.ID = ac.InstanceID
				WHERE ac.ID = @activeChecklistID

				SELECT @Reports = dbo.QStatus_ActiveChecklistReportLinks(@ActiveChecklistID, @Alertee, '<br/>')
				IF LEN(@Reports) = 0 SET @Reports = '&nbsp;'


				SET @tmpBody = '<tr><td><span class="hide">Task: </span>'+@ChecklistName+'<span class="hide"><br><br></span></td>'
				IF @AlertType = 'Overdue' or @AlertType = 'Hours' SET @AlertText = 'Overdue' 
				
				SET @tmpBody = @tmpBody + '<td><span class="hide">Alert Type: </span>'+@AlertText+'<span class="hide"><br><br></span></td>'
				-- Complete link
				SET @tmpBody = @tmpBody + '<td><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=0&daily=' + convert(char(1), dbo.QCheck_IsDailyChecklist(@ActiveChecklistID)) + '">Complete</a><span class="hide"><br><br></span></td>'
				-- N/A link
				SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=1">N/A&nbsp;-&nbsp;Close&nbsp;Task</a><span class="hide"><br><br></span></td>'
				-- Extension link
				SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/ExtensionRequest.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'">Extend&nbsp;Deadline&nbsp;2&nbsp;Days</a><span class="hide"><br><br></span></td>'
				
				SET @tmpBody = @tmpBody + 
					'<td><span class="hide">Due Date: </span>'+CAST(@DueTime as varchar(20))+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Reports: </span>'+@reports+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Assigned To: </span>'+@assignees+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Supervisors: </span>'+@supervisors+'<span class="hide"><br><br></span></td>></tr>'--added by venkat 03/13/2018
		
				insert into @html_output (row_html) select @tmpBody


			FETCH NEXT FROM ASSIGNEDOLDERCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned
		END
		CLOSE ASSIGNEDOLDERCURS
		DEALLOCATE ASSIGNEDOLDERCURS
		
		insert into @html_output (row_html) select '</table>'

		-- Spacer
		insert into @html_output (row_html) select '<br/><br/>'
	
	END
	
	
	--=======================
	-- Controlled Tasks
	--=======================
	IF @CTCount + @CBCount > 0 BEGIN
		INSERT INTO @html_output (row_html) SELECT '<h2>Controlled By You</h2>'
	END
	
	IF @CTCount > 0 BEGIN
	
		-- Overdue today
		INSERT INTO @html_output (row_html) SELECT '<h3>Overdue Today</h3>'
		INSERT INTO @html_output (row_html) SELECT '<table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Alert</th><th>Complete</th><th style="font-size:12.0pt;width:150px;white-space:nowrap;">N/A&nbsp;-&nbsp;Close&nbsp;Task</th><th style="width:180px;;white-space:nowrap;">Extension</th><th>Due</th><th>Reports</th><th>Assigned To</th><th>Supervisors<span class="hide"><br></span></th></tr>'--addec by venkat 04/24/2018

		DECLARE ASSIGNEDTODAYCURS CURSOR FOR
			SELECT ID, ActiveChecklistID, ChecklistName, AlertText, AlertType, DueTime, Assigned,CheckListId --added by venkat 04/24/2018
			FROM ##PHIDAILYOVERDUEALERTWORK 
			WHERE Alertee = @Alertee
			AND Assigned = 0
			AND DueTime BETWEEN CONVERT(VARCHAR(10), GETDATE(), 101) AND GetDate()
			AND ActiveChecklistID NOT IN (
				SELECT DISTINCT ActiveChecklistID
				FROM ##PHIDAILYOVERDUEALERTWORK 
				WHERE Alertee = @Alertee
				AND Assigned = 1
			)
			ORDER BY DueTime

		OPEN ASSIGNEDTODAYCURS
		
		FETCH NEXT FROM ASSIGNEDTODAYCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned,@CheckListId --added by venkat 04/24/2018
		WHILE @@FETCH_STATUS = 0 BEGIN
			
		
				
			SELECT @supervisors = dbo.QCheck_ManagersList(ci.ChecklistID),
				@assignees = dbo.QCheck_AssigneesList_WithOverdueLinks(ci.ID, @ExtURL)
			FROM QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
			on ci.ID = ac.InstanceID
			WHERE ac.ID = @activeChecklistID

			SELECT @Reports = dbo.QStatus_ActiveChecklistReportLinks(@ActiveChecklistID, @Alertee, '<br/>')
			IF LEN(@Reports) = 0 SET @Reports = '&nbsp;'


			SET @tmpBody = '<tr><td><span class="hide">Task: </span>'+@ChecklistName+'<span class="hide"><br><br></span></td>'
			IF @AlertType = 'Overdue' or @AlertType = 'Hours' SET @AlertText = 'Overdue' 
			
			SET @tmpBody = @tmpBody + '<td><span class="hide">Alert Type: </span>'+@AlertText+'<span class="hide"><br><br></span></td>'
			-- Complete link
			SET @tmpBody = @tmpBody + '<td><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=0&daily=' + convert(char(1), dbo.QCheck_IsDailyChecklist(@ActiveChecklistID)) + '">Complete</a><span class="hide"><br><br></span></td>'
			-- N/A link
			SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=1">N/A&nbsp;-&nbsp;Close&nbsp;Task</a><span class="hide"><br><br></span></td>'
			-- Extension link
			SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/ExtensionRequest.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'">Extend&nbsp;Deadline&nbsp;2&nbsp;Days</a><span class="hide"><br><br></span></td>'
			
			SET @tmpBody = @tmpBody + 
				'<td><span class="hide">Due Date: </span>'+CAST(@DueTime as varchar(20))+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Reports: </span>'+@reports+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Assigned To: </span>'+@assignees+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Supervisors: </span>'+@supervisors+'<span class="hide"><br><br></span></td></tr>'--added by venkat 04/24/2018'

			insert into @html_output (row_html) select @tmpBody

			FETCH NEXT FROM ASSIGNEDTODAYCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned,@CheckListId --added by venkat 04/24/2018
		END
		CLOSE ASSIGNEDTODAYCURS
		DEALLOCATE ASSIGNEDTODAYCURS
		
		insert into @html_output (row_html) select '</table>'

		-- Spacer
		insert into @html_output (row_html) select '<br/><br/>'
	
	END
	
	IF @CBCount > 0 BEGIN
	
		-- Assigned overdue today header
		INSERT INTO @html_output (row_html) SELECT '<h3>Overdue Before Today</h3>'
		INSERT INTO @html_output (row_html) SELECT '<table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Alert</th><th>Complete</th><th style="font-size:12.0pt;width:150px;white-space:nowrap;">N/A&nbsp;-&nbsp;Close&nbsp;Task</th><th style="width:180px;;white-space:nowrap;">Extension</th><th>Due</th><th>Reports</th><th>Assigned To</th><th>Supervisors<span class="hide"><br></span></th></tr>'

		DECLARE ASSIGNEDOLDERCURS CURSOR
		FOR
		SELECT ID, ActiveChecklistID, ChecklistName, AlertText, AlertType, DueTime, Assigned
		FROM ##PHIDAILYOVERDUEALERTWORK 
		WHERE Alertee = @Alertee
		AND Assigned = 0
		AND DueTime < CONVERT(VARCHAR(10), GETDATE(), 101)
		AND ActiveChecklistID NOT IN (
				SELECT DISTINCT ActiveChecklistID
				FROM ##PHIDAILYOVERDUEALERTWORK 
				WHERE Alertee = @Alertee
				AND Assigned = 1
			)
			ORDER BY DueTime

		OPEN ASSIGNEDOLDERCURS
		
			FETCH NEXT FROM ASSIGNEDOLDERCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned
			WHILE @@FETCH_STATUS = 0 BEGIN
				
				SELECT @supervisors = dbo.QCheck_ManagersList(ci.ChecklistID),
					@assignees = dbo.QCheck_AssigneesList_WithOverdueLinks(ci.ID, @ExtURL)
				FROM QCheck_ActiveChecklists ac
				INNER JOIN QCheck_ChecklistInstances ci
				on ci.ID = ac.InstanceID
				WHERE ac.ID = @activeChecklistID

				SELECT @Reports = dbo.QStatus_ActiveChecklistReportLinks(@ActiveChecklistID, @Alertee, '<br/>')
				IF LEN(@Reports) = 0 SET @Reports = '&nbsp;'


				SET @tmpBody = '<tr><td><span class="hide">Task: </span>'+@ChecklistName+'<span class="hide"><br><br></span></td>'
				IF @AlertType = 'Overdue' or @AlertType = 'Hours' SET @AlertText = 'Overdue' 
				
				SET @tmpBody = @tmpBody + '<td><span class="hide">Alert Type: </span>'+@AlertText+'<span class="hide"><br><br></span></td>'
				-- Complete link
				SET @tmpBody = @tmpBody + '<td><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=0&daily=' + convert(char(1), dbo.QCheck_IsDailyChecklist(@ActiveChecklistID)) + '">Complete</a><span class="hide"><br><br></span></td>'
				-- Complete link
				SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/BrowserDetect.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'&na=1">N/A&nbsp;-&nbsp;Close&nbsp;Task</a><span class="hide"><br><br></span></td>'
				-- Extension link
				SET @tmpBody = @tmpBody + '<td style="font-size:11.0pt;white-space:nowrap;"><a href="'+@ExtURL+'/fromemail/ExtensionRequest.aspx?ac='+CAST(@activeChecklistID as varchar(20))+'&userID='+CAST(@Alertee as varchar(20))+'">Extend&nbsp;Deadline&nbsp;2&nbsp;Days</a><span class="hide"><br><br></span></td>'
			
				SET @tmpBody = @tmpBody + 
					'<td><span class="hide">Due Date: </span>'+CAST(@DueTime as varchar(20))+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Reports: </span>'+@reports+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Assigned To: </span>'+@assignees+'<span class="hide"><br><br></span></td>
					<td><span class="hide">Supervisors: </span>'+@supervisors+'<span class="hide"><br><br></span></td></tr>'--added by venkat 03/13/2018'
		
				insert into @html_output (row_html) select @tmpBody


			FETCH NEXT FROM ASSIGNEDOLDERCURS INTO @ID, @ActiveChecklistID, @ChecklistName, @AlertText, @AlertType, @DueTime, @IsAssigned
		END
		CLOSE ASSIGNEDOLDERCURS
		DEALLOCATE ASSIGNEDOLDERCURS
		
		insert into @html_output (row_html) select '</table>'

		-- Spacer
		insert into @html_output (row_html) select '<br/><br/>'
	
	END
	
	
	
	
	-- Footer
	insert into @html_output (row_html) select '<br/><br/><a href="' + ISNULL(@ExternalURL, '') + '">' + ISNULL(@AppURL, '') + '</a></body></html>'

	SELECT row_html FROM @html_output ORDER BY seq

	SET NOCOUNT OFF
	
END




GO
/****** Object:  StoredProcedure [dbo].[QCheck_Delete]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






-- This stored procedure will delete a checklist (mark isDeleted - true).


CREATE         PROCEDURE [dbo].[QCheck_Delete](
	@ID INT
)
 AS

BEGIN

	SET NOCOUNT ON
	
	--basic update here
	UPDATE
		QCheck_Checklists
	SET
		IsDeleted = 1
	WHERE 
		[ID] = @ID

	SET NOCOUNT OFF

END





























GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteActiveChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO











CREATE              PROCEDURE [dbo].[QCheck_DeleteActiveChecklist]
(
	@ID INT
)
AS
BEGIN
	SET NOCOUNT ON

		INSERT INTO QCheck_ActiveChecklistArchive
		SELECT a.*, getDate() FROM QCheck_ActiveChecklists a
		where a.ID = @ID
	
		DELETE FROM QCheck_ActiveChecklists
		WHERE ID = @ID

	SET NOCOUNT OFF
END
SET QUOTED_IDENTIFIER ON 





GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO






-- This stored procedure will update a schedule for a specified instance


CREATE              PROCEDURE [dbo].[QCheck_DeleteAlert](
	@ID INT

)
 AS

BEGIN

	SET NOCOUNT ON
	
	UPDATE QCheck_Alerts
	SET IsDeleted = 1
	WHERE ID = @ID



	SET NOCOUNT OFF

END













































GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteAssignedTo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- This stored procedure will delete an assignment (mark isDeleted - true).

CREATE                 PROCEDURE [dbo].[QCheck_DeleteAssignedTo](
	@ID INT
)
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @InstanceID int
	
	SELECT @InstanceID = InstanceID
	FROM QCheck_Assignments
	WHERE [ID] = @ID

	--basic update here
	UPDATE
		QCheck_Assignments
	SET
		IsDeleted = 1
	WHERE 
		[ID] = @ID

	exec QCheck_InstanceChangeAlert @InstanceID, 'Assignment', 'Delete'

	SET NOCOUNT OFF

END



































GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteAssignedToByActiveChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
-- This stored procedure will delete an assignment (mark isDeleted - true).
CREATE                 PROCEDURE [dbo].[QCheck_DeleteAssignedToByActiveChecklist]
(
	@ActiveChecklistID INT,
	@GroupID int
)
 AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @InstanceID int

	SELECT @InstanceID = InstanceID
	FROM QCheck_ActiveChecklists
	WHERE ID = @ActiveChecklistID

	--basic update here
	UPDATE
		QCheck_Assignments
	SET
		IsDeleted = 1
	WHERE 
		InstanceID = @InstanceID 
		AND GroupID = @GroupID

	--exec QCheck_InstanceChangeAlert @InstanceID, 'Assignment', 'Delete'
	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                                     PROCEDURE [dbo].[QCheck_DeleteFolder](
	
	@FolderID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @Parent int

	SELECT @Parent = IsNull(ParentFolder, 0)
	FROM QCheck_Folders
	WHERE ID = @FolderID

	UPDATE QCheck_FolderChecklists
	SET FolderID = @Parent
	WHERE 
		FolderID = @FolderID
	
	UPDATE QCheck_Folders
	SET ParentFolder = @Parent
	WHERE ParentFolder = @FolderID
	
	DELETE FROM QCheck_Folders WHERE ID = @FolderID

	SET NOCOUNT OFF

END








GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteGroup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                       PROCEDURE [dbo].[QCheck_DeleteGroup]
	@ID int
 AS

BEGIN

	SET NOCOUNT ON

		INSERT INTO QCheck_GroupArchive
			SELECT * FROM QCheck_Groups
			WHERE ID = @ID
	

		DELETE FROM  QCheck_Groups
			WHERE ID = @ID

	SET NOCOUNT OFF

End






GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteGroupUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE                          PROCEDURE [dbo].[QCheck_DeleteGroupUser]
	@ID int
 AS

BEGIN

	SET NOCOUNT ON

		DECLARE @GroupID int
		DECLARE @UserID int
		
		SELECT @GroupID = GroupID, @UserID = UserID
		FROM QCheck_GroupMembership
		WHERE ID = @ID

		DELETE FROM QCheck_GroupMembership
		WHERE ID = @ID
	
		EXEC QCheck_GroupEmail 'removed', @GroupID, @UserID

	SET NOCOUNT OFF

End





GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





-- This stored procedure will delete an instance  (mark isDeleted - true).

CREATE           PROCEDURE [dbo].[QCheck_DeleteInstance](
	@ID INT
)
 AS

BEGIN

	SET NOCOUNT ON
	
	--basic update here
	UPDATE
		QCheck_ChecklistInstances
	SET
		IsDeleted = 1
	WHERE 
		[ID] = @ID

	SET NOCOUNT OFF

END






GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteInstanceTaskType]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE             PROCEDURE [dbo].[QCheck_DeleteInstanceTaskType](
	@ID int,
	@UserID int
)
 AS

BEGIN
	
	DECLARE @InstanceID int
	DECLARE @TaskType int
	DECLARE @HasAccess bit
	DECLARE @TaskTypeHasUser bit
	
	SET @HasAccess = 0
	
	SELECT @HasAccess = 1 
	FROM QStatus_InstanceTaskType itt
	INNER JOIN QStatus_TaskTypes tt
	on itt.TaskType = tt.ID
	INNER JOIN QStatus_GroupReport gr
	ON gr.ReportID = tt.ReportID
	INNER JOIN QCheck_Groups g
	ON g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @UserID
	AND itt.ID = @ID

	--KC 8/22/22 - allow supervisor to delete a task from a report
	SELECT @HasAccess = 1 
	FROM QStatus_InstanceTaskType itt
	INNER JOIN QStatus_TaskTypes tt
	on itt.TaskType = tt.ID
	INNER JOIN QStatus_Supervisors s
	ON s.ReportID = tt.ReportID
	INNER JOIN QCheck_Groups g
	ON g.ID = s.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.groupID = g.ID
	AND gm.UserID = @UserID
	AND itt.ID = @ID


	SET @TaskTypeHasUser = 0

	SELECT @TaskTypeHasUser = 1 
	FROM QStatus_InstanceTaskType itt
	INNER JOIN QStatus_TaskTypes tt
	on itt.TaskType = tt.ID
	INNER JOIN QStatus_GroupReport gr
	ON gr.ReportID = tt.ReportID
	INNER JOIN QCheck_Groups g
	ON g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.groupID = g.ID
	INNER JOIN QCheck_Users u
	ON u.ID = gm.UserID
	AND itt.ID = @ID
	AND u.IsDeleted = 0

	SELECT @TaskTypeHasUser = 1 
	FROM QStatus_InstanceTaskType itt
	INNER JOIN QStatus_TaskTypes tt
	on itt.TaskType = tt.ID
	INNER JOIN QStatus_Supervisors s
	ON s.ReportID = tt.ReportID
	INNER JOIN QCheck_Groups g
	ON g.ID = s.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.groupID = g.ID
	INNER JOIN QCheck_Users u
	ON u.ID = gm.UserID
	AND itt.ID = @ID
	AND u.IsDeleted = 0

	IF @HasAccess = 1 or @TaskTypeHasUser = 0
	BEGIN
		
		SELECT @InstanceID = InstanceID,
		@TaskType = TaskType
		FROM QStatus_InstanceTaskType
		WHERE ID = @ID
	
		DELETE FROM QStatus_InstanceTaskType
		WHERE ID = @ID
		
		DELETE FROM QStatus_ActiveChecklistTaskType
		WHERE TaskType = @TaskType
		AND
			ActiveChecklistID in
		(SELECT ID FROM QCheck_ActiveChecklists 
		WHERE INSTANCEID = @InstanceID)

		UPDATE QStatus_Report
		SET isDirty = 1
		FROM QStatus_Report r
		INNER JOIN Qstatus_TaskTypes tt
			ON tt.reportid = r.ID
			AND tt.ID = @TaskType

	END

END



























GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteManager]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE              PROCEDURE [dbo].[QCheck_DeleteManager] (
	@ID Int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	UPDATE QCheck_ChecklistManagers
	SET IsDeleted = 1
	WHERE
		ID = @ID

	SET NOCOUNT OFF

END





























GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteReminder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- This stored procedure will update a schedule for a specified instance


CREATE              PROCEDURE [dbo].[QCheck_DeleteReminder](
	@ID INT

)
 AS

BEGIN

	SET NOCOUNT ON
	
	UPDATE QCheck_Alerts
	SET IsDeleted = 1
	WHERE ID = @ID

	SET NOCOUNT OFF

END













































GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteSuggestion]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                 PROCEDURE [dbo].[QCheck_DeleteSuggestion]
	@SuggestionID int
as

BEGIN

	Update QCheck_Suggestions
	SET IsDeleted = 1
	WHERE SuggestionID = @SuggestionID 

END























GO
/****** Object:  StoredProcedure [dbo].[QCheck_DeleteUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



























CREATE            PROCEDURE [dbo].[QCheck_DeleteUsers]
(
	@ID int
)
AS
BEGIN
	SET NOCOUNT ON

		update QCheck_Users
		set isdeleted = 1 
		WHERE ID = @ID

	SET NOCOUNT OFF
END

























GO
/****** Object:  StoredProcedure [dbo].[QCheck_DuplicateNameCheck]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_DuplicateNameCheck] (
	@Name VARCHAR(500),
	@UserID INT,
	@OKToUse BIT OUTPUT
) AS

BEGIN
	
	DECLARE @Count INT

	SELECT 
		@Count = COUNT(*)
	FROM 
		QCheck_Checklists
	WHERE 
		[Name] = @Name
		AND [Owner] = @UserID
		AND IsDeleted = 0
		
	IF @Count = 0 BEGIN

		SET @OkToUse = 1

	END ELSE BEGIN

		SET @OkToUse = 0

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_DuplicateNameCheck_ByEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_DuplicateNameCheck_ByEmail] (
	@Recipients VARCHAR(5000),
	@Sender VARCHAR(5000),
	@TaskName VARCHAR(500),
	@OkToUse BIT OUTPUT
) AS

BEGIN

	SET @OkToUse = 1

	SELECT 
		@OkToUse = 0
	FROM 
		QCheck_Users u
		INNER JOIN QCheck_Checklists c
			ON u.ID = c.[Owner]
			AND c.Name = @TaskName
		INNER JOIN (
			SELECT c As Email FROM dbo.Util_fn_List_To_Table(@Recipients, ';') r
			UNION
			SELECT c As Email FROM dbo.Util_fn_List_To_Table(@Sender, ';') r
		) e
			ON e.Email = u.Email
			
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_EmailSummaryReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_EmailSummaryReport] (
	@StartDate DATETIME,
	@EndDate DATETIME
) AS

DECLARE @i INT,
	@count INT,
	@FullName VARCHAR(500),
	@total INT,
	@sd VARCHAR(20),
	@ed VARCHAR(20)

DECLARE @work TABLE (
	Seq INT IDENTITY(1,1),
	FullName VARCHAR(500),
	Total INT,
	Alerts INT,
	Incomplete INT,
	Overdue INT,
	Reports INT,
	Status INT,
	Assignments INT,
	Other INT
)

SET @sd = CONVERT(VARCHAR(20), @StartDate, 101) + ' 00:00:00'
SET @ed = CONVERT(VARCHAR(20), @EndDate, 101) + ' 23:59:59'

SET @StartDate = @sd
SET @EndDate = @ed

INSERT INTO @work (FullName)
	SELECT DISTINCT FullName 
	FROM QCheck_EmailsReport
	ORDER BY FullName
SET @count = @@IDENTITY

SET @i = 0

WHILE @i < @Count BEGIN

	-- Get the current name
	SELECT @FullName = FullName
	FROM @work
	WHERE seq = @i

	-- Total
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND FullName = @FullName

	UPDATE @work
	SET Total = @total
	WHERE FullName = @FullName


	-- Alerts
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND LTrim(Subject) LIKE 'Alert%'
		AND FullName = @FullName

	UPDATE @work
	SET Alerts = @total
	WHERE FullName = @FullName

	-- Incomplete
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate 
		AND Sent <= @EndDate
		AND LTrim(Subject) LIKE 'Incomplete%'
		AND FullName = @FullName

	UPDATE @work
	SET Incomplete = @total
	WHERE FullName = @FullName

	-- Overdue
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND LTrim(Subject) LIKE 'Overdue%'
		AND FullName = @FullName

	UPDATE @work
	SET Overdue = @total
	WHERE FullName = @FullName

	-- Reports
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND (
			Subject = 'Unread Reports, Overdue Items, and Due Date Changes'
			OR Subject = 'My Weekly Overdue Report'
			OR Subject = 'My Overdue Report'
		)
		AND FullName = @FullName

	UPDATE @work
	SET Reports = @total
	WHERE FullName = @FullName

	-- Status
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate 
		AND Sent <= @EndDate
		AND Subject LIKE 'Status Report%'
		AND FullName = @FullName

	UPDATE @work
	SET Status = @total
	WHERE FullName = @FullName

	-- Assignments
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND Subject = 'New Assignment'
		AND FullName = @FullName

	UPDATE @work
	SET Assignments = @total
	WHERE FullName = @FullName

	-- Other
	UPDATE @work
	SET Other = Total - Alerts - Incomplete - Overdue - Reports - Status - Assignments
	WHERE FullName = @FullName

	SET @i = @i + 1

END

SELECT 
	FullName,
	ISNULL(Total, 0) AS Total,
	ISNULL(Alerts, 0) AS Alerts,
	ISNULL(Incomplete, 0) AS Incomplete,
	ISNULL(Overdue, 0) AS Overdue,
	ISNULL(Reports, 0) AS Reports,
	ISNULL(Status, 0) AS Status,
	ISNULL(Assignments, 0) AS Assignments,
	ISNULL(Other, 0) AS Other
FROM 
	@work 
WHERE	
	FullName IS NOT NULL
ORDER BY 
	FullName

GO
/****** Object:  StoredProcedure [dbo].[QCheck_EmailSummaryReportTop20Alerts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[QCheck_EmailSummaryReportTop20Alerts] (
	@StartDate DATETIME,
	@EndDate DATETIME,
	@Tab int
) 

AS

DECLARE @i INT,
	@count INT,
	@FullName VARCHAR(500),
	@total INT,
	@sd VARCHAR(20),
	@ed VARCHAR(20)

DECLARE @work TABLE (
	Seq INT IDENTITY(1,1),
	FullName VARCHAR(500),
	Total INT,
	Alerts INT,
	Incomplete INT,
	Overdue INT,
	Reports INT,
	Status INT,
	Assignments INT,
	Other INT
)

DECLARE @top20 TABLE (
	FullName VARCHAR(500),
	Total INT,
	Alerts INT,
	Incomplete INT,
	Overdue INT,
	Reports INT,
	Status INT,
	Assignments INT,
	Other INT
)

SET @sd = CONVERT(VARCHAR(20), @StartDate, 101) + ' 00:00:00'
SET @ed = CONVERT(VARCHAR(20), @EndDate, 101) + ' 23:59:59'

SET @StartDate = @sd
SET @EndDate = @ed

INSERT INTO @work (FullName)
	SELECT DISTINCT FullName 
	FROM QCheck_EmailsReport
	ORDER BY FullName
SET @count = @@IDENTITY

SET @i = 0

WHILE @i < @Count BEGIN

	-- Get the current name
	SELECT @FullName = FullName
	FROM @work
	WHERE seq = @i

	-- Total
	/*SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND FullName = @FullName

	UPDATE @work
	SET Total = @total
	WHERE FullName = @FullName
*/

	-- Alerts
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND LTrim(Subject) LIKE 'Alert%'
		AND FullName = @FullName
		AND Subject NOT LIKE '%Process slow%'

	UPDATE @work
	SET Alerts = @total
	WHERE FullName = @FullName

	-- Incomplete
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate 
		AND Sent <= @EndDate
		AND LTrim(Subject) LIKE 'Incomplete%'
		AND FullName = @FullName

	UPDATE @work
	SET Incomplete = @total
	WHERE FullName = @FullName

	-- Overdue
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND LTrim(Subject) LIKE 'Overdue%'
		AND FullName = @FullName

	UPDATE @work
	SET Overdue = @total
	WHERE FullName = @FullName

	-- Reports
/*	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND (
			Subject = 'Unread Reports, Overdue Items, and Due Date Changes'
			OR Subject = 'My Weekly Overdue Report'
			OR Subject = 'My Overdue Report'
		)
		AND FullName = @FullName

	UPDATE @work
	SET Reports = @total
	WHERE FullName = @FullName

	-- Status
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate 
		AND Sent <= @EndDate
		AND Subject LIKE 'Status Report%'
		AND FullName = @FullName

	UPDATE @work
	SET Status = @total
	WHERE FullName = @FullName

	-- Assignments
	SELECT 	@total = Count(Subject) 
	FROM 	QCheck_EmailsReport
	WHERE	Sent > @StartDate
		AND Sent <= @EndDate
		AND Subject = 'New Assignment'
		AND FullName = @FullName

	UPDATE @work
	SET Assignments = @total
	WHERE FullName = @FullName

	-- Other
	UPDATE @work
	SET Other = Total - Alerts - Incomplete - Overdue - Reports - Status - Assignments
	WHERE FullName = @FullName
*/
	SET @i = @i + 1

END

UPDATE @work
SET Total = Alerts + Incomplete + Overdue

insert into @top20
SELECT TOP 20
	FullName,
	ISNULL(Total, 0) AS Total,
	ISNULL(Alerts, 0) AS Alerts,
	ISNULL(Incomplete, 0) AS Incomplete,
	ISNULL(Overdue, 0) AS Overdue,
	ISNULL(Reports, 0) AS Reports,
	ISNULL(Status, 0) AS Status,
	ISNULL(Assignments, 0) AS Assignments,
	ISNULL(Other, 0) AS Other
FROM 
	@work 
WHERE	
	FullName IS NOT NULL
AND
	FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')
ORDER BY 
	Alerts + Incomplete + Overdue DESC

if @Tab = 1
select FullName AS 'User', Total, Alerts, Incomplete, Overdue 
from @top20
else if @Tab = 2
SELECT     er.FullName as 'User', er.Subject, er.Sent
FROM         QCheck_EmailsReport er INNER JOIN
                          (SELECT     TOP 20 er.FullName, COUNT(er.FullName) AS Expr1
                            FROM          QCheck_EmailsReport er INNER JOIN
                                                   QCheck_Users u ON u.FullName = er.FullName
                            WHERE      (er.Sent > @StartDate) AND er.Sent < @EndDate + 1 AND (er.Subject not like 'Alert - %Process slow') AND (er.Subject <> 'New Assignment') AND (u.IsDeleted = 0) AND 
                                                   (u.FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')) AND (er.Subject <> 'My Overdue Report') 
                                                   AND er.subject <> 'Status Report Reminder'
                            GROUP BY er.FullName
                            ORDER BY expr1 DESC) rpt ON er.FullName = rpt.FullName INNER JOIN
                      QCheck_Users u ON rpt.FullName = u.FullName
WHERE     (er.Sent > @StartDate) AND er.Sent < @EndDate + 1 AND (er.Subject not like 'Alert - %Process slow') AND (er.Subject <> 'New Assignment') AND (u.IsDeleted = 0) AND 
                      (u.FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')) AND (er.Subject <> 'My Overdue Report') AND 
                      (er.Subject <> 'Status Report Reminder')
ORDER BY er.FullName, er.Sent
else if @tab = 3

select distinct
users.fullname as 'User', 
g.name as 'Group Name', 
case when freqRecurrance > 1 THEN 'Every ' + CAST(freqRecurrance AS varchar(2)) + ' ' +
	case s.freqtype WHEN 2 THEN 'Days' WHEN 3 THEN 'Weeks' WHEN 4 THEN 'Months' WHEN 5 THEN 'Years' WHEN 6 THEN 'Quarters' END 
ELSE 
case s.freqtype WHEN 2 THEN 'Daily' WHEN 3 THEN 'Weekly' WHEN 4 THEN 'Monthly' WHEN 5 THEN 'Yearly' WHEN 6 THEN 'Quarterly' END
end + 
case when freqInterval > 0 then 
	' - ' + 
	case when freqtype = 3 THEN
		case when freqInterval & 1 = 1 Then 'Sun ' ELSE '' END +
		case when freqInterval & 2 = 2 Then 'Mon ' ELSE '' END +
		case when freqInterval & 4 = 4 Then 'Tue ' ELSE '' END + 
		case when freqInterval & 8 = 8 Then 'Wed ' ELSE '' END + 
		case when freqInterval & 16 = 16 Then 'Thu ' ELSE '' END + 
		case when freqInterval & 32 = 32 Then 'Fri ' ELSE '' END + 
		case when freqInterval & 64 = 64 Then 'Sat ' ELSE '' END
	when freqtype = 5 THEN
		case when freqInterval & 1 = 1 Then 'Jan ' ELSE '' END +
		case when freqInterval & 2 = 2 Then 'Feb ' ELSE '' END +
		case when freqInterval & 4 = 4 Then 'Mar ' ELSE '' END + 
		case when freqInterval & 8 = 8 Then 'Apr ' ELSE '' END + 
		case when freqInterval & 16 = 16 Then 'May ' ELSE '' END + 
		case when freqInterval & 32 = 32 Then 'Jun ' ELSE '' END + 
		case when freqInterval & 64 = 64 Then 'Jul ' ELSE '' END + 
		case when freqInterval & 128 = 128 Then 'Aug ' ELSE '' END + 
		case when freqInterval & 256 = 256 Then 'Sep ' ELSE '' END + 
		case when freqInterval & 512 = 512 Then 'Oct ' ELSE '' END + 
		case when freqInterval & 1024 = 1024 Then 'Nov ' ELSE '' END + 
		case when freqInterval & 2048 = 2048 Then 'Dec ' ELSE '' END
	ELSE
	' '
	END
ELSE
' '
END
as TaskFrequency, 
--case s.freqtype WHEN 2 THEN 'Daily' WHEN 3 THEN 'Weekly' WHEN 4 THEN 'Monthly' WHEN 5 THEN 'Yearly' WHEN 6 THEN 'Quarterly' END AS Frequency2, 
--Convert(varchar(10),s.firstDueDate,101), s.lastDueDate, 
c.name as 'Task Name', 
ar.DaysBefore, ar.AlertTime, ar.AlertType, ar.AlertText, MIN(udt.DueTime) AS 'Next Due Date'
from qcheck_groups g inner join qcheck_alerts ar on g.id = ar.alerteegroupid
INNER JOIN qcheck_checklistinstances ci ON ar.instanceid = ci.id INNER JOIN
qcheck_schedule s on ci.scheduleid = s.id INNER JOIN
qcheck_checklists c on ci.checklistid = c.id INNER JOIN
qcheck_groupmembership gm on gm.groupid = g.id INNER JOIN
qcheck_users users on gm.userid = users.id INNER JOIN
 qcheck_activealerts aa on ar.id = aa.alertid INNER JOIN
@top20 t20 ON users.fullname = t20.fullname INNER JOIN
qcheck_upcomingduetimes udt ON udt.InstanceID = ci.ID
where s.freqtype > 1 and (s.lastduedate is null or s.lastduedate > @enddate) and c.template = 0 and c.isdeleted = 0 and users.isdeleted = 0 and ci.isdeleted = 0
and users.FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')
group by users.fullname, g.name, s.freqRecurrance, s.freqType, s.freqInterval, c.name,ar.DaysBefore, ar.AlertTime, ar.AlertType, ar.AlertText

UNION

select distinct users.fullname as 'User', g.name as 'Group Name', null as 'Task Frequency', c.name as 'Task Name', a.DaysBefore, a.AlertTime, a.AlertType, a.AlertText, MIN(udt.DueTime) AS 'Next Due Date'
 from qcheck_alerts a INNER JOIN
			QCheck_ChecklistInstances ci ON ci.ID = a.InstanceID INNER JOIN 
			QCheck_Assignments ass ON ass.InstanceID = ci.ID INNER JOIN
                      QCheck_ActiveAssignments aas ON ass.ID = aas.AssignmentsID INNER JOIN
                      QCheck_Checklists c ON ci.ChecklistID = c.ID inner join
		qcheck_groups g on ass.groupid = g.id inner join qcheck_groupmembership gm on g.id = gm.groupid
inner join qcheck_users users on gm.userid = users.id INNER JOIN
qcheck_UpcomingDueTimes udt ON udt.InstanceID = ci.ID
inner join 
	@top20 t20 ON users.fullname = t20.fullname
WHERE     (a.AlertType = 'Reminder') AND (a.IsDeleted = 0) and users.isdeleted = 0
--AND (a.senttime is null OR (a.SentTime > GETDATE() - 30) AND (a.SentTime < GETDATE())) and
and (ci.IsDeleted = 0) AND (c.IsDeleted = 0)
and users.FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')
group by users.fullname, g.name, c.name,a.DaysBefore, a.AlertTime, a.AlertType, a.AlertText

else if @tab = 4
select top20.fullname, count(fullname) as 'Count'
from
(
select distinct
users.fullname, 
g.name as 'Group Name', 
case when freqRecurrance > 1 THEN 'Every ' + CAST(freqRecurrance AS varchar(2)) + ' ' +
	case s.freqtype WHEN 2 THEN 'Days' WHEN 3 THEN 'Weeks' WHEN 4 THEN 'Months' WHEN 5 THEN 'Years' WHEN 6 THEN 'Quarters' END 
ELSE 
case s.freqtype WHEN 2 THEN 'Daily' WHEN 3 THEN 'Weekly' WHEN 4 THEN 'Monthly' WHEN 5 THEN 'Yearly' WHEN 6 THEN 'Quarterly' END
end + 
case when freqInterval > 0 then 
	' - ' + 
	case when freqtype = 3 THEN
		case when freqInterval & 1 = 1 Then 'Sun ' ELSE '' END +
		case when freqInterval & 2 = 2 Then 'Mon ' ELSE '' END +
		case when freqInterval & 4 = 4 Then 'Tue ' ELSE '' END + 
		case when freqInterval & 8 = 8 Then 'Wed ' ELSE '' END + 
		case when freqInterval & 16 = 16 Then 'Thu ' ELSE '' END + 
		case when freqInterval & 32 = 32 Then 'Fri ' ELSE '' END + 
		case when freqInterval & 64 = 64 Then 'Sat ' ELSE '' END
	when freqtype = 5 THEN
		case when freqInterval & 1 = 1 Then 'Jan ' ELSE '' END +
		case when freqInterval & 2 = 2 Then 'Feb ' ELSE '' END +
		case when freqInterval & 4 = 4 Then 'Mar ' ELSE '' END + 
		case when freqInterval & 8 = 8 Then 'Apr ' ELSE '' END + 
		case when freqInterval & 16 = 16 Then 'May ' ELSE '' END + 
		case when freqInterval & 32 = 32 Then 'Jun ' ELSE '' END + 
		case when freqInterval & 64 = 64 Then 'Jul ' ELSE '' END + 
		case when freqInterval & 128 = 128 Then 'Aug ' ELSE '' END + 
		case when freqInterval & 256 = 256 Then 'Sep ' ELSE '' END + 
		case when freqInterval & 512 = 512 Then 'Oct ' ELSE '' END + 
		case when freqInterval & 1024 = 1024 Then 'Nov ' ELSE '' END + 
		case when freqInterval & 2048 = 2048 Then 'Dec ' ELSE '' END
	ELSE
	' '
	END
ELSE
' '
END
as TaskFrequency, 
--case s.freqtype WHEN 2 THEN 'Daily' WHEN 3 THEN 'Weekly' WHEN 4 THEN 'Monthly' WHEN 5 THEN 'Yearly' WHEN 6 THEN 'Quarterly' END AS Frequency2, 
--Convert(varchar(10),s.firstDueDate,101), s.lastDueDate, 
c.name as 'Task Name', 
ar.DaysBefore, ar.AlertTime, ar.AlertType, ar.AlertText, MIN(udt.DueTime) AS 'Next Due Date'
from qcheck_groups g inner join qcheck_alerts ar on g.id = ar.alerteegroupid
INNER JOIN qcheck_checklistinstances ci ON ar.instanceid = ci.id INNER JOIN
qcheck_schedule s on ci.scheduleid = s.id INNER JOIN
qcheck_checklists c on ci.checklistid = c.id INNER JOIN
qcheck_groupmembership gm on gm.groupid = g.id INNER JOIN
qcheck_users users on gm.userid = users.id INNER JOIN
 qcheck_activealerts aa on ar.id = aa.alertid INNER JOIN
@top20 t20 ON users.fullname = t20.fullname INNER JOIN
qcheck_upcomingduetimes udt ON udt.InstanceID = ci.ID
where s.freqtype > 1 and (s.lastduedate is null or s.lastduedate > @enddate) and c.template = 0 and c.isdeleted = 0 and users.isdeleted = 0 and ci.isdeleted = 0
and users.FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')
group by users.fullname, g.name, s.freqRecurrance, s.freqType, s.freqInterval, c.name,ar.DaysBefore, ar.AlertTime, ar.AlertType, ar.AlertText

UNION

select distinct users.fullname as 'User', g.name as 'Group Name', null as 'Task Frequency', c.name as 'Task Name', a.DaysBefore, a.AlertTime, a.AlertType, a.AlertText, MIN(udt.DueTime) AS 'Next Due Date'
 from qcheck_alerts a INNER JOIN
			QCheck_ChecklistInstances ci ON ci.ID = a.InstanceID INNER JOIN 
			QCheck_Assignments ass ON ass.InstanceID = ci.ID INNER JOIN
                      QCheck_ActiveAssignments aas ON ass.ID = aas.AssignmentsID INNER JOIN
                      QCheck_Checklists c ON ci.ChecklistID = c.ID inner join
		qcheck_groups g on ass.groupid = g.id inner join qcheck_groupmembership gm on g.id = gm.groupid
inner join qcheck_users users on gm.userid = users.id INNER JOIN
qcheck_UpcomingDueTimes udt ON udt.InstanceID = ci.ID
inner join 
	@top20 t20 ON users.fullname = t20.fullname
WHERE     (a.AlertType = 'Reminder') AND (a.IsDeleted = 0) and users.isdeleted = 0
--AND (a.senttime is null OR (a.SentTime > GETDATE() - 30) AND (a.SentTime < GETDATE())) and
and (ci.IsDeleted = 0) AND (c.IsDeleted = 0)
and users.FullName NOT IN ('Dani Armstrong', 'David Ponder', 'Sylinda Harper', 'John Paul Estremo', 'Lindsay Stitt')
group by users.fullname, g.name, c.name,a.DaysBefore, a.AlertTime, a.AlertType, a.AlertText
) top20
group by fullname
order by count(user) desc
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ExtendedTasksWarningEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_ExtendedTasksWarningEmail]
AS
begin
					
	set nocount on

	declare @emails table
	(
		id int,
		email varchar(1000)
	)

	insert into @emails 
	select top 20 id, email from 
	(
		select distinct ac.id, dbo.[QCheck_AssigneesEmailList](ci.id) as email, datediff(day, ac.OrigDueTime, ac.duetime) as daysextended
			from qcheck_activechecklists ac	
			inner join qcheck_checklistinstances ci	
				on ci.id = ac.instanceid
				and ci.IsDeleted = 0
			inner join qcheck_checklists c	
				on c.id = ci.checklistid
				and c.IsDeleted = 0
			inner join QCheck_ActiveChecklists_DueDateChangeCount ddc
				on ddc.activechecklistid = ac.id
			inner join QCheck_Assignments a
				on a.InstanceID = ci.id
				and a.IsDeleted = 0
			inner join qcheck_groups g
				on g.id = a.GroupID
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
			inner join qcheck_users u
				on u.id = gm.UserID
				and u.IsDeleted = 0
			inner join QCheck_ExtendedTasksWarningEmail_Queue q
				on q.activechecklistID = ac.id
				and q.emailSent is null
		where ac.completeddate is null		
		and OrigDueTime <= dateadd(day, -90, ac.duetime)		
		and ci.id not in (select id from QCheck_SelfManaged)		
	) a
	order by daysextended desc

	declare @id int, @email varchar(1000), @message varchar(max), @days int, @assignees varchar(100), @controllers varchar(100), @origduetime varchar(100), @duetime varchar(100), @extensions int, @task varchar(1000)

	while exists (select 1 from @emails)
	begin
		select top 1 @id = id, @email = email from @emails
	
		select top 1 @task = c.name, 
				@assignees = dbo.qcheck_assigneeslist(ac.instanceid),
				@controllers = [dbo].[QCheck_ManagersList_FullNames](c.id),  
				@origduetime = convert(varchar, ac.OrigDueTime, 101), 
				@duetime = convert(varchar, ac.DueTime, 101),  
				@days = datediff(day, ac.OrigDueTime, ac.duetime), 
				@extensions = ddc.duedatechanges	
			from qcheck_activechecklists ac		
			inner join qcheck_checklistinstances ci	
				on ci.id = ac.instanceid
				and ci.IsDeleted = 0
			inner join qcheck_checklists c	
				on c.id = ci.checklistid
				and c.IsDeleted = 0
			inner join QCheck_ActiveChecklists_DueDateChangeCount ddc
				on ddc.activechecklistid = ac.id
			inner join QCheck_Assignments a
				on a.InstanceID = ci.id
				and a.IsDeleted = 0
			inner join qcheck_groups g
				on g.id = a.GroupID
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
			inner join qcheck_users u
				on u.id = gm.UserID
				and u.IsDeleted = 0
		where ac.completeddate is null		
		and OrigDueTime <= dateadd(day, -90, ac.duetime)		
		and ci.id not in (select id from QCheck_SelfManaged)
		and ac.id = @id
	
		select @message = '<style>table {
			  border-collapse: collapse;
			}

			table, th, td {
			  border: 1px solid black;
			  padding:5px;
				font-size:14.0pt;
			}
			div {
				font-size:14.0pt;
			}
		</style>
		<div>
		  The following task has been extended by ' + cast(@days as varchar(10)) + ' days which is getting out of hand.  Please send me an explanation on why this task is still outstanding and what you intend to do about it.  If a task is outstanding more than 90 days, there has to be an incredibly good reason or perhaps you need to change the task design.  Please be prepared to change the process.  We are trying to clean up QP and eliminate tasks which have been open too long.</div>'
		select @message = @message + '<br><br><table><tr><th>Task</th><th>Assignees</th><th>Controllers</th><th>Original Due Date</th><th>Current Due Date</th><th>Days Extended</th><th>Number of Times Extended</th></tr>'
		select @message = @message + '<tr><td>'+@task+'</td><td>'+@assignees+'</td><td>'+@controllers+'</td><td>'+@origduetime+'</td><td>'+@duetime+'</td><td>'+cast(@days as varchar(10))+'</td><td>'+cast(@extensions as varchar(10))+'</td></tr></table>'

		--select @message = @message + '<br/><br/>to ' + @email
		--select @email = 'kcroft@acmewidget.com'

		-- Get app configuration
		DECLARE @mailsubject VARCHAR(1000)
		SELECT @mailsubject = 'Extended Tasks In ' + appname 
		FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @FromAddress VARCHAR(50) = (SELECT TOP 1 ExtendedTasksWarningFromAddress FROM QCheck_AppSettings)
	DECLARE @FromName VARCHAR(50) = (SELECT TOP 1 ExtendedTasksWarningFromName FROM QCheck_AppSettings)
	DECLARE @CCAddress VARCHAR(1000) = (SELECT TOP 1 ExtendedTasksWarningCCAddress FROM QCheck_AppSettings)

		EXEC dbo.xp_smtp_sendmail
--		 @FROM       = 'graynor1@acmewidget.com',
		 @FROM = @FromAddress,
--		 @From_Name  = 'Geoffrey Raynor',
		 @From_Name = @FromName,
		 @TO         = @email,
--		 @cc		 = 'graynor1@acmewidget.com;nholm@acmewidget.com;kcroft@acmewidget.com',
		 @cc = @CCAddress,
		 @subject    = @mailsubject,
		 @message    = @message

		
		update QCheck_ExtendedTasksWarningEmail_Queue set emailSent = getdate() where activechecklistid = @id

		delete from @emails where id = @id
	end

	set nocount off
end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ExtendedTasksWarningEmail_PopulateQueue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_ExtendedTasksWarningEmail_PopulateQueue]
as
begin
	truncate table QCheck_ExtendedTasksWarningEmail_Queue

	insert into QCheck_ExtendedTasksWarningEmail_Queue (ActivechecklistID)
	select  distinct ac.id	from qcheck_activechecklists ac		
			inner join qcheck_checklistinstances ci	
				on ci.id = ac.instanceid
				and ci.IsDeleted = 0
			inner join qcheck_checklists c	
				on c.id = ci.checklistid
				and c.IsDeleted = 0
			inner join QCheck_ActiveChecklists_DueDateChangeCount ddc
				on ddc.activechecklistid = ac.id
			inner join QCheck_Assignments a
				on a.InstanceID = ci.id
				and a.IsDeleted = 0
			inner join qcheck_groups g
				on g.id = a.GroupID
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
			inner join qcheck_users u
				on u.id = gm.UserID
				and u.IsDeleted = 0
		where ac.completeddate is null		
		and OrigDueTime <= dateadd(day, -90, ac.duetime)		
		and ci.id not in (select id from QCheck_SelfManaged)		

end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ForceChecklistManager]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ForceChecklistManager] (
	@ChecklistID INT,
	@ManagerGroupID INT
) AS

BEGIN

	-- Remove all other managers
	UPDATE QCheck_ChecklistManagers
	SET IsDeleted = 1
	WHERE ChecklistID = @ChecklistID
	AND ManagerGroupID <> @ManagerGroupID
	
	-- Undelete the given manager if exists
	UPDATE QCheck_ChecklistManagers
	SET IsDeleted = 0
	WHERE ChecklistID = @ChecklistID
	AND ManagerGroupID = @ManagerGroupID
	
	-- Insert if the manager doesn't exist
	IF NOT EXISTS(SELECT [ID] FROM QCheck_ChecklistManagers	WHERE ChecklistID = @ChecklistID AND ManagerGroupID = @ManagerGroupID AND IsDeleted = 0) BEGIN
	
		INSERT INTO QCheck_ChecklistManagers (
			ManagerGroupID,
			ChecklistID,
			IsDeleted
		) VALUES (
			@ManagerGroupID,
			@ChecklistID,
			0
		)
	
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ForceChecklistManagerByActiveChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ForceChecklistManagerByActiveChecklist] (
	@ActiveChecklistID INT,
	@ManagerGroupID INT
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ChecklistID INT,
		@ManagerUserID INT,
		@FullName VARCHAR(500),
		@TaskName VARCHAR(1000),
		@MailSubject VARCHAR(5000),
		@MailFrom VARCHAR(5000),
		@MailBody VARCHAR(5000),
		@MailTo VARCHAR(5000)

	-- Get the checklist ID for the given active checklist	
	SELECT 
		@ChecklistID = ci.ChecklistID
	FROM
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_ChecklistInstances ci
			ON ac.InstanceID = ci.[ID]
	WHERE
		ac.[ID] = @ActiveChecklistID

	-- Set up the e-mail fields
	SELECT @FullName = [Name] FROM QCheck_Groups WHERE [ID] = @ManagerGroupID
	SELECT @TaskName = [Name] FROM QCheck_Checklists WHERE [ID] = @ChecklistID
	SET @MailSubject = ISNULL(@FullName, '') + ' has taken control of task "' + ISNULL(@TaskName, '') + '"'
	SET @MailFrom = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	SET @MailBody = 'You are no longer a controller of this task.'
	
	-- Get the controller e-mails, excluding the person taking control of the task.  This is done BEFORE setting the
	-- new controller so we know who needs to be notified.
	SELECT @ManagerUserID = UserID
	FROM QCheck_GroupMembership
	WHERE GroupID = @ManagerGroupID

	SELECT @MailTo = dbo.QCheck_ChecklistControllerEmails(@ChecklistID, @ManagerUserID)

	-- Set the new controller of the task
	EXEC QCheck_ForceChecklistManager @ChecklistID, @ManagerGroupID

	-- Send the e-mail(s)
	EXEC dbo.xp_smtp_sendmail 
		@from = @MailFrom, 
		@to = @MailTo, 
		@subject = @MailSubject,
		@message = @MailBody, 
		@type = 'text/html', 
		@server = @MailServer

	-- Recache all reports that have this task
	UPDATE 
		QStatus_Report
	SET 
		IsDirty = 1
	FROM 
		QStatus_ActiveChecklistTaskType actt
		INNER JOIN QStatus_TaskTypes tt
			ON actt.TaskType = tt.[ID]
			AND tt.IsDeleted = 0
		INNER JOIN QStatus_Report r
			ON tt.ReportID = r.[ID]
			AND r.IsDeleted = 0
	WHERE
		actt.ActiveChecklistID = @ActiveChecklistID

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetActiveChecklistsIManage]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_GetActiveChecklistsIManage]
	@UserID int
AS

select distinct 
	ac.id 
from 
	qcheck_groupmembership gm
	inner join QCheck_ChecklistManagers cm
		on cm.managergroupid = gm.groupid
	inner join qcheck_checklists c
		on c.id = cm.checklistid
	inner join qcheck_checklistinstances ci
		on ci.checklistid = c.id
	inner join qcheck_activechecklists ac
		on ac.instanceid = ci.id
where 
	gm.userid = @UserID
	and c.isdeleted = 0
	and cm.isdeleted = 0



GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetActiveDueDates]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE          PROCEDURE [dbo].[QCheck_GetActiveDueDates](
	@InstanceID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT distinct ac.ID, ac.DueTime
	FROM QCheck_ActiveChecklists ac
	WHERE InstanceID = @InstanceID
	--AND completeddate is null
	ORDER BY 2

	SET NOCOUNT OFF

END






































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetActiveEmployees]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[QCheck_GetActiveEmployees]
	
AS
BEGIN
	select ID,FullName from QCheck_Users where IsDeleted=0
	order by FullName 
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAlertee]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE PROCEDURE [dbo].[QCheck_GetAlertee](
	@ID INT

)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT 
		alert.ID, 
		c.Name,
		null as NextDue,
		null as LastCompleted,
		--isNull(ac1.duetime, udt1.duetime) as NextDue,
		--isNull(ac3.completeddate, aca1.completeddate) as LastCompleted,
		dbo.QCheck_AssigneesList(ci.id) as Assignees,
		dbo.QCheck_ManagersList(c.id) as Controllers,
		dbo.QCheck_AlerteesList(ci.id) as Alertees,
		--CASE WHEN ac1.ID is null and ac3.ID is null then '' ELSE 'YES' END As 
		'' as Active

	FROM QCheck_Alerts alert
	INNER JOIN QCheck_Groups g with (nolock)
	ON g.ID = alert.AlerteeGroupID
	INNER JOIN QCheck_GroupMembership gm with (nolock)
	ON gm.GroupID = g.ID
	AND gm.UserID = @ID
	INNER JOIN QCheck_ChecklistInstances ci with (nolock)
	on alert.instanceID= ci.ID
	INNER JOIN QCheck_Checklists c with (nolock)
	ON c.ID = ci.ChecklistID
	AND c.IsDeleted = 0
	WHERE alert.IsDeleted = 0
	ORDER BY c.Name
	


	SET NOCOUNT OFF

END
















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAlertExceptions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[QCheck_GetAlertExceptions](
	@ID INT = null,
	@ActiveAlertID INT = null,
	@UserID INT = null	
)
AS
BEGIN
	SELECT ID, ActiveAlertID, UserID, IsActive
	FROM QCheck_AlertExceptions
	WHERE (ID = @ID OR @ID IS NULL)
	OR (ActiveAlertID = @ActiveAlertID OR @ActiveAlertID IS NULL)
	OR (UserID = @UserID OR @UserID IS NULL)	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAlerts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO














CREATE             PROCEDURE [dbo].[QCheck_GetAlerts](
	@InstanceID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT DISTINCT a.[ID], a.DaysBefore, a.AlertTime, g.Name as Alertee,  a.AlertType, a.AlertText, a.AlerteeGroupID as AlerteeID 
	FROM QCheck_ALERTS a
	INNER JOIN QCheck_Groups g
	ON g.ID = a.AlerteeGroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupId = g.ID
	INNER JOIN
	      QCheck_Users u
	ON
		u.ID = gm.UserID
	WHERE a.INSTANCEID= @InstanceID
	AND a.IsDeleted = 0

	Order By AlertType, Alertee


	SET NOCOUNT OFF

END













































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAlertsAndReminders]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_GetAlertsAndReminders] (
	@InstanceID INT,
	@ChangeID INT = -1
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @out TABLE (
		[ID] INT,
		DaysBefore INT,
		AlertTime FLOAT,
		Alertee VARCHAR(50),
		AlertType VARCHAR(10),
		AlertText VARCHAR(250),
		AlerteeID INT,
		Existing BIT
	)

	-- Current alerts
	INSERT INTO @out
		SELECT DISTINCT 
			a.[ID], 
			a.DaysBefore, 
			a.AlertTime, 
			g.[Name] as Alertee, 
			a.AlertType, 
			a.AlertText, 
			a.AlerteeGroupID as AlerteeID,
			1 AS Existing
		FROM 
			QCheck_Alerts a
			INNER JOIN QCheck_Groups g
				ON g.ID = a.AlerteeGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupId = g.ID
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
		WHERE 
			a.InstanceID= @InstanceID
			AND a.IsDeleted = 0
	
		UNION
		
		SELECT 	a.[ID], 
		    	a.DaysBefore, 
			a.AlertTime, 
			'Assignees' as Alertee, 
			a.AlertType, 
			a.AlertText, 
			null as AlerteeID,
			1 As Existing
		FROM 
			QCheck_Alerts a
		WHERE 
			a.InstanceID= @InstanceID
			AND  a.AlertType='Reminder'
			AND a.IsDeleted = 0

	-- Alerts added in this change
	INSERT INTO @out	
		SELECT DISTINCT 
			a.[ID], 
			a.DaysBefore, 
			a.AlertTime, 
			g.[Name] as Alertee, 
			a.AlertType, 
			a.AlertText, 
			a.AlerteeGroupID as AlerteeID,
			0 AS Existing
		FROM 
			QCheck_Approval_Alerts a
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON a.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = a.AlerteeGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupId = g.ID
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
		WHERE 
			a.INSTANCEID= @InstanceID
			AND a.IsDeleted = 0
			AND a.ChangeRequestID = @ChangeID
			
		UNION
		
		SELECT 	a.[ID], 
			a.DaysBefore, 
			a.AlertTime, 
			'Assignees' as Alertee, 
			a.AlertType, 
			a.AlertText, 
			null as AlerteeID,
			0 As Existing
		FROM 
			QCheck_Approval_Alerts a
		WHERE 
			a.InstanceID= @InstanceID
			AND a.ChangeRequestID = @ChangeID
			AND  a.AlertType='Reminder'
			AND a.IsDeleted = 0

	-- Alerts removed in this change
	DELETE FROM @out
	WHERE 
	[ID] IN (
		SELECT AlertID
		FROM 
			QCheck_Approval_Alerts a
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON a.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
		WHERE
			a.ChangeRequestID = @ChangeID
			AND a.IsDeleted = 1
	)
	AND Existing = 1

	-- Get the final output
	SELECT 
		[ID],
		DaysBefore,
		AlertTime,
		Alertee,
		AlertType,
		AlertText,
		AlerteeID,
		Existing
	FROM 
		@out
	ORDER BY 
		AlertType, 
		Alertee

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAppSettings]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                 PROCEDURE [dbo].[QCheck_GetAppSettings](
	@UserID int,
	@AppURL	varchar(50) output
)
 AS

BEGIN

	SET NOCOUNT ON

	SELECT @AppURL = AppURL
	FROM
		QCheck_AppSettings a
	INNER JOIN
		QCheck_Users u
	ON
		u.App = a.ID
	AND
		u.ID = @UserID
		

	SET NOCOUNT OFF

END

























GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAssigned]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                  PROCEDURE [dbo].[QCheck_GetAssigned](
	@ID INT
) AS

BEGIN

	SET NOCOUNT ON
	
	/*SELECT assign.ID, c.Name
	FROM QCheck_Assignments assign
	INNER JOIN QCheck_ChecklistInstances ci
	ON ci.ID = assign.InstanceID
	AND ci.IsDeleted = 0
	INNER JOIN QCheck_Checklists c
	ON c.ID = ci.ChecklistID
	AND c.IsDeleted = 0
	INNER JOIN QCheck_Groups g
	ON g.ID = assign.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @ID
	WHERE assign.IsDeleted = 0
	ORDER BY c.Name*/


	SELECT DISTINCT
		assign.ID, 
		c.Name,
		null as nextdue,--isNull(ac1.duetime, udt1.duetime) as NextDue,
		null as lastcompleted,--isNull(ac3.completeddate, aca1.completeddate) as LastCompleted,
		dbo.QCheck_AssigneesList(ci.id) as Assignees,
		dbo.QCheck_ManagersList(c.id) as Controllers,
		dbo.QStatus_InstanceReports(ci.id, -1) as Alertees,
		--dbo.QCheck_AlerteesList(ci.id) as Alertees,
		--'' As Active
		CASE WHEN ac.ID IS NOT NULL THEN 'YES' ELSE '' END AS Active
		--CASE WHEN ac1.ID is null and ac3.ID is null then '' ELSE 'YES' END As Active
	FROM 
		QCheck_Assignments assign
		INNER JOIN QCheck_Groups g
			ON g.ID = assign.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gm.UserID = @ID
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ID = assign.InstanceID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON c.ID = ci.ChecklistID
			AND c.IsDeleted = 0
		LEFT OUTER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = ci.ID
	--get next due by searching activechecklists and upcoming
	/*left outer join qcheck_activechecklists ac1
	on ac1.instanceid = ci.id
	and ac1.completeddate is null
	left outer join qcheck_activechecklists ac2
	on ac1.instanceid = ac2.instanceid
	and ac2.completeddate is null
	and ac2.duetime < ac1.duetime
	left outer join qcheck_upcomingduetimes udt1
	on udt1.instanceid = ci.id
	and ac1.id is null
	left outer join qcheck_upcomingduetimes udt2
	on udt2.instanceid = ci.id
	and udt2.duetime < udt1.duetime

	--get last completed from activechecklists / archive
	left outer join qcheck_activechecklists ac3
	on ac3.instanceid = ci.id
	and ac3.completeddate is not null
	left outer join qcheck_activechecklists ac4
	on ac4.instanceid = ci.id
	and ac4.completeddate is not null
	and ac4.completeddate > ac3.completeddate

	left outer join qcheck_activechecklistarchive aca1
	on aca1.instanceid = ci.id
	and aca1.completeddate is not null
	left outer join qcheck_activechecklistarchive aca2
	on aca2.instanceid = ci.id
	and aca2.completeddate is not null
	and aca2.completeddate > aca1.completeddate*/

	WHERE assign.IsDeleted = 0
	--AND udt2.id is null
	---AND ac2.id is null
	--AND ac4.id is null
	--AND aca2.id is null

	order by 7, 2

	SET NOCOUNT OFF

END

















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAssignedBulk]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetAssignedBulk] (
	@ID INT
) AS

BEGIN

	SET NOCOUNT ON
	
	SELECT DISTINCT
		assign.ID,
		c.Name,
		null as nextdue,--isNull(ac1.duetime, udt1.duetime) as NextDue,
		null as lastcompleted,--isNull(ac3.completeddate, aca1.completeddate) as LastCompleted,
		dbo.QCheck_AssigneesList(ci.id) as Assignees,
		dbo.QCheck_ManagersList(c.id) as Controllers,
		dbo.QStatus_InstanceReports(ci.id, -1) as Alertees,
		'' As Active,
		CASE
			WHEN ba.[ID] IS NULL THEN 0
			ELSE 1
		END AS Highlight
	FROM 
		QCheck_Assignments assign
		INNER JOIN QCheck_Groups g
			ON g.ID = assign.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gm.UserID = @ID
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ID = assign.InstanceID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON c.ID = ci.ChecklistID
			AND c.IsDeleted = 0
		INNER JOIN QCheck_ActiveChecklists ac
			ON ci.[ID] = ac.InstanceID
		LEFT OUTER JOIN QCheck_BulkAssigned ba
			ON assign.InstanceID = ba.InstanceID
			AND ba.IsDeleted = 0
		
	WHERE 
		assign.IsDeleted = 0
	ORDER BY
		7, 2

	SET NOCOUNT OFF

END


















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetAssigneesIManage]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO















CREATE              PROCEDURE [dbo].[QCheck_GetAssigneesIManage](
	@UserID int
)
 AS

BEGIN

	
	SET NOCOUNT ON
	
		

	SELECT distinct 
		g.ID,
		'Assigned To '+g.Name AS MemberName
	FROM
		QCheck_ChecklistManagers m
	INNER JOIN
		QCheck_ChecklistInstances i
	on
		i.ChecklistID = m.ChecklistID
	and
		i.IsDeleted = 0
	INNER JOIN
		QCheck_Assignments a
	on 
		a.InstanceID = i.ID
	AND
		a.IsDeleted = 0	
	INNER JOIN
		QCheck_Checklists c 
	ON
		i.ChecklistID = c.ID
	AND
		c.IsDeleted = 0
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = a.GroupID
	INNER JOIN 
		QCheck_Groups g2
	ON
		g2.ID = m.ManagerGroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g2.ID
	AND
		gm.UserID = @UserID
	WHERE
		m.IsDeleted = 0
	AND NOT (g.owner = @UserID and g.SingleMemberGroup = 1)

	
	ORDER BY 2

	SET NOCOUNT OFF

END





































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetCalendarChecklists_KVS2]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_GetCalendarChecklists_KVS2]
	@UserID int,
	@startDate datetime,
	@endDate datetime,
	@ID varchar(8000),
	@ShowStatusCalendar bit = 0,
	@ShowAlertEmails bit = 1
AS

BEGIN

	SET NOCOUNT ON

	DECLARE @IDs table(
		ID int
	)

	INSERT INTO @IDs SELECT CAST(Data as int) FROM dbo.Util_Split(@ID,',')
	
	DECLARE @tblAssigned table(
		ID int
	)

	DECLARE @tblAssignee table(
		ID int
	)

	DECLARE @tblManaged table(
		ID int
	)
	
	DECLARE @tblStatusControlled table(
		ID int
	)	

	DECLARE @tblStatusSupervised table(
		ID int
	)

	DECLARE @tblScheduledAlerts table(
		ID int,
		AlertID int
	)

	DECLARE @tblPendingChanges table(
		ActiveChecklistID INT,
		ChangeID INT,
		NewDeadline DATETIME
	)
	
	DECLARE @tblResults table(
		objID int, 
		ChecklistID int, 
		ChecklistName varchar(500),  
		DueTime datetime, 
		ReminderDate datetime,
		type int,
		active int,
		assignedto int,
		ismanager int,
		isRecurring bit,
		PendingChange bit,
		ChangeID int,
		NewDeadline datetime,
		IsNA bit,
		isAlert bit,
		AlertID int,
		isEmailScheduled bit,
		MultiStep bit,
		IsPriority bit,
		OriginalDeadline datetime
	)
	
	IF @UserID <> 5000 BEGIN

		INSERT INTO @tblPendingChanges (
			ActiveChecklistID,
			ChangeID,
			NewDeadline
		)
			SELECT 
				AAC.ActiveChecklistID,
				CR.[ID],
				AAC.DueTime
			FROM 
				QCheck_Approval_ChangeRequests CR
				INNER JOIN QCheck_Approval_ActiveChecklists AAC
					ON AAC.ChangeRequestID = CR.[ID]
				-- 3/25/2013 dalvarado - Created this view and joined it here to eliminate duplicate entries
				-- on the calendar view when you have multiple outstanding change requests for a task.
				INNER JOIN QCheck_MostRecentDeadlineRequests MRDR
					ON AAC.ActiveChecklistID = MRDR.ActiveChecklistID
					AND CR.ID = MRDR.ChangeRequestID
			WHERE 
				CR.IsActive = 1
				AND CR.Approved = 0
				AND CR.Rejected = 0
				AND CR.ReadyForSupervisor = 1
	
		INSERT INTO @tblAssigned
		SELECT a.InstanceID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				on g.ID = a.GroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID
		WHERE a.IsDeleted = 0

		INSERT INTO @tblAssignee
		SELECT a.InstanceID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				on g.ID = a.GroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID IN (SELECT ID FROM @IDs)
			--Failsafe against query string hacking; @UserID and @ID must have a supervisor/report relationship
			INNER JOIN (
				SELECT u.ID
				FROM QCheck_Users U
					INNER JOIN QStatus_Report R
						ON U.FullName = R.[Name]	
						AND r.IsDeleted = 0
					INNER JOIN QStatus_Supervisors S
						ON R.[ID] = S.ReportID			
						AND s.AsOf < GETDATE()
						AND (s.DirectSupervisor = 1 OR s.InterestedParty = 1)
					INNER JOIN QCheck_Groups G
						ON S.SupervisorGroupID = G.[ID]			
					INNER JOIN QCheck_Users SU
						ON G.Owner = SU.[ID]
						AND su.IsDeleted = 0
						AND SU.[ID] = @UserID
					WHERE
						U.IsDeleted = 0
						AND U.ID IN (SELECT ID FROM @IDs)
			) X ON x.ID = gm.UserID
		WHERE a.IsDeleted = 0		
	
		INSERT INTO @tblManaged
		SELECT ci.ID
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN QCheck_Checklists c
				on c.ID = ci.ChecklistID
				and c.IsDeleted = 0
				and ci.IsDeleted = 0
			INNER JOIN QCheck_ChecklistManagers cm
				on cm.ChecklistID = c.ID
				and cm.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				on g.ID = cm.ManagerGroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID

		INSERT INTO @tblStatusControlled
		SELECT r.ID 
		FROM 
			QStatus_Report r
			INNER JOIN  QStatus_GroupReport gr
				ON gr.ReportID = r.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = gr.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID			
		WHERE
			r.IsDeleted = 0
			AND (
				r.ID IN (SELECT ID FROM @IDs)
				or -1 IN (SELECT ID FROM @IDs)		
			)
	
		INSERT INTO @tblStatusSupervised
		SELECT r.ID 
		FROM 
			QStatus_Report r
			INNER JOIN QStatus_Supervisors sup
				ON sup.ReportID = r.ID
				AND sup.DirectSupervisor = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sup.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
		WHERE
			r.IsDeleted = 0
			AND EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, r.ID))			

		--KVS 2017-10-30 - Adding alerts as a viewable calendar item
		INSERT INTO @tblScheduledAlerts
		SELECT a.InstanceID,
			al.ID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Alerts al
				ON al.InstanceID = a.InstanceID
				AND al.IsDeleted = 0				
			INNER JOIN QCheck_Groups g
				ON (al.AlerteeGroupID IS NULL AND g.ID = a.GroupID)
				OR al.AlerteeGroupID = g.ID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID
		WHERE a.IsDeleted = 0 
		
		-- ****************************************
		-- All or assigned to me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 
		BEGIN

			-- Current tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime,
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN a.ID IS NULL OR @ShowAlertEmails = 0 THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID	
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 

			-- Future tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				NULL AS ReminderDate,
				3 AS type, --meaning future
				1 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 As IsNA,
				0 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN a.ID IS NULL OR @ShowAlertEmails = 0 THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime BETWEEN @startDate and @endDate
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 
	
			-- Past tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime,
				ac.ReminderDate,
				2 AS type, --meaning past
				0 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				a.ID as AlertID,
				CASE WHEN a.ID IS NULL OR @ShowAlertEmails = 0 THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID 
					AND CAST(GETDATE() as date) > @startDate
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) 
		END

		-- ****************************************
		-- Managed by me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
			OR (EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) and @ShowStatusCalendar = 0)
		BEGIN

			-- IF @ID = -2, *only* show tasks controlled by the user (ignore supervisor or group membership)
			-- IF ID > 0, show any task where the assignee's status report is visible to the user
			
			-- Current tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QCheck_ActiveAssignments aa
					on aa.ActiveChecklistID = ac.ID
				INNER JOIN QCheck_Assignments a
					on a.ID = aa.AssignmentsID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssignee ta2
					on ta2.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm  
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID	
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))
	
			-- Future tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				NULL AS ReminderDate,
				3 AS type, --meaning current
				1 as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime BETWEEN @startDate and @endDate
				INNER JOIN QCheck_Assignments a
					on a.InstanceID = ci.ID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssignee ta2
					on ta2.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm 
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))	

			-- Past tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				2 AS type, --meaning past
				0 as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID 
					AND CAST(GETDATE() as date) > @startDate			
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QCheck_Assignments a
					on a.InstanceID = ci.ID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssigned ta2
					on ta2.ID = ci.ID
				left outer JOIN @tblManaged tm 
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))	

		END
	
		-- ****************************************
		-- Status
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID = -1) OR @ShowStatusCalendar = 1
		BEGIN
			
			-- Current tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QStatus_ActiveChecklistTaskType actt
					on actt.ActiveChecklistID = ac.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = actt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE 
				NOT (
					tc.ID is null 
					and tss.ID is null
				)
	
			-- Future tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				NULL AS ReminderDate,
				3 AS type, --meaning future
				1 as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.DueTime BETWEEN @startDate and @endDate
					)
				INNER JOIN QStatus_InstanceTaskType itt
					on itt.InstanceID = ci.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = itt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE 
				NOT (
					tss.ID is null 
					and tc.ID is null
				)
	
			-- Past tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				2 AS type, --meaning past
				0 as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as isAlert,
				NULL as AlertID,
				0 as isEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID
					AND CAST(GETDATE() as date) > @startDate		
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN QStatus_InstanceTaskType itt
					on itt.InstanceID = ci.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = itt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		 
			WHERE 
				NOT (
					tss.ID is null 
					and tc.ID is null
				)

		END

		-- ****************************************
		-- Overdue tasks
		
		-- All or assigned to me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) BEGIN

			-- Overdue tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime,
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN a.ID IS NULL THEN 0 ELSE 1 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime < @startDate
					AND ac.DueTime < GETDATE() -- Only overdue stuff, not active tasks in future weeks
					AND ac.CompletedDate IS NULL
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				LEFT OUTER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				LEFT OUTER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType = 'Overdue'
				LEFT OUTER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))
				
		END
		
		-- Managed by me
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
			OR (EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) and @ShowStatusCalendar = 0)		
		BEGIN
			-- Overdue tasks managed by me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end as assignedto,
				CASE WHEN tm.ID is null then 0 else 1 end as isManager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				NULL as AlertID,
				0 as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime < @startDate
					AND ac.DueTime < GETDATE() -- Only overdue stuff, not active tasks in future weeks
					AND ac.CompletedDate IS NULL
				INNER JOIN QCheck_ActiveAssignments aa
					on aa.ActiveChecklistID = ac.ID
				INNER JOIN QCheck_Assignments a
					on a.ID = aa.AssignmentsID
					and a.isdeleted = 0
				INNER JOIN QCheck_Groups g
					on g.ID = a.GroupID
				INNER JOIN QCheck_Groupmembership gm
					on gm.GroupID = g.ID
					and (
						EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, -2)) 
						OR (
							EXISTS (SELECT 'Y' FROM @IDs WHERE ID > 0) 
							and @ShowStatusCalendar = 0
							and gm.UserID IN (select ID FROM @IDs)
						)
					)
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblAssignee ta2
					on ta2.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID		
			WHERE
				(tm.ID is not null OR (-2 NOT IN (SELECT ID FROM @IDs) AND ta2.ID IS NOT NULL))		
		END
		
		-- Status
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID = -1) OR @ShowStatusCalendar = 1
		BEGIN
			
			-- Overdue tasks on status report
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name as ChecklistName, 
				ac.DueTime, 
				ac.ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				CASE WHEN ta.ID is null then 0 else 1 end,
				CASE WHEN tm.ID is null then 0 else 1 end,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				0 as IsAlert,
				NULL as AlertID,
				0 as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime < @startDate
					AND ac.DueTime < GETDATE() -- Only overdue stuff, not active tasks in future weeks
					AND ac.CompletedDate IS NULL
				INNER JOIN QStatus_ActiveChecklistTaskType actt
					on actt.ActiveChecklistID = ac.ID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ID = actt.TaskType
				LEFT OUTER JOIN @tblStatusControlled tc
					ON tc.ID = tt.ReportID
				LEFT OUTER JOIN @tblStatusSupervised tss
					ON tss.ID = tt.ReportID
				LEFT OUTER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID	
			WHERE 
				NOT (
					tc.ID is null 
					and tss.ID is null
				)
				
		END

		-- ****************************************
		-- Email reminders - Assigned ONLY
		IF EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0)) and @ShowAlertEmails = 1 BEGIN
			-- Current tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name + (CASE WHEN a.AlertText IS NOT NULL AND a.AlertText <> '' THEN ' - ' + a.AlertText
							WHEN a.AlertType IN ('Reminder') THEN ' - Reminder'
							WHEN a.AlertType IN ('Hours') THEN ' - Overdue Reminder'  
							ELSE ' - Alert' END) as ChecklistName, 
				CASE
					WHEN a.AlertType = 'Hours' OR a.AlertTime < 0 
						THEN DATEADD(minute, IsNull(a.AlertTime * 60, 0), ac.DueTime)
					ELSE DATEADD(minute, IsNull(a.AlertTime * 60, 0),
							DATEADD(day, IsNull(a.DaysBefore, 0) * -1, 
								DateAdd(day, DATEDIFF(day, 0, ac.DueTime),0)))
				END as DueTime,
				NULL as ReminderDate,
				1 AS type, --meaning current
				case when ac.completeddate is null then 1 else 0 end as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END AS PendingChange,
				ISNULL(pc.ChangeID, -1) AS ChangeID,
				ISNULL(pc.NewDeadline, ac.DueTime) AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				1 as IsAlert,
				aa.ID as AlertID,
				CASE WHEN ae.ID IS NULL THEN 1 ELSE 0 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklists ac 
					on ac.InstanceID = ci.ID 
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID 
				LEFT OUTER JOIN @tblPendingChanges pc
					ON ac.[ID] = pc.ActiveChecklistID
				INNER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				INNER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType IN ('Reminder', 'Custom', 'Hours')
				INNER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID
				LEFT OUTER JOIN QCheck_AlertExceptions ae
					ON ae.ActiveAlertID = aa.ID
					AND ae.UserID = @UserID
					AND ae.IsActive = 1		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID							
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))

			-- Future tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name + IsNull(' - ' + a.AlertText, (CASE 
							WHEN a.AlertType IN ('Reminder') THEN ' - Reminder'
							WHEN a.AlertType IN ('Hours') THEN ' - Overdue Reminder'  
							ELSE ' - Alert' END)) as ChecklistName, 
				CASE 
					WHEN a.AlertType = 'Hours' OR a.AlertTime < 0 
						THEN DATEADD(hour, IsNull(a.AlertTime, 0), ac.DueTime)
					ELSE DATEADD(hour, IsNull(a.AlertTime, 0),
							DATEADD(day, IsNull(a.DaysBefore, 0) * -1, 
								DateAdd(day, DATEDIFF(day, 0, ac.DueTime),0)))
				END as DueTime,
				NULL AS ReminderDate,
				3 AS type, --meaning future
				1 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				0 As IsNA,
				1 as IsAlert,
				a.ID as AlertID,
				CASE WHEN ae.ID IS NULL THEN 1 ELSE 0 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				null as OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_UpcomingDueTimes ac 
					on ac.InstanceID = ci.ID 
					AND ac.DueTime BETWEEN @startDate and @endDate
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				INNER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				INNER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType IN ('Reminder', 'Custom', 'Hours')
				INNER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID
				LEFT OUTER JOIN QCheck_AlertExceptions ae
					ON ae.ActiveAlertID = aa.ID
					AND ae.UserID = @UserID
					AND ae.IsActive = 1		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID					
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))
	
			-- Past tasks assigned to me
			INSERT INTO @tblResults
			SELECT 
				ac.ID as objID, 
				c.ID as ChecklistID, 
				c.Name + IsNull(' - ' + a.AlertText, (CASE 
							WHEN a.AlertType IN ('Reminder') THEN ' - Reminder'
							WHEN a.AlertType IN ('Hours') THEN ' - Overdue Reminder'  
							ELSE ' - Alert' END)) as ChecklistName, 
				CASE 
					WHEN a.AlertType = 'Hours' OR a.AlertTime < 0 
						THEN DATEADD(hour, IsNull(a.AlertTime, 0), ac.DueTime)
					ELSE DATEADD(hour, IsNull(a.AlertTime, 0),
							DATEADD(day, IsNull(a.DaysBefore, 0) * -1, 
								DateAdd(day, DATEDIFF(day, 0, ac.DueTime),0)))
				END as DueTime,
				NULL as ReminderDate,
				2 AS type, --meaning past
				0 as active,
				1,
				CASE WHEN tm.ID is null then 0 else 1 end as ismanager,
				CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring,
				0 AS PendingChange,
				-1 AS ChangeID,
				ac.DueTime AS NewDeadline,
				ISNULL(ac.IsNA, 0) AS IsNA,
				1 as IsAlert,
				a.ID as AlertID,
				CASE WHEN ae.ID IS NULL THEN 1 ELSE 0 END as IsEmailScheduled,
				case when ms.checklistid is null then 0 else 1 end as MultiStep,
				case when p.activechecklistid is null then 0 else 1 end as IsPriority,
				ac.OrigDueTime
			FROM 
				QCheck_ChecklistInstances ci
				INNER JOIN QCheck_Checklists c 
					on ci.checklistID = c.ID 
					AND c.IsDeleted = 0
					and ci.IsDeleted = 0
				INNER JOIN QCheck_ActiveChecklistArchive ac 
					on ac.InstanceID = ci.ID 
					AND CAST(GETDATE() as date) > @startDate
					AND (
						ac.DueTime BETWEEN @startDate and @endDate
						OR ac.ReminderDate BETWEEN @startDate and @endDate
					)
				INNER JOIN @tblAssigned ta
					on ta.ID = ci.ID
				LEFT OUTER JOIN @tblManaged tm
					on tm.ID = ci.ID
				LEFT OUTER JOIN QCheck_Schedule s 
					ON ci.ScheduleID = s.ID
				INNER JOIN @tblScheduledAlerts al
					ON al.ID = ci.ID
				INNER JOIN QCheck_Alerts a
					ON al.AlertID = a.ID
					AND a.AlertType IN ('Reminder', 'Custom', 'Hours')
				INNER JOIN QCheck_ActiveAlerts aa
					ON aa.ActiveChecklistID = ac.ID
					AND aa.AlertID = a.ID
				LEFT OUTER JOIN QCheck_AlertExceptions ae
					ON ae.ActiveAlertID = aa.ID
					AND ae.UserID = @UserID
					AND ae.IsActive = 1		
				LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
				LEFT OUTER JOIN PriorityList p on p.activechecklistid = ac.ID and p.UserID = @UserID				
			WHERE
				EXISTS (SELECT 'Y' FROM @IDs WHERE ID IN(-1, 0))
		END
	END
	
	-- Get the output
	SELECT DISTINCT * 
	FROM 
		@tblResults
	ORDER BY 
		DueTime,
		objID, 
		ChecklistName
	
	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetChecklistsAssignedToMeByFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will retrieve all data for the checklists the user 
-- is assigned to
CREATE PROCEDURE [dbo].[QCheck_GetChecklistsAssignedToMeByFolder](
	@UserID int,
	@memberGroupID int = 0,
	@isAdmin bit = 0,
	@search varchar(200) = ''
) AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @tblResults TABLE(
		ID int
	)

	DECLARE @tblAssigned TABLE(
		ID int
	)
	DECLARE @tblActive TABLE(
		ID int
	)

	-- Get all the ChecklistIDs the user is assigned to
	INSERT INTO @tblAssigned
		SELECT DISTINCT 
			c.ID
		FROM	
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON c.[ID] = ci.ChecklistID
				AND c.IsDeleted = 0
				AND ci.IsDeleted = 0
			INNER JOIN QCheck_Assignments a
				ON ci.[ID] = a.InstanceID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				ON a.GroupID = g.[ID]
			INNER JOIN QCheck_GroupMembership gm
				ON g.[ID] = gm.GroupID
				AND (
					gm.UserID = @UserID 
					OR @isAdmin = 1
				)

	-- Get all active checklists
	INSERT INTO @tblActive
		SELECT DISTINCT 
			c.id
		FROM 
			qcheck_checklists c
		INNER JOIN qcheck_checklistinstances ci
			ON ci.checklistid = c.id
		INNER JOIN qcheck_activechecklists ac
			ON ac.instanceid = ci.id


	-- If no group filter was supplied, the result set is everything assigned to the user through any group
	IF @memberGroupID = 0 BEGIN

		INSERT INTO @tblResults
			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c
				INNER JOIN @tblAssigned tm
					ON tm.ID = c.ID

	-- If a group filter was supplied, the result set is everything assigned to the user through that group
	END ELSE BEGIN

		INSERT INTO @tblResults
			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c
				INNER JOIN @tblAssigned tm
					ON tm.ID = c.ID
				LEFT OUTER JOIN QCheck_ChecklistInstances ci
					ON ci.ChecklistID = c.ID
					AND ci.IsDeleted = 0
				LEFT OUTER JOIN QCheck_Assignments a
					ON a.InstanceID = ci.ID
					AND a.IsDeleted = 0
					AND a.GroupID = @memberGroupID
			WHERE
				(
					a.ID IS NOT NULL 
					OR @memberGroupID = 0
				)

	END
		
	-- If no search string was supplied, return the full result set with folders
	IF LEN(LTRIM(RTRIM(@search))) = 0 BEGIN

		SELECT DISTINCT 
			c.Name as NodeName, 
			c.ID,
			c.ID as FolderID,
			isNull(fc.FolderID, 0) as ParentID,
			1 as Type,
			case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
			c.Template
		FROM 
			@tblResults tr
			INNER JOIN qcheck_checklists c
				ON tr.ID = c.ID
			LEFT OUTER JOIN @tblActive ac
				ON ac.ID = c.ID
			LEFT OUTER JOIN QCheck_FolderChecklists fc
				ON fc.ChecklistID = c.ID
				AND fc.FolderID IN (
					SELECT ID 
					FROM QCheck_Folders 
					WHERE UserID = @UserID
				)
		
		UNION ALL
		
		SELECT 
			'All Tasks' as NodeName, 
			0 As ID,
			0 as FolderID,
			null as ParentID,
			2 as Type,
			0 as Active,
			0 as Template
	
		UNION ALL
			
		SELECT 
			FolderName as NodeName,
			ID,
			ID as FolderID,
			ParentFolder as ParentID,
			3 as Type,
			0 as Active,
			0 as Template
		FROM
			QCheck_Folders
		WHERE
			UserID = @UserID		
		ORDER BY 
			Type desc, 
			NodeName

	-- If a search string was supplied, filter the result set by that search string
	END ELSE BEGIN

		SELECT DISTINCT 
			c.Name as NodeName, 
			c.ID,
			c.ID as FolderID,
			isNull(fc.FolderID, 0) as ParentID,
			1 as Type,
			case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
			c.Template
		FROM 
			@tblResults tr
			INNER JOIN qcheck_checklists c
				ON tr.ID = c.ID
			LEFT OUTER JOIN	QCheck_Items i
				ON i.ChecklistID = c.ID
			LEFT OUTER JOIN @tblActive ac
				ON ac.ID = c.ID
			LEFT OUTER JOIN QCheck_FolderChecklists fc
				ON fc.ChecklistID = c.ID
				AND fc.FolderID IN (
					SELECT ID 
					FROM QCheck_Folders 
					WHERE UserID = @UserID
				)
		WHERE
			c.Name LIKE ('%'+@search+'%') 
			OR i.Text like ('%'+@search+'%')
		
		UNION ALL
		
		SELECT 
			'All Tasks' as NodeName, 
			0 As ID,
			0 as FolderID,
			null as ParentID,
			2 as Type,
			0 as Active,
			0 as Template
	
		UNION ALL
			
		SELECT 
			FolderName as NodeName,
			ID,
			ID as FolderID,
			ParentFolder as ParentID,
			3 as Type,
			0 as Active,
			0 as Template
		FROM
			QCheck_Folders
		WHERE
			UserID = @UserID		
		ORDER BY 
			Type DESC, 
			NodeName

	END

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetChecklistsIManageByFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








-- This stored procedure will retrieve all data for the checklists the user 
-- has access to
CREATE      PROCEDURE [dbo].[QCheck_GetChecklistsIManageByFolder](
	@UserID int,
	@memberGroupID int = 0,
	@managerGroupID int = 0,
	@isAdmin bit = 0,
	@search varchar(200) = ''
)
 AS

BEGIN

	SET NOCOUNT ON
	
		DECLARE @tblResults TABLE(
			ID int
		)

		DECLARE @tblManaged TABLE(
			ID int
		)
		DECLARE @tblActive TABLE(
			ID int
		)

		INSERT INTO @tblManaged
		SELECT distinct c.ID
		FROM	QCheck_Checklists c
		INNER JOIN QCheck_ChecklistManagers cm
		ON
			cm.ChecklistID = c.ID
		AND
			cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
		ON
			g.ID = cm.ManagerGroupID
		INNER JOIN QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			(gm.UserID = @UserID or @isAdmin = 1)
		AND
			c.IsDeleted = 0

		INSERT INTO @tblActive
		select distinct c.id
		from qcheck_checklists c
		inner join qcheck_checklistinstances ci
		on ci.checklistid = c.id
		inner join qcheck_activechecklists ac
		on ac.instanceid = ci.id
	
		if @memberGroupID = 0 and @managergroupID = 0 
		begin
			INSERT INTO @tblResults
			SELECT DISTINCT c.ID
			FROM 
				qcheck_checklists c
			INNER JOIN @tblManaged tm
			ON 
				tm.ID = c.ID
		end
		else
		begin
			INSERT INTO @tblResults
			SELECT DISTINCT c.ID
			FROM 
				qcheck_checklists c
			INNER JOIN @tblManaged tm
			ON 
				tm.ID = c.ID
			LEFT OUTER JOIN QCheck_ChecklistInstances ci
			ON
				ci.ChecklistID = c.ID
			AND
				ci.IsDeleted = 0
			LEFT OUTER JOIN QCheck_Assignments a
			ON 
				a.InstanceID = ci.ID
			AND
				a.IsDeleted = 0
			AND
				a.GroupID = @memberGroupID
			LEFT OUTER JOIN QCheck_ChecklistManagers cm
			ON
				cm.ChecklistID = c.ID
			AND
				cm.IsDeleted = 0
			LEFT OUTER JOIN QCheck_Groups managerg
			ON
				managerg.ID = cm.ManagerGroupID
			LEFT OUTER JOIN QCheck_GroupMembership managergm
			ON
				managergm.GroupID = managerg.ID
			AND
				managergm.GroupID = @managergroupID
			WHERE
				(a.ID is not null OR @memberGroupID = 0)
			AND
				(managergm.ID is not null OR @managergroupID = 0)
		end
			
		
		
		
		if len(ltrim(rtrim(@search)))=0
		BEGIN
	
			SELECT DISTINCT 
				c.Name as NodeName, 
				c.ID,
				c.ID as FolderID,
				isNull(fc.FolderID, 0) as ParentID,
				1 as Type,
				case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
				c.Template
			FROM @tblResults tr
			INNER JOIN 
				qcheck_checklists c
			ON 
				tr.ID = c.ID
			LEFT OUTER JOIN 
				@tblActive ac
			ON 
				ac.ID = c.ID
			LEFT OUTER JOIN
				QCheck_FolderChecklists fc
			ON
				fc.ChecklistID = c.ID
			and 
				fc.FolderID in
			(SELECT ID FROM QCheck_Folders WHERE 
				UserID = @UserID)
			
			UNION ALL
			
			SELECT 
				'All Tasks' as NodeName, 
				0 As ID,
				0 as FolderID,
				null as ParentID,
				2 as Type,
				0 as Active,
				0 as Template
		
			UNION ALL
				
			SELECT 
				FolderName as NodeName,
				ID,
				ID as FolderID,
				ParentFolder as ParentID,
				3 as Type,
				0 as Active,
				0 as Template
			FROM
				QCheck_Folders
			WHERE
				UserID = @UserID		
			Order by Type desc, NodeName
		END
		ELSE
		BEGIN
			SELECT DISTINCT 
				c.Name as NodeName, 
				c.ID,
				c.ID as FolderID,
				isNull(fc.FolderID, 0) as ParentID,
				1 as Type,
				case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
				c.Template
			FROM @tblResults tr
			INNER JOIN 
				qcheck_checklists c
			ON 
				tr.ID = c.ID
			LEFT OUTER JOIN
				QCheck_Items i
			ON 
				i.ChecklistID = c.ID
			LEFT OUTER JOIN 
				@tblActive ac
			ON 
				ac.ID = c.ID
			LEFT OUTER JOIN
				QCheck_FolderChecklists fc
			ON
				fc.ChecklistID = c.ID
			and 
				fc.FolderID in
			(SELECT ID FROM QCheck_Folders WHERE 
				UserID = @UserID)
			WHERE
				(c.Name like ('%'+@search+'%') OR i.Text like ('%'+@search+'%'))
			
			UNION ALL
			
			SELECT 
				'All Tasks' as NodeName, 
				0 As ID,
				0 as FolderID,
				null as ParentID,
				2 as Type,
				0 as Active,
				0 as Template
		
			UNION ALL
				
			SELECT 
				FolderName as NodeName,
				ID,
				ID as FolderID,
				ParentFolder as ParentID,
				3 as Type,
				0 as Active,
				0 as Template
			FROM
				QCheck_Folders
			WHERE
				UserID = @UserID		
			Order by Type desc, NodeName
		END
	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetChecklistStatus]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetChecklistStatus] (
	@UserID int,
	@sort VARCHAR (50),
	@reportType VARCHAR(10)
) AS
BEGIN

	SET NOCOUNT ON
		
	SELECT 		 
		a.ID as Identifier,
		c1.Name as [Task], 
		a.dueTime as [Due Date], 
		isnull(al.assignees, '') as [Assigned To],
		isnull(trl.reportslist, '') AS [Status Report],
		dbo.QCheck_ActiveAssigneeUserIDList(a.ID) AS [AssigneeUserList],
		case when cr.ActiveChecklistID is null then 0 else 1 end as HasChangeRequest,
		case when @sort = 'Person' then isnull(al.assignees, '')
			when @sort = 'Task' then c1.Name
			else convert(varchar, a.dueTime, 102)
		end as sortcol
	FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID
		inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 
			and c1.isdeleted = 0
		inner JOIN QCheck_GroupMembership gm1
			ON	gm1.UserID = @UserID
		inner JOIN QCheck_Groups g
			ON g.ID = gm1.GroupID
		inner JOIN QCheck_ChecklistManagers m
			ON m.IsDeleted = 0
			AND m.ManagerGroupID = g.ID
			AND m.ChecklistID = c1.ID
		left outer join qcheck_assigneelookup al
			on al.instanceid = a.instanceid
		left outer join qstatus_taskreportlist trl
			on trl.activechecklistid = a.id
			and trl.userid = @UserID
		LEFT OUTER JOIN (
			SELECT DISTINCT
				aac.ActiveChecklistID
			FROM 
				QCheck_Approval_ActiveChecklists aac
				INNER JOIN QCheck_Approval_ChangeRequests cr
					ON aac.ChangeRequestID = cr.ID
			WHERE
				cr.ReadyForSupervisor = 1
				AND cr.IsActive = 1
				AND cr.Approved = 0
				AND cr.Rejected = 0
		) cr
			ON a.ID = cr.ActiveChecklistID
	WHERE
		a.CompletedDate is null 
		AND a.DueTime < getDate()

union

	SELECT 		 
		a.ID as Identifier,
		c1.Name as [Task], 
		a.dueTime as [Due Date], 
		isnull(al.assignees, '') as [Assigned To],
		isnull(trl.reportslist, '') AS [Status Report],
		dbo.QCheck_ActiveAssigneeUserIDList(a.ID) AS [AssigneeUserList],
		case when cr.ActiveChecklistID is null then 0 else 1 end as HasChangeRequest,
		case when @sort = 'Person' then isnull(al.assignees, '')
			when @sort = 'Task' then c1.Name
			else convert(varchar, a.dueTime, 102)
		end as sortcol
	FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID
		inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 
			and c1.isdeleted = 0
		inner JOIN QCheck_GroupMembership gm1
			ON gm1.UserID = @UserID
		inner JOIN QCheck_Groups g
			ON g.ID = gm1.GroupID
		inner JOIN QCheck_Assignments f
			on f.InstanceID = b1.ID
			AND f.groupID = g.ID
		left outer join qcheck_assigneelookup al
			on al.instanceid = a.instanceid
		left outer join qstatus_taskreportlist trl
			on trl.activechecklistid = a.id
			and trl.userid = @UserID
		LEFT OUTER JOIN (
			SELECT DISTINCT
				aac.ActiveChecklistID
			FROM 
				QCheck_Approval_ActiveChecklists aac
				INNER JOIN QCheck_Approval_ChangeRequests cr
					ON aac.ChangeRequestID = cr.ID
			WHERE
				cr.ReadyForSupervisor = 1
				AND cr.IsActive = 1
				AND cr.Approved = 0
				AND cr.Rejected = 0
		) cr
			ON a.ID = cr.ActiveChecklistID
	WHERE
		a.CompletedDate is null 
		AND a.DueTime < getDate()
	ORDER BY sortcol

	SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetChecklistTaskTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE               PROCEDURE [dbo].[QCheck_GetChecklistTaskTypes]
@ChecklistID int

AS

BEGIN
	
	SELECT itt.ID, r.Name as Report, tt.Description as TaskType, r.ID as ReportID
	FROM QStatus_InstanceTaskType itt
	INNER JOIN QCheck_ChecklistInstances ci ON ci.ID = itt.InstanceID
	INNER JOIN QCheck_Checklists c ON ci.ChecklistID = c.ID
	inner join QStatus_TaskTypes tt
	on tt.ID = itt.TaskType
	inner join QStatus_Report r
	ON r.ID = tt.ReportID
	--WHERE itt.InstanceID = @InstanceID
	WHERE c.ID = @ChecklistID
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetCompletedChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will retrieve all completed checklists that user has supervisor rights to.
-- Used on history page.
-- member, checklistID, starting and ending are filters for the report
-- the default values retrieve all data

CREATE PROCEDURE [dbo].[QCheck_GetCompletedChecklists](
	@loginID int,
	@member int = -1,
	@checklistID int = -1,
	@starting datetime = 0,
	@ending datetime = '12/31/2999', 
	@activeChecklistID int = 0,
	@sort varchar(10) = 'Due'
) AS

BEGIN

	SET NOCOUNT ON
	
	SELECT DISTINCT
		a.ID as Identifier,
		2 as type,
		c1.Name as [Task], 
		uu.FullName AS [Completed By], 
		--a.ID As Identifier, 
		a.dueTime as [Due Date], 
		a.CompletedDate As [Completed On],
		a.IsNA,
		a.NAReason,
		CASE WHEN @sort = 'Due' THEN convert(varchar, a.duetime, 120)
		     WHEN @sort = 'Task' THEN c1.Name
		     ELSE uu.FullName
		END as Sort
	FROM	
		QCheck_ChecklistInstances b1
		INNER JOIN QCheck_ActiveChecklistArchive a 
			ON a.InstanceID = b1.ID
		INNER JOIN QCheck_Checklists c1
			ON b1.checklistID = c1.ID
		LEFT OUTER JOIN qcheck_groupmembership gm1
			ON gm1.userID = @loginID
		LEFT OUTER JOIN qcheck_groups g1 
			ON g1.ID = gm1.GroupID
		LEFT OUTER JOIN QCheck_ChecklistManagers m	
			ON m.IsDeleted = 0
			AND m.ManagerGroupID = g1.ID
			AND m.ChecklistID = c1.ID
		LEFT OUTER JOIN QCheck_Assignments f2
			ON f2.InstanceID = b1.ID
		LEFT OUTER JOIN qcheck_groups g
			ON g.ID = f2.groupID
		LEFT OUTER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
			AND gm.UserID = @loginID
		INNER JOIN QCheck_Users uu 
			ON uu.ID = a.CompletedBy
		INNER JOIN QCheck_GroupMembership ugm
			ON ugm.userid = uu.id
			AND (@member = -1 OR @member = ugm.groupID)
	WHERE
		a.CompletedDate > @starting 
		AND a.CompletedDate < @ending
		AND (@ChecklistID = -1 or c1.ID = @ChecklistID)
		AND NOT (m.ID IS NULL AND GM.ID IS NULL)

UNION ALL

	SELECT DISTINCT
		a.ID as Identifier,
		1 as type,
		c1.Name as [Task], 
		uu.FullName AS [Completed By], 
		--a.ID As Identifier, 
		a.dueTime as [Due Date], 
		a.CompletedDate As [Completed On],
		a.IsNA,
		a.NAReason,
		CASE WHEN @sort = 'Due' THEN convert(varchar, a.duetime, 120)
		     WHEN @sort = 'Task' THEN c1.Name
		     ELSE uu.FullName
		END as Sort
	FROM	
		QCheck_ChecklistInstances b1
		INNER JOIN QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID
		INNER JOIN QCheck_Checklists c1
			ON b1.checklistID = c1.ID 
		LEFT OUTER JOIN qcheck_groupmembership gm1
			ON gm1.userID = @loginID
		LEFT OUTER JOIN qcheck_groups g1 
			ON g1.ID = gm1.GroupID
		LEFT OUTER JOIN QCheck_ChecklistManagers m	
			ON m.IsDeleted = 0
			AND m.ManagerGroupID = g1.ID
			AND m.ChecklistID = c1.ID
		LEFT OUTER JOIN QCheck_Assignments f2
			ON f2.InstanceID = b1.ID
		LEFT OUTER JOIN qcheck_groups g
			ON g.ID = f2.groupID
		LEFT OUTER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
			AND gm.UserID = @loginID
		INNER JOIN QCheck_Users uu 
			ON uu.ID = a.CompletedBy
		INNER JOIN QCheck_GroupMembership ugm
			ON ugm.userid = uu.id
			AND (@member = -1 or @member = ugm.groupID)
	WHERE
		a.CompletedDate > @starting 
		AND a.CompletedDate < @ending
		AND (@ChecklistID = -1 or c1.ID = @ChecklistID)
		AND NOT (m.ID is null and GM.ID is null)
	ORDER BY 
		sort, 
		[Due Date],
		[Completed On],
		Task, 
		[Completed By]

	SET NOCOUNT OFF

END




















GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetControlled]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO










CREATE                  PROCEDURE [dbo].[QCheck_GetControlled](
	@ID INT

)
 AS

BEGIN

	SET NOCOUNT ON
	
	/*SELECT control.ID, c.Name
	FROM QCheck_ChecklistManagers control
	INNER JOIN QCheck_Checklists c
	ON c.ID = control.ChecklistID
	AND c.IsDeleted = 0
	INNER JOIN QCheck_Groups g
	ON g.ID = control.ManagerGroupID
	INNER JOIN Qcheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @ID
	WHERE control.IsDeleted = 0
	ORDER BY c.Name*/


	SELECT 
		control.ID, 
		c.Name,
		--isNull(ac1.duetime, udt1.duetime) 
		null as NextDue,
		--isNull(ac3.completeddate, aca1.completeddate) 
		null as LastCompleted,
		dbo.QCheck_AssigneesList(ci.id) as Assignees,
		dbo.QCheck_ManagersList(c.id) as Controllers,
		dbo.QStatus_InstanceReports(ci.id, -1) as Alertees,
		--dbo.QCheck_AlerteesList(ci.id) as Alertees,
		'' As Active--CASE WHEN ac1.ID is null and ac3.ID is null then '' ELSE 'YES' END As Active
	FROM QCheck_ChecklistManagers control
	INNER JOIN QCheck_Groups g
	ON g.ID = control.ManagerGroupID
	INNER JOIN Qcheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @ID
	INNER JOIN QCheck_Checklists c
	ON c.ID = control.ChecklistID
	AND c.IsDeleted = 0
	INNER JOIN QCheck_ChecklistInstances ci
	ON ci.ChecklistID = c.ID
	AND ci.IsDeleted = 0
	/*--get next due by searching activechecklists and upcoming
	left outer join qcheck_activechecklists ac1
	on ac1.instanceid = ci.id
	and ac1.completeddate is null
	left outer join qcheck_activechecklists ac2
	on ac1.instanceid = ac2.instanceid
	and ac2.completeddate is null
	and ac2.duetime < ac1.duetime
	left outer join qcheck_upcomingduetimes udt1
	on udt1.instanceid = ci.id
	and ac1.id is null
	left outer join qcheck_upcomingduetimes udt2
	on udt2.instanceid = ci.id
	and udt2.duetime < udt1.duetime

	--get last completed from activechecklists / archive
	left outer join qcheck_activechecklists ac3
	on ac3.instanceid = ci.id
	and ac3.completeddate is not null
	left outer join qcheck_activechecklists ac4
	on ac4.instanceid = ci.id
	and ac4.completeddate is not null
	and ac4.completeddate > ac3.completeddate

	left outer join qcheck_activechecklistarchive aca1
	on aca1.instanceid = ci.id
	and aca1.completeddate is not null
	left outer join qcheck_activechecklistarchive aca2
	on aca2.instanceid = ci.id
	and aca2.completeddate is not null
	and aca2.completeddate > aca1.completeddate*/
	
	WHERE control.IsDeleted = 0
	--AND udt2.id is null
	--AND ac2.id is null
	--AND ac4.id is null
	--AND aca2.id is null
	ORDER BY 7, c.Name



	SET NOCOUNT OFF

END

























































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetDueDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                  PROCEDURE [dbo].[QCheck_GetDueDate](
	@ID int,
	@DueDate	datetime output
)
 AS

BEGIN

	SET NOCOUNT ON

	SELECT @DueDate = DueTime
	FROM
		QCheck_ActiveChecklists
	WHERE ID = @ID
		

	SET NOCOUNT OFF

END


























GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetExternalLinks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetExternalLinks](
	@UserID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	declare @shortname varchar(100)
		select @shortname = shortname from Qcheck_Users
	where id = @UserID
	
	select AppName as [text], appurl as [url]
	from	Qcheck_appsettings a
	inner join 
		Qcheck_users u
	on 
		a.id = u.app
	and
		u.shortname = @shortname and u.isdeleted = 0
	where
		db_name() <> 'QTasks' 
	

	SET NOCOUNT OFF

END






























































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetFolders]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE                                           PROCEDURE [dbo].[QCheck_GetFolders](
	@UserID int
)
 AS

BEGIN

	SET NOCOUNT ON
	

	
		
		SELECT  
			f.ID, f.FolderName
		FROM
			QCheck_Folders f
		WHERE
			f.UserID = @UserID
		ORDER BY 2

	SET NOCOUNT OFF

END



















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetGroupIDFromName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_GetGroupIDFromName](
	@fullname varchar(100)
) AS

BEGIN

	SET NOCOUNT ON
	
	declare @id int
	
	-- First try an exact match
	select @id = id from qcheck_groups where name = @fullname
	
	-- Next try a partial match, only calling it a match if there is exactly one matching row
	if @id is null begin
		select @id = id from qcheck_groups where left(name, LEN(@fullname)) = @fullname	
		if @@ROWCOUNT <> 1  set @id = null
	end
	
	-- If a match was found, return it, otherwise return no rows
	if @id is not null
	begin
		select @id as id
	end
	else
	begin
		select 0 as id where 1 = 0
	end
	
	SET NOCOUNT OFF

END



GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetGroupMembers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                         PROCEDURE [dbo].[QCheck_GetGroupMembers]
	@ID int
 AS

BEGIN

	SET NOCOUNT ON

		SELECT gm.ID, u.FullName, gm.GroupID
		FROM QCheck_GroupMembership gm
		INNER JOIN QCheck_Users u
		ON gm.UserID = u.ID
		WHERE gm.GroupID = @ID
		
	SET NOCOUNT OFF

End

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetGroupName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                       PROCEDURE [dbo].[QCheck_GetGroupName]
	@ID int,
	@Name varchar(50) output
 AS

BEGIN

	SET NOCOUNT ON

		SELECT @Name = Name from QCheck_Groups where id = @id

	SET NOCOUNT OFF

End
































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetGroups]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                        PROCEDURE [dbo].[QCheck_GetGroups]
 AS

BEGIN

	SET NOCOUNT ON
	

		SELECT 
			Distinct g.ID, g.Name as FullName, string_agg(u.email, ';') as email
		FROM
			QCheck_Groups g
		INNER JOIN 
			QCheck_GroupMembership gm
		ON 	gm.GroupID = g.ID
		INNER JOIN 
			QCheck_Users u
		ON
			u.ID = gm.UserID
		AND 
			u.IsDeleted = 0
		group by g.id, g.name

		ORDER BY 2



	SET NOCOUNT OFF

End


































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetGroupsAll]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE                          PROCEDURE [dbo].[QCheck_GetGroupsAll]
 AS

BEGIN

	SET NOCOUNT ON
	

		SELECT 
			Distinct g.ID, g.Name as FullName, isNull(u.FullName, '') As Owner
		FROM
			QCheck_Groups g
		LEFT OUTER JOIN
			QCheck_Users u
		ON
			u.ID = g.Owner
		AND
			u.IsDeleted = 0
		AND
			g.SingleMemberGroup = 0

		
		ORDER BY 2



	SET NOCOUNT OFF

End




































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetGroupUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create                         PROCEDURE [dbo].[QCheck_GetGroupUsers]
	@ID int
 AS

BEGIN

	SET NOCOUNT ON

		SELECT u.ID, u.FullName
		FROM QCheck_GroupMembership gm
		INNER JOIN QCheck_Users u
		ON gm.UserID = u.ID
		WHERE gm.GroupID = @ID
		
	SET NOCOUNT OFF

End

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstanceAssigneeCounts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_GetInstanceAssigneeCounts](
	@InstanceID INT,
	@ChangeID INT = -1
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @Out TABLE (
		[ID] INT,
		[UserID] INT,
		Existing BIT
	)
	DECLARE @Count int

	-- Get the existing assignments
	INSERT INTO @Out	
		SELECT 
			a.ID, 
			gm.[UserID],
			1 As Existing
		FROM
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON g.ID = gm.GroupID
		WHERE
			a.IsDeleted = 0
			AND a.InstanceID = @InstanceID

	-- Get any assignments that were added in the given change request
	INSERT INTO @Out
		SELECT 
			a.ID, 
			gm.[UserID],
			0 As Existing
		FROM
			QCheck_Approval_Assignments a
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON A.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON g.ID = gm.GroupID
		WHERE
			a.IsDeleted = 0
			AND a.InstanceID = @InstanceID
			AND a.ChangeRequestID = @ChangeID

	-- Remove any existing checklist managers that were removed in the given change request
	DELETE FROM @Out
	WHERE 
		[ID] IN (
			SELECT 
				AssignmentID
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_Approval_ChangeRequestItems CRI
					ON A.CRItemID = CRI.[ID]
					AND CRI.Approved = 1
			WHERE
				A.ChangeRequestID = @ChangeID
				AND IsDeleted = 1
		)
		AND Existing = 1

	-- Get the final output
	Select Count(UserID) as [Count]
	FROM @Out
	


	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstanceAssignments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_GetInstanceAssignments](
	@InstanceID INT,
	@ChangeID INT = -1
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @Out TABLE (
		[ID] INT,
		Member VARCHAR(50),
		Existing BIT
	)

	-- Get the existing assignments
	INSERT INTO @Out	
		SELECT 
			a.ID, 
			g.[Name] as Member,
			1 As Existing
		FROM
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
		WHERE
			a.IsDeleted = 0
			AND a.InstanceID = @InstanceID

	-- Get any assignments that were added in the given change request
	INSERT INTO @Out
		SELECT 
			a.ID, 
			g.[Name] as Member,
			0 As Existing
		FROM
			QCheck_Approval_Assignments a
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON A.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
		WHERE
			a.IsDeleted = 0
			AND a.InstanceID = @InstanceID
			AND a.ChangeRequestID = @ChangeID

	-- Remove any existing checklist managers that were removed in the given change request
	DELETE FROM @Out
	WHERE 
		[ID] IN (
			SELECT 
				AssignmentID
			FROM 
				QCheck_Approval_Assignments A
				INNER JOIN QCheck_Approval_ChangeRequestItems CRI
					ON A.CRItemID = CRI.[ID]
					AND CRI.Approved = 1
			WHERE
				A.ChangeRequestID = @ChangeID
				AND IsDeleted = 1
		)
		AND Existing = 1

	-- Get the final output
	SELECT 
		[ID],
		Member,
		Existing
	FROM
		@Out
	ORDER BY
		Member
	

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstanceManagers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetInstanceManagers] (
	@InstanceID INT,
	@ChangeID INT = -1
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @ChecklistID INT

	SELECT @ChecklistID = ChecklistID
	FROM QCheck_ChecklistInstances
	WHERE [ID] = @InstanceID

	EXEC QCheck_GetManagers @ChecklistID, @ChangeID

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstanceRecurring]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                  PROCEDURE [dbo].[QCheck_GetInstanceRecurring](
	@InstanceID INT
)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as isRecurring
	FROM  QCheck_ChecklistInstances b
	INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID 
	WHERE b.ID = @InstanceID

	SET NOCOUNT OFF

END


SET ANSI_NULLS ON
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstanceReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE               PROCEDURE [dbo].[QCheck_GetInstanceReports](
	@InstanceID int,
	@UserID int
)
 AS
BEGIN

	SELECT r.ID, r.Name, 'My Reports' AS RptGroup
	FROM 
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.reportID = r.ID
	INNER JOIN QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.Id
	WHERE
		gm.UserID = @UserID
	AND
		r.IsDeleted = 0

	UNION

	SELECT r.ID, r.Name, 'Supervised Reports' AS RptGroup
	FROM 
		QStatus_Supervisors sup
	INNER JOIN 
		QStatus_Report r
	ON 
		sup.ReportID = r.ID
	INNER JOIN 
		QCheck_Groups g
	ON 
		g.ID = sup.SupervisorGroupID
	INNER JOIN 
		QCheck_GroupMembership gm
	ON 
		gm.GroupID = g.ID
	WHERE
		gm.UserID = @UserID
	AND
		r.IsDeleted = 0
	AND	
		sup.InterestedParty = 0

ORDER BY RptGroup, r.Name
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstances]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







-- This stored procedure will retrieve all instances for a specified checklist that member has rights to
-- isAdmin allows all instances to be returned
-- Used on schedule checklist page.

CREATE                  PROCEDURE [dbo].[QCheck_GetInstances](
	@ChecklistID INT
)
 AS

BEGIN

	SET NOCOUNT ON

		--simple select from the instance table
		SELECT [ID],[Name] 
		FROM
			QCheck_ChecklistInstances
		WHERE
			ChecklistID = @ChecklistID
		AND 	
			IsDeleted = 0
		
		ORDER BY [ID]
	

	SET NOCOUNT OFF

END


































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetInstanceTaskTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE              PROCEDURE [dbo].[QCheck_GetInstanceTaskTypes]
(
	@InstanceID int
)
 AS

BEGIN
	
	SELECT itt.ID, r.Name as Report, tt.Description as TaskType, r.ID as ReportID
	FROM QStatus_InstanceTaskType itt
	inner join QStatus_TaskTypes tt
	on tt.ID = itt.TaskType
	inner join QStatus_Report r
	ON r.ID = tt.ReportID
	AND r.IsDeleted = 0
	WHERE itt.InstanceID = @InstanceID
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetItemTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






-- This stored procedure will retrieve all the item types for the dropdown.
-- Used on build checklist page.

CREATE       PROCEDURE [dbo].[QCheck_GetItemTypes] 
 AS

BEGIN

	SET NOCOUNT ON
	

	--simple select from the itemtypes table.  Use nativetype to place checkbox first
	SELECT 
		ID, Name, NativeType
	FROM 
		QCheck_ItemTypes
	ORDER BY NativeType desc, Name

	SET NOCOUNT OFF

END






























GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetManagers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_GetManagers] (
	@ID INT,
	@ChangeID INT = -1
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @Out TABLE (
		[ID] INT,
		FullName VARCHAR(50),
		Existing BIT
	)

	-- Get the existing checklist managers
	INSERT INTO @Out	
		SELECT 
			m.[ID], 
			g.[Name] As FullName,
			1 As Existing
		FROM
			QCheck_ChecklistManagers m
			INNER JOIN QCheck_Groups g
				ON g.ID = m.ManagerGroupID
		WHERE
			m.ChecklistID = @ID
			AND m.IsDeleted = 0
	
	-- Get any checklist managers that were added in the given change request
	INSERT INTO @Out
		SELECT 
			m.[ID], 
			g.[Name] As FullName,
			0 As Existing
		FROM
			QCheck_Approval_ChecklistManagers m
			INNER JOIN QCheck_Approval_ChangeRequestItems CRI
				ON M.CRItemID = CRI.[ID]
				AND CRI.Approved = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = m.ManagerGroupID
		WHERE
			m.ChecklistID = @ID
			AND m.IsDeleted = 0
			AND m.ChangeRequestID = @ChangeID

	-- Remove any existing checklist managers that were removed in the given change request
	DELETE FROM @Out
	WHERE 
		[ID] IN (
			SELECT 
				ChecklistManagerID
			FROM 
				QCheck_Approval_ChecklistManagers M
				INNER JOIN QCheck_Approval_ChangeRequestItems CRI
					ON M.CRItemID = CRI.[ID]
					AND CRI.Approved = 1
			WHERE
				M.ChangeRequestID = @ChangeID
				AND M.IsDeleted = 1
		)
		AND Existing = 1

	-- Get the final output
	SELECT 
		[ID],
		FullName,
		Existing
	FROM
		@Out

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetMembers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                      PROCEDURE [dbo].[QCheck_GetMembers](
	@login int = null,
	@isAdmin bit = 0
)
 AS

BEGIN

	SET NOCOUNT ON
	

		SELECT DISTINCT ID, FullName
		FROM
		QCheck_Users
		Where IsDeleted = 0
		ORDER BY FullName


	SET NOCOUNT OFF

End































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetMultiUserGroups]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--deploy
CREATE                         PROCEDURE [dbo].[QCheck_GetMultiUserGroups]
AS

BEGIN

	SET NOCOUNT ON

		SELECT distinct G.ID, G.Name
		FROM [dbo].[QCheck_Groups] G
		INNER JOIN dbo.QCheck_GroupMembership GM
			ON G.ID=GM.GroupID
		INNER JOIN dbo.QCheck_Users U
			ON GM.UserID = U.ID
		where singlemembergroup = 0 
		order by Name 
		
	SET NOCOUNT OFF

End

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetMyGroups]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE	PROCEDURE [dbo].[QCheck_GetMyGroups]

	@UserID int,
	@FilterUserID int
 AS

BEGIN

	SET NOCOUNT ON
	

		SELECT DISTINCT g.ID, 
			g.Name, 
			isNull(uName.fullname,'') as owner,
			case when gm.ID is null then 0 else 1 end as isMember,
			case when u.ID is null or g.SingleMemberGroup = 1 then 0 else 1 end as isOwner
		FROM
		QCheck_Groups g
		left outer join qcheck_users u
			on u.id = g.owner
		and 
			u.ID = @UserID
		left outer join qcheck_users uName
			on uName.id = g.owner
		left outer join qcheck_groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @UserID
		left outer join qcheck_groupmembership gm2
			on gm2.GroupID = g.ID
			and gm2.UserID = @FilterUserID
		WHERE
			--g.singleMemberGroup = 0
		--AND
			(@FilterUserID = 0
				OR
			gm2.ID is not null)
		ORDER by IsOwner desc, IsMember desc, Name

		


	SET NOCOUNT OFF

End


GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetMyTasksToAdd]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetMyTasksToAdd]
	@UserID int
AS

BEGIN

	SET NOCOUNT ON
	

		SELECT 
			ci.ID,
			c.Name, 
			CONVERT(VARCHAR(10), duetimes.dt, 101) as duetime,
			CAST(duetimes.dt AS DATETIME) AS duedt,
			dbo.QCheck_AssigneesList(ci.ID) AS Assignees
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Assignments a
				ON a.InstanceID = ci.ID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id
	
		UNION --tasks I control

		SELECT 
			ci.ID,
			c.Name, 
			CONVERT(VARCHAR(10), duetimes.dt, 101) as duetime,
			CAST(duetimes.dt AS DATETIME) AS duedt,
			dbo.QCheck_AssigneesList(ci.ID) AS Assignees
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QCheck_ChecklistManagers cm
				ON cm.ChecklistID = c.ID
				AND cm.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = cm.ManagerGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id


		UNION --tasks on status reports I control

		SELECT 
			ci.ID,
			c.Name, 
			CONVERT(VARCHAR(10), duetimes.dt, 101) as duetime,
			CAST(duetimes.dt AS DATETIME) AS duedt,
			dbo.QCheck_AssigneesList(ci.ID) AS Assignees
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QStatus_InstanceTaskType itt
				ON itt.InstanceID = ci.ID
			INNER JOIN QStatus_TaskTypes tt
				ON tt.ID = itt.TaskType
				AND tt.IsDeleted = 0
			INNER JOIN QStatus_Report r
				ON r.ID = tt.ReportID
				AND r.IsDeleted = 0
			INNER JOIN QStatus_GroupReport gr
				ON gr.ReportID = r.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = gr.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id

		UNION --supervisor
	
		SELECT 
			ci.ID,
			c.Name, 
			CONVERT(VARCHAR(10), duetimes.dt, 101) as duetime,
			CAST(duetimes.dt AS DATETIME) AS duedt,
			dbo.QCheck_AssigneesList(ci.ID) AS Assignees
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QStatus_InstanceTaskType itt
				ON itt.InstanceID = ci.ID
			INNER JOIN QStatus_TaskTypes tt
				ON tt.ID = itt.TaskType
				AND tt.IsDeleted = 0
			INNER JOIN QStatus_Report r
				ON r.ID = tt.ReportID
				AND r.IsDeleted = 0
			INNER JOIN QStatus_Supervisors s
				ON s.ReportID = r.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = s.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id
				
		order by 4

	SET NOCOUNT OFF

End

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetMyTasksToAddAssignees]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetMyTasksToAddAssignees]
	@UserID int
AS

BEGIN

	SET NOCOUNT ON
	

		SELECT DISTINCT
			g.Name
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Assignments a
				ON a.InstanceID = ci.ID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = a.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id
	
		UNION --tasks I control

		SELECT DISTINCT
			ag.Name
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QCheck_ChecklistManagers cm
				ON cm.ChecklistID = c.ID
				AND cm.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = cm.ManagerGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id
			INNER JOIN QCheck_Assignments a
				ON ci.ID = a.InstanceID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups ag
				ON a.GroupID = ag.ID


		UNION --tasks on status reports I control

		SELECT DISTINCT
			ag.Name
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QStatus_InstanceTaskType itt
				ON itt.InstanceID = ci.ID
			INNER JOIN QStatus_TaskTypes tt
				ON tt.ID = itt.TaskType
				AND tt.IsDeleted = 0
			INNER JOIN QStatus_Report r
				ON r.ID = tt.ReportID
				AND r.IsDeleted = 0
			INNER JOIN QStatus_GroupReport gr
				ON gr.ReportID = r.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = gr.GroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id
			INNER JOIN QCheck_Assignments a
				ON ci.ID = a.InstanceID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups ag
				ON a.GroupID = ag.ID

		UNION --supervisor
	
		SELECT DISTINCT
			ag.Name
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
				AND ci.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QStatus_InstanceTaskType itt
				ON itt.InstanceID = ci.ID
			INNER JOIN QStatus_TaskTypes tt
				ON tt.ID = itt.TaskType
				AND tt.IsDeleted = 0
			INNER JOIN QStatus_Report r
				ON r.ID = tt.ReportID
				AND r.IsDeleted = 0
			INNER JOIN QStatus_Supervisors s
				ON s.ReportID = r.ID
			INNER JOIN QCheck_Groups g
				ON g.ID = s.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				AND gm.UserID = @UserID	
			INNER JOIN (
				select ac.instanceid, convert(varchar(10), ac.duetime, 101) as dt, convert(varchar(10), ac.reminderdate, 101) as softdue
				from qcheck_activechecklists ac
				left outer join qcheck_activechecklists ac2 on ac.instanceid = ac2.instanceid and ac2.origduetime < ac.origduetime
				where ac2.[id] is null
			) duetimes
				on duetimes.instanceid = ci.id
			INNER JOIN QCheck_Assignments a
				ON ci.ID = a.InstanceID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups ag
				ON a.GroupID = ag.ID
				
		order by 1

	SET NOCOUNT OFF

End

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetOverdueTasks_Extension]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

Create PROCEDURE [dbo].[QCheck_GetOverdueTasks_Extension]
@userId int
AS
	SELECT DISTINCT 
			
			a.[ID], 
			f.[Name], 
			u.[ID], 
			'', 
			'Overdue',
			a.DueTime,
			dateadd(HOUR, 2,a.DueTime)NewDueTime,
			ccl.controllers,
			--(select email from QCheck_Users where FullName=ccl.controllers) as SupervisorEmail,
			Replace(al.assignees,'&nbsp;',' ') as Assignee,
			1
		FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ActiveAssignments b
				ON b.ActiveChecklistID = a.ID
			INNER JOIN QCheck_Assignments c
				ON b.AssignmentsID = c.ID
				AND c.IsDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = c.GroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do 
				ON u.ID = do.UserID
			LEFT OUTER JOIN QCheck_DailyOverdueBCC bcc
				ON u.ID = bcc.UserID
			 LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = f.id
			 LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on c.InstanceID=al.InstanceID
		WHERE
			-- dont email if this is set
			do.UserID is null
			And DueTime >GetDate()
			AND DueTime <= dateadd(HOUR, 2,getdate()) --need to change it to two hours here
			AND CompletedDate is null
			and U.ID=@userId
			
			--AND (
			--	@LateRun = 0
			--	OR bcc.UserID IS NOT NULL
			--)
			order by DueTime desc
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetOverdueUserChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE	PROCEDURE [dbo].[QCheck_GetOverdueUserChecklists](
	@UserID int,
	@activeChecklistID int = 0,
	@instanceID int = 0,
	@startDate datetime = null,
	--@endDate datetime = null,
	@recurrance int = 0
) AS
BEGIN
	SET NOCOUNT ON
	
		-- get current checklists
		SELECT DISTINCT
		c.ID as ChecklistID ,
		c.Name as ChecklistName,
		al.assigneecount,
		case when pa.activechecklistid is null then 0 else 1 end as PendingChange
		--c.CreateDate,
		--j.Name as ItemType, 
		----d.Text, 	
		--d.URL, 
		--e.Text UserText, 
		--u.FullName As CompletedBy, 
		--convert(varchar,e.CompletedDate,1) + 
		--Right(convert(varchar,e.CompletedDate,0),
		--charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		--as CompletedDate, 
		--d.ID as ItemID, 
		--a.ID As Identifier, 
		--null as UniqueID, 
		--d.SequenceNum, 
		--a.dueTime, 
		--0 as UpcomingID, 
		--a.CompletedDate As ActiveChkCompletedDate, 
		----f.ID as AssignmentID, 
		--isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		--1 As ChkType, 
		--e.CompletedBy as CompletedByID,
		--a.dueTime as dueSort,
		--CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		--CASE WHEN s.freqType = 1 THEN 'One Time' 
		--	 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
		--	 WHEN s.freqType = 3 THEN 
		--			CASE WHEN s.freqRecurrance = 1 THEN 
		--					'Weekly' 
		--			ELSE 
		--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
		--			END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
		--	 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
		--	 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 	--		 WHEN s.freqType = 5 THEN 
		--			CASE WHEN s.freqRecurrance = 1 THEN 
		--					'Yearly' 
		--			ELSE 
		--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
		--			END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
		--	ELSE '' END as ScheduleString,
		----dbo.QStatus_GetActiveChecklistControllers(a.ID) AS Controllers,
		----dbo.QStatus_GetChecklistReports(a.ID, @UserID) as StatusReportString
		--isnull(ccl.controllers, '') as Controllers,
		--isnull(trl.reportslist, '') as StatusReportString,
		--isnull(al.assignees,'') as Assignees
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and @recurrance = 2) and Not (s.freqType > 1 and @recurrance = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_GroupMembership gm on gm. UserID = @UserID
			INNER JOIN QCheck_Groups g on g.ID = gm.GroupID
			INNER JOIN QCheck_Assignments f on f.GroupID = gm.GroupID And f.IsDeleted = 0 and f.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
			LEFT OUTER JOIN QStatus_TaskReportList trl on trl.activechecklistid = a.id and trl.userid = @UserID
	        LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
			LEFT OUTER JOIN QCheck_PendingApprovals pa on pa.activechecklistid = a.id
	     	WHERE
		-- 3/30/2016 dalvarado - removing this filter so you can see past completed items
		--(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate()))) AND 
		--(@activeChecklistID = 0 or a.ID = @activeChecklistID)
		--AND @instanceID = 0
	 --  AND
		a.CompletedDate is null
		AND a.dueTime < IsnULL(@startDate,getDate())
		
	
		
		
	SET NOCOUNT OFF
END

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetPrintBackGroundColor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE            PROCEDURE [dbo].[QCheck_GetPrintBackGroundColor]

@canPrintUserID int,
@BackgroundColor varchar(100) output
AS
BEGIN
	SET NOCOUNT ON
	    SET @BackgroundColor = 'lightblue'
		select @BackgroundColor=BackgroundColor from PrintUserSecurityList where CanPrintUserID=@canPrintUserID
		 

	SET NOCOUNT OFF
END














GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetPrintUserList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







Create            PROCEDURE [dbo].[QCheck_GetPrintUserList]

@userID int
AS
BEGIN
	SET NOCOUNT ON

		SELECT ID, fullname FROM QCheck_Users where isdeleted = 0 and ID in (select CanPrintUserID from PrintUserSecurityList where PrintUserID=@userID)
		 order by FullName

	SET NOCOUNT OFF
END













GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetReminders]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









-- This stored procedure will retrieve all the items on a checklist
-- Used on the Build Checklist page


CREATE     PROCEDURE [dbo].[QCheck_GetReminders](
	@InstanceID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT [ID],DaysBefore, AlertTime FROM QCheck_ALERTS
	WHERE INSTANCEID= @InstanceID
	AND AlertType='Reminder'
	AND IsDeleted = 0
	Order By DaysBefore Desc, AlertTime Asc


	SET NOCOUNT OFF

END





































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetReportFilterDue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck_GetReportFilterDue]
@reportId int,
@userId int,
@filterDue datetime OUTPUT

AS

IF EXISTS 
(
	SELECT PreferenceValue 
	FROM QStatus_Preferences
	WHERE PreferenceType = 'FilterDue'
	AND ReportID = @reportId
	AND UserID = @userId
	AND PreferenceValue = '1'
)

SELECT @filterDue = cast((convert(varchar(10),getdate(),101)) as datetime) + cast(PreferenceValue AS Integer)
FROM QStatus_Preferences
WHERE PreferenceType = 'FilterDueDays'
AND ReportID = @reportId
AND UserID = @userId
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetReportTaskList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   proc [dbo].[QCheck_GetReportTaskList]
	@reportID int
AS
BEGIN
	

	select 
		tt.description as section, 
		c.name, 
		ac.id, 
		-- 9/30/2011 dalvarado - switched to soft due dates
		--convert(varchar, ac.duetime, 101) as duetime
		convert(varchar, ISNULL(ac.ReminderDate, ac.DueTime), 101) as duetime
	from 
		qstatus_tasktypes tt
		inner join qstatus_activechecklisttasktype actt
			on actt.tasktype = tt.id
		inner join qcheck_activechecklists ac
			on actt.activechecklistid = ac.id
			and ac.completeddate is null
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
			and ci.isdeleted = 0
		inner join qcheck_checklists c
			on c.id = ci.checklistid
			and c.isdeleted = 0
	where 
		tt.reportid = @reportID
	order by 
		-- 9/30/2011 dalvarado - switched to soft due dates
		--convert(datetime,ac.duetime) asc --tt.displayorder asc, actt.priority asc
		convert(datetime,ISNULL(ac.ReminderDate, ac.duetime)) asc --tt.displayorder asc, actt.priority asc

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetSchedule]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will retrieve all schedule data for a specified instance
CREATE PROCEDURE [dbo].[QCheck_GetSchedule](
	@InstanceID INT
) AS

BEGIN

	SET NOCOUNT ON

	-- retrieve everything from the schedule table joined with instance
	-- instance table has a foreign key to the schedule table
	SELECT 
		a.* 
	FROM
		QCheck_Schedule a
		INNER JOIN QCheck_ChecklistInstances b
			ON b.scheduleID = a.[ID]	
	WHERE
		b.[ID] = @InstanceID

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetSectionInfoForTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck_GetSectionInfoForTask]
@taskid int,
@reportid int,
@sectionid int OUTPUT,
@sectionname varchar(200) OUTPUT

AS

select @sectionid = tt.id, @sectionname = tt.description
from qstatus_tasktypes tt inner join qstatus_activechecklisttasktype actt on tt.id = actt.tasktype
where tt.reportid = @reportid
and actt.activechecklistid = @taskid
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetSingleChecklist_KVS]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    PROCEDURE [dbo].[QCheck_GetSingleChecklist_KVS](
	@loginID int,
	@type int, 
	@id int
)
 AS

BEGIN

	SET NOCOUNT ON

	DECLARE @tblAssigned table(
			InstanceID int,
			AssignmentID int,
			AssignedTo int
		)
	INSERT INTO @tblAssigned
	SELECT a.InstanceID, a.ID, @loginID
	FROM QCheck_Assignments a
	INNER JOIN QCheck_Groups g
		on
			g.ID = a.GroupID
	INNER JOIN QCheck_Groupmembership gm
		on
			gm.GroupID = g.ID
			and gm.UserID = @loginID
	WHERE a.IsDeleted = 0
	
	
	IF @type = 1
	BEGIN
		-- get current checklists
		SELECT Distinct c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, u.FullName As CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0), charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID as UniqueID
			, d.SequenceNum
			, a.DueTime
			, a.ReminderDate
			, a.CompletedDate As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 1 As ChkType
			, e.CompletedBy as CompletedByID
			, ta.AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, CASE WHEN s.freqType = 1 THEN 'One Time' 
				 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
				 WHEN s.freqType = 3 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Weekly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
						END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
				 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' months' END
				 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				 WHEN s.freqType = 5 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Yearly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
						END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
				ELSE '' END as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, dbo.QStatus_GetChecklistReports(a.ID, @loginID) as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
			, case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee
			, isnull(a.isna, 0) as isna
			, isnull(a.nareason, '') as nareason
			, case when aac.DueTime IS NOT NULL THEN 1 ELSE 0 END PendingChange
			, aac.DueTime NewDeadline
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			LEFT OUTER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta on ta.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
			LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
			LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
			LEFT OUTER JOIN QCheck_MostRecentDeadlineRequests mrdr
					ON a.ID = mrdr.ActiveChecklistID
			LEFT OUTER JOIN QCheck_Approval_ChangeRequests cr
				ON cr.ID = mrdr.ChangeRequestID
			LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aac
					ON aac.ChangeRequestID = CR.[ID]
					AND aac.ActiveChecklistID = mrdr.ActiveChecklistID
			WHERE
			a.ID = @id
		ORDER BY 
			SequenceNum
	END

	IF @type = 2
	BEGIN
		SELECT distinct c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, e.Text UserText
			, uu.FullName AS CompletedBy
			, convert(varchar,e.CompletedDate,1) + Right(convert(varchar,e.CompletedDate,0),charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) as CompletedDate
			, d.ID as ItemID
			, a.ID As Identifier
			, a.ID As UniqueID
			, d.SequenceNum
			, CASE WHEN a.ArchiveDate IS NULL Then a.dueTime Else NULL End As DueTime
			, CASE WHEN a.ArchiveDate IS NULL Then a.ReminderDate Else NULL End As ReminderDate
			, a.CompletedDate As ActiveChkCompletedDate
			, null as AssignmentID
			, 1 As ChkType
			, null As Members
			, 0 as CompletedByID
			, 0 As AssignedTo
			, 0 as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, CASE WHEN s.freqType = 1 THEN 'One Time' 
				 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
				 WHEN s.freqType = 3 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Weekly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
						END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
				 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
				 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				 WHEN s.freqType = 5 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Yearly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
						END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
				ELSE '' END as ScheduleString
			, dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
			, case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee
			, isnull(a.isna, 0) as isna
			, isnull(a.nareason, '') as nareason
	FROM
		QCheck_ActiveChecklistArchive a 
		INNER JOIN 
			(
			SELECT    
				ID, ChecklistID, ScheduleID, null as ArchiveDate
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID, ScheduleID, ArchiveDate
			FROM         
				QCheck_ChecklistInstanceArchive 

			) b
		  ON a.InstanceID = b.ID 
		INNER JOIN QCheck_Checklists_All c
		  on b.checklistID = c.ID  
		INNER JOIN 
			QCheck_Items d
		  on d.checklistID = c.ID 
		INNER JOIN 
			QCheck_ItemTypes j 
		  on d.ItemTypeID = j.ID
		left outer JOIN  QCheck_ActiveItemArchive e
			
		  on 
			e.ActiveChecklistID = a.ID 
			and e.ChecklistItemID = d.ID 
		LEFT OUTER JOIN QCheck_Users uu 
			ON 
			uu.ID = e.CompletedBy
		LEFT OUTER JOIN  QCheck_Schedule s ON b.ScheduleID = s.ID
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
		LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
        WHERE
		a.ID = @ID
        ORDER BY 
		SequenceNum
	END

	IF @type = 3
	BEGIN
		-- get future checklists
		SELECT Distinct 
			c.Name as ChecklistName
			, c.ID AS ChecklistID
			, c.CreateDate
			, j.Name as ItemType
			, d.Text
			, d.URL
			, null As UserText
			, null As CompletedBy
			, null As CompletedDate
			, d.ID as ItemID
			,  b.ID As Identifier
			,  uc.ID As UniqueID
			, d.SequenceNum
			, uc.DueTime
			, NULL AS ReminderDate
			, null As ActiveChkCompletedDate
			, CASE WHEN ta.AssignmentID is null then null else 1 end as AssignmentID
			, 2 As ChkType
			, 0 As AssignedTo
			, uc.ID as UpcomingID
			, CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring
			, CASE WHEN s.freqType = 1 THEN 'One Time' 
				 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
				 WHEN s.freqType = 3 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Weekly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
						END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
				 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
				 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				 WHEN s.freqType = 5 THEN 
						CASE WHEN s.freqRecurrance = 1 THEN 
								'Yearly' 
						ELSE 
								'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
						END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
				ELSE '' END as ScheduleString
			,  dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers
			, '' as StatusReportString
			, isnull(al.assignees,'') as Assignees
			, CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
			, case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee
			, 0 as isna
			, '' as nareason
		FROM
			QCheck_ChecklistInstances b
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			LEFT OUTER JOIN @tblAssigned ta on ta.InstanceID = b.ID
			INNER JOIN QCheck_UpcomingDueTimes uc on uc.InstanceID = b.ID and uc.ID = @id
			LEFT OUTER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
			LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
		ORDER BY 
			SequenceNum
	END
	
	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetStatusListsForCalendar]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE          PROCEDURE [dbo].[QCheck_GetStatusListsForCalendar](
	@UserID int
)
 AS

BEGIN

	
	SET NOCOUNT ON
	
		
	SELECT  distinct
		'*'+ CAST(r.ID as varchar) as reportid, 
		CASE WHEN len('Status: ' + dbo.QStatus_GetUserNames(r.ID) + r.Name) > 40 THEN
			LEFT('Status: ' + dbo.QStatus_GetUserNames(r.ID) + r.Name, 37)+'...'
		ELSE
			'Status: ' + dbo.QStatus_GetUserNames(r.ID) + r.Name
		END
		as fullname
	FROM
		QStatus_Report r
	INNER JOIN QCheck_Groupmembership gm
	ON gm.UserID = @UserID
	INNER JOIN QCheck_Groups g
	ON g.ID = gm.GroupId
	LEFT OUTER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	AND
		gr.GroupID = g.ID
	LEFT OUTER JOIN
		QStatus_Supervisors s
	ON
		r.ID = s.ReportID
	AND
		s.SupervisorGroupID = g.ID

	WHERE
		r.IsDeleted = 0
	AND
		(gr.ID is not null or s.ID is not null)
	Order by 2

	SET NOCOUNT OFF

END
































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetSuggestions]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                   PROCEDURE [dbo].[QCheck_GetSuggestions]
 AS

BEGIN

	SET NOCOUNT ON

		SELECT 
			s.SuggestionID, s.Suggestion, u.FullName AS LoginName, DisplayOrder
		FROM
			QCheck_Suggestions s
		INNER JOIN
			QCheck_Users u
		ON
			s.UserID = u.ID
		WHERE
			s.IsDeleted = 0
		ORDER BY 
			--s.DisplayOrder
			s.SuggestionID DESC
	

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetSupervisedUsersForCalendar]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck_GetSupervisedUsersForCalendar]
--DECLARE
	@UserID int-- = 50
AS
BEGIN
	
	SET NOCOUNT ON

	-- 2023-03-22 KVS - Per GPR and Ken, the Calendar filter should now include only "Assigned To Me", "All Tasks I Control",
	-- and "Assigned To" any user for whose status report the current user is a supervisor or an IP.
	-- So, I borrowed this query from the QStatus_SuperviseesList TVF

	SELECT u.ID, 'Assigned To ' + u.FullName "MemberName"
	FROM QCheck_Users U
		INNER JOIN QCheck_GroupMembership gm
			on gm.userid = u.id
		INNER JOIN QCheck_Groups g1
			on g1.id = gm.groupid
		INNER JOIN QStatus_GroupReport GR
			ON GR.groupid = g1.id
			and gr.defaultreport = 1
		INNER JOIN QStatus_Report R
			ON r.id = gr.reportid
			AND r.IsDeleted = 0
			AND (r.name = u.fullname or r.name not in (select fullname from qcheck_users where isdeleted = 0))
		INNER JOIN QStatus_Supervisors S
			ON R.[ID] = S.ReportID			
			AND s.AsOf < GETDATE()
			AND (s.DirectSupervisor = 1 OR s.InterestedParty = 1)
		INNER JOIN QCheck_Groups G
			ON S.SupervisorGroupID = G.[ID]	
		 INNER JOIN QCheck_GroupMembership gm2
			on gm2.groupid = g.id
		 INNER JOIN QCheck_Users su
			on su.[ID] = gm2.userid
			and su.[ID] <> u.id
			AND su.[ID] = @UserID
	WHERE
		U.IsDeleted = 0		
	ORDER BY MemberName

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserChecklists_KVS]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  	PROCEDURE [dbo].[QCheck_GetUserChecklists_KVS](
	@UserID int,
	@activeChecklistID int = 0,
	@instanceID int = 0,
	@startDate datetime = null,
	@endDate datetime = null,
	@recurrance int = 0
) AS
BEGIN
	SET NOCOUNT ON
	
		-- get current checklists
		SELECT 
		c.ID as ChecklistID,
		c.Name as ChecklistName, 
		c.CreateDate,
		j.Name as ItemType, 
		d.Text, 	
		d.URL, 
		e.Text UserText, 
		u.FullName As CompletedBy, 
		convert(varchar,e.CompletedDate,1) + 
		Right(convert(varchar,e.CompletedDate,0),
		charindex(' ',reverse(convert(varchar,e.CompletedDate,0)))) 
		as CompletedDate, 
		d.ID as ItemID, 
		a.ID As Identifier, 
		a.ID as UniqueID, 
		d.SequenceNum, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		e.CompletedBy as CompletedByID,
		a.dueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetActiveChecklistControllers(a.ID) AS Controllers,
		--dbo.QStatus_GetChecklistReports(a.ID, @UserID) as StatusReportString
		isnull(ccl.controllers, '') as Controllers,
		isnull(trl.reportslist, '') as StatusReportString,
		isnull(al.assignees,'') as Assignees,
		case when ms.checklistid is null then 0 else 1 end as MultiStep,
		case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee,
		al.assigneecount,
		case when aac.ActiveChecklistID is null then 0 else 1 end as PendingChange, 
		aac.DueTime as NewDeadline,
		isnull(a.isna, 0) as isna, 
		isnull(a.nareason, '') as nareason
		FROM
			QCheck_ActiveChecklists a 
			INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
			INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and @recurrance = 2) and Not (s.freqType > 1 and @recurrance = 1)
			INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d on d.checklistID = c.ID AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j on d.ItemTypeID = j.ID
			INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
			INNER JOIN QCheck_GroupMembership gm on gm. UserID = @UserID
			INNER JOIN QCheck_Groups g on g.ID = gm.GroupID
			INNER JOIN QCheck_Assignments f on f.GroupID = gm.GroupID And f.IsDeleted = 0 and f.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveItems e on e.ActiveChecklistID = a.ID and e.ChecklistItemID = d.ID
			LEFT OUTER JOIN QCheck_Users u on e.CompletedBy = u.ID
			LEFT OUTER JOIN QStatus_TaskReportList trl on trl.activechecklistid = a.id and trl.userid = @UserID
	        LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
			LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
			LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
			--LEFT OUTER JOIN QCheck_PendingApprovals pa on pa.activechecklistid = a.id
			LEFT OUTER JOIN QCheck_MostRecentDeadlineRequests mrdr
					ON a.ID = mrdr.ActiveChecklistID
			LEFT OUTER JOIN QCheck_Approval_ChangeRequests cr
				ON cr.ID = mrdr.ChangeRequestID
			LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aac
					ON aac.ChangeRequestID = CR.[ID]
					AND aac.ActiveChecklistID = mrdr.ActiveChecklistID
	     	WHERE
		-- 3/30/2016 dalvarado - removing this filter so you can see past completed items
		--(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate()))) AND 
		(@activeChecklistID = 0 or a.ID = @activeChecklistID)
		AND @instanceID = 0
		AND a.dueTime between @startDate and @endDate

		UNION 
	
		-- get future checklists
		SELECT 
		c.ID As ChecklistID,
		c.Name as ChecklistName, 
		c.CreateDate,
		j.Name as ItemType, 
		d.Text, 
		d.URL, 
		null As UserText, 
		null As CompletedBy, 
		null As CompletedDate,
		d.ID as ItemID,
		b.ID As Identifier,
		upcoming1.ID as UniqueID, 
		d.SequenceNum, 
		upcoming1.DueTime as dueTime, 
		upcoming1.ID as UpcomingID,
		null As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		'12/12/9999' As Computed, 	
		2 As ChkType, 
		0 as CompletedByID,
		upcoming1.DueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers,
		isnull(ccl.controllers, '') as Controllers,
		'' as StatusReportString,
		isnull(al.assignees,'') as Assignees,
		case when ms.checklistid is null then 0 else 1 end as MultiStep,
		case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee,
		AL.assigneecount,
		0 as PendingChange, 
		null as NewDeadline,
		0 as isna, 
		'' as nareason
		
		FROM
			QCheck_ChecklistInstances b
			INNER JOIN QCheck_UpcomingDueTimes upcoming1
				ON b.ID = upcoming1.instanceID
				and upcoming1.DueTime between @StartDate and @EndDate
			INNER JOIN QCheck_Schedule s 
				ON b.ScheduleID = s.ID 
				and Not (s.freqType = 1 and @recurrance = 2) 
				and Not (s.freqType > 1 and @recurrance = 1)
			INNER JOIN QCheck_Checklists c 
				on b.checklistID = c.ID 
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Items d 
				on d.checklistID = c.ID 
				AND d.IsDeleted = 0
			INNER JOIN QCheck_ItemTypes j 
				on d.ItemTypeID = j.ID
			INNER JOIN QCheck_GroupMembership gm 
				on gm. UserID = @UserID
			INNER JOIN QCheck_Groups g
				on g.ID = gm.GroupID
			INNER JOIN QCheck_Assignments f  
				on f.GroupID = gm.GroupID
				And f.IsDeleted = 0 
				and f.InstanceID = b.ID
			LEFT OUTER JOIN QCheck_ActiveChecklists ac
				ON ac.InstanceID = upcoming1.InstanceID
				AND ac.OrigDueTime = upcoming1.DueTime
			LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
			LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
			LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
			LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
		WHERE 
			not b.isDeleted = 1 
			AND (@instanceID = 0 or b.ID = @instanceID)
			AND @activeChecklistID = 0
			AND ac.ID is null
			AND @recurrance < 3
		
		ORDER BY --ChkType,
			Computed desc,
			dueSort,
			ChecklistName,
			Identifier,
			SequenceNum
		
	SET NOCOUNT OFF
END

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserDefaultReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[QCheck_GetUserDefaultReports]

AS
BEGIN

	SELECT p.UserID, p.PreferenceValue AS ReportID
	FROM 
		QStatus_GroupReport gr INNER JOIN 
		QCheck_Groups g ON gr.GroupID = g.ID INNER JOIN
		QCheck_GroupMembership gm ON gm.GroupID = g.ID INNER JOIN
		QCheck_Users u ON u.ID = gm.UserID INNER JOIN
		QStatus_Report r ON gr.ReportID = r.ID INNER JOIN
		QStatus_Preferences p ON p.PreferenceValue = r.ID
	WHERE
		g.SingleMemberGroup = 1 AND
		u.IsDeleted = 0 AND
		r.IsDeleted = 0 AND
		p.PreferenceType = 'LastReport'
	GROUP BY p.UserID, p.PreferenceValue
	ORDER BY p.UserID
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserIDFromName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  PROCEDURE [dbo].[QCheck_GetUserIDFromName](
	@fullname varchar(100)
)
 AS

BEGIN

	SET NOCOUNT ON
	
	select id from qcheck_users where fullname = @fullname

	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GetUserInfo](
	@loginID varchar(50),
	@ID int output,
	@GroupID int output,
	@Admin bit output,
	@DepartmentAdmin bit output,
	@Priorities bit output,
	@FullName varchar(100) output,
	@Email varchar(100) output
)
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @impersonateID int
	DECLARE @origID int


	SELECT @origID=[ID] FROM
		QCheck_Users
	WHERE
		ShortName = @loginID

	--if @loginID = 'kcroft' set @origID = 412

	SELECT @impersonateID = impersonateUserID
	FROM
		QCheck_Impersonate
	WHERE
		UserID = @origID
	AND 
		isDeleted = 0

	SELECT @ID = isNull(@impersonateID, @origID)
	
	SELECT  @Admin=Admin, @DepartmentAdmin = DepartmentAdmin, @Priorities = Priorities, @FullName = FullName, @Email = Email
	FROM
		QCheck_Users
	WHERE
		ID = @ID

	SELECT @GroupID = ID
	FROM QCheck_Groups
	WHERE Owner = @ID
	AND SingleMemberGroup = 1

	SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





create            PROCEDURE [dbo].[QCheck_GetUserList]
AS
BEGIN
	SET NOCOUNT ON

		SELECT ID, fullname FROM QCheck_Users where isdeleted = 0 order by FullName

	SET NOCOUNT OFF
END









GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUserName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                PROCEDURE [dbo].[QCheck_GetUserName](
	@ID INT,
	@UserName varchar(100) output

)
 AS

BEGIN

	SET NOCOUNT ON
	
	SET @UserName = ''

	SELECT @UserName = IsNull(FullName, '')
	FROM QCheck_Users
	WHERE ID = @ID



	SET NOCOUNT OFF

END






GO
/****** Object:  StoredProcedure [dbo].[QCheck_GetUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE              PROCEDURE [dbo].[QCheck_GetUsers]
AS
BEGIN
	SET NOCOUNT ON

		SELECT * FROM QCheck_Users where isdeleted = 0 order by FullName

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GroupByEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GroupByEmail] (
	@email VARCHAR(500)
) AS

BEGIN

	DECLARE @id INT

	SELECT 
		@id = g.ID
	FROM
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
			AND u.ID = g.Owner
			AND g.SingleMemberGroup = 1
	WHERE
		u.Email = @email
		
	IF @id IS NULL BEGIN
	
		SELECT @id = ID
		FROM QCheck_Groups
		WHERE Name = LEFT(@email, CHARINDEX('@', @email) - 1)
	
	END
	
	IF @id IS NULL BEGIN
	
		SET @id = 0
	
	END
		
	SELECT @ID
		
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_GroupByEmail_Output]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GroupByEmail_Output] (
	@Email VARCHAR(500),
	@GroupID INT OUTPUT
) AS

BEGIN

	DECLARE @out TABLE (
		ID int
	)

	INSERT INTO @out
		EXEC QCheck_GroupByEmail @Email
		
	SELECT @GroupID = ID FROM @out

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_GroupEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO














CREATE                           PROCEDURE [dbo].[QCheck_GroupEmail]
	@Type varchar(50),
	@GroupID int,
	@UserID int
 AS

BEGIN

	SET NOCOUNT ON

		INSERT INTO QCheck_GroupChanges (UserID, GroupID, Type)
		SELECT @UserID, @GroupID, @Type

	SET NOCOUNT OFF

End




































GO
/****** Object:  StoredProcedure [dbo].[QCheck_GroupEmail_Send]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_GroupEmail_Send]
	
 AS

BEGIN

	SET NOCOUNT ON
	
		-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

		DECLARE @GroupID int
		DECLARE @mailFrom VARCHAR(1000)
		DECLARE @mailTo VARCHAR(8000)
		DECLARE @mailSubject VARCHAR(1000)
		DECLARE @mailBody VARCHAR(8000)
		DECLARE @mailType VARCHAR(100)
		DECLARE @GroupName varchar(100)
		DECLARE @UserName varchar(100)
		DECLARE @fromname varchar(100)
		DECLARE @Changes varchar(8000)
		DECLARE @Members varchar(8000)

		SET @MailFrom = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'

		SET @mailType = 'text/html'

		DECLARE GROUPCURS CURSOR
			FOR 
		SELECT DISTINCT g.ID, g.Name
		FROM QCheck_GroupChanges gc
		INNER JOIN QCheck_Groups g
		ON g.ID = gc.GroupID
		WHERE dt > getdate() - 1
		
		
		OPEN GROUPCURS
	
		FETCH NEXT FROM GROUPCURS INTO @GroupID, @GroupName
		WHILE @@FETCH_STATUS = 0 BEGIN
			
			SET @mailSubject = 'Group Change - ' + @GroupName
			

			SET @mailTo = ''

			SELECT @mailTo = @mailTo + u.Email + ';'
			FROM
			(
				SELECT email
				FROM QCheck_Users u
				INNER JOIN QCheck_GroupMembership gm
				ON u.ID = gm.UserID
				AND gm.GroupID = @GroupID
				left outer join QCheck_DontEmail de
				on u.id = de.UserID
				where de.UserID is null
				
				UNION
	
				SELECT email
				FROM QCheck_Users u
				INNER JOIN QCheck_GroupChanges gc
				ON gc.GroupID = @GroupID
				AND gc.UserID = u.ID
				left outer join QCheck_DontEmail de
				on u.id = de.UserID
				where de.UserID is null
				AND dt > getdate() - 1
			) u

			SET @Changes = '<u>Group Changes</u><br>'

			SELECT @Changes = @Changes + u.FullName + ' ' + gc.Type + '<br>'
			FROM QCheck_Users u
			INNER JOIN QCheck_GroupChanges gc
			ON gc.GroupID = @GroupID
			AND gc.UserID = u.ID
			AND dt > getdate() - 1
			Order by gc.dt

			SET @Members = '<u>Current Members</u><br>'
		
			SELECT @Members = @Members + u.FullName + '<br>'
			FROM QCheck_Users u
			INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
			AND gm.GroupID = @GroupID
			ORDER BY u.FullName

			SET @mailBody = @Changes + '<br>' + @Members
			

			if len(@mailTo) > 0
			EXEC XPSendEmail
			    @FROM       = @mailFrom,
			    @TO         = @mailTo,
			    @subject    = @mailSubject,
			    @message    = @mailBody,
			    @type       = @mailType,
			    @server     = @mailServer

			FETCH NEXT FROM GROUPCURS INTO @GroupID, @GroupName
		END
		CLOSE GROUPCURS
		DEALLOCATE GROUPCURS

		

	SET NOCOUNT OFF

End








































GO
/****** Object:  StoredProcedure [dbo].[QCheck_HandlePatternDefaults]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[QCheck_HandlePatternDefaults]
as
begin

		--add default outside users to outside users so they dont get fined
		insert into [QCheck_OutsideUsers]
        select u.id from qcheck_users u
			inner join QCheck_UserDefaultsByLogin d
				on u.shortname like d.shortnamepattern
				and u.isdeleted = 0
				and d.OutsideUser = 1
				and u.id not in (select userid from [QCheck_OutsideUsers])

		--add cas employees to the CAS group
		insert into qcheck_groupmembership (userid, groupid, asof)
		select u.id, g.id, getdate() 
		from qcheck_users u
		inner join QCheck_UserDefaultsByLogin d
				on u.shortname like d.shortnamepattern
				and u.isdeleted = 0
				and d.defaultgroup is not null
		inner join qcheck_groups g
				on g.name = d.defaultgroup
		left outer join qcheck_groupmembership gm
			on gm.groupid = g.id
			and gm.userid = u.id
		where gm.id is null

		INSERT INTO QStatus_Supervisors
			(ReportID, SupervisorGroupID,  DirectSupervisor)
		select 
			r.id, gSuper.id, 1
		from qcheck_users u
		inner join QCheck_UserDefaultsByLogin d
			on u.shortname like d.shortnamepattern
			and u.isdeleted = 0
			and d.supervisor is not null
		inner join qcheck_groupmembership gm
			on gm.userid = u.id
		inner join qcheck_groups g
			on g.id = gm.groupid
			and g.singlemembergroup= 1
		inner join qcheck_users super	
			on super.shortname = d.supervisor
		inner join qcheck_groupmembership gmSuper
			on gmSuper.userid = super.id
		inner join qcheck_groups gSuper
			on gSuper.id = gmSuper.groupid
			and gSuper.singlemembergroup= 1
		inner join qstatus_groupreport gr
			on gr.defaultreport = 1
			and gr.groupid = g.id
		inner join qstatus_report r
			on r.id = gr.reportid
		left outer join qstatus_supervisors s
			on s.reportid = r.id
			and s.supervisorgroupid = gSuper.id 
		where s.id is null

end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_HasOldOverdue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_HasOldOverdue] (
	@UserID INT,
	@HasOldOverdue BIT OUTPUT
) AS

BEGIN

	SET @HasOldOverdue = 0

	--turning off for phi

	/*SELECT
		@HasOldOverdue = 1	
	FROM	
		QCheck_ActiveChecklists ac
		INNER JOIN QCheck_Assignments a
			ON ac.InstanceID = a.InstanceID
			AND a.IsDeleted = 0
		INNER JOIN QCheck_Checklistinstances ci
			ON CI.ID = ac.InstanceID
			and CI.IsDeleted = 0	
		INNER JOIN QCheck_Checklists c
			ON C.ID = ci.checklistid
			and C.IsDeleted = 0
		INNER JOIN QCheck_GroupMembership gm
			ON a.GroupID = gm.GroupID
		INNER JOIN QCheck_Groups g
			on g.ID = gm.GroupID
		LEFT OUTER JOIN (
			SELECT DISTINCT
				aac.ActiveChecklistID
			FROM 
				QCheck_Approval_ActiveChecklists aac
				INNER JOIN QCheck_Approval_ChangeRequests cr
					ON aac.ChangeRequestID = cr.ID
			WHERE
				cr.ReadyForSupervisor = 1
				AND cr.IsActive = 1
				AND cr.Approved = 0
				AND cr.Rejected = 0
		) cr
			ON ac.ID = cr.ActiveChecklistID
	WHERE
		ac.DueTime <= DATEADD(DAY, -7, GETDATE())
		AND ac.CompletedDate IS NULL
		AND gm.UserID = @UserID
		AND cr.ActiveChecklistID IS NULL*/
		
	SELECT @HasOldOverdue AS HasOldOverdue
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_InsertEmailIntoQueue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck_InsertEmailIntoQueue] 
@userID int,
@emailTo varchar(1000),
@emailFrom varchar(100),
@emailReplyTo varchar(100),
@emailSubject varchar(255),
@emailSent bit,
@commentsExist bit

AS

DECLARE @Errored bit, @Delivered bit

IF @emailSent = 0
BEGIN
	SET @Errored = 1
	SET @Delivered = 0
END
ELSE
BEGIN
	SET @Errored = 0
	SET @Delivered = 1
END

IF @commentsExist = 0
BEGIN
	SET @Errored = 0
	SET @Delivered = 0
END

INSERT INTO QCheck_QueuedEmails(UserID, emailTo, emailFrom, emailReplyTo, emailSubject, HasComments, Errored, Delivered)
VALUES(@UserID, @emailTo, @emailFrom, @emailReplyTo, @emailSubject, @commentsExist, @Errored, @Delivered)
GO
/****** Object:  StoredProcedure [dbo].[QCheck_InstanceChangeAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE             PROCEDURE [dbo].[QCheck_InstanceChangeAlert]
(
	@InstanceID int,
	@AlertType varchar(10),
	@AddRemoveChange varchar(10)

) AS
BEGIN

	DECLARE @ID int
	DECLARE @ChecklistName VARCHAR(500)
	DECLARE @ChecklistID int
	DECLARE @Alertee int

	DECLARE InstanceChange_CHK_CURS CURSOR FOR
	SELECT
		a.ID, d.[ID], d.[Name], u.ID
	FROM 
		QCheck_Alerts a
	INNER JOIN
		QCheck_ChecklistInstances b
	   ON 
		a.InstanceID = b.ID
	INNER JOIN
		QCheck_Checklists d
	   ON 
		b.ChecklistID = d.[ID]
	INNER JOIN 
		QCheck_Groups g
	ON
		g.ID = a.AlerteeGroupID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN QCheck_Users u
	ON 
		u.ID = gm.UserID
	AND
		u.IsDeleted = 0
	WHERE
		a.InstanceID = @InstanceID
	AND
		a.AlertType = @AlertType
	and 
		a.isdeleted = 0

		OPEN InstanceChange_CHK_CURS
		FETCH NEXT FROM InstanceChange_CHK_CURS INTO @ID, @ChecklistID, @ChecklistName, @Alertee
		WHILE @@FETCH_STATUS = 0 BEGIN
	
		EXEC QCheck_InstanceChangeAlert_SingleUser @InstanceID, @ChecklistID, @ChecklistName, @Alertee, @AlertType
		
		UPDATE QCheck_Alerts
		SET SentTime = getDate()
		WHERE [ID] = @ID

		FETCH NEXT FROM InstanceChange_CHK_CURS INTO @ID, @ChecklistID, @ChecklistName, @Alertee
		END
		CLOSE InstanceChange_CHK_CURS
		DEALLOCATE InstanceChange_CHK_CURS
END






GO
/****** Object:  StoredProcedure [dbo].[QCheck_InstanceChangeAlert_SingleUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_InstanceChangeAlert_SingleUser](
	@InstanceID int,
	@ChecklistID int,
	@ChecklistName varchar(500),
	@Alertee int,
	@AlertType varchar(10)
)
AS

BEGIN
	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1


	DECLARE @mail_to VARCHAR(500)
	DECLARE @mail_from VARCHAR(500)
	DECLARE @mail_subject VARCHAR(500)
	
	SELECT @mail_to = Email FROM QCheck_Users where ID = @Alertee

	SET @Mail_From = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	SET @mail_subject = 'Alert - ' + @AlertType + ' change for the ' + @ChecklistName+' task.'

	
	declare @html table (id int identity(1,1), html varchar(max))
	insert into @html exec QCheck_InstanceChangeAlert_SingleUser_HTML
	declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
	while exists (select 1 from @html)
	begin
		select top 1 @rowid = id from @html order by id asc
		select @onerow = html from @html where id = @rowid
		select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
		delete from @html where id = @rowid
	end
	
	exec [dbo].[xp_smtp_sendmail]
		@to = @mail_to,
		@from = @mail_from,
		@subject = @mail_subject,
		@message = @htmlstr
	


	SET NOCOUNT OFF
END


































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_InstanceChangeAlert_SingleUser_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE                               PROCEDURE [dbo].[QCheck_InstanceChangeAlert_SingleUser_HTML]
	
AS

BEGIN
	SET NOCOUNT ON

	SELECT ''

	SET NOCOUNT OFF
END



































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_IsOverdueAdmin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_IsOverdueAdmin]
	@UserID int,
	@IsAdmin bit output
	
as
begin
	set nocount on

		SELECT @IsAdmin = 0

		SELECT @IsAdmin = 1
		FROM QCheck_OverdueAdmins
		WHERE UserID = @UserID


	set nocount off
end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_IsPrintButtonVisible]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_IsPrintButtonVisible] (
	@UserID INT,
	@IsPrintButtonVisible BIT OUTPUT
) AS

BEGIN

	SET @IsPrintButtonVisible = 0

	SELECT
		@IsPrintButtonVisible = 1	
	FROM	
		PrintUserSecurityList  where PrintUserID=@UserID
		
	SELECT @IsPrintButtonVisible AS IsPrintButtonVisible
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_ITChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ITChecklists]

AS

select distinct c.name as Checklist, dbo.QStatus_GetChecklistControllers(c.id) as Controllers, dbo.QCheck_assigneeslist(ci.id) as 'Assigned To', min(ac.duetime) as 'Next Due Date', dbo.QStatus_StatusReportList(ci.id) as Reports
from qcheck_checklists c 
inner join qcheck_checklistmanagers cm
on c.id = cm.checklistid inner join qcheck_groups g
on g.id = cm.managergroupid inner join qcheck_groupmembership gm
on g.id = gm.groupid inner join
qcheck_checklistinstances ci on ci.checklistid = c.id inner join
qcheck_activechecklists ac on ci.id = ac.instanceid inner join
(select gm.userid from qcheck_groupmembership gm inner join qcheck_groups g on g.id = gm.groupid where g.name = 'IT' and gm.userid <> 71) gmIT on gmIT.userid = gm.userid
where c.isdeleted = 0 and cm.isdeleted = 0 and c.name <> ''
group by c.name, dbo.QStatus_GetChecklistControllers(c.id), dbo.QCheck_assigneeslist(ci.id), dbo.QStatus_StatusReportList(ci.id)

union

select distinct c.name as Checklist, dbo.QStatus_GetChecklistControllers(c.id) as Controllers, dbo.QCheck_assigneeslist(ci.id) as 'Assigned To', min(ac.duetime) as 'Next Due Date', dbo.QStatus_StatusReportList(ci.id) as Reports
from qcheck_checklists c inner join
qcheck_checklistinstances ci on ci.checklistid = c.id inner join
qcheck_activechecklists ac on ci.id = ac.instanceid inner join
 qcheck_assignments a 
on a.instanceid = ci.id inner join qcheck_groups g
on g.id = a.groupid inner join qcheck_groupmembership gm
on g.id = gm.groupid inner join
(select gm.userid from qcheck_groupmembership gm inner join qcheck_groups g on g.id = gm.groupid where g.name = 'IT' and gm.userid <> 71) gmIT on gmIT.userid = gm.userid
where c.isdeleted = 0 and a.isdeleted = 0 and c.name <> ''
group by c.name,  dbo.QStatus_GetChecklistControllers(c.id), dbo.QCheck_assigneeslist(ci.id), dbo.QStatus_StatusReportList(ci.id)
order by c.name
GO
/****** Object:  StoredProcedure [dbo].[QCheck_LoadTime]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                     PROCEDURE [dbo].[QCheck_LoadTime] 
	@UserID int,
	@PageName varchar(100),
	@dt datetime,
	@ClientLoadTime int,
	@ServerLoadTime int,
	@ReportID int = null,
	@Browser varchar(100) = null,
	@LastViewed datetime = null
AS
BEGIN
	SET NOCOUNT ON
	
	DECLARE @ReportName varchar(500)
	
	IF @ReportID IS NOT NULL
	BEGIN
		SELECT @ReportName = Name
		FROM dbo.QStatus_Report
		WHERE ID = @ReportID

	IF CHARINDEX('inbox',@PageName) > 0
		SELECT @LastViewed = LastViewed
		FROM QStatus_SupervisorsLastViewed
		WHERE ReportID = @ReportID AND SupervisorUserID = @UserID

	END

	INSERT INTO QCheck_LoadTimes
	SELECT @UserID, @PageName, @ServerLoadTime, @ClientLoadTime, @dt, @ReportName, @LastViewed, @Browser

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_LoadTimeReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  PROCEDURE [dbo].[QCheck_LoadTimeReport]
--@StartDate datetime,
--@EndDate datetime

AS

SELECT u.FullName as [User], UserID, PageName AS 'Page Name', ServerLoadTime AS 'Server Time', ClientLoadTime AS 'Client Time', TotalTime AS 'Total Load Time', dt as 'DateTime', ReportName AS 'Report Name', LastOpened, Browser
FROM QCheck_LoadTimes LT INNER JOIN QCheck_Users U on LT.UserID = U.ID
WHERE (PageName = 'ASP.StatusCopy_aspx' or PageName = 'ASP.statusinbox_aspx')--or PageName = 'Report/Comments')
AND ReportName is not null
--AND dt < dateadd(dd, 1, @EndDate)
--AND dt > @StartDate

--CONVERT(CHAR(8),GETDATE(),110) = CONVERT(CHAR(8),dt,110)
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ManagesChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_ManagesChecklist] (
	@ChecklistID INT,
	@GroupID INT,
	@IsManager BIT OUTPUT
) AS

BEGIN

	-- First see if the given group is a controller of the task.
	SET @IsManager = 0
	
	SELECT 
		@IsManager = 1
	FROM
		QCheck_ChecklistManagers_WithTemp
	WHERE
		ChecklistID = @ChecklistID
		AND ManagerGroupID = @GroupID
		AND IsDeleted = 0

	-- If the given group is a single member group and not a controller of
	-- the task, go find what other groups the user is a member of and see 
	-- if any of those groups are controllers of the task.  Meaning if I 
	-- hand in the David Alvarado group (24), I need to see if the task is 
	-- controlled by IT, Developers, etc.
	IF @IsManager = 0 BEGIN

		SELECT 
			@IsManager = 1
		FROM 
			QCheck_Groups g
			INNER JOIN QCheck_GroupMembership gm
				ON g.[ID] = gm.GroupID
			INNER JOIN QCheck_Users u
				ON gm.UserID = u.[ID]
			INNER JOIN QCheck_GroupMembership gm2
				ON gm.UserID = gm2.UserID
			INNER JOIN QCheck_ChecklistManagers_WithTemp cm
				ON gm2.GroupID = cm.ManagerGroupID
		WHERE 
			g.[ID] = @GroupID
			AND cm.ChecklistID = @ChecklistID
			AND g.SingleMemberGroup = 1
			AND u.IsDeleted = 0
			AND cm.IsDeleted = 0
			
		--c
		SELECT @IsManager = 1
		where @GroupID in (Select groupid from QCheck_SuperUserGroups)
		

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_MessageToOverdues_EMAIL]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_MessageToOverdues_EMAIL] (
	@UserID INT,
	@RecipientIDs VARCHAR(1000),
	@Message VARCHAR(1000)
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @work TABLE (
		Seq INT IDENTITY(1,1),
		AssigneeID INT,
		Email VARCHAR(50)
	)

	DECLARE @i INT,
			@count INT,
			@AssigneeID INT,
			@MailTo VARCHAR(50),
			@MailFrom VARCHAR(50)
			
	SET @Message = REPLACE(@Message, '''', '')

	INSERT INTO @work (
		AssigneeID,
		Email
	)
		SELECT DISTINCT
			AssigneeID,
			Email
		FROM 
			QCheck_OverdueTasksByController o
			-- Filter down to the recipients passed in
				INNER JOIN dbo.Util_fn_List_To_Table(@RecipientIDs, ',') r
					ON o.AssigneeID = r.c		
		WHERE
			o.ControllerID = @UserID
			AND o.AssigneeID <> @UserID


	SELECT @MailFrom = FullName + '<' + Email + '>' FROM QCheck_Users WHERE id = @UserID

	SELECT @i = 1, @count = MAX(Seq) FROM @work
	WHILE @i <= @count BEGIN

		SELECT 
			@MailTo = Email, 
			@AssigneeID = AssigneeID 
		FROM @work 
		WHERE Seq = @i
			
		
		declare @MailSubject varchar(500)
		set @MailSubject = 'Your ' + @AppName + ' Overdue Tasks'

		declare @html table (id int identity(1,1), html varchar(max))
		insert into @html exec QCheck_MessageToOverdues_HTML @UserID, @AssigneeID, @Message
		declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end
		
		exec [dbo].[xp_smtp_sendmail]
			@to = @MailTo,
			@from = @MailFrom,
			@subject = @MailSubject,
			@message = @htmlstr

		SET @i = @i + 1
		
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_MessageToOverdues_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_MessageToOverdues_HTML] (	
	@ControllerID INT,
	@AssigneeID INT,
	@Message VARCHAR(1000)
) AS

BEGIN
	
	DECLARE @out TABLE (
		seq INT IDENTITY(1,1),
		html VARCHAR(MAX),
		DueTime DATETIME
	)
	
	INSERT INTO @out (html) VALUES ('<h3>' + @Message + '</h3><br/><br/>')
	INSERT INTO @out (html) VALUES ('<table border="1" cellpadding="2" cellspacing="0">')
	INSERT INTO @out (html) VALUES ('<tr><th>Task</th><th>Due</th><th>Assignees</th><th>Controllers</th></tr>')
	INSERT INTO @out (html, DueTime)
		SELECT DISTINCT
			'<tr>' +
			'<td>' + ISNULL(ChecklistName, '&nbsp;') + '</td>' +
			'<td>' + ISNULL(CONVERT(VARCHAR(20), DueTime), '&nbsp;') + '</td>' +
			'<td>' + ISNULL(dbo.QCheck_AssigneesList(InstanceID), '&nbsp;') + '</td>' +
			'<td>' + ISNULL(dbo.QCheck_ManagersList(ChecklistID), '&nbsp;') + '</td>' +
			'</tr>',
			DueTime
		FROM 
			QCheck_OverdueTasksByController
		WHERE
			AssigneeID = @AssigneeID
			AND ControllerID = @ControllerID
		ORDER BY
			DueTime
			
	INSERT INTO @out (html) VALUES ('</table>')
	
	SELECT html
	FROM @out
	ORDER BY seq
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_MessageToOverdues_RecipientList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_MessageToOverdues_RecipientList] (
	@UserID INT,
	@ControllerID INT = NULL
) AS

BEGIN

	IF @ControllerID is null 
		SELECT @ControllerID = @UserID

	SELECT DISTINCT
		AssigneeID,
		FullName
	FROM
		QCheck_OverdueTasksByController
	WHERE
		ControllerID = @ControllerID
		--AND AssigneeID <> @UserID
		
	UNION 
	
	SELECT DISTINCT
		c.AssigneeID,
		c.FullName
	FROM
		QCheck_OverdueTasksByController c
	INNER JOIN QCheck_OverdueTasksByController c2
		ON c2.activeChecklistID = c.activeChecklistID		
	WHERE
		c2.AssigneeID = @ControllerID
	
		
	ORDER BY
		FullName
		
	

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_MoveChecklistToFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                                     PROCEDURE [dbo].[QCheck_MoveChecklistToFolder](
	@UserID int,
	@ChecklistID int,
	@FolderID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	UPDATE QCheck_FolderChecklists
	SET FolderID = @FolderID
	WHERE 
		ChecklistID = @ChecklistID
	AND FolderID IN
		(SELECT ID FROM QCheck_Folders
		WHERE USERID = @UserID
		UNION ALL SELECT 0)

	IF @@rowcount = 0 
		INSERT INTO QCheck_FolderChecklists
			(ChecklistID, FolderID)
		VALUES
			(@ChecklistID, @FolderID)

	SET NOCOUNT OFF

END













































GO
/****** Object:  StoredProcedure [dbo].[QCheck_MoveFolderToFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                                    PROCEDURE [dbo].[QCheck_MoveFolderToFolder](
	@FolderID int,
	@ParentID int
)
 AS

BEGIN

	SET NOCOUNT ON

	--check to make sure we are not adding this folder to a child folder of itself.
	declare @circular bit = 0

	;with tree as (
		select id, foldername, parentfolder, 1 as lvl from qcheck_folders where id = @FolderID
		union all
		select f.id, f.foldername, f.parentfolder, t.lvl + 1
		from tree t
		inner join qcheck_folders f
			 on f.parentfolder = t.id
		where t.lvl < 1000
	)
	select @circular = 1 from tree
	where id = @ParentID
	OPTION(MAXRECURSION 1000)

	if @circular = 0
	begin
		UPDATE QCheck_Folders
		SET ParentFolder = @ParentID
		WHERE 
			ID = @FolderID
	end

	SET NOCOUNT OFF

END












































GO
/****** Object:  StoredProcedure [dbo].[QCheck_MoveItem]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE                       PROCEDURE [dbo].[QCheck_MoveItem]
	@ID int,
	@MoveTo int
 AS

BEGIN

	SET NOCOUNT ON
		
		DECLARE @NewSequenceNum int		
		DECLARE @OldSequenceNum int
		DECLARE @MinWithEmptyBefore int

		SELECT @OldSequenceNum = [SequenceNum]
		FROM QCheck_Items
		WHERE ID = @ID	
		
		SELECT @NewSequenceNum = [SequenceNum]
		FROM QCheck_Items
		WHERE ID = @MoveTo

		IF @OldSequenceNum < @NewSequenceNum  SET @NewSequenceNum = @NewSequenceNum + 1


		UPDATE QCheck_Items
		SET [SequenceNum] = [SequenceNum] + 1
		WHERE [SequenceNum] >= @NewSequenceNum
		AND EXISTS
		(
			SELECT ID FROM QCheck_Items 
			WHERE [SequenceNum] = @NewSequenceNum
		)
		AND IsDeleted = 0

		UPDATE QCheck_Items
		SET SequenceNum = @NewSequenceNum
		WHERE ID = @ID

		SELECT @MinWithEmptyBefore = MIN(A.SequenceNum)
		FROM QCheck_Items a
		WHERE NOT EXISTS
		(SELECT b.ID 
		FROM
		QCheck_Items b
		WHERE b.SequenceNum = a.SequenceNum - 1
		AND b.IsDeleted = 0)
		AND a.SequenceNum > 1
		AND a.IsDeleted = 0
		
		If IsNull(@MinWithEmptyBefore,0) > 1
		BEGIN
			UPDATE QCheck_Items
			SET [SequenceNum] = [SequenceNum] - 1
			WHERE [SequenceNum] >= @MinWithEmptyBefore
			AND IsDeleted = 0
		END
		

	SET NOCOUNT OFF

END






































GO
/****** Object:  StoredProcedure [dbo].[QCheck_MoveSuggestion]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                      PROCEDURE [dbo].[QCheck_MoveSuggestion]
	@SuggestionID int,
	@MoveTo int
 AS

BEGIN

	SET NOCOUNT ON
		
		DECLARE @NewDisplayOrder int		
		DECLARE @OldDisplayOrder int
		DECLARE @MinWithEmptyBefore int

		SELECT @OldDisplayOrder = [DisplayOrder]
		FROM QCheck_Suggestions
		WHERE SuggestionID = @SuggestionID	
		
		SELECT @NewDisplayOrder = [DisplayOrder]
		FROM QCheck_Suggestions
		WHERE SuggestionID = @MoveTo

		IF @OldDisplayOrder < @NewDisplayOrder  SET @NewDisplayOrder = @NewDisplayOrder + 1


		UPDATE QCheck_Suggestions
		SET [DisplayOrder] = [DisplayOrder] + 1
		WHERE [DisplayOrder] >= @NewDisplayOrder
		AND EXISTS
		(
			SELECT SuggestionID FROM QCheck_Suggestions 
			WHERE [DisplayOrder] = @NewDisplayOrder
		)
		AND IsDeleted = 0

		UPDATE QCheck_Suggestions
		SET DisplayOrder = @NewDisplayOrder
		WHERE SuggestionID = @SuggestionID

		SELECT @MinWithEmptyBefore = MIN(A.DisplayOrder)
		FROM QCheck_Suggestions a
		WHERE NOT EXISTS
		(SELECT b.SuggestionID 
		FROM
		QCheck_Suggestions b
		WHERE b.DisplayOrder = a.DisplayOrder - 1
		AND b.IsDeleted = 0)
		AND a.DisplayOrder > 1
		AND a.IsDeleted = 0
		
		If IsNull(@MinWithEmptyBefore,0) > 1
		BEGIN
			UPDATE QCheck_Suggestions
			SET [DisplayOrder] = [DisplayOrder] - 1
			WHERE [DisplayOrder] >= @MinWithEmptyBefore
			AND IsDeleted = 0
		END
		

	SET NOCOUNT OFF

END





































GO
/****** Object:  StoredProcedure [dbo].[QCheck_NagDueEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO









-- This stored procedure will email each user when a checklist goes overdue
-- currently runs every 30 minutes

CREATE                                PROCEDURE [dbo].[QCheck_NagDueEmail] AS

BEGIN
	SET NOCOUNT ON

	/*
	--only run on business days
	*/

	SET NOCOUNT OFF
END






































GO
/****** Object:  StoredProcedure [dbo].[QCheck_NagDueEmailCleanup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                            PROCEDURE [dbo].[QCheck_NagDueEmailCleanup] AS

BEGIN
	SET NOCOUNT ON
-- clean up
		UPDATE
			 QCheck_ActiveChecklists
		SET 
			HasNaggedDue = 1
		WHERE 
			HasNaggedDue = 2

	SET NOCOUNT OFF
END



































GO
/****** Object:  StoredProcedure [dbo].[QCheck_NagEmail_SingleUserChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







-- This stored procedure will email an individual user his/her checklists
-- called by QCheck_nagemail and nagdueemail only
-- copied logic from airQ


CREATE                             PROCEDURE [dbo].[QCheck_NagEmail_SingleUserChecklist]
	@login int,
	@activeChecklistID int,
	@subject varchar(600),
	@bcc varchar(200) = ''
	
AS

BEGIN
	SET NOCOUNT ON

	/*DECLARE @spname VARCHAR(500)
	e*/
	


	SET NOCOUNT OFF
END






















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_NagEmail_SingleUserQCheck_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- This stored procedure will build the html for an individual user's nagmails for checklists
-- called by QCheck_nagemail_singleuser only


CREATE                                       PROCEDURE [dbo].[QCheck_NagEmail_SingleUserQCheck_HTML]
	@login int,
	@activeChecklistID int,
	@AppURL varchar(50),
	@ImagesURL varchar(50)
	
AS

BEGIN
	SET NOCOUNT ON

	/*DECLARE @tmpBody VARCHAR(8000)*/

	SET NOCOUNT OFF
END

































































GO
/****** Object:  StoredProcedure [dbo].[QCheck_NameByLogin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_NameByLogin] (
	@Login VARCHAR(50)
) AS

BEGIN

	SELECT	
		G.[ID],
		G.[Name]
	FROM	
		QCheck_Users U
		INNER JOIN QCheck_Groups G
			ON G.Owner = U.[ID]
			AND G.SingleMemberGroup = 1
			AND G.[Name] = U.FullName
	WHERE
		U.ShortName = @Login

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_NATasksLastHourEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_NATasksLastHourEmail] (
--DECLARE
	@StartDate DATETIME = NULL
) AS

BEGIN

	declare @fromaddress varchar(100), @AppName varchar(100)
	select @fromaddress = fromaddress, @AppName = AppName from QCheck_AppSettings
	where id = 1


	--kc 2/3/17 - changed to last 24 hours
	--kc 9/19/19 - changed to last 7 days (168 hours) per GPR
	IF @StartDate IS NULL SET @StartDate = DATEADD(HOUR, -168, GETDATE())

	DECLARE @Tasks TABLE (
		ID INT IDENTITY(1,1),
		TaskName VARCHAR(500),
		Deadline DATETIME,
		CompletedDate DATETIME,
		CompletedBy VARCHAR(500),
		NAReason VARCHAR(500),
		ControllerEmail VARCHAR(500)
	)

	INSERT INTO @Tasks (
		TaskName,
		Deadline,
		CompletedDate,
		CompletedBy,
		NAReason,
		ControllerEmail
	)
		SELECT
			c.Name,
			ac.DueTime,
			ac.CompletedDate,
			au.FullName AS CompletedBy,
			ac.NAReason,
			cu.Email
		FROM
			QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
				ON ac.InstanceID = ci.ID
				AND ci.IsDeleted = 0
			INNER JOIN QCheck_Checklists c
				ON ci.ChecklistiD = c.ID
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Users au
				ON ac.CompletedBy = au.ID
			INNER JOIN QCheck_ChecklistManagers cm
				ON c.ID = cm.ChecklistID
				AND cm.IsDeleted = 0
			INNER JOIN QCheck_Groups g
				ON cm.ManagerGroupID = g.ID
			INNER JOIN QCheck_GroupMembership gm
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_Users cu
				ON gm.UserID = cu.ID
				AND cu.IsDeleted = 0
		WHERE
			IsNA = 1
			AND CompletedDate > @StartDate
			AND au.ID <> cu.ID -- Don't need to notify the person who completed the task

	DECLARE @ControllerEmails TABLE (
		ID INT IDENTITY(1,1),
		Email VARCHAR(500)
	)

	INSERT INTO @ControllerEmails (Email)
		SELECT DISTINCT ControllerEmail FROM @Tasks

	DECLARE @i INT,
			@count INT,
			@email VARCHAR(500),
			@MailSubject VARCHAR(500) = 'Tasks Marked N/A In The Last 7 Days',
			@MailBody VARCHAR(MAX)

	SET @i = 1
	SELECT @count = MAX(ID) FROM @ControllerEmails

	WHILE @i <= @count BEGIN
	
		SELECT @email = Email FROM @ControllerEmails WHERE ID = @i

		SET @MailBody = '<p>The following tasks you control have been marked N/A in the last 7 days:</p>'
		SET @MailBody = @MailBody + '<table border="1" cellpadding="5" cellspacing="0"><tr><th>Task</th><th>Deadline</th><th>N/A Date</th><th>Marked N/A By</th><th>Reason</th></tr>'

		SELECT @MailBody = @MailBody + '<tr><td>' + 
				ISNULL(TaskName, '&nbsp;') + '</td><td>' + 
				ISNULL(CONVERT(VARCHAR, Deadline, 101), '&nbsp;') + '</td><td>' + 
				ISNULL(CONVERT(VARCHAR(20), CompletedDate), '&nbsp;') + '</td><td>' + 
				ISNULL(CompletedBy, '&nbsp;') + '</td><td>' +
				ISNULL(NAReason, '&nbsp;') + '</td></tr>'
		FROM @Tasks
		WHERE ControllerEmail = @Email

		SET @MailBody = @MailBody + '</table>'
		SET @MailBody = @MailBody + '<p style="font-weight:bold">As a controller, you need to evaluate whether these tasks really should have been marked N/A instead of completing them.</p>' 

		--DEV only
		--SET @MailBody = '<p>'+@email+', '+@MailBody
		--SET @email = 'kshannon@acmewidget.com'

		EXEC dbo.xp_smtp_sendmail @From = @fromaddress, @Message = @MailBody, @To = @Email, @Subject = @MailSubject, @From_Name = @AppName

		SET @i = @i + 1

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_NoAssigneesEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_NoAssigneesEmail]
AS
BEGIN

	
	declare @html varchar(max) = ''
	declare @noassign table 
	(
		checklistid int,
		name varchar(100)
	)

	insert into @noassign
	select distinct c.id, u.fullname
	from 	
	qcheck_checklists c	
	inner join qcheck_checklistmanagers cm	
		on cm.checklistid = c.id
		and cm.isdeleted = 0
	inner join qcheck_groups g	
		on g.id = cm.managergroupid
	inner join qcheck_groupmembership gm	
		on gm.groupid = g.id
	inner join qcheck_users u	
		on u.id = gm.userid
		and u.shortname in ('tgermany', 'graynor')
	left outer join qcheck_checklistinstances ci	
		on ci.checklistid = c.id
		and ci.isdeleted = 0
	where len(dbo.[QCheck_AssigneesList](ci.id)) = 0
	and c.isdeleted = 0
	and c.template = 0

	delete @noassign
	from @noassign n
		inner join  qcheck_checklists c
			on n.checklistid = c.id
		inner join qcheck_checklistinstances ci
			on ci.checklistid = c.id
	where len(dbo.[QCheck_AssigneesList](ci.id)) > 0
	
	select @html = @html + '<h2>Tasks Controlled By Tim Germany</h2>'
	select @html = @html + '<p>' + c.name + '</p>'
	from @noassign n
	inner join qcheck_checklists c
		on n.checklistid = c.id
	where n.name = 'Tim Germany'
	order by c.name
	
	--select @html = @html + '<h2>Tasks Controlled By Mason Coker</h2>'
	--select @html = @html + '<p>' + c.name + '</p>'
	--from @noassign n
	--inner join qcheck_checklists c
	--	on n.checklistid = c.id
	--where n.name = 'Mason Coker'
	--order by c.name
	
	select @html = @html + '<h2>Tasks Controlled By Geoffrey Raynor</h2>'
	select @html = @html + '<p>' + c.name + '</p>'
	from @noassign n
	inner join qcheck_checklists c
		on n.checklistid = c.id
	where n.name = 'Geoffrey Raynor'
	order by c.name

	-- Get app configuration
	DECLARE @mailsubject VARCHAR(1000)
		,@FromAddress VARCHAR(100) = (SELECT TOP 1 'sqlmail@' + BaseDomain FROM QCheck_AppSettings)
	SELECT @mailsubject = appname + ' No Assignees'
	FROM QCheck_AppSettings WHERE ID = 1
	
	EXEC dbo.xp_smtp_sendmail 
			@from = @FromAddress, 
			@from_name = @mailsubject,
			@to = 'tgermany@acmewidget.com;graynor1@acmewidget.com;', 
			@subject = 'Tasks you control that are UNASSIGNED',
			@message = @html, 
			@type = 'text/html', 
			@server = 'SMTPGateway'
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_NonSingleGroupsWithMembers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_NonSingleGroupsWithMembers] AS

BEGIN

	SELECT 
		[Name],
		dbo.QCheck_GroupMemberList([ID]) AS Members
	FROM
		QCheck_Groups
	WHERE
		SingleMemberGroup = 0
	ORDER BY
		[Name]

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_NotifyControllerCreation]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_NotifyControllerCreation] (
	@ChecklistID INT
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @ChecklistOwner VARCHAR(500),
		@ChecklistName VARCHAR(500),
		@Email VARCHAR(100),
		@MailSubject VARCHAR(2000),
		@MailBody VARCHAR(5000),
		@OwnerEmail VARCHAR(500)

	-- Info about the checklist to use in the e-mail	
	SELECT 
		@ChecklistOwner = u.FullName,
		@ChecklistName = c.[Name],
		@OwnerEmail = u.Email
	FROM 
		QCheck_Checklists c
		INNER JOIN QCheck_Users u
			ON c.Owner = u.[ID]
	WHERE
		c.[ID] = @ChecklistID

	-- Subject line for the e-mail
	SET @MailSubject = ISNULL(@ChecklistOwner, '') + ' created task "' + ISNULL(@ChecklistName, '') + '"'

	-- Body of the e-mail
	SET @MailBody = 'You are a controller on this task.  This task is due:<br/><br/>'

	SELECT 
		@MailBody = @MailBody + ISNULL(dbo.QCheck_ScheduleString(ScheduleID), '') + '<br/>'
	FROM 
		QCheck_ChecklistInstances
	WHERE
		ChecklistID = @ChecklistID
		AND IsDeleted = 0
	
	-- Cursor to loop through controller e-mails
	DECLARE curs CURSOR FOR
		SELECT 
			u.Email
		FROM 
			QCheck_ChecklistManagers cm
			INNER JOIN QCheck_Groups g
				ON cm.ManagerGroupID = g.[ID]
			INNER JOIN QCheck_GroupMembership gm
				ON g.[ID] = gm.GroupID
			INNER JOIN QCheck_Users u
				ON gm.UserID = u.[ID]
			INNER JOIN QCheck_Checklists c
				ON cm.ChecklistID = c.[ID]
		WHERE 
			cm.ChecklistID = @ChecklistID
			AND cm.IsDeleted = 0
			-- Don't need to notify the creator, they know they made the task
			AND u.[ID] <> c.Owner 
	OPEN curs
	FETCH NEXT FROM curs INTO @Email
	WHILE @@FETCH_STATUS = 0 BEGIN

		EXEC dbo.xp_smtp_sendmail 
			@from = @OwnerEmail,
			@from_name = @ChecklistOwner,
			@to = @Email, 
			@subject = @MailSubject,
			@message = @MailBody,
			@type = 'text/html', 
			@server = @MailServer
		
		FETCH NEXT FROM curs INTO @Email
	END
	CLOSE curs
	DEALLOCATE curs

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_OldOverdueTasks_EMAIL]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_OldOverdueTasks_EMAIL] (
	@OverdueDays INT,
	@MailTo VARCHAR(5000)
) AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @SendEmail bit = 0
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	SELECT 
		@SendEmail = 1
	FROM
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON c.ID = ci.ChecklistID
			AND c.IsDeleted = 0
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = ci.ID
	WHERE
		ac.DueTime < DATEADD(DAY, @OverdueDays * -1, CONVERT(VARCHAR(10), GETDATE(), 101))
		AND ac.CompletedDate IS NULL
		AND LEN(dbo.QCheck_AssigneesList(ci.ID)) > 0
	   
		
	IF @SendEmail = 1 
	BEGIN

		DECLARE @MailSubject VARCHAR(5000)

		SET @MailSubject = @AppName + ' Report - Tasks More Than ' + CONVERT(VARCHAR(10), @OverdueDays) + ' Overdue'

		declare @html table (id int identity(1,1), html varchar(max))
		insert into @html exec QCheck_OldOverdueTasks_HTML @OverdueDays
		declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end

		exec [dbo].[xp_smtp_sendmail]
			@to = @MailTo,
			@from = @MailFrom,
			@subject = @MailSubject,
			@message = @htmlstr
	END
			
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_OldOverdueTasks_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_OldOverdueTasks_HTML] (
	@OverdueDays INT
) AS

BEGIN

	DECLARE @html_output TABLE (
		seq INT IDENTITY(1,1),
		row_html VARCHAR(max)
	)

	INSERT INTO @html_output (row_html) 
		SELECT '<html><head><style>TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;} .hide {display:none} TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style></head><body>'
		
	INSERT INTO @html_output (row_html)
		SELECT '<h2>Tasks More Than ' + CONVERT(VARCHAR(10), @OverdueDays) + ' Days Overdue</h2><table cellspacing=0 cellpadding=13><tr><th>Task</th><th>Due</th><th>Assigned To</th><th>Supervisors<span class="hide"><br></span></th></tr>'

	INSERT INTO @html_output (row_html)
		SELECT 
			'<tr>' +
			'<td>' + ISNULL(c.Name, '&nbsp;') + '</td>' +
			'<td>' + ISNULL(CONVERT(VARCHAR(10), ac.DueTime, 101), '&nbsp;') + '</td>' +
			'<td>' + ISNULL(dbo.QCheck_AssigneesList(ci.ID), '&nbsp;') + '</td>' +
			'<td>' + ISNULL(dbo.QCheck_ManagersList(c.ID), '&nbsp;') + '</td>' +
			'</tr>'
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON c.ID = ci.ChecklistID
				AND c.IsDeleted = 0
				AND ci.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists ac
				ON ac.InstanceID = ci.ID
		WHERE
			ac.DueTime < DATEADD(DAY, @OverdueDays * -1, CONVERT(VARCHAR(10), GETDATE(), 101))
			AND ac.CompletedDate IS NULL
			AND LEN(dbo.QCheck_AssigneesList(ci.ID)) > 0
			
		ORDER BY
			ISNULL(dbo.QCheck_ManagersList(c.ID), '&nbsp;'),
			ac.DueTime
			
	INSERT INTO @html_output (row_html)
		SELECT '</table></body></html>'
		
	SELECT row_html
	FROM @html_output
	ORDER BY seq
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_OutprocessDeleteAssignment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_OutprocessDeleteAssignment] (
	@AssignmentID INT
) AS

BEGIN

	DECLARE @ChecklistID INT,
			@InstanceID INT,
			@InstanceCount INT

	SELECT
		@ChecklistID = c.ID,
		@InstanceID = ci.ID
	FROM
		QCheck_Assignments a
		INNER JOIN QCheck_ChecklistInstances ci
			ON a.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
	WHERE
		a.ID = @AssignmentID

	SELECT
		@InstanceCount = COUNT(*)
	FROM
		QCheck_ChecklistInstances ci
	WHERE
		ci.ChecklistID = @ChecklistID
		AND ci.IsDeleted = 0

	IF @InstanceCount > 1 BEGIN

		UPDATE QCheck_ChecklistInstances
		SET IsDeleted = 1
		WHERE ID = @InstanceID

	END ELSE BEGIN

		UPDATE QCheck_Checklists
		SET IsDeleted = 1
		WHERE ID = @ChecklistID

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_OverdueControlledTasks_EMAIL]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_OverdueControlledTasks_EMAIL] AS

BEGIN

	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @today VARCHAR(20)
	DECLARE @sub VARCHAR(100)
	DECLARE @To_List VARCHAR(250)
	
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'

	DECLARE @work TABLE (
		seq INT IDENTITY(1,1),
		ControllerUserID INT
	)
	
	DECLARE @count INT,
			@i INT,
			@UserID INT,
			@TaskCount INT,
			@Now DATETIME
			
	SET @Now = GETDATE()
	
	INSERT INTO @work (ControllerUserID)
		SELECT ControllerUserID
		FROM QCheck_OverdueControlledTasksReport
		WHERE SendHour = DATEPART(HOUR, @Now)
		
	SET @i = 1
	SELECT @count = COUNT(*) FROM @work
	
	WHILE @i <= @count BEGIN
	
		SET @TaskCount = 0
	
		SELECT @UserID = ControllerUserID
		FROM @work
		WHERE seq = @i
		
		SELECT @to_list = Email
		FROM QCheck_Users
		WHERE [ID] = @UserID

		SET @sub = @AppName + ' - Overdue Controlled Tasks'
		
		SELECT @TaskCount = dbo.QCheck_OverdueControlledTasksCount(@UserID, @Now)
		
		IF @TaskCount > 0 BEGIN

			declare @html table (id int identity(1,1), html varchar(max))
			insert into @html exec QCheck_OverdueControlledTasks_HTML @UserID
			declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
			while exists (select 1 from @html)
			begin
				select top 1 @rowid = id from @html order by id asc
				select @onerow = html from @html where id = @rowid
				select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
				delete from @html where id = @rowid
			end

			exec [dbo].[xp_smtp_sendmail]
				@to = @to_list,
				@from = @MailFrom,
				@subject = @sub,
				@message = @htmlstr
				
		END
			
		SET @i = @i + 1
			
	END	

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_OverdueControlledTasks_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_OverdueControlledTasks_HTML] (
	@UserID VARCHAR(50)
) AS

BEGIN

	DECLARE @out TABLE (
		seq INT IDENTITY(1,1),
		html VARCHAR(5000)
	)

	INSERT INTO @out (html) VALUES ('<h1>Overdue Tasks You Control</h1>')

	INSERT INTO @out (html) VALUES ('<table cellpadding="2" cellspacing="0" width="100%" border="1">')
	INSERT INTO @out (html) VALUES ('<tr><td><b>Task</b></td><td><b>Due</b></td><td><b>Assigned To</b></td><td><b>Days Overdue</b></td></tr>')

	INSERT INTO @out (html)
		SELECT 
			'<tr>' +
			'<td>' + ISNULL(c.[Name], '&nbsp;') + '</td>' +
			'<td nowrap>' + ISNULL(CONVERT(VARCHAR(20), ac.DueTime), '&nbsp;') + '</td>' +
			'<td>' + ISNULL(dbo.QCheck_AssigneesList(ci.[ID]), '&nbsp;') + '</td>' +
			'<td>' + ISNULL(CONVERT(VARCHAR(10), DATEDIFF(DAY, ac.DueTime, GETDATE())), '&nbsp;') + '</td>' +
			'</tr>'
		FROM 
			QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances ci
				ON ac.InstanceID = ci.[ID]
			INNER JOIN QCheck_Checklists c
				ON ci.ChecklistID = c.[ID]
			INNER JOIN QCheck_ChecklistManagers cm
				ON cm.ChecklistID = ci.ChecklistID
			INNER JOIN QCheck_Groups g
				ON cm.ManagerGroupID = g.[ID]
			INNER JOIN QCheck_Users u
				ON g.[Owner] = u.[ID]
				AND g.SingleMemberGroup = 1
		WHERE
			ac.DueTime < GETDATE()
			AND ac.CompletedDate IS NULL
			AND u.[ID] = @UserID
			AND ci.IsDeleted = 0
			AND c.IsDeleted = 0
			AND cm.IsDeleted = 0
			AND u.IsDeleted = 0
		ORDER BY
			ac.DueTime

			
		INSERT INTO @out (html) VALUES ('</table>')

	SELECT html FROM @out ORDER BY seq
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_PollEmailQueue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck_PollEmailQueue] 
@UserID int,
@EmailMessage varchar(1000) OUTPUT

AS

DECLARE
	@emailID int,
	@emailTo varchar(1000),
	@emailFrom varchar(100),
	@emailReplyTo varchar(100),
	@emailSubject varchar(255),
	@hasComments bit,
	@delivered bit,
	@errored bit

SET @EmailMessage = ''

DECLARE Poll_CHK_CURS CURSOR FOR
SELECT EmailID, EmailTo, EmailFrom, EmailReplyTo, EmailSubject, HasComments, Delivered, Errored
FROM dbo.QCheck_QueuedEmails
WHERE Notified = 0
AND (Errored = 1 OR Delivered = 1 OR HasComments = 0)
AND UserID = @UserID

OPEN Poll_CHK_CURS
FETCH NEXT FROM Poll_CHK_CURS INTO @emailID, @emailTo, @emailFrom, @emailReplyTo, @emailSubject, @hasComments, @delivered, @errored
WHILE @@FETCH_STATUS = 0 
BEGIN
	IF @hasComments = 0
		SET @EmailMessage = @EmailMessage + ' No comments to send for ' + @emailSubject + ' report.<br>'

	IF @delivered = 1
		SET @EmailMessage = @EmailMessage + @emailSubject + ' comments sent.<br>'
	
	IF @errored = 1
		SET @EmailMessage = @EmailMessage + 'Error: ' + @emailSubject + ' comments were not sent - please resend.<br>'

	UPDATE dbo.QCheck_QueuedEmails
	SET Notified = 1
	WHERE EmailID = @EmailID

	FETCH NEXT FROM Poll_CHK_CURS INTO @emailID, @emailTo, @emailFrom, @emailReplyTo, @emailSubject, @hasComments, @delivered, @errored
END

CLOSE Poll_CHK_CURS
DEALLOCATE Poll_CHK_CURS
GO
/****** Object:  StoredProcedure [dbo].[QCheck_PopulateEmailsReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [dbo].[QCheck_PopulateEmailsReport] AS

BEGIN

	TRUNCATE TABLE QCheck_EmailsReport

	INSERT INTO QCheck_EmailsReport (FullName, Email, Subject, Sent)
	SELECT 
		U.FullName,
		M.EmailAddress,
		M.Subject,
		M.Sent
	FROM 
		QCheck_Emails M
		LEFT OUTER JOIN QCheck_Users U
			ON M.EmailAddress LIKE '%' + U.Email + '%'

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_PopulateUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                   PROCEDURE [dbo].[QCheck_PopulateUsers]
 AS

BEGIN

	SET NOCOUNT ON
	
	--update the logins by employeeID (specifically for interns)
	UPDATE qcheck_users
		SET shortname = tb.loginid
	FROM qcheck_users u
	INNER JOIN tblEmployees tb
	ON u.empID = tb.employeeid
	WHERE u.shortname <> tb.loginID
	and u.[Password] = 'Q' --Q "Password" identifies employees vs outside users.  We can make a former employee an outside user by changing this "password" field
	

	-- 9/15/2010 dalvarado - moved this up top.  In cases where a person has an active and an iactive record in
	-- the employee database, they would keep getting marked inactive.  This way, if they have an active record
	-- they finish as active in this SP.
	update
		QCheck_Users
	set isdeleted = 1
	WHERE
		SHORTNAME IN
	(SELECT LoginID from tblEmployees
	WHERE isActive=0)	
	and isdeleted = 0
	and [Password] = 'Q'

	-- 9/8/2010 dalvarado - moved this from above the first update to above the insert.  The way it was set up before,
	-- you would get duplicate users if somebody left the firm then came back.  It would insert a new user
	-- account for them, then re-enable their old one.
	update
		QCheck_Users
	set isdeleted = 0
	WHERE
		SHORTNAME IN
	(SELECT LoginID from tblEmployees
	WHERE isActive=1 and PCAccess = 1 and HireDate is not null and terminationdate is null)	
	and isdeleted = 1
	
	INSERT INTO
		QCheck_Users
	([ShortName], [FullName],[Email],[Password], empID)
	SELECT LoginID, Names, EMailAddress,'Q', employeeID
	FROM
	tblEmployees
	WHERE 
	  	(
			isActive = 1 
		or  --check for new hires in the last two weeks or new hires that have not been activated correctly that started in the last week
			(isnull(startdate, '1/1/1900') >  getdate() - 14  and isnull(startdate, '1/1/1900') < getdate() + 7)
		)
	 AND NOT 
	    Names like 'Guest%'
	 AND NOT EXISTS
	(SELECT [ID] FROM QCheck_Users
	WHERE ShortName = LoginID)	

	--email address changed
	
	update qcheck_users
	set email = e.emailaddress
	from qcheck_users u
	inner join tblEmployees e
	on u.shortname = e.loginid
	and u.email <> e.emailaddress
	and [Password] = 'Q'


	insert into QCheck_Groups
	(name, owner, singlemembergroup)
	select u.fullname, u.ID, 1
	FROM QCheck_Users u
	LEFT OUTER JOIN QCheck_Groups g
	on u.id = g.owner
	and g.singlemembergroup = 1
	where g.id is null
	and u.isdeleted = 0	

	insert into qcheck_groupmembership (userid, groupid)
	select distinct u.id, g.id
	from qcheck_users u
	inner join qcheck_groups g
	on u.id = g.owner
	and g.singlemembergroup = 1
	left outer join qcheck_groupmembership gm
	on u.id = gm.UserID
	and gm.groupid = g.id
	WHERE gm.id is null
	and u.isdeleted = 0

	exec QStatus_DefaultStatus_All
	exec QCheck_HandlePatternDefaults

	--if they dont have a supervisor - default it to have them supervise themselves
	insert into qstatus_supervisoroverride
	select id, id from qcheck_users
	where isdeleted = 0
	and id not in (select userid from QStatus_UserSupervisors)
	and id not in (select userid from qstatus_supervisoroverride)

	--remove the initial self supervising once they have a status report with a supervisor
	delete from qstatus_supervisoroverride 
	where userid = supervisorid --initially users are their own supervisor
	and userid not in ( --dont delete if this person is someone else's supervisor
		select supervisorid from 
		qstatus_supervisoroverride 
		where supervisorid <> userid
	)
	and userid not in (select gm.userid from qstatus_supervisors s--dont delete if this person is someone else's supervisor
				inner join qcheck_groups g
				on g.id = s.supervisorgroupid
				and s.interestedparty = 0
				inner join qcheck_groupmembership gm
				on gm.groupid = g.id)
	and userid in (--only delete if this person is setup with a supervisor on their status report
			SELECT U.[ID]
		FROM 
			QCheck_Users U
			INNER JOIN QStatus_Report R
				ON U.FullName = R.[Name]
			INNER JOIN QStatus_Supervisors S
				ON R.[ID] = S.ReportID
			INNER JOIN QCheck_Groups SG
				ON S.SupervisorGroupID = SG.[ID]
			INNER JOIN QCheck_Groups UG
				ON U.[ID] = UG.Owner
			INNER JOIN QCheck_Users SU
				ON SG.Owner = SU.[ID]
		WHERE
			U.IsDeleted = 0
			AND SU.IsDeleted = 0
			AND UG.SingleMemberGroup = 1
			AND S.DirectSupervisor = 1
			AND S.InterestedParty = 0
			AND R.IsDeleted = 0)

	SET NOCOUNT OFF

END






GO
/****** Object:  StoredProcedure [dbo].[QCheck_ProcessTempAssignmentNotifications]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[QCheck_ProcessTempAssignmentNotifications]
AS
BEGIN

SET NOCOUNT ON

	DECLARE @individualhtml varchar(max)
	DECLARE @email varchar(500)
	DECLARE @ID int
	DECLARE @singlehtml table
	(
		id int identity(1,1),
		html varchar(max)
	)
	DECLARE @AppName varchar(100)
	DECLARE @FromAddress varchar(100)

	select @AppName = AppName, @FromAddress= FromAddress from QCheck_AppSettings where id = 1

	DECLARE @subject varchar(1000) = @AppName + ' Temporary Assignment Notification For Assignees'
	DECLARE @header varchar(max) = '
	<html>
	<head>
	<style>
	table { 
		border-spacing: 0px; border-collapse:collapse;
	}
	th,  td { 
		padding: 5px;border: 1px solid black; 
	}
	</style>
	<body>
	<h2>The following tasks have been temporily assigned to you in '+@AppName+':</h2>
	<table><tr><th>Task</th><th>Employee Reassigning The Task</th><th>Assignee Removed</th><th>Temporary Assignee</th><th>Start Date</th><th>End Date</th></tr>
	'

	DECLARE @footer varchar(max) = '</table></body></html>'

	DECLARE @users table
	(
		ID int
	)

	INSERT INTO @users
	select 
		distinct u.ID
	from qcheck_assignmentstemporary t
		inner join qcheck_groups g
			on t.TempGroupID = g.ID
		inner join QCheck_GroupMembership gm
			on gm.GroupID = g.id
		inner join qcheck_users u
			on u.id = gm.userid
	where t.TempAssignmentEnd > getdate()
	and isnull(t.assigneesAlerted, 0) = 0
	and t.TempAssignmentStart <= dbo.Util_AddOfficeDays(getdate(), 1)

	DECLARE ASSIGNEECURS CURSOR FOR 
	SELECT ID FROM @Users


	OPEN ASSIGNEECURS

	FETCH NEXT FROM ASSIGNEECURS INTO @ID
	WHILE @@FETCH_STATUS = 0 BEGIN

		delete from @singlehtml

		insert into @singlehtml (html)
		select distinct '<tr><td>'+c.[name]+'</td><td>'+u2.[fullname]+'</td><td>'+g2.[name]+'</td><td>'+g.[name]+'</td><td>'+convert(varchar, t.TempAssignmentStart, 101)+'</td><td>'+convert(varchar, t.TempAssignmentEnd, 101)+'</td></tr>'
		from qcheck_assignmentstemporary t
			inner join qcheck_groups g
				on t.TempGroupID = g.ID
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
			inner join qcheck_users u
				on u.id = gm.userid
				and u.id = @ID
			inner join qcheck_checklistinstances ci
				on ci.id = t.InstanceID
			inner join qcheck_checklists c
				on c.id = ci.ChecklistID
			inner join QCheck_Assignments a
				on a.id = t.ReplacingID
			inner join qcheck_groups g2
				on g2.id = a.GroupID
			inner join qcheck_users u2
				on u2.id = t.createdby
		where t.TempAssignmentEnd > getdate()
		and isnull(t.assigneesAlerted, 0) = 0
		and t.TempAssignmentStart <= dbo.Util_AddOfficeDays(getdate(), 1)
		
		select @individualhtml = @header
		select @individualhtml = @individualhtml + html
		from @singlehtml
		order by id
		select @individualhtml = @individualhtml + @footer
		

		select @email = email from qcheck_users where id = @id

		--select @email = 'kcroft@acmewidget.com'

		exec dbo.xp_smtp_sendmail 
			@TO = @email, 
			@CC = '', 
			@FROM = @FromAddress, 
			@FROM_NAME = @AppName,
			@type = 'text/html', 
			@message = @individualhtml, 
			@subject = @subject


		FETCH NEXT FROM ASSIGNEECURS INTO @ID

	END

	CLOSE ASSIGNEECURS
	DEALLOCATE ASSIGNEECURS


	update qcheck_assignmentstemporary set assigneesAlerted = 1
		where id in
		(
			select 
				t.id
			from qcheck_assignmentstemporary t
			inner join qcheck_groups g
				on t.TempGroupID = g.ID
			inner join QCheck_GroupMembership gm
				on gm.GroupID = g.id
			inner join qcheck_users u
				on u.id = gm.userid
			where t.TempAssignmentEnd > getdate()
			and isnull(t.assigneesAlerted, 0) = 0
			and t.TempAssignmentStart <= dbo.Util_AddOfficeDays(getdate(), 1)
			and u.id in (select ID from @users)
		)





	SELECT @header = '
	<html>
	<head>
	<style>
	table { 
		border-spacing: 0px; border-collapse:collapse;
	}
	th,  td { 
		padding: 5px;border: 1px solid black; 
	}
	</style>
	<body>
	<h2>The following tasks, which you control, have been temporily assigned to another assignee in '+@AppName+'.  If you do not approve of this change, please ask the employee who reassigned the task to adjust it accordingly.</h2>
	<table><tr><th>Task</th><th>Employee Reassigning The Task</th><th>Assignee Removed</th><th>Temporary Assignee</th><th>Start Date</th><th>End Date</th></tr>
	'

	select @subject = @AppName + ' Temporary Assignment Notification For Controllers'

	delete from @users
	insert into @users
	select 
		distinct u.ID
	from qcheck_assignmentstemporary t
		inner join qcheck_checklistinstances ci
			on ci.id = t.InstanceID
		inner join qcheck_checklists c
			on c.id = ci.ChecklistID
		inner join QCheck_ChecklistManagers cm
			on cm.ChecklistID = c.id
			and cm.IsDeleted = 0
		inner join qcheck_groups g
			on g.id = cm.ManagerGroupID
		inner join QCheck_GroupMembership gm
			on gm.GroupID = g.id
		inner join qcheck_users u
			on u.id = gm.UserID
			and u.IsDeleted = 0
			and u.id <> t.CreatedBy
	where t.TempAssignmentEnd > getdate()
	and isnull(t.ControllersAlerted, 0) = 0
	and t.TempAssignmentStart <= dbo.Util_AddOfficeDays(getdate(), 1)

	
	DECLARE CONTROLLERCURS CURSOR FOR 
	select ID from @users


	OPEN CONTROLLERCURS

	FETCH NEXT FROM CONTROLLERCURS INTO @ID
	WHILE @@FETCH_STATUS = 0 BEGIN

		delete from @singlehtml

		insert into @singlehtml (html)
		select distinct '<tr><td>'+c.[name]+'</td><td>'+u2.[fullname]+'</td><td>'+g2.[name]+'</td><td>'+g.[name]+'</td><td>'+convert(varchar, t.TempAssignmentStart, 101)+'</td><td>'+convert(varchar, t.TempAssignmentEnd, 101)+'</td></tr>'
		from qcheck_assignmentstemporary t
			inner join qcheck_checklistinstances ci
				on ci.id = t.InstanceID
			inner join qcheck_checklists c
				on c.id = ci.ChecklistID
			inner join QCheck_ChecklistManagers cm
				on cm.ChecklistID = c.id
				and cm.IsDeleted = 0
			inner join qcheck_groups gman
				on gman.id = cm.ManagerGroupID
			inner join QCheck_GroupMembership gmMan
				on gmMan.GroupID = gman.id
			inner join qcheck_users uMan
				on uMan.id = gmMan.UserID
				and uMan.IsDeleted = 0
				and uMan.id <> t.CreatedBy
				and uMan.id = @ID
			inner join qcheck_groups g
				on t.TempGroupID = g.ID
			inner join QCheck_Assignments a
				on a.id = t.ReplacingID
			inner join qcheck_groups g2
				on g2.id = a.GroupID
			inner join qcheck_users u2
				on u2.id = t.createdby
		where t.TempAssignmentEnd > getdate()
			and isnull(t.ControllersAlerted, 0) = 0
			and t.TempAssignmentStart <= dbo.Util_AddOfficeDays(getdate(), 1)

		
		select @individualhtml = @header
		select @individualhtml = @individualhtml + html
		from @singlehtml
		order by id
		select @individualhtml = @individualhtml + @footer
		

		select @email = email from qcheck_users where id = @id

		exec dbo.xp_smtp_sendmail 
			@TO = @email, 
			@CC = '', 
			@FROM = @FromAddress, 
			@FROM_NAME = @AppName,
			@type = 'text/html', 
			@message = @individualhtml, 
			@subject = @subject

		FETCH NEXT FROM CONTROLLERCURS INTO @ID

	END

	CLOSE CONTROLLERCURS
	DEALLOCATE CONTROLLERCURS

	update qcheck_assignmentstemporary set ControllersAlerted = 1
		where id in
		(
			select 
				t.id
			from qcheck_assignmentstemporary t
				inner join qcheck_checklistinstances ci
					on ci.id = t.InstanceID
				inner join qcheck_checklists c
					on c.id = ci.ChecklistID
				inner join QCheck_ChecklistManagers cm
					on cm.ChecklistID = c.id
					and cm.IsDeleted = 0
				inner join qcheck_groups g
					on g.id = cm.ManagerGroupID
				inner join QCheck_GroupMembership gm
					on gm.GroupID = g.id
				inner join qcheck_users u
					on u.id = gm.UserID
					and u.IsDeleted = 0
					and u.id <> t.CreatedBy
			where t.TempAssignmentEnd > getdate()
			and isnull(t.ControllersAlerted, 0) = 0
			and t.TempAssignmentStart <= dbo.Util_AddOfficeDays(getdate(), 1)
			and u.id in (select ID from @users)
		)


SET NOCOUNT OFF


END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ProcessTempAssignments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[QCheck_ProcessTempAssignments] AS
BEGIN


	DECLARE @ID int
	

	
	--gather temp assignments that end
	DECLARE TEMPRemoveCurs CURSOR FOR 
		SELECT ID
		FROM QCheck_AssignmentsTemporary
		WHERE IsNull(TempAssignmentRemoved, 0) = 0
		AND IsNull(TempAssignmentApplied, 0) = 1
		AND TempAssignmentEnd <= GETDATE()
	
	
	OPEN TEMPRemoveCurs

	FETCH NEXT FROM TEMPRemoveCurs INTO @ID
	WHILE @@FETCH_STATUS = 0 BEGIN

		EXEC QCheck_ProcessTempAssignments_End @ID

		FETCH NEXT FROM TEMPRemoveCurs INTO @ID
	END

	CLOSE TEMPRemoveCurs
	DEALLOCATE TEMPRemoveCurs


	--gather any temporary assignments that need to start
	DECLARE TEMPCurs CURSOR FOR 
		SELECT DISTINCT t.ID
		FROM QCheck_AssignmentsTemporary t
			INNER JOIN QCheck_Assignments a
				on a.ID = t.ReplacingID
				and a.IsDeleted = 0
		WHERE IsNull(t.TempAssignmentApplied, 0) = 0
		AND t.TempAssignmentStart <= GETDATE()
		AND t.TempAssignmentEnd >= GETDATE()

	OPEN TEMPCurs

	FETCH NEXT FROM TEMPCurs INTO @ID
	WHILE @@FETCH_STATUS = 0 BEGIN
	
		EXEC QCheck_ProcessTempAssignments_Start @ID

		FETCH NEXT FROM TEMPCurs INTO @ID
	END

	CLOSE TEMPCurs
	DEALLOCATE TEMPCurs


	--refresh the names listed for each task
	exec QCheck_RefreshLookup

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ProcessTempAssignments_End]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_ProcessTempAssignments_End]
(
	@ID int
)
AS
BEGIN

	DECLARE @TempAssignmentsID int, @ReplacingID int, @InstanceID int

	SELECT @TempAssignmentsID = TempAssignmentsID, @ReplacingID = ReplacingID, @InstanceID = InstanceID
	FROM QCheck_AssignmentsTemporary
	WHERE ID = @ID

	--activate the old assignment
	UPDATE QCheck_Assignments
	SET IsDeleted = 0, DtAssigned = getdate()
	WHERE ID = @ReplacingID
		
	--add an active checklist for the old assignee 
	INSERT INTO QCheck_ActiveAssignments
	SELECT Distinct b.ID, @ReplacingID--a.ActiveChecklistID, @AssignmentsID
	FROM
		QCheck_ActiveChecklists b
	LEFT OUTER JOIN
		QCheck_ActiveAssignments newassign
	on
		newassign.AssignmentsID = @ReplacingID AND newassign.ActiveChecklistID = b.ID
	WHERE 
		newassign.ID is null
	AND
		b.InstanceID = @InstanceID
	AND
		b.CompletedDate is null

	--remove the temp
	UPDATE QCheck_Assignments
	SET IsDeleted = 1 
	WHERE ID = @TempAssignmentsID

	--update the master table to denote that this is done
	UPDATE QCheck_AssignmentsTemporary
		SET TempAssignmentRemoved = 1
	WHERE ID = @ID

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ProcessTempAssignments_Start]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[QCheck_ProcessTempAssignments_Start]
(
	@ID int
)
AS
BEGIN

	DECLARE  @InstanceID int, @GroupID int, @ReplacingID int, @TempAssignmentsID int

	SELECT @InstanceID = InstanceID, @GroupID = TempGroupID, @ReplacingID = ReplacingID
	FROM QCheck_AssignmentsTemporary
	WHERE ID = @ID

	--add the assignments record for the temporary group
	INSERT INTO QCheck_Assignments (InstanceID, GroupID, DtAssigned, IsDeleted)
	SELECT @InstanceID, @GroupID, GETDATE(), 0
	SELECT @TempAssignmentsID = SCOPE_IDENTITY()

	--add an active checklist for the temp assignee 
	INSERT INTO QCheck_ActiveAssignments
	SELECT Distinct b.ID, @TempAssignmentsID
	FROM
		QCheck_ActiveChecklists b
	LEFT OUTER JOIN
		QCheck_ActiveAssignments newassign
	ON
		newassign.AssignmentsID = @TempAssignmentsID AND newassign.ActiveChecklistID = b.ID
	WHERE 
		newassign.ID is null
	AND
		b.InstanceID = @InstanceID
	AND
		b.CompletedDate is null

	--remove the person who is beign temporarily replaced
	UPDATE QCheck_Assignments
	SET IsDeleted = 1
	WHERE ID = @ReplacingID

	--update the temporary assignments table to confirm this one is processed
	UPDATE QCheck_AssignmentsTemporary
		SET TempAssignmentApplied = 1, TempAssignmentsID = @TempAssignmentsID
	WHERE ID = @ID

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_PullArchivedComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck_PullArchivedComments] 
@ActiveChecklistID int

AS


SELECT     SPACE(TabIn * 10) + '[' + CONVERT(varchar, CommentDt, 101) + '] [' + Initials + '] ' + Comments AS Comment
FROM         QStatus_CommentArchive
WHERE     (ForeignKeyID = @ActiveChecklistID)
GO
/****** Object:  StoredProcedure [dbo].[QCheck_QuarterlyGroupsAudit]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_QuarterlyGroupsAudit]
as
begin
set nocount on
-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1
	
	declare @mailsubject varchar(1000)

	select @mailsubject = 'Quarterly Review Of ' +@Appname+ ' Groups'

	declare @email varchar(1000), @message varchar(5000)

	declare @groups table
		(
			groupname varchar(1000),
			email varchar(1000),
			groupmembers varchar(2000)
		)
		
	insert into @groups
	select g.name, u.email, dbo.[QCheck_GroupMemberList](g.id) 
	from qcheck_groups g
		inner join qcheck_users u
			 on g.owner = u.id
	where g.singlemembergroup = 0
	order by email

	DECLARE GROUPCURS CURSOR FOR 
			SELECT DISTINCT email
			FROM @groups

	OPEN GROUPCURS

	FETCH NEXT FROM GROUPCURS INTO @email
	WHILE @@FETCH_STATUS = 0 BEGIN

		select @message = 'Please review the following groups that you control in ' + @Appname + '.  It is expected that you review all group members listed below and remove anyone that should no longer be a member of the group.  '
		select @message = @message + 'When you need to make changes to your groups, you can add or remove group members on the groups page in ' + @Appname + '.  You can access your groups page at '+@ExternalURL+'/mygroups.aspx <br/><br/>'
		
		select @message = @message + groupname + ' --- ' + groupmembers + '<br/>'
		from @groups
		where email = @email
		order by groupname

		
		exec dbo.xp_smtp_sendmail 
			@from = @FromAddress, 
			@to = @email,
			@subject=@mailsubject,
			@message = @message
				

		FETCH NEXT FROM GROUPCURS INTO @email

	END

	CLOSE GROUPCURS
	DEALLOCATE GROUPCURS

set nocount off
end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_QuickDeadlineExtension]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_QuickDeadlineExtension] (
	@ActiveChecklistID INT,
	@NewDueTime DATETIME,
	@UserID INT,
	@Comment VARCHAR(1000) = ''
) AS

BEGIN

	DECLARE @IsController BIT = 0
	DECLARE @ControllerShortName VARCHAR(500)
			
	SELECT 
		@IsController = 1,
		@ControllerShortName = isnull(u.shortname, '')
	FROM
		QCheck_ActiveChecklists_All ac
		INNER JOIN QCheck_ChecklistInstances_All ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists_All c
			ON ci.ChecklistID = c.ID
		INNER JOIN QCheck_ChecklistManagers_WithTemp cm
			ON c.ID = cm.ChecklistID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.ID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
		LEFT OUTER JOIN QCheck_Users u
			on u.id = gm.UserID
	WHERE
		ac.ID = @ActiveChecklistID
		AND gm.UserID = @UserID
		
	IF @IsController = 1 BEGIN

		-- Just move it
		EXEC QCheck_UpdateDueDate @ActiveChecklistID, @NewDueTime, @ControllerShortName

	END ELSE BEGIN

		-- Create a deadline extension request
		EXEC QCheck_Approval_NewDeadline @ActiveChecklistID, @NewDueTime, @UserID, @Comment

	END
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReassignAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE       PROCEDURE [dbo].[QCheck_ReassignAlert](
	@ID int,
	@NewGroupID int
)	
 AS

	Update QCheck_Alerts
	Set AlerteeGroupID = @NewGroupID
	WHERE ID = @ID

	/*INSERT INTO QCheck_Alerts (InstanceID, DaysBefore, Alerttime, AlertType, AlertText, SentTime, IsDeleted, AlerteeGroupID)
	SELECT InstanceID, DaysBefore, Alerttime, AlertType, AlertText, SentTime, IsDeleted, @NewGroupID
	FROM QCheck_Alerts WHERE ID = @ID*/





GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReassignController]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

















CREATE          PROCEDURE [dbo].[QCheck_ReassignController](
	@ID int,
	@NewGroupID int
)	
 AS

	Update QCheck_ChecklistManagers
	SET ManagerGroupID = @NewGroupID
	WHERE ID = @ID

	/*INSERT INTO QCheck_ChecklistManagers (ManagerGroupID, ChecklistID, IsDeleted, CreateDate)
	SELECT @NewGroupID, ChecklistID, isDeleted, getdate()
	FROM QCheck_ChecklistManagers WHERE ID = @ID*/













GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReassignLink]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_ReassignLink] (
	@shortname varchar(100)
)
AS
	BEGIN
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1
	
	--users who need to be outprocessed
	select g.name, @AppURL + '/reassign.aspx?r='+
		convert(varchar(10), u.id) + '&q='+
		convert(varchar(10), u.id-5) + '&s='+
		convert(varchar(10), u.id+2) + '&t='+
		convert(varchar(10), u.id*2-4) as url,
		'exec Outprocessing ' + convert(varchar(10), u.id) 
	from qcheck_groups g
	inner join qcheck_groupmembership gm
	on gm.groupid = g.id
	and g.singlemembergroup = 1
	inner join qcheck_users u
	on u.id = gm.userid
	and u.shortname = @shortname
	order by 1
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReassignTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE        PROCEDURE [dbo].[QCheck_ReassignTask](
	@ID int,
	@GroupID int,
	@Status bit = 0
) AS

BEGIN

	DECLARE @ReassignFrom VARCHAR(500)
	
	-- Figure out who this task is coming from, we'll need it if we're adding
	-- the task to a status report
	SELECT 
		@ReassignFrom = g.Name
	FROM 
		QCheck_Assignments a
		INNER JOIN QCheck_Groups g
			ON a.GroupID = g.ID
	WHERE
		a.ID = @ID
		

	-- Reassign the task
	Update QCheck_Assignments
	Set GroupID = @GroupID
	WHERE ID = @ID

	/*INSERT INTO QCheck_Assignments (InstanceID, GroupID, DtAssigned, IsDeleted)
	SELECT InstanceID, @GroupID, getdate(), 0
	FROM QCheck_Assignments WHERE ID = @ID
	AND InstanceID not in (SELECT InstanceID from QCheck_Assignments where GroupID = @GroupID and isdeleted = 0)*/

	-- If the task is to be added to a status report of the new assignee
	IF @Status = 1 BEGIN
	
		DECLARE @ReportID INT,
				@TaskTypeID INT
		
		-- Get the new assignee's personal report
		SELECT 
			@ReportID = r.ID
		FROM 
			QStatus_Report r
			INNER JOIN QCheck_Groups g
				ON r.Name = g.Name
		WHERE
			g.ID = @GroupID		
		
		-- If the report exists (i.e. didn't get reassigned to a multi-user group)
		IF @ReportID IS NOT NULL BEGIN
		
			-- See if there is a section on the status report called "Reassigned from <old assignee>"
			SELECT @TaskTypeID = ID
			FROM QStatus_TaskTypes 
			WHERE [Description] = 'Reassigned From ' + @ReassignFrom AND ReportID = @ReportID
				
			-- If there's not, create it
			IF @TaskTypeID IS NULL BEGIN
			
				UPDATE QStatus_TaskTypes 
				SET DisplayOrder = DisplayOrder + 1
				WHERE ReportID = @ReportID
				AND DisplayOrder > 1
			
				INSERT INTO QStatus_TaskTypes (
					ReportID,
					Description,
					DisplayOrder,
					NativeType,
					IsDeleted
				) VALUES (
					@ReportID,
					'Reassigned From ' + @ReassignFrom,
					2,
					0,
					0
				)
				
				SET @TaskTypeID = @@IDENTITY
				
			-- If that section exists, make sure it's not deleted and move it to the top of the new
			-- assignee's status report
			END ELSE BEGIN
			
				UPDATE QStatus_TaskTypes
				SET 
					IsDeleted = 0,
					DisplayOrder = 2
				WHERE
					ID = @TaskTypeID
					
			END
			
			-- Put the task in the "Reassigned from" section on the new assignee's status report
			INSERT INTO QStatus_ActiveChecklistTaskType (
				ActiveChecklistID,
				TaskType,
				[Priority],
				CreateDt
			)			
				SELECT 
					ac.ID,
					@TaskTypeID,
					1,
					GETDATE()
				FROM
					QCheck_Assignments a
					INNER JOIN QCheck_ActiveAssignments aa
						ON a.ID = aa.AssignmentsID
					INNER JOIN QCheck_ActiveChecklists ac
						ON aa.ActiveChecklistID = ac.ID
					-- This is just to make sure we don't add this task to the status report if it's already there
					LEFT OUTER JOIN (
						SELECT
							actt.ActiveChecklistID
						FROM
							QStatus_ActiveChecklistTaskType actt
							INNER JOIN QStatus_TaskTypes tt
								ON actt.TaskType = tt.ID
								AND tt.IsDeleted = 0
							INNER JOIN QStatus_Report r
								ON tt.ReportID = r.ID
							INNER JOIN QCheck_ActiveAssignments aa
								ON actt.ActiveChecklistID = aa.ActiveChecklistID
						WHERE 
							aa.AssignmentsID = @ID
							AND r.ID = @ReportID
					) actt
						ON ac.ID = actt.ActiveChecklistID
				WHERE
					a.ID = @ID
					AND actt.ActiveChecklistID IS NULL
			
			-- Make sure it shows up on the new report
			UPDATE QStatus_Report
			SET IsDirty = 1
			WHERE ID = @ReportID
					
		END
	
	END
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_RefreshCachedReportsByReportId]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_RefreshCachedReportsByReportId]
	@ReportId int
AS
BEGIN

	UPDATE QStatus_Report
	SET IsDirty = 1
	WHERE [ID] = @ReportID

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_RefreshCachedReportsByTaskId]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_RefreshCachedReportsByTaskId]
	@TaskID int
AS
BEGIN

	--SET NOCOUNT ON;
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	declare @url varchar(300), @baseurl varchar(300)
	SET @baseurl = @AppURL + '/qprocess_ajax.aspx?action=RefreshReport&reportId='

	DECLARE @win int
	DECLARE @hr int 
	DECLARE @i int, @rowcount int
	
	DECLARE @reports TABLE
	(
		ID int IDENTITY(1,1),
		ReportID int
	)
	
	INSERT INTO @reports
	SELECT tt.ReportID
	FROM QStatus_TaskTypes tt INNER JOIN QStatus_ActiveChecklistTaskType actt ON tt.ID = actt.TaskType
	WHERE actt.ActiveChecklistID = @TaskID
	
	SELECT @rowcount = @@ROWCOUNT
	SELECT @i = 1
	--CREATE TABLE #text(html text NULL) 

	DECLARE @reportID int

	WHILE @i <= @rowcount
	BEGIN
		SELECT @reportID = ReportID
		FROM @reports
		WHERE ID = @i

		SELECT @url = @baseurl + CAST(@reportID as varchar)
		
		EXEC @hr=sp_OACreate 'MSXML2.ServerXMLHTTP',@win OUT 

		IF @hr <> 0 
		EXEC sp_OAGetErrorInfo @win 

		EXEC @hr=sp_OAMethod @win, 'Open',NULL,'GET',@url,'false'

		IF @hr <> 0 EXEC sp_OAGetErrorInfo @win 

		EXEC @hr=sp_OAMethod @win,'Send'
		IF @hr <> 0 EXEC sp_OAGetErrorInfo @win 

		/* comment out below to use @text variable for small data */
		--INSERT #text(html)
		--EXEC @hr=sp_OAGetProperty @win,'ResponseText'

		IF @hr <> 0 EXEC sp_OAGetErrorInfo @win

		EXEC @hr=sp_OADestroy @win 

		IF @hr <> 0 EXEC sp_OAGetErrorInfo @win

		--select * from #text
		--drop table #text

		SET @i = @i + 1

	END
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_RefreshInstanceLookup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    PROCEDURE [dbo].[QCheck_RefreshInstanceLookup]
	@InstanceID int
AS
BEGIN

SET NOCOUNT ON 

	delete from qcheck_assigneelookup
	where instanceid = @instanceID

	insert into qcheck_assigneelookup
		select @instanceID, dbo.QCheck_FullAssigneesList(@instanceID), dbo.[QCheck_AssigneeCountByInstance](@instanceID)

SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_RefreshLookup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE      PROCEDURE [dbo].[QCheck_RefreshLookup]
AS
BEGIN

SET NOCOUNT ON 



delete from qcheck_assigneelookup where instanceid not in (
	select distinct instanceid
	from qcheck_assignments
	where isdeleted = 0
	union
	select distinct instanceid
	from qcheck_assignmentarchive
	where isdeleted = 0
)

insert into qcheck_assigneelookup
select instanceid,  dbo.QCheck_FullAssigneesList(instanceID) as assignees, dbo.[QCheck_AssigneeCountByInstance](instanceID) as assigneecount
		from(
			select distinct instanceid
			from qcheck_assignments
			where isdeleted = 0
			union
			select distinct instanceid
			from qcheck_assignmentarchive
			where isdeleted = 0
			and archivedate > dateadd(day, -30, getdate())) allassignees
where instanceid not in (select instanceid from qcheck_assigneelookup)

update qcheck_assigneelookup
set assignees = b.assignees, assigneecount = dbo.[QCheck_AssigneeCountByInstance](b.instanceID)
from
	qcheck_assigneelookup a
	inner join (
		select instanceid,  dbo.QCheck_FullAssigneesList(instanceID) as assignees
		from(
			select distinct instanceid
			from qcheck_assignments
			where isdeleted = 0
			union
			select distinct instanceid
			from qcheck_assignmentarchive
			where isdeleted = 0
			and archivedate > dateadd(day, -30, getdate())) allassignees
	) b
	on a.instanceid = b.instanceid
	and a.assignees <> b.assignees

/*
--truncate table qcheck_assigneelookup
truncate table processed

declare a_curs cursor for 
	select distinct instanceid
	from qcheck_assignments
	where isdeleted = 0
	union
	select distinct instanceid
	from qcheck_assignmentarchive
	where isdeleted = 0

	declare @instanceID int
	OPEN a_curs
	
		FETCH NEXT FROM a_curs INTO @instanceID
		WHILE @@FETCH_STATUS = 0 BEGIN

			delete from qcheck_assigneelookup where instanceid = @instanceID
			
			insert into qcheck_assigneelookup
			select @instanceID, dbo.QCheck_FullAssigneesList(@instanceID)

			insert into processed select  @instanceID
			
			FETCH NEXT FROM a_curs INTO @instanceID
		END
		CLOSE a_curs
		DEALLOCATE a_curs
*/

SET NOCOUNT OFF
END



GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReminderTasksReport_EMAIL]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ReminderTasksReport_EMAIL] (
	@SupervisorUserID INT = NULL
) AS

SET NOCOUNT ON

-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50), @GPRUserID INT
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer, @GPRUserID = GPRUserID FROM QCheck_AppSettings WHERE ID = 1

DECLARE @to VARCHAR(100)
DECLARE @bcc VARCHAR(100)
DECLARE @from VARCHAR(100)
DECLARE @subject VARCHAR(255)
DECLARE @SUID INT
DECLARE @count INT

DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'

SET @bcc = ''

DECLARE CS CURSOR FOR 
	SELECT DISTINCT
		US.SupervisorUserID,
		U.Email
	FROM 
		QStatus_UserSupervisors US
		INNER JOIN QCheck_Users U
			ON US.SupervisorUserID = U.[ID]
	WHERE
		US.SupervisorUserID = ISNULL(@SupervisorUserID, US.SupervisorUserID)
		AND SupervisorUserID <> @GPRUserID -- GPR
OPEN CS
FETCH NEXT FROM CS INTO @SUID, @to
WHILE @@FETCH_STATUS = 0 BEGIN
	
	SELECT 
		@Count = COUNT(*)
	FROM
		QCheck_Checklists C
		INNER JOIN QCheck_ChecklistManagers CM
			ON C.[ID] = CM.ChecklistID
		INNER JOIN QCheck_ChecklistInstances CI
			ON C.[ID] = CI.ChecklistID
		INNER JOIN QCheck_Assignments A
			ON CI.[ID] = A.InstanceID
		INNER JOIN QCheck_ActiveAssignments AA
			ON A.[ID] = AA.AssignmentsID
		INNER JOIN QCheck_Groups CMG
			ON CMG.[ID] = CM.ManagerGroupID
		INNER JOIN QCheck_GroupMembership GM
			ON CMG.[ID] = GM.GroupID
		INNER JOIN QStatus_UserSupervisors US
			ON GM.[UserID] = US.UserID
		INNER JOIN QCheck_Users U
			ON US.UserID = U.[ID]
	WHERE
		C.IsDeleted = 0
		AND CM.IsDeleted = 0
		AND CI.IsDeleted = 0
		AND A.IsDeleted = 0
		AND US.SupervisorUserID = @SUID
		
	IF @Count > 0 BEGIN
	
		SET @from = @MailFrom
		SET @subject = @AppName + ' - Reminder Tasks Report'

		declare @html table (id int identity(1,1), html varchar(max))
		insert into @html exec QCheck_ReminderTasksReport_HTML @SUID
		declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
		while exists (select 1 from @html)
		begin
			select top 1 @rowid = id from @html order by id asc
			select @onerow = html from @html where id = @rowid
			select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
			delete from @html where id = @rowid
		end
			
		exec [dbo].[xp_smtp_sendmail]
				@to = @to,
				@bcc = @bcc,
				@from = @from,
				@subject = @subject,
				@message = @htmlstr

		
	END
	
	FETCH NEXT FROM CS INTO @SUID, @to
END
CLOSE CS
DEALLOCATE CS

SET NOCOUNT OFF

GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReminderTasksReport_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_ReminderTasksReport_HTML] (
	@SupervisorUserID INT
) AS

BEGIN

	DECLARE @Results TABLE (
		SupervisorUserID INT,
		ChecklistID INT,
		ManagerGroupID INT,
		ControllerGroup VARCHAR(50),
		ChecklistName VARCHAR(500),
		IsNew BIT
	)
	
	DECLARE @out TABLE (
		Seq INT IDENTITY(1,1),
		Row VARCHAR(5000)
	)
	
	-- Get all the checklists controlled by anyone the given supervisor supervises that have active
	-- assignments.
	INSERT INTO @Results (
		SupervisorUserID,
		ChecklistID,
		ManagerGroupID,
		ControllerGroup,
		ChecklistName
	)
		SELECT DISTINCT
			US.SupervisorUserID,
			C.[ID] As ChecklistID,
			CM.ManagerGroupID,
			CMG.[Name] AS ControllerGroup,
			C.[Name] As ChecklistName
		FROM
			QCheck_Checklists C
			INNER JOIN QCheck_ChecklistManagers CM
				ON C.[ID] = CM.ChecklistID
			INNER JOIN QCheck_ChecklistInstances CI
				ON C.[ID] = CI.ChecklistID
			INNER JOIN QCheck_Assignments A
				ON CI.[ID] = A.InstanceID
			INNER JOIN QCheck_ActiveAssignments AA
				ON A.[ID] = AA.AssignmentsID
			INNER JOIN QCheck_Groups CMG
				ON CMG.[ID] = CM.ManagerGroupID
			INNER JOIN QCheck_GroupMembership GM
				ON CMG.[ID] = GM.GroupID
			INNER JOIN QStatus_UserSupervisors US
				ON GM.[UserID] = US.UserID
			INNER JOIN QCheck_Users U
				ON US.UserID = U.[ID]
		WHERE
			C.IsDeleted = 0
			AND CM.IsDeleted = 0
			AND CI.IsDeleted = 0
			AND A.IsDeleted = 0
			AND US.SupervisorUserID = @SupervisorUserID
		ORDER BY
			CMG.[Name],
			C.[Name]
	
	
	-- Figure out which of the results are new
	UPDATE 
		@Results
	SET 
		IsNew = CASE
			WHEN RTR.SupervisorUserID IS NULL THEN 1
			ELSE 0
		END
	FROM 
		@Results R
		LEFT OUTER JOIN QCheck_ReminderTasksReport RTR
			ON R.SupervisorUserID = RTR.SupervisorUserID
			AND R.ChecklistID = RTR.ChecklistID
			AND R.ManagerGroupID = RTR.ManagerGroupID
	
	
	-- Create the HTML for the report e-mail
	INSERT INTO @out (row) VALUES ('<h1>Reminder Tasks</h1>')
	INSERT INTO @out (row) VALUES ('Items highlighted yellow are new since the last report.<br/><br/>')
	INSERT INTO @out (row) VALUES ('<style>.new { background-color: yellow; }</style>')
	INSERT INTO @out (row) VALUES ('<table border="1" cellpadding="3" cellspacing="0">')
	INSERT INTO @out (row)
		SELECT '<tr><td' + CASE WHEN IsNew = 1 THEN ' class="new"' ELSE '' END + '>' + ControllerGroup + '</td><td' + CASE WHEN IsNew = 1 THEN ' class="new"' ELSE '' END + '>' + ChecklistName + '</td></tr>'
		FROM @results
	INSERT INTO @out (row) VALUES ('</table>')
	
	
	-- Save off the results of this report so we know what's new next time
	DELETE FROM QCheck_ReminderTasksReport
	WHERE SupervisorUserID = @SupervisorUserID
	
	INSERT INTO QCheck_ReminderTasksReport (
		SupervisorUserID,
		ChecklistID,
		ManagerGroupID
	)
		SELECT
			SupervisorUserID,
			ChecklistID,
			ManagerGroupID
		FROM
			@Results
	
	-- Get the output
	SELECT Row FROM @Out ORDER BY Seq

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_RemoveFromReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE              PROCEDURE [dbo].[QCheck_RemoveFromReport](
	@ActiveChecklistID int,
	@ReportID int,
	@UserID int
)
 AS

BEGIN
	DECLARE @InstanceTaskTypeID int
	
	SELECT @InstanceTaskTypeID = itt.ID
	FROM QCheck_ActiveChecklists ac
	INNER JOIN QStatus_InstanceTaskType itt
	on itt.instanceid = ac.instanceid
	INNER JOIN QStatus_TaskTypes tt
	ON itt.TaskType = tt.ID
	AND tt.ReportID = @ReportID
	AND ac.ID = @activechecklistid

	IF @InstanceTaskTypeID is null
		SELECT @InstanceTaskTypeID = itt.ID
		FROM QCheck_ActiveChecklistArchive ac
		INNER JOIN QStatus_InstanceTaskType itt
		on itt.instanceid = ac.instanceid
		INNER JOIN QStatus_TaskTypes tt
		ON itt.TaskType = tt.ID
		AND tt.ReportID = @ReportID
		AND ac.ID = @activechecklistid

	IF @InstanceTaskTypeID is not null
		EXEC QCheck_DeleteInstanceTaskType @InstanceTaskTypeID, @UserID
END




























GO
/****** Object:  StoredProcedure [dbo].[QCheck_RenameFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE                                     PROCEDURE [dbo].[QCheck_RenameFolder](
	
	@FolderID int,
	@FolderName varchar(50)
)
 AS

BEGIN

	SET NOCOUNT ON
	

	UPDATE QCheck_Folders
	SET FolderName = @FolderName
	WHERE ID = @FolderID
	
	SET NOCOUNT OFF

END













































GO
/****** Object:  StoredProcedure [dbo].[QCheck_ReOpenChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                   PROCEDURE [dbo].[QCheck_ReOpenChecklist](
	@ActiveChecklistID INT
)
 AS
BEGIN
	SET NOCOUNT ON

	IF NOT EXISTS (SELECT ID FROM QCheck_ActiveChecklists WHERE [ID] = @ActiveChecklistID)
		exec dbo.QCheck_RestoreTask @ActiveChecklistID
	
	UPDATE
		QCheck_ActiveChecklists
		SET CompletedBy = null,
		CompletedDate = null
		WHERE [ID] = @ActiveChecklistID

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_RequestExtensionsForOverDueTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[QCheck_RequestExtensionsForOverDueTasks]
@userId int,
@comment varchar(max)
AS
 Create Table #DueTasks
 (
   seq int identity(1,1)
  ,ActiveCheckListId int
  ,DueTime datetime
  ,NewDueTime datetime
  ,ChecklistId int
  ,TaskName varchar(max)
  ,ControllerEmails varchar(max)
 )

 Declare @userEmail varchar(100),@fullName varchar(100)

 select @userEmail=Email,@fullName=FullName from QCheck_Users where ID=@userId


 Insert into #DueTasks(ActiveCheckListId,DueTime,NewDueTime,ChecklistId,TaskName,ControllerEmails)
 select  distinct a.[ID],a.DueTime,dateadd(HOUR, 2,a.DueTime),ccl.checklistid,f.Name,dbo.QCheck_ChecklistExtensionControllerEmails(ccl.checklistid, DEFAULT) as ControllerEmails
 FROM 
			QCheck_ActiveChecklists a
			INNER JOIN QCheck_ActiveAssignments b
				ON b.ActiveChecklistID = a.ID
			INNER JOIN QCheck_Assignments c
				ON b.AssignmentsID = c.ID
				AND c.IsDeleted = 0
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = c.GroupID
			INNER JOIN QCheck_Groups g
				ON g.ID = gm.GroupID
			INNER JOIN QCheck_ChecklistInstances e 
				ON a.InstanceID = e.ID and e.isDeleted = 0
			INNER JOIN QCheck_Checklists f
				ON e.ChecklistID = f.ID and f.isDeleted = 0
			INNER JOIN QCheck_Users u
				ON u.ID = gm.UserID
				AND len(u.Email) > 0
			LEFT OUTER JOIN QCheck_DontEmail do 
				ON u.ID = do.UserID
			LEFT OUTER JOIN QCheck_DailyOverdueBCC bcc
				ON u.ID = bcc.UserID
			 LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = f.id
			 LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on c.InstanceID=al.InstanceID
		WHERE
			-- dont email if this is set
			do.UserID is null
			--AND DueTime <= dateadd(HOUR, 3,getdate()) 
			And DueTime >GetDate()
			AND DueTime <= dateadd(HOUR, 2,getdate()) --need to change it to two hours here
			AND CompletedDate is null
			and U.ID=@userId

Declare @dueTasksCounter int=1;
Declare @dueTasksCount int=0;
select @dueTasksCount=count(*) from #DueTasks
	-- Get app configuration
DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1
while(@dueTasksCounter<=@dueTasksCount)
Begin
Declare @activeCheckListId int
Declare @newDueTime datetime
select @activeCheckListId=ActiveCheckListId,@newDueTime=NewDueTime from #DueTasks where seq=@dueTasksCounter




	DECLARE @ChangeID INT,
		--@FullName VARCHAR(50),
		--@TaskName VARCHAR(500),
	--	@CurrentDueTime DATETIME,
		
		@RequestorEmail VARCHAR(500),
		@MailFrom VARCHAR(500), 
		@MailCC VARCHAR(1000),
		@MailTo VARCHAR(5000), 
		--@MailSubject VARCHAR(1000),
		--@MailBody VARCHAR(5000),
		@AppPath VARCHAR(50),
		@ChecklistID INT
	
	-- Get the path 
	SELECT @AppPath = AppURL 
	FROM QCheck_AppSettings S
	INNER JOIN QCheck_Users U
		ON S.[ID] = U.App
	WHERE U.[ID] = @UserID

	DECLARE @IsController BIT = 0
	DECLARE @ControllerShortName VARCHAR(500)
			
	SELECT 
		@IsController = 1,
		@ControllerShortName = isnull(u.shortname, '')
	FROM
		QCheck_ActiveChecklists_All ac
		INNER JOIN QCheck_ChecklistInstances_All ci
			ON ac.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists_All c
			ON ci.ChecklistID = c.ID
		INNER JOIN QCheck_ChecklistManagers_WithTemp cm
			ON c.ID = cm.ChecklistID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.ID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
		LEFT OUTER JOIN QCheck_Users u
			on u.id = gm.UserID
	WHERE
		ac.ID = @ActiveChecklistID
		AND gm.UserID = @UserID
		
	IF @IsController = 1 BEGIN

		-- Just move it
		EXEC QCheck_UpdateDueDate @ActiveChecklistID, @NewDueTime, @ControllerShortName

	END 
	ELSE BEGIN

		-- Create a deadline extension request
	EXEC QCheck_Approval_NewChangeRequest @UserID, @Comment, @ChangeID OUTPUT

	
	-- Add the change to ActiveChecklists
	INSERT INTO QCheck_Approval_ActiveChecklists (
		ChangeRequestID,
		ActiveChecklistID,
		InstanceID,
		DueTime,
		OrigDueTime,
		ReminderDate,
		CompletedDate,
		HasNaggedDue,
		CompletedBy
	)
		SELECT 
			@ChangeID,
			[ID],
			InstanceID,
			@newDueTime,
			OrigDueTime,
			ReminderDate,
			CompletedDate,
			HasNaggedDue,
			CompletedBy
		FROM
			QCheck_ActiveChecklists
		WHERE
			[ID] = @ActiveChecklistID
     
	 Insert into QCheck_UniversalExtensionChangeRequests(ChangeRequestID,IsActive)
	 values(@ChangeID,1)

	-- Mark the change as ready for the supervisor
	UPDATE QCheck_Approval_ChangeRequests SET ReadyForSupervisor = 1 WHERE [ID] = @ChangeID



	END

	-- Create a new change request
	


set @dueTasksCounter=@dueTasksCounter+1
End


Create table #Controllers
(seq int identity(1,1)
,ControllerEmail varchar(max)
 
)

Insert into #Controllers(ControllerEmail)
SELECT 
		distinct u.Email
	FROM
		QCheck_ChecklistManagers cm
		INNER JOIN QCheck_Groups g
			ON cm.ManagerGroupID = g.[ID]
		INNER JOIN QCheck_GroupMembership gm
			ON g.[ID] = gm.GroupID
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.[ID]
	WHERE
		cm.ChecklistID in(select distinct ChecklistId from #DueTasks) and cm.IsDeleted=0 and u.Email not like '%'+@userEmail+'%'
		and u.id not in (select id from QCheck_ExtensionRequest_Exclude)

Declare @controllerCounter int=1;
Declare @controllerCount int=0;
select @controllerCount=count(*) from #Controllers

while(@controllerCounter<=@controllerCount)
Begin
declare @controllerEmail varchar(100)
select @controllerEmail=ControllerEmail from #Controllers where seq=@controllerCounter

IF OBJECT_ID('tempdb.dbo.#ControllerTasks', 'U') IS NOT NULL
  DROP TABLE #ControllerTasks

 Create Table #ControllerTasks
 (
   seq int identity(1,1)
  ,ActiveCheckListId int
  ,DueTime datetime
  ,NewDueTime datetime
  ,ChecklistId int
  ,TaskName varchar(max)
  ,ControllerEmails varchar(max)
 )
 Insert into #ControllerTasks(ActiveCheckListId,DueTime,NewDueTime,ChecklistId,TaskName,ControllerEmails)--getting the due tasks for which the current user is not a controller
 select ActiveCheckListId,DueTime,NewDueTime,CheckListId,TaskName,ControllerEmails from #DueTasks where ControllerEmails like '%'+@controllerEmail+'%'
 and ControllerEmails not like '%'+@userEmail+'%'
 Declare @mailSubject varchar(max)
 Declare @mailBody varchar(max)=''
 SET @MailSubject = 'Universal Extension request - ' + ISNULL(@FullName, '') 
 --SET @MailBody = '<table border="0">'

 Declare @controllerTasksCounter int=1;
 Declare @controllerTasksCount int=1;
 select @controllerTasksCount=count(*) from #ControllerTasks 
 Declare @changeIds varchar(max)
  set @changeIds=''
 while(@controllerTasksCounter<=@controllerTasksCount)
 Begin
 Declare @currentDueTime DateTime
 Declare @newDueTaskTime DateTime
 Declare @taskName varchar(max)
 --Declare @changeIds varchar(max)
 Declare @currentActiveChecklistId int

 select @currentDueTime=DueTime,@newDueTaskTime=NewDueTime,@taskName=TaskName,@currentActiveChecklistId=ActiveCheckListId from #ControllerTasks where seq=@controllerTasksCounter
 --set @newDueTaskTime=dateadd(HOUR, 2,@currentDueTime)
  SET @MailBody = @MailBody+'<table border="0">'
 SET @MailBody =@MailBody+ '<tr><td>Task Name: </td><td><b>' + ISNULL(CONVERT(VARCHAR(max), @taskName), '') + '</b></td></tr>' 
                         +'<tr><td>Current Due: </td><td><b>' + ISNULL(CONVERT(VARCHAR(20), @CurrentDueTime), '') +'</b></td></tr>'+
			              '<tr><td>Requested Due: </td><td><b>' + ISNULL(CONVERT(VARCHAR(20), @newDueTaskTime), '') + '</b></td></tr>' 
			
   set @mailBody=@mailBody+'</table>'
    set @mailBody=@mailBody+'<br><br>'

 -- set @changeIds=''
  SELECT 
		@changeIds = @changeIds + ISNULL(CONVERT(VARCHAR(max), ChangeRequestID) + ';', '')
	FROM
		QCheck_Approval_ActiveChecklists 
	WHERE
		ActiveChecklistID=@currentActiveChecklistId and DueTime=@newDueTaskTime

set @controllerTasksCounter=@controllerTasksCounter+1
 End
  SET @MailBody = @MailBody+'<table border="0">'
   SET @MailBody = @MailBody+'<tr><td>Comment: <b>' + ISNULL(@Comment, '') + '</b><br/><br/>' +
			'To approve this new due date, reply to this e-mail with "Y".  To reject the change, reply to this e-mail with "N".  The "Y" or "N" must be on the first line of the reply. </td></tr><br/><br/>' 
   set @mailBody=@mailBody+'</table>'

 -- --set @changeIds=''
 --SELECT 
	--	@changeIds = @changeIds + ISNULL(CONVERT(VARCHAR(max), ChangeRequestID) + ';', '')
	--FROM
	--	QCheck_Approval_ActiveChecklists 
	--WHERE
	--	ActiveChecklistID=@currentActiveChecklistId and DueTime=@newDueTaskTime

 set @mailBody=@mailBody+'<span style="color: white;">ChangeID:' + ISNULL(CONVERT(VARCHAR(max), @changeIds), '') + '|[UNIVERSALEXTENSION]</span>'
 --set @mailBody=@mailBody+'</table>'

 DECLARE @From_Address VARCHAR(100) = (SELECT TOP 1 'sqlmail@' + BaseDomain FROM QCheck_AppSettings)

 EXEC dbo.xp_smtp_sendmail 
--		@from = 'Sqlmail@acmewidget.com', 
		@from = @From_Address,
		@From_Name = @FullName,
		@replyto = @AutomationAddress,
		@to = @controllerEmail, 
		--@cc = @controllerEmail,
		@subject = @MailSubject,
		@message = @MailBody, 
		@type = 'text/html', 
		@server = @MailServer

set @controllerCounter=@controllerCounter+1
End


GO
/****** Object:  StoredProcedure [dbo].[QCheck_RestoreInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  PROCEDURE [dbo].[QCheck_RestoreInstance](
	@InstanceID int
) AS

BEGIN

	SET NOCOUNT ON
	

	IF @instanceID is not null
	BEGIN
		--restore instance
		set identity_insert qcheck_checklistinstances on
		insert into qcheck_checklistinstances 
			(id, name, checklistID, scheduleid, isdeleted, createdby)
		select id, name, checklistID, scheduleid, 0, createdby
		from qcheck_checklistinstancearchive
		where id = @instanceID
		set identity_insert qcheck_checklistinstances off

		delete from qcheck_checklistinstancearchive
		where id = @instanceID

		--restore alerts
		set identity_insert qcheck_alerts on
		insert into qcheck_alerts
			(id, instanceid, daysbefore, alerttime, alerttext, 
			alerttype, senttime, isdeleted, alerteeGroupID)
		select id, instanceid, daysbefore, alerttime, alerttext, 
			alerttype, senttime, isdeleted, alerteeGroupID
		from qcheck_alertarchive
		where instanceid = @instanceID and isdeleted = 0
		set identity_insert qcheck_alerts off

		delete from qcheck_alertarchive
		where instanceid = @instanceID and isdeleted = 0

		--restore assignments
		set identity_insert qcheck_assignments on
		insert into qcheck_assignments
			(id, instanceid, groupid, isdeleted)
		select 
			id, instanceid, groupid, isdeleted
		from 
		 	qcheck_assignmentarchive
		where instanceid = @instanceID and isdeleted = 0
		set identity_insert qcheck_assignments off

		delete from qcheck_assignmentarchive
		where instanceid = @instanceID and isdeleted = 0

		DECLARE @ScheduleID int
		SELECT @ScheduleID = ScheduleID 
		FROM qcheck_checklistinstances
		WHERE ID = @InstanceID
		
		IF @ScheduleID is not null
		BEGIN
			set identity_insert qcheck_schedule on
			insert into qcheck_schedule
				(id, firstduedate,lastduedate, freqtype,
				freqinterval, freqrecurrance, duetime,
				busdaybehavior, softdueoffsetdays)
			select 
				id, firstduedate, lastduedate, freqtype,
				freqinterval, freqrecurrance, duetime,
				busdaybehavior, softdueoffsetdays
			from 
			 	qcheck_schedulearchive
			where id = @ScheduleID
			set identity_insert qcheck_schedule off

			delete from qcheck_schedulearchive
			where  id = @ScheduleID

		END
	
		DECLARE @ChecklistID int
		SELECT @ChecklistID = ChecklistID
		FROM qcheck_checklistinstances
		WHERE ID = @InstanceID

		IF @ChecklistID is not null
		BEGIN
			set identity_insert qcheck_checklists on
			insert into qcheck_checklists
				(id, name, isdeleted, owner)
			select 
				id, name, 0, owner
			from 
			 	qcheck_checklistarchive
			where id = @ChecklistID
			set identity_insert qcheck_checklists off
	
			delete from qcheck_checklistarchive
			where  id = @ChecklistID

			set identity_insert qcheck_items on
			insert into qcheck_items
				(id, checklistid, sequencenum, itemtypeid,
				text, url, isdeleted)
			select 
				id, checklistid, sequencenum, itemtypeid,
				text, url, isdeleted
			from 
			 	qcheck_itemarchive
			where checklistid = @ChecklistID and isdeleted = 0
			set identity_insert qcheck_checklists off
	
			delete from qcheck_itemarchive
			where  checklistid = @ChecklistID and isdeleted = 0

		END
		
	END
	

	SET NOCOUNT OFF

END


















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_RestoreTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QCheck_RestoreTask](
	@ActiveChecklistID int,
	@reopen bit = 1
) AS

BEGIN

	SET NOCOUNT ON
	
	if @reopen = 1
	begin
		--restore active checklist
		set identity_insert qcheck_activechecklists on

		insert into qcheck_activechecklists (
			[id], 
			instanceid, 
			duetime, 
			origduetime,
			completeddate, 
			hasnaggeddue, 
			completedBy
		)
			select 
				[id], 
				instanceid,
				duetime, 
				origduetime, 
				completeddate, 
				hasnaggeddue, 
				completedBy 
			from 
				qcheck_activechecklistarchive 
			where 
				id = @ActiveChecklistID
				
		-- Active checklists get archived with a completed date filled in, if it wasn't actually completed, get rid of the completed date
		update qcheck_activechecklists
		set completeddate = null
		where id = @ActiveChecklistID AND CompletedBy IS NULL

		set identity_insert qcheck_activechecklists off
		
		delete from qcheck_activechecklistarchive
		where [id] = @ActiveChecklistID

		--restore activechecklisttasktype
		insert into qstatus_activechecklisttasktype (activechecklistid, tasktype, priority, createdt)
		select activechecklistid, tasktype, priority, createdt
		from  qstatus_activechecklisttasktypearchive
		where 
			activechecklistid = @ActiveChecklistID

		delete from qstatus_activechecklisttasktypearchive
		where 
			activechecklistid = @ActiveChecklistID
		
		--restore activeitems
		set identity_insert qcheck_activeitems on
		insert into qcheck_activeitems 
			(id, activechecklistid, checklistitemid, 
			text, completeddate, completedby )
		select 
			id, activechecklistid, checklistitemid, 
			text, completeddate, completedby 
		from qcheck_activeitemarchive
		where activechecklistid = @activechecklistid
		set identity_insert qcheck_activeitems off
		
		delete from qcheck_activeitemarchive
		where activechecklistid = @activechecklistid

		--restore activealerts
		
		set identity_insert QCheck_ActiveAlerts on
		insert into QCheck_ActiveAlerts 
			(id, alertid, activechecklistid, senttime )
		select 
			id, alertid, activechecklistid, senttime 
		from QCheck_ActiveAlertArchive
		where activechecklistid = @activechecklistid
		set identity_insert QCheck_ActiveAlerts off
		
		
		delete from QCheck_ActiveAlertArchive
		where activechecklistid = @activechecklistid


		--restore activeassignments
		set identity_insert qcheck_activeassignments on
		insert into qcheck_activeassignments 
			(id, activechecklistid, assignmentsID)
		select 
			id, activechecklistid, assignmentsID 
		from qcheck_activeassignmentarchive
		where activechecklistid = @activechecklistid
		set identity_insert qcheck_activeassignments off
		
		delete from qcheck_activeassignmentarchive 
		where activechecklistid = @activechecklistid

		
	end

	DECLARE @instanceID int
		
	SELECT @instanceID = InstanceID
	FROM QCheck_ActiveChecklists 
	WHERE ID = @activechecklistid
	
	if @instanceID is null and @reopen = 0
	begin
		SELECT @instanceID = InstanceID
		FROM QCheck_ActiveChecklistarchive
		WHERE ID = @activechecklistid
	end

	IF @instanceID is not null
	BEGIN
		--restore instance
		set identity_insert qcheck_checklistinstances on
		insert into qcheck_checklistinstances 
			(id, name, checklistID, scheduleid, isdeleted, createdby)
		select id, name, checklistID, scheduleid, 0, createdby
		from qcheck_checklistinstancearchive
		where id = @instanceID
		set identity_insert qcheck_checklistinstances off

		delete from qcheck_checklistinstancearchive
		where id = @instanceID

		--restore alerts
		set identity_insert qcheck_alerts on
		insert into qcheck_alerts
			(id, instanceid, daysbefore, alerttime, alerttext, 
			alerttype, senttime, isdeleted, alerteeGroupID)
		select id, instanceid, daysbefore, alerttime, alerttext, 
			alerttype, senttime, isdeleted, alerteeGroupID
		from qcheck_alertarchive
		where instanceid = @instanceID and isdeleted = 0
		set identity_insert qcheck_alerts off

		delete from qcheck_alertarchive
		where instanceid = @instanceID and isdeleted = 0

		--restore assignments
		set identity_insert qcheck_assignments on
		insert into qcheck_assignments
			(id, instanceid, groupid, isdeleted)
		select 
			id, instanceid, groupid, isdeleted
		from 
		 	qcheck_assignmentarchive
		where instanceid = @instanceID and isdeleted = 0
		set identity_insert qcheck_assignments off

		delete from qcheck_assignmentarchive
		where instanceid = @instanceID and isdeleted = 0

		DECLARE @ScheduleID int
		SELECT @ScheduleID = ScheduleID 
		FROM qcheck_checklistinstances
		WHERE ID = @InstanceID
		
		IF @ScheduleID is not null
		BEGIN
			set identity_insert qcheck_schedule on
			insert into qcheck_schedule
				(id, firstduedate,lastduedate, freqtype,
				freqinterval, freqrecurrance, duetime,
				busdaybehavior, softdueoffsetdays)
			select 
				id, firstduedate, lastduedate, freqtype,
				freqinterval, freqrecurrance, duetime,
				busdaybehavior, softdueoffsetdays
			from 
			 	qcheck_schedulearchive
			where id = @ScheduleID
			set identity_insert qcheck_schedule off

			delete from qcheck_schedulearchive
			where  id = @ScheduleID

		END
	
		DECLARE @ChecklistID int
		SELECT @ChecklistID = ChecklistID
		FROM qcheck_checklistinstances
		WHERE ID = @InstanceID

		IF @ChecklistID is not null
		BEGIN
			set identity_insert qcheck_checklists on
			insert into qcheck_checklists
				(id, name, isdeleted, owner)
			select 
				id, name, 0, owner
			from 
			 	qcheck_checklistarchive
			where id = @ChecklistID
			set identity_insert qcheck_checklists off
	
			delete from qcheck_checklistarchive
			where  id = @ChecklistID

			set identity_insert qcheck_items on
			insert into qcheck_items
				(id, checklistid, sequencenum, itemtypeid,
				text, url, isdeleted)
			select 
				id, checklistid, sequencenum, itemtypeid,
				text, url, isdeleted
			from 
			 	qcheck_itemarchive
			where checklistid = @ChecklistID and isdeleted = 0
			set identity_insert qcheck_checklists off
	
			delete from qcheck_itemarchive
			where  checklistid = @ChecklistID and isdeleted = 0

		END
		
	END
	
	exec QCheck_SetUpcomingInstance @InstanceID
	exec QCheck_ActivateFutureInstancesAfterDue
	

	SET NOCOUNT OFF

END

















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_RunChecklistNow]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	
CREATE PROCEDURE [dbo].[QCheck_RunChecklistNow] (
	@ChecklistID INT,
	@UserID INT,
	@ActiveChecklistID INT OUTPUT
) AS

BEGIN

	DECLARE @InstanceID INT,
			@DueDate DATETIME,
			@PrevFreqType INT,
			@RowsUpdated INT,
			@GroupID INT

	DECLARE @DueTime int

	SELECT @DueTime = duetime from QCheck_UserDefaultTimes
	WHERE UserID = @UserID

	IF @DueTime is null 
	BEGIN
		SELECT @DueTime = duetime from QCheck_UserDefaultTimes
		WHERE UserID = -1
	END
			
	SET @DueDate = CONVERT(VARCHAR(10), GETDATE(), 101) + ' ' + convert(varchar(2), @DueTime) + ':00:00'
	
	if @DueDate < getdate() select @DueDate = @DueDate + 1
	
	-- Get the single member group for the person running the checklist
	SELECT @GroupID = ID FROM QCheck_Groups WHERE [Owner] = @UserID AND SingleMemberGroup = 1

	-- Create a new instance
	EXEC QCheck_CreateInstance @InstanceID OUTPUT, @ChecklistID, '', @UserID, -1
	
	-- Assign the instance to the person running the checklist
	EXEC QCheck_AddAssignedTo @InstanceID, @GroupID, @UserID, 0

	-- Activate a one-time schedule, due today at 6pm.
	EXEC QCheck_UpdateSchedule_Part1 @InstanceID, @DueDate, NULL, 1, NULL, NULL, @DueTime, 0, @PrevFreqType OUTPUT, @RowsUpdated OUTPUT
	IF @RowsUpdated > 0 BEGIN
		EXEC QCheck_UpdateSchedule_Part2 @InstanceID, @PrevFreqType, 1
	END

	-- Finally, look up the newly created ActiveChecklistID to return to the caller, so it can open up the checklist.
	SELECT @ActiveChecklistID = ID FROM QCheck_ActiveChecklists WHERE InstanceID = @InstanceID
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_Sendmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_Sendmail]
--	@From NVARCHAR (4000) = 'sqlmail@dnr.acmewidget.com', 
	@From NVARCHAR (4000) = '',
	@Message NVARCHAR (MAX)='', 
	@To NVARCHAR (4000)='', 
	@Subject NVARCHAR (4000)='', 
	@Server NVARCHAR (4000)='', 
	@Type NVARCHAR (4000)='text/html', 
	@CC NVARCHAR (4000)='', 
	@BCC NVARCHAR (4000)='', 
	@Attachment NVARCHAR (4000)='', 
	@Attachment_Name NVARCHAR (4000)='',
	@MessageFile NVARCHAR (4000)='', 
	@From_Name NVARCHAR (4000)='',
	@replyto NVARCHAR (4000)=''
as
begin
	IF LEN(@From) = 0
		SET @From = (SELECT TOP 1 'sqlmail@dnr.' + BaseDomain FROM QCheck_AppSettings)

	declare @CommentsAddress varchar(50)

	select @CommentsAddress = lower(CommentsAddress) from QCheck_AppSettings

	-- we're using CC for this now
	if lower(@replyto) = @CommentsAddress
	begin
		select @cc = isnull(@replyto + ';', '') + @cc;
		select @replyto = ''
	end
	

	exec dbo.xp_smtp_sendmail
		@From = @From,
		@Message = @Message,
		@To = @To,
		@Subject = @Subject,
		@Server = @Server,
		@Type = @Type,
		@CC = @CC,
		@BCC = @BCC,
		@Attachment = @Attachment, 
		@Attachment_Name = @Attachment_Name,
		@MessageFile = @MessageFile,
		@From_Name = @From_Name,
		@replyto = @replyto

end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetAlertException]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[QCheck_SetAlertException](
	@ActiveAlertID INT = null,
	@UserID INT	
)
AS
BEGIN
	UPDATE [QCheck_AlertExceptions] SET
		IsActive = 1
	FROM QCheck_AlertExceptions ae
	WHERE ActiveAlertID = @ActiveAlertID
		AND UserID = @UserID		

	IF (@@ROWCOUNT = 0) --nothing was updated so no row exists; insert one
	INSERT INTO [QCheck_AlertExceptions] (
		ActiveAlertID,
		UserID,
		IsActive
	) VALUES (
		@ActiveAlertID,
		@UserID,
		1
	)	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetFirstReminderDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_SetFirstReminderDate] (
	@InstanceID INT,
	@ReminderDate DATETIME
) AS

BEGIN

	DECLARE @ActiveChecklistID INT,
			@SoftDueOffsetDays INT

	-- Get the first active checklist that has not been completed yet
	SELECT TOP 1 @ActiveChecklistID = [ID]
	FROM QCheck_ActiveChecklists
	WHERE InstanceID = @InstanceID
	AND CompletedDate IS NULL
	ORDER BY OrigDueTime
	
	SELECT @SoftDueOffsetDays = s.SoftDueOffsetDays
	FROM QCheck_Schedule s
	INNER JOIN QCheck_ChecklistInstances ci
			ON s.ID = ci.ScheduleID
	WHERE ci.ID = @InstanceID

	-- Update that checklist with the reminder date
	UPDATE QCheck_ActiveChecklists
	SET ReminderDate = CASE
		WHEN @SoftDueOffsetDays IS NOT NULL THEN DATEADD(DAY, @SoftDueOffsetDays * -1, DueTime)
		ELSE @ReminderDate
	END
	WHERE [ID] = @ActiveChecklistID
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetSoloController]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_SetSoloController] (
	@ActiveChecklistID int,
	@GroupID int)
AS 
BEGIN
	DECLARE @ChecklistID int
	
	SELECT @ChecklistID = c.id
	FROM QCheck_Checklists c
	INNER JOIN QCheck_ChecklistInstances ci
		ON c.ID = ci.ChecklistID
	INNER JOIN QCheck_ActiveChecklists ac
		ON ac.InstanceID = ci.ID
		AND AC.ID = @ActiveChecklistID
		
	IF @ChecklistID is not null
	BEGIN
		--delete any other controllers
		UPDATE QCheck_ChecklistManagers
		SET IsDeleted = 1
		WHERE ChecklistID = @ChecklistID
		AND IsDeleted = 0
		AND ManagerGroupID <> @GroupID
		
		--set the record to undeleted for this controller (it will also just update any active values to undeleted as well)
		UPDATE QCheck_ChecklistManagers
		SET IsDeleted  = 0
		WHERE ChecklistID = @ChecklistID
		AND ManagerGroupID = @GroupID
		
		--if this did not undelete, then we have to insert
		IF @@ROWCOUNT = 0
		BEGIN
			INSERT INTO QCheck_ChecklistManagers (ManagerGroupID, ChecklistID, IsDeleted)
			SELECT @GroupID, @ChecklistID, 0
		END
	END
END	

	
GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetUpcoming]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE           PROCEDURE [dbo].[QCheck_SetUpcoming] AS

BEGIN
	SET NOCOUNT ON

	DECLARE @ID int

	TRUNCATE TABLE QCheck_UpcomingDueTimes

	DECLARE SetUpcoming_CHK_CURS CURSOR FOR
		

		
		SELECT
			a.ID
		FROM
			QCheck_ChecklistInstances a with (nolock)
		INNER JOIN
			QCheck_Checklists b	 with (nolock)
		  ON
			a.ChecklistID = b.[ID]
		  AND
			b.IsDeleted = 0
		INNER JOIN qcheck_schedule s with (nolock)
			ON s.ID = a.ScheduleID
			AND s.freqType > 1
		WHERE
			a.IsDeleted = 0
		AND
			a.ScheduleID IS NOT NULL

		OPEN SetUpcoming_CHK_CURS
		FETCH NEXT FROM SetUpcoming_CHK_CURS INTO @ID
		WHILE @@FETCH_STATUS = 0 BEGIN
	
			EXEC QCheck_SetUpcomingInstance @ID
	
		FETCH NEXT FROM SetUpcoming_CHK_CURS INTO @ID
		END
		CLOSE SetUpcoming_CHK_CURS
		DEALLOCATE SetUpcoming_CHK_CURS

		
	SET NOCOUNT OFF
END
































GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetUpcoming_Additive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE           PROCEDURE [dbo].[QCheck_SetUpcoming_Additive] AS

BEGIN
	SET NOCOUNT ON

	DECLARE @ID int
	DECLARE @starttime datetime

	DECLARE Upcoming_CHK_CURS CURSOR FOR
		

		SELECT
			a.ID
		FROM
			QCheck_ChecklistInstances a with (nolock)
		INNER JOIN
			QCheck_Checklists b	 with (nolock)
		  ON
			a.ChecklistID = b.[ID]
		  AND
			b.IsDeleted = 0
		INNER JOIN qcheck_schedule s with (nolock)
			ON s.ID = a.ScheduleID
			AND s.freqType > 1
		WHERE
			a.IsDeleted = 0
		AND
			a.ScheduleID IS NOT NULL

		OPEN Upcoming_CHK_CURS
		FETCH NEXT FROM Upcoming_CHK_CURS INTO @ID
		WHILE @@FETCH_STATUS = 0 BEGIN
			set @starttime = getdate()
		
			EXEC QCheck_SetUpcomingInstance_Additive @ID
			
			insert into QCheck_SetUpcomingTiming 
				select @ID, @starttime, getdate()
	
		FETCH NEXT FROM Upcoming_CHK_CURS INTO @ID
		END
		CLOSE Upcoming_CHK_CURS
		DEALLOCATE Upcoming_CHK_CURS

		
	SET NOCOUNT OFF
END
































GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetUpcomingInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO





















CREATE                                        PROCEDURE [dbo].[QCheck_SetUpcomingInstance]
(
	@InstanceID int
)
AS

BEGIN
	SET NOCOUNT ON

	--print @InstanceID

	DECLARE @DueDate datetime
	DECLARE @RelativeDueDate datetime
	DECLARE @AsOfDate datetime
	DECLARE @EndDate datetime 
	DECLARE @iter int
	DECLARE @freqType int
	
	SET @EndDate = DATEADD(dd, 372, getdate())
	SET @iter = 0
	

	DELETE FROM QCheck_UpcomingDueTimes WHERE InstanceID = @InstanceID
	
	SELECT @AsOfDate =GetDate()

	--set to a saturday (scheduling based on saturdays)
	if datepart(dw, getdate()) < 7
		set @AsOfDate = @AsOfDate - datepart(dw, getdate())

	SELECT @freqType = freqType
	FROM QCheck_Schedule s with (nolock)
	INNER JOIN QCheck_ChecklistInstances ci with (nolock)
	ON ci.ScheduleID = s.ID
	AND ci.ID = @InstanceID

	IF @freqType > 1
	BEGIN
		
		DECLARE @existingupcoming TABLE
		(duetime DATETIME, relativeduetime DATETIME)
		DECLARE @existingac TABLE
		(duetime DATETIME, origduetime DATETIME)
		
		INSERT INTO @existingupcoming
		SELECT duetime, relativeduetime
		FROM QCheck_UpcomingDueTimes WITH (NOLOCK)
		WHERE InstanceID = @InstanceID
		
		INSERT INTO @existingac
		SELECT DueTime, OrigDueTime
		FROM QCheck_ActiveChecklists WITH (NOLOCK)
		WHERE InstanceID = @InstanceID
		
		INSERT INTO @existingac
		SELECT DueTime, OrigDueTime
		FROM QCheck_ActiveChecklistArchive WITH (NOLOCK)
		WHERE InstanceID = @InstanceID
		
		WHILE (@iter < 500)
		BEGIN
			EXEC [QCheck_CalculateNextDueTime]  @InstanceID, @AsofDate, @dueDate output, @RelativeDueDate output
	
			--If @DueDate is null BREAK
			IF @DueDate > @EndDate and @iter > 5 BREAK
			If @DueDate > getDate() 
			BEGIN
				INSERT INTO QCheck_UpcomingDueTimes
				SELECT @InstanceID, @dueDate, @RelativeDueDate
				WHERE 
				NOT EXISTS
				
				(
					SELECT 1 
					FROM @existingupcoming
					WHERE DueTime = @dueDate
					AND ISNULL(RelativeDueTime, getDate()) = ISNULL(@RelativeDueDate, getDate())
				)
				
				AND NOT EXISTS
				
				(
					SELECT 1 
					FROM @existingac
					WHERE 
						OrigDueTime = @dueDate
						OR DueTime = @dueDate
				)
				
				INSERT INTO @existingupcoming
				SELECT @dueDate, @RelativeDueDate
			END
			
			SET @AsOfDate = isnull(dateadd(hour, 23, isnull(@RelativeDueDate,@DueDate)), dateadd(day, 1, @AsOfDate))
			SET @iter = @iter + 1
			
		END

	END
	ELSE
	BEGIN
		EXEC [QCheck_CalculateNextDueTime]  @InstanceID, @AsofDate, @dueDate output, @RelativeDueDate output
		
		
		If @DueDate > getDate() 
			BEGIN
			INSERT INTO QCheck_UpcomingDueTimes
				SELECT @InstanceID, @dueDate, @RelativeDueDate
				WHERE NOT EXISTS
				(SELECT InstanceID FROM QCheck_UpcomingDueTimes with (nolock)
				WHERE InstanceID = @InstanceID
				AND DueTime = @dueDate
				AND ISNULL(RelativeDueTime, getDate()) = ISNULL(@RelativeDueDate, getDate())
				)
				AND NOT EXISTS
				(SELECT InstanceID FROM QCheck_ActiveChecklists with (nolock)
				WHERE InstanceID = @InstanceID)
			END
		

	END				
	
	SET NOCOUNT OFF
END










































GO
/****** Object:  StoredProcedure [dbo].[QCheck_SetUpcomingInstance_Additive]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                                        PROCEDURE [dbo].[QCheck_SetUpcomingInstance_Additive]
(
	@InstanceID int
)
AS

BEGIN
	SET NOCOUNT ON

	--print @InstanceID

	DECLARE @DueDate datetime
	DECLARE @RelativeDueDate datetime
	DECLARE @AsOfDate datetime
	DECLARE @EndDate datetime 
	DECLARE @iter int
	DECLARE @freqType int
	DECLARE @populatedprevious bit = 0
	DECLARE @lastDue datetime
	
	
	SET @EndDate = DATEADD(dd, 372, getdate())
	SET @iter = 0

	
	SELECT @AsOfDate = 
		CASE WHEN ISNULL(relativeduetime, 0) > duetime THEN
			 relativeduetime 
		ELSE 
			duetime 
		END
	FROM QCheck_UpcomingDueTimes  with (nolock)
	WHERE InstanceID = @InstanceID
	
	SELECT @iter = count(ID)
	FROM QCheck_UpcomingDueTimes with (nolock)
	WHERE InstanceID = @InstanceID
	
	IF @AsOfDate IS NULL SET @AsOfDate = getdate()

	--set to a saturday (scheduling based on saturdays)
	if datepart(dw, getdate()) < 7
		set @AsOfDate = @AsOfDate - datepart(dw, getdate())

	SELECT @freqType = freqType, @lastDue = isnull(lastDueDate, '1/1/9999')
	FROM QCheck_Schedule s with (nolock)
	INNER JOIN QCheck_ChecklistInstances ci with (nolock)
	ON ci.ScheduleID = s.ID
	AND ci.ID = @InstanceID

	IF @freqType > 1
	BEGIN
		
		DECLARE @existingupcoming TABLE
		(duetime DATETIME, relativeduetime DATETIME)
		DECLARE @existingac TABLE
		(duetime DATETIME, origduetime DATETIME)
		
		IF (@DueDate > @EndDate or @asofdate > @EndDate or @asofdate > @lastDue) and @iter > 5 RETURN
		
		WHILE (@iter < 500)
		BEGIN			
			EXEC [QCheck_CalculateNextDueTime]  @InstanceID, @AsofDate, @dueDate output, @RelativeDueDate output
	
			IF (@DueDate > @EndDate or @asofdate > @EndDate or @asofdate > @lastDue) and @iter > 5 BREAK
			If @DueDate > getDate() 
			BEGIN
			
				IF @populatedprevious = 0
				BEGIN
						INSERT INTO @existingupcoming
						SELECT duetime, relativeduetime
						FROM QCheck_UpcomingDueTimes WITH (NOLOCK)
						WHERE InstanceID = @InstanceID
						
						INSERT INTO @existingac
						SELECT DueTime, OrigDueTime
						FROM QCheck_ActiveChecklists WITH (NOLOCK)
						WHERE InstanceID = @InstanceID
						
						INSERT INTO @existingac
						SELECT DueTime, OrigDueTime
						FROM QCheck_ActiveChecklistArchive WITH (NOLOCK)
						WHERE InstanceID = @InstanceID
					SELECT @populatedprevious = 1
				END
			
				INSERT INTO QCheck_UpcomingDueTimes
				SELECT @InstanceID, @dueDate, @RelativeDueDate
				WHERE 
				NOT EXISTS
				
				(
					SELECT 1 
					FROM @existingupcoming
					WHERE DueTime = @dueDate
					AND ISNULL(RelativeDueTime, getDate()) = ISNULL(@RelativeDueDate, getDate())
				)
				
				AND NOT EXISTS
				
				(
					SELECT 1 
					FROM @existingac
					WHERE 
						OrigDueTime = @dueDate
						OR DueTime = @dueDate
				)
				
				INSERT INTO @existingupcoming
				SELECT @dueDate, @RelativeDueDate
			END
			
			SET @AsOfDate = isnull(dateadd(hour, 23, isnull(@RelativeDueDate,@DueDate)), dateadd(day, 1, @AsOfDate))
			SET @iter = @iter + 1
			
		END

	END
	ELSE
	BEGIN
		EXEC [QCheck_CalculateNextDueTime]  @InstanceID, @AsofDate, @dueDate output, @RelativeDueDate output
		
		
		If @DueDate > getDate() 
			BEGIN
			INSERT INTO QCheck_UpcomingDueTimes
				SELECT @InstanceID, @dueDate, @RelativeDueDate
				WHERE NOT EXISTS
				(SELECT InstanceID FROM QCheck_UpcomingDueTimes with (nolock)
				WHERE InstanceID = @InstanceID
				AND DueTime = @dueDate
				AND ISNULL(RelativeDueTime, getDate()) = ISNULL(@RelativeDueDate, getDate())
				)
				AND NOT EXISTS
				(SELECT InstanceID FROM QCheck_ActiveChecklists with (nolock)
				WHERE InstanceID = @InstanceID)
			END
		

	END				
	
	SET NOCOUNT OFF
END










































GO
/****** Object:  StoredProcedure [dbo].[QCheck_SlimGetUserChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QCheck_SlimGetUserChecklists](
	@UserID int,
	@activeChecklistID int = 0,
	@instanceID int = 0,
	@startDate datetime = null,
	@endDate datetime = null,
	@recurrance int = 0
) AS
BEGIN
	SET NOCOUNT ON
	
	-- get current checklists
	SELECT 
		c.ID as ChecklistID,
		c.Name as ChecklistName, 
		c.CreateDate,
		a.ID As Identifier, 
		a.ID as UniqueID, 
		a.dueTime, 
		0 as UpcomingID, 
		a.CompletedDate As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		isNull(a.CompletedDate,'12/12/9999') As Computed, 	
		1 As ChkType, 
		a.dueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetActiveChecklistControllers(a.ID) AS Controllers,
		--dbo.QStatus_GetChecklistReports(a.ID, @UserID) as StatusReportString
		isnull(ccl.controllers, '') as Controllers,
		isnull(trl.reportslist, '') as StatusReportString,
		isnull(al.assignees,'') as Assignees,
		case when ms.checklistid is null then 0 else 1 end as MultiStep,
		case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee,
		al.assigneecount,
		case when aac.ActiveChecklistID is null then 0 else 1 end as PendingChange, 
		aac.DueTime as NewDeadline,
		isnull(a.isna, 0) as isna, 
		isnull(a.nareason, '') as nareason
	INTO #result
	FROM
		QCheck_ActiveChecklists a 
		INNER JOIN QCheck_ChecklistInstances b ON a.InstanceID = b.ID AND b.IsDeleted = 0
		INNER JOIN QCheck_Schedule s ON b.ScheduleID = s.ID and Not (s.freqType = 1 and @recurrance = 2) and Not (s.freqType > 1 and @recurrance = 1)
		INNER JOIN QCheck_Checklists c on b.checklistID = c.ID AND c.IsDeleted = 0
		INNER JOIN QCheck_ActiveAssignments k on k.ActiveChecklistID = a.ID 
		INNER JOIN QCheck_GroupMembership gm on gm. UserID = @UserID
		INNER JOIN QCheck_Groups g on g.ID = gm.GroupID
		INNER JOIN QCheck_Assignments f on f.GroupID = gm.GroupID And f.IsDeleted = 0 and f.InstanceID = b.ID
		LEFT OUTER JOIN QStatus_TaskReportList trl on trl.activechecklistid = a.id and trl.userid = @UserID
	 LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on a.InstanceID=al.InstanceID
		LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
		LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
		--LEFT OUTER JOIN QCheck_PendingApprovals pa on pa.activechecklistid = a.id
		LEFT OUTER JOIN QCheck_MostRecentDeadlineRequests mrdr
				ON a.ID = mrdr.ActiveChecklistID
		LEFT OUTER JOIN QCheck_Approval_ChangeRequests cr
			ON cr.ID = mrdr.ChangeRequestID
		LEFT OUTER JOIN QCheck_Approval_ActiveChecklists aac
				ON aac.ChangeRequestID = CR.[ID]
				AND aac.ActiveChecklistID = mrdr.ActiveChecklistID
	 WHERE
		-- 3/30/2016 dalvarado - removing this filter so you can see past completed items
		--(a.CompletedDate is null or (DatePart(month,a.CompletedDate) = DatePart(month,getDate()) and DatePart(day,a.CompletedDate) = DatePart(day,getDate()) and DatePart(year,a.CompletedDate) = DatePart(year,getDate()))) AND 
		(@activeChecklistID = 0 or a.ID = @activeChecklistID)
		AND @instanceID = 0
		AND a.dueTime between @startDate and @endDate

	UNION 
	
	-- get future checklists
	SELECT 
		c.ID As ChecklistID,
		c.Name as ChecklistName, 
		c.CreateDate,
		b.ID As Identifier,
		upcoming1.ID as UniqueID, 
		upcoming1.DueTime as dueTime, 
		upcoming1.ID as UpcomingID,
		null As ActiveChkCompletedDate, 
		--f.ID as AssignmentID, 
		'12/12/9999' As Computed, 	
		2 As ChkType, 
		upcoming1.DueTime as dueSort,
		CASE WHEN s.freqType > 1 THEN 1 ELSE 0 END as Recurring,
		CASE WHEN s.freqType = 1 THEN 'One Time' 
			 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
			 WHEN s.freqType = 3 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Weekly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
			 WHEN s.freqType = 4 and s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every' + CONVERT(varchar,s.freqRecurrance) + ' months' END
			 WHEN s.freqType = 4 and s.freqRecurrance = 3 THEN 'Quarterly' 
 			 WHEN s.freqType = 5 THEN 
					CASE WHEN s.freqRecurrance = 1 THEN 
							'Yearly' 
					ELSE 
							'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years' 
					END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
			ELSE '' END as ScheduleString,
		--dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers,
		isnull(ccl.controllers, '') as Controllers,
		'' as StatusReportString,
		isnull(al.assignees,'') as Assignees,
		case when ms.checklistid is null then 0 else 1 end as MultiStep,
		case when cai.id is null then 0 else 1 end as ControllerPartOfAssignee,
		AL.assigneecount,
		0 as PendingChange, 
		null as NewDeadline,
		0 as isna, 
		'' as nareason
	FROM
		QCheck_ChecklistInstances b
		INNER JOIN QCheck_UpcomingDueTimes upcoming1
			ON b.ID = upcoming1.instanceID
			and upcoming1.DueTime between @StartDate and @EndDate
		INNER JOIN QCheck_Schedule s 
			ON b.ScheduleID = s.ID 
			and Not (s.freqType = 1 and @recurrance = 2) 
			and Not (s.freqType > 1 and @recurrance = 1)
		INNER JOIN QCheck_Checklists c 
			on b.checklistID = c.ID 
			AND c.IsDeleted = 0
		INNER JOIN QCheck_GroupMembership gm 
			on gm. UserID = @UserID
		INNER JOIN QCheck_Groups g
			on g.ID = gm.GroupID
		INNER JOIN QCheck_Assignments f 
			on f.GroupID = gm.GroupID
			And f.IsDeleted = 0 
			and f.InstanceID = b.ID
		LEFT OUTER JOIN QCheck_ActiveChecklists ac
			ON ac.InstanceID = upcoming1.InstanceID
			AND ac.OrigDueTime = upcoming1.DueTime
		LEFT OUTER JOIN QCheck_ChecklistControllersList ccl on ccl.checklistid = c.id
		LEFT OUTER JOIN	dbo.QCheck_AssigneeLookup AL on b.ID=al.InstanceID
		LEFT OUTER JOIN QCheck_MultiStep ms on ms.checklistid = c.ID
		LEFT OUTER JOIN QCheck_ControllerAssigneeInstances cai on cai.id = b.id
	WHERE 
		not b.isDeleted = 1 
		AND (@instanceID = 0 or b.ID = @instanceID)
		AND @activeChecklistID = 0
		AND ac.ID is null
		AND @recurrance < 3
		
	ORDER BY --ChkType,
		Computed desc,
		dueSort,
		ChecklistName,
		Identifier

	DECLARE @recordIds AS RecordId
	INSERT INTO @recordIds
		SELECT DISTINCT ChecklistId
		FROM #result
		WHERE ChecklistId IS NOT NULL
	EXEC dbo.Audit_Set @userId, @recordIds, 'Checklist', 2

	-- return result
	SELECT * FROM #result
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_StopChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[QCheck_StopChecklist](
	@ID INT,
	@UserID int
)
 AS

BEGIN

	SET NOCOUNT ON

		DECLARE @instanceid int
		SELECT @instanceid = ci.ID 
			FROM QCheck_ChecklistInstances ci
			INNER JOIN QCheck_ActiveChecklists ac
				on ac.Instanceid = ci.id
				and ac.ID = @ID

		
		INSERT INTO QCheck_InstanceStops (
				instanceid,
				stoppedby,
				stoppedDt
		)
		SELECT @instanceid, @UserID, getdate()

		UPDATE QCHECK_Schedule
			set lastDueDate = cast(getdate() as date)
		FROM QCHECK_Schedule s
			INNER JOIN QCheck_ChecklistInstances ci
				on ci.scheduleid = s.id
				AND ci.id = @instanceid

		DELETE FROM [QCheck_UpcomingDueTimes]
			WHERE instanceid = @instanceid

	SET NOCOUNT OFF

END



















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_TasksControlledByGroup]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QCheck_TasksControlledByGroup] (
	@GroupID INT,
	@Login VARCHAR(50) = NULL,
	@NewOnly BIT = 0,
	@IncompleteOnly BIT = 0
) AS

BEGIN

	SET NOCOUNT ON

	DECLARE @SupervisorUserID INT

	SELECT @SupervisorUserID = [ID]
	FROM QCheck_Users
	WHERE ShortName = @Login

	DECLARE	@work TABLE (
		Seq INT IDENTITY(1,1),
		ChecklistID INT,
		ChecklistName VARCHAR(500),
		Controllers VARCHAR(1000),
		Assignees VARCHAR(1000),
		IsDeleted BIT
	)

	INSERT INTO @work (
		ChecklistID,
		ChecklistName,
		Controllers,
		Assignees,
		IsDeleted
	)

		-- Tasks controlled by the given group
		SELECT DISTINCT
			c.[ID] As ChecklistID,
			c.[Name] As ChecklistName,
			dbo.QStatus_GetChecklistControllers(c.[ID]) AS Controllers,
			dbo.QCheck_GetChecklistAssignees(c.[ID]) AS Assignees,
			c.IsDeleted AS ChecklistDeleted
		FROM
			QCheck_ChecklistManagers cm
			INNER JOIN QCheck_Checklists c
				ON cm.ChecklistID = c.[ID]
			LEFT OUTER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
			LEFT OUTER JOIN QCheck_ActiveChecklists ac
				ON ac.InstanceID = ci.ID
		WHERE
			cm.ManagerGroupID = @GroupID
			AND cm.IsDeleted = 0
			AND c.IsDeleted = 0
			AND (@IncompleteOnly = 0 OR (ac.ID IS NOT NULL AND ac.CompletedDate IS NULL))
			
		UNION
		
		-- If the given group is a user's single member group, pull tasks that user controls
		-- through any group.
		SELECT
			c.[ID] As ChecklistID,
			c.[Name] As ChecklistName,
			dbo.QStatus_GetChecklistControllers(c.[ID]) AS Controllers,
			dbo.QCheck_GetChecklistAssignees(c.[ID]) AS Assignees,
			c.IsDeleted AS ChecklistDeleted
		FROM
			QCheck_Groups g
			INNER JOIN QCheck_Users u
				ON g.Owner = u.[ID]
			INNER JOIN QCheck_GroupMembership gm
				ON u.[ID] = gm.UserID
				and gm.groupid = g.[id]
			INNER JOIN QCheck_ChecklistManagers cm
				ON gm.GroupID = cm.ManagerGroupID
			INNER JOIN QCheck_Checklists c
				ON cm.ChecklistID = c.[ID]
			LEFT OUTER JOIN QCheck_ChecklistInstances ci
				ON ci.ChecklistID = c.ID
			LEFT OUTER JOIN QCheck_ActiveChecklists ac
				ON ac.InstanceID = ci.ID
		WHERE
			g.[ID] = @GroupID
			AND g.SingleMemberGroup = 1
			AND cm.IsDeleted = 0
			AND c.IsDeleted = 0
			AND (@IncompleteOnly = 0 OR (ac.ID IS NOT NULL AND ac.CompletedDate IS NULL))

	-- Save off the results
	IF @SupervisorUserID IS NOT NULL BEGIN

		INSERT INTO QCheck_Reassign_History (
			ChecklistID,
			UserID,
			Controllers
		)
			SELECT w.ChecklistID, @SupervisorUserID, w.Controllers
			FROM 
				@work w
				LEFT OUTER JOIN QCheck_Reassign_History h
					ON w.ChecklistID = h.ChecklistID
					AND h.UserID = @SupervisorUserID
					AND w.Controllers = h.Controllers
			WHERE
				h.[ID] IS NULL
		

	END

	-- Get the output
	SELECT 
		w.ChecklistID,
		w.ChecklistName,
		w.Controllers,
		w.Assignees,
		w.IsDeleted,
		CASE
			WHEN H.[ID] IS NOT NULL THEN 0
			ELSE 1
		END AS IsNew
	FROM
		@work w
		LEFT OUTER JOIN QCheck_Reassign_History h
			ON w.ChecklistID = h.ChecklistID
			AND h.UserID = @SupervisorUserID
			AND w.Controllers = h.Controllers
			AND h.ViewDate < DATEADD(DAY, -7, GETDATE())
	WHERE
		(@NewOnly = 1 AND H.[ID] IS NULL)
		OR @NewOnly = 0
	SET NOCOUNT OFF

END


GO
/****** Object:  StoredProcedure [dbo].[QCheck_TasksNotControlled_Email]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_TasksNotControlled_Email] (
	@MailTo VARCHAR(5000),
	@MailBCC VARCHAR(5000),
	@MailFrom VARCHAR(5000),
	@MailSubject VARCHAR(5000),
	@Supervisor VARCHAR(50),
	@Employee VARCHAR(50)
) AS

BEGIN

	declare @html table (id int identity(1,1), html varchar(max))
	insert into @html exec QCheck_TasksNotControlled_HTML @Supervisor,  @Employee
	declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
	while exists (select 1 from @html)
	begin
		select top 1 @rowid = id from @html order by id asc
		select @onerow = html from @html where id = @rowid
		select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
		delete from @html where id = @rowid
	end

	exec [dbo].[xp_smtp_sendmail]
			@to = @MailTo,
			@bcc = @MailBCC,
			@from = @MailFrom,
			@subject = @MailSubject,
			@message = @htmlstr


END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_TasksNotControlled_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_TasksNotControlled_HTML] (
	@Supervisor VARCHAR(50),
	@Employee VARCHAR(50)
) AS

BEGIN

	DECLARE @now DATETIME = GETDATE(),
			@SupervisorName VARCHAR(100),
			@EmployeeName VARCHAR(100)

	DECLARE @out TABLE (
		seq INT IDENTITY(1,1),
		html VARCHAR(MAX)
	)

	SELECT @SupervisorName = FullName FROM QCheck_Users WHERE ShortName = @Supervisor
	SELECT @EmployeeName = FullName FROM QCheck_Users WHERE ShortName = @Employee


	INSERT INTO @out (html) VALUES ('<style>td { vertical-align: top; }</style>')

	INSERT INTO @out (html) VALUES ('<h3>Tasks Assigned to ' + @EmployeeName + ' Not Controlled By ' + @SupervisorName + '</h3>')

	INSERT INTO @out (html) VALUES ('<table cellpadding="5" cellspacing="0" border="1">')

	INSERT INTO @out (html) VALUES ('<tr><td><b>Task</b></td><td><b>Due</b></td><td><b>Assignee(s)</b></td><td><b>Controller(s)</b></td></tr>')

	INSERT INTO @out (html)
		SELECT 
			'<tr>' + 
			--tasks.ID,
			'<td>' + ISNULL(tasks.Name, '') + '</td>' +
			'<td nowrap>' + ISNULL(CONVERT(VARCHAR(20), tasks.DueTime), '') + '</td>' + 
			'<td>' + dbo.QCheck_AssigneesListSplitGroups(tasks.InstanceID) + '</td>' +
			'<td>' + dbo.QCheck_ManagersList(tasks.ID) + '</td>' +
			'</tr>'
		FROM
			(
				SELECT DISTINCT
					c.ID,
					ci.ID AS InstanceID,
					ac.DueTime,
					c.Name
				FROM
					QCheck_Checklists c
					INNER JOIN QCheck_ChecklistInstances ci
						ON c.ID = ci.ChecklistID
						AND c.IsDeleted = 0
						AND ci.IsDeleted = 0
					INNER JOIN QCheck_ActiveChecklists ac
						ON ci.ID = ac.InstanceID
					INNER JOIN QCheck_Assignments a
						ON ci.ID = a.InstanceID
						AND a.IsDeleted = 0
					INNER JOIN QCheck_Groups g
						ON a.GroupID = g.ID
					INNER JOIN QCheck_GroupMembership gm
						ON gm.GroupID = g.ID
					INNER JOIN QCheck_Users u
						ON u.ID = gm.UserID
				WHERE
					(u.ShortName = @Employee)
					AND ac.CompletedDate IS NULL
					AND ac.DueTime <= DATEADD(DAY, 30, GETDATE())
			) tasks
			LEFT OUTER JOIN (
				SELECT DISTINCT 
					c.ID
				FROM
					QCheck_Checklists c
					INNER JOIN QCheck_ChecklistManagers cm
						ON c.ID = cm.ChecklistID
						AND c.IsDeleted = 0
						AND cm.IsDeleted = 0
					INNER JOIN QCheck_Groups g
						ON cm.ManagerGroupID = g.ID
					INNER JOIN QCheck_GroupMembership gm
						ON g.ID = gm.GroupID
					INNER JOIN QCheck_Users u
						ON u.ID = gm.UserID
				WHERE
					u.ShortName = @Supervisor
			) supervisorcontrols
				ON tasks.ID = supervisorcontrols.ID
		WHERE
			supervisorcontrols.ID IS NULL
		ORDER BY
			DueTime
			
	INSERT INTO @out (html) VALUES ('</table>')

	SELECT html FROM @out ORDER BY seq

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_ToggleTemplate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE                        PROCEDURE [dbo].[QCheck_ToggleTemplate]
(
	@ID int
)
 AS

BEGIN

	SET NOCOUNT ON
	
	update qcheck_checklists set template = CASE WHEN template = 1 then 0 else 1 end
	WHERE id = @id
	
	SET NOCOUNT OFF
	END


					
						
					    
	

			
					
						
	





































GO
/****** Object:  StoredProcedure [dbo].[QCheck_UniversalExtension_Email]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[QCheck_UniversalExtension_Email] 
	@command varchar(max) 
	,@fromEmail varchar(100)
AS
BEGIN
	Declare @userId int

	select @userId=Id from QCheck_Users where Email=@fromEmail and IsDeleted=0

	Exec QCheck_RequestExtensionsForOverDueTasks @userId=@userId,@comment=@command
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                    PROCEDURE [dbo].[QCheck_UpdateAlert](
	@ID INT,
	@nagBeforeDays int = null,
	@nagTime float = null,
	@alerteegroupid int = null,
	@alertText varchar(250) = null
)
 AS

BEGIN

	SET NOCOUNT ON
	
	UPDATE QCheck_Alerts
	SET DaysBefore = @nagBeforeDays,
	AlertTime = @nagTime,
	Alerteegroupid = @alerteegroupid,
	AlertText = @alertText
	WHERE ID = @ID

	SET NOCOUNT OFF

END

















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateAssigneesForTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE    PROCEDURE [dbo].[QCheck_UpdateAssigneesForTask]
	@ActiveChecklistID int,
	@Assignees varchar(8000),
	@AssignedBy int,
	@Comment VARCHAR(1000) = ''
AS

BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @assignee_list TABLE
	(
		ID int IDENTITY(1,1),
		Assignee int
	)

	DECLARE @CurrentAssignees TABLE (
		Seq INT IDENTITY(1,1),
		[Name] VARCHAR(500)
	)

	DECLARE @NewAssignees TABLE (
		Seq INT IDENTITY(1,1),
		[Name] VARCHAR(500)
	)

	DECLARE @rowcount int, 
		@i int, 
		@GroupID int, 
		@InstanceID int, 
		@IsController bit, 
		@ChangeID int,
		@MailFrom VARCHAR(100), 
		@MailTo VARCHAR(5000), 
		@AssignedByEmail VARCHAR(100),
		@MailSubject VARCHAR(1000),
		@MailBody VARCHAR(5000),
		@AppPath VARCHAR(50),
		@FullName VARCHAR(50),
		@TaskName VARCHAR(500),
		@ChecklistID INT,
		@CurrentAssigneeList VARCHAR(2000),
		@NewAssigneeList VARCHAR(2000),
		@AssignmentID INT


	SELECT @InstanceID = InstanceID
	FROM QCheck_ActiveChecklists
	WHERE ID = @ActiveChecklistID

	IF @InstanceID IS NULL BEGIN

		SELECT @InstanceID = [ID]
 		FROM QCheck_ActiveChecklistArchive
 		WHERE [ID] = @ActiveChecklistID

	END

	INSERT INTO @assignee_list
	SELECT n FROM dbo.Util_fn_List_To_Table(@Assignees,',')

	SELECT @rowcount = @@ROWCOUNT
	SELECT @i = 1

	DECLARE @ChangeCount INT
	
	SELECT 
		@ChangeCount = COUNT(*)	
	FROM 
		(
			SELECT a.GroupID
			FROM
				QCheck_Assignments a
				INNER JOIN QCheck_ChecklistInstances ci
					ON a.InstanceID = ci.[ID]
				INNER JOIN QCheck_ActiveChecklists ac
					ON ci.[ID] = ac.InstanceID
			WHERE 
				ac.[ID] = @ActiveChecklistID
				AND a.IsDeleted = 0
		) asn
		FULL OUTER JOIN @assignee_list al
			ON al.Assignee = asn.GroupID
	WHERE
		asn.GroupID IS NULL
		OR al.Assignee IS NULL

			
	
	IF @ChangeCount > 0 BEGIN

		-- Figure out if the requesting user is a controller of this task
		SET @IsController = 0
	


		
		SELECT
			@IsController = 1
		FROM
			QCheck_GroupMembership gm
			INNER JOIN QCheck_ChecklistManagers cm
				ON cm.managergroupid = gm.groupid
			INNER JOIN QCheck_Checklists c
				ON c.id = cm.checklistid
			INNER JOIN QCheck_ChecklistInstances_All ci
				ON ci.checklistid = c.id
			INNER JOIN QCheck_ActiveChecklists_All ac
				ON ac.instanceid = ci.id
		WHERE
			gm.userid = @AssignedBy
			AND c.isdeleted = 0
			AND cm.isdeleted = 0
			AND ac.[id] = @ActiveChecklistID

	
		IF @IsController = 1 BEGIN
		
			-- Delete removed assignments
			DECLARE curs_removed CURSOR FOR
				SELECT [ID] 
				FROM QCheck_Assignments
				WHERE GroupID NOT IN (SELECT Assignee FROM @assignee_list)
				AND InstanceID = @InstanceID
			OPEN curs_removed
			FETCH NEXT FROM curs_removed INTO @AssignmentID
			WHILE @@FETCH_STATUS = 0 BEGIN
				-- Use the SP, it handles the removal e-mails
				EXEC QCheck_DeleteAssignedTo @AssignmentID
				FETCH NEXT FROM curs_removed INTO @AssignmentID
			END
			CLOSE curs_removed
			DEALLOCATE curs_removed
		
			-- Add new assignments
			WHILE @i <= @rowcount
			BEGIN
				SELECT @GroupID = Assignee
				FROM @assignee_list
				WHERE ID = @i
				
				IF NOT EXISTS (
					SELECT IsDeleted 
					FROM QCheck_Assignments
					WHERE GroupID = @GroupID
					AND InstanceID = @InstanceID
					AND IsDeleted = 0
				) BEGIN
					EXEC QCheck_AddAssignedTo @InstanceID, @GroupID, @AssignedBy
				END
		
				SET @i = @i + 1
			END
	
		END ELSE BEGIN
	
			-- Create a new change request
			EXEC QCheck_Approval_NewChangeRequest @AssignedBy, @Comment, @ChangeID OUTPUT
		
			-- Save the assignments to be deleted
			INSERT INTO QCheck_Approval_Assignments (
				ChangeRequestID,
				AssignmentID,
				InstanceID,
				GroupID,
				DtAssigned,
				IsDeleted
			)
				SELECT
					@ChangeID,
					[ID],
					InstanceID,
					GroupID,
					DtAssigned,
					1
				FROM
					QCheck_Assignments
				WHERE 
					GroupID NOT IN (
						SELECT Assignee 
						FROM @assignee_list
					)
					AND InstanceID = @InstanceID
		
			-- Mark the change as ready for the supervisor
			UPDATE QCheck_Approval_ChangeRequests SET ReadyForSupervisor = 1 WHERE [ID] = @ChangeID
		
			-- Save the assignments to be added
			WHILE @i <= @rowcount BEGIN
		
				SELECT @GroupID = Assignee
				FROM @assignee_list
				WHERE ID = @i
				
				IF NOT EXISTS (
					SELECT IsDeleted 
					FROM QCheck_Assignments
					WHERE GroupID = @GroupID
					AND InstanceID = @InstanceID
					AND IsDeleted = 0
				) 
				BEGIN
					INSERT INTO QCheck_Approval_Assignments (
						ChangeRequestID,
						AssignmentID,
						InstanceID,  
						GroupID,
						DtAssigned,
						IsDeleted
					)
						SELECT 
							@ChangeID, 
							-1,
							@InstanceID, 
							@GroupID,
							GETDATE(),
							0
						WHERE 
							NOT EXISTS (
								SELECT [ID] FROM QCheck_Assignments
								WHERE InstanceID = @InstanceID
								AND GroupID = @GroupID
								and IsDeleted = 0
							)
				END
		
				SET @i = @i + 1
		
			END
		
			-- Get current info
			SELECT 
				@TaskName = c.[Name],
				@ChecklistID = c.[ID]
			FROM
				QCheck_Checklists c
				INNER JOIN QCheck_ChecklistInstances ci
					ON ci.ChecklistID = c.[ID]
				INNER JOIN QCheck_ActiveChecklists ac
					ON ac.InstanceID = ci.[ID]
			WHERE
				ac.[ID] = @ActiveChecklistID
		
			-- Get current assignee list
			INSERT INTO @CurrentAssignees (
				[Name]
			)
				SELECT 
					G.[Name]
				FROM 
					QCheck_Assignments A
					INNER JOIN QCheck_Groups G
						ON A.GroupID = G.[ID]
						AND A.InstanceID = @InstanceID
				WHERE
					A.IsDeleted = 0
				ORDER BY 
					G.[Name]
		
			SELECT @rowcount = MAX(Seq) FROM @CurrentAssignees
			SET @i = 1
			SET @CurrentAssigneeList = ''
			WHILE @i <= @rowcount BEGIN
				SELECT @CurrentAssigneeList = @CurrentAssigneeList + [Name] FROM @CurrentAssignees WHERE Seq = @i
				IF @i < @rowcount SET @CurrentAssigneeList = @CurrentAssigneeList + ', '
				SET @i = @i + 1
			END
		
			-- Get new assignee list
			INSERT INTO @NewAssignees (
				[Name]
			)
				SELECT 
					G.[Name]
				FROM 
					QCheck_Approval_Assignments A
					INNER JOIN QCheck_Groups G
						ON A.GroupID = G.[ID]
				WHERE
					A.IsDeleted = 0
					AND A.InstanceID = @InstanceID
					AND A.ChangeRequestID = @ChangeID
		
				UNION
		
				SELECT 
					G.[Name]
				FROM 
					QCheck_Assignments A
					INNER JOIN QCheck_Groups G
						ON A.GroupID = G.[ID]
						AND A.InstanceID = @InstanceID
					-- Join to assignments we are deleting
					LEFT OUTER JOIN QCheck_Approval_Assignments AA
						ON A.[ID] = AA.AssignmentID
						AND AA.ChangeRequestID = @ChangeID
						AND AA.InstanceID = @InstanceID
						AND AA.IsDeleted = 1
				WHERE
					A.IsDeleted = 0
					-- Make sure the assignment is not being deleted
					AND AA.[ID] IS NULL
				ORDER BY 
					G.[Name]
		
			SELECT @rowcount = MAX(Seq) FROM @NewAssignees
			SET @i = 1
			SET @NewAssigneeList = ''
			WHILE @i <= @rowcount BEGIN
				SELECT @NewAssigneeList = @NewAssigneeList + [Name] FROM @NewAssignees WHERE Seq = @i
				IF @i < @rowcount SET @NewAssigneeList = @NewAssigneeList + ', '
				SET @i = @i + 1
			END
		
		
			-- Get the path 
			SELECT @AppPath = AppURL 
			FROM QCheck_AppSettings S
			INNER JOIN QCheck_Users U
				ON S.[ID] = U.App
			WHERE U.[ID] = @AssignedBy
		
		
			-- Get the controller email address(es)
			SELECT @MailTo = dbo.QCheck_ChecklistControllerEmails(@ChecklistID, DEFAULT)
			
			-- Send e-mails requesting approval for the due date change
			SELECT @FullName = FullName, @AssignedByEmail = Email FROM QCheck_Users WHERE [ID] = @AssignedBy
			SET @MailFrom = @FullName + '<' + @AssignedByEmail + '>'
					
			SET @MailSubject = '"' + ISNULL(@TaskName, '') + '" - ' + ISNULL(@FullName, '') + ' wants to change assignee to ' + ISNULL(@NewAssigneeList, '')
			
			SET @MailBody = '<table border="0"><tr><td>Current Assignees:</td><td><b>' + ISNULL(@CurrentAssigneeList, '') + '</b></td><tr>' +
					'<tr><td>Requested Assignees:</td><td><b>' + ISNULL(@NewAssigneeList, '') + '</b></td></tr></table><br/><br/>' +
					'<table border="0"><tr><td>Comment: <b>' + ISNULL(@Comment, '') + '</b><br/><br/>' +
					'To approve this assignment change, reply to this e-mail with "Y".  To reject the change, reply to this e-mail with "N".  The "Y" or "N" must be on the first line of the reply.  To set up different assignees, click <a href="' + ISNULL(@AppPath, '') + '/ManageTasks.aspx?checklistid=' + ISNULL(CONVERT(VARCHAR(20), @ChecklistID), '') + '">here</a>.<br/><br/>If you want to include a comment, copy ' + ISNULL(@Fullname, '') + ' on the reply and put your comment below the first line.</td></tr></table><br/><br/>' +
					'<span style="color: white;">ChangeID:' + CONVERT(VARCHAR(20), @ChangeID) + '|[ID2]</span>'
			
			EXEC dbo.xp_smtp_sendmail 
				@from = @AssignedByEmail, 
				@from_name = @FullName,
				@replyto = @AutomationAddress,
				@to = @MailTo, 
				@cc = @AssignedByEmail,
				@subject = @MailSubject,
				@message = @MailBody, 
				@type = 'text/html', 
				@server = @MailServer
		
			SET @i = @i + 1
		
	
		END

	END

END



GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateDueDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[QCheck_UpdateDueDate]
	@TaskID int,
	@DueDate datetime,
	@ChangedBy Varchar(100) = ''
AS
BEGIN
	DECLARE @DueDateOld datetime,
		@NextDueDate datetime

	SELECT @DueDateOld = DueTime
	FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID

	SELECT @NextDueDate = min(udt.duetime)
	from qcheck_upcomingduetimes udt
	inner join qcheck_activechecklists ac
	on ac.instanceid = udt.instanceid
	and ac.id = @TaskID

	IF isnull(@NextDueDate, '1/1/9999') > @DueDate
	BEGIN
	
		IF @DueDateOld is not null AND @DueDate is not null
		BEGIN
	
			IF CONVERT(varchar, @DueDateOld, 101) <> CONVERT(varchar, @DueDate, 101) 
			BEGIN
				INSERT INTO QStatus_DueDateChanges
				(ActiveChecklistID, DueDateOld, UpdateDT, ChangedBy)
				VALUES
				(@TaskID, @DueDateOld, getDate(), @ChangedBy)	
			END	
		END
		
		Update QCheck_ActiveChecklists
		SET DueTime = @DueDate
		WHERE ID = @TaskID							
	
	END
	
END












































GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateInstanceReminderDates]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_UpdateInstanceReminderDates]
	@InstanceID int,
	@SoftDueOffsetDays int
AS

BEGIN
	
	UPDATE QCheck_ActiveChecklists
	SET ReminderDate = DATEADD(DAY, @SoftDueOffsetDays * -1, DueTime)
	WHERE InstanceID = @InstanceID
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateJBTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QCheck_UpdateJBTask]
@TaskName varchar(1000),
@Active bit,
@TraderID varchar(20),
@BondID int,
@BondTradeID int = NULL

AS
BEGIN
	
	Declare @ActiveChecklistID int

	--pull the task ID from the lookup table
	select @ActiveChecklistID = TaskID from JB_Tasks
	where bondid = @BondID and 	
	(
		bondtradeid = @BondTradeID
		or 
		(bondtradeid is null and @BondTradeID is null)  --name of interest have no tradeid
	)

	IF @ActiveChecklistID is not null  --make sure we have a task to update
	BEGIN
		IF @Active = 1 -- task is active, update name
		BEGIN
			UPDATE QCheck_Checklists
				SET Name = @TaskName
			FROM QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
			ON
				ci.ChecklistID = c.ID
			INNER JOIN QCheck_ActiveChecklists ac
			ON
				ac.InstanceID = ci.ID
			AND
				ac.ID = @ActiveChecklistID
		END
		ELSE --task inactive, just mark complete
		BEGIN
			DECLARE @isComplete bit
			DECLARE @CompletedBy int
			SET @CompletedBy = 0
			
			SELECT @CompletedBy = ID
			FROM QCheck_Users 
			WHERE ShortName = @TraderID
	
			EXEC QCheck_CompleteChecklist @ActiveChecklistID, @CompletedBy, 0, '', @isComplete output
		END
	END
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateReminderDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_UpdateReminderDate]
	@TaskID int,
	@ReminderDate datetime
AS
BEGIN
	DECLARE @ReminderDateOld datetime,
		@DueTime datetime

	SELECT @ReminderDateOld = ReminderDate
	FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID

	SELECT @DueTime = DueTime
	FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID

	IF @DueTime >= @ReminderDate
	BEGIN
		
		Update QCheck_ActiveChecklists
		SET ReminderDate = @ReminderDate
		WHERE ID = @TaskID
	
	END
	
END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateSchedule_Part1]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_UpdateSchedule_Part1](
      @InstanceID INT,
      @firstDueDate datetime,
      @lastDueDate datetime = null,
      @freqType int,
      @freqInterval int = null,
      @freqRecurrance int = null,
      @dueTime float = null,
      @busDayBehavior int = 0,
      @PrevFreqType int = 0 output,
      @RowsUpdated int = 0 output,
      @Activate bit = 1,
      @SoftDueOffsetDays int = null,
      @BusDayValue int = null
) AS

BEGIN

      SET NOCOUNT ON

	  --if no duetime passed in, get the default
	  IF @dueTime is NULL
	  BEGIN
			DECLARE @UserID int

			SELECT @UserID = CreatedBy
			FROM qcheck_checklistinstances ci
			INNER JOIN qcheck_checklists c
				ON ci.ChecklistID = c.id

			SELECT @DueTime = duetime from QCheck_UserDefaultTimes
			WHERE UserID = @UserID

			IF @DueTime is null 
			BEGIN
				SELECT @DueTime = duetime from QCheck_UserDefaultTimes
				WHERE UserID = -1
			END
	  END

      set @firstDueDate = convert(varchar, @firstDueDate, 101)
      
      if @freqtype = 1 set @lastDueDate = null
      
      DECLARE @ScheduleID int
      
      -- make sure we dont already have a schedule

      SELECT @ScheduleID = ScheduleID 
      FROM QCheck_ChecklistInstances
      WHERE [ID] = @InstanceID
      
      If @ScheduleID is null
      BEGIN
      
            INSERT INTO QCheck_Schedule (
                  firstDueDate,
                  lastDueDate,
                  freqType,
                  freqInterval,
                  freqRecurrance,
                  dueTime,
                  busDayBehavior,
                  SoftDueOffsetDays,
                  busDayValue
            ) VALUES (
                  @firstDueDate,
                  @lastDueDate,
                  @freqType,
                  @freqInterval,
                  @freqRecurrance,
                  @dueTime,
                  @busDayBehavior,
                  @SoftDueOffsetDays,
                  @BusDayValue
            )
      
            SET @ScheduleID = @@IDENTITY
            SET @RowsUpdated = @@ROWCOUNT

            -- update instances with the schedule we just inserted
            UPDATE QCheck_ChecklistInstances
            SET ScheduleID = @ScheduleID
            WHERE [ID] = @InstanceID

      END

      ELSE

      BEGIN

            -- otherwise just update
            SELECT 
                  @PrevFreqType = FreqType
            FROM
                  QCheck_Schedule
            WHERE
                  [ID] = @ScheduleID

            UPDATE QCheck_Schedule
            SET 
                  firstduedate = @firstduedate,
                  lastduedate = @lastduedate,
                  freqType = @freqType,
                  freqInterval = @freqInterval,
                  freqRecurrance = @freqRecurrance,
                  dueTime = @dueTime,
                  busDayBehavior = @busDayBehavior,
                  SoftDueOffsetDays = ISNULL(@SoftDueOffsetDays, SoftDueOffsetDays),
                  busDayValue = @BusDayValue
            WHERE 
                  [ID] = @ScheduleID
                  AND (
                        firstduedate <> @firstduedate 
                        OR isnull(lastduedate, getdate()) <> isnull(@lastduedate, getdate()) 
                        OR freqType <> @freqType 
                        OR isNull(freqInterval,0) <> isNull(@freqInterval,0) 
                        OR isNull(freqRecurrance,0) <> isNull(@freqRecurrance,0) 
                        OR dueTime <> @dueTime 
                        OR busDayBehavior <> @busDayBehavior
                        OR SoftDueOffsetDays <> ISNULL(@SoftDueOffsetDays, SoftDueOffsetDays)
                        OR busDayValue <> ISNULL(@busDayValue, busDayValue)
            )
            
            SET @RowsUpdated = @@ROWCOUNT

      END

      --EXEC QCheck_SetUpcomingInstance @InstanceID, @ScheduleID
      if @Activate = 1 exec QCheck_ActivateSchedule @InstanceID, @PrevFreqType


      SET NOCOUNT OFF

END

GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateSchedule_Part2]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








-- This stored procedure will update a schedule for a specified instance


CREATE                                 PROCEDURE [dbo].[QCheck_UpdateSchedule_Part2](
	@InstanceID INT,
	@PrevFreqType INT,
	@activate bit

)
 AS

BEGIN

	SET NOCOUNT ON
	
		insert into Temp_UpdateSchedule 
		select @InstanceID, @PrevFreqType, @activate, getdate()

		exec QCheck_InstanceChangeAlert @InstanceID, 'Schedule', 'Change'
		IF @activate = 1 exec QCheck_ActivateSchedule @InstanceID, @PrevFreqType
	
		EXEC QCheck_SetUpcomingInstance @InstanceID
	
		EXEC QCheck_ActivateFutureInstance @InstanceID

		--find #active
		DECLARE @ActiveCount int
	
		SELECT @ActiveCount = Count(ac.ID)
		FROM QCheck_ActiveChecklists ac
		WHERE ac.InstanceID = @InstanceID
		AND ac.CompletedDate is null
		
		IF @ActiveCount = 0
		BEGIN
			DECLARE @FutureID int
			SELECT TOP 1 @FutureID = ID
			FROM QCheck_UpcomingDueTimes
			WHERE InstanceID = @InstanceID
			ORDER BY DueTime asc

			declare @newid int

			IF @FutureID is not null
				EXEC QCheck_ActivateFuture @InstanceID, @FutureID, @newid

		END
	

	SET NOCOUNT OFF

END






















































GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateSectionDueDates]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck_UpdateSectionDueDates]
@sectionId int,
@newDueDate datetime,
@pushDays int = null

AS

IF @pushDays IS NULL

	UPDATE QCheck_ActiveChecklists
	SET DueTime = @newDueDate
	WHERE ID IN
	(
		SELECT distinct
			ac.ID
		FROM
			QStatus_ActiveChecklistTaskType actt
		INNER JOIN
			QStatus_TaskTypes	tt
		ON
			actt.TaskType = tt.ID
		INNER JOIN 
			QCheck_ActiveChecklists ac
		ON
			ac.ID = actt.ActiveChecklistID
		INNER JOIN
			QCheck_ActiveAssignments aa
		ON
			aa.ActiveChecklistID = ac.ID
		INNER JOIN 
			qcheck_checklistinstances ci
		ON
			ci.ID = ac.InstanceID
		INNER JOIN
			qcheck_checklists c
		ON
			ci.ChecklistID = c.ID
		INNER JOIN
			QCheck_Assignments a
		ON
			a.ID = aa.AssignmentsID
		WHERE
			tt.id = @sectionId
		AND
			a.IsDeleted = 0
		AND
			ac.CompletedDate IS NULL
	)

ELSE

	UPDATE QCheck_ActiveChecklists
	SET DueTime = DueTime + @pushDays
	WHERE ID IN
	(
		SELECT distinct
			ac.ID
		FROM
			QStatus_ActiveChecklistTaskType actt
		INNER JOIN
			QStatus_TaskTypes	tt
		ON
			actt.TaskType = tt.ID
		INNER JOIN 
			QCheck_ActiveChecklists ac
		ON
			ac.ID = actt.ActiveChecklistID
		INNER JOIN
			QCheck_ActiveAssignments aa
		ON
			aa.ActiveChecklistID = ac.ID
		INNER JOIN 
			qcheck_checklistinstances ci
		ON
			ci.ID = ac.InstanceID
		INNER JOIN
			qcheck_checklists c
		ON
			ci.ChecklistID = c.ID
		INNER JOIN
			QCheck_Assignments a
		ON
			a.ID = aa.AssignmentsID
		WHERE
			tt.id = @sectionId
		AND
			a.IsDeleted = 0
		AND
			ac.CompletedDate IS NULL
	)
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateSoftDue]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_UpdateSoftDue]
	@TaskID int,
	@NewSoftDue datetime
AS
BEGIN
	DECLARE @SoftDue datetime,
		@DueTime datetime

	SELECT @SoftDue = ReminderDate,
		@DueTime = DueTime
	FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID


	IF @NewSoftDue <= @DueTime
	BEGIN
		
		Update QCheck_ActiveChecklists
		SET ReminderDate = @NewSoftDue
		WHERE ID = @TaskID				
	
	END ELSE BEGIN

		Update QCheck_ActiveChecklists
		SET ReminderDate = @DueTime
		WHERE ID = @TaskID

	END
	
END













































GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateSuggestion]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                     PROCEDURE [dbo].[QCheck_UpdateSuggestion]
	@SuggestionID int,
	@DisplayOrder int
 AS

BEGIN

	SET NOCOUNT ON

		DECLARE @MinWithEmptyBefore int

		UPDATE QCheck_Suggestions
		SET [DisplayOrder] = [DisplayOrder] + 1
		WHERE [DisplayOrder] >= @DisplayOrder
		AND EXISTS
		(
			SELECT SuggestionID FROM QCheck_Suggestions 
			WHERE [DisplayOrder] = @DisplayOrder
		)
		AND IsDeleted = 0

		UPDATE QCheck_Suggestions
		SET DisplayOrder = @DisplayOrder
		WHERE SuggestionID = @SuggestionID
		
		SELECT @MinWithEmptyBefore = MIN(A.DisplayOrder)
		FROM QCheck_Suggestions a
		WHERE NOT EXISTS
		(SELECT b.SuggestionID 
		FROM
		QCheck_Suggestions b
		WHERE b.DisplayOrder = a.DisplayOrder - 1
		AND b.IsDeleted = 0)
		AND a.DisplayOrder > 1
		AND a.IsDeleted = 0
		
		If IsNull(@MinWithEmptyBefore,0) > 1
		BEGIN
			UPDATE QCheck_Suggestions
			SET [DisplayOrder] = [DisplayOrder] - 1
			WHERE [DisplayOrder] >= @MinWithEmptyBefore
			AND IsDeleted = 0
		END

	SET NOCOUNT OFF

END




































GO
/****** Object:  StoredProcedure [dbo].[QCheck_UpdateUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck_UpdateUser]
(
	@ID int,
	@Login varchar(50),
	@Name varchar(50),
	@Email varchar(50),
	@Password varchar(50),
	@Admin	bit,
	@Beta bit = 0,
	@EmpID int = null
)
AS
BEGIN
	SET NOCOUNT ON

		UPDATE QCheck_Users 
		SET ShortName = @Login,
			FullName = @Name,
			Email = @Email,
			Password = @Password,
			Admin = @Admin,
			Beta = @Beta,
			empID = ISNULL(@EmpID, empId)
		WHERE ID = @ID

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UserByEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  Proc [dbo].[QCheck_UserByEmail](
	@emailaddress varchar(100)
)
as 
begin
   DECLARE @DueTime int

	SELECT @DueTime = duetime from QCheck_UserDefaultTimes
	WHERE UserID = (select id from QCheck_Users where Email=@emailaddress and IsDeleted = 0)

	IF @DueTime is null 
	BEGIN
		SELECT @DueTime = duetime from QCheck_UserDefaultTimes
		WHERE UserID = -1
	END


	select top 1 s.UserID, s.usergroupid, s.supervisorgroupid , usup.fullname as supervisorname, u.fullname,COnvert(varchar(10),Cast(Cast(@DueTime as varchar(10))+':0:0' as Time),100) as DefaultDueTime
	from qcheck_users u
	inner join qstatus_usersupervisors s
		on u.id = s.userid
	left outer join qcheck_users usup
		on usup.id = s.supervisoruserid
	 where u.email = @emailaddress
	

end

GO
/****** Object:  StoredProcedure [dbo].[QCheck_UserReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QCheck_UserReport]
(
@startdt datetime = null, 
@enddt datetime = null
)
as
begin
	if @startdt is null select @startdt = getdate() - 1
	if @enddt is null select @enddt = getdate()

	SELECT distinct u.fullname
		, u.shortname as username
		, u.email
		, u.empid
		 ,u.id as UserID
		 ,case when bu.userid is null then 0 else 1 end as setupForBonus
         ,isnull(bonus.b, 0) as bonus
         ,isnull(checklistcount, 0) as taskscreated
         ,isnull(activechecklists, 0) as taskscompletedontime
         ,isnull(comments, 0) as comments
         ,isnull(logid, 0) as emailSends
  FROM [dbo].QCheck_Users u
       left outer join [dbo].[Grading_QProcessTests] qt
              on u.fullname = qt.employee
       left outer join qcheck_bonususers bu
              on bu.userid = u.id
			  and u.isdeleted = 0
       outer apply
       (
         SELECT sum(bonus) as b
         FROM [dbo].[QCheck_BonusDatesAmounts]
         where userid = u.id
         and dt >= @startdt
		 and dt < @enddt
       ) bonus
       outer apply
       (
              select count(id) as checklistcount
              from qcheck_checklists_all
              where owner = u.id
              and name not like '%test%'
              and createdate >= @startdt
			  and createdate < @enddt
       ) as checklists
       outer apply
       (
              select count(ac.id) as activechecklists
              from qcheck_activechecklists_all ac
              inner join qcheck_checklistinstances_all ci
                     on ci.id = ac.instanceid
                     inner join qcheck_checklists_all c
                           on c.id = ci.checklistid
                           and c.name not like '%test%'
              where ac.completedby = u.id
              and ac.completeddate >= @startdt
			  and ac.completeddate < @enddt
			  and ac.completeddate <= ac.duetime
       ) as ac
       
       outer apply
       (
              select count(id) as comments
              from qstatus_comments_all c 
              where c.userid = u.id
              and commentdt >= @startdt
			  and commentdt < @enddt
       ) as comments
       outer apply
       (
			select count(sentdt) as logid
			from
			[QCheck_BonusStatusEmails]

              where userid = u.id
              and sentdt >= @startdt
			  and sentdt < @enddt
       ) as priority
	where u.isdeleted = 0
	order by fullname
end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_UserTasksReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck_UserTasksReport] (
	@UserID INT = NULL,
	@Search VARCHAR(5000) = NULL
) AS

BEGIN
	
	IF LTRIM(RTRIM(ISNULL(@Search, ''))) = '' SET @Search = '@@@***###'

	SELECT DISTINCT
		c.Name AS Task,
		dbo.QCheck_AssigneesList(ci.ID) AS Assignees,
		dbo.QStatus_GetChecklistControllers(c.ID) AS Controllers,
		ac.DueTime AS Due,
		ac.CompletedDate AS Completed,
		CASE
			WHEN s.FreqType = 1 THEN 'One time task'
			ELSE dbo.QCheck_ScheduleString(ci.ScheduleID)
		END AS Schedule
	FROM 
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
		INNER JOIN QCheck_Assignments a
			ON g.ID = a.GroupID
			AND a.IsDeleted = 0
		INNER JOIN QCheck_ActiveAssignments aa
			ON a.ID = aa.AssignmentsID
		INNER JOIN QCheck_ActiveChecklists ac
			--ON ac.ID = acm.ID
			ON aa.ActiveChecklistID = ac.ID
		INNER JOIN QCheck_ChecklistInstances ci 
			ON a.InstanceID = ci.ID
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
			AND c.IsDeleted = 0
		INNER JOIN QCheck_Schedule s
			ON ci.ScheduleID = s.ID
	WHERE
		u.ID = ISNULL(@UserID, u.ID)
		--AND c.Name LIKE '%' + ISNULL(@Search, '') + '%'
		AND (
			@Search = '@@@***###'
			OR CONTAINS(c.Name, @Search)
		)
	ORDER BY
		c.Name,
		ac.DueTime

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_VacationReminder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[QCheck_VacationReminder]
AS
BEGIN

	if dbo.Util_isofficeday(getdate()) = 0 return;

	declare @firstreminder date
	declare @secondreminder date

	select @firstreminder = dbo.Util_AddOfficeDays(getdate(), 3)
	select @secondreminder = dbo.Util_AddOfficeDays(getdate(), 1)

	declare @vacations table
	(vacationday date, employeeid int, nextday date)

	insert into @vacations
	select vacationday, employeeid, dbo.[Util_NextOfficeDay](VacationDay)  
	from vwVacation
	where VacationDay >= cast(getdate() as date)
	and vacationday < dateadd(day, 7, getdate())
	and vacationtypeid in (1,2)

	declare @emailbcc varchar(max) = ''

	select @emailbcc = @emailbcc + u.email + ';'
	 from @vacations v1
		inner join @vacations v2
			on v1.EmployeeID = v2.EmployeeID
			and v1.nextday = v2.VacationDay
		left outer join @vacations v3
			on v3.EmployeeID = v1.EmployeeID
			and v3.nextday = v1.VacationDay
		left outer join qcheck_users u
			on u.empid = v1.employeeid
	where v1.vacationday in (@firstreminder, @secondreminder)
	and v3.VacationDay is null

	declare @message varchar(max) 

	DECLARE @AppName VARCHAR(50),  @MailFrom varchar(1000), @MailSubject varchar(1000)
	SELECT @Appname = AppName
		,@MailFrom = AppName + (SELECT TOP 1 '@dnr.' + BaseDomain FROM QCheck_AppSettings)
		,@MailSubject= 'Reminder To Reassign Tasks In ' + AppName
	FROM QCheck_AppSettings WHERE ID = 1
	   
	select @message = 'You have a multi-day vacation coming up.  Please remember to reassign out any critical tasks using the Vacation link at the bottom left of '+@Appname+'.  If you need a refresher on how the Vacation functionality works in '+@Appname+', please review the video below.  As always, email IT if you have any questions.'
	select @message = @message + '<br><br/> <a href="https://vimeo.com/368309490">https://vimeo.com/368309490</a><br>Password: vacation'

	if len(@emailbcc) > 0
	begin
		EXEC dbo.xp_smtp_sendmail
			@BCC        = @emailbcc,
			@subject   = @MailSubject,
			@message   = @message,
			@type      = 'text/html',
			@from_name =  @AppName,
			@from	   =  @MailFrom
	end
end
GO
/****** Object:  StoredProcedure [dbo].[QCheck_VacationReminderReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[QCheck_VacationReminderReport](
 @startdate date = null
)
AS
BEGIN

	declare @a int = 0

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck_WeeklyAlertCounts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  PROCEDURE [dbo].[QCheck_WeeklyAlertCounts]
@alertthreshhold smallmoney = 3.5

AS


declare @startdate datetime
set @startdate = '12/17/2007'

declare @bncount int
declare @mrcount int
declare @totalcount int

declare @results table
(
	weekstarting datetime,
	alertcount int,
	bnalerts int null,
	mralerts int null,
	totalalerts int null
)

while @startdate < getdate()
begin
insert into @results(weekstarting, alertcount)
select @startdate, count(*) from qcheck_loadtimes
where totaltime > @alertthreshhold * 1000
and (pagename like '%statuscopy%' or pagename like '%inbox%')
and dt > @startdate and dt < @startdate + 7
and not (userid = 14 or userid = 68)

select @bncount = count(*) from qcheck_loadtimes t1
where totaltime > @alertthreshhold * 1000
and (pagename like '%statuscopy%' or pagename like '%inbox%')
and dt > @startdate and dt < @startdate + 7
and (userid = 14 or userid = 68)

select @mrcount = count(*) from qcheck_loadtimes t1
where totaltime > @alertthreshhold * 1000
and (pagename like '%statuscopy%' or pagename like '%inbox%')
and dt > @startdate and dt < @startdate + 7
and (userid = 218)

select @totalcount = count(*) from qcheck_loadtimes t1
where totaltime > @alertthreshhold * 1000
and (pagename like '%statuscopy%' or pagename like '%inbox%')
and dt > @startdate and dt < @startdate + 7

update @results
set bnalerts = @bncount, totalalerts = @totalcount, mralerts = @mrcount
where weekstarting = @startdate

set @startdate = @startdate + 7
end

select weekstarting as 'Week Of', alertcount as 'Alert Count' , bnalerts as 'Brandon/Nelson', mralerts as 'Michael', totalalerts as 'Total Alerts' from @results
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_AddAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will update a schedule for a specified instance

CREATE PROCEDURE [dbo].[QCheck2_AddAlert](
	@InstanceID INT,
	@nagBeforeDays int = null,
	@nagTime float = null,
	@alerteegroupid int = null,
	@alertType varchar(10),
	@alertText varchar(250) = null,
	@ReturnID int output
)
 AS

BEGIN

	SET NOCOUNT ON
	
	Insert Into QCheck_Alerts
	(InstanceID, DaysBefore, AlertTime, AlerteeGroupID, AlertType, AlertText)
	Values
	(@InstanceID, @nagBeforeDays, @nagTime, @AlerteeGroupID, @alertType, @alertText)

	select @ReturnID = @@IDENTITY

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_AddAssignedTo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- This stored procedure will Assign a member to a checklist
-- InstanceID is the instance being assigned to
-- AssignedTo is the member being assigned
-- AssignedBy is the member who assigned the checklist out

CREATE       PROCEDURE [dbo].[QCheck2_AddAssignedTo](
	@InstanceID INT,
	@GroupID	int,
	@AssignedBy 	int,
	@Email		bit = 1,
	@ReturnID Int OUTPUT
)
 AS

BEGIN

	SET NOCOUNT ON
	DECLARE @AssignmentsID int
	DECLARE @ScheduleID int
	DECLARE @ActiveChecklistID int
	DECLARE @startDate datetime
	DECLARE @dueDate datetime
	DECLARE @nextStart datetime
	DECLARE @checklistName varchar(500)
	DECLARE @relativeStart datetime
	DECLARE @ActiveAssignments int
	DECLARE @Now datetime

	--Create the assignment
	INSERT INTO
		QCheck_Assignments
	([InstanceID],  [GroupID])
	SELECT @InstanceID, @GroupID
	WHERE NOT EXISTS
	(SELECT [ID] FROM QCheck_Assignments
	WHERE InstanceID = @InstanceID
	AND GroupID = @GroupID
	and IsDeleted = 0)

	SELECT @AssignmentsID = @@IDENTITY	
	
	--Only do this if they are not already assigned to the checklist	
	IF @AssignmentsID is not null 
	BEGIN

		SELECT Distinct @ActiveChecklistID = MIN(b.ID)
		FROM QCheck_ActiveChecklists b
		LEFT OUTER JOIN
			QCheck_ActiveAssignments newassign
		on
			newassign.AssignmentsID = @AssignmentsID AND newassign.ActiveChecklistID = b.ID--a.ActiveChecklistID
		WHERE 
			newassign.ID is null
		AND
			b.InstanceID = @InstanceID
		AND
			b.CompletedDate is null

		--Select @ActiveChecklistID
		
		INSERT INTO QCheck_ActiveAssignments
		SELECT Distinct b.ID, @AssignmentsID--a.ActiveChecklistID, @AssignmentsID
		FROM
			QCheck_ActiveChecklists b
		LEFT OUTER JOIN
			QCheck_ActiveAssignments newassign
		on
			newassign.AssignmentsID = @AssignmentsID AND newassign.ActiveChecklistID = b.ID--a.ActiveChecklistID
		WHERE 
			newassign.ID is null
		AND
			b.InstanceID = @InstanceID
		AND
			b.CompletedDate is null
		--SELECT @ActiveAssignments = @@rowcount

		/*Notify the assignee*/
		SELECT 
			@checklistName = b.[Name]
		FROM
			QCheck_ChecklistInstances a
		INNER JOIN
			QCheck_Checklists b
		   ON
			a.ChecklistID = b.[ID]
		WHERE
			a.[ID] = @InstanceID

		
		DECLARE @SendEmail bit
		SET @SendEmail = 1
		
		SELECT @SendEmail = 0
		FROM QCheck_GroupMembership gm
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		WHERE gm.GroupID = @GroupID 
		AND gm.UserID = @AssignedBy
		AND g.SingleMemberGroup = 1

		if @SendEmail =1 and @Email = 1
			exec QCheck_AssignedEmail_AddToQueue @GroupID, @AssignedBy, @checklistName, @InstanceID
		
		exec QCheck_InstanceChangeAlert @InstanceID, 'Assignment', 'Add'
	END

	SELECT @ReturnID = @AssignmentsID

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_AddManager]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck2_AddManager] (
	@GroupID Int,
	@ChecklistID Int,
	@ReturnID INT OUTPUT
)
 AS

BEGIN

	SET NOCOUNT ON

	DECLARE @AlreadyExisted bit;
	
	UPDATE QCheck_ChecklistManagers
	SET IsDeleted = 0
	WHERE
		IsDeleted = 1
	AND
		ManagerGroupID = @GroupID
	AND
		ChecklistID = @ChecklistID

	if(@@ROWCOUNT > 0)
		SET @AlreadyExisted = 1;
	
	INSERT INTO QCheck_ChecklistManagers
	(ChecklistID, ManagerGroupID)
	SELECT @ChecklistID, @GroupID
	WHERE NOT EXISTS
	(
	SELECT ID FROM QCheck_ChecklistManagers
	WHERE
		ManagerGroupID = @GroupID
	AND
		ChecklistID = @ChecklistID
	)

	if(@AlreadyExisted = 1)
		select @ReturnId = ID
		from QCheck_ChecklistManagers
		where ManagerGroupID = @GroupID
			AND ChecklistID = @ChecklistID
	else
		select @ReturnID = @@IDENTITY

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_CopyInstance]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QCheck2_CopyInstance] (
	@ID INT = NULL OUTPUT,
	@InstanceID INT
) AS

BEGIN
	
	DECLARE @NewInstanceID INT
	DECLARE @ScheduleID INT
	DECLARE @NewScheduleID INT
	DECLARE @NowDate DATETIME
	DECLARE @ChecklistID INT
	DECLARE @FreqType INT

	
	SELECT @NowDate = GetDate()

	SELECT 
		@ScheduleID = ScheduleID, 
		@ChecklistID = ChecklistID
	FROM 
		QCheck_ChecklistInstances
	WHERE
		[ID] = @InstanceID

	INSERT INTO QCheck_Schedule (
		firstDueDate, 
		lastDueDate, 
		freqType, 
		freqInterval, 
		freqRecurrance, 
		dueTime, 
		busDayBehavior,
		SoftDueOffsetDays
	)
		SELECT 
			firstDueDate, 
			lastDueDate, 
			freqType, 
			freqInterval, 
			freqRecurrance, 
			dueTime, 
			busDayBehavior,
			SoftDueOffsetDays
		FROM 
			QCheck_Schedule
		WHERE
			[ID] = @ScheduleID

	SELECT @NewScheduleID = @@Identity
		
	INSERT INTO QCheck_ChecklistInstances (
		[Name], 
		ChecklistID, 
		ScheduleID, 
		IsDeleted, 
		CreatedBy
	)
		SELECT 
			[Name], 
			@ChecklistID, 
			@NewScheduleID,  
			0, 
			CreatedBy
		FROM 
			QCheck_ChecklistInstances
		WHERE
			[ID] = @InstanceID
			AND IsDeleted = 0

	SELECT @NewInstanceID = @@Identity
	SET @ID = @NewInstanceID

	INSERT INTO QCheck_Assignments (
		InstanceID, 
		GroupID, 
		IsDeleted
	)
		SELECT 
			@NewInstanceID, 
			GroupID,  
			0
		FROM 
			QCheck_Assignments
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	INSERT INTO QStatus_InstanceTaskType (
		InstanceID, 
		TaskType
	)
		SELECT 
			@NewInstanceID, 
			TaskType
		FROM 
			QStatus_InstanceTaskType
		WHERE 
			InstanceID = @InstanceID
	
	INSERT INTO QCheck_Alerts (
		InstanceID, 
		DaysBefore, 
		AlertTime, 
		AlertType, 
		AlertText, 
		SentTime, 
		IsDeleted, 
		AlerteeGroupID
	)
		SELECT 
			@NewInstanceID, 
			DaysBefore, 
			AlertTime, 
			AlertType, 
			AlertText, 
			NULL, 
			0, 
			AlerteeGroupID
		FROM 
			QCheck_Alerts
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	SELECT 
		@FreqType = FreqType 
	FROM 
		QCheck_Schedule
	WHERE
		[ID] = @ScheduleID
	
	EXEC QCheck_SetUpcomingInstance @NewInstanceID

	IF @FreqType = 1 BEGIN

		EXEC QCheck_ActivateInstance @NewInstanceID, @NowDate

	END ELSE BEGIN

		EXEC QCheck_ActivateFutureInstance @NewInstanceID

	END
	
END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_GetMyChecklistsByFolder]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- This stored procedure will retrieve all data for the checklists the user 
-- is assigned to
create PROCEDURE [dbo].[QCheck2_GetMyChecklistsByFolder](
	@UserID int,
	@memberGroupID int = 0,
	@managerGroupID int = 0,
	@isAdmin bit = 0,
	@search varchar(200) = '',
	@parentID int = 0
) AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @tblResults TABLE(
		ID int
	)

	DECLARE @tblAssigned TABLE(
		ID int
	)

	DECLARE @tblManaged TABLE(
		ID int
	)

	DECLARE @tblActive TABLE(
		ID int
	)

	-- Get all the ChecklistIDs the user is assigned to
	INSERT INTO @tblAssigned
		SELECT DISTINCT 
			c.ID
		FROM	
			QCheck_Checklists c (nolock)
			INNER JOIN QCheck_ChecklistInstances ci (nolock)
				ON c.[ID] = ci.ChecklistID
				AND c.IsDeleted = 0
				AND ci.IsDeleted = 0
			INNER JOIN QCheck_Assignments a (nolock)
				ON ci.[ID] = a.InstanceID
				AND a.IsDeleted = 0
			INNER JOIN QCheck_Groups g (nolock)
				ON a.GroupID = g.[ID]
			INNER JOIN QCheck_GroupMembership gm (nolock)
				ON g.[ID] = gm.GroupID
				AND (
					gm.UserID = @UserID 
					OR @isAdmin = 1
				)

	-- Get all the ChecklistIDs the user controls
	INSERT INTO @tblManaged
		SELECT DISTINCT 
			c.[ID]
		FROM	
			QCheck_Checklists c (nolock)
			INNER JOIN QCheck_ChecklistManagers cm (nolock)
				ON cm.ChecklistID = c.[ID]
				AND cm.IsDeleted = 0
				AND c.IsDeleted = 0
			INNER JOIN QCheck_Groups g (nolock)
				ON g.[ID] = cm.ManagerGroupID
			INNER JOIN QCheck_GroupMembership gm (nolock)
				ON gm.GroupID = g.[ID]
				AND (
					gm.UserID = @UserID 
					OR @isAdmin = 1
				)
				


	-- Get all active checklists
	INSERT INTO @tblActive
		SELECT DISTINCT 
			c.id
		FROM 
			qcheck_checklists c (nolock)
		INNER JOIN qcheck_checklistinstances ci (nolock)
			ON ci.checklistid = c.id
		INNER JOIN qcheck_activechecklists ac (nolock)
			ON ac.instanceid = ci.id


	-- If no group filter was supplied, the result set is everything assigned/managed through any group
	IF @memberGroupID = 0 AND @managergroupID = 0  BEGIN

		INSERT INTO @tblResults
			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN @tblAssigned tm
					ON tm.ID = c.ID

			UNION

			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN @tblManaged tm
					ON tm.ID = c.ID

	-- If a group filter was supplied, the result set is everything assigned to the user through that group
	END ELSE BEGIN

		INSERT INTO @tblResults
			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN @tblAssigned tm
					ON tm.ID = c.ID
				LEFT OUTER JOIN QCheck_ChecklistInstances ci (nolock)
					ON ci.ChecklistID = c.ID
					AND ci.IsDeleted = 0
				LEFT OUTER JOIN QCheck_Assignments a (nolock)
					ON a.InstanceID = ci.ID
					AND a.IsDeleted = 0
					AND a.GroupID = @memberGroupID
			WHERE
				(
					a.ID IS NOT NULL 
					OR @memberGroupID = 0
				)

			UNION

			SELECT DISTINCT 
				c.ID
			FROM 
				qcheck_checklists c (nolock)
				INNER JOIN @tblManaged tm
					ON tm.ID = c.ID
				LEFT OUTER JOIN QCheck_ChecklistInstances ci (nolock)
					ON ci.ChecklistID = c.ID
					AND ci.IsDeleted = 0
				LEFT OUTER JOIN QCheck_Assignments a (nolock)
					ON a.InstanceID = ci.ID
					AND a.IsDeleted = 0
					AND a.GroupID = @memberGroupID
			WHERE
				(
					a.ID IS NOT NULL
					OR @memberGroupID = 0
				)
				AND 
				(
					@managerGroupID = 0 OR
					c.id in (
					 select cm.checklistid from 
						QCheck_ChecklistManagers cm (nolock)
					 inner JOIN QCheck_Groups managerg (nolock)
								  ON managerg.ID = cm.ManagerGroupID
					 inner join QCheck_GroupMembership managergm (nolock)
								  ON managergm.GroupID = managerg.ID
								  AND managergm.GroupID = @managergroupID
					 where cm.IsDeleted = 0) 
				)

	END
	
	DECLARE @Results TABLE (
		NodeName varchar(500),
		ID int,
		FolderID int,
		ParentID int,
		Type int,
		Active int,
		Template int
	);
		
	-- If no search string was supplied, return the full result set with folders
	IF LEN(LTRIM(RTRIM(@search))) = 0 BEGIN
		
		INSERT INTO @Results (
		NodeName,
		ID,
		FolderID,
		ParentID,
		Type,
		Active,
		Template) (
		
		SELECT DISTINCT 
			c.Name as NodeName, 
			c.ID,
			c.ID as FolderID,
			isNull(fc.FolderID, 0) as ParentID,
			1 as Type,
			case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
			c.Template
		FROM 
			@tblResults tr
			INNER JOIN qcheck_checklists c (nolock)
				ON tr.ID = c.ID
			LEFT OUTER JOIN @tblActive ac
				ON ac.ID = c.ID
			LEFT OUTER JOIN QCheck_FolderChecklists fc (nolock)
				ON fc.ChecklistID = c.ID
				AND fc.FolderID IN (
					SELECT ID 
					FROM QCheck_Folders 
					WHERE UserID = @UserID
				)
		
		UNION ALL
		
		SELECT 
			'All Tasks' as NodeName, 
			0 As ID,
			0 as FolderID,
			null as ParentID,
			2 as Type,
			0 as Active,
			0 as Template
	
		UNION ALL
			
		SELECT 
			FolderName as NodeName,
			ID,
			ID as FolderID,
			ParentFolder as ParentID,
			3 as Type,
			0 as Active,
			0 as Template
		FROM
			QCheck_Folders (nolock)
		WHERE
			UserID = @UserID
	);
		SELECT * FROM @Results 
		WHERE ParentID = @parentID
		ORDER BY 
			Type desc, 
			NodeName
	-- If a search string was supplied, filter the result set by that search string
	END ELSE BEGIN

		INSERT INTO @Results (
			NodeName,
			ID,
			FolderID,
			ParentID,
			Type,
			Active,
			Template) (

		SELECT DISTINCT 
			c.Name as NodeName, 
			c.ID,
			c.ID as FolderID,
			isNull(fc.FolderID, 0) as ParentID,
			1 as Type,
			case when ac.ID IS NULL THEN 0 ELSE 1 END As Active,
			c.Template
		FROM 
			@tblResults tr
			INNER JOIN qcheck_checklists c (nolock)
				ON tr.ID = c.ID
			LEFT OUTER JOIN	QCheck_Items i (nolock)
				ON i.ChecklistID = c.ID
			LEFT OUTER JOIN @tblActive ac
				ON ac.ID = c.ID
			LEFT OUTER JOIN QCheck_FolderChecklists fc (nolock)
				ON fc.ChecklistID = c.ID
				AND fc.FolderID IN (
					SELECT ID 
					FROM QCheck_Folders 
					WHERE UserID = @UserID
				)
		WHERE
			c.Name LIKE ('%'+@search+'%') 
			OR i.Text like ('%'+@search+'%')
		
		UNION ALL
		
		SELECT 
			'All Tasks' as NodeName, 
			0 As ID,
			0 as FolderID,
			null as ParentID,
			2 as Type,
			0 as Active,
			0 as Template
	
		UNION ALL
			
		SELECT 
			FolderName as NodeName,
			ID,
			ID as FolderID,
			ParentFolder as ParentID,
			3 as Type,
			0 as Active,
			0 as Template
		FROM
			QCheck_Folders (nolock)
		WHERE
			UserID = @UserID
	);		
		SELECT * FROM @Results 
		WHERE ParentID = @parentID
		ORDER BY 
			Type desc, 
			NodeName

	END

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_GetUserInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck2_GetUserInfo](
	@loginID varchar(50),
	@ID int output,
	@GroupID int output,
	@Beta bit = 0 output, --weird-looking syntax but it's an optional parameter
	@Admin bit output,
	@DepartmentAdmin bit output,
	@Priorities bit output,
	--@FullName varchar(100) output,
	@Email varchar(100) output
)
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @impersonateID int
	DECLARE @origID int


	SELECT @origID=[ID] FROM
		QCheck_Users
	WHERE
		ShortName = @loginID

	--if @loginID = 'kcroft' set @origID = 412

	SELECT @impersonateID = impersonateUserID
	FROM
		QCheck_Impersonate
	WHERE
		UserID = @origID
	AND 
		isDeleted = 0

	SELECT @ID = isNull(@impersonateID, @origID)
	
	SELECT  
		@Admin=Admin,
		@Beta=Beta,
		@DepartmentAdmin = DepartmentAdmin, 
		@Priorities = Priorities/*, @FullName = FullName*/, 
		@Email = Email
	FROM
		QCheck_Users
	WHERE
		ID = @ID

	SELECT @GroupID = ID
	FROM QCheck_Groups
	WHERE Owner = @ID
	AND SingleMemberGroup = 1

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_GetUserInfo_ByEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[QCheck2_GetUserInfo_ByEmail](
	@Email varchar(100),
	@LoginID varchar(50) output,
	@ID int output,
	@GroupID int output,
	@Beta bit = 0 output, --weird-looking syntax but it's an optional parameter
	@Admin bit output,
	@DepartmentAdmin bit output,
	@Priorities bit output,
	--@FullName varchar(100) output,	
	@IncludeDeleted bit = 0
)
 AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @impersonateID int
	DECLARE @origID int

	SELECT @origID=[ID] FROM
		QCheck_Users
	WHERE
		Email = @Email
		AND (@IncludeDeleted = 1 OR IsDeleted = 0)

	--if @loginID = 'kcroft' set @origID = 412

	SELECT @impersonateID = impersonateUserID
	FROM
		QCheck_Impersonate
	WHERE
		UserID = @origID
	AND 
		isDeleted = 0

	SELECT @ID = isNull(@impersonateID, @origID)
	
	SELECT @LoginId = u.ShortName
	,@Admin=u.Admin
	,@Beta= u.Beta
	,@DepartmentAdmin = u.DepartmentAdmin
	,@Priorities = u.Priorities
	--,@FullName = FullName
	--,@Email = u.Email
	FROM
		QCheck_Users u
	WHERE
		u.ID = @ID		

	SELECT @GroupID = ID
	FROM QCheck_Groups
	WHERE Owner = @ID
	AND SingleMemberGroup = 1

	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[QCheck2_LoadTimeReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QCheck2_LoadTimeReport]
--@StartDate datetime,
--@EndDate datetime

AS

SELECT u.FullName as [User], UserID, PageName AS 'Page Name', ServerLoadTime AS 'Server Time', ClientLoadTime AS 'Client Time', TotalTime AS 'Total Load Time', dt as 'DateTime', ReportName AS 'Report Name', LastOpened, Browser
FROM QCheck_LoadTimes LT INNER JOIN QCheck_Users U on LT.UserID = U.ID
WHERE (PageName = 'MyStatus.aspx' or PageName = 'MyInbox.aspx')--or PageName = 'Report/Comments')
AND ReportName is not null
--AND dt < dateadd(dd, 1, @EndDate)
--AND dt > @StartDate

--CONVERT(CHAR(8),GETDATE(),110) = CONVERT(CHAR(8),dt,110)
GO
/****** Object:  StoredProcedure [dbo].[QPI_Calc_Grade]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE        procedure [dbo].[QPI_Calc_Grade] 
	@daysago int,
	@numdays int = 30
as
begin
	set nocount on

		declare @asof_date datetime
		set @asof_date = dateadd(day, -1 * @daysago, convert(varchar, getdate(), 101))

		exec QPI_Get_Data @asof_date, @numdays

		select d.fullname,
			100 
			+ d.ControllerDeductions * 
				CASE WHEN d.issupervisor = 1 THEN
					p.SupervisorController
			 	 ELSE
					p.NonSupervisorController
				END
			+ d.supervisordeductions * p.supervisor
			+ d.ipcomments * p.interestedparty
			+ d.overdue * p.overdue
			+ d.checklistoverdue * p.checklistoverdue
				AS Score,
			d.supervisorcomments + d.controllercomments + d.ipcomments
				As TotalComments,
			d.ControllerComments,
			d.SupervisorComments,
			d.IsSupervisor,
			abs(d.ControllerDeductions * 
				CASE WHEN d.issupervisor = 1 THEN
					p.SupervisorController
			 	 ELSE
					p.NonSupervisorController
				END) as ControllerDeductions,
			abs(d.supervisordeductions * p.supervisor) As SupervisorDeductions,
			abs(d.overdue * p.overdue) as OverdueDeduction,
			abs(d.checklistoverdue * p.checklistoverdue) as ChecklistOverdueDeduction,
			abs(d.ipcomments * p.interestedparty) as IPBonus
		from qpi_data d
		inner join qpi_points p
		on 1=1
		order by 1


	set nocount off		
end










GO
/****** Object:  StoredProcedure [dbo].[QPI_CalculateIISTime]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE               procedure [dbo].[QPI_CalculateIISTime]
	@asof_date datetime = null
AS 

if @asof_date is null
	set @asof_date = getdate() - 1

declare @shortname varchar(50)
declare @dt datetime
declare @endtime datetime
declare @prevname varchar(50)
declare @starttime datetime
declare @issupervisor int
declare @previousissupervisor int
declare @startEnd varchar(20)
declare @lookingfor varchar(20)
declare @maxminutes int

set @maxminutes = 20
set @dt = 0
set @prevname = ''
set @previousissupervisor = 0
set @lookingfor = 'START'

/*delete from IIS_TIME
WHERE convert(varchar, dt, 101)  = convert(varchar, @asof_date, 101)
*/

declare iis_curs cursor for
select shortname, dt, isSupervisor, startEnd
from iislog_startend
where convert(varchar, dt, 101) = convert(varchar, @asof_date, 101) 
order by 1, 3, 2


OPEN iis_curs
FETCH NEXT FROM iis_curs INTO @shortname, @dt, @issupervisor, @startEnd
WHILE @@FETCH_STATUS = 0 BEGIN
	
	if @prevname <> @shortname OR @previousissupervisor <> @issupervisor
		SET @lookingfor = 'START'

	if @startEnd = @lookingfor
	BEGIN
		IF @lookingfor = 'START'
		BEGIN
			SET @lookingfor = 'END'
			SET @starttime = @dt
		END
		ELSE
		BEGIN
			SET @lookingfor = 'START'
			
			SET @endtime = @dt

			IF datediff(minute, @starttime, @endtime) <= @maxminutes
			BEGIN
				UPDATE IIS_TIME
				SET totalminutes = totalminutes + datediff(second, @starttime, @endtime)/60.0
				where shortname = @shortname
				and dt = convert(varchar, @dt, 101)
				and issupervisor = @issupervisor
				
				if @@rowcount = 0 
					INSERT INTO IIS_TIME
						SELECT @shortname, 
						convert(varchar, @endtime, 101), 
						datediff(second, @starttime, @endtime)/60.0,
						@issupervisor
			END
		END
	END
	set @prevname = @shortname
	SET @previousissupervisor = @issupervisor
FETCH NEXT FROM iis_curs INTO @shortname, @dt, @issupervisor, @startEnd
END
CLOSE iis_curs
DEALLOCATE iis_curs





GO
/****** Object:  StoredProcedure [dbo].[QPI_CommentCharacters]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                 procedure [dbo].[QPI_CommentCharacters]
	@daysago int = 0
AS 

declare @today datetime

set @today = convert(varchar, getdate() - @daysago, 101)

select fullname as name, 
	case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END as role,
	sum(len(comments)) as totallast30days,
	
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -1, 101) then
			len(comments)
		else
			0
		end
	) as yesterday,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -2, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -3, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -4, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -5, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -6, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -7, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -8, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -9, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -10, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -11, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -12, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -13, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -14, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -15, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -16, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -17, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -18, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -19, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -20, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -21, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -22, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -23, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -24, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -25, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -26, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -27, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -28, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -29, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -30, 101) then
			len(comments)
		else
			0
		end
	)
			from 
			(
			select distinct  comments, fullname, commentdt, interestedparty
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = c.foreignkeyid
					and c.specialtask = 0
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null
		
			union all

			--supervisor general
			select distinct  comments, fullname, commentdt, interestedparty
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null

			union all

			--controller normal
			select distinct  comments, fullname, commentdt, null
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = c.foreignkeyid
					and c.specialtask = 0
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null

			union all

			--controller general
			select distinct  comments, fullname, commentdt, null
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null

			--archive!
			union all

			select distinct  comments, fullname, commentdt, interestedparty
			FROM QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = c.foreignkeyid
					and c.specialtask = 0
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null
		
			union all

			--supervisor general
			select distinct  comments, fullname, commentdt, interestedparty
			FROM QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null

			union all

			--controller normal
			select distinct  comments, fullname, commentdt, null
			FROM QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = c.foreignkeyid
					and c.specialtask = 0
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null

			union all

			--controller general
			select distinct  comments, fullname, commentdt, null
			FROM QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt*/
			where commentdt >= @today - 30
				and commentdt <=@today
				--and oh.reportID is null
			) a

		group by fullname, case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END
			order by 1, 2 desc










GO
/****** Object:  StoredProcedure [dbo].[QPI_CommentCharacters_bak]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE               procedure [dbo].[QPI_CommentCharacters_bak]
AS 

declare @today datetime

set @today = convert(varchar, getdate(), 101)

select fullname as name, 
	case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END as role,
	sum(len(comments)) as totallast30days,
	
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -1, 101) then
			len(comments)
		else
			0
		end
	) as yesterday,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -2, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -3, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -4, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -5, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -6, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -7, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -8, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -9, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -10, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -11, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -12, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -13, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -14, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -15, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -16, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -17, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -18, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -19, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -20, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -21, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -22, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -23, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -24, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -25, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -26, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -27, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -28, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -29, 101) then
			len(comments)
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -30, 101) then
			len(comments)
		else
			0
		end
	)
			from 
			(
			select distinct  comments, fullname, commentdt, interestedparty
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where commentdt >= @today - 30
				and commentdt <=@today
				and oh.reportID is null
		
			union all

			--supervisor general
			select distinct  comments, fullname, commentdt, interestedparty
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where commentdt >= @today - 30
				and commentdt <=@today
				and oh.reportID is null

			union all

			--controller normal
			select distinct  comments, fullname, commentdt, null
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where commentdt >= @today - 30
				and commentdt <=@today
				and oh.reportID is null

			union all

			--controller general
			select distinct  comments, fullname, commentdt, null
			FROM QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where commentdt >= @today - 30
				and commentdt <=@today
				and oh.reportID is null
			) a

		group by fullname, case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END
			order by 1, 2 desc








GO
/****** Object:  StoredProcedure [dbo].[QPI_Comments_ByReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE                     procedure [dbo].[QPI_Comments_ByReport] 
	@daysago int = 0
as
begin
	set nocount on

declare @today datetime

set @today = convert(varchar, getdate() - @daysago, 101)


declare @resultstbl table(
	userid int,
	fullname varchar(100),
	role varchar(20),
	reportName varchar(100),
	reportID int,
	totallast40days int,
	yesterday int, 
	days2 int,
	days3 int,
	days4 int,
	days5 int,
	days6 int,
	days7 int,
	days8 int,
	days9 int,
	days10 int,
	days11 int,
	days12 int,
	days13 int,
	days14 int,
	days15 int,
	days16 int,
	days17 int,
	days18 int,
	days19 int,
	days20 int,
	days21 int,
	days22 int,
	days23 int,
	days24 int,
	days25 int,
	days26 int,
	days27 int,
	days28 int,
	days29 int,
	days30 int,
	days31 int,
	days32 int,
	days33 int,
	days34 int,
	days35 int,
	days36 int,
	days37 int,
	days38 int,
	days39 int,
	days40 int
)

	insert into @resultstbl
	select 
	a.userid,
	fullname as name, 
	case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END as role,
	a.name as reportName,
	a.reportID,
	count(a.ID) as totallast40days,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -1, 101) then
			1
		else
			0
		end
	) as yesterday,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -2, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -3, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -4, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -5, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -6, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -7, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -8, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -9, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -10, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -11, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -12, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -13, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -14, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -15, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -16, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -17, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -18, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -19, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -20, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -21, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -22, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -23, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -24, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -25, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -26, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -27, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -28, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -29, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -30, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -31, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -32, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -33, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -34, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -35, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -36, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -37, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -38, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -39, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -40, 101) then
			1
		else
			0
		end
	)
			from 
			(

			--supervisor normal
			select distinct u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today
		
			union all

			--supervisor general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--controller normal
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--controller general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--archive!

			
			--supervisor normal
			select distinct u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today
		
			union all

			--supervisor general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--controller normal
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--controller general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			) a
		LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = a.reportID
				AND oh.startdt < @today
				AND oh.enddt > @today - 40
		WHERE
			oh.reportID is null

		group by fullname, case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END, a.userid, a.reportID, a.name


		insert into @resultstbl
		select 
			a.userid, 
			a.fullname as name, 
			case when InterestedParty is null then 'Controller'
				else
					CASE WHEN InterestedParty = 1 Then
						'Interested Party'
					ELSE
						'Supervisor'
					END
				END as role,
			a.name as reportName,
			a.reportID,
			0, 
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0
		from 
			(
				select u.id as userid, 
					u.fullname, 
					dbo.QStatus_GetUserNames(r.ID) + r.Name as Name,
					r.id as reportID,
					s.interestedparty
				from qpi_users u
				inner join qcheck_groupmembership gm
					on gm.userID = u.id	
				inner join qcheck_groups g
					on g.id = gm.groupID
				inner join qstatus_supervisors s
					on g.ID = s.supervisorgroupid
				inner join  qstatus_report r
					on s.reportid = r.id
					and r.isdeleted = 0

				union all
			
				select u.id as userid, 
					u.fullname, 
					dbo.QStatus_GetUserNames(r.ID) + r.Name as Name,
					r.id as reportID,
					null
				from qpi_users u
				inner join qcheck_groupmembership gm
					on gm.userID = u.id	
				inner join qcheck_groups g
					on g.id = gm.groupID
				inner join qstatus_groupreport gr
					on gr.groupID = g.ID
				inner join  qstatus_report r
					on gr.reportid = r.id
					and r.isdeleted = 0
				
			) as a 
		left outer join @resultstbl b
		on a.userid = b.userid
		and a.reportID = b.reportID
		LEFT OUTER JOIN QStatus_OnHold oh
			ON oh.reportID = a.reportID
			AND oh.startdt < @today
			AND oh.enddt > @today - 40
		where b.reportID is null
			and oh.reportID is null


		select 
		fullname,
		role,
		reportName,
		totallast40days,
		yesterday, 
		days2,
		days3,
		days4,
		days5,
		days6,
		days7,
		days8,
		days9,
		days10,
		days11,
		days12,
		days13,
		days14,
		days15,
		days16,
		days17,
		days18,
		days19,
		days20,
		days21,
		days22,
		days23,
		days24,
		days25,
		days26,
		days27,
		days28,
		days29,
		days30,
		days31,
		days32,
		days33,
		days34,
		days35,
		days36,
		days37,
		days38,
		days39,
		days40
		from @resultstbl
		order by 1, 2, 3 desc



	set nocount off		
end























GO
/****** Object:  StoredProcedure [dbo].[QPI_Comments_ByReport_bak]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE                    procedure [dbo].[QPI_Comments_ByReport_bak] 
	
as
begin
	set nocount on

declare @today datetime

set @today = convert(varchar, getdate(), 101)


declare @resultstbl table(
	userid int,
	fullname varchar(100),
	role varchar(20),
	reportName varchar(100),
	reportID int,
	totallast40days int,
	yesterday int, 
	days2 int,
	days3 int,
	days4 int,
	days5 int,
	days6 int,
	days7 int,
	days8 int,
	days9 int,
	days10 int,
	days11 int,
	days12 int,
	days13 int,
	days14 int,
	days15 int,
	days16 int,
	days17 int,
	days18 int,
	days19 int,
	days20 int,
	days21 int,
	days22 int,
	days23 int,
	days24 int,
	days25 int,
	days26 int,
	days27 int,
	days28 int,
	days29 int,
	days30 int,
	days31 int,
	days32 int,
	days33 int,
	days34 int,
	days35 int,
	days36 int,
	days37 int,
	days38 int,
	days39 int,
	days40 int
)

	insert into @resultstbl
	select 
	a.userid,
	fullname as name, 
	case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END as role,
	a.name as reportName,
	a.reportID,
	count(a.ID) as totallast40days,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -1, 101) then
			1
		else
			0
		end
	) as yesterday,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -2, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -3, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -4, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -5, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -6, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -7, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -8, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -9, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -10, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -11, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -12, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -13, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -14, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -15, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -16, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -17, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -18, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -19, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -20, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -21, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -22, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -23, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -24, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -25, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -26, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -27, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -28, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -29, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -30, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -31, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -32, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -33, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -34, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -35, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -36, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -37, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -38, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -39, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -40, 101) then
			1
		else
			0
		end
	)
			from 
			(

			--supervisor normal
			select distinct u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today
		
			union all

			--supervisor general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--controller normal
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			union all

			--controller general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 40
				and commentdt <=@today

			) a
		LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = a.reportID
				AND oh.startdt < @today
				AND oh.enddt > @today - 40
		WHERE
			oh.reportID is null

		group by fullname, case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END, a.userid, a.reportID, a.name


		insert into @resultstbl
		select 
			a.userid, 
			a.fullname as name, 
			case when InterestedParty is null then 'Controller'
				else
					CASE WHEN InterestedParty = 1 Then
						'Interested Party'
					ELSE
						'Supervisor'
					END
				END as role,
			a.name as reportName,
			a.reportID,
			0, 
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0
		from 
			(
				select u.id as userid, 
					u.fullname, 
					dbo.QStatus_GetUserNames(r.ID) + r.Name as Name,
					r.id as reportID,
					s.interestedparty
				from qpi_users u
				inner join qcheck_groupmembership gm
					on gm.userID = u.id	
				inner join qcheck_groups g
					on g.id = gm.groupID
				inner join qstatus_supervisors s
					on g.ID = s.supervisorgroupid
				inner join  qstatus_report r
					on s.reportid = r.id
					and r.isdeleted = 0

				union all
			
				select u.id as userid, 
					u.fullname, 
					dbo.QStatus_GetUserNames(r.ID) + r.Name as Name,
					r.id as reportID,
					null
				from qpi_users u
				inner join qcheck_groupmembership gm
					on gm.userID = u.id	
				inner join qcheck_groups g
					on g.id = gm.groupID
				inner join qstatus_groupreport gr
					on gr.groupID = g.ID
				inner join  qstatus_report r
					on gr.reportid = r.id
					and r.isdeleted = 0
				
			) as a 
		left outer join @resultstbl b
		on a.userid = b.userid
		and a.reportID = b.reportID
		LEFT OUTER JOIN QStatus_OnHold oh
			ON oh.reportID = a.reportID
			AND oh.startdt < @today
			AND oh.enddt > @today - 40
		where b.reportID is null
			and oh.reportID is null


		select 
		fullname,
		role,
		reportName,
		totallast40days,
		yesterday, 
		days2,
		days3,
		days4,
		days5,
		days6,
		days7,
		days8,
		days9,
		days10,
		days11,
		days12,
		days13,
		days14,
		days15,
		days16,
		days17,
		days18,
		days19,
		days20,
		days21,
		days22,
		days23,
		days24,
		days25,
		days26,
		days27,
		days28,
		days29,
		days30,
		days31,
		days32,
		days33,
		days34,
		days35,
		days36,
		days37,
		days38,
		days39,
		days40
		from @resultstbl
		order by 1, 2, 3 desc



	set nocount off		
end






















GO
/****** Object:  StoredProcedure [dbo].[QPI_Comments_ByReport_Date]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE                     procedure [dbo].[QPI_Comments_ByReport_Date] 
	@today datetime = null
as
begin

	set nocount on

--declare @today datetime

--set @today = convert(varchar, getdate() - @daysago, 101)
if @today is null
	set @today = getdate()

declare @resultstbl table(
	userid int,
	fullname varchar(100),
	role varchar(20),
	reportName varchar(100),
	reportID int,
	totallast30days int,
	yesterday int, 
	days2 int,
	days3 int,
	days4 int,
	days5 int,
	days6 int,
	days7 int,
	days8 int,
	days9 int,
	days10 int,
	days11 int,
	days12 int,
	days13 int,
	days14 int,
	days15 int,
	days16 int,
	days17 int,
	days18 int,
	days19 int,
	days20 int,
	days21 int,
	days22 int,
	days23 int,
	days24 int,
	days25 int,
	days26 int,
	days27 int,
	days28 int,
	days29 int,
	days30 int /*,
	days31 int,
	days32 int,
	days33 int,
	days34 int,
	days35 int,
	days36 int,
	days37 int,
	days38 int,
	days39 int,
	days40 int*/
)

	insert into @resultstbl
	select 
	a.userid,
	fullname as name, 
	case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END as role,
	a.name as reportName,
	a.reportID,
	count(a.ID) as totallast30days,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -1, 101) then
			1
		else
			0
		end
	) as yesterday,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -2, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -3, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -4, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -5, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -6, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -7, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -8, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -9, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -10, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -11, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -12, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -13, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -14, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -15, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -16, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -17, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -18, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -19, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -20, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -21, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -22, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -23, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -24, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -25, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -26, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -27, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -28, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -29, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -30, 101) then
			1
		else
			0
		end
	)/*,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -31, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -32, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -33, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -34, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -35, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -36, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -37, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -38, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -39, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -40, 101) then
			1
		else
			0
		end
	)*/
			from 
			(

			--supervisor normal
			select distinct u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today
		
			union all

			--supervisor general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today

			union all

			--controller normal
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today

			union all

			--controller general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today

			union all

			--archive!

			
			--supervisor normal
			select distinct u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today
		
			union all

			--supervisor general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, interestedparty, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today

			union all

			--controller normal
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			left outer join qcheck_activechecklists ac
				on ac.id = c.foreignkeyid
			left outer join qcheck_activechecklistarchive aca
				on aca.id = c.foreignkeyid
			inner join qstatus_activechecklisttasktype actt
				on actt.activechecklistid = ac.id
				or actt.activechecklistid = aca.id
			inner join qstatus_tasktypes tt
				on tt.id = actt.tasktype
				and c.specialtask = 0
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today

			union all

			--controller general
			select distinct  u.id as userid, c.ID,  fullname, commentdt, null, dbo.QStatus_GetUserNames(r.ID) + r.Name as Name, r.id as reportID
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
				and r.isdeleted = 0
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today -30 --- 40
				and commentdt <=@today

			) a
		LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = a.reportID
				AND oh.startdt < @today
				AND oh.enddt > @today -30 --- 40
		WHERE
			oh.reportID is null

		group by fullname, case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END, a.userid, a.reportID, a.name


		insert into @resultstbl
		select 
			a.userid, 
			a.fullname as name, 
			case when InterestedParty is null then 'Controller'
				else
					CASE WHEN InterestedParty = 1 Then
						'Interested Party'
					ELSE
						'Supervisor'
					END
				END as role,
			a.name as reportName,
			a.reportID,
			0, 
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0/*,
			0, 0, 0, 0, 0,
			0, 0, 0, 0, 0*/
		from 
			(
				select u.id as userid, 
					u.fullname, 
					dbo.QStatus_GetUserNames(r.ID) + r.Name as Name,
					r.id as reportID,
					s.interestedparty
				from qpi_users u
				inner join qcheck_groupmembership gm
					on gm.userID = u.id	
				inner join qcheck_groups g
					on g.id = gm.groupID
				inner join qstatus_supervisors s
					on g.ID = s.supervisorgroupid
				inner join  qstatus_report r
					on s.reportid = r.id
					and r.isdeleted = 0

				union all
			
				select u.id as userid, 
					u.fullname, 
					dbo.QStatus_GetUserNames(r.ID) + r.Name as Name,
					r.id as reportID,
					null
				from qpi_users u
				inner join qcheck_groupmembership gm
					on gm.userID = u.id	
				inner join qcheck_groups g
					on g.id = gm.groupID
				inner join qstatus_groupreport gr
					on gr.groupID = g.ID
				inner join  qstatus_report r
					on gr.reportid = r.id
					and r.isdeleted = 0
				
			) as a 
		left outer join @resultstbl b
		on a.userid = b.userid
		and a.reportID = b.reportID
		LEFT OUTER JOIN QStatus_OnHold oh
			ON oh.reportID = a.reportID
			AND oh.startdt < @today
			AND oh.enddt > @today -30 --- 40
		where b.reportID is null
			and oh.reportID is null


		select 
		fullname AS 'User Name',
		role AS 'Role',
		reportName AS 'Report Name',
		totallast30days AS 'Last 30 Days',
		yesterday AS 'Yesterday', 
		days2,
		days3,
		days4,
		days5,
		days6,
		days7,
		days8,
		days9,
		days10,
		days11,
		days12,
		days13,
		days14,
		days15,
		days16,
		days17,
		days18,
		days19,
		days20,
		days21,
		days22,
		days23,
		days24,
		days25,
		days26,
		days27,
		days28,
		days29,
		days30/*,
		days31,
		days32,
		days33,
		days34,
		days35,
		days36,
		days37,
		days38,
		days39,
		days40*/
		from @resultstbl
		order by 1, 2, 3 desc



	set nocount off		
end
GO
/****** Object:  StoredProcedure [dbo].[QPI_Get_Data]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                        procedure [dbo].[QPI_Get_Data]
	@asof_date datetime,
	@numdays int = 30
as
begin
	set nocount on

	delete from  QPI_Data

	


	DECLARE @ControllerDays int, @SupervisorDays int

	SELECT @ControllerDays = ControllerDays, @SupervisorDays = SupervisorDays
	FROM QPI_Points

	insert into QPI_Data (id, fullname)
	SELECT id, fullname
	from qpi_users u	

	declare @comments table	
		(id int	identity(1,1)
			, UserID	int
			, CommentDt	datetime
		)

	declare @controllercomments table
		(id int	identity(1,1)
			, UserID	int
			, CommentDt	datetime
		)

	declare @t table
		(id int	identity(1,1)
			, UserID	int
			, CommentDt	datetime
		)

	--set supervisor bit
	update QPI_Data
		set isSupervisor = 1
	WHERE id in(
		select distinct u.ID
			from QStatus_Report R
			INNER JOIN QStatus_Supervisors SR
					on SR.reportid = R.id
					and sr.interestedparty = 0
					and r.isdeleted = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
			INNER JOIN qpi_users u
					on u.id = gm.UserID
					and u.isdeleted = 0
			LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < @asof_date
				AND oh.enddt > @asof_date - @numdays
			WHERE oh.reportID is null
	)

	--get controller comments
	insert into @comments (commentdt, UserID)
			select distinct c.commentdt, c.UserID
			from QStatus_Comments C
					inner join qpi_users u	
						on u.id = c.userid
				INNER JOIN QCheck_ActiveChecklists AC
					on c.foreignkeyID = ac.id
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = ac.id
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
					and c.SpecialTask = 0	
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and R.IsDeleted = 0
				inner join QStatus_GroupReport gr
					on gr.reportid = R.id
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID= g.ID
					and gm.UserID = c.UserID
				LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
				WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
					and oh.reportID is null
			UNION ALL

			select distinct c.commentdt, c.UserID
			from QStatus_Comments C
					inner join qpi_users u	
						on u.id = c.userid
				INNER JOIN QCheck_ActiveChecklistArchive AC
					on c.foreignkeyID = ac.id
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = ac.id
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
					and c.SpecialTask = 0			
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and R.IsDeleted = 0
				inner join QStatus_GroupReport gr
					on gr.reportid = R.id
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID= g.ID
					and gm.UserID = c.UserID
				LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
				WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
					and oh.reportID is null
			UNION ALL
			
			select distinct c.commentdt, c.UserID
				from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
				inner join qstatus_specialtasks st
					on st.id = c.foreignkeyid
				inner join qstatus_tasktypes tt
					on tt.id = st.tasktype
					and c.specialtask = 1
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and R.IsDeleted = 0
				inner join QStatus_GroupReport gr
					on gr.reportid = R.id
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID= g.ID
					and gm.UserID = c.UserID
				LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
				WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null
			order by 2, 1

	-- archive!
	insert into @comments (commentdt, UserID)
			select distinct c.commentdt, c.UserID
			from QStatus_CommentArchive C
					inner join qpi_users u	
						on u.id = c.userid
				INNER JOIN QCheck_ActiveChecklists AC
					on c.foreignkeyID = ac.id
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = ac.id
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
					and c.SpecialTask = 0	
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and R.IsDeleted = 0
				inner join QStatus_GroupReport gr
					on gr.reportid = R.id
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID= g.ID
					and gm.UserID = c.UserID
				LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
				WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
					and oh.reportID is null
			UNION ALL

			select distinct c.commentdt, c.UserID
			from QStatus_CommentArchive C
					inner join qpi_users u	
						on u.id = c.userid
				INNER JOIN QCheck_ActiveChecklistArchive AC
					on c.foreignkeyID = ac.id
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = ac.id
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
					and c.SpecialTask = 0			
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and R.IsDeleted = 0
				inner join QStatus_GroupReport gr
					on gr.reportid = R.id
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID= g.ID
					and gm.UserID = c.UserID
				LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
				WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
					and oh.reportID is null
			UNION ALL
			
			select distinct c.commentdt, c.UserID
				from QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
				inner join qstatus_specialtasks st
					on st.id = c.foreignkeyid
				inner join qstatus_tasktypes tt
					on tt.id = st.tasktype
					and c.specialtask = 1
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and R.IsDeleted = 0
				inner join QStatus_GroupReport gr
					on gr.reportid = R.id
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID= g.ID
					and gm.UserID = c.UserID
				LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
				WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null
			order by 2, 1


	insert into @controllercomments (commentdt, UserID)
		select commentdt, UserID
		from @comments

	--update controller comments
	update qpi_data
		set controllercomments = c.cnt
	from qpi_data d
	inner join 
		(select UserID, count(commentdt) as cnt
		from @comments 
		group by UserID) c
	on d.id = c.UserID

	--add a placeholder for start and end time
	insert into @t (commentdt, UserID)
		select c.commentdt, c.UserID
		from @comments c
		union all
		select distinct @asof_date-@numdays - 1, u.id
		from qpi_users u	
		union all
		select distinct @asof_date, u.id
		from qpi_users u	
		order by 2, 1

	--update controller deductions
	update qpi_data
		set ControllerDeductions = t.ControllerDeductions
	from qpi_data d
	inner join (
		select t1.UserID,
			 sum(((DATEDIFF(day, t1.commentDt, t2.commentDt)-1) / @ControllerDays)) as ControllerDeductions
		from @t t1
			inner join @t t2
				on t1.UserID = t2.UserID
					and t1.id+1 = t2.id
		where convert(varchar, t2.commentdt, 101) > DATEADD(day, @ControllerDays, convert(varchar, t1.commentdt, 101))
		group by t1.UserID
	) t
	ON d.ID = t.UserID

	delete from @t
	delete from @comments


	--find supervisor comments
	insert into @comments (commentdt, UserID)
		select distinct c.commentdt, c.UserID
		from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklists AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.IsDeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
				and SR.InterestedParty = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null

			union all

			select distinct c.commentdt, c.UserID
			from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklistArchive AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.IsDeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
				and SR.InterestedParty = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null

			union all
	
			select distinct c.commentdt, c.UserID
			from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.IsDeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
				and SR.InterestedParty = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null
			order by 2, 1

	--archive
	insert into @comments (commentdt, UserID)
		select distinct c.commentdt, c.UserID
		from QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklists AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.IsDeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
				and SR.InterestedParty = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null

			union all

			select distinct c.commentdt, c.UserID
			from QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklistArchive AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.IsDeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
				and SR.InterestedParty = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null

			union all
	
			select distinct c.commentdt, c.UserID
			from QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.IsDeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
				and SR.InterestedParty = 0
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null
			order by 2, 1

	--update supervisor comments
	update qpi_data
		set supervisorcomments = c.cnt
	from qpi_data d
	inner join 
		(select UserID, count(commentdt) as cnt
		from @comments 
		group by UserID) c
	on d.id = c.UserID

	--add a placeholder for start and end time
	insert into @t (commentdt, UserID)
		select distinct c.commentdt, c.UserID
		from @comments c
		union all
		select distinct @asof_date-@numdays-1, u.ID
		from QPI_Data u
		where u.isSupervisor = 1
		union all
		select distinct @asof_date, u.ID
		from QPI_Data u
		where u.isSupervisor = 1
		order by 2, 1



	--update supervisor deductions
	update qpi_data
		set SupervisorDeductions = t.SupervisorDeductions
	from qpi_data d
	inner join (
		select t1.UserID,
			 sum(((DATEDIFF(day, t1.commentDt, t2.commentDt)-1) / @SupervisorDays)) as SupervisorDeductions
		from @t t1
			inner join @t t2
				on t1.UserID = t2.UserID
					and t1.id+1 = t2.id
		where convert(varchar, t2.commentdt, 101) > DATEADD(day, @SupervisorDays, convert(varchar, t1.commentdt, 101))
		group by t1.UserID
	) t
	ON d.ID = t.UserID

	delete from @t
	delete from @comments

	--find ip comments
	insert into @comments (commentdt, UserID)
	select distinct c.commentdt, u.ID
		from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklists AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.isdeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
					and SR.InterestedParty = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
	
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null
			union all

			select distinct c.commentdt, u.ID
			from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklistArchive AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.isdeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
					and SR.InterestedParty = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt

			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
			and oh.reportID is null

			union all

			select distinct c.commentdt, u.ID
			from QStatus_Comments C
			inner join qpi_users u	
				on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.isdeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
					and SR.InterestedParty = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null

			order by 2, 1

	--archive
	insert into @comments (commentdt, UserID)
	select distinct c.commentdt, u.ID
		from QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklists AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.isdeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
					and SR.InterestedParty = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
	
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null
			union all

			select distinct c.commentdt, u.ID
			from QStatus_CommentArchive C
				inner join qpi_users u	
					on u.id = c.userid
			INNER JOIN QCheck_ActiveChecklistArchive AC
				on c.foreignkeyID = ac.id
			INNER JOIN qstatus_ActiveChecklistTaskType ACTT
				on ACTT.activechecklistid = ac.id
			INNER JOIN QStatus_TaskTypes TT
				on TT.ID = ACTT.TaskType
				and c.SpecialTask = 0
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.isdeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
					and SR.InterestedParty = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt

			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
			and oh.reportID is null

			union all

			select distinct c.commentdt, u.ID
			from QStatus_CommentArchive C
			inner join qpi_users u	
				on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			INNER JOIN QStatus_Report R
				on R.ID = TT.ReportID
				and r.isdeleted = 0
			inner join QStatus_Supervisors SR
				on SR.reportid = R.id
					and SR.InterestedParty = 1
			INNER JOIN QCheck_Groups g
				ON g.ID = sr.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm
				ON gm.GroupID = g.ID
				and gm.UserID = c.UserID
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < c.commentdt
					AND oh.enddt > c.commentdt
			WHERE commentdt >= @asof_date - @numdays and commentdt <=@asof_date
				and oh.reportID is null

			order by 2, 1

	--dont count ip comments that are from controllers
	delete @comments
	from @comments c
	inner join @controllercomments cc
	on c.userid = cc.userid
	and c.commentdt = cc.commentdt 

	--update ip comments
	update qpi_data
		set ipcomments = c.cnt
	from qpi_data d
	inner join 
		(select UserID, count(commentdt) as cnt
		from @comments 
		group by UserID) c
	on d.id = c.UserID


	--update overdue
	update qpi_data
		set overdue = od.cnt
	from qpi_data d
	inner join 
		(
			select d.id, count(distinct overdue.id) as cnt
			from
				(
					select ac.id
					from 
						qcheck_activechecklists ac
					left outer join 
						qstatus_duedatechanges ddc
					on 
						ddc.activechecklistid = ac.id
					
					where 
						(ac.completeddate is null and ac.duetime < @asof_date - 3)
					or
						(
							(ac.completeddate is null or ac.completeddate > @asof_date - @numdays)
						and
							(
								ac.completeddate > ac.duetime + 3
							--or
							--	(ddc.updatedt > ddc.duedateold + 3 and ddc.updatedt > @asof_date - @numdays)
							)
						)
					and
						ac.completeddate < @asof_date
					
					union
					
					select ac.id
					from 
						qcheck_activechecklistarchive ac
					left outer join 
						qstatus_duedatechanges ddc
					on 
						ddc.activechecklistid = ac.id
					where 
						ac.completeddate is not null
					and
						ac.completeddate > @asof_date - @numdays
					and
						ac.completeddate < @asof_date
					and
						(ac.completeddate > ac.duetime + 3
						--	or
						--(ddc.updatedt > ddc.duedateold + 3 and ddc.updatedt > @asof_date - @numdays and ddc.updatedt < @asof_date)
						)
				) as overdue
			left outer join qcheck_activeassignments aa
				on aa.activechecklistid = overdue.id
			left outer join qcheck_activeassignmentarchive aaa
				on aaa.activechecklistid = overdue.id
			left outer join qcheck_assignments a
				on a.id = isnull(aa.assignmentsid, aaa.assignmentsid)
			left outer join qcheck_assignmentarchive asa
				on asa.id = isnull(aa.assignmentsid, aaa.assignmentsid)
			inner join qcheck_groups g
				on g.id = isnull(a.GroupID, asa.GroupID)
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
			inner join qpi_data d
				on d.id = gm.userID
			inner join qstatus_groupreport gr
				on gr.GroupID = g.ID
			inner join qstatus_report r
				on r.Id = gr.ReportID
				and r.isdeleted = 0
			inner join qstatus_tasktypes tt
				on tt.reportID = r.ID
				and tt.isdeleted = 0
			inner join qstatus_activechecklisttasktype actt
				on actt.tasktype = tt.ID
				AND actt.ActiveChecklistID = overdue.id
			LEFT OUTER JOIN QStatus_OnHold oh
					ON oh.reportID = r.ID
					AND oh.startdt < @asof_date 
					AND oh.enddt > @asof_date - 30
			
			group by d.id
		
		) od
	on od.id = d.id
			

--update checklist overdue
	update qpi_data
		set checklistoverdue = od.cnt
	from qpi_data d
	inner join 
		(
			select d.id, count(distinct overdue.id) as cnt
			from
				(
					select ac.id
					from 
						qcheck_activechecklists ac
					left outer join 
						qstatus_duedatechanges ddc
					on 
						ddc.activechecklistid = ac.id

					where 
						(ac.completeddate is null and ac.duetime < @asof_date - 3)
					or
						(
							(ac.completeddate is null or ac.completeddate > @asof_date - @numdays)
						and
							(
								ac.completeddate > ac.duetime + 3
							--or
							--	(ddc.updatedt > ddc.duedateold + 3 and ddc.updatedt > @asof_date - @numdays)
		)
					and
						ac.completeddate < @asof_date
		)

					union

					select ac.id
					from 
						qcheck_activechecklistarchive ac
					left outer join 
						qstatus_duedatechanges ddc
					on 
						ddc.activechecklistid = ac.id
					where 
						ac.completeddate is not null
					and
						ac.completeddate > @asof_date - @numdays
					and
						ac.completeddate < @asof_date
					and
						(ac.completeddate > ac.duetime + 3
						--	or
						--(ddc.updatedt > ddc.duedateold + 3 and ddc.updatedt > @asof_date - @numdays and ddc.updatedt < @asof_date)
		)
				) as overdue
			left outer join qcheck_activeassignments aa
				on aa.activechecklistid = overdue.id
			left outer join qcheck_activeassignmentarchive aaa
				on aaa.activechecklistid = overdue.id
			left outer join qcheck_assignments a
				on a.id = isnull(aa.assignmentsid, aaa.assignmentsid)
			left outer join qcheck_assignmentarchive asa
				on asa.id = isnull(aa.assignmentsid, aaa.assignmentsid)
			inner join qcheck_groups g
				on g.id = isnull(a.GroupID, asa.GroupID)
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
			inner join qpi_data d
				on d.id = gm.userID

			left outer join (
				select u.id, actt.activechecklistid
				from qstatus_activechecklisttasktype actt
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
					and tt.isdeleted = 0
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
					and r.isdeleted = 0
				inner join qstatus_groupreport gr
					on gr.ReportID = r.ID
				inner join qcheck_groups g
					on g.id = gr.GroupID
				inner join qcheck_groupmembership gm
					on gm.groupid = g.id
				inner join qcheck_users u
					on u.id = gm.UserID
					and u.isdeleted = 0
			) instatus
			on instatus.id = d.id
			and instatus.activechecklistid = overdue.id

			where instatus.id is null --not on a status report

			group by d.id

		) od
	on od.id = d.id

	set nocount off

end



			






























GO
/****** Object:  StoredProcedure [dbo].[QPI_IISALL]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE             procedure [dbo].[QPI_IISALL]
	@asof_date datetime = null
AS 

	if @asof_date is null
	set @asof_date = getdate() - 1
	
	exec QPI_IISLogs @asof_date
	exec QPI_ScrubIISData
	exec QPI_CalculateIISTime @asof_date


GO
/****** Object:  StoredProcedure [dbo].[QPI_IISLogs]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE             procedure [dbo].[QPI_IISLogs]
	@asof_date datetime = null
AS 

if @asof_date is null
	set @asof_date = getdate() - 1

declare @script varchar(1000)
declare @logfileslocation varchar(100)
SET @logfileslocation = '\\ftw-web-01\d$\LogFiles\W3SVC3\'

delete from IISLOG

SET @script = 'C:\LogParser\LogParser.exe "SELECT cs-username, date, time, cs-uri-stem into IISLOG from '+@logfileslocation+'u_ex'+convert(varchar, @asof_date, 12)+'_x.log where cs-username is not null" -o:SQL -server:'+@@SERVERNAME+' -database:'+db_name()+' -username:QApps -password:TonyR0mo -createTable:OFF'

EXEC master..xp_cmdshell @script

SET @logfileslocation = '\\ftw-web-02\d$\LogFiles\W3SVC3\'

SET @script = 'C:\LogParser\LogParser.exe "SELECT cs-username, date, time, cs-uri-stem into IISLOG from '+@logfileslocation+'u_ex'+convert(varchar, @asof_date, 12)+'_x.log where cs-username is not null" -o:SQL -server:'+@@SERVERNAME+' -database:'+db_name()+' -username:QApps -password:TonyR0mo -createTable:OFF'

EXEC master..xp_cmdshell @script
GO
/****** Object:  StoredProcedure [dbo].[QPI_NumComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                procedure [dbo].[QPI_NumComments]
	@daysago int = 0
AS 

BEGIN

	
declare @today datetime

set @today = convert(varchar, getdate()- @daysago, 101)


select fullname as name, 
	case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END as role,
	count(a.commentdt) as totallast30days,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -1, 101) then
			1
		else
			0
		end
	) as yesterday,
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -2, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -3, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -4, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -5, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -6, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -7, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -8, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -9, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -10, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -11, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -12, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -13, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -14, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -15, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -16, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -17, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -18, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -19, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -20, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -21, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -22, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -23, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -24, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -25, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -26, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -27, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -28, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -29, 101) then
			1
		else
			0
		end
	),
	sum(case when convert(varchar, commentdt, 101) = convert(varchar, @today -30, 101) then
			1
		else
			0
		end
	)
			from 
			(

			--supervisor normal
			select distinct fullname, commentdt, interestedparty
			from qstatus_comments C
					inner join qpi_users u	
						on u.id = c.userid
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = c.foreignkeyid
					and c.specialtask = 0
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			where commentdt >= @today - 30 and commentdt <=@today
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
		
			
			where oh.reportID is null*/
					
			union all

			--supervisor general
			select distinct  fullname, commentdt, interestedparty
			from qstatus_comments C
					inner join qpi_users u	
						on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			INNER JOIN QStatus_TaskTypes TT
				on tt.id = st.tasktype
				and c.specialtask = 1
			INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today
			
			union all

			--controller normal
			select distinct  fullname, commentdt, null
				from qstatus_comments C
						inner join qpi_users u	
							on u.id = c.userid
					INNER JOIN qstatus_ActiveChecklistTaskType ACTT
						on ACTT.activechecklistid = c.foreignkeyid
						and c.specialtask = 0
					INNER JOIN QStatus_TaskTypes TT
						on TT.ID = ACTT.TaskType
					INNER JOIN QStatus_Report R
						on R.ID = TT.ReportID
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today

			
			
			union all

			--controller general
			select distinct  fullname, commentdt, null
			FROM qstatus_comments C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today


			union all
			--archive!!

			
			--supervisor normal
			select distinct fullname, commentdt, interestedparty
			from qstatus_commentarchive C
					inner join qpi_users u	
						on u.id = c.userid
				INNER JOIN qstatus_ActiveChecklistTaskType ACTT
					on ACTT.activechecklistid = c.foreignkeyid
				and c.specialtask = 0
				INNER JOIN QStatus_TaskTypes TT
					on TT.ID = ACTT.TaskType
				INNER JOIN QStatus_Report R
					on R.ID = TT.ReportID
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today
	
						
			union all

			--supervisor general
			select distinct  fullname, commentdt, interestedparty
						from qstatus_commentarchive C
								inner join qpi_users u	
									on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
							INNER JOIN QStatus_TaskTypes TT
				on tt.id = st.tasktype
				and c.specialtask = 1
							INNER JOIN QStatus_Report R
								on R.ID = TT.ReportID
			inner join qstatus_supervisors s
				on s.reportid = r.id
			inner join qcheck_groups g
				on g.ID = s.supervisorgroupid
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today

			union all

			--controller normal
			select distinct  fullname, commentdt, null
				from qstatus_commentarchive C
						inner join qpi_users u	
							on u.id = c.userid
					INNER JOIN qstatus_ActiveChecklistTaskType ACTT
						on ACTT.activechecklistid = c.foreignkeyid
				and c.specialtask = 0
					INNER JOIN QStatus_TaskTypes TT
						on TT.ID = ACTT.TaskType
					INNER JOIN QStatus_Report R
						on R.ID = TT.ReportID
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today
			
			union all

			--controller general
			select distinct  fullname, commentdt, null
			FROM qstatus_commentarchive C
				inner join qpi_users u	
					on u.id = c.userid
			inner join qstatus_specialtasks st
				on st.id = c.foreignkeyid
			inner join qstatus_tasktypes tt
				on tt.id = st.tasktype
				and c.specialtask = 1
			inner join qstatus_report r
				on r.id = tt.reportid
			inner join qstatus_groupreport gr
				on gr.reportid = r.id
			inner join qcheck_groups g
				on g.ID = gr.groupID
			inner join qcheck_groupmembership gm
				on gm.groupid = g.id
				and gm.userID = u.id
			/*LEFT OUTER JOIN QStatus_OnHold oh
				ON oh.reportID = r.ID
				AND oh.startdt < c.commentdt
				AND oh.enddt > c.commentdt
			where oh.reportID is null*/
			where commentdt >= @today - 30 and commentdt <=@today

			) a
		group by fullname, case when InterestedParty is null then 'Controller'
		else
			CASE WHEN InterestedParty = 1 Then
				'Interested Party'
			ELSE
				'Supervisor'
			END
		END
			order by 1, 2 desc

END

GO
/****** Object:  StoredProcedure [dbo].[QPI_ScrubIISData]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE             procedure [dbo].[QPI_ScrubIISData]
AS 
	delete from IISLOG_CLEAN
	
	INSERT INTO IISLOG_CLEAN
	select distinct
	replace(csUsername,'ACMENETWORK\',''),
	convert(datetime, (convert(varchar, [date], 101) + ' ' +
	convert(varchar, datepart(hour, [time]))+':'+
	convert(varchar, datepart(minute, [time]))+':'+
	convert(varchar, datepart(second, [time])))),
	replace(page, '/', '')
	
	from IISLOG
	where lower(replace(page, '/', ''))
		in (select lower(replace(page, '/', '')) from IIS_PAGES)
	
	
	declare @offset int --offset from GMT

	set @offset = datediff(hour, getutcdate(), getdate())

	update IISLOG_CLEAN
	set dt =  dateadd(hour, @offset, dt)
	
	declare @timeout int
	set @timeout = 30 --number of seconds


	insert into IISLOG_STARTEND
	select distinct c.shortname,
		case when c.page like '%Timeout' Then
			dateadd(minute, -1 * @timeout, c.dt)
		else
			c.dt
		end,
		p.SupervisorPage,
		CASE WHEN c.page like '%Timeout%' Then
			'END'
			WHEN c.page like '%End%' Then
			'END'
			ELSE
			'START'
end
	from IISLOG_CLEAN c
	inner join IIS_PAGES p
	on lower(replace(c.page, '/', '')) = lower(replace(p.page, '/', ''))

	


GO
/****** Object:  StoredProcedure [dbo].[QPI_Time]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE              procedure [dbo].[QPI_Time]
AS 

declare @today datetime
set @today = convert(varchar, getdate(), 101)

select u.fullname,
	case when issupervisor = 1 then
		case when ip.userid is null then
			'Supervisor'
		else
			'Interested Party'
		end
	else
		'Controller'
	end as issupervisor,
	convert(decimal(7,2),sum(case when dt > @today - 30 then
			i.totalminutes
		else
			0
		end)) as total,
	convert(decimal(7,2),sum(case when dt = @today - 1  then
			i.totalminutes
		else
			0
		end)) as yesterday,
	convert(decimal(7,2),sum(case when dt = @today - 2 then
			i.totalminutes
		else
			0
		end)) as d3,
	convert(decimal(7,2),sum(case when dt = @today - 3 then
			i.totalminutes
		else
			0
		end)) as d4,
	convert(decimal(7,2),sum(case when dt = @today - 4 then
			i.totalminutes
		else
			0
		end)) as d5,
	convert(decimal(7,2),sum(case when dt = @today - 5 then
			i.totalminutes
		else
			0
		end)) as d6,
	convert(decimal(7,2),sum(case when dt = @today - 6 then
			i.totalminutes
		else
			0
		end)) as d7,
	convert(decimal(7,2),sum(case when dt = @today - 7 then
			i.totalminutes
		else
			0
		end)) as d8,
	convert(decimal(7,2),sum(case when dt = @today - 8 then
			i.totalminutes
		else
			0
		end)) as d9,
	convert(decimal(7,2),sum(case when dt = @today - 9 then
			i.totalminutes
		else
			0
		end)) as d10,
	convert(decimal(7,2),sum(case when dt = @today - 10 then
			i.totalminutes
		else
			0
		end)) as d11,
	convert(decimal(7,2),sum(case when dt = @today - 11  then
			i.totalminutes
		else
			0
		end)) as d12,
	convert(decimal(7,2),sum(case when dt = @today - 12 then
			i.totalminutes
		else
			0
		end)) as d13,
	convert(decimal(7,2),sum(case when dt = @today - 13 then
			i.totalminutes
		else
			0
		end)) as d14,
	convert(decimal(7,2),sum(case when dt = @today - 14 then
			i.totalminutes
		else
			0
		end)) as d15,
	convert(decimal(7,2),sum(case when dt = @today - 15 then
			i.totalminutes
		else
			0
		end)) as d16,
	convert(decimal(7,2),sum(case when dt = @today - 16 then
			i.totalminutes
		else
			0
		end)) as d17,
	convert(decimal(7,2),sum(case when dt = @today - 17 then
			i.totalminutes
		else
			0
		end)) as d18,
	convert(decimal(7,2),sum(case when dt = @today - 18 then
			i.totalminutes
		else
			0
		end)) as d19,
	convert(decimal(7,2),sum(case when dt = @today - 19 then
			i.totalminutes
		else
			0
		end)) as d20,
	convert(decimal(7,2),sum(case when dt = @today - 20 then
			i.totalminutes
		else
			0
		end)) as d21,
	convert(decimal(7,2),sum(case when dt = @today - 21  then
			i.totalminutes
		else
			0
		end)) as d22,
	convert(decimal(7,2),sum(case when dt = @today - 22 then
			i.totalminutes
		else
			0
		end)) as d23,
	convert(decimal(7,2),sum(case when dt = @today - 23 then
			i.totalminutes
		else
			0
		end)) as d24,
	convert(decimal(7,2),sum(case when dt = @today - 24 then
			i.totalminutes
		else
			0
		end)) as d25,
	convert(decimal(7,2),sum(case when dt = @today - 25 then
			i.totalminutes
		else
			0
		end)) as d26,
	convert(decimal(7,2),sum(case when dt = @today - 26 then
			i.totalminutes
		else
			0
		end)) as d27,
	convert(decimal(7,2),sum(case when dt = @today - 27 then
			i.totalminutes
		else
			0
		end)) as d28,
	convert(decimal(7,2),sum(case when dt = @today - 28 then
			i.totalminutes
		else
			0
		end)) as d29,
	convert(decimal(7,2),sum(case when dt = @today - 29 then
			i.totalminutes
		else
			0
		end)) as d30

from qcheck_users  u
left outer join iis_time i
on u.shortname = i.shortname
left outer join(
	
			select distinct gm.UserID
			from qstatus_supervisors s
			inner join qcheck_groups g
			on g.id = s.supervisorgroupid
			inner join qcheck_groupmembership gm
			on gm.groupid = g.ID
			where 
				s.interestedparty = 1
				and gm.UserID not in(
					select gm.UserID
					from qstatus_supervisors s
					inner join qcheck_groups g
					on g.id = s.supervisorgroupid
					inner join qcheck_groupmembership gm
					on gm.groupid = g.ID
					where interestedparty = 0
				)
) ip
on ip.userid = u.id

where u.isdeleted = 0
and (
	convert(decimal(7,2), i.totalminutes) > 0
	or i.totalminutes is null
)

--and u.id < 4000

group by u.fullname, 
	case when issupervisor = 1 then
		case when ip.userid is null then
			'Supervisor'
		else
			'Interested Party'
		end
	else
		'Controller'
	end
having
(
	convert(decimal(7,2),sum(case when dt > @today - 30 then
			i.totalminutes
		else
			0
		end))
 	> 0)




order by 2 desc, 1--total desc--1, 2, 3



GO
/****** Object:  StoredProcedure [dbo].[QPI_TimeDetails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE              procedure [dbo].[QPI_TimeDetails]
AS 

declare @today datetime
set @today = convert(varchar, getdate(), 101)

select shortname as name, dt as date, issupervisor as supervisorpage, startend
 from iislog_startend
where 
dt > @today - 30
and dt > '2007-05-05'
order by shortname, issupervisor, dt asc, startend

GO
/****** Object:  StoredProcedure [dbo].[qpi_users_refresh]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE      proc [dbo].[qpi_users_refresh] as
begin
	truncate table qpi_users

	insert into qpi_users (
	   [ID]
      ,[ShortName]
      ,[FullName]
      ,[Email]
      ,[Password]
      ,[Admin]
      ,[App]
      ,[empID]
      ,[DepartmentAdmin]
      ,[Priorities]
      ,[IsDeleted]
	  )
		select u.[ID]
			  ,u.[ShortName]
			  ,u.[FullName]
			  ,u.[Email]
			  ,u.[Password]
			  ,u.[Admin]
			  ,u.[App]
			  ,u.[empID]
			  ,u.[DepartmentAdmin]
			  ,u.[Priorities]
			  ,u.[IsDeleted] 
			from qcheck_users u
					inner join [tblEmployees] t
						on u.shortname = t.loginid
			left outer join qpi_exclude e
				on e.id = u.id
			where isdeleted = 0
		
			--and (t.departmentid not in (9, 18)  or u.id in (140)) -- interns, india, w/exceptions
			and (t.departmentid not in (10, 24)  or u.id in (140)) -- interns, india, w/exceptions
			and e.id is null
			-- 6/16/2010 dalvarado - Mike Simmons was violating the PK constraint in qpi_users because he's in tblEmployees twice.  If this isn't
			-- the correct fix, maybe a SELECT DISTINCT will work.
			and t.isactive = 1
			and t.startdate < getdate() - 30
order by u.[ID]

end
GO
/****** Object:  StoredProcedure [dbo].[QProcess_LastRead]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                               PROCEDURE [dbo].[QProcess_LastRead] AS
BEGIN

	select 
		r.name, 
		dbo.QStatus_GetUserNamesFull(r.id), 
		u.fullname as supervisor, 
		r.lastreportdate, 
	case when s.id > 0 then s.id else null end as 'Read'
	from qstatus_report r
	left outer join qstatus_supervisors s
	on s.reportid = r.id
	left outer join qcheck_groups g
	on g.id = s.SupervisorGroupID
	left outer join qcheck_groupmembership gm
	on gm.groupid = g.ID
	left outer join qcheck_users u
	on u.id = gm.userid
	where r.isdeleted = 0
	order by 1, 3, 2

END








GO
/****** Object:  StoredProcedure [dbo].[QProcess_MostUserTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                                     PROCEDURE [dbo].[QProcess_MostUserTasks] AS
BEGIN



	SELECT 
	 TOP 20
	 U.FullName,
	 count(distinct ac.id) as activetasks,
	 sum(case when s.id is null then 0 else 1 end) as recurring,
	 sum(case when ac.duetime < getdate() then 1 else 0 end) as late,
	 count(distinct actt.activechecklistid) as onstatusreport
	FROM 
		QCheck_Users u
	left outer join qcheck_groupmembership gm
		on gm.userid = u.id
	left outer join qcheck_groups g
		on g.id = gm.groupid
	left outer join qcheck_assignments a
		on a.GroupID = g.id
	left outer join qcheck_activeassignments aa
		on aa.assignmentsid = a.id
	left outer JOIN  qcheck_activechecklists ac
		on ac.id = aa.activechecklistid
	 	and ac.completeddate is null
	left outer join qstatus_activechecklisttasktype actt
		on ac.id = actt.activechecklistid
	left outer join qcheck_checklistinstances ci
		on ci.id = ac.instanceid
	left outer join qcheck_schedule s
		on ci.scheduleid = s.id
		and s.freqType > 1
	inner join tblEmployees t
		on t.employeeID = u.empID
		--and not t.departmentID in (9, 15, 18, 19, 20)
		and not t.departmentID in (10, 18, 24, 22, 28)
		and not u.FullName in ('Geoffrey Raynor', 'Rob McCormick')
	GROUP BY
	 u.FullName
	Order by 2 desc

end

/*
Old	Name		New	Name
9	Interns		10	Interns/Office Personnel
15	Q Development	18	Q Development
18	Q India		24	Q India
19	Intermet	22	Intermet
20	Westover	28	Westside Maintenance
*/






GO
/****** Object:  StoredProcedure [dbo].[QProcess_SupervisorComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO











CREATE                                PROCEDURE [dbo].[QProcess_SupervisorComments] AS
BEGIN

declare @supervisortable table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int,
	interestedparty bit
	)

declare @supervisordates table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int,
	interestedparty bit,
	today int,
	onedayago int,
	twodaysago int,
	threedaysago int,
	fourdaysago int,
	fivedaysago int,
	sixdaysago int,
	sevendaysago int,
	eightdaysago int,
	ninedaysago int,
	tendaysago int,
	elevendaysago int,
	twelvedaysago int,
	thirteendaysago int,
	fourteendaysago int,
	fifteendaysago int,
	sixteendaysago int,
	seventeendaysago int,
	eightteendaysago int,
	nineteendaysago int,
	twentydaysago int,
	twentyonedaysago int,
	twentytwodaysago int,
	twentythreedaysago int,
	twentyfourdaysago int,
	twentyfivedaysago int,
	twentysixdaysago int,
	twentysevendaysago int,
	twentyeightdaysago int,
	twentyninedaysago int,
	thirtydaysago int
	)

insert into @supervisortable
Select u.fullname, r.name, r.id, u.id, s.interestedparty
from 
	qcheck_users u
inner join qcheck_groupmembership gm
on
	gm.userid = u.id
inner join qcheck_groups g
on
	g.id = gm.groupID
inner join 
	qstatus_supervisors s
on 
	s.SupervisorGroupID = g.id
and 
	s.directsupervisor = 1
inner join
	qstatus_report r
on
	r.id = s.reportid
and 
	r.isdeleted = 0
--order by u.fullname, r.name



insert into @supervisordates
select ut.username, ut.reportname, ut.reportid, ut.userid, ut.interestedparty,
sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate(), 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-1, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-2, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-3, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-4, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-5, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-6, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-7, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-8, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-9, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-10, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-11, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-12, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-13, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-14, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-15, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-16, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-17, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-18, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-19, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-20, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-21, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-22, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-23, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-24, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-25, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-26, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-27, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-28, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-29, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-30, 101) then 1 else 0 end)
from @supervisortable ut
left outer join qstatus_tasktypes tt
on tt.reportid = ut.reportid
left outer join qstatus_activechecklisttasktype actt
on actt.tasktype = tt.id
left outer join qstatus_specialtasks st
on st.tasktype = tt.id
left outer join qstatus_comments c
on c.foreignkeyid = actt.activechecklistid and c.specialtask = 0 and c.userID = ut.userid
left outer join qstatus_comments c2
on c2.foreignkeyid = st.id and c2.specialtask = 1 and c.userID = ut.userID
group by ut.username, ut.reportname, ut.reportid, ut.userid, ut.interestedparty


select * from @supervisordates
order by username, reportname

END









GO
/****** Object:  StoredProcedure [dbo].[QProcess_SupervisorCommentTotals]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

















CREATE                                      PROCEDURE [dbo].[QProcess_SupervisorCommentTotals] AS
BEGIN

declare @supervisortable table(
	username varchar(100),
	userid int)

END















GO
/****** Object:  StoredProcedure [dbo].[QProcess_UserComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                              PROCEDURE [dbo].[QProcess_UserComments] AS
BEGIN
declare @usertable table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int)

declare @userdates table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int,
	today int,
	onedayago int,
	twodaysago int,
	threedaysago int,
	fourdaysago int,
	fivedaysago int,
	sixdaysago int,
	sevendaysago int,
	eightdaysago int,
	ninedaysago int,
	tendaysago int,
	elevendaysago int,
	twelvedaysago int,
	thirteendaysago int,
	fourteendaysago int,
	fifteendaysago int,
	sixteendaysago int,
	seventeendaysago int,
	eightteendaysago int,
	nineteendaysago int,
	twentydaysago int,
	twentyonedaysago int,
	twentytwodaysago int,
	twentythreedaysago int,
	twentyfourdaysago int,
	twentyfivedaysago int,
	twentysixdaysago int,
	twentysevendaysago int,
	twentyeightdaysago int,
	twentyninedaysago int,
	thirtydaysago int
	)

insert into @usertable
Select u.fullname, r.name, r.id, u.id
from 
	qcheck_users u
inner join qcheck_groupmembership gm
on
	gm.userid = u.id
inner join qcheck_groups g
on
	g.id = gm.groupID
inner join 
	qstatus_groupreport gr
on 
	gr.groupid = g.id
inner join
	qstatus_report r
on
	r.id = gr.reportid
and 
	r.isdeleted = 0


insert into @userdates
select ut.username, ut.reportname, ut.reportid, ut.userid,
sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate(), 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-1, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-2, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-3, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-4, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-5, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-6, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-7, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-8, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-9, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-10, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-11, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-12, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-13, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-14, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-15, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-16, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-17, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-18, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-19, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-20, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-21, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-22, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-23, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-24, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-25, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-26, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-27, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-28, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-29, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-30, 101) then 1 else 0 end)
from @usertable ut
left outer join qstatus_tasktypes tt
on tt.reportid = ut.reportid
left outer join qstatus_activechecklisttasktype actt
on actt.tasktype = tt.id
left outer join qstatus_specialtasks st
on st.tasktype = tt.id
left outer join qstatus_comments c
on c.foreignkeyid = actt.activechecklistid and c.specialtask = 0 and c.userID = ut.userid
left outer join qstatus_comments c2
on c2.foreignkeyid = st.id and c2.specialtask = 1 and c.userID = ut.userID
group by ut.username, ut.reportname, ut.reportid, ut.userid


select * from @userdates
order by username, reportname

END







GO
/****** Object:  StoredProcedure [dbo].[QProcess_UserCommentTotals]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


















CREATE                                       PROCEDURE [dbo].[QProcess_UserCommentTotals] AS
BEGIN
declare @usertable table(
	username varchar(100),
	userid int)

declare @userdates table(
	username varchar(100),
	userid int,
	_1to5daysago int,
	_1to14daysago int,
	_1to21daysago int,
	total int
	)

insert into @usertable
Select distinct u.fullname, u.id
from 
	qcheck_users u
inner join qcheck_groupmembership gm
on
	gm.userid = u.id
inner join qcheck_groups g
on
	g.id = gm.groupID
inner join 
	qstatus_groupreport gr
on 
	gr.groupid = g.id
inner join
	qstatus_report r
on
	r.id = gr.reportid
and 
	r.isdeleted = 0
inner join tblEmployees t
on t.employeeID = u.empID
and not t.departmentID in (10, 18, 24, 22, 28) --(9, 15, 18, 19, 20)
and not u.Fullname in ('Geoffrey Raynor', 'Rob McCormick')

insert into @userdates
select ut.username, ut.userid
,sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) > convert(varchar, getdate()-5, 101) then 1 else 0 end)
,sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) > convert(varchar, getdate()-14, 101) then 1 else 0 end)
,sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) > convert(varchar, getdate()-21, 101) then 1 else 0 end)
,sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) > convert(varchar, getdate()-30, 101) then 1 else 0 end)
from @usertable ut
left outer join qcheck_groupmembership gm
on gm.UserID = ut.UserID
left outer join qcheck_groups g
on g.ID = gm.GroupID
left outer join qstatus_groupreport gr
on gr.GroupID = g.ID
left outer join qstatus_report r
on r.id = gr.reportid
left outer join qstatus_tasktypes tt
on tt.reportid = r.id
left outer join qstatus_activechecklisttasktype actt
on actt.tasktype = tt.id
left outer join qstatus_specialtasks st
on st.tasktype = tt.id
left outer join qstatus_comments c
on c.foreignkeyid = actt.activechecklistid and c.specialtask = 0 and c.userID = ut.userid
left outer join qstatus_comments c2
on c2.foreignkeyid = st.id and c2.specialtask = 1 and c.userID = ut.userID
where
(isNull(c.commentdt, c2.commentdt)> convert(varchar, getdate()-30, 101) or isNull(c.commentdt, c2.commentdt) is null)
group by ut.username, ut.userid
having sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) > convert(varchar, getdate()-5, 101) then 1 else 0 end) < 3



select * from @userdates
order by username

END
GO
/****** Object:  StoredProcedure [dbo].[QProcess_UserTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                                   PROCEDURE [dbo].[QProcess_UserTasks] AS
BEGIN



	SELECT 
	 U.FullName,
	 count(distinct ac.id) as activetasks,
	 sum(case when s.id is null then 0 else 1 end) as recurring,
	 sum(case when ac.duetime < getdate() then 1 else 0 end) as late,
	 count(distinct actt.activechecklistid) as onstatusreport
	FROM 
		QCheck_Users u
	left outer join qcheck_groupmembership gm
		on gm.userid = u.id
	left outer join qcheck_groups g
		on g.id = gm.groupid
	left outer join qcheck_assignments a
		on a.GroupID = g.id
	left outer join qcheck_activeassignments aa
		on aa.assignmentsid = a.id
	left outer JOIN  qcheck_activechecklists ac
		on ac.id = aa.activechecklistid
	 	and ac.completeddate is null
	left outer join qstatus_activechecklisttasktype actt
		on ac.id = actt.activechecklistid
	left outer join qcheck_checklistinstances ci
		on ci.id = ac.instanceid
	left outer join qcheck_schedule s
		on ci.scheduleid = s.id
		and s.freqType > 1
	inner join tblEmployees t
		on t.employeeID = u.empID
		and not t.departmentID in (10, 18, 24, 22, 28) --(9, 15, 18, 19, 20)
		and not u.FullName in ('Geoffrey Raynor', 'Rob McCormick')
	GROUP BY
	 u.FullName
	HAVING  sum(case when ac.duetime < getdate() then 1 else 0 end) > 2
	Order by 1

end











GO
/****** Object:  StoredProcedure [dbo].[QProcess_UserTotals]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO















CREATE                                   PROCEDURE [dbo].[QProcess_UserTotals] AS
BEGIN

declare @usertable table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int)

declare @supervisortable table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int,
	interestedparty bit
	)

declare @userdates table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int,
	today int,
	onedayago int,
	twodaysago int,
	threedaysago int,
	fourdaysago int,
	fivedaysago int,
	sixdaysago int,
	sevendaysago int,
	eightdaysago int,
	ninedaysago int,
	tendaysago int,
	elevendaysago int,
	twelvedaysago int,
	thirteendaysago int,
	fourteendaysago int,
	fifteendaysago int,
	sixteendaysago int,
	seventeendaysago int,
	eightteendaysago int,
	nineteendaysago int,
	twentydaysago int,
	twentyonedaysago int,
	twentytwodaysago int,
	twentythreedaysago int,
	twentyfourdaysago int,
	twentyfivedaysago int,
	twentysixdaysago int,
	twentysevendaysago int,
	twentyeightdaysago int,
	twentyninedaysago int,
	thirtydaysago int
	)


declare @usertotals table(
	username varchar(100),
	userid int,
	today int,
	onedayago int,
	twodaysago int,
	threedaysago int,
	fourdaysago int,
	fivedaysago int,
	sixdaysago int,
	sevendaysago int,
	eightdaysago int,
	ninedaysago int,
	tendaysago int,
	elevendaysago int,
	twelvedaysago int,
	thirteendaysago int,
	fourteendaysago int,
	fifteendaysago int,
	sixteendaysago int,
	seventeendaysago int,
	eightteendaysago int,
	nineteendaysago int,
	twentydaysago int,
	twentyonedaysago int,
	twentytwodaysago int,
	twentythreedaysago int,
	twentyfourdaysago int,
	twentyfivedaysago int,
	twentysixdaysago int,
	twentysevendaysago int,
	twentyeightdaysago int,
	twentyninedaysago int,
	thirtydaysago int
	)

declare @supervisordates table(
	username varchar(100),
	reportname varchar(200),
	reportid int,
	userid int,
	interestedparty bit,
	today int,
	onedayago int,
	twodaysago int,
	threedaysago int,
	fourdaysago int,
	fivedaysago int,
	sixdaysago int,
	sevendaysago int,
	eightdaysago int,
	ninedaysago int,
	tendaysago int,
	elevendaysago int,
	twelvedaysago int,
	thirteendaysago int,
	fourteendaysago int,
	fifteendaysago int,
	sixteendaysago int,
	seventeendaysago int,
	eightteendaysago int,
	nineteendaysago int,
	twentydaysago int,
	twentyonedaysago int,
	twentytwodaysago int,
	twentythreedaysago int,
	twentyfourdaysago int,
	twentyfivedaysago int,
	twentysixdaysago int,
	twentysevendaysago int,
	twentyeightdaysago int,
	twentyninedaysago int,
	thirtydaysago int
	)


insert into @usertable
Select distinct u.fullname, r.name, r.id, u.id
from 
	qcheck_users u
inner join qcheck_groupmembership gm
on
	gm.userid = u.id
inner join qcheck_groups g
on
	g.id = gm.groupID
inner join 
	qstatus_groupreport gr
on 
	gr.groupid = g.id
inner join
	qstatus_report r
on
	r.id = gr.reportid
and 
	r.isdeleted = 0
inner join tblEmployees t
on t.employeeID = u.empID
and not t.departmentID in (10, 18, 24, 22, 28) --(9, 15, 18, 19, 20)
and not u.Fullname in ('Geoffrey Raynor', 'Rob McCormick')

insert into @userdates
select ut.username, ut.reportname, ut.reportid, ut.userid,
sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate(), 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-1, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-2, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-3, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-4, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-5, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-6, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-7, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-8, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-9, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-10, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-11, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-12, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-13, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-14, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-15, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-16, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-17, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-18, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-19, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-20, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-21, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-22, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-23, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-24, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-25, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-26, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-27, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-28, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-29, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-30, 101) then 1 else 0 end)
from @usertable ut
left outer join qstatus_tasktypes tt
on tt.reportid = ut.reportid
left outer join qstatus_activechecklisttasktype actt
on actt.tasktype = tt.id
left outer join qstatus_specialtasks st
on st.tasktype = tt.id
left outer join qstatus_comments c
on c.foreignkeyid = actt.activechecklistid and c.specialtask = 0 and c.userID = ut.userid
left outer join qstatus_comments c2
on c2.foreignkeyid = st.id and c2.specialtask = 1 and c.userID = ut.userID
group by ut.username, ut.reportname, ut.reportid, ut.userid

insert into @supervisortable
Select u.fullname, r.name, r.id, u.id, s.interestedparty
from 
	qcheck_users u
inner join qcheck_groupmembership gm
on
	gm.userid = u.id
inner join qcheck_groups g
on
	g.id = gm.groupID
inner join 
	qstatus_supervisors s
on 
	s.SupervisorGroupID = g.id
and 
	s.directsupervisor = 1
inner join
	qstatus_report r
on
	r.id = s.reportid
and 
	r.isdeleted = 0



insert into @supervisordates
select ut.username, ut.reportname, ut.reportid, ut.userid, ut.interestedparty,
sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate(), 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-1, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-2, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-3, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-4, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-5, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-6, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-7, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-8, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-9, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-10, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-11, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-12, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-13, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-14, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-15, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-16, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-17, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-18, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-19, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-20, 101) then 1 else 0 end)

, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-21, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-22, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-23, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-24, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-25, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-26, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-27, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-28, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-29, 101) then 1 else 0 end)
, sum(case when convert(varchar, isNull(c.commentdt, c2.commentdt), 101) = convert(varchar, getdate()-30, 101) then 1 else 0 end)
from @supervisortable ut
left outer join qstatus_tasktypes tt
on tt.reportid = ut.reportid
left outer join qstatus_activechecklisttasktype actt
on actt.tasktype = tt.id
left outer join qstatus_specialtasks st
on st.tasktype = tt.id
left outer join qstatus_comments c
on c.foreignkeyid = actt.activechecklistid and c.specialtask = 0 and c.userID = ut.userid
left outer join qstatus_comments c2
on c2.foreignkeyid = st.id and c2.specialtask = 1 and c.userID = ut.userID
group by ut.username, ut.reportname, ut.reportid, ut.userid, ut.interestedparty

insert into @usertotals
select u.fullname, u.id
	, sum(isnull(today, 0))
	, sum(isnull(onedayago, 0))
	, sum(isnull(twodaysago, 0))
	, sum(isnull(threedaysago, 0))
	, sum(isnull(fourdaysago, 0))
	, sum(isnull(fivedaysago, 0))
	, sum(isnull(sixdaysago, 0))
	, sum(isnull(sevendaysago, 0))
	, sum(isnull(eightdaysago, 0))
	, sum(isnull(ninedaysago, 0))
	, sum(isnull(tendaysago, 0))
	, sum(isnull(elevendaysago, 0))
	, sum(isnull(twelvedaysago, 0))
	, sum(isnull(thirteendaysago, 0))
	, sum(isnull(fourteendaysago, 0))
	, sum(isnull(fifteendaysago, 0))
	, sum(isnull(sixteendaysago, 0))
	, sum(isnull(seventeendaysago, 0))
	, sum(isnull(eightteendaysago, 0))
	, sum(isnull(nineteendaysago, 0))
	, sum(isnull(twentydaysago, 0))
	, sum(isnull(twentyonedaysago, 0))
	, sum(isnull(twentytwodaysago, 0))
	, sum(isnull(twentythreedaysago, 0))
	, sum(isnull(twentyfourdaysago, 0))
	, sum(isnull(twentyfivedaysago, 0))
	, sum(isnull(twentysixdaysago, 0))
	, sum(isnull(twentysevendaysago, 0))
	, sum(isnull(twentyeightdaysago, 0))
	, sum(isnull(twentyninedaysago, 0))
	, sum(isnull(thirtydaysago, 0))
from 
	qcheck_users u
inner join
	(
	select
		userid,
		today,
		onedayago,
		twodaysago,
		threedaysago,
		fourdaysago,
		fivedaysago,
		sixdaysago,
		sevendaysago,
		eightdaysago,
		ninedaysago,
		tendaysago,
		elevendaysago,
		twelvedaysago,
		thirteendaysago,
		fourteendaysago,
		fifteendaysago,
		sixteendaysago,
		seventeendaysago,
		eightteendaysago,
		nineteendaysago,
		twentydaysago,
		twentyonedaysago,
		twentytwodaysago,
		twentythreedaysago,
		twentyfourdaysago,
		twentyfivedaysago,
		twentysixdaysago,
		twentysevendaysago,
		twentyeightdaysago,
		twentyninedaysago,
		thirtydaysago
	from @userdates
	union 
	select
		userid,
		today,
		onedayago,
		twodaysago,
		threedaysago,
		fourdaysago,
		fivedaysago,
		sixdaysago,
		sevendaysago,
		eightdaysago,
		ninedaysago,
		tendaysago,
		elevendaysago,
		twelvedaysago,
		thirteendaysago,
		fourteendaysago,
		fifteendaysago,
		sixteendaysago,
		seventeendaysago,
		eightteendaysago,
		nineteendaysago,
		twentydaysago,
		twentyonedaysago,
		twentytwodaysago,
		twentythreedaysago,
		twentyfourdaysago,
		twentyfivedaysago,
		twentysixdaysago,
		twentysevendaysago,
		twentyeightdaysago,
		twentyninedaysago,
		thirtydaysago
	from @supervisordates)
	tot
on u.id = tot.userid

group by u.fullname, u.id

select * from @usertotals
order by username

END













GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddDepartmentSuper]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO










CREATE                PROCEDURE [dbo].[QStatus_AddDepartmentSuper]
	@SupervisorGroupID int,
	@ReportID int
AS
BEGIN
	SET NOCOUNT ON
	
	
	IF
	EXISTS
	(
		SELECT 1
		FROM 
			QStatus_SupervisorDepartments sd
		INNER JOIN 
			QCheck_Groups superg
		ON
			superg.ID = @SupervisorGroupID
		INNER JOIN
			QCheck_GroupMembership supergm
		ON
			supergm.GroupID = superg.ID
		ANd
			supergm.UserID = sd.SupervisorUserID
		INNER JOIN QStatus_GroupReport gr
		ON
			gr.ReportID = @ReportID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON
			g.ID = gm.GroupID	
		INNER JOIN
			QCheck_Users u
		ON
			gm.UserID = u.ID
		INNER JOIN
			tblemployees e
		ON
			(u.empid = e.employeeid
		AND
			e.DepartmentID = sd.DepartmentID)
		OR
			sd.DepartmentID = -1
		LEFT OUTER JOIN
			QStatus_Supervisors s
		ON
			s.SupervisorGroupID = @SupervisorGroupID
		AND
			s.ReportID = @ReportID
		WHERE
			s.ID is null
	)
			
	BEGIN
		EXEC QStatus_AddSupervisors @ReportID, @SupervisorGroupID, 0
	END
END










GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddDepartmentSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                          PROCEDURE [dbo].[QStatus_AddDepartmentSupervisors]
	@SupervisorID int,
	@DepartmentID int
AS

BEGIN

	SET NOCOUNT ON
	
		DELETE FROM QStatus_supervisordepartments
		WHERE SupervisorUserID = @SupervisorID
		AND @DepartmentID = -1

		Insert into QStatus_supervisordepartments
		SELECT @SupervisorID, @DepartmentID
		WHERE
			Not exists (
				SELECT ID from 	QStatus_supervisordepartments
				WHERE SupervisorUserID = @SupervisorID
				AND
					(DepartmentID = @DepartmentID or DepartmentID = -1)
			)

		
		


	SET NOCOUNT OFF

End














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddDontEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO












CREATE                     PROCEDURE [dbo].[QStatus_AddDontEmail]
	@ReportID int
AS
BEGIN

		INSERT INTO QStatus_DontEmail
		SELECT @ReportID
		WHERE NOT EXISTS
			(SELECT 1 FROM QStatus_DontEmail
			WHERE ReportID = @ReportID)
END











GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE                                     PROCEDURE [dbo].[QStatus_AddOnHold]
	@reportID int,
	@starting datetime,
	@ending datetime
AS
BEGIN

	insert into grading_onhold (reportID, StartDt, EndDt)
		select @reportID, @starting, @ending


END












































GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddPreference]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



















CREATE                    PROCEDURE [dbo].[QStatus_AddPreference]
	@UserID int,
	@ReportID int = 0,
	@PreferenceType varchar(50),
	@PreferenceValue varchar(50)
AS
BEGIN
	SET NOCOUNT ON

	if Not lower(@PreferenceValue) like '%users.%' and not lower(@PreferenceValue) like '%StatusCopyLegal.aspx%'
	BEGIN
		UPDATE QStatus_Preferences
		SET PreferenceValue = @PreferenceValue
		WHERE PreferenceType = @PreferenceType
		AND UserID = @UserID
		AND @ReportID = ReportID
		
		IF @@Rowcount = 0
		BEGIN
			INSERT INTO QStatus_Preferences (UserID, ReportID, PreferenceType, PreferenceValue)
			VALUES (@UserID, @ReportID, @PreferenceType, @PreferenceValue)
		END
	END
	

	SET NOCOUNT OFF
END







GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                              PROCEDURE [dbo].[QStatus_AddReport]
	@GroupID int,
	@ReportName varchar(50) = null
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ReportID int

	INSERT INTO QStatus_Report
	([Name])
	VALUES
	(ISNULL(@ReportName,'New Report'))
	
	SELECT @ReportID = SCOPE_IDENTITY()

	INSERT INTO QStatus_GroupReport
	(GroupID, ReportID)
	VALUES
	(@GroupID, @ReportID)
		
	EXEC QStatus_Init @ReportID

		

	SET NOCOUNT OFF
END








GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddReportUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                               PROCEDURE [dbo].[QStatus_AddReportUser]
	@GroupID int,
	@ReportID int
AS
BEGIN
	SET NOCOUNT ON

	INSERT INTO QStatus_GroupReport
	(GroupID, ReportID)
	SELECT @GroupID, @ReportID
	WHERE NOT EXISTS
	(
		SELECT ID FROM QStatus_GroupReport
		WHERE GroupID = @GroupID AND ReportID = @ReportID
	)
	

	SET NOCOUNT OFF
END
















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddSection]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






--Add a section to a status report

CREATE                   PROCEDURE [dbo].[QStatus_AddSection]
	@ReportID int
AS
BEGIN
	
	--check current number, if there are more than 15, then don't add
	SELECT 
		ID
	FROM
		QStatus_TaskTypes
	WHERE	
		ReportID = @ReportID

	IF @@ROWCOUNT < 150
	BEGIN
		--get the max display order so it can be added at the end
		DECLARE @DisplayOrder INT
		SELECT @DisplayOrder = MAX(DisplayOrder) + 1
		FROM QStatus_TaskTypes
		WHERE
			ReportID = @ReportID

		--insert the new section with the name 'new section'
		INSERT INTO QStatus_TaskTypes
		(ReportID, [Description], DisplayOrder)
		VALUES
		(@ReportID, 'New Section', @DisplayOrder)
	END
END





































GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddSupervisorByName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[QStatus_AddSupervisorByName] (
	@ReportName VARCHAR(50),
	@SupervisorName VARCHAR(50),
	@InterestedParty BIT = 0 --Set to 0 for supervisor, 1 for interested party
) AS

BEGIN
	
	DECLARE @GroupID INT,
		@ReportID INT,
		@GroupCount INT,
		@ReportCount INT
	
	
	SELECT @GroupCount = COUNT(*) FROM QCheck_Groups WHERE [Name] LIKE '%' + @SupervisorName + '%'
	
	IF @GroupCount = 1 BEGIN
	
		SELECT @ReportCount = COUNT(*) FROM QStatus_Report WHERE isdeleted = 0 and [Name] LIKE '%' + @ReportName + '%'
	
		IF @ReportCount = 1 BEGIN
	
			SELECT @GroupID = [ID] FROM QCheck_Groups WHERE [Name] LIKE '%' + @SupervisorName + '%'
			SELECT @ReportID = [ID] FROM QStatus_Report WHERE [Name] LIKE '%' + @ReportName + '%'
	
			IF EXISTS(SELECT * FROM QStatus_Supervisors WHERE ReportID = @ReportID AND SupervisorGroupID = @GroupID) BEGIN
	
				UPDATE 
					QStatus_Supervisors
				SET 
					InterestedParty = @InterestedParty
				WHERE
					ReportID = @ReportID
					AND SupervisorGroupID = @GroupID
	
				SELECT 'SUCCESS: Supervisor row exists, updated interested party' AS OutputStatus
	
			END ELSE BEGIN
	
				INSERT INTO QStatus_Supervisors (
					ReportID, 
					SupervisorGroupID,
					DirectSupervisor,
					InterestedParty
				) VALUES (
					@ReportID,
					@GroupID,
					1,
					@InterestedParty
				)
	
				SELECT 'SUCCESS: Inserted supervisor record' AS OutputStatus		
	
			END
	
		END ELSE IF @ReportCount = 0 BEGIN

			SELECT 'FAILED: Could not find report "' + @ReportName + '"' AS OutputStatus

		END ELSE BEGIN
	
			SELECT 'FAILED: Found multiple reports.  Please pass in one of the exact names below:' AS OutputStatus
			SELECT [NAME] FROM QStatus_Report WHERE [Name] LIKE '%' + @ReportName + '%' ORDER BY [Name]
	
		END
	
	END ELSE IF @GroupCount = 0 BEGIN

		SELECT 'FAILED: Could not find group "' + @SupervisorName + '"' AS OutputStatus

	END ELSE BEGIN
	
		SELECT 'FAILED: Found multiple supervisor groups.  Please pass in one of the exact names below:' AS OutputStatus
		SELECT [NAME] FROM QCheck_Groups  WHERE [Name] LIKE '%' + @SupervisorName + '%' ORDER BY [Name]
	
	END

END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_AddSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO











--add a supervisor to a report
CREATE                              PROCEDURE [dbo].[QStatus_AddSupervisors]
	@ReportID int,
	@SupervisorGroupID int,
	@DirectSupervisor bit = 1,
	@Allow bit = 0
AS
BEGIN

	
	--make sure they arent adding a current user of the report as a supervisor
	DECLARE @MyReport int
	SET @MyReport = 0

	IF @DirectSupervisor = 0 or @Allow = 1
	BEGIN
		
		SELECT @MyReport = 1
		FROM  QStatus_GroupReport gr
		WHERE gr.ReportID = @ReportID
		AND gr.GroupID = @SupervisorGroupID
	
		IF @MyReport = 0
		BEGIN
			--robert and greg can only have geoffrey, noel, or rob, and william
			--william can only have geoffrey as a supervisor
			--DECLARE @CanAddThisSupervisor int
			--set @CanAddThisSupervisor = 0
	
			--If @CanAddThisSupervisor = 0
			
			--BEGIN
			
				UPDATE QStatus_Supervisors
				SET DirectSupervisor = @DirectSupervisor
				WHERE ReportID = @ReportID
				AND SupervisorGroupID = @SupervisorGroupID
				
				--add the supervisor if he does not already exist
				INSERT INTO QStatus_Supervisors
				(ReportID, SupervisorGroupID,  DirectSupervisor)
				SELECT @ReportID, @SupervisorGroupID, @DirectSupervisor
				WHERE NOT EXISTS
				(
					SELECT ID FROM QStatus_Supervisors
					WHERE ReportID = @ReportID
					AND SupervisorGroupID = @SupervisorGroupID
				)
			--END
		END
	END
	
END























































GO
/****** Object:  StoredProcedure [dbo].[QStatus_AllReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







create                                    PROCEDURE [dbo].[QStatus_AllReports]
	
AS
BEGIN

	select r.id, dbo.QStatus_GetUserNames(r.ID) + r.Name
	from qstatus_report r
	where r.isdeleted = 0
	order by 2

END











































GO
/****** Object:  StoredProcedure [dbo].[QStatus_ArchiveGeneralComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





--after a # days, archive off the general comments

CREATE                        PROCEDURE [dbo].[QStatus_ArchiveGeneralComments]
AS
BEGIN
	/*DECLARE @archivebeforedate datetime
	set @archivebeforedate =  DateAdd(dd, -7, getdate())	--5 days

	--insert into the archivea
	INSERT INTO QStatus_CommentArchive
	SELECT  c.*, getdate()
	FROM
		QStatus_Comments c
	INNER JOIN
		 QStatus_ActiveChecklistTaskType actt
	ON
		c.ForeignKeyID = actt.ActiveChecklistID
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		tt.ID = actt.TaskType
	AND
		tt.NativeType = 5  --general comment
	WHERE
		c.CommentDt < @archivebeforedate

	--remove it from the comments table
	DELETE 
		QStatus_Comments
	FROM
		QStatus_Comments c
	INNER JOIN
		QStatus_Tasks t
	ON
		c.TaskID = t.ID
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		t.Type = tt.ID
	AND
		tt.NativeType = 5
	WHERE
		c.CommentDt < @archivebeforedate*/

	DECLARE @NumToKeep int
	
	SET @NumToKeep = 15
	
	update qstatus_comments 
	set qstatus_comments.DisplayOrder = d.DisplayOrder
	from qstatus_comments 
	inner join 
	(
		select b.Id, count(a.ID) as DisplayOrder from 
		qstatus_comments a
		inner join qstatus_comments b
		on a.foreignkeyID = b.foreignkeyId and 
		a.specialtask = b.specialtask
		and a.displayOrder <= b.displayOrder
		group by b.ID
	) d
	on qstatus_comments.ID = d.ID
	
	insert into qstatus_commentarchive
	select distinct a.*, getdate()
	from qstatus_comments a
	inner join 
	qstatus_comments b
	on a.foreignkeyID = b.foreignKeyID
	and a.specialtask = b.specialtask
	and a.DisplayOrder = b.DisplayOrder - @NumToKeep
	WHERE a.specialTask = 1
	
	delete from qstatus_comments
	where id in 
	(select ID from qstatus_commentarchive)

END

































GO
/****** Object:  StoredProcedure [dbo].[QStatus_AutomationEmailPreferences_Get]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QStatus_AutomationEmailPreferences_Get]
	@UserID int,
	@AssigneeVal int = -1
AS BEGIN

	DECLARE @Assignee int = -1, 
			@Controller int = -1,
			@Due int = -1,
			@ReportOrig int = -1,
			@Report int = -1,
			@Priority int = -1,
			@Alert int = -1,
			@SoftDue int = -1,
			@EChecklistPriority int = -1
			
	SELECT @Assignee=Assignee, 
			@Controller = Controller, 
			@Due = Due, 
			@Report = Report, 
			@ReportOrig = Report,
			@Priority = [Priority],
			@Alert = Alert,
			@SoftDue = SoftDue,
			@EChecklistPriority = EChecklistPriority
	FROM QStatus_AutomationEmailPreferences
	WHERE UserID = @UserID
	
	
	
	DECLARE @AssigneeName varchar(1000) = '',
			@ControllerName varchar(1000) = '',
			@ReportName varchar(1000) = ''
			
	IF @Assignee > -1
	BEGIN
		SELECT @AssigneeName = name from QCheck_Groups
		WHERE ID = @Assignee
	END
	
	IF @ControllerName > -1
	BEGIN
		SELECT @ControllerName = name from QCheck_Groups
		where ID = @Controller
	END
	
	--if it was not passed in, use the default
	IF @AssigneeVal = -1
	BEGIN
		SELECT @AssigneeVal = @Assignee
	END
	
	--if default not set, it will be the group id of the user who sent it
	IF @AssigneeVal = -1
	BEGIN
		SELECT @AssigneeVal = UserGroupID 
		FROM qstatus_usersupervisors
		WHERE UserID = @UserID
	END
	
	IF @Report = -1
	BEGIN
		SELECT top 1 
			@Report = tt.ID
		FROM 
			QStatus_Report r
		INNER JOIN QCheck_GroupMembership gm1
			on gm1.GroupID = @AssigneeVal
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = gm1.UserID
		INNER JOIN 
			QStatus_TaskTypes tt
		ON
			tt.ReportID = r.ID
		AND 
			tt.IsDeleted = 0
		AND
			tt.NativeType = 0
		WHERE 
			r.IsDeleted = 0
		ORDER BY gr.defaultreport desc, r.ID, tt.displayOrder
	END
	
	If @Report > -1 
	BEGIN
		select @ReportName = r.Name + ' - ' + tt.Description 
		from QStatus_TaskTypes tt
		inner join QStatus_Report r
			on tt.ReportID = r.id
		WHERE tt.ID = @Report
	END
		
	
	SELECT @Assignee as Assignee, 
			@Controller as Controller,
			@Due as Due,
			@Report as Report,
			@ReportOrig as ReportOrig,
			@Priority as [Priority],
			@AssigneeName as AssigneeName,
			@ControllerName as ControllerName,
			@ReportName as ReportName,
			@Alert as Alert,
			@SoftDue as SoftDue,
			@EChecklistPriority as EChecklistPriority
			 
End
GO
/****** Object:  StoredProcedure [dbo].[QStatus_AutomationEmailPreferences_Set]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QStatus_AutomationEmailPreferences_Set]
	@UserID int,
	@Assignee int,
	@Controller int,
	@Due int,
	@Report int,
	@Priority int,
	@Alert int = -1,
	@SoftDue int = -1,
	@EChecklistPriority int = -1
AS BEGIN

	UPDATE QStatus_AutomationEmailPreferences
		SET Assignee = @Assignee,
			Controller = @Controller,
			Due = @Due,
			Report = @Report,
			[Priority] = @Priority,
			Alert = @Alert,
			SoftDue = @SoftDue,
			EChecklistPriority = @EChecklistPriority
		WHERE UserID = @UserID
		
	IF @@ROWCOUNT = 0
	BEGIN
		INSERT INTO QStatus_AutomationEmailPreferences
		(UserID, Assignee, Controller, Due, Report, [Priority], Alert, SoftDue, EChecklistPriority)
		SELECT @UserID, @Assignee, @Controller, @Due, @Report, @Priority, @Alert, @SoftDue, @EChecklistPriority
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_CanEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE                            PROCEDURE [dbo].[QStatus_CanEmail](
	@ReportID INT,
	@CanEmail bit output
	
)
 AS

BEGIN

	SET NOCOUNT ON
	
	SET @CanEmail = 1

	SELECT 
		@CanEmail = 0 
	FROM
		QStatus_DontEmail
	WHERE
		ReportID = @ReportID

	SET NOCOUNT OFF

END














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_CheckDepartments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                    PROCEDURE [dbo].[QStatus_CheckDepartments]
	@SupervisorID int,
	@HasDepartments bit output
AS
	
BEGIN

	SET @HasDepartments = 0

	SELECT ID FROM QStatus_SupervisorDepartments
	WHERE SupervisorUserID = @SupervisorID

	IF @@RowCount > 0 
		SET @HasDepartments = 1

END
























GO
/****** Object:  StoredProcedure [dbo].[QStatus_CheckSupervisor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE                     PROCEDURE [dbo].[QStatus_CheckSupervisor]
	@SupervisorID int,
	@ReportID int,
	@IsSupervisor bit output
AS
	SET @IsSupervisor = 0
	
	SELECT @IsSupervisor = 1
	WHERE @SupervisorID in (select GPRUserID from Qcheck_Appsettings)
	
	SELECT @IsSupervisor = 1
	WHERE 
	EXISTS
	(
		SELECT s.ID 
			FROM QStatus_Supervisors s
		INNER JOIN QCheck_Groups g
		ON
			g.ID = s.SupervisorGroupID
		INNER JOIN QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = 	@SupervisorID	
		WHERE 
			s.ReportID = @ReportID 
		AND
			s.DirectSupervisor = 1
	)
	OR EXISTS
	(
		SELECT gr.ID 
		FROM 
			QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @SupervisorID	
		WHERE 
			ReportID = @ReportID 
		AND
			UserID = @SupervisorID
	)

	IF @IsSupervisor = 0
	SELECT @IsSupervisor = 1
	WHERE 
	EXISTS
	(
		SELECT s.ID FROM 
			QStatus_Supervisors s
		INNER JOIN 
			QCheck_Groups gsuper
		ON
			gsuper.ID = s.SupervisorGroupID
		INNER JOIN 
			QCheck_GroupMembership gmsuper
		ON
			gmsuper.GroupID = gsuper.id
		AND
			gmsuper.UserID = @SupervisorID
		INNER JOIN
			QStatus_SupervisorDepartments sd
		ON
			sd.SupervisorUserID = @SupervisorID
		INNER JOIN
			QStatus_GroupReport	gr
		ON
			gr.ReportID = s.ReportID
		INNER JOIN QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		INNER JOIN
			QCheck_Users u
		ON
			u.ID = gm.UserID
		INNER JOIN
			tblemployees e
		ON
			(u.empid = e.employeeid
		AND
			e.DepartmentID = sd.DepartmentID)
		OR
			sd.DepartmentID = -1
		WHERE 
			s.ReportID = @ReportID 
		AND
			s.DirectSupervisor = 0	
	)
	

























GO
/****** Object:  StoredProcedure [dbo].[QStatus_CondensedSupervisorEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_CondensedSupervisorEmail]
AS

	
	DECLARE @SupervisorName varchar(100)
		
	DECLARE SUPERCURS CURSOR
	FOR 	
		--overdue
		select distinct u.shortname
		from Qcheck_activechecklists t
		inner join QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = t.ID
		AND
			t.CompletedDate is null
		inner join QStatus_tasktypes tt
		on actt.tasktype = tt.ID
		and tt.Isdeleted = 0
		and tt.nativetype = 0
		inner join QStatus_report r
		on tt.reportID = r.id
		and r.isdeleted = 0
		inner join QStatus_supervisors s
		on s.reportid = r.id
		and s.directsupervisor = 1
		inner join QCheck_Groups g
		on g.id = s.supervisorgroupid
		inner join QCheck_Groupmembership gm
		on gm.groupid = g.id
		inner join QCheck_Users u
		on u.id = gm.userID
		inner join QStatus_SupervisorEmailDefaults def
		on def.EmailType = 'Overdue'
		AND 	(
				(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
					OR
				(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
			)
		left outer join QStatus_SupervisorEmailPreferences pref
		ON
			pref.type = def.id
		AND
			pref.UserID = u.ID
		inner join QStatus_CondensedEmails ce
		ON
			ce.UserID = u.ID
		where duetime < (getdate() - 1) 
		and isnull(pref.SendEmail, def.SendEmail) = 1
		and len(email) > 0
	
		union
	
		--duedatechanges
		select distinct supervisorID from
		(
			select distinct u.shortname as supervisorID, u.Email, c.name as description, convert(varchar, min(ddc.duedateold), 101) as ddo, isnull(convert(varchar, t.duetime, 101), 'No due date') as dd 
			from QStatus_duedatechanges ddc
			inner join Qcheck_activechecklists t on ddc.activechecklistid = t.id
			inner join QCheck_ChecklistInstances i on i.ID = t.InstanceID and i.isdeleted = 0
			inner join QCheck_Checklists c on c.ID = i.ChecklistID and c.IsDeleted = 0
			inner join QStatus_ActiveChecklisttasktype actt on actt.ActiveChecklistID = t.ID
			inner join QStatus_TaskTypes tt on actt.TaskType = tt.ID
			inner join QStatus_supervisors s on s.directsupervisor = 1
			and s.reportID = tt.reportID
			inner join QCheck_Groups g
			on g.id = s.supervisorgroupid
			inner join QCheck_Groupmembership gm
			on gm.groupid = g.id
			inner join QCheck_Users u
			on u.id = gm.userID
			inner join QStatus_SupervisorEmailDefaults def
			on def.EmailType = 'DueDateChanges'
			AND 	(
					(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
						OR
					(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
				)
			left outer join QStatus_SupervisorEmailPreferences pref
			ON
				pref.type = def.id
			AND
				pref.UserID = u.ID
			inner join QStatus_CondensedEmails ce
			ON
				ce.UserID = u.ID
			where ddc.updatedt > getdate() - 1
			and len(email) > 0
			and isnull(pref.SendEmail, def.SendEmail) = 1
			group by t.id, t.duetime, c.name, u.shortname, u.Email
			having isnull(min(ddc.duedateold),0)<>isnull(t.duetime,0)
		) a
	
		union
	
		--unread inbox
		SELECT DISTINCT us.ShortName
			FROM
				QStatus_Supervisors sup
			INNER JOIN
				QStatus_Report r
			ON
				sup.ReportID = r.ID
			AND
				r.IsDeleted = 0
			INNER JOIN
				QStatus_GroupReport gr
			ON
				gr.ReportID = r.ID
			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = gr.GroupID
			INNER JOIN
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID
			INNER JOIN
				QCheck_Users u
			ON
				u.ID = gm.UserID
			INNER JOIN
				QCheck_Groups gSuper
			ON
				gSuper.ID = sup.SupervisorGroupID
			INNER JOIN
				QCheck_GroupMembership gmSuper
			ON
				gmSuper.GroupID = gSuper.ID
			INNER JOIN
				QCheck_Users us
			ON
				us.ID = gmSuper.UserID
			inner join 
				QStatus_SupervisorEmailDefaults def
			on 
				def.EmailType = 'Unread'
			AND 	
				(
					(def.SupervisorType = 'Supervisor' AND sup.InterestedParty = 0)
						OR
					(def.SupervisorType = 'InterestedParty' AND sup.InterestedParty = 1)
				)
			left outer join 
				QStatus_SupervisorEmailPreferences pref
			ON
				pref.type = def.id
			AND
				pref.UserID = us.ID
			inner join QStatus_CondensedEmails ce
			ON
				ce.UserID = us.ID
			inner join qstatus_supervisorslastviewed lv
			ON	
				lv.supervisoruserid = ce.UserID
			AND
				lv.ReportID = r.ID
			AND
				ISNULL(r.LastReportDate,0) > lv.LastViewed
			WHERE
				isnull(pref.SendEmail, def.SendEmail) = 1
			and 
				len(us.email) > 0			

	OPEN SUPERCURS

	FETCH NEXT FROM SUPERCURS INTO @SupervisorName
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		EXEC QStatus_CondensedSupervisorEmail_SingleUser @SupervisorName
		
		FETCH NEXT FROM SUPERCURS INTO @SupervisorName
	
	END
	CLOSE SUPERCURS
	DEALLOCATE SUPERCURS
GO
/****** Object:  StoredProcedure [dbo].[QStatus_CondensedSupervisorEmail_SingleUser_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_CondensedSupervisorEmail_SingleUser_HTML]
	@SupervisorName varchar(200)
AS

BEGIN
	RETURN
--	SET NOCOUNT ON
	
	---- Get app configuration
	--DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	--SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	----unread reports variables
	--DECLARE @startText varchar(1000)
	--DECLARE @luText varchar(1000)
	--DECLARE @lrText varchar(1000)
	--DECLARE @dt datetime

	----overdue variables
	--DECLARE @ReportID int,
	--	@StatusReport varchar(200),
	--	@PrevStatusReport varchar(200),
	--	@Task varchar(200),
	--	@DueDate varchar(50),
	--	@DaysOverdue int,
	--	@i int,
	--	@j int
	
	
	----due date changes variables
	--DECLARE @OldDueDate varchar(50)
	

	
	
	--DECLARE @html_output TABLE (
	--	seq INT IDENTITY(1,1),
	--	row_html VARCHAR(5000)
	--)

		
	---- apply the style sheet and header information
	--	INSERT INTO @html_output (row_html) 
	--			SELECT
	--		'<html>
	--			<style>
	--			TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;}
	--			TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}
	--			.allborder{
	--				border-left:solid 1px #000000;
	--				border-right:solid 1px #000000;
	--				border-bottom:solid 1px #000000;
	--			}	
	--			.bottom{
	--				border-bottom:solid 1px #000000;
	--			}	
	--			.bottomright{
	--				border-bottom:solid 1px #000000;
	--				border-right:solid 1px #000000;
	--			}
	--			A:link {	
	--				text-decoration: none;
	--				color:	#003366;
	--			}				
	--			A:visited {	
	--				text-decoration: none;
	--				color: #003366;
	--			}	
	--			A:active {	
	--				text-decoration: none;
	--			 	color: #003366;
	--			}	
	--			A:hover	{
	--				text-decoration: underline;
	--				color: #FF9900;
	--			}
	--			</style>
	--		<body>'


	--	SELECT @APPURL = appurl +'/MyInbox.aspx' from qcheck_appsettings a
	--	inner join qcheck_users u
	--	on u.app = a.id
	--	and u.shortname = @SupervisorName

	--	SET @i = 0
	--	SET @j = 0
	--	SET @PrevStatusReport = ''


		
	--	--unread reports
	--	DECLARE INNERSUPERCURS CURSOR
	--	FOR 
	--		SELECT distinct
	--			'<tr>
	--				<td class="allborder">
	--					<a href="' + a.AppUrl + '/MyInbox.aspx?reportID=' + CAST(r.ID as varchar) + '">'
	--						+  dbo.QStatus_GetUserNames(r.ID) + r.Name 
	--					+ '</a>
	--				</td>' as nameColumn,
					
	--				'<td class="bottom">' 
	--					+ ISNULL(left(Datename(dw, LastReportDate), 3) + '. ', 'No Status') 
	--			     + '</td>
	--				<td class="bottom">' 
	--					+ ISNULL(CONVERT(varchar, LastReportDate,1), '') 
	--			     + '</td>' 
	--					+ CASE WHEN LastReportDate = 0 Then
	--				'<td class="bottom">
	--					&nbsp;
	--				</td>
	--				<td class="bottomright">
	--					&nbsp;
	--				</td>'
	--					WHEN datediff(day, LastReportDate, getdate())=1 THEN
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastReportDate, 100), 7)) + '
	--				</td>
	--				<td class="bottomright">
	--					1&nbsp;Day&nbsp;Ago
	--				</td>'
	--					ELSE 
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastReportDate, 100), 7)) 
	--			     + '</td>
	--				<td class="bottomright">'
	--					+ CAST(datediff(day, LastReportDate, getdate()) as varchar) + '&nbsp;Days&nbsp;Ago'
	--			      +	'</td>'
	--					END as lastUpdatedColumn,
	--			       '<td class="bottom">' 
	--					+ CASE WHEN LastViewed = 0 Then 'Never Read' ELSE ISNULL(left(Datename(dw, LastViewed), 3) + '. ', 'Never Read') END
	--			     + '</td>
	--				<td class="bottom">' 
	--					+ CASE WHEN LastViewed = 0 Then '&nbsp;' ELSE ISNULL(CONVERT(varchar, LastViewed,1), '') END
	--			     + '</td>' 
	--					+ CASE WHEN LastViewed = 0 Then
	--				'<td class="bottom">

	--					&nbsp;
	--				</td>
	--				<td class="bottomright">
	--					&nbsp;
	--				</td>'
	--					WHEN datediff(day, LastViewed, getdate())=1 THEN
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastViewed, 100), 7)) + '
	--				</td>
	--				<td class="bottomright">
	--					1&nbsp;Day&nbsp;Ago
	--				</td>'
	--					ELSE 
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastViewed, 100), 7)) 
	--			     + '</td>
	--				<td class="bottomright">'
	--					+ CAST(datediff(day, LastViewed, getdate()) as varchar) + '&nbsp;Days&nbsp;Ago'
	--			      +	'</td>' END as LastViewedColumn,
	--				r.LastReportDate
				
	--		FROM
	--			QStatus_Supervisors sup
	--		INNER JOIN
	--			QStatus_Report r
	--		ON
	--			sup.ReportID = r.ID
	--		and 
	--			r.isdeleted = 0
	--		inner join 
	--			QCheck_Groups g
	--		on 
	--			g.id = sup.supervisorgroupid
	--		inner join 
	--			QCheck_Groupmembership gm
	--		on 
	--			gm.groupid = g.id
	--		inner join 
	--			QCheck_Users u
	--		on 
	--			u.id = gm.userID
	--		AND
	--			u.shortname = @SupervisorName
	--		INNER JOIN
	--			qcheck_appsettings a
	--		ON
	--			u.App = a.ID
	--		inner join 
	--			QStatus_SupervisorEmailDefaults def
	--		on 
	--			def.EmailType = 'Unread'
	--		AND 	(
	--				(def.SupervisorType = 'Supervisor' AND sup.InterestedParty = 0)
	--					OR
	--				(def.SupervisorType = 'InterestedParty' AND sup.InterestedParty = 1)
	--			)
	--		left outer join 
	--			QStatus_SupervisorEmailPreferences pref
	--		ON
	--			pref.type = def.id
	--		AND
	--			pref.UserID = u.ID
	--		inner join
	--			QStatus_CondensedEmails ce
	--		ON
	--			ce.UserID = u.ID
	--		inner join qstatus_supervisorslastviewed lv
	--		ON	
	--			lv.supervisoruserid = ce.UserID
	--		AND
	--			lv.ReportID = r.ID
	--		AND
	--			ISNULL(r.LastReportDate,0) > lv.LastViewed
	--		where 
	--			isnull(pref.SendEmail, def.SendEmail) = 1
	--		AND
	--			sup.DirectSupervisor = 1
	--		ORDER BY r.LastReportDate desc


	--		OPEN INNERSUPERCURS
	--		FETCH NEXT FROM INNERSUPERCURS INTO  @startText, @luText, @lrText, @dt
	--		WHILE @@FETCH_STATUS = 0 BEGIN		

	--			if @i = 0
	--				insert into 
	--				@html_output (row_html) 
	--				select '<span style=''font-size:20pt''><u><b>' + @AppName + ' Unread Status Reports</b></u></span><br><br>' +
	--					'<table cellspacing=0 cellpadding=13>' +
	--					'<tr><th style="border-left:solid 1px #000000;">Name</th><th colspan=4>Last Updated</th><th  colspan=4>Last Read</th></tr>' 
						

	--			insert into 
	--				@html_output (row_html) 
	--				select  + @startText + @luText + @lrText + '</tr>'
				
	--			SELECT @i = @i + 1		

	--			FETCH NEXT FROM INNERSUPERCURS INTO  @startText, @luText, @lrText, @dt
	--		END
	--		CLOSE INNERSUPERCURS
	--		DEALLOCATE INNERSUPERCURS

	--		if @i > 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '</table><br><hr><br>'
	--		set @j = @j + @i

		
	--	--end of unread reports
	--	set @i = 0

	--	-- overdue items
	--	DECLARE INNEROVERDUECURS CURSOR
	--	FOR 

	--	select distinct r.[ID], 
			
	--		'<a href="' + a.AppUrl + '/MyInbox.aspx?reportID=' + CAST(r.ID as varchar) + '">'
	--			+  dbo.QStatus_GetUserNames(r.ID) + r.Name 
	--		+ '</a>', 
	--		c.name, 
	--		CONVERT(varchar, t.duetime, 101), 
	--		DateDiff(day, t.duetime, getDate())
	--	from Qcheck_activechecklists t
	--	inner join qcheck_checklistinstances i
	--	on
	--		t.InstanceID = i.ID
	--	and
	--		i.Isdeleted = 0
	--	inner join qcheck_checklists c
	--	on
	--		i.ChecklistID = c.ID
	--	and
	--		c.IsDeleted = 0
	--	inner join QStatus_ActiveChecklistTaskType actt
	--	ON
	--		actt.ActiveChecklistID = t.ID
	--	AND
	--		t.CompletedDate is null
	--	inner join QStatus_tasktypes tt
	--	on actt.tasktype = tt.ID
	--	and tt.Isdeleted = 0
	--	inner join QStatus_report r
	--	on tt.reportID = r.id
	--	and r.isdeleted = 0
	--	inner join QStatus_supervisors s
	--	on s.reportid = r.id
	--	and s.directsupervisor = 1
	--	inner join 
	--		QCheck_Groups g
	--	on 
	--		g.id = s.supervisorgroupid
	--	inner join 
	--		QCheck_Groupmembership gm
	--	on 
	--		gm.groupid = g.id
	--	inner join 
	--		QCheck_Users u
	--	on 
	--		u.id = gm.userID
	--	AND
	--		u.shortname = @SupervisorName
	--	INNER JOIN
	--		qcheck_appsettings a
	--	ON
	--		u.App = a.ID
	--	inner join 
	--		QStatus_SupervisorEmailDefaults def
	--	on 
	--		def.EmailType = 'Overdue'
	--	AND 	(
	--			(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
	--				OR
	--			(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
	--		)
	--	left outer join 
	--		QStatus_SupervisorEmailPreferences pref
	--	ON
	--		pref.type = def.id
	--	AND
	--		pref.UserID = u.ID
	--	inner join
	--		QStatus_CondensedEmails ce
	--	ON
	--		ce.UserID = u.ID
	--	where 
	--		isnull(pref.SendEmail, def.SendEmail) = 1 
	--	AND
	--		t.duetime < (getdate()) 
	--	order by r.[ID], CONVERT(varchar, t.duetime, 101)
		
	--	OPEN INNEROVERDUECURS
	--		FETCH NEXT FROM INNEROVERDUECURS INTO  @ReportID, @StatusReport, @Task, @DueDate, @DaysOverdue
	--		WHILE @@FETCH_STATUS = 0 BEGIN		
				
	--			IF @i = 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '<span style=''font-size:20pt''><u><b>' + @AppName + ' Overdue Report</b></u></span><br><br>' +
	--					'<table cellspacing=0 cellpadding=7>' + 
	--					'<tr><th>Status Report</th><th>Task</th><th>Due Date</th><th>Days Overdue</th></tr>' 
						

	--			IF @i > 1 AND @StatusReport <> @PrevStatusReport 
	--			BEGIN
	--				insert into 
	--				@html_output (row_html) 
	--				select '<tr style="height:10px;"><td></td><td></td><td></td></tr>'
	--			END
	
	--			SET @PrevStatusReport = @StatusReport
				
	--			insert into 
	--				@html_output (row_html) 
	--				select '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@DueDate+'</td><td style="text-align:center;">'+CAST(@DaysOverdue as varchar)+'</td></tr>'
	
	--			SELECT @i = @i + 1

	--			FETCH NEXT FROM INNEROVERDUECURS INTO   @ReportID, @StatusReport, @Task, @DueDate, @DaysOverdue
	--		END
	--	CLOSE INNEROVERDUECURS
	--	DEALLOCATE INNEROVERDUECURS

	--		if @i > 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '</table><br><hr><br>'
	--		set @j = @j + @i

	--	--end of overdue
	--	set @i = 0
	
	--	-- due date changes
	--	DECLARE INNERDDCCURS CURSOR
	--	FOR 
	--	select 
	--		'<a href="' + a.AppUrl + '/MyInbox.aspx?reportID=' + CAST(ID as varchar) + '">'
	--			+  dbo.QStatus_GetUserNames(ID) + Name 
	--		+ '</a>', 
	--		a.description, 
	--		CONVERT(varchar, a.ddo, 101), 
	--		CONVERT(varchar, a.dd, 101)
	--	FROM
	--	(
	--		select distinct r.ID, r.name, c.name as description, convert(varchar, min(ddc.duedateold), 101) as ddo, isnull(convert(varchar, t.duetime, 101), 'No due date') as dd, a.appURL 
	--		from QStatus_duedatechanges ddc
	--		inner join Qcheck_activechecklists t on ddc.activechecklistid = t.id
	--		inner join QCheck_ChecklistInstances i on i.ID = t.InstanceID and i.isdeleted = 0
	--		inner join QCheck_Checklists c on c.ID = i.ChecklistID and c.IsDeleted = 0
	--		inner join QStatus_ActiveChecklisttasktype actt on actt.ActiveChecklistID = t.ID
	--		inner join QStatus_TaskTypes tt on actt.TaskType = tt.ID
	--		inner join QStatus_report r on r.id = tt.reportID
	--		inner join QStatus_supervisors s on s.directsupervisor = 1
	--		and s.reportID = r.ID
	--		inner join 
	--			QCheck_Groups g
	--		on 
	--			g.id = s.supervisorgroupid
	--		inner join 
	--			QCheck_Groupmembership gm
	--		on 
	--			gm.groupid = g.id
	--		inner join 
	--			QCheck_Users u
	--		on 
	--			u.id = gm.userID
	--		AND
	--			u.shortname = @SupervisorName
	--		INNER JOIN
	--		qcheck_appsettings a
	--		ON
	--			u.App = a.ID
	--		inner join 
	--			QStatus_SupervisorEmailDefaults def
	--		on 
	--			def.EmailType = 'DueDateChanges'
	--		AND 	(
	--				(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
	--					OR
	--				(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
	--			)
	--		left outer join 
	--			QStatus_SupervisorEmailPreferences pref
	--		ON
	--			pref.type = def.id
	--		AND
	--			pref.UserID = u.ID
	--		inner join
	--			QStatus_CondensedEmails ce
	--		ON
	--			ce.UserID = u.ID
	--		where 
	--			isnull(pref.SendEmail, def.SendEmail) = 1 
	--		AND 
	--			ddc.updatedt > getdate() - 1
	--		group by t.id, t.duetime, c.name, r.name, r.ID, a.appURL
	--		having isnull(min(ddc.duedateold),0)<>isnull(t.duetime,0)

	--	) a

		
	--	OPEN INNERDDCCURS
	--		FETCH NEXT FROM INNERDDCCURS INTO  @StatusReport, @Task, @OldDueDate, @DueDate
	--		WHILE @@FETCH_STATUS = 0 BEGIN		
								
	--			IF @i = 0
	--				insert into 
	--				@html_output (row_html) 
	--				select '<span style=''font-size:20pt''><u><b>' + @AppName + ' Due Date Changes</b></u></span><br><br>' +
	--					'<table cellspacing=0 cellpadding=13>' +
	--					'<tr><th>Status Report</th><th>Task</th><th>Old Due Date</th><th>New Due Date</th></tr>' 
						
	
	--			IF @i > 1 AND @StatusReport <> @PrevStatusReport 
	--			BEGIN
	--				insert into 
	--				@html_output (row_html) 
	--				select '<tr style="height:10px;"><td></td><td></td><td></td><td></td></tr>'
	--			END
	
	--			SET @PrevStatusReport = @StatusReport
				
	--			insert into 
	--				@html_output (row_html) 
	--				select  '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@OldDueDate+'</td><td>'+@DueDate+'</td></tr>'
	
				
	--			SELECT @i = @i + 1

	--			FETCH NEXT FROM INNERDDCCURS INTO   @StatusReport, @Task, @OldDueDate, @DueDate
	--		END
	--	CLOSE INNERDDCCURS
	--	DEALLOCATE INNERDDCCURS

	--		if @i > 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '</table><br><hr><br>'
	--		set @j = @j + @i




	--if @j > 0 
	--	insert into @html_output (row_html) select '<br> <a href="'+@APPURL+'">'+@APPURL+'</a><br><br>'





	---- minyards




	
	--SELECT @APPURL = appurl +'/MyInbox.aspx' from minyardsprocess.dbo.qcheck_appsettings a
	--	inner join minyardsprocess.dbo.qcheck_users u
	--	on u.app = a.id
	--	and u.shortname = @SupervisorName
	--SET @i = 0
	--SET @j = 0
	--	SET @PrevStatusReport = ''


		
	--	--unread reports
	--	DECLARE INNERSUPERCURS CURSOR
	--	FOR 
	--		SELECT distinct
	--			'<tr>
	--				<td class="allborder">
	--					<a href="' + a.AppUrl + '/MyInbox.aspx?reportID=' + CAST(r.ID as varchar) + '">'
	--						+  minyardsprocess.dbo.QStatus_GetUserNames(r.ID) + r.Name 
	--					+ '</a>
	--				</td>' as nameColumn,
					
	--				'<td class="bottom">' 
	--					+ ISNULL(left(Datename(dw, LastReportDate), 3) + '. ', 'No Status') 
	--			     + '</td>
	--				<td class="bottom">' 
	--					+ ISNULL(CONVERT(varchar, LastReportDate,1), '') 
	--			     + '</td>' 
	--					+ CASE WHEN LastReportDate = 0 Then
	--				'<td class="bottom">
	--					&nbsp;
	--				</td>
	--				<td class="bottomright">
	--					&nbsp;
	--				</td>'
	--					WHEN datediff(day, LastReportDate, getdate())=1 THEN
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastReportDate, 100), 7)) + '
	--				</td>
	--				<td class="bottomright">
	--					1&nbsp;Day&nbsp;Ago
	--				</td>'
	--					ELSE 
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastReportDate, 100), 7)) 
	--			     + '</td>
	--				<td class="bottomright">'
	--					+ CAST(datediff(day, LastReportDate, getdate()) as varchar) + '&nbsp;Days&nbsp;Ago'
	--			      +	'</td>'
	--					END as lastUpdatedColumn,
	--			       '<td class="bottom">' 
	--					+ CASE WHEN LastViewed = 0 Then 'Never Read' ELSE ISNULL(left(Datename(dw, LastViewed), 3) + '. ', 'Never Read') END
	--			     + '</td>
	--				<td class="bottom">' 
	--					+ CASE WHEN LastViewed = 0 Then '&nbsp;' ELSE ISNULL(CONVERT(varchar, LastViewed,1), '') END
	--			     + '</td>' 
	--					+ CASE WHEN LastViewed = 0 Then
	--				'<td class="bottom">

	--					&nbsp;
	--				</td>
	--				<td class="bottomright">
	--					&nbsp;
	--				</td>'
	--					WHEN datediff(day, LastViewed, getdate())=1 THEN
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastViewed, 100), 7)) + '
	--				</td>
	--				<td class="bottomright">
	--					1&nbsp;Day&nbsp;Ago
	--				</td>'
	--					ELSE 
	--				'<td class="bottom">
	--					' + ltrim(right(convert(varchar, LastViewed, 100), 7)) 
	--			     + '</td>
	--				<td class="bottomright">'
	--					+ CAST(datediff(day, LastViewed, getdate()) as varchar) + '&nbsp;Days&nbsp;Ago'
	--			      +	'</td>' END as LastViewedColumn,
	--				r.LastReportDate
				
	--		FROM
	--			minyardsprocess.dbo.QStatus_Supervisors sup
	--		INNER JOIN
	--			minyardsprocess.dbo.QStatus_Report r
	--		ON
	--			sup.ReportID = r.ID
	--		and 
	--			r.isdeleted = 0
	--		INNER JOIN
	--			minyardsprocess.dbo.QCheck_Groups g
	--		on 
	--			g.id = sup.supervisorgroupid
	--		inner join 
	--			minyardsprocess.dbo.QCheck_Groupmembership gm
	--		on 
	--			gm.groupid = g.id
	--		inner join 
	--			minyardsprocess.dbo.QCheck_Users u
	--		ON
	--			u.id = gm.userID
	--		AND
	--			u.shortname = @SupervisorName
	--		INNER JOIN
	--			minyardsprocess.dbo.qcheck_appsettings a
	--		ON
	--			u.App = a.ID
	--		inner join 
	--			minyardsprocess.dbo.QStatus_SupervisorEmailDefaults def
	--		on 
	--			def.EmailType = 'Unread'
	--		AND 	(
	--				(def.SupervisorType = 'Supervisor' AND sup.InterestedParty = 0)
	--					OR
	--				(def.SupervisorType = 'InterestedParty' AND sup.InterestedParty = 1)
	--			)
	--		left outer join 
	--			minyardsprocess.dbo.QStatus_SupervisorEmailPreferences pref
	--		ON
	--			pref.type = def.id
	--		AND
	--			pref.UserID = u.ID
	--		inner join
	--			minyardsprocess.dbo.QStatus_CondensedEmails ce
	--		ON
	--			ce.UserID = u.ID
	--		inner join minyardsprocess.dbo.qstatus_supervisorslastviewed lv
	--		ON	
	--			lv.supervisoruserid = ce.UserID
	--		AND
	--			lv.ReportID = r.ID
	--		AND
	--			ISNULL(r.LastReportDate,0) > lv.LastViewed
	--		where 
	--			isnull(pref.SendEmail, def.SendEmail) = 1
	--		AND
	--			sup.DirectSupervisor = 1
	--		ORDER BY r.LastReportDate desc


	--		OPEN INNERSUPERCURS
	--		FETCH NEXT FROM INNERSUPERCURS INTO  @startText, @luText, @lrText, @dt
	--		WHILE @@FETCH_STATUS = 0 BEGIN		

	--			if @i = 0
	--				insert into 
	--				@html_output (row_html) 
	--				select '<span style=''font-size:20pt''><u><b>MinyardsProcess Unread Status Reports</b></u></span><br><br>' +
	--					'<table cellspacing=0 cellpadding=13>' +
	--					'<tr><th style="border-left:solid 1px #000000;">Name</th><th colspan=4>Last Updated</th><th  colspan=4>Last Read</th></tr>' 
						

	--			insert into 
	--				@html_output (row_html) 
	--				select  + @startText + @luText + @lrText + '</tr>'
				
	--			SELECT @i = @i + 1		

	--			FETCH NEXT FROM INNERSUPERCURS INTO  @startText, @luText, @lrText, @dt
	--		END
	--		CLOSE INNERSUPERCURS
	--		DEALLOCATE INNERSUPERCURS

	--		if @i > 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '</table><br><hr><br>'
	--		set @j = @j + @i

		
	--	--end of unread reports
	--	set @i = 0

	--	-- overdue items
	--	DECLARE INNEROVERDUECURS CURSOR
	--	FOR 

	--	select distinct r.[ID], 
			
	--		'<a href="' + a.AppUrl + '/MyInbox.aspx?reportID=' + CAST(r.ID as varchar) + '">'
	--			+  minyardsprocess.dbo.QStatus_GetUserNames(r.ID) + r.Name 
	--		+ '</a>', 
	--		c.name, 
	--		CONVERT(varchar, t.duetime, 101), 
	--		DateDiff(day, t.duetime, getDate())
	--	from minyardsprocess.dbo.Qcheck_activechecklists t
	--	inner join minyardsprocess.dbo.qcheck_checklistinstances i
	--	on
	--		t.InstanceID = i.ID
	--	and
	--		i.Isdeleted = 0
	--	inner join minyardsprocess.dbo.qcheck_checklists c
	--	on
	--		i.ChecklistID = c.ID
	--	and
	--		c.IsDeleted = 0
	--	inner join minyardsprocess.dbo.QStatus_ActiveChecklistTaskType actt
	--	ON
	--		actt.ActiveChecklistID = t.ID
	--	AND
	--		t.CompletedDate is null
	--	inner join minyardsprocess.dbo.QStatus_tasktypes tt
	--	on actt.tasktype = tt.ID
	--	and tt.Isdeleted = 0
	--	inner join minyardsprocess.dbo.QStatus_report r
	--	on tt.reportID = r.id
	--	and r.isdeleted = 0
	--	inner join minyardsprocess.dbo.QStatus_supervisors s
	--	on s.reportid = r.id
	--	and s.directsupervisor = 1
	--	inner join 
	--		minyardsprocess.dbo.QCheck_Groups g
	--	on
	--		g.id = s.supervisorgroupid
	--	inner join 
	--		minyardsprocess.dbo.QCheck_Groupmembership gm
	--	on 
	--		gm.groupid = g.id
	--	inner join 
	--		minyardsprocess.dbo.QCheck_Users u
	--	on 
	--		u.id = gm.userID
	--	and
	--		u.shortname = @SupervisorName
	--	INNER JOIN
	--		minyardsprocess.dbo.qcheck_appsettings a
	--	ON
	--		u.App = a.ID
	--	inner join 
	--		minyardsprocess.dbo.QStatus_SupervisorEmailDefaults def
	--	on 
	--		def.EmailType = 'Overdue'
	--	AND 	(
	--			(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
	--				OR
	--			(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
	--		)
	--	left outer join 
	--		minyardsprocess.dbo.QStatus_SupervisorEmailPreferences pref
	--	ON
	--		pref.type = def.id
	--	AND
	--		pref.UserID = u.ID
	--	inner join
	--		minyardsprocess.dbo.QStatus_CondensedEmails ce
	--	ON
	--		ce.UserID = u.ID
	--	where 
	--		isnull(pref.SendEmail, def.SendEmail) = 1 
	--	AND
	--		t.duetime < (getdate()) 
	--	order by r.[ID], CONVERT(varchar, t.duetime, 101)
		
	--	OPEN INNEROVERDUECURS
	--		FETCH NEXT FROM INNEROVERDUECURS INTO  @ReportID, @StatusReport, @Task, @DueDate, @DaysOverdue
	--		WHILE @@FETCH_STATUS = 0 BEGIN		
				
	--			IF @i = 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '<span style=''font-size:20pt''><u><b>MinyardsProcess Overdue Report</b></u></span><br><br>' +
	--					'<table cellspacing=0 cellpadding=7>' + 
	--					'<tr><th>Status Report</th><th>Task</th><th>Due Date</th><th>Days Overdue</th></tr>' 
						

	--			IF @i > 1 AND @StatusReport <> @PrevStatusReport 
	--			BEGIN
	--				insert into 
	--				@html_output (row_html) 
	--				select '<tr style="height:10px;"><td></td><td></td><td></td></tr>'
	--			END
	
	--			SET @PrevStatusReport = @StatusReport
				
	--			insert into 
	--				@html_output (row_html) 
	--				select '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@DueDate+'</td><td style="text-align:center;">'+CAST(@DaysOverdue as varchar)+'</td></tr>'
	
	--			SELECT @i = @i + 1

	--			FETCH NEXT FROM INNEROVERDUECURS INTO   @ReportID, @StatusReport, @Task, @DueDate, @DaysOverdue
	--		END
	--	CLOSE INNEROVERDUECURS
	--	DEALLOCATE INNEROVERDUECURS

	--		if @i > 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '</table><br><hr><br>'
	--		set @j = @j + @i

	--	--end of overdue
	--	set @i = 0
	
	--	-- due date changes
	--	DECLARE INNERDDCCURS CURSOR
	--	FOR 
	--	select 
	--		'<a href="' + a.AppUrl + '/MyInbox.aspx?reportID=' + CAST(ID as varchar) + '">'
	--			+  minyardsprocess.dbo.QStatus_GetUserNames(ID) + Name 
	--		+ '</a>', 
	--		a.description, 
	--		CONVERT(varchar, a.ddo, 101), 
	--		CONVERT(varchar, a.dd, 101)
	--	FROM
	--	(
	--		select distinct r.ID, r.name, c.name as description, convert(varchar, min(ddc.duedateold), 101) as ddo, isnull(convert(varchar, t.duetime, 101), 'No due date') as dd, a.appURL 
	--		from minyardsprocess.dbo.QStatus_duedatechanges ddc
	--		inner join minyardsprocess.dbo.Qcheck_activechecklists t on ddc.activechecklistid = t.id
	--		inner join minyardsprocess.dbo.QCheck_ChecklistInstances i on i.ID = t.InstanceID and i.isdeleted = 0
	--		inner join minyardsprocess.dbo.QCheck_Checklists c on c.ID = i.ChecklistID and c.IsDeleted = 0
	--		inner join minyardsprocess.dbo.QStatus_ActiveChecklisttasktype actt on actt.ActiveChecklistID = t.ID
	--		inner join minyardsprocess.dbo.QStatus_TaskTypes tt on actt.TaskType = tt.ID
	--		inner join minyardsprocess.dbo.QStatus_report r on r.id = tt.reportID
	--		inner join minyardsprocess.dbo.QStatus_supervisors s on s.directsupervisor = 1
	--		and s.reportID = r.ID
	--		inner join 
	--			minyardsprocess.dbo.QCheck_Groups g
	--		on
	--			g.id = s.supervisorgroupid
	--		inner join 
	--			minyardsprocess.dbo.QCheck_Groupmembership gm
	--		on 
	--			gm.groupid = g.id
	--		inner join 
	--			minyardsprocess.dbo.QCheck_Users u
	--		on 
	--			u.id = gm.userID
	--		and
	--			u.shortname = @SupervisorName
	--		INNER JOIN
	--		minyardsprocess.dbo.qcheck_appsettings a
	--		ON
	--			u.App = a.ID
	--		inner join 
	--			minyardsprocess.dbo.QStatus_SupervisorEmailDefaults def
	--		on 
	--			def.EmailType = 'DueDateChanges'
	--		AND 	(
	--				(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
	--					OR
	--				(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
	--			)
	--		left outer join 
	--			minyardsprocess.dbo.QStatus_SupervisorEmailPreferences pref
	--		ON
	--			pref.type = def.id
	--		AND
	--			pref.UserID = u.ID
	--		inner join
	--			minyardsprocess.dbo.QStatus_CondensedEmails ce
	--		ON
	--			ce.UserID = u.ID
	--		where 
	--			isnull(pref.SendEmail, def.SendEmail) = 1 
	--		AND 
	--			ddc.updatedt > getdate() - 1
	--		group by t.id, t.duetime, c.name, r.name, r.ID, a.appURL
	--		having isnull(min(ddc.duedateold),0)<>isnull(t.duetime,0)

	--	) a

		
	--	OPEN INNERDDCCURS
	--		FETCH NEXT FROM INNERDDCCURS INTO  @StatusReport, @Task, @OldDueDate, @DueDate
	--		WHILE @@FETCH_STATUS = 0 BEGIN		
								
	--			IF @i = 0
	--				insert into 
	--				@html_output (row_html) 
	--				select '<span style=''font-size:20pt''><u><b>MinyardsProcess Due Date Changes</b></u></span><br><br>' +
	--					'<table cellspacing=0 cellpadding=13>' +
	--					'<tr><th>Status Report</th><th>Task</th><th>Old Due Date</th><th>New Due Date</th></tr>' 
						
	
	--			IF @i > 1 AND @StatusReport <> @PrevStatusReport 
	--			BEGIN
	--				insert into 
	--				@html_output (row_html) 
	--				select '<tr style="height:10px;"><td></td><td></td><td></td><td></td></tr>'
	--			END
	
	--			SET @PrevStatusReport = @StatusReport
				
	--			insert into 
	--				@html_output (row_html) 
	--				select  '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@OldDueDate+'</td><td>'+@DueDate+'</td></tr>'
	
				
	--			SELECT @i = @i + 1

	--			FETCH NEXT FROM INNERDDCCURS INTO   @StatusReport, @Task, @OldDueDate, @DueDate
	--		END
	--	CLOSE INNERDDCCURS
	--	DEALLOCATE INNERDDCCURS

	--		if @i > 0
	--			insert into 
	--				@html_output (row_html) 
	--				select '</table><br><hr><br>'
	--		set @j = @j + @i



	--if @j > 0 
	--	insert into @html_output (row_html) select '<br> <a href="'+@APPURL+'">'+@APPURL+'</a><br><br>'

	

--	insert into @html_output (row_html) select '</body></html>'
--	SELECT row_html FROM @html_output ORDER BY seq

--	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_CopyTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







create                      PROCEDURE [dbo].[QStatus_CopyTask]
	@TaskID int,
	@Type int,
	@Copied bit = 0 output
AS
BEGIN
	
	DECLARE @CurrentPriority int
	DECLARE @AlreadyExists bit
	DECLARE @InstanceID int


	SET @AlreadyExists = 0

	SELECT @AlreadyExists = 1 FROM 
	QStatus_ActiveChecklistTaskType
	WHERE ActiveChecklistID = @TaskID
	AND TaskType in (  --check here to make sure it isnt already on the report.  Cannot have two copies of the same task
			-- on the same report.
				Select ID from QStatus_TaskTypes
				WHERE ReportID =
					(
						SELECT ReportID from QStatus_TaskTypes
						WHERE ID = @Type
					)
	)
		

	IF @AlreadyExists = 0
	BEGIN

		SELECT 	@CurrentPriority = Priority
		FROM QStatus_ActiveChecklistTaskType
		WHERE ActiveChecklistID = @TaskID

		--copy over the active task
		INSERT INTO QStatus_ActiveChecklistTaskType
		SELECT @TaskID, @Type, @CurrentPriority, getdate()

		SET @Copied = 1

		SELECT @InstanceID = instanceID 
		FROM QCheck_ActiveChecklists
		WHERE ID = @TaskID

		SELECT @AlreadyExists = 1 FROM 
		QStatus_InstanceTaskType
		WHERE InstanceID = @InstanceID
		AND TaskType in (  --check here to make sure it isnt already on the report.  Cannot have two copies of the same task
				-- on the same report.
					Select ID from QStatus_TaskTypes
					WHERE ReportID =
						(
							SELECT ReportID from QStatus_TaskTypes
							WHERE ID = @Type
						)
		)

		IF @AlreadyExists = 0
		BEGIN
			-- copy the instance
			INSERT INTO QStatus_InstanceTaskType
			SELECT @InstanceID, @Type
		END
	END
	
	




END














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_CreateNewComment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_CreateNewComment]
	@TaskID int,
	@UserID int,
	@Comments varchar(1500),
	@NewID int output,
	@CommentsInitials varchar(100) output,
	@FullName varchar(50) output
AS
BEGIN

	DECLARE @SpecialTask bit
	SET @SpecialTask = 0

	IF @TaskID < 0
	BEGIN
		SET @TaskID = abs(@TaskID)
		SET @SpecialTask = 1
	END
	
	
	SELECT @CommentsInitials = fullname,--UPPER(LEFT(replace(shortname, 'phi-', ''), 2)), 
		@FullName = FullName
	FROM
		QCheck_Users
	WHERE
		ID = @UserID
	

	IF LEN(LTRIM(RTRIM(@Comments))) >0
		BEGIN	
			DECLARE @DisplayOrder int
			SELECT 	@DisplayOrder = ISNULL(Max(DisplayOrder), 0)
			FROM
				QStatus_Comments
			WHERE 
				ForeignKeyID = @taskID
			AND
				SpecialTask = @SpecialTask

			INSERT INTO
					QStatus_Comments
			(ForeignKeyID, Comments, DisplayOrder, CommentDt, Initials, UserID, SpecialTask)
			VALUES
			(ABS(@taskID), @Comments, @DisplayOrder + 1, getDate(), @CommentsInitials, @UserID, @SpecialTask)

			SELECT @NewID = @@IDENTITY
			
		END	

	DELETE FROM QStatus_Comments
	WHERE 
		ForeignKeyID = @taskID
	AND
		LEN(Comments) = 0

	DELETE FROM QStatus_CommentArchive
	WHERE 
		ForeignKeyID = @taskID
	AND
		LEN(Comments) = 0

	
	If @SpecialTask = 1
	BEGIN

		UPDATE
			QStatus_Report
		SET 
			LastReportDate = getDate(),
			IsDirty = 1
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_TaskTypes tt
		ON
			tt.ReportID = r.ID
		AND
			tt.IsDeleted = 0
		INNER JOIN
			QStatus_SpecialTasks st
		ON
			st.TaskType = tt.ID
		AND
			st.ID = @TaskID
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN 
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON	
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
			
	END ELSE BEGIN
	
		UPDATE
			QStatus_Report
		SET
			IsDirty = 1
		FROM 
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes tt
				ON actt.TaskType = tt.ID
			INNER JOIN QStatus_Report r
				ON tt.ReportID = r.ID
		WHERE 
			ActiveChecklistID = @TaskID	
			
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_CreateNewPriorityComment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_CreateNewPriorityComment]
	@TaskID int,
	@UserID int,
	@Comments varchar(1500),
	@StartTime date
	
AS
BEGIN

DECLARE	@NewID int,
		@CommentsInitials varchar(100),
		@FullName varchar(50)

 if Exists(select 1 from QStatus_Comments where ForeignKeyID=@taskID and UserID=@UserID and CommentDt>@StartTime )
 begin
 Update QStatus_Comments
 set Comments=@Comments
 where ID=(select max(ID) from QStatus_Comments where ForeignKeyID=@taskID and UserID=@UserID and CommentDt>@StartTime)
 end
 else
 Begin

 EXEC	 [dbo].[QStatus_CreateNewComment]
		@TaskID = @TaskID,
		@UserID = @UserID,
		@Comments = @Comments,
		@NewID = @NewID OUTPUT,
		@CommentsInitials = @CommentsInitials OUTPUT,
		@FullName = @FullName OUTPUT
 End



END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_CreateQuickReply]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE                                          PROCEDURE [dbo].[QStatus_CreateQuickReply]
	@CommentID  int,
	@Comments varchar(1500),
	@UserID int,
	@ReplyID int output,
	@CommentsInitials varchar(100) output,
	@FullName varchar(50) output,
	@tabin int output
AS
	DECLARE @DisplayOrder int
	DECLARE @MaxDisplayOrder int
	DECLARE @foreignKeyID int
	DECLARE @SpecialTask bit
		
	SELECT @CommentsInitials = fullname,--UPPER(LEFT(ShortName, 2)), 
		@FullName = FullName
	FROM
		QCheck_Users
	WHERE
		ID = @UserID

	SELECT 
		@DisplayOrder = DisplayOrder, 
		@tabin= tabin, 
		@foreignKeyID=foreignKeyID,
		@SpecialTask = SpecialTask
	FROM QStatus_COMMENTS_All c
	INNER JOIN
		QCheck_Users u
	ON
		c.UserID = u.ID
	WHERE 
		c.ID = @CommentID

	If NOT @tabin is null
	BEGIN
	
		SELECT @MaxDisplayOrder = MAX(DisplayOrder)
		FROM
			QStatus_COMMENTS
		WHERE 
			foreignKeyID = @foreignKeyID
	
		IF @DisplayOrder < @MaxDisplayOrder
		BEGIN
			SELECT @DisplayOrder = ISNULL(MIN(DisplayOrder) - 1, @MaxDisplayOrder)
			FROM QStatus_COMMENTS
			WHERE DisplayOrder > @DisplayOrder
			AND TabIn <= @tabin
			AND foreignKeyID = @foreignKeyID
		END
	
		UPDATE QStatus_COMMENTS
		SET DisplayOrder = DisplayOrder + 1
		WHERE
			foreignKeyID = @foreignKeyID
		AND
			DisplayOrder > @DisplayOrder
	
		SET @tabin = @tabin + 1
	
		INSERT INTO
				QStatus_Comments
		(foreignKeyID, Comments, DisplayOrder, tabIn, CommentDt, Initials, UserID, ReplyID, specialTask)
		VALUES
		(@foreignKeyID, @Comments, @DisplayOrder + 1, @tabin, getDate(), @CommentsInitials, @UserID, @CommentID, @specialTask)
	
		SELECT @ReplyID = Scope_Identity()

	END

	DELETE FROM QStatus_Comments
	WHERE 
		ForeignKeyID = @foreignKeyID
	AND
		LEN(Comments) = 0

	DELETE FROM QStatus_CommentArchive
	WHERE 
		ForeignKeyID = @foreignKeyID
	AND
		LEN(Comments) = 0
	

	If @SpecialTask = 1
	BEGIN

		UPDATE
			QStatus_Report
		SET 
			LastReportDate = getDate()
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_TaskTypes tt
		ON
			tt.ReportID = r.ID
		AND
			tt.IsDeleted = 0
		INNER JOIN
			QStatus_SpecialTasks st
		ON
			st.TaskType = tt.ID
		AND
			st.ID = @foreignKeyID
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN 
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON	
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID

	END














GO
/****** Object:  StoredProcedure [dbo].[QStatus_CreateReply]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                                       PROCEDURE [dbo].[QStatus_CreateReply]
	@CommentID  int,
	@UserID int,
	@ReplyID int output,
	@ReplyToID int output,
	@ReplyToUserID int output,
	@ReplyToEmail	varchar(50) output,
	@ReplyTo varchar(50) output
AS
	DECLARE @DisplayOrder int
	DECLARE @MaxDisplayOrder int
	DECLARE @tabin int
	DECLARE @foreignKeyID int
	DECLARE @CommentsInitials VARCHAR(100)
	DECLARE @SpecialTask bit
		
	SELECT @CommentsInitials = fullname--UPPER(LEFT(ShortName, 2))
	FROM
		QCheck_Users
	WHERE
		ID = @UserID

	SELECT 
		@DisplayOrder = DisplayOrder, 
		@tabin= tabin, 
		@foreignKeyID=foreignKeyID,
		@ReplyToID = c.ID,
		@ReplyToUserID = u.ID,
		@ReplyToEmail = Email,
		@ReplyTo = FullName,
		@SpecialTask = SpecialTask
	FROM QStatus_COMMENTS_All c
	INNER JOIN
		QCheck_Users u
	ON
		c.UserID = u.ID
	WHERE 
		c.ID = @CommentID

	If NOT @tabin is null
	BEGIN
	
		SELECT @MaxDisplayOrder = MAX(DisplayOrder)
		FROM
			QStatus_COMMENTS
		WHERE 
			foreignKeyID = @foreignKeyID
	
		IF @DisplayOrder < @MaxDisplayOrder
		BEGIN
			SELECT @DisplayOrder = ISNULL(MIN(DisplayOrder) - 1, @MaxDisplayOrder)
			FROM QStatus_COMMENTS
			WHERE DisplayOrder > @DisplayOrder
			AND TabIn <= @tabin
			AND foreignKeyID = @foreignKeyID
		END
	
		UPDATE QStatus_COMMENTS
		SET DisplayOrder = DisplayOrder + 1
		WHERE
			foreignKeyID = @foreignKeyID
		AND
			DisplayOrder > @DisplayOrder
	
		INSERT INTO
				QStatus_Comments
		(foreignKeyID, Comments, DisplayOrder, tabIn, CommentDt, Initials, UserID, ReplyID, specialTask)
		VALUES
		(@foreignKeyID, '', @DisplayOrder + 1, @tabin + 1, getDate(), @CommentsInitials, @UserID, @CommentID, @specialTask)
	
		SELECT @ReplyID = Scope_Identity()

	END

	





























GO
/****** Object:  StoredProcedure [dbo].[QStatus_DefaultStatus]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                                 PROCEDURE [dbo].[QStatus_DefaultStatus]
	@UserID int,
	@ReportID int output
AS
BEGIN
	SET NOCOUNT ON

	SELECT @ReportID = r.ID
	FROM QStatus_Report r
	INNER JOIN QStatus_GroupReport gr
	ON  r.ID = gr.ReportID
	AND r.IsDeleted = 0
	AND gr.DefaultReport = 1
	INNER JOIN QCheck_Groups g
	ON g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @UserID

	IF @ReportID IS NULL
	BEGIN
	
		DECLARE @GroupID int

		SELECT @GroupID = ID
		FROM QCheck_Groups
		WHERE Owner = @UserID
		AND SingleMemberGroup = 1
		
		DECLARE @ReportName varchar(100)
		SELECT @ReportName = u.fullname 
		FROM QCheck_Users u
		WHERE u.ID = @UserID	

		IF @GroupID IS NOT NULL BEGIN
		
			INSERT INTO QStatus_Report
			([Name])
			VALUES
			(@ReportName)
		
			SELECT @ReportID = SCOPE_IDENTITY()

			INSERT INTO QStatus_GroupReport
			(GroupID, ReportID, DefaultReport)
			VALUES
			(@GroupID, @ReportID, 1)
			
			EXEC QStatus_Init @ReportID
		
		END
		
	END

	SET NOCOUNT OFF
END


















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_DefaultStatus_All]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Proc [dbo].[QStatus_DefaultStatus_All]
as
begin

	declare @usersNoStatus table
	(
		userid int
	)

	insert into @usersNoStatus
		select id from qcheck_users u
		where u.isdeleted = 0
		and u.id not in (
							select gm.userid from qstatus_groupreport gr
								inner join qcheck_groupmembership gm
									on gm.groupid = gr.groupid
				
						)

	declare @userid int
	declare @ReportID int
	
	while exists (select top 1 userid from @usersNoStatus)
	begin
		select top 1 @userid = userid from @usersNoStatus
	
		exec [QStatus_DefaultStatus] @Userid, @ReportID output

		delete from @usersNoStatus
		where userid = @userid
	end

	--Add corresponding folder in Manage Tasks for status reports
	INSERT INTO QCheck_Folders (UserID, FolderName, ParentFolder)
	select u.ID, 'Status - ' + u.FullName, 0
	from QCheck_Users u
	LEFT JOIN QCheck_Folders f ON u.ID = UserID AND f.FolderName = 'Status - ' + u.FullName
	where u.IsDeleted = 0 AND f.ID IS NULL

end
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteCompletedTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE            PROCEDURE [dbo].[QStatus_DeleteCompletedTasks]
	@ReportID int,
	@ArchiveDate datetime,
	@RowsDeleted int output
AS
BEGIN
	UPDATE QStatus_Tasks
		SET IsDeleted = 1
	FROM QStatus_Tasks t
		INNER JOIN
	     QStatus_TaskTypes tt
		ON t.Type = tt.ID
		AND tt.NativeType = 2
	WHERE
		(@ReportID = -1 OR t.ReportID = @ReportID)
	AND
		t.UpdatedDate < @ArchiveDate
	and 	
		t.IsDeleted = 0

	SELECT @RowsDeleted = @@ROWCOUNT
END
GO

/****** Object:  StoredProcedure [dbo].[QStatus_DeleteCompletedTasksDaily]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE           PROCEDURE [dbo].[QStatus_DeleteCompletedTasksDaily]
	
AS
BEGIN
	UPDATE QStatus_Tasks
		SET IsDeleted = 1
	FROM QStatus_Tasks t
		INNER JOIN
	     QStatus_TaskTypes tt
		ON t.Type = tt.ID
		AND tt.NativeType = 2
	WHERE
		t.UpdatedDate < DateAdd(Day, -7, getdate())
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteDepartmentSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE                         PROCEDURE [dbo].[QStatus_DeleteDepartmentSupervisors]
	@ID int
AS

BEGIN

	SET NOCOUNT ON
	
		DELETE FROM QStatus_supervisordepartments
		WHERE ID = @ID
	

	SET NOCOUNT OFF

End
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE                                     PROCEDURE [dbo].[QStatus_DeleteOnHold]
	@ID int
AS
BEGIN

	delete from grading_onhold
		where id = @ID


END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE                       PROCEDURE [dbo].[QStatus_DeleteReport]
	@ReportID int
AS
BEGIN

		UPDATE
			QStatus_Report
		SET 
			IsDeleted = 1
		WHERE 
			ID = @ReportID
		
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteReportUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_DeleteReportUser]
	@ID int
AS

BEGIN
	SET NOCOUNT ON

	-- 10/9/2014 dalvarado - If the last controller is deleted from a report, just go ahead
	-- and delete the report.
	DECLARE @ReportID INT,
			@GroupCount INT
	
	SELECT @ReportID = ReportID
	FROM QStatus_GroupReport 
	WHERE ID = @ID
	
	SELECT @GroupCount = COUNT(*)
	FROM QStatus_GroupReport
	WHERE ReportID = @ReportID
	
	IF @GroupCount = 1 BEGIN
		UPDATE QStatus_Report
		SET IsDeleted = 1
		WHERE ID = @ReportID
	END
	-- End 10/9/2014 change
	
	DELETE FROM
		QStatus_GroupReport
	WHERE ID = @ID

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteRestoreSection]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                  PROCEDURE [dbo].[QStatus_DeleteRestoreSection]
	@TaskID int
AS
BEGIN

	DECLARE @IsDeleted bit
	DECLARE @CurrentDisplayOrder int
	DECLARE @ReportID int

	SELECT @IsDeleted = IsDeleted, 
		@CurrentDisplayOrder = DisplayOrder,
		@ReportID = ReportID
	FROM QStatus_TaskTypes
	WHERE
		ID = @TaskID

	IF @IsDeleted = 0
	BEGIN
		UPDATE
			QStatus_TaskTypes
		SET 
			IsDeleted = 1
		WHERE
			ID = @TaskID

		UPDATE QStatus_TaskTypes
		SET DisplayOrder = DisplayOrder - 1
		WHERE
			ReportID = @ReportID
		AND
			DisplayOrder >= @CurrentDisplayOrder
		AND
			IsDeleted = 0
	END
	ELSE
	BEGIN
		SELECT @CurrentDisplayOrder = MAX(DisplayOrder) + 1
		FROM
			QStatus_TaskTypes
		WHERE
			IsDeleted = 0
		AND
			ReportID = @ReportID

		UPDATE
			QStatus_TaskTypes
		SET 
			IsDeleted = 0,
			DisplayOrder = @CurrentDisplayOrder
		WHERE
			ID = @TaskID
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_DeleteSupervisor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE             PROCEDURE [dbo].[QStatus_DeleteSupervisor]
	@ID int,
	@Allow int = 0
AS
BEGIN
	
	IF @Allow = 1
		DELETE FROM QStatus_Supervisors
		WHERE ID = @ID

	
END

SET QUOTED_IDENTIFIER OFF 

GO
/****** Object:  StoredProcedure [dbo].[QStatus_EditComment]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE                                       PROCEDURE [dbo].[QStatus_EditComment]
	@CommentID int,
	@Comments varchar(1500),
	@CommentsInitials varchar(100) output,
	@FullName varchar(50) output,
	@tabin int output
AS
BEGIN

	DECLARE @ForeignKeyID int
	DECLARE @DisplayOrder int
	DECLARE @SpecialTask bit
	DECLARE @DisplayOrderMax int
	DECLARE @UserID int

	SELECT @CommentsInitials = Initials,
		@tabin = TabIn,
		@FullName = FullName,
		@ForeignKeyID = ForeignKeyID,	
		@DisplayOrder = DisplayOrder,
		@SpecialTask = SpecialTask,
		@UserID = c.UserID
	FROM
		qstatus_comments c
	INNER JOIN
		QCheck_users U
		on u.id = c.UserID
	WHERE
		c.ID = @CommentID
		
	
	SELECT @DisplayOrderMax = Min(DisplayOrder)
	FROM qstatus_comments
	WHERE ForeignKeyID = @ForeignKeyID
	AND @SpecialTask = SpecialTask
	AND DisplayOrder > @DisplayOrder
	AND tabin <= @tabin

	UPDATE qstatus_comments SET Comments = @Comments, CommentDt = getdate()
	where id = @CommentID

	/*If len(@comments) = 0
	BEGIN
		--unindent
		update 
			QStatus_Comments
		set @tabin = @tabin - 1
		WHERE
			DisplayOrder > @DisplayOrder
		AND
			DisplayOrder < @DisplayOrderMax
		AND	
			ForeignKeyID = @ForeignKeyID
		AND 
			@SpecialTask = SpecialTask	
	END*/

	DELETE FROM QStatus_Comments
	WHERE 
		ForeignKeyID = @ForeignKeyID
	AND
		LEN(Comments) = 0

	DELETE FROM QStatus_CommentArchive
	WHERE 
		ForeignKeyID = @ForeignKeyID
	AND
		LEN(Comments) = 0
	

	If @SpecialTask = 1
	BEGIN

		UPDATE
			QStatus_Report
		SET 
			LastReportDate = getDate()
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_TaskTypes tt
		ON
			tt.ReportID = r.ID
		AND
			tt.IsDeleted = 0
		INNER JOIN
			QStatus_SpecialTasks st
		ON
			st.TaskType = tt.ID
		AND
			st.ID = @ForeignKeyID
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN 
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON	
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID

	END

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_EmailDueTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_EmailDueTasks]
	
AS
BEGIN

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1
	
	DECLARE @UserID int
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)
	SELECT @mailType = 'text/html'
	SELECT @mailSubject = 'Status Report Tasks Due Today'
	
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	DECLARE DUECURS CURSOR
	FOR 
	SELECT 	DISTINCT u.ID, u.Email, a.AppUrl + '/MyInbox.aspx?reportID=' +  CAST(u.ID as varchar)
	FROM
		QStatus_Tasks t
	INNER JOIN
		QStatus_Report r
	ON
		t.ReportID = r.[ID]
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN 
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON	
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gr.UserID
	INNER JOIN
		qcheck_appsettings a
	ON
		u.App = a.ID
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		t.Type = tt.ID
	AND
		tt.NativeType = 0
	AND
		tt.IsDeleted = 0
	WHERE
		t.IsDeleted = 0
	AND
		CONVERT(varchar, IsNull(t.DueDate,0), 101) = CONVERT(varchar, getdate(), 101)

	OPEN DUECURS

	FETCH NEXT FROM DUECURS INTO @UserID, @mailTo, @AppURL
	WHILE @@FETCH_STATUS = 0 BEGIN
		SET @mailBody = 'You have tasks on your status report that are due today.  Please update them accordingly<br><br>'
		SET @mailBody = @mailBody + '<a href="' + @AppURL + '">Status Report</a>'
		
		EXEC XPSendEmail
		    @FROM       = @mailFrom,
		    @TO         = @mailTo,
		    @subject    = @mailSubject,
		    @message    = @mailBody,
		    @type       = @mailType,
		    @server     = @mailServer
		
		
		FETCH NEXT FROM DUECURS INTO @UserID, @mailTo, @AppURL
	
	END
	CLOSE DUECURS
	DEALLOCATE DUECURS


END











































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetAlertCountDetails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QStatus_GetAlertCountDetails]
@startdate datetime = null,
@enddate datetime = null
AS

if @startdate is null 
	SELECT @startdate = getdate() - 30

if @enddate is null
	SELECT @enddate = getdate()


select distinct
u.fullname as 'User', 
g.name as 'Group Name', 
case when freqRecurrance > 1 THEN 'Every ' + CAST(freqRecurrance AS varchar(2)) + ' ' +
	case s.freqtype WHEN 2 THEN 'Days' WHEN 3 THEN 'Weeks' WHEN 4 THEN 'Months' WHEN 5 THEN 'Years' WHEN 6 THEN 'Quarters' END 
ELSE 
case s.freqtype WHEN 2 THEN 'Daily' WHEN 3 THEN 'Weekly' WHEN 4 THEN 'Monthly' WHEN 5 THEN 'Yearly' WHEN 6 THEN 'Quarterly' END
end + 
case when freqInterval > 0 then 
	' - ' + 
	case when freqtype = 3 THEN
		case when freqInterval & 1 = 1 Then 'Sun ' ELSE '' END +
		case when freqInterval & 2 = 2 Then 'Mon ' ELSE '' END +
		case when freqInterval & 4 = 4 Then 'Tue ' ELSE '' END + 
		case when freqInterval & 8 = 8 Then 'Wed ' ELSE '' END + 
		case when freqInterval & 16 = 16 Then 'Thu ' ELSE '' END + 
		case when freqInterval & 32 = 32 Then 'Fri ' ELSE '' END + 
		case when freqInterval & 64 = 64 Then 'Sat ' ELSE '' END
	when freqtype = 5 THEN
		case when freqInterval & 1 = 1 Then 'Jan ' ELSE '' END +
		case when freqInterval & 2 = 2 Then 'Feb ' ELSE '' END +
		case when freqInterval & 4 = 4 Then 'Mar ' ELSE '' END + 
		case when freqInterval & 8 = 8 Then 'Apr ' ELSE '' END + 
		case when freqInterval & 16 = 16 Then 'May ' ELSE '' END + 
		case when freqInterval & 32 = 32 Then 'Jun ' ELSE '' END + 
		case when freqInterval & 64 = 64 Then 'Jul ' ELSE '' END + 
		case when freqInterval & 128 = 128 Then 'Aug ' ELSE '' END + 
		case when freqInterval & 256 = 256 Then 'Sep ' ELSE '' END + 
		case when freqInterval & 512 = 512 Then 'Oct ' ELSE '' END + 
		case when freqInterval & 1024 = 1024 Then 'Nov ' ELSE '' END + 
		case when freqInterval & 2048 = 2048 Then 'Dec ' ELSE '' END
	ELSE
	' '
	END
ELSE
' '
END
as 'Task Frequency', 
--case s.freqtype WHEN 2 THEN 'Daily' WHEN 3 THEN 'Weekly' WHEN 4 THEN 'Monthly' WHEN 5 THEN 'Yearly' WHEN 6 THEN 'Quarterly' END AS Frequency2, 
--Convert(varchar(10),s.firstDueDate,101), s.lastDueDate, 
c.name as 'Task Name', 
ar.DaysBefore, ar.AlertTime, ar.AlertType, ar.AlertText
from qcheck_groups g inner join qcheck_alerts ar on g.id = ar.alerteegroupid
INNER JOIN qcheck_checklistinstances ci ON ar.instanceid = ci.id INNER JOIN
qcheck_schedule s on ci.scheduleid = s.id INNER JOIN
qcheck_checklists c on ci.checklistid = c.id INNER JOIN
qcheck_groupmembership gm on gm.groupid = g.id INNER JOIN
qcheck_users u on gm.userid = u.id INNER JOIN
 qcheck_activealerts aa on ar.id = aa.alertid INNER JOIN
(
select top 20 u.id, count(aa.id) as 'Alert Count'
from qcheck_groups g inner join qcheck_Assignments a on g.id = a.groupid 
INNER JOIN qcheck_checklistinstances ci ON a.instanceid = ci.id INNER JOIN
qcheck_schedule s on ci.scheduleid = s.id INNER JOIN
qcheck_checklists c on ci.checklistid = c.id INNER JOIN
qcheck_groupmembership gm on gm.groupid = g.id INNER JOIN
qcheck_users u on gm.userid = u.id and u.isdeleted = 0
inner join qcheck_alerts ar on ci.id = ar.instanceid
inner join qcheck_activealerts aa on ar.id = aa.alertid
where aa.senttime is not null and aa.senttime > @startdate and aa.senttime < @enddate
and s.freqtype > 1 and (s.lastduedate is null or s.lastduedate > getdate()) and c.template = 0 and c.isdeleted = 0 and u.isdeleted = 0
group by u.id
order by count(aa.id) desc
) ucount ON u.id = ucount.id
where s.freqtype > 1 and (s.lastduedate is null or s.lastduedate > @enddate) and c.template = 0 and c.isdeleted = 0 and u.isdeleted = 0
order by u.fullname
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetAlertCounts]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  PROCEDURE [dbo].[QStatus_GetAlertCounts] 
@startdate datetime = null,
@enddate datetime = null

AS

if @startdate is null 
	SELECT @startdate = getdate() - 30

if @enddate is null
	SELECT @enddate = getdate()
/*
declare @work table
(
	userid int,
	fullname varchar(50)
)

insert into @work
select distinct u.id, u.fullname
from
qcheck_groups g inner join qcheck_alerts ar on g.id = ar.alerteegroupid
INNER JOIN qcheck_checklistinstances ci ON ar.instanceid = ci.id INNER JOIN
qcheck_schedule s on ci.scheduleid = s.id INNER JOIN
qcheck_checklists c on ci.checklistid = c.id INNER JOIN
qcheck_groupmembership gm on gm.groupid = g.id INNER JOIN
qcheck_users u on gm.userid = u.id and u.isdeleted = 0
inner join qcheck_activealerts aa on ar.id = aa.alertid
where aa.senttime is not null and aa.senttime > getdate() - 30
and s.freqtype > 1 and (s.lastduedate is null or s.lastduedate > getdate()) and c.template = 0 and c.isdeleted = 0 and u.isdeleted = 0


insert into @work
select u.id, u.fullname
 from qcheck_alerts a INNER JOIN
                      QCheck_ActiveAlerts aa ON a.ID = aa.AlertID INNER JOIN
                      QCheck_ActiveChecklists ac ON aa.ActiveChecklistID = ac.ID INNER JOIN
			QCheck_ChecklistInstances ON QCheck_ChecklistInstances.ID = ac.InstanceID INNER JOIN 
			QCheck_Assignments ass ON ass.InstanceID = QCheck_ChecklistInstances.ID INNER JOIN
                      QCheck_ActiveAssignments aas ON ass.ID = aas.AssignmentsID INNER JOIN
                      QCheck_Checklists c ON QCheck_ChecklistInstances.ChecklistID = c.ID inner join
		qcheck_groups g on ass.groupid = g.id inner join qcheck_groupmembership gm on g.id = gm.groupid
inner join qcheck_users u on u.id = gm.userid
WHERE     (a.AlertType = 'Reminder') AND (a.IsDeleted = 0) and u.isdeleted = 0
AND (a.senttime is null OR (a.SentTime > GETDATE() - 30) AND (a.SentTime < GETDATE())) and
(QCheck_ChecklistInstances.IsDeleted = 0) AND (c.IsDeleted = 0) 


select top 20 fullname, count(fullname)
from @work
group by fullname
order by count(fullname) desc
*/
select top 20 u.fullname as 'User', count(aa.id) as 'Alert Count'
from qcheck_groups g inner join qcheck_Assignments a on g.id = a.groupid 
INNER JOIN qcheck_checklistinstances ci ON a.instanceid = ci.id INNER JOIN
qcheck_schedule s on ci.scheduleid = s.id INNER JOIN
qcheck_checklists c on ci.checklistid = c.id INNER JOIN
qcheck_groupmembership gm on gm.groupid = g.id INNER JOIN
qcheck_users u on gm.userid = u.id and u.isdeleted = 0
inner join qcheck_alerts ar on ci.id = ar.instanceid
inner join qcheck_activealerts aa on ar.id = aa.alertid
where aa.senttime is not null and aa.senttime > @startdate and aa.senttime < @enddate
and s.freqtype > 1 and (s.lastduedate is null or s.lastduedate > getdate()) and c.template = 0 and c.isdeleted = 0 and u.isdeleted = 0
group by u.fullname
order by count(aa.id) desc
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetAlertTimes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE    PROCEDURE [dbo].[QStatus_GetAlertTimes](
	@ID int,
	@Type int
)	
 AS

	
	IF @Type = 1
	BEGIN
		select 
			CASE a.AlertType 
				WHEN 'Reminder' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				WHEN 'Custom' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				ELSE
					ac.DueTime
			END
			as alerttime,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Custom' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Complete' THEN
					'When Completed'
				ELSE
					CAST(ac.DueTime as varchar(50))
			END
			as alerttimetext,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					dbo.QCheck_AssigneesList(ac.instanceID)
				ELSE
					u.FullName
			END as alertee,
			CASE a.AlertType
				WHEN 'Complete' THEN
					'When Completed'
				WHEN 'Overdue' THEN
					'When Overdue'
				WHEN 'Hours' THEN
					'Every '+cast(a.AlertTime as varchar(10))+' hours after overdue'
				ELSE
					a.AlertType
			END as type,
			CASE WHEN aa.senttime is null then 0 else 1 end as issent,
			CASE a.AlertType
				WHEN 'Complete' THEN 4
				WHEN 'Overdue' THEN 2
				WHEN 'Hours' THEN 3
				ELSE 1
			END as typeid
		from qcheck_alerts a
		inner join qcheck_activealerts aa
		on a.id = aa.alertid
		and aa.activechecklistid = @ID
		inner join qcheck_activechecklists ac
		on ac.id = @ID
		left outer join qcheck_groups g
		on g.id = a.alerteegroupid
		left outer join qcheck_groupmembership gm
		on gm.groupid = g.id
		left outer join qcheck_users u
		on u.id = gm.userid
		where a.alerttype in ('Custom', 'Complete', 'Overdue', 'Hours', 'Reminder')
		order by typeid, alerttime
	END 
	ELSE IF @Type = 3
		BEGIN
		select 
			CASE a.AlertType 
				WHEN 'Reminder' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime))
				WHEN 'Custom' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime))
				ELSE
					udt.DueTime
			END
			as alerttime,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Custom' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Complete' THEN
					'When Completed'
				ELSE
					CAST(udt.DueTime as varchar(50))
			END
			as alerttimetext,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					dbo.QCheck_AssigneesList(udt.instanceID)
				ELSE
					u.FullName
			END as alertee,
			CASE a.AlertType
				WHEN 'Complete' THEN
					'When Completed'
				WHEN 'Overdue' THEN
					'When Overdue'
				WHEN 'Hours' THEN
					'Every '+cast(a.AlertTime as varchar(10))+' hours after overdue'
				ELSE
					a.AlertType
			END as type,
			0 issent,
			CASE a.AlertType
				WHEN 'Complete' THEN 4
				WHEN 'Overdue' THEN 2
				WHEN 'Hours' THEN 3
				ELSE 1
			END as typeid
		from qcheck_alerts a
		inner join qcheck_upcomingduetimes udt
		on udt.id = @ID
		and a.instanceid = udt.instanceid
		left outer join qcheck_groups g
		on g.id = a.alerteegroupid
		left outer join qcheck_groupmembership gm
		on gm.groupid = g.id
		left outer join qcheck_users u
		on u.id = gm.userid
		where a.alerttype in ('Custom', 'Complete', 'Overdue', 'Hours', 'Reminder')
		order by typeid, alerttime
	END
	ELSE
	BEGIN
		select 
			CASE a.AlertType 
				WHEN 'Reminder' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				WHEN 'Custom' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				ELSE
					ac.DueTime
			END
			as alerttime,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Custom' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Complete' THEN
					'When Completed'
				ELSE
					CAST(ac.DueTime as varchar(50))
			END
			as alerttimetext,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					dbo.QCheck_AssigneesList(ac.instanceID)
				ELSE
					u.FullName
			END as alertee,
			CASE a.AlertType
				WHEN 'Complete' THEN
					'When Completed'
				WHEN 'Overdue' THEN
					'When Overdue'
				WHEN 'Hours' THEN
					'Every '+cast(a.AlertTime as varchar(10))+' hours after overdue'
				ELSE
					a.AlertType
			END as type,
			CASE WHEN aa.senttime is null then 0 else 1 end as issent,
			CASE a.AlertType
				WHEN 'Complete' THEN 4
				WHEN 'Overdue' THEN 2
				WHEN 'Hours' THEN 3
				ELSE 1
			END as typeid
		from qcheck_alerts a
		inner join qcheck_activealertarchive aa
		on a.id = aa.alertid
		and aa.activechecklistid = @ID
		inner join qcheck_activechecklistarchive ac
		on ac.id = @ID
		left outer join qcheck_groups g
		on g.id = a.alerteegroupid
		left outer join qcheck_groupmembership gm
		on gm.groupid = g.id
		left outer join qcheck_users u
		on u.id = gm.userid
		where a.alerttype in ('Custom', 'Complete', 'Overdue', 'Hours', 'Reminder')
		order by typeid, alerttime

	END






GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetAllCommentsByChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[QStatus_GetAllCommentsByChecklist]
	@checklistID int
as
begin
	SELECT 
		   cm.TabIn, '[' + CONVERT(varchar, cm.CommentDt, 101) + '] [' + cm.Initials + '] ' + cm.Comments as Comments
	FROM 
		   QCheck_Checklists_All c 
		   INNER JOIN QCheck_ChecklistInstances_All ci
				  ON c.ID = ci.ChecklistID
		   INNER JOIN QCheck_ActiveChecklists_All ac
				  ON ci.ID = ac.InstanceID
		   INNER JOIN QStatus_Comments_All cm
				  ON cm.ForeignKeyID = ac.ID
				  AND cm.SpecialTask = 0
	WHERE 
		   c.ID = @ChecklistID
	ORDER BY
		   cm.CommentDt,
		   cm.DisplayOrder
end
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetAllReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE                                  PROCEDURE [dbo].[QStatus_GetAllReports]
	
AS
BEGIN

	SELECT
		'' as Email, --u.Email,
		r.ID as ReportID,
		u.ID as UserID
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		r.ID = gr.ReportID
	AND
		r.IsDeleted = 0
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	where
		r.LastReportDate > getDate() - 1
	
END









































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetAssigneeVisibility]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE                        PROCEDURE [dbo].[QStatus_GetAssigneeVisibility]
	@UserID int,
	@ReportID int,
	@Visible bit output
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @Force bit
	SET @Force = 0

	SET @Visible = 0

	SELECT @Force = 1, @Visible = 1
	FROM QStatus_Preferences
	WHERE UserID = @UserID
	AND PreferenceType = 'AssigneeOn'
	AND PreferenceValue = CAST(@ReportID as varchar(10))

	SELECT @Force = 1, @Visible = 0
	FROM QStatus_Preferences
	WHERE UserID = @UserID
	AND PreferenceType = 'AssigneeOff'
	AND PreferenceValue = CAST(@ReportID as varchar(10))
	
	--use defaults - visible for multiple user report
	IF @Force = 0
	BEGIN
		DECLARE @Cnt int
		
		SELECT @Cnt = Count(distinct u.ID)
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
		ON g.ID = gr.GroupID
		AND gr.ReportID = @ReportID
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = g.ID
		INNER JOIN QCheck_Users u
		ON u.ID = gm.UserID
		AND u.IsDeleted = 0
		
		IF @Cnt > 1 SET @Visible = 1
	END

	SET NOCOUNT OFF
END








































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetChecklistItems]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[QStatus_GetChecklistItems]
	@checklistID int
as
begin
	select Text, IsDeleted, ChecklistID, SequenceNum from QCheck_Items 
	where checklistid = @checklistID
	union all
	select Text, IsDeleted, ChecklistID, SequenceNum from QCheck_ItemArchive
	where checklistid = @checklistID
	order by ChecklistID, SequenceNum
end
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetColor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO














CREATE                               PROCEDURE [dbo].[QStatus_GetColor]
	@UserID int,
	@ReportID int,
	@ColorNum int output
AS
BEGIN
	SET NOCOUNT ON

		--assume interested party
		SET @ColorNum = 50 --purple

		--check if you are a controller
		SELECT @ColorNum = 0 --red
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
		ON g.ID = gr.GroupID
		AND gr.ReportID = @ReportID
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = g.ID
		AND gm.UserID = @UserID

		--check for custom color
		IF @ColorNum = 50
			SELECT @ColorNum = sc.ColorNum 
			FROM 
				QStatus_SupervisorColors sc
			WHERE
				sc.SupervisorUserID = @UserID

		--check for supervisor
		IF @ColorNum = 50
			SELECT @ColorNum = 3 -- green
			FROM QStatus_Supervisors s
			INNER JOIN QCheck_Groups g
			ON g.ID = s.SupervisorGroupID
			AND s.ReportID = @ReportID
			AND s.InterestedParty = 0	
			INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gm.UserID = @UserID	



				

	SET NOCOUNT OFF
END
















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetColumnWidth]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                  PROCEDURE [dbo].[QStatus_GetColumnWidth]
	@UserID int,
	@ReportID int,
	@Width int output
AS
	
	SELECT @Width = 10

	SELECT @Width = ColumnWidth
	FROM
		QStatus_ColumnWidth
	WHERE
		UserID = @UserID
	AND
		ReportID = @ReportID




GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                                             PROCEDURE [dbo].[QStatus_GetComments]
	@ReportID int,
	@TaskID  int,
	@UserID int = null,
	@deletedDate datetime = null
AS

	SET NOCOUNT ON

	DECLARE @HasRelatedComments bit
	SET  @HasRelatedComments = 0

	SELECT @HasRelatedComments = 1
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		(
			SELECT    
				ID, InstanceID
			FROM         QCheck_ActiveChecklists
			UNION ALL
			SELECT     
				ID, InstanceID
			FROM         
				QCheck_ActiveChecklistArchive 

		) AC
	ON
		C.ForeignKeyID = AC.ID
	AND
		AC.ID <> @TaskID
	INNER JOIN
		(
			SELECT    
				ID, ChecklistID
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID
			FROM         
				QCheck_ChecklistInstanceArchive 

		) CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID = @TaskID

	SELECT 
		Distinct null as archiveid, C.*, null as archivedt, 
		task.TaskID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName,
		2147483647 as CommentSort

	FROM
		QStatus_COMMENTS C
	INNER JOIN 

		(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		c.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID

	union all

	SELECT 
		Distinct C.*,
		task.TaskID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName,
		C.ArchiveID as CommentSort
 
	FROM
		QStatus_COMMENTarchive C
	INNER JOIN 

		(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				(
					SELECT *, null as archivedate, 0 as deleted FROM 
						QStatus_ActiveChecklistTaskType 
					UNION
					SELECT *, 1 as deleted FROM 
						QStatus_ActiveChecklistTaskTypeArchive 
				) actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		C.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = C.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	ORDER BY CommentSort, C.DisplayOrder


	SELECT @HasRelatedComments

GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetCommentsAllLegalReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO














CREATE        PROCEDURE [dbo].[QStatus_GetCommentsAllLegalReport]
	@Seed int,
	@ReportID int, 
	@StartDate datetime,
	@EndDate datetime
AS

	--DECLARE @HasRelatedComments bit
	--SET  @HasRelatedComments = 0

	SET NOCOUNT ON

	SELECT 
		Distinct C.ID,C.ForeignKeyID,C.Comments,C.DisplayOrder,C.TabIn,C.CommentDt,C.Initials,C.UserID,C.ReplyID,C.SpecialTask, 
		tt.keyID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTS C
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		c.ForeignKeyID = abs(tt.KeyID)
	AND
		c.SpecialTask = tt.SpecialTask
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID

	WHERE c.commentdt <= @enddate AND c.commentdt >= @startdate
	UNION ALL
SELECT 
		Distinct C.ID,C.ForeignKeyID,C.Comments,C.DisplayOrder,C.TabIn,C.CommentDt,C.Initials,C.UserID,C.ReplyID,C.SpecialTask,  
		tt.keyID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTARCHIVE C
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		c.ForeignKeyID = abs(tt.KeyID)
	AND
		c.SpecialTask = tt.SpecialTask
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID

	WHERE c.commentdt <= @enddate AND c.commentdt >= @startdate
	
	ORDER BY C.DisplayOrder




	--SELECT 0--@HasRelatedComments

	SELECT distinct ac2.ID
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		(
			SELECT    
				ID, InstanceID
			FROM         QCheck_ActiveChecklists
			UNION ALL
			SELECT     
				ID, InstanceID
			FROM         
				QCheck_ActiveChecklistArchive 

		) AC
	ON
		C.ForeignKeyID = AC.ID
	AND
		c.SpecialTask = 0
	INNER JOIN
		(
			SELECT    
				ID, ChecklistID
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID
			FROM         
				QCheck_ChecklistInstanceArchive 

		) CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID <> AC.ID
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		ac2.ID = tt.KeyID
	
	WHERE c.commentdt <= @enddate AND c.commentdt >= @startdate

	delete from QStatus_TempTasks where id = @Seed OR input_date < dateadd(mi, -1, getdate())
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetDefaultReportID]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_GetDefaultReportID] (
	@UserID INT = 24,
	@ReportID INT OUTPUT
) AS

BEGIN

	SELECT 
		@ReportID = r.ID
	FROM 
		QCheck_Users U
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
			AND g.SingleMemberGroup = 1
		INNER JOIN QStatus_GroupReport gr
			ON g.ID = gr.GroupID
			AND gr.DefaultReport = 1
		INNER JOIN QStatus_Report r
			ON gr.ReportID = r.ID
			AND r.IsDeleted = 0
	WHERE
		U.ID = @UserID
		
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetDepartments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE                          PROCEDURE [dbo].[QStatus_GetDepartments]
	
AS

BEGIN

	SET NOCOUNT ON
	

		SELECT distinct d.DepartmentID, d.Department
		FROM tbldepartment d
		inner join
		tblemployees e
		on e.departmentid = d.departmentid
		and e.isActive = 1
		Order by department


	SET NOCOUNT OFF

End















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetDepartmentSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO









CREATE                         PROCEDURE [dbo].[QStatus_GetDepartmentSupervisors]
	
AS

BEGIN

	SET NOCOUNT ON
	

		SELECT sd.id, 
			u.fullname as supervisor, 
			sd.DepartmentID, 
			case when sd.DepartmentID = -1 Then  
				'All Users' else 
				d.department 
			END as department
		FROM QStatus_supervisordepartments sd
		inner join
			QCheck_Users  u
		on
			u.id = sd.supervisoruserid
		left outer join
			tbldepartment d
		on 
			d.departmentid = sd.departmentid

		
		


	SET NOCOUNT OFF

End














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetDontEmailReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO













CREATE                      PROCEDURE [dbo].[QStatus_GetDontEmailReports]
	
AS
BEGIN

		SELECT 
			r.[ID],
		     	dbo.QStatus_GetUserNames(r.ID) + r.Name AS [Description]
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_DontEmail de
		on
			de.reportID = r.ID
		Order by 2
END















GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetDueDateChanges]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                                             PROCEDURE [dbo].[QStatus_GetDueDateChanges]
	@ReportID INT
AS
BEGIN
	
	SET NOCOUNT on

		select 
			c.name as description,
			convert(varchar, min(ddc.duedateold), 101) as ddo, 
			isnull(convert(varchar, t.duetime, 101), 'No due date') as dd 
		from 
			QStatus_duedatechanges ddc
		INNER JOIN 
			QCheck_ActiveChecklists T
		ON 	
			T.ID = ddc.ActiveChecklistID
		INNER JOIN
			QCheck_ChecklistInstances ci
		ON
			ci.ID = T.InstanceID
		AND
			ci.IsDeleted = 0
		INNER JOIN
			QCheck_Checklists c
		ON
			c.ID = ci.ChecklistID
		AND
			c.IsDeleted = 0		
		INNER JOIN
			QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = t.ID
		INNER JOIN
			QStatus_TaskTypes tt
		ON
			actt.TaskType = tt.ID
		AND
			tt.ReportID = @ReportID
		where 
			ddc.updatedt > getdate() - 1
		group by 
			t.duetime, 
			c.name
		having 
			isnull(min(ddc.duedateold),0) <> isnull(t.duetime,0)
		
		

	SET NOCOUNT OFF

END






























GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetEmailInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                    PROCEDURE [dbo].[QStatus_GetEmailInfo]
	@UserID int,
	@ReportID int,
	@StatusReportUserName VARCHAR(50) output,
	@From VARCHAR(500) OUTPUT,
	@AppURL VARCHAR(500) OUTPUT
AS

BEGIN
	DECLARE @CurrentTo VARCHAR(100)
		
	SELECT 
		@From = u.FullName + '<' + u.Email + '>',
		--@From = u.Email,
		@StatusReportUserName = FullName, 
		@AppURL = a.AppURL + '/MyInbox.aspx?reportID=' + CAST(@ReportID as varchar)
	FROM
		QCheck_Users u
		INNER JOIN qcheck_appsettings a
			ON a.ID = u.App
	WHERE
		u.ID = @UserID

	
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetFiveDayComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE                                   PROCEDURE [dbo].[QStatus_GetFiveDayComments]
	@ReportID int,
	@TaskID  int,
	@UserID int = null,
	@selectedComments varchar(1000) = null
AS

	
	DECLARE @CompareDt datetime

	set @CompareDt = dateadd(hour, 4, convert(datetime, convert(varchar, getdate(), 101)))

	if @CompareDt > getdate() 
		set @CompareDt = dateadd(day, -1, @CompareDt)

	select @CompareDt = dateadd(day, -4, @CompareDt)

	--if only specific comments were requested, parse them out into a table
	DECLARE @selectedCommentsTbl TABLE (commentID int)

	IF @selectedComments IS NOT NULL
		INSERT INTO @selectedCommentsTbl
		SELECT n from dbo.Util_fn_List_To_Table(@selectedComments,',')

	DECLARE @results TABLE
	(
		ID	int,
		ForeignKeyID	int,
		Comments	varchar(1500),
		DisplayOrder	int,
		TabIn	int,
		CommentDt	datetime,
		Initials	varchar(100),
		UserID	int,
		ReplyID	int,
		SpecialTask	bit,
		TaskID	int,
		ColorNum int,
		FullName varchar(100)
	)

	INSERT INTO @results
	SELECT 
		Distinct C.*, 
		task.taskID as TaskID,
	 	CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTS C
	INNER JOIN 
	(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		c.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	WHERE
	 (
		c.ID in (SELECT ID FROM QStatus_comments where LEN(Comments)>0 AND CommentDt > @CompareDt)
			OR 
		c.ID in (SELECT ReplyID FROM QStatus_comments where LEN(Comments)>0 AND CommentDt > @CompareDt)
	)
	ORDER BY C.DisplayOrder

	IF @selectedComments IS NOT NULL
		DELETE FROM @results
		WHERE ID NOT IN (SELECT CommentID FROM @selectedCommentsTbl)

	SELECT * FROM @results


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetInterestedPartyList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO











CREATE                                   PROCEDURE [dbo].[QStatus_GetInterestedPartyList]
	@ReportID  int
AS

	SELECT Distinct  g.Name as FullName From
		QCheck_Users u
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.UserID = u.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	INNER JOIN 
		QStatus_SUPERVISORS S
	ON 
		S.SUPERVISORGroupID = g.ID
	AND
		S.REPORTID = @ReportID
	AND
		S.DirectSupervisor = 1
	AND
		S.InterestedParty = 1












GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetLastViewed]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                                               PROCEDURE [dbo].[QStatus_GetLastViewed]
	@UserID int,
	@ReportID int,
	@LastViewed datetime output
AS
BEGIN
	SET NOCOUNT ON
	
	
	SELECT @LastViewed = LastViewed
		FROM 
			QStatus_SupervisorsLastViewed
		WHERE
			ReportID = @ReportID 
		AND
			SupervisorUserID = @UserID

	
	IF @LastViewed Is Null
	BEGIN

		DECLARE @GroupID int

		SELECT @GroupID = SupervisorGroupID
		FROM QStatus_Supervisors s
		INNER JOIN QCheck_Groups g
		ON s.SupervisorGroupID = g.ID
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = g.ID
		AND gm.UserID = @UserID

		IF @GroupID is null
		BEGIN
			SELECT @GroupID = ID
			FROM QCheck_Groups
			WHERE Owner = @UserID
			AND SingleMemberGroup = 1
			
			EXEC QStatus_AddSupervisors @ReportID, @GroupID, 0
		END
		SET @LastViewed = getdate() - 60--getdate()
	END

	--select @LastViewed = getdate()
END




























GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetLatestCommentsSubjectLine]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                                               PROCEDURE [dbo].[QStatus_GetLatestCommentsSubjectLine]
	@UserID int,
	@ReportID int,
	@Subject varchar(500) output
AS
	DECLARE @FullName varchar(50)

	SET @Subject = ''


	SELECT @FullName = u.FullName--LEFT(u.FullName, CHARINDEX(' ', u.FullName)-1)
	FROM
		QCheck_Users u
	WHERE
		u.ID = @UserID

	DECLARE @ReportName varchar(100)

	SELECT Top 1 @ReportName = dbo.QStatus_GetUserNames(r.ID) + r.name
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID

	SET @Subject = @Subject + @ReportName + ' Status Report - '

	DECLARE @ReplyCount int

	SELECT @ReplyCount = count (distinct USERID)
	FROM
		QStatus_Comments c
	WHERE
		c.ID IN (
				SELECT ReplyID 
				FROM 
					QStatus_comments c 
				inner join 
					(
						SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
						FROM
							QStatus_ActiveChecklistTaskType actt
						inner join 
							qstatus_tasktypes tt 
						on 
							actt.tasktype = tt.ID 
						and 
							tt.ReportID = @ReportID 
						
						
						UNION
					
						SELECT 
							ST.[ID], 1 As SpecialTask
						FROM
							QStatus_SpecialTasks st
						inner join 
							qstatus_tasktypes tt 
						on 
							st.tasktype = tt.ID 
						and 
							tt.ReportID = @ReportID 
			
					) task
				ON
					task.[ID] = c.ForeignKeyID
				AND
					task.SpecialTask = c.SpecialTask	
				
				where 
					USERID = @UserID 
				AND 
					LEN(Comments)>0 
				AND 
					CommentDt > dateadd(hour, -1, getDate())
			)
	AND
		USERID <> @UserID
	AND LEN(c.Comments)>0

	IF @ReplyCount = 0 BEGIN
		SET @Subject = @Subject + @FullName + '''s Comments'
	END
	ELSE BEGIN
		SET @Subject = @Subject + @FullName + '''s Reply To '
		SELECT @Subject = @Subject + innertbl.FullName + ', '--LEFT(innertbl.FullName, CHARINDEX(' ', innertbl.FullName)-1)+', '
		FROM 
		(
			SELECT DISTINCT u.FullName from
				QStatus_Comments c
			INNER JOIN
				QCheck_Users u
			ON
				c.UserID = u.ID
			WHERE
				c.ID IN (
					SELECT ReplyID FROM 
						QStatus_comments c 
					inner join 
						(
							SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
							FROM
								QStatus_ActiveChecklistTaskType actt
							inner join 
								qstatus_tasktypes tt 
							on 
								actt.tasktype = tt.ID 
							and 
								tt.ReportID = @ReportID 
							
							
							UNION
						
							SELECT 
								ST.[ID], 1 As SpecialTask
							FROM
								QStatus_SpecialTasks st
							inner join 
								qstatus_tasktypes tt 
							on 
								st.tasktype = tt.ID 
							and 
								tt.ReportID = @ReportID 
				
						) task
					ON
						task.[ID] = c.ForeignKeyID
					AND
						task.SpecialTask = c.SpecialTask	
					where 
						USERID = @UserID 
					AND 
						LEN(Comments)>0 
					AND 
						CommentDt > dateadd(hour, -1, getDate())
				)
			AND
				c.USERID <> @UserID
			AND LEN(c.Comments)>0
		) innertbl
		SET @Subject = LEFT(@Subject, len(@Subject) - 1)
		
	END






GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetLegalSearchReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[QStatus_GetLegalSearchReport]
	@UserIDs varchar(8000),
	@SearchCriteria varchar(100),
	@StartDate datetime,
	@EndDate datetime,
	@ReportID int = null,
	@excludeACP bit = 1
AS
BEGIN

	--exec sp_recompile 'QStatus_GetReport'
 
	SET NOCOUNT ON
	
	DECLARE @ReportUserID int
	DECLARE @LastReadDate datetime
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int
	DECLARE @Seed int
	INSERT INTO QStatus_Seed
	SELECT 1
	SELECT @Seed = scope_identity()
	DELETE FROM QStatus_Seed

	SELECT @CompletedType = 'Completed'

	--find all the tasks
	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT,
		ReportID int,
		Report varchar(100),
		Checklist varchar(200)
	)

	DECLARE @UserID table
	(
		UserID int
	)

	SELECT @SearchCriteria = '''' + @SearchCriteria + ''''

	INSERT INTO @UserID
	SELECT n FROM dbo.Util_fn_List_To_Table(@UserIDs,',')

IF @excludeACP = 0 
	INSERT INTO @ForeignKeyIDs 
		SELECT 
			distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM 
			QStatus_ActiveChecklistTaskType actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_comments c on c.foreignkeyid = actt.activechecklistid INNER JOIN
			qcheck_activechecklists ac on ac.id = actt.activechecklistid INNER JOIN
			qcheck_checklistinstances ci ON ci.id = ac.instanceID INNER JOIN
			qcheck_checklists ck on ci.checklistid = ck.id INNER JOIN
			qstatus_report r on tt.reportid = r.id inner join
			qstatus_groupreport gr ON gr.reportid = r.id inner join 
			qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
			qcheck_users u on u.id = gm.userid INNER JOIN
			@UserID u2 ON u.ID = u2.UserID 
		WHERE 
			c.commentdt >= @startdate AND 
			c.commentdt <= @enddate AND
			c.specialtask = 0 AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))
		
		UNION ALL
		
		SELECT 
			distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM 
			QStatus_ActiveChecklistTaskTypearchive actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_commentarchive c on c.foreignkeyid = actt.activechecklistid INNER JOIN
			qcheck_activechecklistarchive ac on ac.id = actt.activechecklistid INNER JOIN
			qcheck_checklistinstancearchive ci ON ci.id = ac.instanceID INNER JOIN
			qcheck_checklistarchive ck on ci.checklistid = ck.id INNER JOIN
			qstatus_report r on tt.reportid = r.id inner join
			qstatus_groupreport gr ON gr.reportid = r.id inner join 
			qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
			qcheck_users u on u.id = gm.userid INNER JOIN
			@UserID u2 ON u.ID = u2.UserID 
		WHERE 
			c.commentdt >= @startdate AND 
			c.commentdt <= @enddate AND
			c.specialtask = 0 AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))

		UNION ALL

		SELECT 
			distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM 
			QStatus_ActiveChecklistTaskType actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_comments c on c.foreignkeyid = actt.activechecklistid INNER JOIN
			qcheck_activechecklists ac on ac.id = actt.activechecklistid INNER JOIN
			qcheck_checklistinstances ci ON ci.id = ac.instanceID INNER JOIN
			qcheck_checklists ck on ci.checklistid = ck.id INNER JOIN
			qstatus_report r on tt.reportid = r.id inner join
			qstatus_groupreport gr ON gr.reportid = r.id inner join 
			qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
			qcheck_users u on u.id = gm.userid INNER JOIN
			@UserID u2 ON u.ID = u2.UserID INNER JOIN
			(SELECT ChecklistID FROM QStatus_TaskNameChanges tnc INNER JOIN QCheck_Checklists c ON tnc.ChecklistID = c.ID WHERE UpdateDt < @enddate AND UpdateDt >= @startdate AND 
			(CONTAINS (tnc.TaskOld, @searchcriteria))) tnc ON tnc.ChecklistID = ck.ID
		WHERE 
			c.commentdt >= @startdate AND 
			c.commentdt <= @enddate AND
			c.specialtask = 0 AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))
		
		UNION ALL
		
		SELECT 
			distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM 
			QStatus_ActiveChecklistTaskTypearchive actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_commentarchive c on c.foreignkeyid = actt.activechecklistid INNER JOIN
			qcheck_activechecklistarchive ac on ac.id = actt.activechecklistid INNER JOIN
			qcheck_checklistinstancearchive ci ON ci.id = ac.instanceID INNER JOIN
			qcheck_checklistarchive ck on ci.checklistid = ck.id INNER JOIN
			qstatus_report r on tt.reportid = r.id inner join
			qstatus_groupreport gr ON gr.reportid = r.id inner join 
			qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
			qcheck_users u on u.id = gm.userid INNER JOIN
			@UserID u2 ON u.ID = u2.UserID INNER JOIN
			(SELECT ChecklistID FROM QStatus_TaskNameChanges tnc INNER JOIN QCheck_Checklists c ON tnc.ChecklistID = c.ID WHERE UpdateDt < @enddate AND UpdateDt >= @startdate AND 
			(CONTAINS (tnc.TaskOld, @searchcriteria))) tnc ON tnc.ChecklistID = ck.ID
		WHERE 
			c.commentdt >= @startdate AND 
			c.commentdt <= @enddate AND
			c.specialtask = 0 AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))

ELSE

	INSERT INTO @ForeignKeyIDs 
		SELECT 
			distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM 
			QStatus_ActiveChecklistTaskType actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_comments c on c.foreignkeyid = actt.activechecklistid INNER JOIN
			qcheck_activechecklists ac on ac.id = actt.activechecklistid INNER JOIN
			qcheck_checklistinstances ci ON ci.id = ac.instanceID INNER JOIN
			qcheck_checklists ck on ci.checklistid = ck.id INNER JOIN
			qstatus_report r on tt.reportid = r.id inner join
			qstatus_groupreport gr ON gr.reportid = r.id inner join 
			qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
			qcheck_users u on u.id = gm.userid INNER JOIN
			@UserID u2 ON u.ID = u2.UserID 
--		INNER JOIN (SELECT Distinct ReportID 
--			 FROM Grading_Daily_UserReport 
--			 WHERE UserID IN (8,99,151) AND 
--			 dt <= @enddate) gdur ON r.id = gdur.reportid 
		WHERE 
			c.commentdt <= @enddate AND 
			c.commentdt >= @startdate AND
			c.specialtask = 0 AND 
			gr.groupID NOT IN (SELECT GroupID FROM Qcheck_GroupMembership WHERE UserID IN (8,99,151))
			AND r.ID NOT IN (SELECT Distinct ReportID 
			 FROM Grading_Daily_UserReport 
			 WHERE UserID IN (8,99,151) AND 
			 dt <= @enddate) AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))

		UNION ALL

		SELECT distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM QStatus_ActiveChecklistTaskTypearchive actt
		inner join qstatus_tasktypes tt
		on tt.id = actt.tasktype
		inner join qstatus_commentarchive c
		on c.foreignkeyid = actt.activechecklistid INNER JOIN
		qcheck_activechecklistarchive ac on ac.id = actt.activechecklistid INNER JOIN
		qcheck_checklistinstancearchive ci ON ci.id = ac.instanceID INNER JOIN
		qcheck_checklistarchive ck on ci.checklistid = ck.id INNER JOIN
		qstatus_report r on tt.reportid = r.id inner join
		qstatus_groupreport gr ON gr.reportid = r.id inner join 
		qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
		qcheck_users u on u.id = gm.userid INNER JOIN
		@UserID u2 ON u.ID = u2.UserID 
--		INNER JOIN (SELECT Distinct ReportID 
--			 FROM Grading_Daily_UserReport 
--			 WHERE UserID IN (8,99,151) AND 
--			 dt <= @enddate) gdur ON r.id = gdur.reportid 
		WHERE 
			c.commentdt <= @enddate AND 
			c.commentdt >= @startdate AND
			c.specialtask = 0 AND 
			gr.groupID NOT IN (SELECT GroupID FROM Qcheck_GroupMembership WHERE UserID IN (8,99,151))
			AND r.ID NOT IN (SELECT Distinct ReportID 
			 FROM Grading_Daily_UserReport 
			 WHERE UserID IN (8,99,151) AND 
			 dt <= @enddate) AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))

		UNION ALL

		SELECT 
			distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM 
			QStatus_ActiveChecklistTaskType actt inner join 
			qstatus_tasktypes tt on tt.id = actt.tasktype inner join 
			qstatus_comments c on c.foreignkeyid = actt.activechecklistid INNER JOIN
			qcheck_activechecklists ac on ac.id = actt.activechecklistid INNER JOIN
			qcheck_checklistinstances ci ON ci.id = ac.instanceID INNER JOIN
			qcheck_checklists ck on ci.checklistid = ck.id INNER JOIN
			qstatus_report r on tt.reportid = r.id inner join
			qstatus_groupreport gr ON gr.reportid = r.id inner join 
			qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
			qcheck_users u on u.id = gm.userid INNER JOIN
			@UserID u2 ON u.ID = u2.UserID INNER JOIN
			(SELECT ChecklistID FROM QStatus_TaskNameChanges tnc INNER JOIN QCheck_Checklists c ON tnc.ChecklistID = c.ID WHERE UpdateDt < @enddate AND UpdateDt >= @startdate AND 
			(CONTAINS (tnc.TaskOld, @searchcriteria))) tnc ON tnc.ChecklistID = ck.ID
--		INNER JOIN (SELECT Distinct ReportID 
--			 FROM Grading_Daily_UserReport 
--			 WHERE UserID IN (8,99,151) AND 
--			 dt <= @enddate) gdur ON r.id = gdur.reportid 
		WHERE 
			c.commentdt <= @enddate AND 
			c.commentdt >= @startdate AND
			c.specialtask = 0 AND 
			gr.groupID NOT IN (SELECT GroupID FROM Qcheck_GroupMembership WHERE UserID IN (8,99,151))
			AND r.ID NOT IN (SELECT Distinct ReportID 
			 FROM Grading_Daily_UserReport 
			 WHERE UserID IN (8,99,151) AND 
			 dt <= @enddate) AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))

		UNION ALL

		SELECT distinct actt.activechecklistid, r.id, r.name, ck.name
		FROM QStatus_ActiveChecklistTaskTypearchive actt
		inner join qstatus_tasktypes tt
		on tt.id = actt.tasktype
		inner join qstatus_commentarchive c
		on c.foreignkeyid = actt.activechecklistid INNER JOIN
		qcheck_activechecklistarchive ac on ac.id = actt.activechecklistid INNER JOIN
		qcheck_checklistinstancearchive ci ON ci.id = ac.instanceID INNER JOIN
		qcheck_checklistarchive ck on ci.checklistid = ck.id INNER JOIN
		qstatus_report r on tt.reportid = r.id inner join
		qstatus_groupreport gr ON gr.reportid = r.id inner join 
		qcheck_groupmembership gm on gr.groupid = gm.groupid INNER JOIN
		qcheck_users u on u.id = gm.userid INNER JOIN
		@UserID u2 ON u.ID = u2.UserID INNER JOIN
			(SELECT ChecklistID FROM QStatus_TaskNameChanges tnc INNER JOIN QCheck_Checklists c ON tnc.ChecklistID = c.ID WHERE UpdateDt < @enddate AND UpdateDt >= @startdate AND 
			(CONTAINS (tnc.TaskOld, @searchcriteria))) tnc ON tnc.ChecklistID = ck.ID
--		INNER JOIN (SELECT Distinct ReportID 
--			 FROM Grading_Daily_UserReport 
--			 WHERE UserID IN (8,99,151) AND 
--			 dt <= @enddate) gdur ON r.id = gdur.reportid 
		WHERE 
			c.commentdt <= @enddate AND 
			c.commentdt >= @startdate AND
			c.specialtask = 0 AND 
			gr.groupID NOT IN (SELECT GroupID FROM Qcheck_GroupMembership WHERE UserID IN (8,99,151))
			AND r.ID NOT IN (SELECT Distinct ReportID 
			 FROM Grading_Daily_UserReport 
			 WHERE UserID IN (8,99,151) AND 
			 dt <= @enddate) AND 
			(CONTAINS (ck.name, @searchcriteria) OR CONTAINS(tt.description, @searchcriteria))

IF @ReportID IS NULL
BEGIN
		SELECT 
			DISTINCT ReportID, Report
		FROM 
			@ForeignKeyIDs 
		ORDER BY 
			Report
END
ELSE
BEGIN

	DELETE FROM @ForeignKeyIDs WHERE ReportID <> @ReportID

	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		InstanceID int,
		assignees varchar(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit,
		isDeleted bit
	)
	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int
	)
	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived,
			IsDeleted
		)
	SELECT distinct
		ac.ID, 
		ac.DueTime,
		ac.InstanceID,
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0  as NewTask,
		CompletedDate, 
		0,
		c.IsDeleted
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ActiveAssignments aa
	ON
		aa.ActiveChecklistID = ac.ID
	INNER JOIN 
		qcheck_checklistinstances ci
	ON
		ci.ID = ac.InstanceID
	INNER JOIN
		qcheck_checklists c
	ON
		ci.ChecklistID = c.ID
	INNER JOIN
		QCheck_Assignments a
	ON
		a.ID = aa.AssignmentsID
	AND
		a.IsDeleted = 0
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	WHERE
		tt.ReportID = @ReportID
	AND (ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	
	SELECT distinct 
		ac.ID, 
		ac.DueTime,
		ac.InstanceID, 
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0  as NewTask,
		CompletedDate, 
		1
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklistArchive ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ActiveAssignmentArchive aa
	ON
		aa.ActiveChecklistID = ac.ID
	
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	WHERE
		
		tt.ReportID = @ReportID
	AND (
	 ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	
	SELECT distinct 
		ac.ID, 
		ac.DueTime,
		ac.InstanceID, null,
		--isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0  as NewTask,
		CompletedDate, 
		1
	FROM
		QStatus_ActiveChecklistTaskTypeArchive actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklistArchive ac
	ON
		ac.ID = actt.ActiveChecklistID
--	INNER JOIN
--		QCheck_ActiveAssignmentArchive aa
--	ON
--		aa.ActiveChecklistID = ac.ID
----	
--	left outer join qcheck_assigneelookup al
--		on al.instanceid = ac.instanceid
	WHERE
		
		tt.ReportID = @ReportID
	AND (
	 ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	

	update @tasks
		set DueDateChanged = 1
		from @tasks t
		inner join QStatus_DueDateChanges ddc
		on 
			ddc.ActiveChecklistID =t.ID
	
	update @tasks
		set PriorityChanged = 1
		from @tasks t
		inner join QStatus_PriorityChanges pc
		on 
			pc.ActiveChecklistID =t.ID

	insert into @instances
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstances ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			ci.IsDeleted = 0 
		UNION ALL
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstanceArchive ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			(ci.IsDeleted = 0 )
	
	insert into @checklists
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_Checklists c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		WHERE
			c.IsDeleted = 0 
		UNION ALL
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
--		WHERE
--			(c.IsDeleted = 0 )

	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)

	update @tasks
		set description = c.description,
		tasknamechanged = c.tasknamechanged
	from @tasks t
	inner join @instances i
	on i.id = t.instanceid
	inner join @checklists c
	on c.id = i.checklistid
	
	INSERT INTO QStatus_TempTasks (ID, keyID, specialTask)
	SELECT @Seed, id, 0
	FROM @Tasks/*
	INSERT INTO QStatus_TempTasks (ID, keyID, specialTask)
	SELECT @Seed, -1 * st.id, 1
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes  tt
	ON
		st.TaskType = tt.ID
--	AND
--		tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0*/

	--START HEADER
	SELECT
		null as ID, 
		dbo.QStatus_GetUserNames(r.ID) + r.Name + ' - Status Report - '
		+ CASE WHEN r.LastReportDate = 0 THEN
			'No Status'
		ELSE
			ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
			+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
			+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
		END 
		as Description,
		@LastReadDate as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		'0' as TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER
	
	UNION ALL
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder, 
		'0' As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	UNION ALL
	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN t.CompletedDate IS Not Null then Null ELSE t.TaskType END AS ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType +' - '+ taskdescription ELSE taskdescription END AS Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
		
	FROM
		@tasks t
	
	
	UNION ALL
	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN  t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  + 1 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t
	UNION ALL
	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskdescription end as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN  t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 999 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t
	--END SECTION ENDERS
	UNION ALL
	
	--START SECTION
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskDescription end As Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else
			CASE WHEN t.archived = 1 THEN
				3
			ELSE
				t.NativeType
			END
		END as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo
	FROM
		@tasks t
UNION ALL
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		'Comments' As Type,
		999 as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo
	FROM
		@tasks t

	UNION ALL
 
	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 As ReturnOrder,
		CAST(tt.ID As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	--END SECTION HEADS SPECIAL 
	UNION ALL
	-- SECTION ENDERS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 999 As ReturnOrder,
		CAST(tt.ID AS varchar) AS TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	--END SECTION ENDERS SPECIAL 
	
	UNION ALL
	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID,  -- negative for special sections
		tt.Description,
		0 as DueDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		tt.Description as Type,
		tt.NativeType ,
		0 as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		CAST(tt.ID AS varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	--END SECTION SPECIAL 
	
	ORDER BY ReturnOrder, DueDate asc, description, NativeType asc

	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID

	SELECT @Seed

END

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetMySections]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO













CREATE                                PROCEDURE [dbo].[QStatus_GetMySections]
	@UserID int
AS

BEGIN

	SET NOCOUNT ON
	
	SELECT 
		DISTINCT tt.ID, r.Name + ' - ' + tt.description, r.ID, tt.displayOrder, gr.defaultreport
	FROM 
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	INNER JOIN 
		QStatus_TaskTypes tt
	ON
		tt.ReportID = r.ID
	AND 
		tt.IsDeleted = 0
	AND
		tt.NativeType = 0
	WHERE 
		r.IsDeleted = 0
	ORDER BY gr.defaultreport desc, r.ID, tt.displayOrder

SET NOCOUNT OFF

End





















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetPreference]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


















CREATE                    PROCEDURE [dbo].[QStatus_GetPreference]
	@UserID int,
	@ReportID int = 0,
	@PreferenceType varchar(50),
	@PreferenceValue varchar(50) output
AS
BEGIN
	SET NOCOUNT ON

	SET @PreferenceValue = ''

	IF @PreferenceType = 'LastReport'
		SELECT @PreferenceValue = p.PreferenceValue
		FROM
			QStatus_Preferences p
		INNER JOIN
			QStatus_Report r
		ON
			r.ID = p.PreferenceValue
		AND
			r.IsDeleted = 0
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN 
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN 
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		AND 
			p.UserID = @UserID
		AND 
			p.PreferenceType = @PreferenceType
		AND 
			p.ReportID = @ReportID

	ELSE
	SELECT @PreferenceValue = PreferenceValue
	FROM
		QStatus_Preferences
	WHERE UserID = @UserID
	AND PreferenceType = @PreferenceType
	AND ReportID = @ReportID
	

	SET NOCOUNT OFF
END




































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetPriorityListSchedules]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[QStatus_GetPriorityListSchedules] 
	@supervisorId int,
	@subOrdinateId int
AS
BEGIN
	select * from Schedule_PriorityList where --SupervisorID=@supervisorId and 
	EmployeeId=@subOrdinateId and IsActive=1
	order by DaysOfWeek
END


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReport_Test]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QStatus_GetReport_Test] (
	@UserID int,
	@ReportID int,
	@deletedDate datetime = null,
	@MoveCompleted bit = 0,
	@DueFilter datetime = null,
	@AssignedTo int = -1,
	@PriorityListSetID INT = -1

/*
set @UserID = 24
set @ReportID = 1100843
set @MoveCompleted = 0
set @AssignedTo = -1
set @PriorityListSetID = 149
--set @PriorityListSetID = -1
*/
) AS

BEGIN
	
	--exec sp_recompile 'QStatus_GetReport'
 
	SET NOCOUNT ON
	
	DECLARE @ReportUserID int
	DECLARE @LastReadDate datetime
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int
	DECLARE @Seed int
	DECLARE @PriorityListSetName VARCHAR(50)
	
	INSERT INTO QStatus_Seed
		SELECT 1

	SELECT @Seed = scope_identity()

	DELETE FROM QStatus_Seed
	--find all the tasks

	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY
	)

	INSERT INTO @ForeignKeyIDs 
		SELECT distinct activechecklistid 
		FROM qstatus_commentedreporttasks
		WHERE reportID = @reportID 

	--add a day to whatever was passed in (takes care of default to midnight)
	IF @DueFilter is not null
		SET @DueFilter = DateAdd(day, 1, @DueFilter)
	
	SELECT @CompletedType = 'Completed'
	--find out if they are a user or supervisor/ip

	SET @ReportUserID = 0

	SELECT 
		@ReportUserID = UserID
	FROM
		QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
			ON g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gr.ReportID = @ReportID
			AND gm.UserID = @UserID

	--default to 60 days ago
	SELECT @LastReadDate =  getdate() - 60
	
	--find last time it was marked read by you if you are supervisor/ip
	SELECT 
		@LastReadDate = LastViewed
	FROM 
		QStatus_SupervisorsLastViewed
	WHERE
		ReportID = @ReportID 
		AND SupervisorUserID = @UserID
	
	--if it is your report, just use yesterday
	IF @ReportUserID = @UserID
		SELECT @LastReadDate = dateadd(day, -1, getdate())

	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		ReminderDate datetime,
		InstanceID int,
		assignees varchar(1000),
		controllers VARCHAR(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit,
		isDeleted bit,
		isRecurring bit,
		isPriority bit,
		isDaily bit
	)

	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int,
		isRecurring bit
	)

	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)

	-- 02/23/2011 dalvarado - priorities section
	declare @priorities table (
		ID int PRIMARY KEY IDENTITY(1,1),
		InstanceID INT,
		Priority INT
	)

	INSERT INTO @priorities (
		InstanceID,
		Priority
	)
		SELECT 
			ac.InstanceID,
			pl.Priority
		FROM
			PriorityListUsers plu
			INNER JOIN PriorityList pl
				ON plu.UserID = pl.UserID
			INNER JOIN QCheck_ActiveChecklists ac
				ON pl.ActiveChecklistID = ac.[ID]
		WHERE 
			PLU.[SetID] = @PriorityListSetID

	SELECT @PriorityListSetName = [Name]
	FROM PriorityListSet
	WHERE [ID] = @PriorityListSetID


	--insert into @tasks (
	--	ID ,
	--	DueTime,
	--	ReminderDate,
	--	InstanceID ,
	--	assignees ,
	--	controllers,
	--	tasktype ,
	--	taskdescription ,
	--	nativetype ,
	--	tasktypeorder ,
	--	priority ,
	--	prioritychanged ,
	--	duedatechanged ,
	--	newtask ,
	--	CompletedDate ,
	--	Archived,
	--	IsDeleted,
	--	IsPriority,
	--	IsDaily
	--)
		SELECT distinct
			ac.ID, 
			ac.DueTime,
			CASE WHEN CONVERT(VARCHAR(10), ac.ReminderDate, 101) <> CONVERT(VARCHAR(10), ac.DueTime, 101) THEN ac.ReminderDate ELSE NULL END,
			ac.InstanceID,
			isnull(al.assignees, ''),
			isnull(dbo.QCheck_ManagersList(c.[id]), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
			CompletedDate, 
			0,
			c.IsDeleted,
			null,--CASE WHEN p.InstanceID IS NULL THEN 0 ELSE 1 END AS IsPriority,
			CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				--AND
				--	tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists ac
				ON ac.ID = actt.ActiveChecklistID
			INNER JOIN qcheck_checklistinstances ci
				ON ci.ID = ac.InstanceID
			INNER JOIN qcheck_checklists c
				ON ci.ChecklistID = c.ID
			INNER JOIN QCheck_Assignments a
				ON a.instanceID = ci.ID
				AND (
					a.GroupID = @AssignedTo 
					or @AssignedTo = -1
				)
				AND a.IsDeleted = 0
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
			left outer join QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
			left outer join @Priorities p
				ON ac.InstanceID = p.InstanceID
			
		WHERE
			tt.ReportID = @ReportID
			AND (
				@DueFilter is null 
				OR ac.DueTime < @DueFilter
				OR isnull(ac.ReminderDate, ac.DueTime) < @DueFilter
				OR ac.ID in (
					SELECT ForeignKeyID 
					FROM @ForeignKeyIDs
				)
			)


	/*insert into @tasks (
		ID ,
		DueTime,
		ReminderDate,
		InstanceID ,
		assignees ,
		controllers,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived ,
		IsPriority,
		IsDaily
	)
		SELECT distinct 
			ac.ID, 
			ac.DueTime,
			CASE WHEN CONVERT(VARCHAR(10), ac.ReminderDate, 101) <> CONVERT(VARCHAR(10), ac.DueTime, 101) THEN ac.ReminderDate ELSE NULL END,
			ac.InstanceID, 
			isnull(al.assignees, ''),
			isnull(dbo.QCheck_ManagersList(ISNULL(cia.ChecklistID, ci.ChecklistID)), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
			CompletedDate, 
			1,
			0,
			0
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				--AND tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklistArchive ac
				ON ac.ID = actt.ActiveChecklistID
				AND ac.archivedate > @deleteddate 
				AND @deleteddate is not null
			INNER JOIN QCheck_ActiveAssignmentArchive aa
				ON aa.ActiveChecklistID = ac.ID
			LEFT OUTER JOIN QCheck_ChecklistInstanceArchive cia
				ON ac.InstanceID = cia.[ID]
			-- 2/26/2013 dalvarado - found cases where the instance wasn't archived with the active checklist, so need to look
			-- in both checklistinstances and checklistinstancearchive.
			left outer join qcheck_checklistinstances ci
				ON ac.InstanceID = ci.ID
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
		WHERE
			tt.ReportID = @ReportID
			AND (
				@DueFilter is null 
				OR ac.DueTime < @DueFilter 
				OR isnull(ac.ReminderDate, ac.DueTime) < @DueFilter 
				OR ac.ID in (
					SELECT ForeignKeyID 
					FROM @ForeignKeyIDs
				)
			)
			AND (
				@AssignedTo = -1
				OR aa.AssignmentsID in (
					SELECT ID 
					FROM QCheck_Assignments
					WHERE 
						GroupID = @AssignedTo 
						and isdeleted = 0
				)
				OR aa.AssignmentsID in (
					SELECT ID 
					FROM QCheck_AssignmentArchive
					WHERE 
						GroupID = @AssignedTo 
						and isdeleted = 0
				)
			)

	update 
		@tasks
	set 
		DueDateChanged = 1
	from 
		@tasks t
		inner join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID =t.ID
			AND ddc.UpdateDt > @deletedDate
	
	update 
		@tasks
	set 
		PriorityChanged = 1
	from 
		@tasks t
		inner join QStatus_PriorityChanges pc
			on pc.ActiveChecklistID =t.ID
			AND pc.UpdateDt > @deletedDate

	-- 02/23/2011 dalvarado
	IF @PriorityListSetID <> -1 BEGIN

		UPDATE 
			@tasks
		SET 
			TaskType = -1000,
			TaskDescription = 'Top Priorities' + ISNULL(' - ' + @PriorityListSetName, ''),
			TaskTypeOrder = 10,
			Priority = p.Priority
		FROM 
			@tasks t
			inner join @priorities p
				on t.InstanceID = p.InstanceID

	END


	insert into @instances

		SELECT distinct
			ci.ID,
			ci.ChecklistID,
			CASE 
				WHEN s.freqType > 1 THEN 1 
				ELSE 0 
			END as isRecurring
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN @tasks t
				ON t.InstanceID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
		WHERE
			ci.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT distinct
			ci.ID,
			ci.ChecklistID,
			CASE 
				WHEN s.freqType > 1 THEN 1 
				ELSE 0 
			END as isRecurring
		FROM 
			QCheck_ChecklistInstanceArchive ci
			INNER JOIN @tasks t
				ON t.InstanceID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
		WHERE
			(
				ci.IsDeleted = 0 
				OR @deleteddate is not null
			)
			AND ci.archivedate > @deleteddate 
			AND @deleteddate is not null
	

	insert into @checklists

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE 
				WHEN tnc.ChecklistID IS NULL THEN 0 
				ELSE 1 
			END as TaskNameChanged
		FROM 
			QCheck_Checklists c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE 
				WHEN tnc.ChecklistID IS NULL THEN 0 
				ELSE 1 
			END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			(
				c.IsDeleted = 0 
				OR @deleteddate is not null
			)
			AND c.archivedate > @deleteddate 
			AND @deleteddate is not null


	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)


	update @tasks
	set 
		description = c.description,
		tasknamechanged = c.tasknamechanged,
		isRecurring = i.isRecurring
	from 
		@tasks t
		inner join @instances i
			on i.id = t.instanceid
		inner join @checklists c
			on c.id = i.checklistid


	INSERT INTO QStatus_TempTasks (
		ID, 
		keyID, 
		specialTask
	)
		SELECT 
			@Seed, 
			id, 
			0
		FROM 
			@Tasks
	
	INSERT INTO QStatus_TempTasks (
		ID, 
		keyID, 
		specialTask
	)
		SELECT 
			@Seed, 
			-1 * st.id, 
			1
		FROM
			QStatus_SpecialTasks st
			INNER JOIN QStatus_TaskTypes  tt
				ON st.TaskType = tt.ID
			--	AND tt.IsDeleted = 0
				AND tt.ReportID = @ReportID
				AND st.IsDeleted = 0


	--START HEADER
	SELECT
		null as ID, 
		dbo.QStatus_GetUserNames(r.ID) + 
			r.Name + ' - Status Report - '
			+ CASE 
				WHEN r.LastReportDate = 0 THEN 
					'No Status'
				ELSE 
					ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
					+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
					+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
			END as Description,
		@LastReadDate as DueDate,
		@LastReadDate AS ReminderDate,
		@LastReadDate AS SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		'0' as TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER
	
	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder, 
		'0' As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as isDaily

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN t.CompletedDate IS Not Null then Null ELSE t.TaskType END AS ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType +' - '+ taskdescription ELSE taskdescription END AS Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL
	
	
	UNION ALL

	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN  t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  + 1 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskdescription end as Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN  t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 999 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	--END SECTION ENDERS

	UNION ALL
	
	--START SECTION
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		Convert(varchar, t.ReminderDate, 101) as ReminderDate,
		Convert(varchar, ISNULL(t.ReminderDate, t.DueTime), 101) as SortDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskDescription end As Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else
			CASE WHEN t.archived = 1 THEN
				3
			ELSE
				t.NativeType
			END
		END as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo,
		Controllers,
		t.isRecurring as isRecurring,
		t.IsDaily as isDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL

	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		Convert(varchar, t.ReminderDate, 101) as ReminderDate,
		Convert(varchar, ISNULL(t.ReminderDate, t.DueTime), 101) as SortDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		'Comments' As Type,
		999 as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo,
		Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL
 
	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 As ReturnOrder,
		CAST(tt.ID As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			--AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION HEADS SPECIAL 

	UNION ALL

	-- SECTION ENDERS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 999 As ReturnOrder,
		CAST(tt.ID AS varchar) AS TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring, 
		null as IsDaily
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			--AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION ENDERS SPECIAL 
	
	UNION ALL

	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID,  -- negative for special sections
		tt.Description,
		0 as DueDate,
		0 as ReminderDate,
		0 as SortDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		tt.Description as Type,
		tt.NativeType ,
		0 as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		CAST(tt.ID AS varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			--AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION SPECIAL 
	
	ORDER BY 
		ReturnOrder,
		SortDate asc,
		ReminderDate asc, 
		DueDate asc, 
		description, 
		NativeType asc


	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID

	SELECT @Seed*/

	SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportControllersSP]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_GetReportControllersSP] (
	@ReportID INT,
	@ReportControllers VARCHAR(1000) OUTPUT
) AS

BEGIN

	SELECT @ReportControllers = dbo.QStatus_GetReportControllers(@ReportID)

END


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportEmails]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[QStatus_GetReportEmails]
	@ReportID int,
	@TaskID int = null
AS
BEGIN
	SET NOCOUNT ON
	
		SELECT  u.ID, u.Email, u.Fullname
		FROM
			QCheck_Users u
		INNER JOIN 
			QCheck_GroupMembership gm
		ON
			gm.UserID = u.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gm.GroupID
		INNER JOIN
			QStatus_Supervisors s
		ON
			s.SupervisorGroupID = g.ID
		AND
			s.ReportID = @ReportID
		AND
			s.DirectSupervisor = 1

		UNION
		
		SELECT  u.ID, u.Email, u.Fullname
		FROM
			QCheck_Users u
		INNER JOIN 
			QCheck_GroupMembership gm
		ON
			gm.UserID = u.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gm.GroupID
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.GroupID = g.ID
		AND
			gr.ReportID = @ReportID

		UNION

		SELECT  u.ID, u.Email, u.Fullname
		FROM
			QCheck_Users u
		INNER JOIN 
			QCheck_GroupMembership gm
		ON
			gm.UserID = u.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gm.GroupID
		INNER JOIN
			QCheck_Assignments a
		ON
			a.GroupID = g.ID
		AND
			a.IsDeleted = 0
		INNER JOIN
			QCheck_ActiveAssignments aa
		ON
			aa.AssignmentsID = a.ID
		AND
			aa.ActiveChecklistID = @TaskID
		AND
			@TaskID is not null

		UNION

		SELECT  u.ID, u.Email, u.Fullname
		FROM
			QCheck_Users u
		INNER JOIN 
			QCheck_GroupMembership gm
		ON
			gm.UserID = u.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gm.GroupID
		INNER JOIN
			QCheck_ChecklistManagers cm
		ON
			cm.ManagerGroupID = g.ID
		AND
			cm.IsDeleted = 0
		INNER JOIN
			QCheck_ChecklistInstances ci
		ON
			ci.ChecklistID = cm.ChecklistID
		INNER JOIN
			QCheck_ActiveChecklists ac
		ON
			ac.InstanceID = ci.ID
		AND
			ac.ID = @TaskID
		AND
			@TaskID is not null

		order by u.fullname
		

	SET NOCOUNT OFF
END



GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportGroups]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





create                               PROCEDURE [dbo].[QStatus_GetReportGroups]
	@ReportID int
AS
BEGIN
	
	
	SET NOCOUNT ON
	


		SELECT 
			Distinct g.ID, g.Name as FullName
		FROM
			QCheck_Groups g
		INNER JOIN 
			QCheck_GroupMembership gm
		ON 	gm.GroupID = g.ID
		INNER JOIN 
			QCheck_Users u
		ON
			u.ID = gm.UserID
		AND 
			u.IsDeleted = 0
		INNER JOIN
			QCheck_Assignments a
		ON
			a.GroupID = g.ID
		INNER JOIN
			QCheck_ActiveAssignments aa
		ON
			aa.AssignmentsID = a.ID
		INNER JOIN
			QCheck_ActiveChecklists ac
		ON
			ac.ID = aa.ActiveChecklistID
		INNER JOIN
			QCheck_ChecklistInstances ci
		ON
			ci.ID = ac.InstanceID
		AND
			ci.IsDeleted = 0
		INNER JOIN
			QCheck_Checklists c
		ON
			c.ID = ci.ChecklistID
		INNER JOIN
			QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = ac.ID
		INNER JOIN
			qstatus_tasktypes tt
		ON
			tt.id = actt.tasktype
		and 
			tt.reportID = @reportID

		ORDER BY 1


	SET NOCOUNT OFF
END







GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportIDAndAccess]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                     PROCEDURE [dbo].[QStatus_GetReportIDAndAccess]
	@ReportName varchar(100),
	@Username varchar(100),
	@ReportID int output,
	@ReportAccess varchar(100) output
AS
BEGIN
	SET NOCOUNT ON
DECLARE @UserID int

SELECT @UserID = ID FROM QCheck_Users WHERE Shortname = @Username
	SELECT TOP 1 @ReportID =  r.ID
	FROM
		QStatus_Report r
	WHERE r.Name LIKE @ReportName + '%'

IF @ReportID IS NULL 
BEGIN
	SELECT @ReportAccess = 'NotFound'
	RETURN 0
END

SELECT @ReportAccess = 'None'

IF EXISTS 
	(SELECT 
		r.[ID]
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		WHERE 
			r.IsDeleted = 0
			AND r.ID = @ReportID)

	SELECT @ReportAccess = 'Controller'


ELSE IF EXISTS
(
		SELECT s.ReportID
			
		FROM
			QStatus_Report r
		INNER JOIN
			QStatus_Supervisors s
		ON
			r.ID = s.ReportID
		AND
			s.DirectSupervisor = 1
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = s.SupervisorGroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		
		
		WHERE
		 r.IsDeleted = 0
		AND r.ID = @ReportID
)
	SELECT @ReportAccess = 'IPSupervisor'
	
	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportLatestUrgent]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
















CREATE                           PROCEDURE [dbo].[QStatus_GetReportLatestUrgent]
	@UserID int,
	@ReportID int,
	@deletedDate datetime = null,
	@MoveCompleted bit = 0
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @LastReadDate datetime
	
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int

	SELECT @CompletedType = Description, @CompletedOrder = DisplayOrder
	FROM QStatus_TaskTypes
	WHERE
		NativeType = 2
	AND
		ReportID = @ReportID


	DECLARE @CommentID int

	SELECT top 1 @CommentID = c.ID
	FROM QStatus_comments c 
	inner join 
		(
			SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
			FROM
				QStatus_ActiveChecklistTaskType actt
			inner join 
				qstatus_tasktypes tt 
			on 
				actt.tasktype = tt.ID 
			and 
				tt.ReportID = @ReportID 
			
			
			UNION
		
			SELECT 
				ST.[ID], 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			inner join 
				qstatus_tasktypes tt 
			on 
				st.tasktype = tt.ID 
			and 
				tt.ReportID = @ReportID 

		) task
	ON
		task.[ID] = c.ForeignKeyID
	AND
		task.SpecialTask = c.SpecialTask	
	AND
		USERID = @UserID 
	AND 
		LEN(Comments)>0 
	ORDER BY CommentDt desc
	
	--START HEADER
	SELECT
		null as ID, 
			dbo.QStatus_GetUserNames(r.ID) + r.Name + ' Status Report - '
			+ CASE WHEN r.LastReportDate = 0 THEN
				'No Status'
			ELSE
				ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
				+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
				+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
			END 
		as Description,
		@LastReadDate as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER

	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN AC.CompletedDate IS Not Null then @CompletedType + ' - ' + tt.Description ELSE tt.Description END AS Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder  * 1000 * 2 + 1000 Else tt.DisplayOrder  * 1000 * 2 END As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ActiveChecklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ActiveChecklistArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ChecklistInstances  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistInstanceArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_Checklists  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistArchive
			where archivedate > @deleteddate and @deleteddate is not null 
		) c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN
		QStatus_TaskTypes	tt

	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		tt.ReportID = @ReportID
	AND ac.ID in (SELECT foreignKeyID FROM QStatus_comments where ID = @CommentID and specialtask=0)
	--END SECTION HEADS

	UNION ALL

	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	AND     
		st.ID in (SELECT foreignKeyID FROM QStatus_comments where ID = @CommentID and specialtask=1)
	
	--END SECTION HEADS SPECIAL 

	UNION ALL
	
	-- COLUMN HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Special Headings Row' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 1 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	AND     
		st.ID in (SELECT foreignKeyID FROM QStatus_comments where ID = @CommentID and specialtask=1)
	
	--END COLUMN HEADS SPECIAL 

	UNION ALL


	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder  * 1000 * 2 + 1000 Else tt.DisplayOrder  * 1000 * 2 END + 1 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ActiveChecklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ActiveChecklistArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ChecklistInstances  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistInstanceArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_Checklists  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistArchive
			where archivedate > @deleteddate and @deleteddate is not null 
		) c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN
		QStatus_TaskTypes	tt

	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		tt.ReportID = @ReportID
	AND
		tt.NativeType <> 1 --Questions section has no headings
	AND
		tt.NativeType <> 5 --General section has no headings
	AND ac.ID in (SELECT foreignKeyID FROM QStatus_comments where ID= @CommentID and specialtask = 0)
	--END SECTION HEADINGS

	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN AC.CompletedDate IS Not Null then @CompletedType else tt.Description end as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder  * 1000 * 2 + 1000 Else tt.DisplayOrder  * 1000 * 2 END + 999 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ActiveChecklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ActiveChecklistArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ChecklistInstances  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistInstanceArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_Checklists  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistArchive
			where archivedate > @deleteddate and @deleteddate is not null 
		) c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN
		QStatus_TaskTypes	tt

	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		tt.ReportID = @ReportID
	AND ac.ID in (SELECT foreignKeyID FROM QStatus_comments where ID = @CommentID and specialTask = 0)
	--END SECTION ENDERS

	UNION ALL
	
	-- SECTION ENDERS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 999 As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	AND     
		st.ID in (SELECT foreignKeyID FROM QStatus_comments where ID=@CommentID and specialtask=1)
	
	--END SECTION ENDERS SPECIAL 
	
	UNION ALL
	--START SECTION
	SELECT 
		DISTINCT
		ac.ID, 
		c.Name +
		CASE WHEN ac.CompletedDate IS NULL THEN
			CASE WHEN ac.archivedate IS NOT NULL THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			
				''
		END as Description,
		Convert(varchar, ac.DueTime, 101) as DueDate,
		actt.Priority,
		CAST(ac.ID as varchar) As Comments,
		--Convert(varchar, UpdatedDate, 101) 
		0 as UpdatedDate,
		CASE WHEN AC.CompletedDate IS Not Null then @CompletedType else tt.Description end As Type,
		CASE WHEN AC.CompletedDate IS Not Null then 2 else tt.NativeType end as NativeType,
		0 as IsDeleted,
		CASE WHEN AC.CompletedDate IS Not Null then tt.DisplayOrder  * 1000 * 2 + 1000 Else tt.DisplayOrder  * 1000 * 2 END + 100 + actt.Priority As ReturnOrder,
		CASE WHEN pc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END as PriorityChanged,
		CASE WHEN ddc.ActiveChecklistID IS NULL THEN 0 ELSE 1 END as DueDateChanged,
		CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		dbo.QCheck_FullAssigneesList(ci.id) as AssignedTo
		--actt.ShowSupervisor
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ActiveChecklists 
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ActiveChecklistArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_ChecklistInstances  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistInstanceArchive 
			where archivedate > @deleteddate and @deleteddate is not null
		) ci
	ON
		ci.ID = ac.InstanceID
	AND
		(ci.IsDeleted = 0 or @deleteddate is not null)
	INNER JOIN

		(
			SELECT *, null as archivedate, 0 as deleted FROM 
				QCheck_Checklists  
			UNION
			SELECT *, 1 as deleted FROM 
				QCheck_ChecklistArchive
			where archivedate > @deleteddate and @deleteddate is not null 
		) c
	ON	
		c.ID = ci.ChecklistID
	AND 
		(c.IsDeleted = 0 or @deleteddate is not null)
	LEFT OUTER JOIN
		QStatus_PriorityChanges pc
	ON
		pc.ActiveChecklistID = ac.ID
	AND 
		pc.UpdateDt > @deletedDate
	LEFT OUTER JOIN
		QStatus_DueDateChanges ddc
	ON
		ddc.ActiveChecklistID = ac.ID
	AND 
		ddc.UpdateDt > @deletedDate
	LEFT OUTER JOIN
		QStatus_TaskNameChanges tnc
	ON
		tnc.ChecklistID = c.ID
	AND 
		tnc.UpdateDt > @deletedDate
	INNER JOIN
		QStatus_TaskTypes	tt

	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		tt.ReportID = @ReportID
	AND ac.ID in (SELECT ForeignKeyID FROM QStatus_comments where ID=@CommentID and specialTask = 0)
	--END SECTION

	
	UNION ALL

	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID,  -- negative for special sections
		tt.Description,
		0 as DueDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		tt.Description as Type,
		tt.NativeType ,
		0 as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo--,
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st

	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		st.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	AND
		st.IsDeleted = 0
	AND     
		st.ID in (SELECT foreignKeyID FROM QStatus_comments where ID=@CommentID and specialtask=1)
	
	--END SECTION SPECIAL 
	

	
	ORDER BY ReturnOrder, DueDate asc


	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID

	SET NOCOUNT OFF
END

































































































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                       PROCEDURE [dbo].[QStatus_GetReports]
	
AS
BEGIN

		SELECT 
			r.[ID],
		     	dbo.QStatus_GetUserNames(r.ID) + r.Name AS [Description]
		FROM 
			QStatus_Report r
		WHERE 
			r.IsDeleted = 0
		Order by 2
END
















GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReports_NoSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







Create                       PROCEDURE [dbo].[QStatus_GetReports_NoSupervisors]
	
AS
BEGIN

		SELECT 
			r.[ID],
		     dbo.QStatus_GetUserNames(r.ID) + r.Name AS [Description]
		FROM 
			QStatus_Report r
		WHERE 
			r.IsDeleted = 0
			and r.ID not in (select reportID from QStatus_Supervisors)
		Order by 2
		
END
















GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportsForActiveChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QStatus_GetReportsForActiveChecklist]
@TaskID int

AS

SELECT ReportID
FROM dbo.QStatus_TaskTypes
WHERE ID IN
	(SELECT TaskType
	 FROM QStatus_ActiveChecklistTaskType
	 WHERE ActiveChecklistID = @TaskID)
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportsInboxAll]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE                                                       PROCEDURE [dbo].[QStatus_GetReportsInboxAll]
	@UserID int

AS
BEGIN

			SELECT  distinct
				r.ID as reportid, 
				LastReportDate, 
				CASE WHEN IsNull(LastViewed,0) > 0 THEN LastViewed ELSE NULL END AS LastViewed,
				dbo.QStatus_GetUserNames(r.ID) + r.Name as fullname
				,CASE WHEN f.ReportID IS NULL THEN 'non' ELSE '' END as IsFav
			FROM
			
				QStatus_Report r
			INNER JOIN
				QStatus_GroupReport gr
			ON
				gr.ReportID = r.ID
			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = gr.GroupID
			INNER JOIN
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID
			INNER JOIN
				QCheck_Users u
			ON
				u.ID = gm.UserID
			LEFT OUTER JOIN
				QStatus_SupervisorsLastViewed lv
			ON
				lv.SupervisorUserID = @UserID
			AND
				lv.ReportID = r.ID
			LEFT OUTER JOIN 
				QStatus_Favorites f
			ON
				f.UserID = @UserID
			AND
				f.ReportID = r.ID
			WHERE
				 r.IsDeleted = 0
				and not 
					r.id in (select reportID from 
						QStatus_GroupReport gr
					 INNER JOIN
						QCheck_Groups g
					ON
						g.ID = gr.GroupID
					INNER JOIN
						QCheck_GroupMembership gm
					ON
						gm.GroupID = g.ID
					AND
						gm.UserID = @UserID)
				and
					@UserID in
					(
						SELECT SupervisorUserID FROM 
						QStatus_SupervisorDepartments
					)
			ORDER BY LastReportDate desc
		
END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportSingleTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE                                PROCEDURE [dbo].[QStatus_GetReportSingleTask]
	@ReportID int,
	@taskID int
AS
BEGIN
	SET NOCOUNT ON
	
	

	-- SECTION HEADS
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType,
		tt.DisplayOrder * 1000 As ReturnOrder
	FROM
		QStatus_Tasks t
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		t.Type = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		t.ReportID = @ReportID
	AND
		t.IsDeleted = 0
	AND 	
		t.ID = @taskID
	--END SECTION HEADS

	UNION ALL

	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		tt.NativeType,
		tt.DisplayOrder * 1000 + 1 As ReturnOrder
	FROM
		QStatus_Tasks t
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		t.Type = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		t.ReportID = @ReportID
	AND
		t.IsDeleted = 0
	AND 	
		t.ID = @taskID
	AND
		tt.NativeType <> 1 --Questions section has no headings
	--END SECTION HEADINGS

	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tt.NativeType,
		tt.DisplayOrder * 1000 + 999 As ReturnOrder
	FROM
		QStatus_Tasks t
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		t.Type = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE
		t.ReportID = @ReportID
	AND
		t.IsDeleted = 0
	AND 	
		t.ID = @taskID

	--END SECTION ENDERS

	UNION ALL
	
	--START SECTION
	SELECT 
		t.ID, 
		t.Description,
		Convert(varchar, DueDate, 101) as DueDate,
		Priority,
		'' As Comments,
		Convert(varchar, UpdatedDate, 101) as UpdatedDate,
		tt.Description As Type,
		tt.NativeType,
		tt.DisplayOrder * 1000 + 100 + Priority As ReturnOrder
	FROM
		QStatus_Tasks t
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		t.Type = tt.ID
	AND
		tt.IsDeleted = 0
	WHERE

		t.ReportID = @ReportID
	AND
		t.IsDeleted = 0
	AND 	
		t.ID = @taskID
	--END SECTION

	ORDER BY ReturnOrder

	SET NOCOUNT OFF
END

























































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportsOnHold]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE       PROCEDURE [dbo].[QStatus_GetReportsOnHold]
	@expired bit = 0

AS
BEGIN
	
	select 
		oh.ID
		, r.name as report
		, convert(varchar, startdt, 101) as starting
		, convert(varchar, enddt, 101) as ending
		, dbo.QStatus_GetUserNamesFull(r.ID) as controllers
		, dbo.QStatus_GetSupervisorOnlyNames(r.ID) as Supervisors
		, dbo.QStatus_GetIPNames(r.ID) as InterestedParties
	from Grading_OnHold oh
	inner join qstatus_report r
	on r.id = oh.reportID
	and r.isdeleted = 0
	and (
		(@expired = 0 AND oh.enddt >= getdate() - 40)
		OR
		(@expired = 1 AND oh.enddt < getdate() - 40)
	)
	order by 2, 3

END



GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportsUnreadData]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO















CREATE                                                       PROCEDURE [dbo].[QStatus_GetReportsUnreadData]
	@UserID int,
	@Read bit,
	@ViewType int
AS
BEGIN

	IF @ViewType <= 2  --supervisor or ip
	BEGIN
		SELECT distinct s.ReportID, 
			LastReportDate, 
			CASE WHEN LastViewed > 0 THEN LastViewed ELSE NULL END AS LastViewed,
			dbo.QStatus_GetUserNames(r.ID) + r.Name as fullname
			,CASE WHEN f.ReportID IS NULL THEN 'non' ELSE '' END as IsFav
		FROM
		
			QStatus_Report r
		LEFT OUTER JOIN
			QStatus_SupervisorsLastViewed lv
		ON
			lv.SupervisorUserID = @UserID
		AND
			lv.ReportID = r.ID
		INNER JOIN
			QStatus_Supervisors s
		ON
			r.ID = s.ReportID
		AND
			s.DirectSupervisor = 1
		AND
		(
			(s.InterestedParty = 0 and @ViewType = 1) --supervisor
				OR
			(s.InterestedParty = 1 and @ViewType = 2)  --ip
		)
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = s.SupervisorGroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		LEFT OUTER JOIN 
				QStatus_Favorites f
			ON
				f.UserID = @UserID
			AND
				f.ReportID = r.ID
		WHERE
			(
				(@Read = 0 AND ISNULL(r.LastReportDate,1) > IsNull(lv.LastViewed, 0))
					OR
				(@Read = 1 AND ISNULL(r.LastReportDate,0) < IsNull(lv.LastViewed, 0))
			)	
			and r.IsDeleted = 0
			and not 
				r.id in (select reportID from 
						QStatus_GroupReport gr
					 INNER JOIN
						QCheck_Groups g
					ON
						g.ID = gr.GroupID
					INNER JOIN
						QCheck_GroupMembership gm
					ON
						gm.GroupID = g.ID
					AND
						gm.UserID = @UserID)
		ORDER BY LastReportDate desc
	END
	ELSE
	BEGIN
		IF @ViewType = 3  -- all firm reports (geoffrey)
		BEGIN
			SELECT  distinct
				r.ID as reportid, 
				LastReportDate, 
				CASE WHEN IsNull(LastViewed,0) > 0 THEN LastViewed ELSE NULL END AS LastViewed,
				dbo.QStatus_GetUserNames(r.ID) + r.Name as fullname
				,CASE WHEN f.ReportID IS NULL THEN 'non' ELSE '' END as IsFav
			FROM
			
				QStatus_Report r
			INNER JOIN
				QStatus_GroupReport gr
			ON
				gr.ReportID = r.ID

			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = gr.GroupID
			INNER JOIN
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID
			INNER JOIN
				QCheck_Users u
			ON
				u.ID = gm.UserID
			LEFT OUTER JOIN
				QStatus_SupervisorsLastViewed lv
			ON
				lv.SupervisorUserID = @UserID
			AND
				lv.ReportID = r.ID
			LEFT OUTER JOIN 
				QStatus_Favorites f
			ON
				f.UserID = @UserID
			AND
				f.ReportID = r.ID

			WHERE
				(
					(@Read = 0 AND ISNULL(r.LastReportDate,1) > IsNull(lv.LastViewed, 0))
						OR
					(@Read = 1 AND ISNULL(r.LastReportDate,0) < IsNull(lv.LastViewed, 0))
				)	
				and r.IsDeleted = 0
				/*and not 
					r.id in (select reportID from 
						QStatus_GroupReport gr
					 INNER JOIN
						QCheck_Groups g
					ON
						g.ID = gr.GroupID
					INNER JOIN
						QCheck_GroupMembership gm
					ON
						gm.GroupID = g.ID
					AND
						gm.UserID = @UserID)*/
				and
					@UserID in
					(
						SELECT SupervisorUserID FROM 
						QStatus_SupervisorDepartments
					)
			ORDER BY LastReportDate desc
		END
		ELSE --favorites
			
			SELECT  distinct
				r.ID as reportid, 
				LastReportDate, 
				CASE WHEN IsNull(LastViewed,0) > 0 THEN LastViewed ELSE NULL END AS LastViewed,
				dbo.QStatus_GetUserNames(r.ID) + r.Name as fullname
				,'' as IsFav
			FROM
				QStatus_Report r
			LEFT OUTER JOIN
				QStatus_SupervisorsLastViewed lv
			ON
				lv.SupervisorUserID = @UserID
			AND
				lv.ReportID = r.ID
			INNER JOIN 
				QStatus_Favorites f
			ON
				f.UserID = @UserID
			AND
				f.ReportID = r.ID


			WHERE
				
				(
					(@Read = 0 AND ISNULL(r.LastReportDate,1) > IsNull(lv.LastViewed, 0))
						OR
					(@Read = 1 AND ISNULL(r.LastReportDate,0) < IsNull(lv.LastViewed, 0))
				)	
				and r.IsDeleted = 0
				and (
					r.ID in
					(
						select 
							s.reportID 
						from 
							QStatus_Supervisors s
						INNER JOIN
							QCheck_Groups g
						ON
							g.ID = s.SupervisorGroupID
						AND
							r.ID = s.ReportID
						AND
							s.DirectSupervisor = 1
						INNER JOIN
							QCheck_GroupMembership gm
						ON
							gm.GroupID = g.ID
						AND
							gm.UserID = @UserID
					)
					or @UserID in
					(
						SELECT SupervisorUserID FROM 
						QStatus_SupervisorDepartments
					)
				)
				and not 
					r.id in 
						(
						select reportID from 
							QStatus_GroupReport gr
						INNER JOIN
							QCheck_Groups g
						ON
							g.ID = gr.GroupID
						INNER JOIN
							QCheck_GroupMembership gm
						ON
							gm.GroupID = g.ID
						AND
							gm.UserID = @UserID
						)
				

	END
END
































































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportTaskTypes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QStatus_GetReportTaskTypes]
@ReportID int

AS

SELECT distinct id
from qstatus_tasktypes tt
	
WHERE 
		tt.reportID = @reportID
UNION
select st.id
FROM
	QStatus_SpecialTasks st
INNER JOIN
	QStatus_TaskTypes  tt
ON
	st.TaskType = tt.ID
AND
	tt.ReportID = @ReportID
AND
	st.IsDeleted = 0
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportTimeline]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE	PROCEDURE [dbo].[QStatus_GetReportTimeline]
	@ReportID int,
	@UserID int
AS
BEGIN
	SET NOCOUNT ON
	
	IF @ReportID > 0
		SELECT 
			DISTINCT 
			
			tt.Description + ' - ' +c.Name as [Description],
			Convert(varchar, ac.DueTime, 101) as DueDate,
			1 as Type,
			CASE WHEN DueTime < GetDate() Then
				1
			Else
				0
			END As Overdue,
			DueTime as dt
		FROM  QStatus_Report r
		INNER JOIN Qstatus_TaskTypes tt
			ON tt.ReportID = r.ID
			AND tt.IsDeleted = 0
			AND tt.NativeType = 0
			AND r.ID = @ReportID
		INNER JOIN QStatus_ActiveChecklistTaskType actt
			ON actt.taskType = tt.ID
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.ID = actt.ActiveChecklistID
			AND ac.completedDate is null
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ID = ac.InstanceID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON c.ID = ci.ChecklistID 
			AND c.IsDeleted = 0
		ORDER By dt
	ELSE
		SELECT 
			DISTINCT 
			r.Name + ' : ' + 
			tt.Description + ' - ' +c.Name as [Description],
			Convert(varchar, ac.DueTime, 101) as DueDate,
			1 as Type,
			CASE WHEN DueTime < GetDate() Then
				1
			Else
				0
			END As Overdue,
			DueTime as dt
		FROM QCheck_GroupMembership gm
		INNER JOIN QCheck_Groups g
			ON g.ID = gm.GroupID
			AND gm.UserID = @UserID
		INNER JOIN QStatus_GroupReport ur
			ON ur.GroupID = g.ID
		INNER JOIN QStatus_Report r
			ON (r.ID = @ReportID OR @ReportID = 0)
			AND ur.ReportID = r.ID
			AND r.IsDeleted = 0
		INNER JOIN Qstatus_TaskTypes tt
			ON tt.ReportID = r.ID
			AND tt.IsDeleted = 0
			AND tt.NativeType = 0
		INNER JOIN QStatus_ActiveChecklistTaskType actt
			ON actt.taskType = tt.ID
		INNER JOIN QCheck_ActiveChecklists ac
			ON ac.ID = actt.ActiveChecklistID
			AND ac.completedDate is null
		INNER JOIN QCheck_ChecklistInstances ci
			ON ci.ID = ac.InstanceID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON c.ID = ci.ChecklistID 
			AND c.IsDeleted = 0
		ORDER By dt
	
		

	SET NOCOUNT OFF
END




GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportTodaysComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                                 PROCEDURE [dbo].[QStatus_GetReportTodaysComments]
	@UserID int,
	@ReportID int,
	@deletedDate datetime = null,
	@MoveCompleted bit = 0,
	@selectedComments varchar(1000) = null
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @CompletedType varchar(10)
	
	SELECT @CompletedType = 'Completed'

	DECLARE @CompareDt datetime

	set @CompareDt = dateadd(hour, 4, convert(datetime, convert(varchar, getdate(), 101)))

	if @CompareDt > getdate() 
		set @CompareDt = dateadd(day, -1, @CompareDt)

	--if only specific comments were requested, parse them out into a table
	DECLARE @selectedCommentsTbl TABLE (commentID int)

	IF @selectedComments IS NOT NULL
		INSERT INTO @selectedCommentsTbl
		SELECT n from dbo.Util_fn_List_To_Table(@selectedComments,',')

	--find all the tasks
	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY,
		SpecialTask int
	)

	IF @selectedComments IS NOT NULL
	BEGIN
		INSERT INTO @ForeignKeyIDs 
			SELECT distinct actt.activechecklistid, specialTask 
			FROM QStatus_ActiveChecklistTaskType actt
			inner join qstatus_tasktypes tt
			on tt.id = actt.tasktype
			and tt.reportID = @reportID
			inner join qstatus_comments c
			on c.foreignkeyid = actt.activechecklistid
			and c.specialtask = 0
			--and c.UserID = @UserID
			AND LEN(Comments)>0 
			AND CommentDt > @CompareDt 
			INNER JOIN @selectedCommentsTbl sc ON
			c.id = sc.commentID

		INSERT INTO @ForeignKeyIDs
			SELECT distinct 
				st.ID, 1
			FROM 
				QStatus_SpecialTasks st
			inner join 
				qstatus_tasktypes tt
			ON
				tt.ID = st.TaskType
			AND
				tt.ReportID = @ReportID
			inner join 
				qstatus_comments c
			on c.foreignkeyid = st.ID
			AND LEN(Comments)>0 
			AND CommentDt > @CompareDt
			and specialtask=1
			--and c.UserID = @UserID
			INNER JOIN @selectedCommentsTbl sc ON
			c.id = sc.commentID
	END
	ELSE
	BEGIN
		INSERT INTO @ForeignKeyIDs 
			SELECT distinct actt.activechecklistid, specialTask 
			FROM QStatus_ActiveChecklistTaskType actt
			inner join qstatus_tasktypes tt
			on tt.id = actt.tasktype
			and tt.reportID = @reportID
			inner join qstatus_comments c
			on c.foreignkeyid = actt.activechecklistid
			and c.specialtask = 0
			--and c.UserID = @UserID
			AND LEN(Comments)>0 
			AND CommentDt > @CompareDt

		INSERT INTO @ForeignKeyIDs
			SELECT distinct 
				st.ID, 1
			FROM 
				QStatus_SpecialTasks st
			inner join 
				qstatus_tasktypes tt
			ON
				tt.ID = st.TaskType
			AND
				tt.ReportID = @ReportID
			inner join 
				qstatus_comments c
			on c.foreignkeyid = st.ID
			AND LEN(Comments)>0 
			AND CommentDt > @CompareDt 
			and specialtask=1
			--and c.UserID = @UserID
	END

	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		InstanceID int,
		assignees varchar(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit
	)

		
	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int
	)
	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)
	
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	SELECT distinct
		ac.ID, 
		ac.DueTime,
		ac.InstanceID,
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		CompletedDate, 
		0
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	AND
		tt.IsDeleted = 0
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	inner join 
		@ForeignKeyIDs f
	ON
		f.ForeignKeyID = ac.ID
	AND
		f.SpecialTask = 0	

	
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	SELECT distinct 
		ac.ID, 
		ac.DueTime,
		ac.InstanceID, 
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		CompletedDate, 
		1
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	AND
		tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklistArchive ac
	ON
		ac.ID = actt.ActiveChecklistID
	--AND 
	--	ac.archivedate > @deleteddate 
	--AND
	--	@deleteddate is not null

	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	inner join 
		@ForeignKeyIDs f
	ON
		f.ForeignKeyID = ac.ID
	AND
		f.SpecialTask = 0	



	
	update @tasks
		set DueDateChanged = 1
		from @tasks t
		inner join QStatus_DueDateChanges ddc
		on 
			ddc.ActiveChecklistID =t.ID
		AND 
			ddc.UpdateDt > @deletedDate

	
	update @tasks
		set PriorityChanged = 1
		from @tasks t
		inner join QStatus_PriorityChanges pc
		on 
			pc.ActiveChecklistID =t.ID
		AND 
			pc.UpdateDt > @deletedDate
	
	insert into @instances
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstances ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			ci.IsDeleted = 0 
		OR 
			@deleteddate is not null

		UNION ALL

		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstanceArchive ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			(ci.IsDeleted = 0 
			OR	 
			@deleteddate is not null)
		AND 
			ci.archivedate > @deleteddate 
		AND 
			@deleteddate is not null
	
	insert into @checklists
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_Checklists c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		AND 
			tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
		OR 
			@deleteddate is not null

		UNION ALL

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		AND 
			tnc.UpdateDt > @deletedDate
		WHERE
			(c.IsDeleted = 0 
			OR	 
			@deleteddate is not null)
		AND 
			c.archivedate > @deleteddate 
		AND 
			@deleteddate is not null

	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)

	update @tasks
		set description = c.description,
		tasknamechanged = c.tasknamechanged
	from @tasks t
	inner join @instances i
	on i.id = t.instanceid
	inner join @checklists c
	on c.id = i.checklistid


	DECLARE @specialtasks table(
		ID int,
		priority int,
		tasktypeid int,
		tasktypedescription varchar(1000), 
		tasktypenativetype int,
		tasktypedisplayorder int
	)

	insert into @specialtasks
		select st.ID,
			st.priority,
			tt.id,
			tt.description,
			tt.nativetype,
			tt.displayorder
		from 
			QStatus_SpecialTasks st
		INNER JOIN
			QStatus_TaskTypes	tt
		ON
			st.TaskType = tt.ID
		AND
			tt.IsDeleted = 0
		AND
			st.IsDeleted = 0
		AND
			tt.ReportID = @ReportID
		INNER JOIN
			@ForeignKeyIDs f
		ON 
			f.ForeignKeyID = st.ID
		AND
			f.SpecialTask = 1

	--START HEADER
	SELECT
		null as ID, 
		dbo.QStatus_GetUserNames(r.ID) + r.Name + ' - Status Report - '
		+ CASE WHEN r.LastReportDate = 0 THEN
			'No Status'
		ELSE
			ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
			+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
			+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
		END 
		as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		'0' as TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER

	
	UNION ALL

	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		-1,
		null as IsDeleted,
		2 As ReturnOrder, 
		'0' As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN t.CompletedDate IS Not Null then Null ELSE t.TaskType END AS ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType +' - '+ taskdescription ELSE taskdescription END AS Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
		
	FROM
		@tasks t
	
	
	UNION ALL

	--START SECTION HEADINGS
	SELECT DISTINCT
		null as ID, 
		null as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Headings Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  + 1 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t

	UNION ALL

	--START SECTION ENDERS
	SELECT DISTINCT
		null as ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskdescription end as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 999 As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@tasks t

	--END SECTION ENDERS


	UNION ALL
	
	--START SECTION
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.archived = 1 THEN
			--' (DELETED)'
			''
		ELSE
			''
		END
		 as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskDescription end As Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo
	FROM
		@tasks t

	UNION ALL
 
	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tasktypedescription as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tasktypenativetype as NativeType ,
		null as IsDeleted,
		tasktypedisplayorder * 1000 * 2 As ReturnOrder,
		CAST(tasktypeid As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION HEADS SPECIAL 
	
	UNION ALL
	
	-- COLUMN HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tasktypedescription as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Special Headings Row' as Type,
		tasktypenativetype as NativeType ,
		null as IsDeleted,
		tasktypedisplayorder * 1000 * 2 + 1 As ReturnOrder,
		CAST(tasktypeid As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END COLUMN HEADS SPECIAL 


	UNION ALL

	-- SECTION ENDERS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tasktypedescription as Description,
		null as DueDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'EnderType' as Type,
		tasktypenativetype as NativeType ,
		null as IsDeleted,
		tasktypedisplayorder * 1000 * 2 + 999 As ReturnOrder,
		CAST(tasktypeid AS varchar) AS TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION ENDERS SPECIAL 
	
	UNION ALL

	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID,  -- negative for special sections
		st.tasktypedescription as description,
		null as DueDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		st.tasktypedescription as Type,
		st.tasktypenativetype as NativeType ,
		0 as IsDeleted,
		st.tasktypedisplayorder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		CAST(st.tasktypeid AS varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo
	FROM
		@specialtasks st
	--END SECTION SPECIAL 

	

	ORDER BY ReturnOrder, DueDate asc

	SELECT 
		IsConfidential 
	FROM
		QStatus_Report
	WHERE
		ID = @ReportID


	SET NOCOUNT OFF
END



GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportTop10]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE       PROCEDURE [dbo].[QStatus_GetReportTop10]

AS
BEGIN
	
	--exec sp_recompile 'QStatus_GetReport'
 
	SET NOCOUNT ON
declare @UserID int,
	@ReportID int,
	@deletedDate datetime,
	@MoveCompleted bit ,
	@DueFilter datetime,
	@AssignedTo int 
	
set @deletedDate = null
set @MoveCompleted  = 0
set 	@DueFilter  = null
set @AssignedTo = -1

	DECLARE @ReportUserID int
	DECLARE @LastReadDate datetime
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int
	/*DECLARE @Seed int
	INSERT INTO QStatus_Seed
	SELECT 1
	SELECT @Seed = scope_identity()
	DELETE FROM QStatus_Seed*/
	--find all the tasks
	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY
	)

	DECLARE @TaskCount TABLE
	(
		ReportID int,
		TaskCount int
	)
	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		InstanceID int,
		assignees varchar(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit
	)
	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int
	)
	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)

DECLARE REPORTS CURSOR
FOR
SELECT
distinct		r.ID as ReportID,
		u.ID as UserID
	FROM
		QStatus_Report r
	INNER JOIN
		QStatus_GroupReport gr
	ON
		r.ID = gr.ReportID
	AND
		r.IsDeleted = 0
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	INNER JOIN
		QCheck_Users u
	ON
		u.ID = gm.UserID
	--where
	--	r.LastReportDate > getDate() - 1

OPEN REPORTS
	FETCH NEXT FROM REPORTS INTO @ReportID, @UserID
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		
	delete from @ForeignKeyIDs

	INSERT INTO @ForeignKeyIDs 
		SELECT distinct actt.activechecklistid 
		FROM QStatus_ActiveChecklistTaskType actt
		inner join qstatus_tasktypes tt
		on tt.id = actt.tasktype
		inner join qstatus_comments c
		on c.foreignkeyid = actt.activechecklistid
		WHERE 
		tt.reportID = @reportID AND
		c.specialtask = 0

	--add a day to whatever was passed in (takes care of default to midnight)
	IF @DueFilter is not null
		SET @DueFilter = DateAdd(day, 1, @DueFilter)
	
	SELECT @CompletedType = 'Completed'
	--find out if they are a user or supervisor/ip
	SET @ReportUserID = 0
	SELECT @ReportUserID = UserID
	FROM
		QStatus_GroupReport gr
	INNER JOIN QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gr.ReportID = @ReportID
	AND
		gm.UserID = @UserID
	--default to 60 days ago
	SELECT @LastReadDate =  getdate() - 60
	
	--find last time it was marked read by you if you are supervisor/ip
	SELECT @LastReadDate = LastViewed
		FROM 
			QStatus_SupervisorsLastViewed
		WHERE
			ReportID = @ReportID 
		AND
			SupervisorUserID = @UserID
	
	--if it is your report, just use yesterday
	IF @ReportUserID = @UserID
		SELECT @LastReadDate = dateadd(day, -1, getdate())

	delete from @tasks
	delete from @instances
	delete from @checklists

	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	SELECT distinct
		ac.ID, 
		ac.DueTime,
		ac.InstanceID,
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		CompletedDate, 
		0
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN
		QCheck_ActiveAssignments aa
	ON
		aa.ActiveChecklistID = ac.ID
	INNER JOIN
		QCheck_Assignments a
	ON
		a.ID = aa.AssignmentsID
	AND
		(a.GroupID = @AssignedTo or @AssignedTo = -1)
	AND
		a.IsDeleted = 0
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	WHERE
		tt.ReportID = @ReportID
	AND (
		@DueFilter is null 
		OR ac.DueTime < @DueFilter 
		OR ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	
	SELECT distinct 
		ac.ID, 
		ac.DueTime,
		ac.InstanceID, 
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		CompletedDate, 
		1
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklistArchive ac
	ON
		ac.ID = actt.ActiveChecklistID
	AND 
		ac.archivedate > @deleteddate 
	AND
		@deleteddate is not null
	INNER JOIN
		QCheck_ActiveAssignmentArchive aa
	ON
		aa.ActiveChecklistID = ac.ID
	
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	WHERE
		
		tt.ReportID = @ReportID
	AND (
		@DueFilter is null 
		OR ac.DueTime < @DueFilter 
		OR ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	AND
		(
			@AssignedTo = -1
		OR
			aa.AssignmentsID in
			(SELECT ID FROM QCheck_Assignments
			WHERE GroupID = @AssignedTo and isdeleted = 0)
		OR
			aa.AssignmentsID in
			(SELECT ID FROM QCheck_AssignmentArchive
			WHERE GroupID = @AssignedTo and isdeleted = 0)
		)
	update @tasks
		set DueDateChanged = 1
		from @tasks t
		inner join QStatus_DueDateChanges ddc
		on 
			ddc.ActiveChecklistID =t.ID
		AND 
			ddc.UpdateDt > @deletedDate
	
	update @tasks
		set PriorityChanged = 1
		from @tasks t
		inner join QStatus_PriorityChanges pc
		on 
			pc.ActiveChecklistID =t.ID
		AND 
			pc.UpdateDt > @deletedDate
	
	insert into @instances
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstances ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			ci.IsDeleted = 0 
		OR 
			@deleteddate is not null
		UNION ALL
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstanceArchive ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			(ci.IsDeleted = 0 
			OR	 
			@deleteddate is not null)
		AND 
			ci.archivedate > @deleteddate 
		AND 
			@deleteddate is not null
	
	insert into @checklists
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_Checklists c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		AND 
			tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
		OR 
			@deleteddate is not null
		UNION ALL
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		AND 
			tnc.UpdateDt > @deletedDate
		WHERE
			(c.IsDeleted = 0 
			OR	 
			@deleteddate is not null)
		AND 
			c.archivedate > @deleteddate 
		AND 
			@deleteddate is not null
	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)
	update @tasks
		set description = c.description,
		tasknamechanged = c.tasknamechanged
	from @tasks t
	inner join @instances i
	on i.id = t.instanceid
	inner join @checklists c
	on c.id = i.checklistid

	insert into @taskcount
	select @reportID, count(*)
	from @tasks
	where id is not null

		FETCH NEXT FROM REPORTS INTO @ReportID, @UserID
	
	END
	CLOSE REPORTS
	DEALLOCATE REPORTS

	declare @bytecount table
	(
		ReportID int,
		ByteCount int
	)

	insert into @bytecount
	select r.id, sum(len(c.comments))
			FROM QStatus_ActiveChecklistTaskType actt
			inner join qstatus_tasktypes tt
			on tt.id = actt.tasktype inner join qstatus_report r
			on tt.reportID = r.ID
			inner join qstatus_comments c
			on c.foreignkeyid = actt.activechecklistid
where c.commentdt > getdate() - 14
group by r.id

update @bytecount
set bytecount = bc.bytecount + (t.taskcount * 1500)
from @bytecount bc inner join @taskcount t on bc.reportid = t.reportid
	
--select distinct top 10 r.name, t.taskcount from @taskcount t inner join qstatus_report r on r.id = t.reportid order by taskcount desc
select distinct top 15 r.name, bc.bytecount from @bytecount bc inner join qstatus_report r on r.id = bc.reportid order by bytecount desc

	SET NOCOUNT OFF
END








GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





























CREATE                          PROCEDURE [dbo].[QStatus_GetReportUser]
	@ReportID int,
	@CheckUserID int,
	@UserID int output
AS
BEGIN
	SET NOCOUNT ON
	
	SELECT @UserID = gm.UserID
	FROM
		QStatus_GroupReport gr
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @CheckUserID
	AND
		gr.ReportID = @ReportID

	IF @UserID IS NULL
		SELECT @UserID = ISNULL(Max(gm.UserID), 0)
		FROM
			QStatus_GroupReport gr
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gr.ReportID = @ReportID


	SET NOCOUNT OFF
END






























GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetReportUsers]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE                              PROCEDURE [dbo].[QStatus_GetReportUsers]
	@ReportID int
AS
BEGIN
	SET NOCOUNT ON

	SELECT DISTINCT gr.ID, g.Name as FullName--u.FullName--, u.ID as ReportUser
	FROM
		QStatus_GroupReport gr
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gr.ReportID = @ReportID
	INNER JOIN
		QCheck_Users u
	on 
		u.id = gm.UserID
	AND
		gr.ReportID = @ReportID
	ORDER BY
		FullName
		

	SET NOCOUNT OFF
END















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSections]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                    PROCEDURE [dbo].[QStatus_GetSections]
	@ReportID int,
	@IsDeleted bit = 0
AS
BEGIN

	SELECT 
		ID, 
		Description, 
		NativeType 
	FROM
		QStatus_TaskTypes
	WHERE	
		IsDeleted = @IsDeleted
	AND
		ReportID = @ReportID
	AND
		NativeType <> 5
	AND Description Not in ('Questions', 'Completed')
	ORDER BY
		DisplayOrder
END




GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSingleTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO













CREATE                                                 PROCEDURE [dbo].[QStatus_GetSingleTask]
	@TaskID  int,
	@UserID int
AS

	SET NOCOUNT ON

	DECLARE @HasRelatedComments bit
	SET  @HasRelatedComments = 0

	SELECT @HasRelatedComments = 1
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		(
			SELECT    
				ID, InstanceID
			FROM         QCheck_ActiveChecklists
			UNION ALL
			SELECT     
				ID, InstanceID
			FROM         
				QCheck_ActiveChecklistArchive 

		) AC
	ON
		C.ForeignKeyID = AC.ID
	AND
		AC.ID <> @TaskID
	INNER JOIN
		(
			SELECT    
				ID, ChecklistID
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID
			FROM         
				QCheck_ChecklistInstanceArchive 

		) CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID = @TaskID

	SELECT 
		Distinct null as archiveid, C.*, null as archivedt, 
		@TaskID as TaskID,
		CASE WHEN supcolor.colorNum is not null THEN
			supcolor.colorNum
		ELSE
			0
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTS C
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	WHERE c.foreignkeyid = @TaskID
	AND c.specialtask = 0

	union all

	SELECT 
		Distinct c.*,
		@taskID as TaskID,
		CASE WHEN supcolor.colorNum is not null THEN
			supcolor.colorNum
		ELSE
			0
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTarchive C
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	WHERE c.foreignkeyid = @TaskID
	AND c.specialtask = 0

	ORDER BY C.DisplayOrder


	SELECT @HasRelatedComments


	SELECT  c.Name,
		dbo.QCheck_FullAssigneesList(ci.id) as Assignees,
		convert(varchar, ac.duetime, 101) as due
	FROM QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		on ci.id = ac.instanceid
	INNER JOIN QCheck_Checklists c
		on c.id = ci.checklistid
	WHERE ac.ID = @TaskID

	DECLARE @Color int
	SET @Color = 0
	
	SELECT @Color = ColorNum
	FROM QStatus_SupervisorColors
	WHERE SupervisorUserID = @UserID

	SELECT @Color


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSlimCommentsAll]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetSlimCommentsAll]
	@Seed int,
	@ReportID int,
	@UserId int
AS
	SET NOCOUNT ON

	SELECT DISTINCT
		 null AS ArchiveID
		, C.ID
		, tt.keyID AS TaskID
		, DisplayOrder
		, c.TabIn
		, c.Initials
		, u.FullName
		, c.CommentDt
		, c.UserID
		, CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		 ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		 END as colornum
	FROM
		QStatus_COMMENTS C
		INNER JOIN
		QStatus_TempTasks tt
			ON tt.ID = @Seed
			AND c.ForeignKeyID = abs(tt.KeyID)
			AND c.SpecialTask = tt.SpecialTask
		INNER JOIN QCheck_Users u
			ON u.ID = C.UserID
		LEFT OUTER JOIN 
			(SELECT gm.UserID, s.InterestedParty
			FROM QStatus_SUPERVISORS s
			INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = s.supervisorGroupID
			INNER JOIN QCheck_Groups g
			ON g.ID = gm.GroupID
			AND s.ReportID = @ReportID
		) sup
		ON sup.UserId = c.UserID
		LEFT OUTER JOIN 
			(SELECT gm.UserID
			FROM QStatus_GroupReport gr
			INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = gr.GroupID
			INNER JOIN QCheck_Groups g
			ON g.ID = gm.GroupID
			AND gr.ReportID = @ReportID
		) gr ON gr.UserId = c.UserID
		LEFT OUTER JOIN QStatus_SupervisorColors supcolor
			ON supcolor.supervisorUserID = u.ID

	UNION ALL

	SELECT DISTINCT
		 C.ArchiveID
		, c.ID
		, tt.keyID AS TaskID
		, DisplayOrder
		, c.TabIn
		, c.Initials
		, u.FullName
		, c.CommentDt
		, c.UserID
		, CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		 ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		 END as colornum
	FROM
		QStatus_commentarchive C
		INNER JOIN QStatus_TempTasks tt
			ON tt.ID = @Seed
			AND c.ForeignKeyID = ABS(tt.KeyID)
			AND c.SpecialTask = tt.SpecialTask
		INNER JOIN QCheck_Users u
			ON u.ID = C.UserID
		LEFT OUTER JOIN 
			(SELECT gm.UserID, s.InterestedParty
			FROM QStatus_SUPERVISORS s
			INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = s.supervisorGroupID
			INNER JOIN QCheck_Groups g
			ON g.ID = gm.GroupID
			AND s.ReportID = @ReportID
		) sup ON sup.UserId = c.UserID
		LEFT OUTER JOIN 
			(SELECT gm.UserID
			FROM QStatus_GroupReport gr
			INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = gr.GroupID
			INNER JOIN QCheck_Groups g
			ON g.ID = gm.GroupID
			AND gr.ReportID = @ReportID
		) gr ON gr.UserId = c.UserID
		LEFT OUTER JOIN QStatus_SupervisorColors supcolor
			ON supcolor.supervisorUserID = u.ID

	SELECT distinct ac2.ID
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		--QCheck_ActiveChecklists
	(
		select id, instanceid from QCheck_ActiveChecklists
		union all
		select id, instanceid from QCheck_ActiveChecklistArchive
	)
	 AC
	ON
		C.ForeignKeyID = AC.ID
	INNER JOIN
		--QCheck_ChecklistInstances
		(
		select id, checklistid from QCheck_ChecklistInstances
		union all
		select id, checklistid from QCheck_ChecklistInstanceArchive
	) 
	CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID <> AC.ID
	INNER JOIN
		QStatus_TempTasks tt
	ON
		tt.ID = @Seed
	AND
		ac2.ID = tt.KeyID
	WHERE c.specialtask = 0
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSlimCommentsByIds]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [dbo].[QStatus_GetSlimCommentsByIds]
	@ReportID int,
	@UserID int,
	@RecordId RecordId readonly
AS
BEGIN
	SET NOCOUNT ON

	EXEC dbo.Audit_Set @userId, @recordId, 'Comment', 2

	SELECT DISTINCT
		 Id = c.ID
		,[Text] = c.Comments
	FROM
		QStatus_COMMENTS C
		INNER JOIN @RecordId R
			ON r.Id = c.ID

	UNION ALL

	SELECT DISTINCT
		 Id = c.ID
		,[Text] = c.Comments
	FROM
		QStatus_commentarchive C
		INNER JOIN @RecordId R
			ON R.Id = c.ID
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetStatusReportSummary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[QStatus_GetStatusReportSummary]
	@UserID int,
	@ReportID int,
	@deletedDate datetime = null,
	@MoveCompleted bit = 0,
	@DueFilter datetime = null,
	@AssignedTo int = -1,
	@PriorityListSetID INT = -1
 as
	SET NOCOUNT ON
	
	--@UserID int = 471,
	--@ReportID int = 1100913,

	DECLARE @ReportUserID int
	DECLARE @LastReadDate datetime
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int
	DECLARE @Seed int
	DECLARE @PriorityListSetName VARCHAR(50)
	
	INSERT INTO QStatus_Seed
		SELECT 1

	SELECT @Seed = scope_identity()

	DELETE FROM QStatus_Seed
	--find all the tasks

	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY
	)

	INSERT INTO @ForeignKeyIDs 
		SELECT distinct activechecklistid 
		FROM qstatus_commentedreporttasks
		WHERE reportID = @reportID 

	--add a day to whatever was passed in (takes care of default to midnight)
	IF @DueFilter is not null
		SET @DueFilter = DateAdd(day, 1, @DueFilter)
	
	SELECT @CompletedType = 'Completed'
	--find out if they are a user or supervisor/ip

	SET @ReportUserID = 0

	SELECT 
		@ReportUserID = UserID
	FROM
		QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
			ON g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gr.ReportID = @ReportID
			AND gm.UserID = @UserID

	--default to 60 days ago
	SELECT @LastReadDate =  getdate() - 60
	
	--find last time it was marked read by you if you are supervisor/ip
	SELECT 
		@LastReadDate = LastViewed
	FROM 
		QStatus_SupervisorsLastViewed
	WHERE
		ReportID = @ReportID 
		AND SupervisorUserID = @UserID
	
	--if it is your report, just use yesterday
	IF @ReportUserID = @UserID
		SELECT @LastReadDate = dateadd(day, -1, getdate())

	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		ReminderDate datetime,
		InstanceID int,
		assignees varchar(1000),
		controllers VARCHAR(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit,
		isDeleted bit,
		isRecurring bit,
		isPriority bit,
		isDaily bit
	)

	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int,
		isRecurring bit
	)

	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)

	-- 02/23/2011 dalvarado - priorities section
	declare @priorities table (
		ID int PRIMARY KEY IDENTITY(1,1),
		InstanceID INT,
		Priority INT
	)

	INSERT INTO @priorities (
		InstanceID,
		Priority
	)
		SELECT 
			ac.InstanceID,
			pl.Priority
		FROM
			PriorityListUsers plu
			INNER JOIN PriorityList pl
				ON plu.UserID = pl.UserID
			INNER JOIN QCheck_ActiveChecklists ac
				ON pl.ActiveChecklistID = ac.[ID]
		WHERE 
			PLU.[SetID] = @PriorityListSetID

	SELECT @PriorityListSetName = [Name]
	FROM PriorityListSet
	WHERE [ID] = @PriorityListSetID


	insert into @tasks (
		ID ,
		DueTime,
		ReminderDate,
		InstanceID ,
		assignees ,
		controllers,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived,
		IsDeleted,
		IsPriority,
		IsDaily
	)
		SELECT distinct
			ac.ID, 
			ac.DueTime,
			CASE WHEN CONVERT(VARCHAR(10), ac.ReminderDate, 101) <> CONVERT(VARCHAR(10), ac.DueTime, 101) THEN ac.ReminderDate ELSE NULL END,
			ac.InstanceID,
			isnull(al.assignees, ''),
			isnull(dbo.QCheck_ManagersList(c.[id]), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
			CompletedDate, 
			0,
			c.IsDeleted,
			CASE WHEN p.InstanceID IS NULL THEN 0 ELSE 1 END AS IsPriority,
			CASE WHEN (freqType = 2 AND freqRecurrance = 1) OR (freqType = 3 AND freqRecurrance = 1 AND (freqInterval & 62) = 62) THEN 1 ELSE 0 END as IsDaily
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				--AND
				--	tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists ac
				ON ac.ID = actt.ActiveChecklistID
			INNER JOIN qcheck_checklistinstances ci
				ON ci.ID = ac.InstanceID
			INNER JOIN qcheck_checklists c
				ON ci.ChecklistID = c.ID
			INNER JOIN QCheck_Assignments a
				ON a.instanceID = ci.ID
				AND (
					a.GroupID = @AssignedTo 
					or @AssignedTo = -1
				)
				AND a.IsDeleted = 0
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
			left outer join QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
			left outer join @Priorities p
				ON ac.InstanceID = p.InstanceID
			
		WHERE
			tt.ReportID = @ReportID
			AND (
				@DueFilter is null 
				OR ac.DueTime < @DueFilter
				OR isnull(ac.ReminderDate, ac.DueTime) < @DueFilter
				OR ac.ID in (
					SELECT ForeignKeyID 
					FROM @ForeignKeyIDs
				)
			)


	insert into @tasks (
		ID ,
		DueTime,
		ReminderDate,
		InstanceID ,
		assignees ,
		controllers,
		tasktype ,
		taskdescription ,
		nativetype ,
		tasktypeorder ,
		priority ,
		prioritychanged ,
		duedatechanged ,
		newtask ,
		CompletedDate ,
		Archived ,
		IsPriority,
		IsDaily
	)
		SELECT distinct 
			ac.ID, 
			ac.DueTime,
			CASE WHEN CONVERT(VARCHAR(10), ac.ReminderDate, 101) <> CONVERT(VARCHAR(10), ac.DueTime, 101) THEN ac.ReminderDate ELSE NULL END,
			ac.InstanceID, 
			isnull(al.assignees, ''),
			isnull(dbo.QCheck_ManagersList(ISNULL(cia.ChecklistID, ci.ChecklistID)), ''),
			--dbo.QCheck_FullAssigneesList(ac.instanceid),
			tt.ID,
			tt.Description,
			tt.NativeType,
			tt.DisplayOrder,
			actt.Priority,
			0 as PriorityChanged,
			0 as DueDateChanged,
			CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
			CompletedDate, 
			1,
			0,
			0
		FROM
			QStatus_ActiveChecklistTaskType actt
			INNER JOIN QStatus_TaskTypes	tt
				ON actt.TaskType = tt.ID
				--AND tt.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklistArchive ac
				ON ac.ID = actt.ActiveChecklistID
				AND ac.archivedate > @deleteddate 
				AND @deleteddate is not null
			INNER JOIN QCheck_ActiveAssignmentArchive aa
				ON aa.ActiveChecklistID = ac.ID
			LEFT OUTER JOIN QCheck_ChecklistInstanceArchive cia
				ON ac.InstanceID = cia.[ID]
			-- 2/26/2013 dalvarado - found cases where the instance wasn't archived with the active checklist, so need to look
			-- in both checklistinstances and checklistinstancearchive.
			left outer join qcheck_checklistinstances ci
				ON ac.InstanceID = ci.ID
			left outer join qcheck_assigneelookup al
				on al.instanceid = ac.instanceid
		WHERE
			tt.ReportID = @ReportID
			AND (
				@DueFilter is null 
				OR ac.DueTime < @DueFilter 
				OR isnull(ac.ReminderDate, ac.DueTime) < @DueFilter 
				OR ac.ID in (
					SELECT ForeignKeyID 
					FROM @ForeignKeyIDs
				)
			)
			AND (
				@AssignedTo = -1
				OR aa.AssignmentsID in (
					SELECT ID 
					FROM QCheck_Assignments
					WHERE 
						GroupID = @AssignedTo 
						and isdeleted = 0
				)
				OR aa.AssignmentsID in (
					SELECT ID 
					FROM QCheck_AssignmentArchive
					WHERE 
						GroupID = @AssignedTo 
						and isdeleted = 0
				)
			)

	update 
		@tasks
	set 
		DueDateChanged = 1
	from 
		@tasks t
		inner join QStatus_DueDateChanges ddc
			on ddc.ActiveChecklistID =t.ID
			AND ddc.UpdateDt > @deletedDate
	
	update 
		@tasks
	set 
		PriorityChanged = 1
	from 
		@tasks t
		inner join QStatus_PriorityChanges pc
			on pc.ActiveChecklistID =t.ID
			AND pc.UpdateDt > @deletedDate

	-- 02/23/2011 dalvarado
	IF @PriorityListSetID <> -1 BEGIN

		UPDATE 
			@tasks
		SET 
			TaskType = -1000,
			TaskDescription = 'Top Priorities' + ISNULL(' - ' + @PriorityListSetName, ''),
			TaskTypeOrder = 10,
			Priority = p.Priority
		FROM 
			@tasks t
			inner join @priorities p
				on t.InstanceID = p.InstanceID

	END


	insert into @instances

		SELECT distinct
			ci.ID,
			ci.ChecklistID,
			CASE 
				WHEN s.freqType > 1 THEN 1 
				ELSE 0 
			END as isRecurring
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN @tasks t
				ON t.InstanceID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
		WHERE
			ci.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT distinct
			ci.ID,
			ci.ChecklistID,
			CASE 
				WHEN s.freqType > 1 THEN 1 
				ELSE 0 
			END as isRecurring
		FROM 
			QCheck_ChecklistInstanceArchive ci
			INNER JOIN @tasks t
				ON t.InstanceID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 
		WHERE
			(
				ci.IsDeleted = 0 
				OR @deleteddate is not null
			)
			AND ci.archivedate > @deleteddate 
			AND @deleteddate is not null
	

	insert into @checklists

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE 
				WHEN tnc.ChecklistID IS NULL THEN 0 
				ELSE 1 
			END as TaskNameChanged
		FROM 
			QCheck_Checklists c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
			OR @deleteddate is not null

		UNION ALL

		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE 
				WHEN tnc.ChecklistID IS NULL THEN 0 
				ELSE 1 
			END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
			INNER JOIN @instances ci
				ON c.ID = ci.ChecklistID
			LEFT OUTER JOIN QStatus_TaskNameChanges tnc
				ON tnc.ChecklistID = c.ID
				AND tnc.UpdateDt > @deletedDate
		WHERE
			(
				c.IsDeleted = 0 
				OR @deleteddate is not null
			)
			AND c.archivedate > @deleteddate 
			AND @deleteddate is not null


	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)


	update @tasks
	set 
		description = c.description,
		tasknamechanged = c.tasknamechanged,
		isRecurring = i.isRecurring
	from 
		@tasks t
		inner join @instances i
			on i.id = t.instanceid
		inner join @checklists c
			on c.id = i.checklistid


	INSERT INTO QStatus_TempTasks (
		ID, 
		keyID, 
		specialTask
	)
		SELECT 
			@Seed, 
			id, 
			0
		FROM 
			@Tasks
	
	INSERT INTO QStatus_TempTasks (
		ID, 
		keyID, 
		specialTask
	)
		SELECT 
			@Seed, 
			-1 * st.id, 
			1
		FROM
			QStatus_SpecialTasks st
			INNER JOIN QStatus_TaskTypes  tt
				ON st.TaskType = tt.ID
			--	AND tt.IsDeleted = 0
				AND tt.ReportID = @ReportID
				AND st.IsDeleted = 0


	--START HEADER
	SELECT
		null as ID, 
		dbo.QStatus_GetUserNames(r.ID) + 
			r.Name + ' - Status Report - '
			+ CASE 
				WHEN r.LastReportDate = 0 THEN 
					'No Status'
				ELSE 
					ISNULL(datename(dw, r.LastReportDate) + ' ', '') 
					+ ISNULL(CONVERT(varchar, r.LastReportDate, 101) + ' ', '') 
					+ ltrim(isnull(right(convert(varchar, r.LastReportDate, 100), 7), ''))
			END as Description,
		@LastReadDate as DueDate,
		@LastReadDate AS ReminderDate,
		@LastReadDate AS SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Header Row' as Type,
		-1 As NativeType,
		null as IsDeleted,
		1 As ReturnOrder,
		'0' as TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID
	--END OF HEADER

	UNION ALL

	-- SECTION HEADS
	SELECT DISTINCT
		CASE WHEN t.CompletedDate IS Not Null then Null ELSE t.TaskType END AS ID, 
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType +' - '+ taskdescription ELSE taskdescription END AS Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else t.NativeType end as NativeType,
		null as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeorder * 1000 * 2 + 1000 Else t.tasktypeorder * 1000 * 2 END  As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(t.tasktype as varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		@tasks t
	
	UNION ALL
	
	--START SECTION
	SELECT 
		DISTINCT
		t.ID, 
		t.description + 
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				' (DELETED)'
			ELSE
				''
			END
		ELSE
			''
		END as Description,
		Convert(varchar, t.DueTime, 101) as DueDate,
		Convert(varchar, t.ReminderDate, 101) as ReminderDate,
		Convert(varchar, ISNULL(t.ReminderDate, t.DueTime), 101) as SortDate,
		t.Priority,
		CAST(t.ID as varchar) As Comments,
		0 as UpdatedDate,
		CASE WHEN t.CompletedDate IS Not Null then @CompletedType else t.taskDescription end As Type,
		CASE WHEN t.CompletedDate IS Not Null then 2 else
			CASE WHEN t.archived = 1 THEN
				3
			ELSE
				t.NativeType
			END
		END as NativeType,
		CASE WHEN t.CompletedDate IS NULL THEN
			CASE WHEN t.archived = 1 THEN
				1
			ELSE
				IsDeleted
			END
		ELSE
			IsDeleted
		END as IsDeleted,
		--0 as IsDeleted,
		CASE WHEN t.CompletedDate IS Not Null then t.tasktypeOrder * 1000 * 2 + 1000 Else t.tasktypeOrder * 1000 * 2 END  + 100 + t.Priority As ReturnOrder,
		CASE WHEN t.CompletedDate IS Not Null then 'C' else '' END + CAST(tasktype as varchar) As TaskType,
		PriorityChanged,
		DueDateChanged,
		TaskNameChanged,
		NewTask,
		Assignees as AssignedTo,
		Controllers,
		t.isRecurring as isRecurring,
		t.IsDaily as isDaily
	FROM
		@tasks t
		-- 02/23/2011 dalvarado
--		LEFT OUTER JOIN @priorities p
--			ON t.[id] = p.TaskID
--	WHERE
--		p.[TaskID] IS NULL

	UNION ALL
 
	-- SECTION HEADS SPECIAL (General Comments, etc)
	SELECT DISTINCT
		null as ID, 
		tt.Description,
		null as DueDate,
		null as ReminderDate,
		null as SortDate,
		null as Priority,
		null as Comments,
		null as UpdatedDate,
		'Sub Header Row' as Type,
		tt.NativeType ,
		null as IsDeleted,
		tt.DisplayOrder * 1000 * 2 As ReturnOrder,
		CAST(tt.ID As varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			--AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION HEADS SPECIAL 

	UNION ALL

	-- SECTION SPECIAL (General Comments, etc)
	SELECT DISTINCT
		st.ID * -1 as ID,  -- negative for special sections
		tt.Description,
		0 as DueDate,
		0 as ReminderDate,
		0 as SortDate,
		st.Priority as Priority,
		CAST((st.ID * -1) as varchar) As Comments,
		0 as UpdatedDate,
		tt.Description as Type,
		tt.NativeType ,
		0 as IsDeleted,
		tt.DisplayOrder * 1000 * 2 + 100 + st.Priority As ReturnOrder,
		CAST(tt.ID AS varchar) As TaskType,
		0 as PriorityChanged,
		0 as DueDateChanged,
		0 as TaskNameChanged,
		0 as NewTask,
		null as AssignedTo,
		null as Controllers,
		null as isRecurring,
		null as IsDaily
		--0 As ShowSupervisor
	FROM
		QStatus_SpecialTasks st
		INNER JOIN QStatus_TaskTypes	tt
			ON st.TaskType = tt.ID
			--AND tt.IsDeleted = 0
			AND tt.ReportID = @ReportID
			AND st.IsDeleted = 0
	--END SECTION SPECIAL 
	
	ORDER BY 
		ReturnOrder,
		SortDate asc,
		ReminderDate asc, 
		DueDate asc, 
		description, 
		NativeType asc

	SET NOCOUNT OFF
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSupervisedReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE               PROCEDURE [dbo].[QStatus_GetSupervisedReports](
	@ID INT

)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT sup.ID, r.Name, 
		dbo.QStatus_GetUserNamesFull(r.ID) as Controllers,
		dbo.QStatus_GetSupervisorNames(r.ID) as Supervisors
	FROM QStatus_Supervisors sup
	INNER JOIN QStatus_Report r
	ON sup.ReportID = r.ID
	INNER JOIN QCheck_Groups g
	ON g.ID = sup.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @ID
	WHERE r.IsDeleted = 0
	ORDER BY r.Name



	SET NOCOUNT OFF

END














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSupervisorEmailPreferences]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE       PROCEDURE [dbo].[QStatus_GetSupervisorEmailPreferences]
	@UserID INT

 AS

BEGIN

	
	SET NOCOUNT ON

	SELECT d.ID, IsNull(p.SendEmail, d.SendEmail) as SendEmail
	FROM QStatus_SupervisorEmailDefaults d
	LEFT OUTER JOIN
		QStatus_SupervisorEmailPreferences p
	ON
		p.Type = d.ID
	AND
		p.UserID = @UserID

	SET NOCOUNT OFF

END











GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSupervisorList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE                                   PROCEDURE [dbo].[QStatus_GetSupervisorList]
	@ReportID  int
AS

	SELECT Distinct g.Name as FullName From
		QCheck_Users u
	INNER JOIN 
		QStatus_SUPERVISORS S
	ON 
		S.REPORTID = @ReportID
	AND
		S.DirectSupervisor = 1
	AND
		S.InterestedParty = 0
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = s.SupervisorGroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = u.ID





GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSupervisorRole]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE	PROCEDURE [dbo].[QStatus_GetSupervisorRole]
	@UserID int,
	@ReportID int,
	@Role varchar(20) output
AS
BEGIN

	SET @Role = ""

	SELECT @Role = "InterestedParty"
	FROM QStatus_Supervisors s
	INNER JOIN QCheck_Groups g
	on g.ID = s.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	on gm.GroupID = g.ID
	and gm.UserID = @UserID
	and s.ReportID = @ReportID
	and s.InterestedParty = 1

	SELECT @Role = "Supervisor"
	FROM QStatus_Supervisors s
	INNER JOIN QCheck_Groups g
	on g.ID = s.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	on gm.GroupID = g.ID
	and gm.UserID = @UserID
	and s.ReportID = @ReportID
	and s.InterestedParty = 0
	
	
END





GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetSupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE              PROCEDURE [dbo].[QStatus_GetSupervisors]
	@ReportID int
AS
BEGIN
	SELECT DISTINCT s.ID, g.Name As Supervisor, s.InterestedParty
	From
		QCheck_Users u
	INNER JOIN 
		QStatus_SUPERVISORS S
	ON 
		S.REPORTID = @ReportID
	AND
		S.DirectSupervisor = 1
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = s.SupervisorGroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = u.ID
END






































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetTodaysComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE                                   PROCEDURE [dbo].[QStatus_GetTodaysComments]
	@ReportID int,
	@TaskID  int,
	@UserID int = null,
	@selectedComments varchar(1000) = null
AS

	
	DECLARE @CompareDt datetime

	set @CompareDt = dateadd(hour, 4, convert(datetime, convert(varchar, getdate(), 101)))

	if @CompareDt > getdate() 
		set @CompareDt = dateadd(day, -1, @CompareDt)

	--if only specific comments were requested, parse them out into a table
	DECLARE @selectedCommentsTbl TABLE (commentID int)

	IF @selectedComments IS NOT NULL
		INSERT INTO @selectedCommentsTbl
		SELECT n from dbo.Util_fn_List_To_Table(@selectedComments,',')

	DECLARE @results TABLE
	(
		ID	int,
		ForeignKeyID	int,
		Comments	varchar(1500),
		DisplayOrder	int,
		TabIn	int,
		CommentDt	datetime,
		Initials	varchar(100),
		UserID	int,
		ReplyID	int,
		SpecialTask	bit,
		TaskID	int,
		ColorNum int,
		FullName varchar(100)
	)

	INSERT INTO @results
	SELECT 
		Distinct C.*, 
		task.taskID as TaskID,
	 	CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTS C
	INNER JOIN 
	(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		c.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	WHERE
	 (
		c.ID in (SELECT ID FROM QStatus_comments where LEN(Comments)>0 AND CommentDt > @CompareDt)
			OR 
		c.ID in (SELECT ReplyID FROM QStatus_comments where LEN(Comments)>0 AND CommentDt > @CompareDt)
	)
	ORDER BY C.DisplayOrder

	IF @selectedComments IS NOT NULL
		DELETE FROM @results
		WHERE ID NOT IN (SELECT CommentID FROM @selectedCommentsTbl)

	SELECT * FROM @results


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetTodaysCommentsSubjectLine]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO










CREATE                                                 PROCEDURE [dbo].[QStatus_GetTodaysCommentsSubjectLine]
	@UserID int,
	@ReportID int,
	@Subject varchar(500) output
AS

	
	DECLARE @CompareDt datetime

	set @CompareDt = dateadd(hour, 4, convert(datetime, convert(varchar, getdate(), 101)))

	if @CompareDt > getdate() 
		set @CompareDt = dateadd(day, -1, @CompareDt)

	DECLARE @FullName varchar(50)

	SET @Subject = ''


	SELECT @FullName = u.FullName--LEFT(u.FullName, CHARINDEX(' ', u.FullName)-1)
	FROM
		QCheck_Users u
	WHERE
		u.ID = @UserID

	DECLARE @ReportName varchar(100)

	SELECT Top 1 @ReportName = dbo.QStatus_GetUserNames(r.ID) + r.name
	FROM
		QStatus_Report r
	WHERE
		r.ID = @ReportID

	SET @Subject = @Subject + @ReportName + ' Status Report'

	/*
	DECLARE @ReplyCount int

	SELECT @ReplyCount = count (distinct USERID)
	FROM
		QStatus_Comments c
	WHERE
		c.ID IN (
				SELECT ReplyID 
				FROM 
					QStatus_comments c 
				inner join 
					(
						SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
						FROM
							QStatus_ActiveChecklistTaskType actt
						inner join 
							qstatus_tasktypes tt 
						on 
							actt.tasktype = tt.ID 
						and 
							tt.ReportID = @ReportID 
						
						
						UNION
					
						SELECT 
							ST.[ID], 1 As SpecialTask
						FROM
							QStatus_SpecialTasks st
						inner join 
							qstatus_tasktypes tt 
						on 
							st.tasktype = tt.ID 
						and 
							tt.ReportID = @ReportID 
			
					) task
				ON
					task.[ID] = c.ForeignKeyID
				AND
					task.SpecialTask = c.SpecialTask	
				
				where 
					USERID = @UserID 
				AND 
					LEN(Comments)>0 
				AND 
					CommentDt > @CompareDt
			)
	AND
		USERID <> @UserID
	AND LEN(c.Comments)>0

	IF @ReplyCount = 0 BEGIN
		SET @Subject = @Subject + @FullName + '''s Comments'
	END
	ELSE BEGIN
		SET @Subject = @Subject + @FullName + '''s Reply To '
		SELECT @Subject = @Subject + innertbl.FullName + ', '--LEFT(innertbl.FullName, CHARINDEX(' ', innertbl.FullName)-1)+', '
		FROM 
		(
			SELECT DISTINCT u.FullName from
				QStatus_Comments c
			INNER JOIN
				QCheck_Users u
			ON
				c.UserID = u.ID
			WHERE
				c.ID IN (
					SELECT ReplyID FROM 
						QStatus_comments c 
					inner join 
						(
							SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
							FROM
								QStatus_ActiveChecklistTaskType actt
							inner join 
								qstatus_tasktypes tt 
							on 
								actt.tasktype = tt.ID 
							and 
								tt.ReportID = @ReportID 
							
							
							UNION
						
							SELECT 
								ST.[ID], 1 As SpecialTask
							FROM
								QStatus_SpecialTasks st
							inner join 
								qstatus_tasktypes tt 
							on 
								st.tasktype = tt.ID 
							and 
								tt.ReportID = @ReportID 
				
						) task
					ON
						task.[ID] = c.ForeignKeyID
					AND
						task.SpecialTask = c.SpecialTask	
					where 
						USERID = @UserID 
					AND 
						LEN(Comments)>0 
					AND 
						CommentDt > @CompareDt
				)
			AND
				c.USERID <> @UserID
			AND LEN(c.Comments)>0
		) innertbl
		SET @Subject = LEFT(@Subject, len(@Subject) - 1)
		
	END*/









GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetTwoWeekComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE                                             PROCEDURE [dbo].[QStatus_GetTwoWeekComments]
	@ReportID int,
	@TaskID  int,
	@all bit = 0
AS

	SET NOCOUNT ON

	DECLARE @HasRelatedComments bit
	SET  @HasRelatedComments = 0

	SELECT @HasRelatedComments = 1
	FROM 
		QStatus_COMMENTS C
	INNER JOIN
		(
			SELECT    
				ID, InstanceID
			FROM         QCheck_ActiveChecklists
			UNION ALL
			SELECT     
				ID, InstanceID
			FROM         
				QCheck_ActiveChecklistArchive 

		) AC
	ON
		C.ForeignKeyID = AC.ID
	AND
		AC.ID <> @TaskID
	INNER JOIN
		(
			SELECT    
				ID, ChecklistID
			FROM         QCheck_ChecklistInstances chkInst
			UNION ALL
			SELECT     
				ID, ChecklistID
			FROM         
				QCheck_ChecklistInstanceArchive 

		) CI
	ON
		CI.ID = AC.InstanceID
	INNER JOIN
		QCheck_ChecklistInstances CI2
	ON
		CI.ChecklistID = CI2.ChecklistID
	INNER JOIN
		QCheck_ActiveChecklists AC2
	ON
		CI2.ID = AC2.InstanceID
	AND
		AC2.ID = @TaskID

	SELECT 
		Distinct null as archiveid, C.*, null as archivedt, 
		task.TaskID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName,
		2147483647 as CommentSort
	into #CommentResult
	FROM
		QStatus_COMMENTS C with (nolock)
	INNER JOIN 

		(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		c.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	where CommentDt > GETDATE() - 14

	union all

	SELECT 
		Distinct C.*,
		task.TaskID as TaskID,
		CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName,
		C.ArchiveID as CommentSort
 
	FROM
		QStatus_COMMENTarchive C
	INNER JOIN 

		(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				(
					SELECT *, null as archivedate, 0 as deleted FROM 
						QStatus_ActiveChecklistTaskType 
					UNION
					SELECT *, 1 as deleted FROM 
						QStatus_ActiveChecklistTaskTypeArchive 
				) actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		C.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = C.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	ORDER BY CommentSort, C.DisplayOrder
	
	select * from #CommentResult
	where CommentDt > case when @all=1 then '1/1/1950' else GETDATE() - 14 end
		
	SELECT @HasRelatedComments

	select COUNT(*) from #CommentResult
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetUrgentComments]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO








CREATE                                     PROCEDURE [dbo].[QStatus_GetUrgentComments]
	@ReportID int,
	@TaskID  int,
	@UserID int = null
AS
	DECLARE @CommentID int

	SELECT top 1 @CommentID = c.ID
	FROM QStatus_comments c 
	inner join 
		(
			SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
			FROM
				QStatus_ActiveChecklistTaskType actt
			inner join 
				qstatus_tasktypes tt 
			on 
				actt.tasktype = tt.ID 
			and 
				tt.ReportID = @ReportID 
			
			
			UNION
		
			SELECT 
				ST.[ID], 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			inner join 
				qstatus_tasktypes tt 
			on 
				st.tasktype = tt.ID 
			and 
				tt.ReportID = @ReportID 

		) task
	ON
		task.[ID] = c.ForeignKeyID
	AND
		task.SpecialTask = c.SpecialTask	
	AND
		USERID = @UserID 
	AND 
		LEN(Comments)>0 
	ORDER BY CommentDt desc

	SELECT 
		Distinct C.*, 
		task.taskID as TaskID,
	 	CASE WHEN gr.USERID IS NOT NULL THEN 
			0 --red
		ELSE
			CASE WHEN supcolor.colorNum is not null THEN
				supcolor.colorNum
			ELSE
				CASE WHEN sup.interestedParty = 0 THEN
					3 --green
				ELSE
					50 --purple
				END
			END
		END as colornum, 
		u.FullName
	FROM
		QStatus_COMMENTS C
	INNER JOIN 
	(
			SELECT actt.ActiveChecklistID as taskID, actt.ActiveChecklistID as [ID], actt.TaskType, 0 As SpecialTask
			FROM
				(SELECT *, null as archivedate FROM QCheck_ActiveChecklists 
				where ID = @TaskID
				union all
				select * FROM QCheck_ActiveChecklistArchive 
				where ID = @TaskID)
				T
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.ActiveChecklistID = t.ID
			
			
			UNION
		
			SELECT 
				-1 * ST.ID As taskID, ST.ID, ST.TaskType, 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			WHERE
				ST.ID = ABS(@TaskID)	
			AND
				@TaskID < 0
		) task
	ON
		task.SpecialTask = c.SpecialTask
	AND
		c.ForeignKeyID = task.[ID]
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		task.TaskType = tt.ID
	AND
		tt.ReportID = @ReportID
	INNER JOIN 
		QCheck_Users u
	ON
		u.ID = C.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID, s.InterestedParty
		FROM QStatus_SUPERVISORS s
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = s.supervisorGroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND s.ReportID = @ReportID
	) sup
	ON sup.UserId = c.UserID
	LEFT OUTER JOIN 
		(SELECT gm.UserID
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = gr.GroupID
		INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
		AND gr.ReportID = @ReportID
	) gr
	ON gr.UserId = c.UserID
	LEFT OUTER JOIN
		QStatus_SupervisorColors supcolor
	ON
		supcolor.supervisorUserID = u.ID
	
	WHERE
	 (
		c.ID = @CommentID
			OR 
		c.ID in (SELECT ReplyID FROM QStatus_comments where ID = @CommentID)
	)
	ORDER BY C.DisplayOrder














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetUrgentCommentsSubjectLine]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QStatus_GetUrgentCommentsSubjectLine]
	@UserID int,
	@ReportID int,
	@Subject varchar(500) output
AS
	DECLARE @FullName varchar(50)

	SET @Subject = 'RESPONSE REQUESTED - '


	SELECT @FullName = u.FullName--LEFT(u.FullName, CHARINDEX(' ', u.FullName)-1)
	FROM
		QCheck_Users u
	WHERE
		u.ID = @UserID

	DECLARE @ReportName varchar(100)

	SELECT Top 1 @ReportName = dbo.QStatus_GetUserNames(r.ID) + r.name
	FROM
		QCheck_Users u
		INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.UserID = u.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.GroupID = g.ID
	AND
		gr.ReportID = @ReportID
	INNER JOIN
		QStatus_Report r
	ON
		r.ID = gr.ReportID

	-- 10/14/2014 dalvarado - The above query doesn't really make sense, it's basically saying you can only pull
	-- the report name if you're a controller of the report, which can cause this function to come up with no
	-- subject line.  You can do a Response Requested from the My Inbox tab as well, so just pulling the report
	-- name from QStatus_Report makes more sense.  Using IS NULL just in case I'm wrong about how this is used.
	IF @ReportName IS NULL SELECT @ReportName = Name FROM QStatus_Report WHERE ID = @ReportID
	
	SET @Subject = @Subject + @ReportName + ' Status Report - '

	DECLARE @CommentID int

	SELECT top 1 @CommentID = c.ID
	FROM QStatus_comments c 
	inner join 
		(
			SELECT actt.ActiveChecklistID as [ID], 0 As SpecialTask
			FROM
				QStatus_ActiveChecklistTaskType actt
			inner join 
				qstatus_tasktypes tt 
			on 
				actt.tasktype = tt.ID 
			and 
				tt.ReportID = @ReportID 
			
			
			UNION
		
			SELECT 
				ST.[ID], 1 As SpecialTask
			FROM
				QStatus_SpecialTasks st
			inner join 
				qstatus_tasktypes tt 
			on 
				st.tasktype = tt.ID 
			and 
				tt.ReportID = @ReportID 

		) task
	ON
		task.[ID] = c.ForeignKeyID
	AND
		task.SpecialTask = c.SpecialTask	
	AND
		USERID = @UserID 
	AND 
		LEN(Comments)>0 
	ORDER BY CommentDt desc

	DECLARE @ReplyCount int

	SELECT @ReplyCount = count (distinct USERID)
	FROM
		QStatus_Comments c
	WHERE
		c.ID IN (
				SELECT ReplyID 
				FROM 
					QStatus_comments c 
				where 
					ID = 	@CommentID				
			)
	AND
		USERID <> @UserID
	AND LEN(c.Comments)>0

	IF @ReplyCount = 0 BEGIN
		SET @Subject = @Subject + @FullName + '''s Comments'
	END
	ELSE BEGIN
		SET @Subject = @Subject + @FullName + '''s Reply To '
		SELECT @Subject = @Subject + innertbl.FullName--LEFT(innertbl.FullName, CHARINDEX(' ', innertbl.FullName)-1)+', '
		FROM 
		(
			SELECT DISTINCT u.FullName from
				QStatus_Comments c
			INNER JOIN
				QCheck_Users u
			ON
				c.UserID = u.ID
			WHERE
				c.ID IN (
					SELECT ReplyID FROM 
						QStatus_comments c 
					where 
					ID = 	@CommentID	
				)
			AND
				c.USERID <> @UserID
			AND LEN(c.Comments)>0
		) innertbl
		--SET @Subject = LEFT(@Subject, len(@Subject) - 1)
		
	END















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetUserList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO








CREATE                                  PROCEDURE [dbo].[QStatus_GetUserList]
	@ReportID  int
AS

	SELECT Distinct  g.Name as FullName From
		QCheck_Users u
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.UserID = u.ID
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = gm.GroupID
	INNER JOIN
		QStatus_GroupReport gr
	ON
		gr.GroupID = g.ID
	AND
		gr.ReportID = @ReportID
	






GO
/****** Object:  StoredProcedure [dbo].[QStatus_GetUserReports]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE               PROCEDURE [dbo].[QStatus_GetUserReports](
	@ID INT

)
 AS

BEGIN

	SET NOCOUNT ON
	
	SELECT gr.ID, r.Name, 
		dbo.QStatus_GetUserNamesFull(r.ID) as Controllers,
		dbo.QStatus_GetSupervisorNames(r.ID) as Supervisors
	FROM QStatus_GroupReport gr
	INNER JOIN QStatus_Report r
	ON r.ID = gr.ReportID
	INNER JOIN QCheck_Groups g
	ON gr.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @ID
	AND r.IsDeleted = 0
	ORDER BY r.Name



	SET NOCOUNT OFF

END














































GO
/****** Object:  StoredProcedure [dbo].[QStatus_GlobalSearch]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QStatus_GlobalSearch] 
	@userIDs varchar(4000),	-- separated by commas or leave blank
	@criteria varchar(4000),-- can be blank
	@logicAndOr bit,		-- 1 = AND, 0 = OR
	@userId int
as
begin
	--declare @userIDs varchar(4000) = '471'	-- separated by commas or leave blank
	--declare @criteria varchar(4000) = 'nnn'	-- can be blank
	--declare @logicAndOr bit = 0				-- 1 = AND, 0 = OR
	--declare @userId int = 471

	-- if not admin, then lock user into only viewing items they are/were assignee/controller
	declare @isAdmin bit = 0, @loginId int = 0, @needTruncating bit = 0, @count int = 0
	select 
		@isAdmin = [admin], @loginId = ID
	from 
		QCheck_Users with (nolock)
	where 
		IsDeleted = 0 and ID = @userId

	if @isAdmin <> 1
		set @userIDs = cast(@loginId as varchar)

	-- clean up resources
	if object_id('tempdb..#grp', 'U') is not null
		drop table #grp

	if object_id('tempdb..#checklist', 'U') is not null
		drop table #checklist

	-- variable declaration
	create table #grp (Id int)
	create table #checklist (Id int, Archive bit)

	declare @cmd varchar(max) = '',
			@exec varchar(max) = '',
			@first bit = null,
			@word varchar(255) = '',
			@contain varchar(max) = ''

	-- build criteria string
	declare oCursor cursor for
		select Data from dbo.Util_Split(@criteria,' ')

	open oCursor
	fetch next from oCursor into @word
	while @@FETCH_STATUS = 0 begin
		set @word = REPLACE(@word, '''', '''''')

		if @first is null
			begin
				set @first = 0
				set @cmd = @cmd + ' [Name] like ''%' + @word + '%'''
				set @contain = @contain + ' contains(Comments, ''' + @word + ''')'
			end
		else
			begin
				if @logicAndOr = 0
					begin
						set @cmd = @cmd + ' or [Name] like ''%' + @word + '%'''
						set @contain = @contain + ' or contains(Comments, ''' + @word + ''')'
					end
				else
					begin
						set @cmd = @cmd + ' and [Name] like ''%' + @word + '%'''
						set @contain = @contain + ' and contains(Comments, ''' + @word + ''')'
					end
			end
		
		fetch next from oCursor into @word
	end
	close oCursor
	deallocate oCursor

	-- filter out matches by IDs
	if @userIDs = ''
		begin
			insert into #grp
				select ID from QCheck_Groups
				union all
				select ID from QCheck_GroupArchive
		end
	else
		begin
			insert into #grp
				select 
					GroupID
				from 
					QCheck_GroupChanges with (nolock) 
				where 
					UserID in (select Data from dbo.Util_split(@userIDs, ','))
				union 
				select
					ID
				from
					QCheck_Groups with (nolock) 
				where 
					[Owner] in (select Data from dbo.Util_split(@userIDs, ','))

		end

	if @criteria <> ''
		begin
			set @exec = 'insert into #checklist select ID, 0 from QCheck_Checklists with (nolock) where' + @cmd; exec(@exec)
			set @exec = 'insert into #checklist select ID, 1 from QCheck_ChecklistArchive with (nolock) where' + @cmd; exec(@exec)
			set @exec = 'insert into #checklist select ChecklistID, 0 from QCheck_Items with (nolock) where' + replace(@cmd, '[Name]', '[Text]'); exec(@exec)
			set @exec = 'insert into #checklist select ChecklistID, 1 from QCheck_ItemArchive with (nolock) where' + replace(@cmd, '[Name]', '[Text]'); exec(@exec)
			set @exec = 'insert into #checklist select aa.ChecklistID, 0 from QStatus_Comments c with (nolock) inner join QCheck_ActiveChecklists a with (nolock) on a.ID = c.ForeignKeyID inner join QCheck_ChecklistInstances aa with (nolock) on aa.ID = a.InstanceID where specialtask=0 and (' + replace(@cmd, '[Name]', '[Comments]') + ')'; exec(@exec)
			set @exec = 'insert into #checklist select aa.ChecklistID, 1 from QStatus_CommentArchive c with (nolock) inner join QCheck_ActiveChecklistArchive a with (nolock) on a.ID = c.ForeignKeyID inner join QCheck_ChecklistInstanceArchive aa with (nolock) on aa.ID = a.InstanceID where specialtask=0 and (' + @contain + ')'; exec(@exec)
		end

	-- get result
	if @criteria = ''
		begin
			select 
				@count = count(*)
			from 
				QCheck_Assignments a with (nolock) 
			inner join
				QCheck_ChecklistInstances i with (nolock) on a.InstanceID = i.ID
			inner join
				QCheck_ActiveChecklists aa with (nolock) on i.ID = aa.InstanceID
			inner join
				QCheck_Checklists c with (nolock) on i.ChecklistID = c.ID
			left outer join 
				QCheck_ChecklistManagers cm with (nolock) on cm.ChecklistID = c.ID
			where 
				(
					--assigned or controlled
					a.GroupID in (select Id from #grp) 
					or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
				)

			if @count > 100
				set @needTruncating = 1

			select 
				@count = count(*)
			from 
				QCheck_AssignmentArchive a with (nolock)
			inner join
				QCheck_ChecklistInstanceArchive i with (nolock) on a.InstanceID = i.ID 
			inner join
				QCheck_ActiveChecklistArchive aa with (nolock) on i.ID = aa.InstanceID
			inner join
				QCheck_ChecklistArchive c with (nolock) on i.ChecklistID = c.ID
			left outer join 
				QCheck_ChecklistManagerArchive cm with (nolock) on cm.ChecklistID = c.ID
			where 
				(
					--assigned or controlled
					a.GroupID in (select Id from #grp) 
					or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
				)

			if @count > 100
				set @needTruncating = 1


			select
				r.*,
				convert(varchar, aa.CompletedDate, 101) as CompletedDate,
				isnull(ccl.controllers, '') as Controllers,
				dbo.Util_StripHTML(replace(isnull((select top 1 ReportsList from QStatus_TaskReportList where ActiveChecklistID = aa.ID), ''),'Status Reports: ','')) as StatusReport,
				isnull(al.assignees,'') as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					0 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleString(i.ScheduleID) AS ScheduleString
				from 
					QCheck_Assignments a with (nolock) 
				inner join
					QCheck_ChecklistInstances i with (nolock) on a.InstanceID = i.ID
				inner join
					QCheck_ActiveChecklists aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_Checklists c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagers cm with (nolock) on cm.ChecklistID = c.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
			) r
			left outer join 
				QCheck_ChecklistInstances i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstances with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklists aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklists with (nolock) where InstanceID = i.ID)
		    left outer join 
				QCheck_ChecklistControllersList ccl on ccl.checklistid = r.ChecklistID
			left outer join 
				QCheck_AssigneeLookup AL on aa.InstanceID = al.InstanceID
			left outer join
				QStatus_Comments ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_Items it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_Items with (nolock) where ChecklistID = r.ChecklistID)
			
			union all 
			
			select
				r.*
				,
				convert(varchar, aa.CompletedDate, 101) as CompletedDate,
				dbo.QStatus_GetChecklistControllerArchive(i.ChecklistID) as Controllers,
				replace(isnull(dbo.QStatus_GetChecklistReportArchive(aa.ID),''),'Status Reports: ','') as StatusReport,
				dbo.QCheck_FullAssigneesListArchive(i.ID) as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.Text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					1 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleStringArchive(i.ScheduleID) AS ScheduleString
				from 
					QCheck_AssignmentArchive a with (nolock)
				inner join
					QCheck_ChecklistInstanceArchive i with (nolock) on a.InstanceID = i.ID 
				inner join
					QCheck_ActiveChecklistArchive aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_ChecklistArchive c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagerArchive cm with (nolock) on cm.ChecklistID = c.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
			) r
			left outer join 
				QCheck_ChecklistInstanceArchive i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstanceArchive with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklistArchive aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklistArchive with (nolock) where InstanceID = i.ID)
			left outer join
				QStatus_CommentArchive ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_ItemArchive it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_ItemArchive with (nolock) where ChecklistID = r.ChecklistID)
		end
	else
		begin
			select 
				@count = count(*)
			from 
				QCheck_Assignments a with (nolock) 
			inner join
				QCheck_ChecklistInstances i with (nolock) on a.InstanceID = i.ID
			inner join
				QCheck_ActiveChecklists aa with (nolock) on i.ID = aa.InstanceID
			inner join
				QCheck_Checklists c with (nolock) on i.ChecklistID = c.ID
			left outer join 
				QCheck_ChecklistManagers cm with (nolock) on cm.ChecklistID = c.ID
			where 
				(
					--assigned or controlled
					a.GroupID in (select Id from #grp) 
					or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
				)
				and 
				c.id in (select distinct Id from #checklist where Archive = 0)

			if @count > 100
				set @needTruncating = 1

			select 
				@count = count(*)
			from 
				QCheck_AssignmentArchive a with (nolock)
			inner join
				QCheck_ChecklistInstanceArchive i with (nolock) on a.InstanceID = i.ID 
			inner join
				QCheck_ActiveChecklistArchive aa with (nolock) on i.ID = aa.InstanceID
			inner join
				QCheck_ChecklistArchive c with (nolock) on i.ChecklistID = c.ID
			left outer join 
				QCheck_ChecklistManagerArchive cm with (nolock) on cm.ChecklistID = c.ID
			where 
				(
					--assigned or controlled
					a.GroupID in (select Id from #grp) 
					or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
				)
				and c.id in (select distinct Id from #checklist where Archive = 1)

			if @count > 100
				set @needTruncating = 1

			select
				r.*,
				convert(varchar, aa.CompletedDate, 100) as CompletedDate,
				isnull(ccl.controllers, '') as Controllers,
				dbo.Util_StripHTML(replace(isnull((select top 1 ReportsList from QStatus_TaskReportList where ActiveChecklistID = aa.ID), ''),'Status Reports: ','')) as StatusReport,
				isnull(al.assignees,'') as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.Text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					0 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleString(i.ScheduleID) AS ScheduleString
				from 
					QCheck_Assignments a with (nolock) 
				inner join
					QCheck_ChecklistInstances i with (nolock) on a.InstanceID = i.ID
				inner join
					QCheck_ActiveChecklists aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_Checklists c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagers cm with (nolock) on cm.ChecklistID = c.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
					and 
					c.id in (select distinct Id from #checklist where Archive = 0)
			) r
			left outer join 
				QCheck_ChecklistInstances i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstances with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklists aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklists with (nolock) where InstanceID = i.ID)
		    left outer join 
				QCheck_ChecklistControllersList ccl on ccl.checklistid = r.ChecklistID
			left outer join 
				QCheck_AssigneeLookup AL on aa.InstanceID = al.InstanceID
			left outer join
				QStatus_Comments ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_Items it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_Items with (nolock) where ChecklistID = r.ChecklistID)
			
			union all 
			
			select
				r.*
				,
				convert(varchar, aa.CompletedDate, 100) as CompletedDate,
				dbo.QStatus_GetChecklistControllerArchive(i.ChecklistID) as Controllers,
				replace(isnull(dbo.QStatus_GetChecklistReportArchive(aa.ID),''),'Status Reports: ','') as StatusReport,
				dbo.QCheck_FullAssigneesListArchive(i.ID) as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.Text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					1 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleStringArchive(i.ScheduleID) AS ScheduleString
				from 
					QCheck_AssignmentArchive a with (nolock)
				inner join
					QCheck_ChecklistInstanceArchive i with (nolock) on a.InstanceID = i.ID 
				inner join
					QCheck_ActiveChecklistArchive aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_ChecklistArchive c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagerArchive cm with (nolock) on cm.ChecklistID = c.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
					and c.id in (select distinct Id from #checklist where Archive = 1)
			) r
			left outer join 
				QCheck_ChecklistInstanceArchive i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstanceArchive with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklistArchive aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklistArchive with (nolock) where InstanceID = i.ID)
			left outer join
				QStatus_CommentArchive ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_ItemArchive it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_ItemArchive with (nolock) where ChecklistID = r.ChecklistID)
		end

	select @needTruncating
end
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GlobalSearchOld]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[QStatus_GlobalSearchOld] 
	@userIDs varchar(4000),	-- separated by commas or leave blank
	@criteria varchar(4000),-- can be blank
	@logicAndOr bit,		-- 1 = AND, 0 = OR
	@userId int
as
begin
	--declare @userIDs varchar(4000) = '471'	-- separated by commas or leave blank
	--declare @criteria varchar(4000) = 'nnn'	-- can be blank
	--declare @logicAndOr bit = 0				-- 1 = AND, 0 = OR
	--declare @user varchar(255) = ''

	-- if not admin, then lock user into only viewing items they are/were assignee/controller
	declare @isAdmin bit = 0, @loginId int = 0
	select 
		@isAdmin = [admin], @loginId = ID
	from 
		QCheck_Users with (nolock)
	where 
		IsDeleted = 0 and ID = @userId

	if @isAdmin <> 1
		set @userIDs = cast(@loginId as varchar)

	-- clean up resources
	if object_id('tempdb..#grp', 'U') is not null
		drop table #grp

	if object_id('tempdb..#checklist', 'U') is not null
		drop table #checklist

	-- variable declaration
	create table #grp (Id int)
	create table #checklist (Id int, Archive bit)

	declare @cmd varchar(max) = '',
			@exec varchar(max) = '',
			@first bit = null,
			@word varchar(255) = '',
			@contain varchar(max) = ''

	-- build criteria string
	declare oCursor cursor for
		select Data from dbo.Util_Split(@criteria,' ')

	open oCursor
	fetch next from oCursor into @word
	while @@FETCH_STATUS = 0 begin
		set @word = REPLACE(@word, '''', '''''')

		if @first is null
			begin
				set @first = 0
				set @cmd = @cmd + ' [Name] like ''%' + @word + '%'''
				set @contain = @contain + ' contains(Comments, ''' + @word + ''')'
			end
		else
			begin
				if @logicAndOr = 0
					begin
						set @cmd = @cmd + ' or [Name] like ''%' + @word + '%'''
						set @contain = @contain + ' or contains(Comments, ''' + @word + ''')'
					end
				else
					begin
						set @cmd = @cmd + ' and [Name] like ''%' + @word + '%'''
						set @contain = @contain + ' and contains(Comments, ''' + @word + ''')'
					end
			end
		
		fetch next from oCursor into @word
	end
	close oCursor
	deallocate oCursor

	-- filter out matches by IDs
	if @userIDs = ''
		begin
			insert into #grp
				select ID from QCheck_Groups
				union all
				select ID from QCheck_GroupArchive
		end
	else
		begin
			insert into #grp
				select 
					GroupID
				from 
					QCheck_GroupChanges with (nolock) 
				where 
					UserID in (select Data from dbo.Util_split(@userIDs, ','))
				union 
				select
					ID
				from
					QCheck_Groups with (nolock) 
				where 
					[Owner] in (select Data from dbo.Util_split(@userIDs, ','))

		end

	if @criteria <> ''
		begin
			set @exec = 'insert into #checklist select ID, 0 from QCheck_Checklists with (nolock) where' + @cmd; exec(@exec)
			set @exec = 'insert into #checklist select ID, 1 from QCheck_ChecklistArchive with (nolock) where' + @cmd; exec(@exec)
			set @exec = 'insert into #checklist select ChecklistID, 0 from QCheck_Items with (nolock) where' + replace(@cmd, '[Name]', '[Text]'); exec(@exec)
			set @exec = 'insert into #checklist select ChecklistID, 1 from QCheck_ItemArchive with (nolock) where' + replace(@cmd, '[Name]', '[Text]'); exec(@exec)
			set @exec = 'insert into #checklist select aa.ChecklistID, 0 from QStatus_Comments c with (nolock) inner join QCheck_ActiveChecklists a with (nolock) on a.ID = c.ForeignKeyID inner join QCheck_ChecklistInstances aa with (nolock) on aa.ID = a.InstanceID where specialtask=0 and (' + replace(@cmd, '[Name]', '[Comments]') + ')'; exec(@exec)
			set @exec = 'insert into #checklist select aa.ChecklistID, 1 from QStatus_CommentArchive c with (nolock) inner join QCheck_ActiveChecklistArchive a with (nolock) on a.ID = c.ForeignKeyID inner join QCheck_ChecklistInstanceArchive aa with (nolock) on aa.ID = a.InstanceID where specialtask=0 and (' + @contain + ')'; exec(@exec)
		end

	-- get result
	if @criteria = ''
		begin
			select
				r.*,
				convert(varchar, aa.CompletedDate, 101) as CompletedDate,
				isnull(ccl.controllers, '') as Controllers,
				dbo.Util_StripHTML(replace(isnull((select top 1 ReportsList from QStatus_TaskReportList where ActiveChecklistID = aa.ID), ''),'Status Reports: ','')) as StatusReport,
				isnull(al.assignees,'') as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					0 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleString(i.ScheduleID) AS ScheduleString
					--CASE WHEN s.freqType = 1 THEN 'One Time' 
					--	 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
					--	 WHEN s.freqType = 3 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Weekly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					--			END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' months' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				--		 WHEN s.freqType = 5 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Yearly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					--			END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
					--	ELSE '' END as ScheduleString
				from 
					QCheck_Assignments a with (nolock) 
				inner join
					QCheck_ChecklistInstances i with (nolock) on a.InstanceID = i.ID
				inner join
					QCheck_ActiveChecklists aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_Checklists c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagers cm with (nolock) on cm.ChecklistID = c.ID
				--inner join
				--	QCheck_Schedule s with (nolock) on i.ScheduleID = s.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
					and 
					c.id in (select distinct Id from #checklist where Archive = 0)
					
			) r
			left outer join 
				QCheck_ChecklistInstances i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstances with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklists aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklists with (nolock) where InstanceID = i.ID)
		    left outer join 
				QCheck_ChecklistControllersList ccl on ccl.checklistid = r.ChecklistID
			left outer join 
				QCheck_AssigneeLookup AL on aa.InstanceID = al.InstanceID
			left outer join
				QStatus_Comments ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_Items it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_Items with (nolock) where ChecklistID = r.ChecklistID)
			
			union all 
			
			select
				r.*
				,
				convert(varchar, aa.CompletedDate, 101) as CompletedDate,
				dbo.QStatus_GetChecklistControllerArchive(i.ChecklistID) as Controllers,
				replace(isnull(dbo.QStatus_GetChecklistReportArchive(aa.ID),''),'Status Reports: ','') as StatusReport,
				dbo.QCheck_FullAssigneesListArchive(i.ID) as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.Text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					1 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleStringArchive(i.ScheduleID) AS ScheduleString
					--CASE WHEN s.freqType = 1 THEN 'One Time' 
					--	 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
					--	 WHEN s.freqType = 3 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Weekly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					--			END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' months' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				--		 WHEN s.freqType = 5 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Yearly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					--			END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
					--	ELSE '' END as ScheduleString
				from 
					QCheck_AssignmentArchive a with (nolock)
				inner join
					QCheck_ChecklistInstanceArchive i with (nolock) on a.InstanceID = i.ID 
				inner join
					QCheck_ActiveChecklistArchive aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_ChecklistArchive c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagerArchive cm with (nolock) on cm.ChecklistID = c.ID
				--inner join
				--	QCheck_ScheduleArchive s with (nolock) on i.ScheduleID = s.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
			) r
			left outer join 
				QCheck_ChecklistInstanceArchive i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstanceArchive with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklistArchive aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklistArchive with (nolock) where InstanceID = i.ID)
			left outer join
				QStatus_CommentArchive ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_ItemArchive it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_ItemArchive with (nolock) where ChecklistID = r.ChecklistID)
		end
	else
		begin
			select
				r.*,
				convert(varchar, aa.CompletedDate, 100) as CompletedDate,
				isnull(ccl.controllers, '') as Controllers,
				dbo.Util_StripHTML(replace(isnull((select top 1 ReportsList from QStatus_TaskReportList where ActiveChecklistID = aa.ID), ''),'Status Reports: ','')) as StatusReport,
				isnull(al.assignees,'') as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.Text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					0 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleString(i.ScheduleID) AS ScheduleString
					--CASE WHEN s.freqType = 1 THEN 'One Time' 
					--	 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
					--	 WHEN s.freqType = 3 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Weekly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					--			END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' months' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				--		 WHEN s.freqType = 5 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Yearly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					--			END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
					--	ELSE '' END as ScheduleString
				from 
					QCheck_Assignments a with (nolock) 
				inner join
					QCheck_ChecklistInstances i with (nolock) on a.InstanceID = i.ID
				inner join
					QCheck_ActiveChecklists aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_Checklists c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagers cm with (nolock) on cm.ChecklistID = c.ID
				--inner join
				--	QCheck_Schedule s with (nolock) on i.ScheduleID = s.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
					and 
					c.id in (select distinct Id from #checklist where Archive = 0)
			) r
			left outer join 
				QCheck_ChecklistInstances i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstances with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklists aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklists with (nolock) where InstanceID = i.ID)
		    left outer join 
				QCheck_ChecklistControllersList ccl on ccl.checklistid = r.ChecklistID
			left outer join 
				QCheck_AssigneeLookup AL on aa.InstanceID = al.InstanceID
			left outer join
				QStatus_Comments ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_Items it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_Items with (nolock) where ChecklistID = r.ChecklistID)
			
			union all 
			
			select
				r.*
				,
				convert(varchar, aa.CompletedDate, 100) as CompletedDate,
				dbo.QStatus_GetChecklistControllerArchive(i.ChecklistID) as Controllers,
				replace(isnull(dbo.QStatus_GetChecklistReportArchive(aa.ID),''),'Status Reports: ','') as StatusReport,
				dbo.QCheck_FullAssigneesListArchive(i.ID) as Assignees,
				'[' + convert(varchar, ct.CommentDt, 101) + '] [' + ct.Initials + '] ' + ct.Comments as Comments,
				it.Text as ItemText
			from (
				select distinct top 100
					i.ChecklistID,
					a.IsDeleted,
					1 as Archived,
					c.Name as Task,
					dbo.QCheck_ScheduleStringArchive(i.ScheduleID) AS ScheduleString
					--CASE WHEN s.freqType = 1 THEN 'One Time' 
					--	 WHEN s.freqType = 2 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Daily' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' days' END 
					--	 WHEN s.freqType = 3 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Weekly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' weeks' 
					--			END + CASE WHEN s.freqInterval > 0 THEN ' on ' + dbo.QCheck_GetDaysFromInterval(s.freqInterval) ELSE '' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance <> 3 THEN CASE WHEN s.freqRecurrance = 1 THEN 'Monthly' ELSE 'Every ' + CONVERT(varchar,s.freqRecurrance) + ' months' END
					--	 WHEN s.freqType = 4 and  s.freqRecurrance = 3 THEN 'Quarterly'  
 				--		 WHEN s.freqType = 5 THEN 
					--			CASE WHEN s.freqRecurrance = 1 THEN 
					--					'Yearly' 
					--			ELSE 
					--					'Every ' + CONVERT(varchar,s.freqRecurrance) + ' years'  
					--			END + CASE WHEN s.freqInterval > 0 THEN ' in ' + dbo.QCheck_GetMonthsFromInterval(s.freqInterval) ELSE '' END
					--	ELSE '' END as ScheduleString
				from 
					QCheck_AssignmentArchive a with (nolock)
				inner join
					QCheck_ChecklistInstanceArchive i with (nolock) on a.InstanceID = i.ID 
				inner join
					QCheck_ActiveChecklistArchive aa with (nolock) on i.ID = aa.InstanceID
				inner join
					QCheck_ChecklistArchive c with (nolock) on i.ChecklistID = c.ID
				left outer join 
					QCheck_ChecklistManagerArchive cm with (nolock) on cm.ChecklistID = c.ID
				--inner join
				--	QCheck_ScheduleArchive s with (nolock) on i.ScheduleID = s.ID
				where 
					(
						--assigned or controlled
						a.GroupID in (select Id from #grp) 
						or isnull(cm.ManagerGroupID, 0) in (select Id from #grp)
					)
					
					and c.id in (select distinct Id from #checklist where Archive = 1)
			) r
			left outer join 
				QCheck_ChecklistInstanceArchive i with (nolock) on i.ID = 
				(select max(ID) from QCheck_ChecklistInstanceArchive with (nolock) where ChecklistID = r.ChecklistID)
			left outer join 
				QCheck_ActiveChecklistArchive aa with (nolock) on aa.ID =
				(select max(ID) from QCheck_ActiveChecklistArchive with (nolock) where InstanceID = i.ID)
			left outer join
				QStatus_CommentArchive ct on ct.ForeignKeyID = aa.ID and ct.DisplayOrder = 1
			left outer join
				QCheck_ItemArchive it with (nolock)  on it.ID = 
				(select min(ID) from QCheck_ItemArchive with (nolock) where ChecklistID = r.ChecklistID)
		end
end
GO
/****** Object:  StoredProcedure [dbo].[QStatus_GPR_IT_Priorities]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  proc [dbo].[QStatus_GPR_IT_Priorities]
AS
BEGIN

declare @instanceid int, @activechecklistid int, @tasktype int, @priority int, @userID int, @reportid int
set @tasktype = 1110414
set @userid = 50
set @reportid = 1100996

DECLARE @NewTaskTypeID int


DECLARE ACCURS CURSOR
		FOR 
	
select actt.activechecklistid 
from qstatus_activechecklisttasktype actt
inner join qcheck_activechecklists ac
	on ac.id = actt.activechecklistid
	and ac.completeddate is null
where tasktype in (1110414)
	
	OPEN ACCURS

	FETCH NEXT FROM ACCURS INTO @activechecklistid
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		exec QCheck_RemoveFromReport @activechecklistid, @reportid, 50

		

		FETCH NEXT FROM ACCURS INTO @activechecklistid
	END
	CLOSE ACCURS
	DEALLOCATE ACCURS


DECLARE PRCURS CURSOR
		FOR 
	
select distinct ac.id, ac.instanceid, p.priority from prioritylist p
inner join qcheck_activechecklists ac
on p.activechecklistid = ac.id
where userid = @userid
and p.priority > 0
	
	
	OPEN PRCURS

	FETCH NEXT FROM PRCURS INTO @activechecklistid, @instanceid, @priority
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		set @NewTaskTypeID = null
		
		EXEC QCheck_AddInstanceTaskType @InstanceID, @tasktype, @priority, @NewTaskTypeID OUTPUT
		
		FETCH NEXT FROM PRCURS INTO @activechecklistid, @instanceid, @priority
	END
	CLOSE PRCURS
	DEALLOCATE PRCURS

set @tasktype = 1107038
set @userid = 59


DECLARE PRCURS CURSOR
		FOR 
	
select distinct ac.id, ac.instanceid, p.priority from prioritylist p
inner join qcheck_activechecklists ac
on p.activechecklistid = ac.id
where userid = @userid
and p.priority > 0
	
	
	OPEN PRCURS

	FETCH NEXT FROM PRCURS  INTO @activechecklistid, @instanceid, @priority
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		
			set @NewTaskTypeID = null
			EXEC QCheck_AddInstanceTaskType @InstanceID, @tasktype, @priority, @NewTaskTypeID OUTPUT
		
		

		FETCH NEXT FROM PRCURS  INTO @activechecklistid, @instanceid, @priority
	END
	CLOSE PRCURS
	DEALLOCATE PRCURS

update qstatus_report set isdirty = 1
where id = @reportid

END


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GPR_IT_Priorities_Shortterm]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  proc [dbo].[QStatus_GPR_IT_Priorities_Shortterm]
(
	@tasktype int,
	@userid int,
	@reportID int
	)
AS
BEGIN

declare @instanceid int, @activechecklistid int,  @priority int 

DECLARE @NewTaskTypeID int
--set @tasktype = 1112536
--set @userid = 50
--set @reportid = 1101317



DECLARE ACCURS CURSOR
		FOR 
	
select activechecklistid from qstatus_activechecklisttasktype
where tasktype = @tasktype
	
	
	OPEN ACCURS

	FETCH NEXT FROM ACCURS INTO @activechecklistid
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		exec QCheck_RemoveFromReport @activechecklistid, @reportid, 50

		

		FETCH NEXT FROM ACCURS INTO @activechecklistid
	END
	CLOSE ACCURS
	DEALLOCATE ACCURS



DECLARE PRCURS CURSOR
		FOR 
	
select distinct ac.id, ac.instanceid, p.priority from prioritylist p
inner join qcheck_activechecklists ac
on p.activechecklistid = ac.id
where userid = @userid
and p.priority > 0
	
	
	OPEN PRCURS

	FETCH NEXT FROM PRCURS INTO @activechecklistid, @instanceid, @priority
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		set @NewTaskTypeID= null
		EXEC QCheck_AddInstanceTaskType @InstanceID, @tasktype, @priority, @NewTaskTypeID OUTPUT
		
		FETCH NEXT FROM PRCURS INTO @activechecklistid, @instanceid, @priority
	END
	CLOSE PRCURS
	DEALLOCATE PRCURS

update qstatus_report set isdirty = 1
where id = @reportid

END


GO
/****** Object:  StoredProcedure [dbo].[QStatus_GroupsSupervisedByLogin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QStatus_GroupsSupervisedByLogin] (
	@Login VARCHAR(50),
	@PeopleOnly BIT = 0
) AS

BEGIN

	DECLARE @SupervisorUserID INT,
		@impersonateID int,
		@origID int

	SELECT @origID=[ID] 
	FROM QCheck_Users
	WHERE ShortName = @Login

	SELECT @impersonateID = impersonateUserID
	FROM QCheck_Impersonate
	WHERE UserID = @origID AND isDeleted = 0

	SELECT @SupervisorUserID = isNull(@impersonateID, @origID)
	
	SELECT DISTINCT
		g.[ID],
		g.[Name]
	FROM
		QStatus_UserSupervisors us
		INNER JOIN QCheck_Users u
			ON us.UserID = u.[ID]
		INNER JOIN QCheck_GroupMembership gm
			ON us.UserID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.[ID]
	WHERE
		us.SupervisorUserID = @SupervisorUserID
		AND u.IsDeleted = 0
		AND (
			g.SingleMemberGroup = 1
			OR @PeopleOnly = 0
		)

	UNION

	SELECT
		g.[ID],
		g.[Name]
	FROM
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.[ID] = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.[ID]
	WHERE
		u.[ID] = @SupervisorUserID
		AND g.SingleMemberGroup = 1
	ORDER BY
		g.[Name]


END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_HasReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE                            PROCEDURE [dbo].[QStatus_HasReport]
	@UserID int,
	@HasReport bit output
AS
BEGIN
	SET NOCOUNT ON

	SET @HasReport = 0

	SELECT @HasReport = 1
	FROM QStatus_GroupReport gr
	INNER JOIN QStatus_Report r
	ON r.ID = gr.ReportID
	INNER JOIN QCheck_Groups g
	ON gr.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @UserID
	AND r.IsDeleted = 0

	SET NOCOUNT OFF
END













































GO
/****** Object:  StoredProcedure [dbo].[QStatus_Init]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE                          PROCEDURE [dbo].[QStatus_Init]
	@ReportID int
AS
BEGIN
	SET NOCOUNT ON

	SELECT 
		ID
	FROM
		QStatus_TaskTypes
	WHERE
		ReportID = @ReportID
			
	IF @@ROWCOUNT = 0
	BEGIN
		INSERT INTO QStatus_TaskTypes
		(ReportID, [Description], DisplayOrder, NativeType)
		SELECT 
			@ReportID, [Description], DisplayOrder, NativeType
		FROM
			QStatus_TaskTypesTemplate
		
	END

	SELECT 
		t.ID
	FROM
		QStatus_SpecialTasks t
	INNER JOIN
		QStatus_TaskTypes tt
	ON
		t.TaskType = tt.ID
	AND
		tt.NativeType = 5
	AND
		tt.ReportID = @ReportID

	IF @@ROWCOUNT = 0
	BEGIN
		INSERT INTO QStatus_SpecialTasks
		(Priority, TaskType)
		SELECT 
			1, tt.ID
		FROM
			QStatus_TaskTypes tt
		WHERE
			tt.ReportID = @ReportID
		AND 
			tt.NativeType = 5
	END

	


	SET NOCOUNT OFF
END











































GO
/****** Object:  StoredProcedure [dbo].[QStatus_InitUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE                                PROCEDURE [dbo].[QStatus_InitUser]
	@UserID int,
	@IsSupervisor int output,
	@Font int output
AS
BEGIN
	SET NOCOUNT ON

	

	SET @IsSupervisor = 0


	SELECT @IsSupervisor = 1--Case WHEN MAX(ColorNum) = 3 THEN 100 Else IsNull(MAX(ColorNum)%5 + 1, 0) END
	FROM
		QStatus_Supervisors s
	INNER JOIN QCheck_Groups g
	ON
		g.ID = s.SupervisorGroupID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = @UserID
	inner join
		QStatus_report r
	on
		s.reportID = r.ID
	and
		r.IsDeleted = 0

	If @IsSupervisor = 0
		SELECT @IsSupervisor = 1
		FROM QStatus_SupervisorDepartments
		WHERE SupervisorUserID = @UserID
	

	SELECT @Font = 0
	
	SELECT @Font = PreferenceValue
	FROM
		QStatus_Preferences
	WHERE
		UserID = @UserID
	AND
		PreferenceType = 'Fonts'

	SET NOCOUNT OFF
END

















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_InterestedPartyOnly]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO










CREATE                                                   PROCEDURE [dbo].[QStatus_InterestedPartyOnly]
	@UserID int,
	@Result bit output
AS
BEGIN

		SELECT @Result = 1
	
		SELECT 
			@Result = 0
		FROM
		
			QStatus_Report r
		INNER JOIN
			QStatus_Supervisors s
		ON
			r.ID = s.ReportID
		AND
			s.DirectSupervisor = 1
		AND
			s.InterestedParty = 0 
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = s.SupervisorGroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		
		WHERE
			r.IsDeleted = 0
			and not 
				r.id in (select reportID from 
						QStatus_GroupReport gr
					 INNER JOIN
						QCheck_Groups g
					ON
						g.ID = gr.GroupID
					INNER JOIN
						QCheck_GroupMembership gm
					ON
						gm.GroupID = g.ID
					AND
						gm.UserID = @UserID)
	
END


























































GO
/****** Object:  StoredProcedure [dbo].[QStatus_IsAdmin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[QStatus_IsAdmin]
	@userId int
as
begin
	declare @isAdmin bit = 0
	select 
		@isAdmin = [admin]
	from 
		QCheck_Users with (nolock)
	where 
		IsDeleted = 0 and ID = @userId

	select @isAdmin
end
GO
/****** Object:  StoredProcedure [dbo].[QStatus_IsConfidential]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE                             PROCEDURE [dbo].[QStatus_IsConfidential]
	@ReportID int,
	@IsConfidential bit output
AS
	select @IsConfidential = IsConfidential from QStatus_report
	where id = @ReportID



GO
/****** Object:  StoredProcedure [dbo].[QStatus_IsUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE                              PROCEDURE [dbo].[QStatus_IsUser]
	@UserID int,
	@ReportID int,
	@IsUser bit output
AS

	SET @IsUser = 0

	SELECT @IsUser = 1 FROM QStatus_GroupReport gr
	INNER JOIN QCheck_Groups g
	ON g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON gm.GroupID = g.ID
	AND gm.UserID = @UserID
	AND gr.ReportID = @ReportID




















GO
/****** Object:  StoredProcedure [dbo].[QStatus_MarkRead]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE              PROCEDURE [dbo].[QStatus_MarkRead]
	@ReportID int,
	@SupervisorID int
AS
BEGIN

	UPDATE QStatus_SupervisorsLastViewed
	SET LastViewed = getDate()
	WHERE
		ReportID = @ReportID
	AND
		SupervisorUserID = @SupervisorID

	IF @@Rowcount = 0

	INSERT INTO QStatus_SupervisorsLastViewed
		(LastViewed, ReportID, SupervisorUserID)
	SELECT
		getDate(), @ReportID, @SupervisorID
	
END






































GO
/****** Object:  StoredProcedure [dbo].[QStatus_MoveSection]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE                      PROCEDURE [dbo].[QStatus_MoveSection]
	@ID int,
	@MoveTo int
 AS

BEGIN

	SET NOCOUNT ON
		
		DECLARE @NewDisplayOrder int		
		DECLARE @OldDisplayOrder int
		DECLARE @MinWithEmptyBefore int

		SELECT @OldDisplayOrder = [DisplayOrder]
		FROM QStatus_TaskTypes
		WHERE ID = @ID	
		
		SELECT @NewDisplayOrder = [DisplayOrder]
		FROM QStatus_TaskTypes
		WHERE ID = @MoveTo

		IF @OldDisplayOrder < @NewDisplayOrder  SET @NewDisplayOrder = @NewDisplayOrder + 1


		UPDATE QStatus_TaskTypes
		SET [DisplayOrder] = [DisplayOrder] + 1
		WHERE [DisplayOrder] >= @NewDisplayOrder
		AND EXISTS
		(
			SELECT ID FROM QStatus_TaskTypes 
			WHERE [DisplayOrder] = @NewDisplayOrder
		)
		AND IsDeleted = 0

		UPDATE QStatus_TaskTypes
		SET DisplayOrder = @NewDisplayOrder
		WHERE ID = @ID

		SELECT @MinWithEmptyBefore = MIN(A.DisplayOrder)
		FROM QStatus_TaskTypes a
		WHERE NOT EXISTS
		(SELECT b.ID 
		FROM
		QStatus_TaskTypes b
		WHERE b.DisplayOrder = a.DisplayOrder - 1
		AND b.IsDeleted = 0)
		AND a.DisplayOrder > 1
		AND a.IsDeleted = 0
		
		If IsNull(@MinWithEmptyBefore,0) > 1
		BEGIN
			UPDATE QStatus_TaskTypes
			SET [DisplayOrder] = [DisplayOrder] - 1
			WHERE [DisplayOrder] >= @MinWithEmptyBefore
			AND IsDeleted = 0
		END
		

	SET NOCOUNT OFF

END





























GO
/****** Object:  StoredProcedure [dbo].[QStatus_MoveTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO











CREATE                          PROCEDURE [dbo].[QStatus_MoveTask]
	@ReportID int,
	@TaskID int,
	@Type int,
	@Moved bit output,
	@CurrentTaskType int output,
	@NewReportID int output,
	@NewSectionName varchar(100) output,
	@IsComplete bit output
	
AS
BEGIN
	
	DECLARE @CanMove bit

	SET @IsComplete = 1
	SELECT @IsComplete = 0 FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID
	AND CompletedDate is NULL

	SELECT @NewSectionName = Description
	FROM QStatus_TaskTypes WHERE ID = @Type

	SET @Moved = 0

	SELECT @CurrentTaskType = TaskType
	FROM QStatus_ActiveChecklistTaskType
	WHERE ActiveChecklistID = @TaskID
	AND TaskType in
		(SELECT ID FROM QStatus_TaskTypes
		WHERE ReportID = @ReportID)


	SET @CanMove = 0
	--First check to see that the report it is being moved to does not already have a copy of this task
	
	SELECT @NewReportID = ReportID from QStatus_TaskTypes
	WHERE ID = @Type
	
	--If it is being moved within the same report, carry on
	IF @NewReportID = @ReportID
	BEGIN
		SET @CanMove = 1
	END
	ELSE
	BEGIN
		--being moved to a new report.  Check to make sure that report does not already have a copy of this task
		SELECT @CanMove = 1
		WHERE Not Exists
			(SELECT 1 FROM QStatus_ActiveChecklistTaskType
			WHERE ActiveChecklistID = @TaskID
			AND TaskType in (SELECT ID FROM QStatus_TaskTypes WHERE ReportID = @NewReportID)
			)
	
	END

	IF @CurrentTaskType = @Type SET @CanMove = 0 --don't move if its already there

	IF @CanMove = 1
	BEGIN
		UPDATE QStatus_ActiveChecklistTaskType
		SET TaskType = @Type
		WHERE ActiveChecklistID = @TaskID
		AND TaskType = @CurrentTaskType

		IF @@rowcount > 0 SET @Moved = 1
	
		UPDATE QStatus_InstanceTaskType
		SET TaskType = @Type
		WHERE InstanceID in (
					SELECT instanceID from 
					QCheck_ActiveChecklists
					WHERE ID = @TaskID
				)
		AND TaskType = @CurrentTaskType
	END
END


















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_MySections]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROC [dbo].[QStatus_MySections] (
	@UserID int,
	@SectionID int = null
)
AS
BEGIN

	SELECT  
			tt.ID, 
			r.Name,
			tt.description
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		INNER JOIN 
			QStatus_TaskTypes tt
		ON
			tt.ReportID = r.ID
		AND 
			tt.IsDeleted = 0
		AND
			tt.NativeType = 0
		WHERE 
			r.IsDeleted = 0
		and
			(tt.ID = @SectionID or @SectionID is null)
		ORDER BY r.ID, tt.displayOrder

END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_MySections_Condensed]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROC [dbo].[QStatus_MySections_Condensed] (
	@UserID int,
	@SectionID int = null
)
AS
BEGIN

	SELECT  
			tt.ID, 
			r.Name + ' ' +
			tt.description
		FROM 
			QStatus_Report r
		INNER JOIN
			QStatus_GroupReport gr
		ON
			gr.ReportID = r.ID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		AND
			gm.UserID = @UserID
		INNER JOIN 
			QStatus_TaskTypes tt
		ON
			tt.ReportID = r.ID
		AND 
			tt.IsDeleted = 0
		AND
			tt.NativeType = 0
		WHERE 
			r.IsDeleted = 0
		and
			(tt.ID = @SectionID or @SectionID is null)
		ORDER BY r.ID, tt.displayOrder

END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_MySupervisees]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO











CREATE                 PROCEDURE [dbo].[QStatus_MySupervisees]
	@UserID int
AS
BEGIN
	SELECT distinct u2.fullname as Supervisee
	From
		QCheck_Users u
	INNER JOIN 
		QStatus_SUPERVISORS S
	ON
		S.DirectSupervisor = 1
	AND 
		S.InterestedParty = 0
	INNER JOIN
		QCheck_Groups g
	ON
		g.ID = s.SupervisorGroupID
	INNER JOIN
		QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gm.UserID = u.ID
	INNER JOIN
		QStatus_Report r
	ON
		r.IsDeleted = 0
	AND 
		r.ID = s.ReportID
	INNER JOIN 
		QStatus_GroupReport gr
	ON
		gr.ReportID = r.ID
	INNER JOIN 
		QCheck_GroupMembership ugm
	ON
		ugm.GroupID = gr.GroupID
	INNER JOIN 
		QCheck_Groups ug
	ON
		ug.ID = ugm.GroupID
	inner join qcheck_users u2
	on
		u2.id = ugm.userid
	WHERE 
		u.IsDeleted = 0
	and
		u2.isdeleted = 0
	and
		u.ID = @UserID
	order by 1 desc
END










































GO
/****** Object:  StoredProcedure [dbo].[QStatus_MySupervisors]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_MySupervisors]
	@UserID int
AS
BEGIN
	
	DECLARE @Login VARCHAR(50)
	
	SELECT @Login = ShortName
	FROM QCheck_Users
	WHERE ID = @UserID
	
	DECLARE @Supervisors TABLE (
		ID INT,
		Name VARCHAR(500)
	)
	
	INSERT INTO @Supervisors (ID, Name)
		EXEC QStatus_SupervisorsByLogin @Login
		
	SELECT Name AS Supervisor
	FROM @Supervisors
	
	
END









































GO
/****** Object:  StoredProcedure [dbo].[QStatus_NeedsRefresh]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_NeedsRefresh] (
	@ReportID INT,
	@NeedsRefresh BIT OUTPUT
) AS

BEGIN

	SELECT @NeedsRefresh = IsDirty
	FROM QStatus_Report
	WHERE [ID] = @ReportID

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_NeedsRefresh_ResetDirty]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_NeedsRefresh_ResetDirty] (
	@ReportID INT,
	@NeedsRefresh BIT OUTPUT
) AS

BEGIN

	SELECT @NeedsRefresh = IsDirty
	FROM QStatus_Report
	WHERE [ID] = @ReportID
	
	UPDATE QStatus_Report
	SET IsDirty = 0
	WHERE [ID] = @ReportID

END


	
GO
/****** Object:  StoredProcedure [dbo].[QStatus_OutprocessDeleteReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_OutprocessDeleteReport] (
	@GroupReportID INT
) AS

BEGIN

	DECLARE @ReportID INT

	SELECT 
		@ReportID = ReportID
	FROM
		QStatus_GroupReport
	WHERE 
		ID = @GroupReportID

	UPDATE QStatus_Report
	SET IsDeleted = 1
	WHERE ID = @ReportID

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_OverdueTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QStatus_OverdueTasks]
@daysoverdue int

AS

SELECT 		distinct 
		u2.fullname as 'Assigned To',dbo.QStatus_GetChecklistControllers(c1.ID) as 'Controller By',  c1.name as Task, datediff(dd,a.DueTime,getdate()) as 'Days Overdue'
	
	
		FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID

		inner join
			QCheck_Assignments f
		on
			f.InstanceID = b1.ID

inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 
			and c1.isdeleted = 0


		inner join QCheck_Groups g
		ON
			f.groupID = g.ID
		inner join 
			QCheck_GroupMembership gm
		on
			g.ID = gm.GroupID
		inner join qcheck_users u2
			on gm.userid = u2.id
				
		inner JOIN QCheck_ActiveAssignments
		
			k 
		  on 
			k.ActiveChecklistID = a.ID 
			and k.AssignmentsID = f.ID
		WHERE
	
			a.CompletedDate is null 
		AND ( f.ID is not null)
		AND a.DueTime < getDate() - @daysoverdue - 1
order by 'Days Overdue' desc
GO
/****** Object:  StoredProcedure [dbo].[QStatus_OverdueTasks3To10]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QStatus_OverdueTasks3To10]

AS

SELECT 		distinct 
		u2.fullname as 'Assigned To',dbo.QStatus_GetChecklistControllers(c1.ID) as 'Controller By',  c1.name as Task, datediff(dd,a.DueTime,getdate()) as 'Days Overdue'
	
	
		FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID

		inner join
			QCheck_Assignments f
		on
			f.InstanceID = b1.ID

inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 
			and c1.isdeleted = 0


		inner join QCheck_Groups g
		ON
			f.groupID = g.ID
		inner join 
			QCheck_GroupMembership gm
		on
			g.ID = gm.GroupID
		inner join qcheck_users u2
			on gm.userid = u2.id
				
		inner JOIN QCheck_ActiveAssignments
		
			k 
		  on 
			k.ActiveChecklistID = a.ID 
			and k.AssignmentsID = f.ID
		WHERE
	
			a.CompletedDate is null 
		AND ( f.ID is not null)
		AND a.DueTime < getDate() - 4 AND a.DueTime > getdate() - 11
order by 'Days Overdue' desc
GO
/****** Object:  StoredProcedure [dbo].[QStatus_PriorityListSet_ByReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_PriorityListSet_ByReport] (
	@ReportID INT
) AS

BEGIN

	-- Returns all the named priority list sets that belong to any controller on the status report
	SELECT DISTINCT
		pls.[ID] As PriorityListSetID,
		pls.[Name] As PriorityListName
	FROM 
		QStatus_Report r
		INNER JOIN QStatus_GroupReport gr
			ON r.[ID] = gr.ReportID
		INNER JOIN QCheck_GroupMembership gm
			ON gr.GroupID = gm.GroupID
		INNER JOIN PriorityListSet pls
			ON gm.UserID = pls.UserID
	WHERE 
		r.[ID] = @ReportID
	ORDER BY
		pls.[Name]

END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_QPI_Summary]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






CREATE   procedure [dbo].[QStatus_QPI_Summary]
	(
		@ratio1 float = 1
		, @ratio2 float = 1
		, @ratio3 float = 1
		, @ratio4 float = 1
		, @ratio5 float = 1
		, @ratio6 float = -1
		, @ratio7 float = -1
		, @ratio8 float = -1
		, @ratio9 float = -1
		, @ratio10 float = -1
		, @ratio11 float = -1
		, @ratio12 float = -1
		, @WhichResult	int = 0
	)
as
begin

	set nocount on

	declare @rows	float
	declare @total	table
		(	
			userid	varchar(50)
			, score	int
		)
	declare @GrandTotal	table
		(	
			id	int	identity(1,1)
			, userid	varchar(50)
			, score	int
			, Rank	int
		)



	-- ---------------------------------------------------------------------
	-- Tasks due over next 14 days
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 1 or @WhichResult = 4
	begin
		declare @t1 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t1 (userid, value)
			select shortname, count(*) 
			from [QStatus_QPI_AssignedTasksComingDue]
			where duetime <= getdate() + 14
			group by shortname
			order by 2 desc

			set @rows = @@rowcount

		update @t1
			set rank = true_rank
		from @t1 t1
				inner join (select value, min(id) "true_rank" from @t1 group by value) t2
					on t1.value = t2.value

		update @t1
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio1
	end
	if @WhichResult = 1 begin
		select Userid, Value, Score 
		from @t1
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t1
		order by id
	end

	-- ---------------------------------------------------------------------
	-- # of tasks completed in past 14 days
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 2 
	begin
		declare @t12 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t12 (userid, value)
			select shortname, count(*) 
			from QStatus_QPI_AssignedTasksCompleted
			where ActiveChkCompletedDate >= getdate() - 14
			group by shortname
			order by 2 desc

			set @rows = @@rowcount

		update @t12
			set rank = true_rank
		from @t12 t1
				inner join (select value, min(id) "true_rank" from @t12 group by value) t2
					on t1.value = t2.value

		update @t12
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio2

	end
	if @WhichResult = 2 begin
		select Userid, Value, Score 
		from @t12
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t12
		order by id
	end

	-- ---------------------------------------------------------------------
	-- Tasks Steps due over next 14 days
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 3 or @WhichResult = 4
	begin
		declare @t2 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t2 (userid, value)
			select shortname, count(*) "Steps"
			from [QStatus_QPI_AssignedTaskStepsComingDue]
			where duetime <= getdate() + 14
			group by shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t2
			set rank = true_rank
		from @t2 t1
				inner join (select value, min(id) "true_rank" from @t2 group by value) t2
					on t1.value = t2.value

		update @t2
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio3

	end
	if @WhichResult = 3 begin
		select Userid, Value, Score 
		from @t2
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t2
		order by id
	end


	-- ---------------------------------------------------------------------
	-- Ratio of Tasks Steps to Discrete Tasks	
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 4
	begin
		declare @t3 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t3 (userid, value)
		select t.userid, convert(float, isnull(s.value,0)) / convert(float,t.value) "Ratio"
		from @t1 t
			left outer join @t2 s
				on t.userid = s.userid
		order by 2 desc

		set @rows = @@rowcount

		update @t3
			set rank = true_rank
		from @t3 t1
				inner join (select value, min(id) "true_rank" from @t3 group by value) t2
					on t1.value = t2.value

		update @t3
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio4

	end
	if @WhichResult = 4 begin
		select Userid, Value, Score 
		from @t3
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t3
		order by id
	end

	-- ---------------------------------------------------------------------
	-- # of Status Report Comments in past 7 days
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 5
	begin
		declare @t4 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t4 (userid, value)
			select u.shortname, Count(*) "Comments"
			from QStatus_Comments C
					inner join qpi_users u	
						on u.id = c.userid
			where commentdt >= getdate() - 7
			group by u.shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t4
			set rank = true_rank
		from @t4 t1
				inner join (select value, min(id) "true_rank" from @t4 group by value) t2
					on t1.value = t2.value

		update @t4
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio5

	end
	if @WhichResult = 5 begin
		select Userid, Value, Score 
		from @t4
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t4
		order by id
	end


	-- ---------------------------------------------------------------------
	-- # Overdue Tasks - Assigned
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 6
	begin
		declare @t5 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t5 (userid, value)
			select shortname, count(*) "Tasks"
			from QStatus_QPI_AssignedTasksOverdue 
			where	dueTime <= getdate()
			group by shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t5
			set rank = true_rank
		from @t5 t1
				inner join (select value, max(id) "true_rank" from @t5 group by value) t2
					on t1.value = t2.value

		update @t5
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio6

	end
	if @WhichResult = 6 begin
		select Userid, Value, Score 
		from @t5
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t5
		order by id
	end

	-- ---------------------------------------------------------------------
	-- # Overdue Tasks more than 1 week overdue
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 7
	begin
		declare @t6 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t6 (userid, value)
			select shortname, count(*) "Tasks"
			from QStatus_QPI_AssignedTasksOverdue 
			where	dueTime <= getdate() - 7
			group by shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t6
			set rank = true_rank
		from @t6 t1
				inner join (select value, max(id) "true_rank" from @t6 group by value) t2
					on t1.value = t2.value

		update @t6
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio7

	end
	if @WhichResult = 7 begin
		select Userid, Value, Score 
		from @t6
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t6
		order by id
	end

	-- ---------------------------------------------------------------------
	-- # Overdue Tasks - Controller
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 8
	begin
		declare @t7 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t7 (userid, value)
			select shortname, count(*) "Tasks"
			from [QStatus_QPI_ControllerTasksOverdue] 
			where	dueTime <= getdate()
			group by shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t7
			set rank = true_rank
		from @t7 t1
				inner join (select value, max(id) "true_rank" from @t7 group by value) t2
					on t1.value = t2.value

		update @t7
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio8

	end
	if @WhichResult = 8 begin
		select Userid, Value, Score 
		from @t7
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t7
		order by id
	end

	-- ---------------------------------------------------------------------
	-- % of Tasks Overdue
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 9
	begin
		declare @t11 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		float
				, rank		int
				, score		int
			)

		insert into @t11 (userid, value)
			select shortname 
				, sum(case when duetime < getdate() then 1.0 else 0.0 end)  / convert(float,count(*)) "PercentOverdue"
			from [QStatus_QPI_AllActiveTasks]
			group by shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t11
			set rank = true_rank
		from @t11 t1
				inner join (select value, max(id) "true_rank" from @t11 group by value) t2
					on t1.value = t2.value

		update @t11
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio9

	end
	if @WhichResult = 9 begin
		select Userid, Value, Score 
		from @t11
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t11
		order by id
	end

	-- ---------------------------------------------------------------------
	-- Supervisor Not Read in More than 1 week
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 10
	begin
		declare @t8 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t8 (userid, value)
			select u.shortname, count(*) 
			from qstatus_report r
				inner join qstatus_supervisors s
					on r.id = s.reportid
				inner join qcheck_groups g
					on g.id = s.supervisorgroupid	
				inner join qcheck_groupmembership gm
					on gm.groupID = g.ID
				inner join qpi_users u
					on u.id = gm.UserID
				inner join qstatus_supervisorslastviewed lv
					on s.reportID = lv.reportID
					and u.id = lv.supervisoruserid
			where datediff(day, lv.lastviewed, r.LastReportDate) > 7
				and r.isdeleted = 0
				and (s.directsupervisor = 1 or s.interestedparty = 1)
			group by u.shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t8
			set rank = true_rank
		from @t8 t1
				inner join (select value, max(id) "true_rank" from @t8 group by value) t2
					on t1.value = t2.value

		update @t8
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio10

	end
	if @WhichResult = 10 begin
		select Userid, Value, Score 
		from @t8
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t8
		order by id
	end

	-- ---------------------------------------------------------------------
	-- Avg Comment Size is too large
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 11
	begin
		declare @t9 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t9 (userid, value)
			select u.shortname, avg(len(Comments)) "AvgLength"
			from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			where commentdt >= getdate() - 7
			group by u.shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t9
			set rank = true_rank
		from @t9 t1
				inner join (select value, max(id) "true_rank" from @t9 group by value) t2
					on t1.value = t2.value

		update @t9
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio11

	end
	if @WhichResult = 11 begin
		select Userid, Value, Score 
		from @t9
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t9
		order by id
	end

	-- ---------------------------------------------------------------------
	-- # of comments in past 7 days that are too large
	-- ---------------------------------------------------------------------
	if @WhichResult = 0 or @WhichResult = 12
	begin
		declare @t10 table
			(
				id	int	identity(1,1)
				, userid	varchar(50)
				, value		int
				, rank		int
				, score		int
			)

		insert into @t10 (userid, value)
			select u.shortname, count(*) "AvgLength"
			from QStatus_Comments C
				inner join qpi_users u	
					on u.id = c.userid
			where commentdt >= getdate() - 7
				and len(Comments) > 600
			group by u.shortname
			order by 2 desc
			set @rows = @@rowcount

		update @t10
			set rank = true_rank
		from @t10 t1
				inner join (select value, max(id) "true_rank" from @t10 group by value) t2
					on t1.value = t2.value

		update @t10
			set score = ((@rows - rank + 1) / @rows * 100) * @ratio12

	end
	if @WhichResult = 12 begin
		select Userid, Value, Score 
		from @t10
		order by Score desc
		return
	end 
	else begin
		insert into @total (userid, score)
		select userid, score from @t10
		order by id
	end


	-- ---------------------------------------------------------------------

	if @WhichResult = 0 begin
		insert into @GrandTotal (userid, score)
			select userid, sum(score) "Total"
			from @total
			group by userid
			order by 2 desc

		set @rows = @@rowcount

		update @GrandTotal
			set Rank = case 
							when (id*100) / (@rows*100) * 100 < 34 then 1
							when (id*100) / (@rows*100) * 100 < 67 then 2
							else 3
						end

		set nocount off
		select Userid, Score, Rank
		from @GrandTotal
		order by Rank asc, Score Desc, Userid Asc

	end

end





GO
/****** Object:  StoredProcedure [dbo].[QStatus_ReassignReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE       PROCEDURE [dbo].[QStatus_ReassignReport](
	@ID int,
	@NewGroupID int
)	
 AS

	Update QStatus_GroupReport
	Set GroupID = @NewGroupID, defaultreport= 0, asof = getdate()
	WHERE ID = @ID






GO
/****** Object:  StoredProcedure [dbo].[QStatus_ReassignSupervisor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE       PROCEDURE [dbo].[QStatus_ReassignSupervisor](
	@ID int,
	@NewGroupID int
)	
 AS

	Update QStatus_Supervisors
	Set supervisorGroupID = @NewGroupID, asof = getdate()
	WHERE ID = @ID









GO
/****** Object:  StoredProcedure [dbo].[QStatus_ReassignSupervisorByName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QStatus_ReassignSupervisorByName]
    @ReportName varchar(50),
    @CurrentSupervisor varchar(50),
    @NewSupervisor varchar(50)
AS
    Update s 
        Set supervisorGroupID = ng.ID, asof = getdate()
    FROM QStatus_Supervisors s
    JOIN QStatus_Report r ON r.ID = s.ReportID AND r.Name = @ReportName
    JOIN QCheck_Groups og ON og.ID = s.SupervisorGroupID AND og.Name = @CurrentSupervisor
    JOIN QCheck_Groups ng ON ng.Name = @NewSupervisor
GO
/****** Object:  StoredProcedure [dbo].[QStatus_RemoveDontEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO












CREATE                     PROCEDURE [dbo].[QStatus_RemoveDontEmail]
	@ReportID int
AS
BEGIN

		DELETE FROM QStatus_DontEmail
		WHERE ReportID = @ReportID
END














GO
/****** Object:  StoredProcedure [dbo].[QStatus_ReportLastestComments_RefreshAll]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  proc [dbo].[QStatus_ReportLastestComments_RefreshAll]
AS
BEGIN
	
	
	truncate table QStatus_ReportLastestComments

	insert into QStatus_ReportLastestComments
	SELECT distinct userid, reportid, max(commentdt) as commentdt
		from
		(
			SELECT tt.ReportID, c.UserID, max(commentDt) as commentDt
			FROM
				QStatus_TaskTypes tt
			INNER JOIN
				QStatus_ActiveChecklistTaskType actt
			ON
				actt.TaskType = tt.ID
			INNER JOIN
				QStatus_Comments c
			ON
				c.ForeignKeyID = actt.ActiveChecklistID
			AND
				c.SpecialTask = 0
			INNER JOIN Qstatus_Report r
			ON r.ID = tt.ReportID
			AND r.IsDeleted = 0
			Group By tt.ReportID, c.UserID
			
			union all
			
			SELECT tt.ReportID, c.UserID, max(commentDt) as commentDt
			FROM
				QStatus_TaskTypes tt
			inner join qstatus_specialtasks st
			on 
				st.tasktype = tt.ID
			INNER JOIN
				QStatus_Comments c
			ON
				c.ForeignKeyID = st.ID
			AND
				c.SpecialTask = 1
			INNER JOIN Qstatus_Report r
				ON r.ID = tt.ReportID
				AND r.IsDeleted = 0
			Group By tt.ReportID, c.UserID
	
			union all
	
			SELECT tt.ReportID, c.UserID, max(commentDt) as commentDt
			FROM
				QStatus_TaskTypes tt
			INNER JOIN
				QStatus_ActiveChecklistTaskTypeArchive actt
			ON
				actt.TaskType = tt.ID
			INNER JOIN
				QStatus_CommentArchive c
			ON
				c.ForeignKeyID = actt.ActiveChecklistID
			AND
				c.SpecialTask = 0
			INNER JOIN Qstatus_Report r
			ON r.ID = tt.ReportID
			AND r.IsDeleted = 0
			Group By tt.ReportID, c.UserID
			
			union all
			
			SELECT tt.ReportID, c.UserID, max(commentDt) as commentDt
			FROM
				QStatus_TaskTypes tt
			inner join qstatus_specialtasks st
			on 
				st.tasktype = tt.ID
			INNER JOIN
				QStatus_CommentArchive c
			ON
				c.ForeignKeyID = st.ID
			AND
				c.SpecialTask = 1
			INNER JOIN Qstatus_Report r
				ON r.ID = tt.ReportID
				AND r.IsDeleted = 0
			Group By tt.ReportID, c.UserID
		) a
	group by reportid, userID
	order by 2, 1
end

GO
/****** Object:  StoredProcedure [dbo].[QStatus_ReportLastestComments_Update]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   proc [dbo].[QStatus_ReportLastestComments_Update]
	@UserID int,
	@CommentDt datetime,
	@ForeignKeyID int,
	@SpecialTask bit
	
AS
BEGIN

	DECLARE @Reports Table(
		ReportID int
	)

	INSERT INTO @Reports
	SELECT DISTINCT tt.ReportID
	FROM 	
		QStatus_TaskTypes tt
	INNER JOIN
		QStatus_ActiveChecklistTaskType actt
	ON
		actt.TaskType = tt.ID
	AND
		actt.ActiveChecklistID = @ForeignKeyID
	AND
		@SpecialTask = 0

	UNION ALL
	
	SELECT DISTINCT tt.ReportID
	FROM 	
		QStatus_TaskTypes tt
	inner join qstatus_specialtasks st
	on 
		st.tasktype = tt.ID	
	and
		st.ID = @ForeignKeyID
	and
		@SpecialTask = 1

	DELETE from QStatus_ReportLastestComments
	WHERE UserID = @UserID
	AND ReportID in (select reportID from @Reports)

	INSERT INTO QStatus_ReportLastestComments
	SELECT @UserID, ReportID, @CommentDt
	FROM @Reports
	
	UPDATE QStatus_Report
	SET IsDirty = 1
	WHERE ID IN (
		select reportID from @Reports
	)
		
end


GO
/****** Object:  StoredProcedure [dbo].[QStatus_ReportUpdated]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE     PROC [dbo].[QStatus_ReportUpdated]
	(@reportID int,
	@userid varchar(1000),
	@emailfrom varchar(1000),
	@emailfromname varchar(1000),
	@emailto varchar(1000),
	@emailsubject varchar(1000)
	)
AS
BEGIN
	
	declare @updated int
		
	set @updated = 0 
	
	select @updated = 1 from qstatus_report
	where id = @reportID
	and lastreportdate > getdate() - 1
	
	select @updated as updated
END




GO
/****** Object:  StoredProcedure [dbo].[QStatus_ResetFavorite]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE                   PROCEDURE [dbo].[QStatus_ResetFavorite]
	@UserID int,
	@ReportID int
AS
BEGIN
	SET NOCOUNT ON
	
	DELETE FROM QStatus_Favorites
	WHERE UserID = @UserID
	AND ReportID = @ReportID
	
	IF @@rowcount = 0
		INSERT INTO QStatus_Favorites
		SELECT @UserID, @ReportID

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_ResetFont]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






CREATE                  PROCEDURE [dbo].[QStatus_ResetFont]
	@UserID int,
	@Font int = 0 output
AS
BEGIN
	SET NOCOUNT ON
	
	SET @Font = 0


	SELECT @Font = CASE WHEN CAST(PreferenceValue as int) = 1 THEN 0 ELSE 1 END FROM
		QStatus_Preferences
	WHERE
		UserID = @UserID
	AND
		PreferenceType = 'Fonts'
	

	IF @@Rowcount = 0
	BEGIN
		INSERT INTO QStatus_Preferences (UserID, PreferenceType, PreferenceValue)
		VALUES (@UserID, 'Fonts', 1)
		SET @Font = 1
	END
	ELSE
	BEGIN
		UPDATE QStatus_Preferences
		SET PreferenceValue = @Font
		WHERE 
			UserID = @UserID
		AND
			PreferenceType = 'Fonts'
		
	END
	

	SET NOCOUNT OFF
END


































GO
/****** Object:  StoredProcedure [dbo].[QStatus_SaveCommentFromEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SaveCommentFromEmail] (
	@ActiveChecklistID INT,
	@SenderUserID INT,
	@Comment VARCHAR(5000),
	@CommentID INT = 0,
	@ReplyID INT OUTPUT
) AS

BEGIN

	DECLARE @Exists BIT = 0,
			@UserID INT,
			@NewID INT,
			@CommentsInitials VARCHAR(100),
			@FullName VARCHAR(50),
			@TabIn INT
	
	SELECT 
		@Exists = 1, 
		@ReplyID = ID	
	FROM 
		QStatus_Comments_All
	WHERE 
		-- Logic to handle both general comments and regular task comments
		(
			ForeignKeyID = ABS(@ActiveChecklistID)
			AND SpecialTask = CASE
				WHEN @ActiveChecklistID < 0 THEN 1
				ELSE 0
			END
		)
		AND LTRIM(RTRIM(UPPER(dbo.[RemoveNonAlphaCharacters]([dbo].[udf_StripHTML] (Comments))))) = LTRIM(RTRIM(UPPER(dbo.[RemoveNonAlphaCharacters]([dbo].[udf_StripHTML] (@Comment)))))
	
	-- If this comment doesn't already exist on the task
	IF @Exists = 0 BEGIN
		
		-- If none of the above, assume whoever sent the e-mail made the comment
		IF @UserID IS NULL BEGIN
			SET @UserID = @SenderUserID
		END
		
		SET @Comment = LEFT(@Comment, 1500)

		IF @CommentID <> 0 BEGIN
		
			-- Create the reply
			EXEC QStatus_CreateQuickReply 
				@CommentID, 
				@Comment, 
				@UserID, 
				@ReplyID OUTPUT, 
				@CommentsInitials OUTPUT, 
				@FullName OUTPUT, 
				@tabin OUTPUT
			
		END ELSE BEGIN
		
			-- Create the comment
			EXEC QStatus_CreateNewComment
				@ActiveChecklistID,
				@UserID,
				@Comment,
				@NewID OUTPUT,
				@CommentsInitials OUTPUT,
				@FullName OUTPUT
				
				SET @ReplyID = @NewID
				
		END
	
	END

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_SaveConfidential]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                             PROCEDURE [dbo].[QStatus_SaveConfidential]
	@ReportID int,
	@IsConfidential bit
AS
	update QStatus_report
	set IsConfidential = @IsConfidential  
	where id = @ReportID






GO
/****** Object:  StoredProcedure [dbo].[QStatus_SaveGeneralCommentFromEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SaveGeneralCommentFromEmail] (
	@ReportID INT,
	@SenderUserID INT,
	@Comments VARCHAR(1500)
) AS

BEGIN

	DECLARE @TaskID INT,
			@NewID INT,
			@CommentsInitials VARCHAR(100),
			@FullName VARCHAR(50)
	
	-- Get the general comments task ID from SpecialTasks
	SELECT 
		@TaskID = st.ID * -1
	FROM 
		QStatus_Report r
		INNER JOIN QStatus_TaskTypes tt
			ON tt.ReportID = r.ID
		INNER JOIN QStatus_SpecialTasks st
			ON st.TaskType = tt.ID
	WHERE 
		r.ID = @ReportID
		
	-- Create the comment. 
	EXEC QStatus_CreateNewComment @TaskID, @SenderUserID, @Comments, @NewID OUTPUT, @CommentsInitials OUTPUT, @FullName OUTPUT

END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_SendNotUpdatedList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                    PROCEDURE [dbo].[QStatus_SendNotUpdatedList]

AS
BEGIN
	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @mail_to VARCHAR(500)
	DECLARE @mail_subject VARCHAR(500)
	
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	SELECT @appURL = AppURL
	FROM QCheck_AppSettings a	
	where id = 1

--	SELECT @mail_to = 'kcroft@acmewidget.com;'	
	SELECT @mail_to = (SELECT TOP 1 StatusListNotUpdatedToAddress FROM QCheck_AppSettings)
	SET @mail_subject = 'Status Reports not commented in 3+ business days'

	declare @html table (id int identity(1,1), html varchar(max))
	insert into @html exec QStatus_SendNotUpdatedList_HTML
	declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
	while exists (select 1 from @html)
	begin
		select top 1 @rowid = id from @html order by id asc
		select @onerow = html from @html where id = @rowid
		select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
		delete from @html where id = @rowid
	end
	
	exec [dbo].[xp_smtp_sendmail]
			@to = @mail_to,
			@from = @MailFrom,
			@subject = @mail_subject,
			@message = @htmlstr
	

	SET NOCOUNT OFF

END












GO
/****** Object:  StoredProcedure [dbo].[QStatus_SendNotUpdatedList_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE                 PROCEDURE [dbo].[QStatus_SendNotUpdatedList_HTML]

AS
BEGIN
	SET NOCOUNT ON

		
	DECLARE @html_output TABLE (
		seq INT IDENTITY(1,1),
		row_html VARCHAR(5000)
	)

	DECLARE @StatusReport varchar(200)
	DECLARE @StatusUsers varchar(1000)
	DECLARE @UpdatedDate varchar(200)
	DECLARE @NumDaysOld varchar(10)
	
	DECLARE @i int
	DECLARE @count int

	DECLARE @APPURL varchar(150)
	
	
	--Work table
	DECLARE @NotUpdated TABLE
	(
		seq INT IDENTITY(1,1),
		id int,
		StatusReport varchar(200),
		StatusUsers varchar(1000),
		UpdatedDate varchar(200),
		NumDaysOld varchar(10)
	)	

	
	select  @APPURL = a.appurl
	from  qcheck_appsettings a
	where a.id = 1


		INSERT INTO @html_output (row_html) 
				SELECT '<html><style>
				TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;}TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style><body><table cellspacing=0 cellpadding=13>'
			

		insert into @NotUpdated
		([ID], StatusReport, StatusUsers, UpdatedDate, NumDaysOld)
		select
			 distinct r.[ID], 
			dbo.QStatus_GetUserNames(r.ID) + r.name,
			dbo.QStatus_GetUserNamesFull(r.ID),
			isNull(cast(b.commentDt as varchar), 'Never'),
			isNull(cast(datediff(day, b.commentDt, getdate()) as varchar), '')
		--r.ID, r.Name, isNull(b.commentDt, 0) as commentDt
		from
		qstatus_report r
		left outer join 
		(
		select reportID, max(commentdt) as commentDt from
			(
			select tt.reportID, max(c.CommentDt) as commentdt from 
				qstatus_comments c
			inner join qstatus_activechecklisttasktype actt
			on c.foreignkeyID = actt.activeChecklistID
			and c.specialTask = 0
			inner join qstatus_tasktypes tt
			on actt.tasktype = tt.id
			inner join qstatus_groupreport gr
			on gr.reportID = tt.reportID
			inner join qcheck_groups g
			on g.ID = gr.GroupID
			inner join qcheck_groupmembership gm
			on gm.groupID = g.ID
			and gm.userID = c.UserID
			group by tt.ReportID
			
			union all
			
			select tt.reportID, max(c.CommentDt) as commentdt from 
				qstatus_comments c
			inner join qstatus_specialtasks st
			on c.foreignkeyID = st.ID
			and c.specialTask = 1
			inner join qstatus_tasktypes tt
			on st.tasktype = tt.id
			inner join qstatus_groupreport gr
			on gr.reportID = tt.reportID
			inner join qcheck_groups g
			on g.ID = gr.GroupID
			inner join qcheck_groupmembership gm
			on gm.groupID = g.ID
			and gm.userID = c.UserID
			group by tt.ReportID
		
			union all
		
			select tt.reportID, max(c.CommentDt) as commentdt from 
				qstatus_commentarchive c
			inner join qstatus_activechecklisttasktype actt
			on c.foreignkeyID = actt.activeChecklistID
			and c.specialTask = 0
			inner join qstatus_tasktypes tt
			on actt.tasktype = tt.id
			inner join qstatus_groupreport gr
			on gr.reportID = tt.reportID
			inner join qcheck_groups g
			on g.ID = gr.GroupID
			inner join qcheck_groupmembership gm
			on gm.groupID = g.ID
			and gm.userID = c.UserID
			group by tt.ReportID
		
			union all
			
			select tt.reportID, max(c.CommentDt) as commentdt from 
				qstatus_commentarchive c
			inner join qstatus_specialtasks st
			on c.foreignkeyID = st.ID
			and c.specialTask = 1
			inner join qstatus_tasktypes tt
			on st.tasktype = tt.id
			inner join qstatus_groupreport gr
			on gr.reportID = tt.reportID
			inner join qcheck_groups g
			on g.ID = gr.GroupID
			inner join qcheck_groupmembership gm
			on gm.groupID = g.ID
			and gm.userID = c.UserID
			group by tt.ReportID
			) a
		group by reportID
		) b
		on r.ID = b.reportID
		and r.isDeleted = 0
		where 
		(b.commentDt is null or datediff(day, b.commentDt, getdate()) >=3)
		and r.isDeleted = 0
		order by 2


		SET @count = @@ROWCOUNT
		
		IF @Count > 0 BEGIN
		
			INSERT INTO @html_output (row_html) 
				SELECT '<tr><th>Status Report</th><th>Controllers</th><th>Last Updated</th><th>Days Since</th></tr>'
		
			SET @i = 1
			WHILE @i <= @count BEGIN
	
				SELECT @StatusReport = StatusReport,
					@StatusUsers = StatusUsers,
					@UpdatedDate = UpdatedDate,
					@NumDaysOld = NumDaysOld
				FROM @NotUpdated
				WHERE seq = @i
	
	
				INSERT INTO @html_output (row_html) 
					SELECT '<tr><td>'+@StatusReport+'</td><td>'+@StatusUsers+'&nbsp;</td><td>'+CAST(@UpdatedDate as varchar)+'</td><td style="text-align:center;">'+CAST(@NumDaysOld as varchar)+'&nbsp;</td></tr>'
				
				SELECT @i = @i + 1
			END
			
		END ELSE BEGIN
		
		INSERT INTO @html_output (row_html) 
			
			SELECT '<tr><td>All status reports have been updated in the last 3 days.</td></tr>'
		
		END

		INSERT INTO @html_output (row_html) 
				SELECT '</table><br><br> <a href="'+@APPURL+'">'+@APPURL+'</a></body></html>'


		select row_html from @html_output
		order by seq
		

	
	
	SET NOCOUNT OFF

END









GO
/****** Object:  StoredProcedure [dbo].[QStatus_SendOverdueNotices]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SendOverdueNotices]

AS
BEGIN
	SET NOCOUNT ON
	DECLARE @UserID int
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailCC VARCHAR(500)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1
	
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'

	DECLARE @count int
	DECLARE @i int
	DECLARE @StatusReport varchar(500)
	DECLARE @PrevStatusReport varchar(500)
	DECLARE @Task varchar(500)
	DECLARE @AssignedTo varchar(1000)
	DECLARE @DueDate varchar(50)
	DECLARE @DaysOverdue int
	

	SET @PrevStatusReport = ''

	SELECT @mailType = 'text/html'
	DECLARE @fromname varchar(100)

	
	SELECT @mailSubject = 'My Overdue Report'

	declare @sum int
	SET @sum = 0

	--Work table
	DECLARE @work TABLE (
		seq INT IDENTITY(1,1),
		id int,
		StatusReport varchar(500),
		Task varchar(500),
		AssignedTo varchar(1000),
		DueDate varchar(50),
		DaysOverdue int
	)

	DECLARE UserCurs CURSOR
	FOR 
	select distinct u.id, u.email
	from Qcheck_activechecklists t
	inner join QStatus_ActiveChecklistTaskType actt
	ON
		actt.ActiveChecklistID = t.ID
	AND
		t.CompletedDate is null
	inner join QStatus_tasktypes tt
	on actt.tasktype = tt.ID
	and tt.Isdeleted = 0
	and tt.nativetype = 0
	inner join QStatus_report r
	on tt.reportID = r.id
	
	and r.isdeleted = 0
	inner join qstatus_groupreport gr
	on gr.reportID = r.ID
	inner join qcheck_groups g
	on g.ID = gr.GroupID
	inner join qcheck_groupmembership gm
	on gm.groupID = g.ID
	inner join QCheck_Users u
	on u.id = gm.UserID
	where duetime < (getdate() - 1) 
	and len(u.email) > 0	

	OPEN UserCurs

	FETCH NEXT FROM UserCurs INTO @UserID, @mailTo
	WHILE @@FETCH_STATUS = 0 BEGIN

		
		SELECT @APPURL = appurl +'/MyStatus.aspx' from qcheck_appsettings a
		inner join qcheck_users u
			on u.app = a.id
			and u.id = @UserID

		select @mailBody = '<html><style>
				TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;} .hide {display:none} TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style><body><table cellspacing=0 cellpadding=13>'
		select @mailBody = @mailBody + '<tr><th>Status Report</th><th>Task</th><th>Assigned To</th><th>Due Date</th><th>Days Overdue<span class="hide"><br></span></th></tr>'

		insert into @work
		([ID], StatusReport, Task, AssignedTo, DueDate, DaysOverdue)
		select distinct r.[ID], dbo.QStatus_GetUserNames(r.ID) + r.name, c.name, dbo.QCheck_AssigneesList(i.id), CONVERT(varchar, t.duetime, 101), DateDiff(day, t.duetime, getDate())
		from Qcheck_activechecklists t
		inner join qcheck_checklistinstances i
		on
			t.InstanceID = i.ID
		and
			i.Isdeleted = 0
		inner join qcheck_checklists c
		on
			i.ChecklistID = c.ID
		and
			c.IsDeleted = 0
		inner join QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = t.ID
		AND
			t.CompletedDate is null
		inner join QStatus_tasktypes tt
		on actt.tasktype = tt.ID
		and tt.Isdeleted = 0
		inner join QStatus_report r
		on tt.reportID = r.id
		and r.isdeleted = 0
		inner join qstatus_groupreport gr
		on gr.reportID = r.ID
		inner join qcheck_groups g
		on g.ID = gr.GroupID
		inner join qcheck_groupmembership gm
		on gm.groupID = g.ID
		and gm.UserID = @UserID
		where t.duetime < (getdate() - 1) 
		order by r.[ID], CONVERT(varchar, t.duetime, 101)

		SET @count = @@ROWCOUNT
		
		SET @i = 1
		WHILE @i + @sum <= @count + @sum BEGIN

			SELECT @StatusReport = StatusReport,
				@Task = Task,
				@AssignedTo = AssignedTo,
				@DueDate = DueDate,
				@DaysOverdue = DaysOverdue
			FROM @work
			WHERE seq = @i + @sum

			IF @i > 1 AND @StatusReport <> @PrevStatusReport 
			BEGIN
				select @mailBody = @mailBody + '<tr style="height:10px;"><td></td><td></td><td></td></tr>'
			END

			SET @PrevStatusReport = @StatusReport
			
			--select @mailBody = @mailBody + '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@AssignedTo+'</td><td>'+@DueDate+'</td><td style="text-align:center;">'+CAST(@DaysOverdue as varchar)+'</td></tr>'
			select @mailBody = @mailBody + 
				'<tr><td><span class="hide">Report: </span>'+@StatusReport+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Task: </span>'+@Task+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Assigned To: </span>'+@AssignedTo+'<span class="hide"><br><br></span></td>
				<td><span class="hide">Due Date: </span>'+@DueDate+'<span class="hide"><br><br></span></td>
				<td style="text-align:center;"><span class="hide">Days Overdue: </span>'+CAST(@DaysOverdue as varchar)+'<span class="hide"><br><br></span></td></tr>'
			
			SELECT @i = @i + 1
		END

		SET @sum = @sum + @count

		select @mailBody = @mailBody + '</table><br><br> <a href="'+@APPURL+'">'+@APPURL+'</a></body></html>'

			--if @mailTo = 'kcroft@acmewidget.com'
			EXEC XPSendEmail
			    @FROM       = @mailFrom,
			    @TO         = @mailTo,
			    @subject    = @mailSubject,
			    @message    = @mailBody,
			    @type       = @mailType,
			    @server     = @mailServer
		

		DELETE FROM @work

	FETCH NEXT FROM UserCurs INTO  @UserID, @mailTo

	END
	CLOSE UserCurs
	DEALLOCATE UserCurs

	
	SET NOCOUNT OFF
	

END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_SendOverdueNotices_10day]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SendOverdueNotices_10day]
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @UserID int
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailCC VARCHAR(500)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody varchar(8000)
	DECLARE @mailTable varchar(8000)
	DECLARE @mailType VARCHAR(100)
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1
	
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	DECLARE @count int
	DECLARE @i int
	DECLARE @StatusReport varchar(200)
	DECLARE @PrevStatusReport varchar(200)
	DECLARE @Task varchar(500)
	DECLARE @AssignedTo varchar(1000)
	DECLARE @DueDate varchar(50)
	DECLARE @DaysOverdue int
	
	SET @mailBody = ''
	SET @mailTable = ''

	SET @PrevStatusReport = ''
	SELECT @mailType = 'text/html'
	DECLARE @fromname varchar(100)
	
	SELECT @mailSubject = 'My Weekly Overdue Report'
	declare @sum int
	SET @sum = 0
	--Work table
	DECLARE @work TABLE (
		seq INT IDENTITY(1,1),
		id int,
		Task varchar(500),
		AssignedTo varchar(1000),
		DueDate varchar(50),
		DaysOverdue int
	)
	DECLARE UserCurs CURSOR
	FOR 
	/*SELECT 		distinct 
		u1.id as id,
		u1.email as email
	
		FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID
		
		inner join
			QCheck_Assignments f
		on
			f.InstanceID = b1.ID
		inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 

		inner join QCheck_ChecklistManagers m
			
		   ON
			 m.ChecklistID = c1.ID
		inner join QCheck_Groups g1
				on m.ManagerGroupID = g1.ID
		inner join QCheck_GroupMembership gm1
		ON	
			g1.ID = gm1.GroupID
		inner join QCheck_Users u1 ON
			gm1.UserID = u1.id
		WHERE
	
			a.CompletedDate is null 
		AND (m.ManagerGroupID is not null OR f.ID is not null)
		AND a.DueTime < getDate() - 10
			and c1.isdeleted = 0 and 
			m.IsDeleted = 0
union*/
	SELECT 		distinct 
		u2.id as id,
		u2.email as email
	
		FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID

		inner join
			QCheck_Assignments f
		on
			f.InstanceID = b1.ID

inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 
			and c1.isdeleted = 0

/*		inner join QCheck_ChecklistManagers m
			
		   ON
			m.IsDeleted = 0
			AND m.ChecklistID = c1.ID*/
		inner join QCheck_Groups g
		ON
			f.groupID = g.ID
		inner join 
			QCheck_GroupMembership gm
		on
			g.ID = gm.GroupID
		inner join qcheck_users u2
			on gm.userid = u2.id
				
		inner JOIN QCheck_ActiveAssignments
		
			k 
		  on 
			k.ActiveChecklistID = a.ID 
			and k.AssignmentsID = f.ID
		WHERE
	
			a.CompletedDate is null 
		AND (/*m.ManagerGroupID is not null OR*/ f.ID is not null)
		AND a.DueTime < getDate() - 10

	OPEN UserCurs
	FETCH NEXT FROM UserCurs INTO @UserID, @mailTo
	WHILE @@FETCH_STATUS = 0 BEGIN
		set @mailBody = '<html><head><style> body {font-size:14pt;font-family:Times New Roman}' + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + '.c {text-align:center;} TD {border:solid 1px #000000;font-size:14pt;font-family:Times New Roman;} TH{border:solid 1px #000000;font-size:14pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style></head>'  + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + '<body><p>You currently have tasks in ' + @AppName + ' overdue by more than 10 days (see below).'  + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + 'Please take a few minutes to review these tasks and mark them complete.</p><p>You can find these tasks by doing either of the following:</p>' + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + '<ol><li>Go to <a href="' + @AppURL + '/mytasks.aspx">My Tasks</a> and adjust the date range at the top to include the original due date of the tasks.' + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + '  The old tasks should appear.  Click on the plus icon next to the task to open it, and mark it as complete.<br><br><b>OR</b><br><br></li><li>Go to the <a href="' + @AppURL + '/Reports.aspx">Reports</a> tab and click on Overdue.  The old tasks should appear.' + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + '  Click on the task to open it, and mark it complete.</li></ol>' + CHAR(13) + CHAR(10)
		set @mailBody = @mailBody + '<p>If you  have any questions, please <a href="mailto:' + @ITAddress + '">email IT</a>.  Thanks.</p>'  + CHAR(13) + CHAR(10)
		set @mailTable = '<table cellspacing="0" cellpadding="8"><tr><th>Task</th><th>Assigned To</th><th>Due Date</th><th>Days Overdue</th></tr>' + CHAR(13) + CHAR(10)

insert into @work
(ID, Task, AssignedTo, DueDate, DaysOverdue)
SELECT 		distinct 
		a.ID as Identifier,
		c1.Name as [Task], 
		dbo.QCheck_AssigneesList(b1.id) as [Assigned To],
		a.dueTime as [Due Date], 
		DateDiff(day, a.duetime, getDate())
	
		FROM
		QCheck_ChecklistInstances b1
		inner join QCheck_ActiveChecklists a 
			ON a.InstanceID = b1.ID
		
		inner JOIN QCheck_Checklists c1
			on b1.checklistID = c1.ID 
			and c1.isdeleted = 0
		LEFT OUTER JOIN QCheck_GroupMembership gm1
		ON	
			gm1.UserID = @UserID
		LEFT OUTER JOIN QCheck_Groups g1
		ON
			g1.ID = gm1.GroupID
		/*LEFT OUTER JOIN QCheck_ChecklistManagers m
			
		   ON
			m.IsDeleted = 0
				AND m.ManagerGroupID = g1.ID
			AND m.ChecklistID = c1.ID*/
		INNER JOIN
			QCheck_Assignments f1
		on
			f1.InstanceID = b1.ID
		left outer join 
			QCheck_GroupMembership gm
		on
			gm.UserID = @UserID
		LEFT OUTER JOIN QCheck_Groups g
		ON
			g.ID = gm.GroupID
		Left outer join 
			QCheck_Assignments f
		on
			f.InstanceID = b1.ID
		AND
			f.groupID = g.ID
		inner JOIN QCheck_ActiveAssignments
		
			k 
		  on 
			k.ActiveChecklistID = a.ID 
			and k.AssignmentsID = f1.ID
		WHERE
	
			a.CompletedDate is null 
		AND (/*m.ManagerGroupID is not null OR*/ f.ID is not null)
		AND a.DueTime < getDate() - 10
	
		ORDER BY 
		[Due Date],
		Task, 
		[Assigned To]

		/*insert into @work
		([ID], StatusReport, Task, AssignedTo, DueDate, DaysOverdue)
		select distinct r.[ID], dbo.QStatus_GetUserNames(r.ID) + r.name, c.name, dbo.QCheck_AssigneesList(i.id), CONVERT(varchar, t.duetime, 101), DateDiff(day, t.duetime, getDate())
		from Qcheck_activechecklists t
		inner join qcheck_checklistinstances i
		on
			t.InstanceID = i.ID
		and
			i.Isdeleted = 0
		inner join qcheck_checklists c
		on
			i.ChecklistID = c.ID
		and
			c.IsDeleted = 0
		inner join QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = t.ID
		AND
			t.CompletedDate is null
		inner join QStatus_tasktypes tt
		on actt.tasktype = tt.ID
		and tt.Isdeleted = 0
		inner join QStatus_report r
		on tt.reportID = r.id
		and r.isdeleted = 0
		inner join qstatus_groupreport gr
		on gr.reportID = r.ID
		inner join qcheck_groups g
		on g.ID = gr.GroupID
		inner join qcheck_groupmembership gm
		on gm.groupID = g.ID
		and gm.UserID = @UserID
		where t.duetime < (getdate() - 1) 
		order by r.[ID], CONVERT(varchar, t.duetime, 101)*/
		SET @count = @@ROWCOUNT
		
		SET @i = 1
		WHILE @i + @sum <= @count + @sum AND len(@mailBody) + len(@mailTable) < 7500
		BEGIN
--			SELECT @StatusReport = StatusReport,
			SELECT @Task = Task,
				@AssignedTo = AssignedTo,
				@DueDate = DueDate,
				@DaysOverdue = DaysOverdue
			FROM @work
			WHERE seq = @i + @sum
/*			IF @i > 1 AND @StatusReport <> @PrevStatusReport 
			BEGIN
				select @mailBody = @mailBody + '<tr style="height:10px;"><td></td><td></td><td></td></tr>'
			END
			SET @PrevStatusReport = @StatusReport*/
			
			--select @mailBody = @mailBody + '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@AssignedTo+'</td><td>'+@DueDate+'</td><td style="text-align:center;">'+CAST(@DaysOverdue as varchar)+'</td></tr>'
			set @mailTable = @mailTable + '<tr><td>'+@Task+'</td><td>'+@AssignedTo+'</td><td>' + CHAR(13) + CHAR(10)
			set @mailTable = @mailTable + @DueDate+'</td><td class="c">'+CAST(@DaysOverdue as varchar)+'</td></tr>' + CHAR(13) + CHAR(10)
			
			SELECT @i = @i + 1
		END
		SET @sum = @sum + @count
		
		IF len(@mailBody) + len(@mailTable) >= 7500
		BEGIN
			set @mailBody = @mailBody + '<p>Note: you have ' + cast(@count as varchar(3)) + ' overdue tasks.  Due to space limitations, only the first ' + cast(@i as varchar(3)) + ' are shown below.  Please refer to ' + @AppName + ', per the above instructions, for a complete listing.</p>' + CHAR(13) + CHAR(10)
		END

		select @mailBody = @mailBody + @mailTable + '</table></body></html>'

			EXEC XPSendEmail
			    @FROM       = @mailFrom,
			    @TO         = @mailTo,
			    @subject    = @mailSubject,
			    @message    = @mailBody,
			    @type       = @mailType,
			    @server     = @mailServer
		
		DELETE FROM @work
	FETCH NEXT FROM UserCurs INTO  @UserID, @mailTo
	END
	CLOSE UserCurs
	DEALLOCATE UserCurs
	
	SET NOCOUNT OFF
	
END

GO
/****** Object:  StoredProcedure [dbo].[QStatus_SendSupervisorNotUpdatedList]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SendSupervisorNotUpdatedList]

AS
BEGIN
	SET NOCOUNT ON
	DECLARE @SupervisorID int
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailCC VARCHAR(500)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)

	DECLARE @StatusReport varchar(200)
	DECLARE @StatusUsers varchar(1000)
	DECLARE @UpdatedDate datetime
	DECLARE @NumDaysOld int
	
	DECLARE @i int
	DECLARE @count int

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1
	
	
	SELECT @mailType = 'text/html'

	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	SELECT @mailSubject = 'Status Reports not updated in 2+ business days'

	--Work table
	CREATE TABLE #NotUpdated (
		seq INT IDENTITY(1,1),
		id int,
		StatusReport varchar(200),
		StatusUsers varchar(1000),
		UpdatedDate datetime,
		NumDaysOld int
	)	

	DECLARE SupemailCurs CURSOR
	FOR 
	select distinct u.id, u.email, a.appurl +'/MyInbox.aspx'
	from qstatus_report r
	inner join qstatus_supervisors s
	on s.reportID = r.ID
	and s.interestedparty = 0
	inner join qcheck_users u
	on 
	u.DepartmentAdmin = 1
	inner join qcheck_appsettings a
	ON
		a.id = u.app
	where dbo.Util_AddOfficeDays(getDate(), -2) > r.LastReportDate
	and r.isdeleted = 0

	OPEN SupemailCurs

	FETCH NEXT FROM SupemailCurs INTO @SupervisorID, @mailTo, @APPURL
	WHILE @@FETCH_STATUS = 0 BEGIN
		select @mailBody = '<html><style>
				TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;}TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}</style><body><table cellspacing=0 cellpadding=13>'
		select @mailBody = @mailBody + '<tr><th>Status Report</th><th>Controllers</th><th>Last Updated</th><th>Days Since</th></tr>'

		

		insert into #NotUpdated
		([ID], StatusReport, StatusUsers, UpdatedDate, NumDaysOld)
		select distinct r.[ID], 
			dbo.QStatus_GetUserNames(r.ID) + r.name,
			dbo.QStatus_GetUserNamesFull(r.ID),
			r.LastReportDate,
			datediff(day, r.LastReportDate, getdate())
		from qstatus_report r
		inner join qstatus_supervisors s
		on s.reportID = r.ID
		and s.interestedparty = 0
		inner join qcheck_Groups g
		ON g.ID = s.SupervisorGroupID
		inner join qcheck_groupmembership gm
		on gm.GroupID = g.ID
		inner join qcheck_users u
		on (u.ID = gm.UserID
		or u.DepartmentAdmin = 1)
		and u.ID = @SupervisorID
		where dbo.Util_AddOfficeDays(getDate(), -2) > r.LastReportDate
		and r.isdeleted = 0
		order by 2


		SET @count = @@ROWCOUNT
		
		SET @i = 1
		WHILE @i <= @count BEGIN

			SELECT @StatusReport = StatusReport,
				@StatusUsers = StatusUsers,
				@UpdatedDate = UpdatedDate,
				@NumDaysOld = NumDaysOld
			FROM #NotUpdated
			WHERE seq = @i


			select @mailBody = @mailBody + '<tr><td>'+@StatusReport+'</td><td>'+@StatusUsers+'</td><td>'+CAST(@UpdatedDate as varchar)+'</td><td style="text-align:center;">'+CAST(@NumDaysOld as varchar)+'</td></tr>'
			

			
			SELECT @i = @i + 1
		END

		select @mailBody = @mailBody + '</table><br><br> <a href="'+@APPURL+'">'+@APPURL+'</a></body></html>'


			EXEC XPSendEmail
			    @FROM       = @mailFrom,
			    @TO         = @mailTo,
			    @subject    = @mailSubject,
			    @message    = @mailBody,
			    @type       = @mailType,
			    @server     = @mailServer
		
		TRUNCATE TABLE #NOTUPDATED

	FETCH NEXT FROM SupemailCurs INTO  @SupervisorID, @mailTo, @APPURL

	END
	CLOSE SupemailCurs
	DEALLOCATE SupemailCurs
	

	SET NOCOUNT OFF

END





















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_SetColumnWidth]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                  PROCEDURE [dbo].[QStatus_SetColumnWidth]
	@UserID int,
	@ReportID int,
	@Width int 
AS
	UPDATE
		QStatus_ColumnWidth
	SET 
		ColumnWidth = @Width
	WHERE
		UserID = @UserID
	AND
		ReportID = @ReportID

	IF @@ROWCOUNT = 0
		INSERT INTO QStatus_ColumnWidth
		VALUES (@UserID, @ReportID, @Width)




GO
/****** Object:  StoredProcedure [dbo].[QStatus_SetSupervisorEmailPreference]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO










CREATE       PROCEDURE [dbo].[QStatus_SetSupervisorEmailPreference]
	@UserID INT,
	@Type INT,
	@SendEmail BIT

 AS

BEGIN

	
	SET NOCOUNT ON

	
	Update QStatus_SupervisorEmailPreferences
	SET SendEmail = @SendEmail
	WHERE
		UserID = @UserID
	AND
		Type = @Type

	IF @@Rowcount = 0 
		INSERT INTO QStatus_SupervisorEmailPreferences
		(UserID, Type, SendEmail)
		VALUES
		(@UserID, @Type, @SendEmail)


	SET NOCOUNT OFF

END











GO
/****** Object:  StoredProcedure [dbo].[QStatus_SupervisorEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE                                                  PROCEDURE [dbo].[QStatus_SupervisorEmail]
AS

	
	DECLARE @SuperID int
		
	DECLARE SUPERCURS CURSOR
	FOR 	
		--overdue
		select distinct u.id
		from Qcheck_activechecklists t
		inner join QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = t.ID
		AND
			t.CompletedDate is null
		inner join QStatus_tasktypes tt
		on actt.tasktype = tt.ID
		and tt.Isdeleted = 0
		and tt.nativetype = 0
		inner join QStatus_report r
		on tt.reportID = r.id
		and r.isdeleted = 0
		inner join QStatus_supervisors s
		on s.reportid = r.id
		and s.directsupervisor = 1
		inner join qcheck_groups g
		on g.ID = s.supervisorgroupid
		inner join qcheck_groupmembership gm
		on gm.GroupID = g.ID
		inner join QCheck_Users u
		on  u.id = gm.UserID
		inner join QStatus_SupervisorEmailDefaults def
		on def.EmailType = 'Overdue'
		AND 	(
				(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
					OR
				(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
			)
		left outer join QStatus_SupervisorEmailPreferences pref
		ON
			pref.type = def.id
		AND
			pref.UserID = u.ID
		left outer join QStatus_CondensedEmails ce
		ON
			ce.UserID = u.ID
		where duetime < (getdate() - 1) 
		and isnull(pref.SendEmail, def.SendEmail) = 1
		and len(email) > 0
		and ce.UserID is null
	
		union
	
		--duedatechanges
		select distinct supervisorID from
		(
			select distinct gm.UserID as supervisorID, u.Email, c.name as description, convert(varchar, min(ddc.duedateold), 101) as ddo, isnull(convert(varchar, t.duetime, 101), 'No due date') as dd 
			from QStatus_duedatechanges ddc
			inner join Qcheck_activechecklists t on ddc.activechecklistid = t.id
			inner join QCheck_ChecklistInstances i on i.ID = t.InstanceID and i.isdeleted = 0
			inner join QCheck_Checklists c on c.ID = i.ChecklistID and c.IsDeleted = 0
			inner join QStatus_ActiveChecklisttasktype actt on actt.ActiveChecklistID = t.ID
			inner join QStatus_TaskTypes tt on actt.TaskType = tt.ID
			inner join QStatus_supervisors s on s.directsupervisor = 1
			and s.reportID = tt.reportID
			inner join qcheck_groups g on g.ID = s.SupervisorGroupID
			inner join qcheck_groupmembership gm on gm.GroupID = g.ID
			inner join QCheck_Users u 
			on u.ID = gm.UserID
			inner join QStatus_SupervisorEmailDefaults def
			on def.EmailType = 'DueDateChanges'
			AND 	(
					(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
						OR
					(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
				)
			left outer join QStatus_SupervisorEmailPreferences pref
			ON
				pref.type = def.id
			AND
				pref.UserID = u.ID
			left outer join QStatus_CondensedEmails ce
			ON
				ce.UserID = u.ID
			where ddc.updatedt > getdate() - 1
			and len(email) > 0
			and isnull(pref.SendEmail, def.SendEmail) = 1
			and ce.UserID is null
			group by t.id, t.duetime, c.name, gm.UserID, u.Email
			having isnull(min(ddc.duedateold),0)<>isnull(t.duetime,0)
		) a
	
		union
	
		--unread inbox
		SELECT DISTINCT gm.UserID
			FROM
				QStatus_Supervisors sup
			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = sup.SupervisorGroupID
			INNER JOIN
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID
			INNER JOIN
				QStatus_Report r
			ON
				sup.ReportID = r.ID
			AND
				r.IsDeleted = 0				
			INNER JOIN QStatus_SupervisorsLastViewed lv
			ON
				lv.ReportID = r.ID
			AND
				lv.SupervisorUserID = gm.UserID
			AND
				ISNULL(r.LastReportDate,0) > lv.LastViewed
			INNER JOIN QStatus_GroupReport gr
			ON
				gr.ReportID = r.ID
			INNER JOIN QCheck_Groups ug
			ON
				ug.ID = gr.GroupID
			INNER JOIN QCheck_GroupMembership ugm
			On
				ugm.GroupID = ug.ID
			
			INNER JOIN
				QCheck_Users u
			ON
				u.ID = ugm.UserID
			INNER JOIN
				QCheck_Users us
			ON
				us.ID = gm.UserID
			inner join 
				QStatus_SupervisorEmailDefaults def
			on 
				def.EmailType = 'Unread'
			AND 	
				(
					(def.SupervisorType = 'Supervisor' AND sup.InterestedParty = 0)
						OR
					(def.SupervisorType = 'InterestedParty' AND sup.InterestedParty = 1)
				)
			left outer join 
				QStatus_SupervisorEmailPreferences pref
			ON
				pref.type = def.id
			AND
				pref.UserID = us.ID
			left outer join QStatus_CondensedEmails ce
			ON
				ce.UserID = us.ID
			WHERE
				isnull(pref.SendEmail, def.SendEmail) = 1
			and 
				len(us.email) > 0
			and	
				ce.UserID is null

	OPEN SUPERCURS

	FETCH NEXT FROM SUPERCURS INTO @SuperID
	WHILE @@FETCH_STATUS = 0 BEGIN
		
		EXEC QStatus_SupervisorEmail_SingleUser @SuperID
		
		FETCH NEXT FROM SUPERCURS INTO @SuperID
	
	END
	CLOSE SUPERCURS
	DEALLOCATE SUPERCURS














GO
/****** Object:  StoredProcedure [dbo].[QStatus_SupervisorEmail_SingleUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SupervisorEmail_SingleUser]
	@SuperID int
AS
begin	
	DECLARE @mail_to VARCHAR(500)
	DECLARE @mail_subject VARCHAR(500)
	
	DECLARE @imgURL VARCHAR(50)
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1
	
	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	SELECT @appURL = AppURL, @imgURL = ImagesURL
	FROM QCheck_AppSettings a
	INNER JOIN QCheck_Users u
	ON a.ID = u.App
	AND u.ID = @SuperID		

	SELECT @mail_to = Email FROM QCheck_Users where ID = @SuperID 
	
	SET @mail_subject = 'Unread Reports, Overdue Items, and Due Date Changes'
	
	declare @html table (id int identity(1,1), html varchar(max))
	insert into @html exec QStatus_SupervisorEmail_SingleUser_HTML @SuperID
	declare @htmlstr varchar(max), @onerow varchar(max), @rowid int
	while exists (select 1 from @html)
	begin
		select top 1 @rowid = id from @html order by id asc
		select @onerow = html from @html where id = @rowid
		select @htmlstr = isnull(@htmlstr, '') + isnull(@onerow, '') 
		delete from @html where id = @rowid
	end
	
	exec [dbo].[xp_smtp_sendmail]
			@to = @mail_to,
			@from = @MailFrom,
			@subject = @mail_subject,
			@message = @htmlstr


end




GO
/****** Object:  StoredProcedure [dbo].[QStatus_SupervisorEmail_SingleUser_HTML]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO









CREATE    			PROCEDURE [dbo].[QStatus_SupervisorEmail_SingleUser_HTML]
	@SuperID int
	
AS

BEGIN
	SET NOCOUNT ON

	--unread reports variables
	DECLARE @startText varchar(1000)
	DECLARE @luText varchar(1000)
	DECLARE @lrText varchar(1000)
	DECLARE @dt datetime

	--overdue variables
	DECLARE @ReportID int,
		@StatusReport varchar(200),
		@PrevStatusReport varchar(200),
		@Task varchar(200),
		@DueDate varchar(50),
		@DaysOverdue int,
		@AppURL varchar(150),
		@i int
	
	SET @i = 0

	--due date changes variables
	DECLARE @OldDueDate varchar(50)
	

	SELECT @APPURL = appurl --+'/MyInbox.aspx' 
	from qcheck_appsettings a
	inner join qcheck_users u
	on a.id = u.app
	and u.id = @SuperID

	-- table that will hold the html
	
	DECLARE @html_output TABLE (
		seq INT IDENTITY(1,1),
		row_html VARCHAR(5000)
	)

		
	-- apply the style sheet and header information
		INSERT INTO @html_output (row_html) 
				SELECT
			'<html>
				<style>
				TD {border:solid 1px #000000;font-size:16pt;font-family:Times New Roman;}
				TH{border:solid 1px #000000;font-size:18pt;font-family:Times New Roman;font-weight:bold;background-color:#DDDDDD;}
				.allborder{
					border-left:solid 1px #000000;
					border-right:solid 1px #000000;
					border-bottom:solid 1px #000000;
				}	
				.bottom{
					border-bottom:solid 1px #000000;
				}	
				.bottomright{
					border-bottom:solid 1px #000000;
					border-right:solid 1px #000000;
				}
				A:link {	
					text-decoration: none;
					color:	#003366;
				}				
				A:visited {	
					text-decoration: none;
					color: #003366;
				}	
				A:active {	
					text-decoration: none;
				 	color: #003366;
				}	
				A:hover	{
					text-decoration: underline;
					color: #FF9900;
				}
				</style>
			<body>'

		
		--unread reports
		DECLARE INNERSUPERCURS CURSOR
		FOR 
			SELECT distinct
				'<tr>
					<td class="allborder">
						<a href="' + @APPURL + '/MyInbox.aspx?reportID=' + CAST(r.ID as varchar) + '">'
							+  dbo.QStatus_GetUserNames(r.ID) + r.Name 
						+ '</a>
					</td>' as nameColumn,
					
					'<td class="bottom">' 
						+ ISNULL(left(Datename(dw, LastReportDate), 3) + '. ', 'No Status') 
				     + '</td>
					<td class="bottom">' 
						+ ISNULL(CONVERT(varchar, LastReportDate,1), '') 
				     + '</td>' 
						+ CASE WHEN LastReportDate = 0 Then
					'<td class="bottom">
						&nbsp;
					</td>
					<td class="bottomright">
						&nbsp;
					</td>'
						WHEN datediff(day, LastReportDate, getdate())=1 THEN
					'<td class="bottom">
						' + ltrim(right(convert(varchar, LastReportDate, 100), 7)) + '
					</td>
					<td class="bottomright">
						1&nbsp;Day&nbsp;Ago
					</td>'
						ELSE 
					'<td class="bottom">
						' + ltrim(right(convert(varchar, LastReportDate, 100), 7)) 
				     + '</td>
					<td class="bottomright">'
						+ CAST(datediff(day, LastReportDate, getdate()) as varchar) + '&nbsp;Days&nbsp;Ago'
				      +	'</td>'
						END as lastUpdatedColumn,
				       '<td class="bottom">' 
						+ CASE WHEN LastViewed = 0 Then 'Never Read' ELSE ISNULL(left(Datename(dw, LastViewed), 3) + '. ', 'Never Read') END
				     + '</td>
					<td class="bottom">' 
						+ CASE WHEN LastViewed = 0 Then '&nbsp;' ELSE ISNULL(CONVERT(varchar, LastViewed,1), '') END
				     + '</td>' 
						+ CASE WHEN LastViewed = 0 Then
					'<td class="bottom">

						&nbsp;
					</td>
					<td class="bottomright">
						&nbsp;
					</td>'
						WHEN datediff(day, LastViewed, getdate())=1 THEN
					'<td class="bottom">
						' + ltrim(right(convert(varchar, LastViewed, 100), 7)) + '
					</td>
					<td class="bottomright">
						1&nbsp;Day&nbsp;Ago
					</td>'
						ELSE 
					'<td class="bottom">
						' + ltrim(right(convert(varchar, LastViewed, 100), 7)) 
				     + '</td>
					<td class="bottomright">'
						+ CAST(datediff(day, LastViewed, getdate()) as varchar) + '&nbsp;Days&nbsp;Ago'
				      +	'</td>' END as LastViewedColumn,
					r.LastReportDate
				
			FROM
				QStatus_Supervisors sup
			INNER JOIN
				QStatus_SupervisorsLastViewed lv
			ON
				lv.ReportID = sup.ReportID
			AND
				lv.SupervisorUserID = @SuperID
			INNER JOIN
				QCheck_Groups g
			ON
				g.ID = sup.SupervisorGroupID
			INNER JOIN
				QCheck_GroupMembership gm
			ON
				gm.GroupID = g.ID		
			INNER JOIN
				QStatus_Report r
			ON
				sup.ReportID = r.ID
			and 
				r.isdeleted = 0
			INNER JOIN
				QCheck_Users u
			ON
				u.ID = @SuperID
			AND
				u.ID = gm.UserID
			inner join 
				QStatus_SupervisorEmailDefaults def
			on 
				def.EmailType = 'Unread'
			AND 	(
					(def.SupervisorType = 'Supervisor' AND sup.InterestedParty = 0)
						OR
					(def.SupervisorType = 'InterestedParty' AND sup.InterestedParty = 1)
				)
			left outer join 
				QStatus_SupervisorEmailPreferences pref
			ON
				pref.type = def.id
			AND
				pref.UserID = @SuperID
			where 
				isnull(pref.SendEmail, def.SendEmail) = 1
			AND
				sup.DirectSupervisor = 1
			AND
				r.LastReportDate > lv.LastViewed
			ORDER BY r.LastReportDate desc


			OPEN INNERSUPERCURS
			FETCH NEXT FROM INNERSUPERCURS INTO  @startText, @luText, @lrText, @dt
			WHILE @@FETCH_STATUS = 0 BEGIN		

				if @i = 0
					insert into 
					@html_output (row_html) 
					select '<span style=''font-size:20pt''><u><b>Unread Status Reports</b></u></span><br><br>' +
						'<table cellspacing=0 cellpadding=13>' +
						'<tr><th style="border-left:solid 1px #000000;">Name</th><th colspan=4>Last Updated</th><th  colspan=4>Last Read</th></tr>' 
						

				insert into 
					@html_output (row_html) 
					select  + @startText + @luText + @lrText + '</tr>'
				
				SELECT @i = @i + 1		

				FETCH NEXT FROM INNERSUPERCURS INTO  @startText, @luText, @lrText, @dt
			END
			CLOSE INNERSUPERCURS
			DEALLOCATE INNERSUPERCURS

			if @i > 0
				insert into 
					@html_output (row_html) 
					select '</table><br><hr><br>'

		
		--end of unread reports
		set @i = 0

		-- overdue items
		DECLARE INNEROVERDUECURS CURSOR
		FOR 

		select distinct r.[ID], 
			
			'<a href="' + @APPURL + '/MyInbox.aspx?reportID=' + CAST(r.ID as varchar) + '">'
				+  dbo.QStatus_GetUserNames(r.ID) + r.Name 
			+ '</a>', 
			c.name, 
			CONVERT(varchar, t.duetime, 101), 
			DateDiff(day, t.duetime, getDate())
		from Qcheck_activechecklists t
		inner join qcheck_checklistinstances i
		on
			t.InstanceID = i.ID
		and
			i.Isdeleted = 0
		inner join qcheck_checklists c
		on
			i.ChecklistID = c.ID
		and
			c.IsDeleted = 0
		inner join QStatus_ActiveChecklistTaskType actt
		ON
			actt.ActiveChecklistID = t.ID
		AND
			t.CompletedDate is null
		inner join QStatus_tasktypes tt
		on actt.tasktype = tt.ID
		and tt.Isdeleted = 0
		inner join QStatus_report r
		on tt.reportID = r.id
		and r.isdeleted = 0
		inner join QStatus_supervisors s
		on s.reportid = r.id
		and s.directsupervisor = 1
		INNER JOIN
			QStatus_SupervisorsLastViewed lv
		ON
			lv.ReportID = s.ReportID
		AND
			lv.SupervisorUserID = @SuperID
		INNER JOIN
			QCheck_Groups g
		ON
			g.ID = s.SupervisorGroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID	
		AND
			gm.UserID = @SuperID
		inner join 
			QStatus_SupervisorEmailDefaults def
		on 
			def.EmailType = 'Overdue'
		AND 	(
				(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
					OR
				(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
			)
		left outer join 
			QStatus_SupervisorEmailPreferences pref
		ON
			pref.type = def.id
		AND
			pref.UserID = @SuperID
		where 
			isnull(pref.SendEmail, def.SendEmail) = 1 
		AND
			t.duetime < (getdate()) 
		order by r.[ID], CONVERT(varchar, t.duetime, 101)
		
		OPEN INNEROVERDUECURS
			FETCH NEXT FROM INNEROVERDUECURS INTO  @ReportID, @StatusReport, @Task, @DueDate, @DaysOverdue
			WHILE @@FETCH_STATUS = 0 BEGIN		
				
				IF @i = 0
				insert into 
					@html_output (row_html) 
					select '<span style=''font-size:20pt''><u><b>Overdue Report</b></u></span><br><br>' +
						'<table cellspacing=0 cellpadding=7>' + 
						'<tr><th>Status Report</th><th>Task</th><th>Due Date</th><th>Days Overdue</th></tr>' 
						

				IF @i > 1 AND @StatusReport <> @PrevStatusReport 
				BEGIN
					insert into 
					@html_output (row_html) 
					select '<tr style="height:10px;"><td></td><td></td><td></td></tr>'
				END
	
				SET @PrevStatusReport = @StatusReport
				
				insert into 
					@html_output (row_html) 
					select '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@DueDate+'</td><td style="text-align:center;">'+CAST(@DaysOverdue as varchar)+'</td></tr>'
	
				SELECT @i = @i + 1

				FETCH NEXT FROM INNEROVERDUECURS INTO   @ReportID, @StatusReport, @Task, @DueDate, @DaysOverdue
			END
		CLOSE INNEROVERDUECURS
		DEALLOCATE INNEROVERDUECURS

			if @i > 0
				insert into 
					@html_output (row_html) 
					select '</table><br><hr><br>'

		--end of overdue
		set @i = 0
	
		-- due date changes
		DECLARE INNERDDCCURS CURSOR
		FOR 
		select 
			'<a href="' + @APPURL + '/MyInbox.aspx?reportID=' + CAST(ID as varchar) + '">'
				+  dbo.QStatus_GetUserNames(ID) + Name 
			+ '</a>', 
			a.description, 
			CONVERT(varchar, a.ddo, 101), 
			CONVERT(varchar, a.dd, 101)
		FROM
		(
			select distinct r.ID, r.name, c.name as description, convert(varchar, min(ddc.duedateold), 101) as ddo, isnull(convert(varchar, t.duetime, 101), 'No due date') as dd
			from QStatus_duedatechanges ddc
			inner join Qcheck_activechecklists t on ddc.activechecklistid = t.id
			inner join QCheck_ChecklistInstances i on i.ID = t.InstanceID and i.isdeleted = 0
			inner join QCheck_Checklists c on c.ID = i.ChecklistID and c.IsDeleted = 0
			inner join QStatus_ActiveChecklisttasktype actt on actt.ActiveChecklistID = t.ID
			inner join QStatus_TaskTypes tt on actt.TaskType = tt.ID
			inner join QStatus_report r on r.id = tt.reportID
			inner join QStatus_supervisors s on s.directsupervisor = 1
			and s.reportID = r.ID 
			INNER JOIN QCheck_Groups g ON g.ID = s.SupervisorGroupID
			INNER JOIN QCheck_GroupMembership gm ON gm.GroupID = g.ID	
			AND gm.UserID = @SuperID
			INNER JOIN QStatus_SupervisorsLastViewed lv ON lv.ReportID = s.ReportID
			AND lv.SupervisorUserID = @SuperID
			inner join 
				QStatus_SupervisorEmailDefaults def
			on 
				def.EmailType = 'DueDateChanges'
			AND 	(
					(def.SupervisorType = 'Supervisor' AND s.InterestedParty = 0)
						OR
					(def.SupervisorType = 'InterestedParty' AND s.InterestedParty = 1)
				)
			left outer join 
				QStatus_SupervisorEmailPreferences pref
			ON
				pref.type = def.id
			AND
				pref.UserID = @SuperID
			where 
				isnull(pref.SendEmail, def.SendEmail) = 1 
			AND 
				ddc.updatedt > getdate() - 1
			group by t.id, t.duetime, c.name, r.name, r.ID
			having isnull(min(ddc.duedateold),0)<>isnull(t.duetime,0)

		) a

		
		OPEN INNERDDCCURS
			FETCH NEXT FROM INNERDDCCURS INTO  @StatusReport, @Task, @OldDueDate, @DueDate
			WHILE @@FETCH_STATUS = 0 BEGIN		
								
				IF @i = 0
					insert into 
					@html_output (row_html) 
					select '<span style=''font-size:20pt''><u><b>Due Date Changes</b></u></span><br><br>' +
						'<table cellspacing=0 cellpadding=13>' +
						'<tr><th>Status Report</th><th>Task</th><th>Old Due Date</th><th>New Due Date</th></tr>' 
						
	
				IF @i > 1 AND @StatusReport <> @PrevStatusReport 
				BEGIN
					insert into 
					@html_output (row_html) 
					select '<tr style="height:10px;"><td></td><td></td><td></td><td></td></tr>'
				END
	
				SET @PrevStatusReport = @StatusReport
				
				insert into 
					@html_output (row_html) 
					select  '<tr><td>'+@StatusReport+'</td><td>'+@Task+'</td><td>'+@OldDueDate+'</td><td>'+@DueDate+'</td></tr>'
	
				
				SELECT @i = @i + 1

				FETCH NEXT FROM INNERDDCCURS INTO   @StatusReport, @Task, @OldDueDate, @DueDate
			END
		CLOSE INNERDDCCURS
		DEALLOCATE INNERDDCCURS

			if @i > 0
				insert into 
					@html_output (row_html) 
					select '</table><br><hr><br>'




	insert into @html_output (row_html) select '<br> <a href="'+@APPURL+'">'+@APPURL+'</a></body></html>'

	SELECT row_html FROM @html_output ORDER BY seq

	SET NOCOUNT OFF
END

























GO
/****** Object:  StoredProcedure [dbo].[QStatus_SupervisorsByLogin]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QStatus_SupervisorsByLogin] (
	@Login VARCHAR(50)
) AS

BEGIN

	SELECT 
		G.[ID],
		G.[Name]
	FROM
		QStatus_UserSupervisors us
		INNER JOIN QCheck_Users u
			ON us.UserID = u.[ID]
		INNER JOIN QCheck_Groups g
			ON us.SupervisorGroupID = g.[ID]
		WHERE
			u.ShortName = @Login

	/*
	SELECT
		G.[ID],
		G.[Name]
	FROM 
		QCheck_Users U
		INNER JOIN QStatus_Report R
			ON U.FullName = R.[Name]
			AND R.isdeleted = 0
		INNER JOIN QStatus_Supervisors S
			ON R.[ID] = S.ReportID
			AND S.DirectSupervisor = 1
			AND S.InterestedParty = 0
		INNER JOIN QCheck_Groups G
			ON S.SupervisorGroupID = G.[ID]
	WHERE
		U.ShortName = @Login
	*/
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus_SupervisorsListSP]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_SupervisorsListSP] (
	@UserID INT,
	@Supervisors VARCHAR(1000) OUTPUT
) AS

BEGIN

	SET @Supervisors = ''

	SELECT 
		@Supervisors = @Supervisors + FullName + ', '
	FROM
		dbo.QStatus_SupervisorsList(@UserID, DEFAULT)

	IF LEN(@Supervisors) > 2 BEGIN

		SET @Supervisors = LEFT(@Supervisors, LEN(@Supervisors) - 1)

	END

END


GO
/****** Object:  StoredProcedure [dbo].[QStatus_TaskReportList_Refresh]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create Proc [dbo].[QStatus_TaskReportList_Refresh]
	@ActiveChecklistID int = null
AS


IF @ActiveChecklistID is null 
BEGIN
	Truncate table QStatus_TaskReportList
END
ELSE
BEGIN
	DELETE FROM QStatus_TaskReportList
	WHERE ActiveChecklistID = @ActiveChecklistID
END

INSERT INTO QStatus_TaskReportList
select 
	distinct a.id, 
	u.id, 
	dbo.QStatus_GetChecklistReports(a.ID, u.id)
from qcheck_activechecklists a
INNER JOIN QCheck_ChecklistInstances b 
ON a.InstanceID = b.ID
INNER JOIN QCheck_Assignments f 
on f.InstanceID = b.ID	
INNER JOIN QCheck_GroupMembership gm 
on gm.groupid = f.groupid
INNER JOIN QCheck_Users u
on u.id = gm.UserID
WHERE (@ActiveChecklistID is null or @ActiveChecklistID = a.id)
GO
/****** Object:  StoredProcedure [dbo].[QStatus_ToggleAssigneeVisibility]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE                      PROCEDURE [dbo].[QStatus_ToggleAssigneeVisibility]
	@UserID int,
	@ReportID int
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ONOFF VARCHAR(20)

	DECLARE @NewPreference bit
	SET @NewPreference = 1

	UPDATE QStatus_Preferences
	SET PreferenceType = 	CASE PreferenceType
					WHEN 'AssigneeOn' THEN 'AssigneeOff'
					WHEN 'AssigneeOff' THEN 'AssigneeOn'
				END,
	@NewPreference = 0
	WHERE UserID = @UserID
	AND (PreferenceType = 'AssigneeOn' or PreferenceType = 'AssigneeOff')
	AND PreferenceValue = CAST(@ReportID as varchar(10))

	IF @NewPreference = 1
	BEGIN
		SET @ONOFF = 'AssigneeOn'
	
		DECLARE @Cnt int
		
		SELECT @Cnt = Count(distinct u.ID)
		FROM QStatus_GroupReport gr
		INNER JOIN QCheck_Groups g
		ON g.ID = gr.GroupID
		AND gr.ReportID = @ReportID
		INNER JOIN QCheck_GroupMembership gm
		ON gm.GroupID = g.ID
		INNER JOIN QCheck_Users u
		ON u.ID = gm.UserID
		AND u.IsDeleted = 0
		
		IF @Cnt > 1 SET @ONOFF = 'AssigneeOff'

		INSERT INTO QStatus_Preferences (UserID, PreferenceType, PreferenceValue)
		SELECT @UserID, @ONOFF, @ReportID
	END


	SET NOCOUNT OFF
END















GO
/****** Object:  StoredProcedure [dbo].[QStatus_ToggleInterestedParty]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO















CREATE                                  PROCEDURE [dbo].[QStatus_ToggleInterestedParty]
	@ID int,
	@Allow bit = 0
AS

	IF @Allow = 1
		update QStatus_Supervisors
		set InterestedParty = CASE WHEN InterestedParty = 1 THEN 0 ELSE 1 END 
		where id = @ID
	






GO
/****** Object:  StoredProcedure [dbo].[QStatus_UpdateMyTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[QStatus_UpdateMyTask]
	@TaskID int,
	@UserID int,
	@Description varchar(500),
	@DueDate datetime = NULL,
	@Priority int = NULL,
	@ReminderDate datetime = NULL
AS

BEGIN

	DECLARE @PrevPriority int,
		@DueDateOld datetime,
		@ReminderDateOld datetime,
		@NextDueDate datetime,
		@tmpstr varchar(50),
		@tmpdt datetime,
		@tmpremstr varchar(50),
		@tmpremdt datetime,
		@CurrentDueTime datetime,
		@FreqType int,
		@SchID int,
		@IsArchived bit,
		@ChecklistID int,
		@DescriptionOld varchar(500),
		@NumItems int,
		@LastReportStr varchar(100),
		@LastReportInt int
	
	SET @IsArchived = 0
			
	SELECT @ChecklistID = ChecklistID
	FROM
		QCheck_ChecklistInstances i
		inner join QCheck_ActiveChecklists ac 
			on ac.InstanceID = i.ID
			AND ac.ID = @TaskID

	IF @ChecklistID IS NULL BEGIN

		SELECT 
			@ChecklistID = ChecklistID
		FROM
			QCheck_ChecklistInstances i
			inner join QCheck_ActiveChecklistArchive ac 
				on ac.InstanceID = i.ID
				AND ac.ID = @TaskID

		SET @IsArchived = 1

	END
	
	SELECT @DescriptionOld = [Name]
	FROM QCheck_Checklists 
	WHERE [ID] = @ChecklistID	

	IF LEN(LTRIM(RTRIM(@Description))) > 0 BEGIN

		UPDATE QCheck_Checklists 
		SET [Name] = @Description
		WHERE [ID] = @ChecklistID

		IF LTRIM(RTRIM(@DescriptionOld)) <> LTRIM(RTRIM(@Description)) BEGIN
	
			INSERT INTO QStatus_TaskNameChanges (
				ChecklistID, 
				TaskOld, 
				UpdateDT
			) VALUES (
				@ChecklistID, 
				@DescriptionOld, 
				getDate()
			)
	
			SET @NumItems = 0
	
			SELECT @NumItems = Count([ID])
			FROM QCheck_Items 
			WHERE ChecklistID = @ChecklistID
	
			IF @NumItems = 1 BEGIN
	
				UPDATE QCheck_Items
				SET [Text] = @Description
				WHERE 
					ChecklistID = @ChecklistID
					AND [Text] = @DescriptionOld
	
			END
	
		END

	END


	SELECT @LastReportStr = preferencevalue 
	FROM qstatus_preferences
	WHERE
		userid = @UserID
		AND preferencetype = 'LastReport'

	IF @LastReportStr is not null BEGIN
		IF Isnumeric(@LastReportStr) = 1 BEGIN
			SELECT @LastReportInt = cast(@LastReportStr as int)
		END
	END

	--try to match up to your most recent status report
	SELECT 
		@PrevPriority = actt.Priority
	FROM 
		QStatus_ActiveChecklistTaskType actt
		inner join QStatus_TaskTypes tt
			on tt.ID = actt.TaskType
	WHERE 
		ActiveChecklistID = @TaskID
		AND (
			tt.ReportID = @LastReportInt
			OR @LastReportInt is null
		)

	--cant match - just use any random one
	IF @@Rowcount = 0 BEGIN
		SELECT 
			@PrevPriority = actt.Priority
		FROM 
			QStatus_ActiveChecklistTaskType actt
			inner join QStatus_TaskTypes tt
				on tt.ID = actt.TaskType
		WHERE 
			ActiveChecklistID = @TaskID
	END

	
	SET @PrevPriority = IsNull(@PrevPriority, 1)

	IF @Priority IS NULL OR @Priority > 500 BEGIN
		SELECT @Priority = @PrevPriority
	END
	
	IF @Priority <> @PrevPriority BEGIN
		INSERT INTO QStatus_PriorityChanges (
			ActiveChecklistID, 
			PriorityOld, 
			UpdateDT
		) VALUES (
			@TaskID, 
			@PrevPriority, 
			getDate()
		)	
	END

	
	SELECT @DueDateOld = DueTime
	FROM QCheck_ActiveChecklists
	WHERE [ID] = @TaskID

	SELECT @NextDueDate = min(udt.duetime)
	from 
		qcheck_upcomingduetimes udt
		inner join qcheck_activechecklists ac
			on ac.instanceid = udt.instanceid
			and ac.id = @TaskID

	-- Get the new due date preserving the time		
	SELECT @CurrentDueTime = DueTime
	FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID

	SET @tmpstr = CAST(MONTH(ISNull(@DueDate, @DueDateOld)) as varchar)+'/'+CAST(DAY(ISNull(@DueDate, @DueDateOld))as varchar)+'/'+CAST(YEAR(ISNull(@DueDate, @DueDateOld))as varchar) + ' ' + CAST(DATEPART(hh, @CurrentDueTime)as varchar)+':'+CAST(DATEPART(mi,@CurrentDueTime)as varchar)+':00'
	SET @tmpdt = CAST(@tmpstr as datetime)

	-- If the requested deadline does not run past the next occurrence of recurring tasks
	IF isnull(@NextDueDate, '1/1/9999') > @DueDate BEGIN
	
		-- If a due date was handed in and the task is active
		IF @DueDateOld is not null AND @DueDate is not null 
		BEGIN
			IF CONVERT(varchar, @DueDateOld, 101) <> CONVERT(varchar, @DueDate, 101) 
			BEGIN
				DECLARE @changedby varchar(100)
				SELECT @changedby = ShortName
				FROM
					QCheck_Users
				WHERE
					ID = @UserID

				INSERT INTO QStatus_DueDateChanges
				(ActiveChecklistID, DueDateOld, UpdateDT, changedby)
				VALUES
				(@TaskID, @DueDateOld, getDate(), @changedby)	
			END	
		END
		
		-- If this is a one-time task, need to update the schedule		
		SELECT @FreqType = s.FreqType, @SchID = s.ID
		FROM
			QCheck_ActiveChecklists ac
			INNER JOIN QCheck_ChecklistInstances i
				ON ac.InstanceID = i.ID
				AND ac.ID = @TaskID
			INNER JOIN QCheck_Schedule s
				ON s.ID = i.ScheduleID

		IF @FreqType = 1 BEGIN
			UPDATE QCheck_Schedule
			SET FirstDueDate = @tmpdt
			WHERE ID = @SchID
		END
		
	END ELSE BEGIN

		-- If the requested deadline is after the next due time, don't allow the change
		SET @tmpdt = @DueDateOld

	END

	-- Do the update.  We have to send in both DueTime and ReminderDate in the same update statement so the trigger on ActiveChecklists works correctly.  That's
	-- why we're doing the @tmpdt = @DueDateOld above if the due date isn't allowed to change.
	UPDATE QCheck_ActiveChecklists
	SET 
		DueTime = @tmpdt,
		ReminderDate = CASE
			WHEN ISNULL(@ReminderDate, '1/1/9999') <= ISNULL(@DueDate, @DueDateOld) THEN CONVERT(VARCHAR(10), @ReminderDate, 101) + RIGHT(CONVERT(VARCHAR(20), ReminderDate), 8)
			ELSE ReminderDate
		END
	WHERE ID = @TaskID

	UPDATE QStatus_ActiveChecklistTaskType
	SET [Priority]=@Priority
	FROM 
		QStatus_ActiveChecklistTaskType actt
		inner join QStatus_TaskTypes tt
			on tt.ID = actt.TaskType
	WHERE
		ActiveChecklistID = @TaskID
		AND (
			tt.ReportID = @LastReportInt
			OR @LastReportInt is null
		)

	IF @@rowcount = 0 BEGIN

		UPDATE QStatus_ActiveChecklistTaskType
		SET [Priority]=@Priority	
		WHERE ActiveChecklistID = @TaskID

	END
		


	UPDATE QStatus_Report
	SET LastReportDate = getDate()
	FROM 
		QStatus_Report r
		INNER JOIN QStatus_TaskTypes tt
			ON tt.ReportID = r.ID
			AND tt.IsDeleted = 0
		INNER JOIN QStatus_activechecklisttasktype actt
			ON actt.tasktype = tt.ID
			AND actt.ActiveChecklistID = @TaskID
	
	IF @IsArchived = 0 BEGIN
	
		SELECT 
			CASE WHEN @Priority = @PrevPriority THEN 0 ELSE 1 END as NeedsRefresh,
			c.[Name] as newTask,
			ac.DueTime as newDeadline,
			ISNULL(ac.ReminderDate, ac.DueTime) as newReminderDate,
			Case WHEN AC.CompletedDate is null then 0 ELSE 1 END AS Completed
		FROM 
			QCheck_Checklists c
			INNER JOIN QCheck_ActiveChecklists ac
				ON ac.[ID] = @TaskID
				AND c.[ID] = @ChecklistID
	
	END ELSE BEGIN
	
		SELECT 
			CASE WHEN @Priority = @PrevPriority THEN 0 ELSE 1 END as NeedsRefresh,
			c.[Name] as newTask,
			ac.DueTime as newDeadline,
			ISNULL(ac.ReminderDate, ac.DueTime) as newReminderDate,
			Case WHEN AC.CompletedDate is null then 0 ELSE 1 END AS Completed
		FROM 
			QCheck_Checklists c
			INNER JOIN QCheck_ActiveChecklistArchive ac
				ON ac.[ID] = @TaskID
				AND c.[ID] = @ChecklistID	
			
	END

END



GO
/****** Object:  StoredProcedure [dbo].[QStatus_UpdateReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







CREATE                       PROCEDURE [dbo].[QStatus_UpdateReport]
	@ReportID int,
	@Name varchar(50)
AS
BEGIN

		UPDATE
			QStatus_Report
		SET 
			[Name] = @Name, IsDirty = 1
		WHERE 
			ID = @ReportID
			and name not in (select fullname from qcheck_users where isdeleted = 0)
					
END















































GO
/****** Object:  StoredProcedure [dbo].[QStatus_UpdateSectionName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE                 PROCEDURE [dbo].[QStatus_UpdateSectionName]
	@TaskID int,
	@Description VARCHAR(50)
AS
BEGIN

	UPDATE
		QStatus_TaskTypes
	SET 
		Description = @Description
	WHERE	
		ID = @TaskID
END



































GO
/****** Object:  StoredProcedure [dbo].[QStatus_UpdateStatusTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE                                  PROCEDURE [dbo].[QStatus_UpdateStatusTask]
	@TaskID int,
	@UserID int,
	@Comments varchar(1500),
	@CommentsID int
AS
BEGIN
	
	DECLARE @CommentsInitials VARCHAR(100)
	DECLARE @NewID int
	
	SELECT @CommentsInitials = fullname--UPPER(LEFT(ShortName, 2))
	FROM
		QCheck_Users
	WHERE
		ID = @UserID
	

	IF LEN(LTRIM(RTRIM(@Comments))) >0
		BEGIN	
			IF @CommentsID > 0
				BEGIN
					UPDATE QStatus_Comments
					SET 
						Comments = @Comments,
						CommentDt = getDate()
					WHERE
						ID = @CommentsID
						--AND Comments <> @Comments
					
				END	
			ELSE
				BEGIN
					DECLARE @DisplayOrder int
					SELECT 	@DisplayOrder = ISNULL(Max(DisplayOrder), 0)
					FROM
						QStatus_Comments
					WHERE 
						ForeignKeyID = @taskID

					INSERT INTO
							QStatus_Comments
					(ForeignKeyID, Comments, DisplayOrder, CommentDt, Initials, UserID, SpecialTask)
					VALUES
					(ABS(@taskID), @Comments, @DisplayOrder + 1, getDate(), @CommentsInitials, @UserID, CASE WHEN @taskID > 0 then 0 else 1 End)

					SELECT @NewID = @@IDENTITY
				
					
				END
		END	
	ELSE
		BEGIN
			IF @CommentsID > 0 
			BEGIN
				DELETE FROM QStatus_Comments
				WHERE 
					ID = @CommentsID
				AND
					LEN(Comments) > 0
				
			END
		END

	DELETE FROM QStatus_Comments
	WHERE 
		ForeignKeyID = @taskID
	AND
		LEN(Comments) = 0
	AND 
		ID <> @CommentsID

	DELETE FROM QStatus_CommentArchive
	WHERE 
		ForeignKeyID = @taskID
	AND
		LEN(Comments) = 0
	AND 
		ID <> @CommentsID

END




































GO
/****** Object:  StoredProcedure [dbo].[QStatus_UpdateTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE	PROCEDURE [dbo].[QStatus_UpdateTask]
	@ReportID int,
	@TaskID int,
	@UserID int,
	@Description varchar(500),
	@DueDate datetime = NULL,
	@Priority int = NULL,
	@Comments varchar(1500) = '',
	@CommentsID int = -1
AS
BEGIN

	DECLARE @PrevPriority int
	DECLARE @DueDateOld datetime,
		@NextDueDate datetime
	DECLARE @tmpstr varchar(50)
	DECLARE @tmpdt datetime
	DECLARE @CurrentDueTime datetime
	DECLARE @FreqType int
	DECLARE @SchID int
			

	declare @ChecklistID int
	SELECT @ChecklistID = ChecklistID
	FROM
		QCheck_ChecklistInstances i
	inner join
		QCheck_ActiveChecklists ac 
	on
		ac.InstanceID = i.ID
	AND
		ac.ID = @TaskID

	DECLARE @DescriptionOld varchar(100)
	SELECT @DescriptionOld = Name
	FROM QCheck_Checklists 
	WHERE [ID] = @ChecklistID

	update QCheck_Checklists 
	SET
		Name = @Description
	WHERE [ID] = @ChecklistID
	
	IF @DescriptionOld <> @Description
	BEGIN
		INSERT INTO QStatus_TaskNameChanges
		(ChecklistID, TaskOld, UpdateDT)
		VALUES
		(@ChecklistID, @DescriptionOld, getDate())	

		DECLARE @NumItems int
		SET @NumItems = 0

		SELECT @NumItems = Count(ID)
		FROM QCheck_Items 
		WHERE ChecklistID = @ChecklistID

		IF @NumItems = 1
		BEGIN
			UPDATE QCheck_Items
			SET Text = @Description
			WHERE ChecklistID = @ChecklistID
			AND Text = @DescriptionOld
		END

	END

	SELECT @PrevPriority = actt.Priority
		FROM QStatus_ActiveChecklistTaskType actt
		inner join QStatus_TaskTypes tt
		on tt.ID = actt.TaskType
		WHERE ActiveChecklistID = @TaskID
	

	SET @PrevPriority = IsNull(@PrevPriority, 1)

	IF @Priority IS NULL OR @Priority > 500 SELECT @Priority = @PrevPriority
	
	
	IF @Priority <> @PrevPriority 
		INSERT INTO QStatus_PriorityChanges
		(ActiveChecklistID, PriorityOld, UpdateDT)
		VALUES
		(@TaskID, @PrevPriority, getDate())	

	SELECT @DueDateOld = DueTime
	FROM QCheck_ActiveChecklists
	WHERE ID = @TaskID


	SELECT @NextDueDate = min(udt.duetime)
	from qcheck_upcomingduetimes udt
	inner join qcheck_activechecklists ac
	on ac.instanceid = udt.instanceid
	and ac.id = @TaskID

	
	IF isnull(@NextDueDate, '1/1/9999') > @DueDate
	BEGIN

		IF @DueDateOld is not null AND @DueDate is not null 
		BEGIN
			IF CONVERT(varchar, @DueDateOld, 101) <> CONVERT(varchar, @DueDate, 101) 
			BEGIN
				DECLARE @changedby varchar(100)
				SELECT @changedby = ShortName
				FROM
					QCheck_Users
				WHERE
					ID = @UserID

				INSERT INTO QStatus_DueDateChanges
				(ActiveChecklistID, DueDateOld, UpdateDT, changedby)
				VALUES
				(@TaskID, @DueDateOld, getDate(), @changedby)	
			END	
		END
	
	END
	
	IF LEN(LTRIM(RTRIM(@Comments))) >0
		BEGIN

			DECLARE @CommentsInitials VARCHAR(100)

			SELECT @CommentsInitials = fullname--UPPER(LEFT(ShortName, 2))
			FROM
				QCheck_Users
			WHERE
				ID = @UserID
			
			IF @CommentsID > 0
			BEGIN
				UPDATE QStatus_Comments
				SET 
					Comments = @Comments,
					CommentDt = getDate()
				WHERE
					ID = @CommentsID
				--AND 
					--Comments <> @Comments
			END
			ELSE
			BEGIN
				DECLARE @DisplayOrder int
					SELECT 	@DisplayOrder = ISNULL(Max(DisplayOrder), 0)
					FROM
						QStatus_Comments
					WHERE 
						ForeignKeyID = ABS(@TaskID)
					AND
						(@TaskID > 0 and SpecialTask = 0)
					OR
						(@TaskID < 0 and SpecialTask = 1)

				INSERT INTO
						QStatus_Comments
				(ForeignKeyID, Comments, DisplayOrder, CommentDt, Initials, UserID, SpecialTask)
				VALUES
				(ABS(@TaskID), @Comments, @DisplayOrder + 1, getDate(), @CommentsInitials, @UserID, CASE WHEN @taskID > 0 then 0 else 1 End)
			END
			
			
			SELECT @CurrentDueTime = DueTime
			FROM QCheck_ActiveChecklists
			WHERE ID = @TaskID
	

			SET @tmpstr = CAST(MONTH(ISNull(@DueDate, @DueDateOld)) as varchar)+'/'+CAST(DAY(ISNull(@DueDate, @DueDateOld))as varchar)+'/'+CAST(YEAR(ISNull(@DueDate, @DueDateOld))as varchar) + ' ' + CAST(DATEPART(hh, @CurrentDueTime)as varchar)+':'+CAST(DATEPART(mi,@CurrentDueTime)as varchar)+':00'
			SET @tmpdt = CAST(@tmpstr as datetime)

			SELECT @FreqType = s.FreqType, @SchID = s.ID
			FROM
				QCheck_ActiveChecklists ac
			INNER JOIN
				QCheck_ChecklistInstances i
			ON
				ac.InstanceID = i.ID
			AND
				ac.ID = @TaskID
			INNER JOIN
				QCheck_Schedule s
			ON
				s.ID = i.ScheduleID

			IF @FreqType = 1 
				BEGIN
					UPDATE QCheck_Schedule
					SET FirstDueDate = @tmpdt
					WHERE ID = @SchID
				END
			
			IF isnull(@NextDueDate, '1/1/9999') > @DueDate
				UPDATE 	QCheck_ActiveChecklists
				SET DueTime = 	@tmpdt
				WHERE ID = @TaskID

			UPDATE QStatus_ActiveChecklistTaskType
				SET /*[Description]=@Description, 
				[DueDate]=@DueDate, */
				[Priority]=@Priority/*, 
				[UpdatedDate]=getDate()*/
			WHERE
				ActiveChecklistID = @TaskID
		END	
	ELSE
		BEGIN
			IF @CommentsID > 0 
			BEGIN
				DELETE FROM QStatus_Comments
				WHERE ID = @CommentsID
				AND
					LEN(Comments) > 0
			END

			SELECT @CurrentDueTime = DueTime
			FROM QCheck_ActiveChecklists
			WHERE ID = @TaskID
	

			SET @tmpstr = CAST(MONTH(ISNull(@DueDate, @DueDateOld)) as varchar)+'/'+CAST(DAY(ISNull(@DueDate, @DueDateOld))as varchar)+'/'+CAST(YEAR(ISNull(@DueDate, @DueDateOld))as varchar) + ' ' + CAST(DATEPART(hh, @CurrentDueTime)as varchar)+':'+CAST(DATEPART(mi,@CurrentDueTime)as varchar)+':00'
			SET @tmpdt = CAST(@tmpstr as datetime)

			
			SELECT @FreqType = s.FreqType, @SchID = s.ID
			FROM
				QCheck_ActiveChecklists ac
			INNER JOIN
				QCheck_ChecklistInstances i
			ON
				ac.InstanceID = i.ID
			AND
				ac.ID = @TaskID
			INNER JOIN
				QCheck_Schedule s
			ON
				s.ID = i.ScheduleID

			IF @FreqType = 1 
				BEGIN
					UPDATE QCheck_Schedule
					SET FirstDueDate = @tmpdt
					WHERE ID = @SchID
				END
			
			IF isnull(@NextDueDate, '1/1/9999') > @DueDate
				UPDATE 	QCheck_ActiveChecklists
				SET DueTime = 	@tmpdt
				WHERE ID = @TaskID

			/*UPDATE QStatus_Tasks
					SET [Description]=@Description, 
					[DueDate]=@DueDate, 
					[Priority]=@Priority,
					[UpdatedDate]=getDate()
			WHERE NOT EXISTS
				(SELECT @TaskID 
				FROM QStatus_Tasks
				WHERE [Description]=@Description
				AND IsNull([DueDate],0)=IsNull(@DueDate,0) 
				AND [Priority]=@Priority
				AND ID = @TaskID)

			AND ID = @TaskID*/

			UPDATE QStatus_ActiveChecklistTaskType
				SET /*[Description]=@Description, 
				[DueDate]=@DueDate, */
				[Priority]=@Priority/*, 
				[UpdatedDate]=getDate()*/
			WHERE
				ActiveChecklistID = @TaskID
		END


	DELETE FROM QStatus_Comments
	WHERE 
		ForeignKeyID = @TaskID
	AND
		LEN(Comments) = 0
	AND 
		ID <> @CommentsID

	UPDATE
		QStatus_Report
	SET 
		LastReportDate = getDate()
	WHERE
		ID = @ReportID
	
	
END





GO
/****** Object:  StoredProcedure [dbo].[QStatus_UpdateTaskPriority]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO












CREATE                 PROCEDURE [dbo].[QStatus_UpdateTaskPriority]
	@InstanceID int,
	@Priority int 
AS
BEGIN
	
	UPDATE QStatus_ActiveChecklistTaskType
	set Priority = @Priority
	FROM QStatus_ActiveChecklistTaskType actt
	INNER JOIN QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	AND
		ac.InstanceID = @InstanceID
	
END










GO
/****** Object:  StoredProcedure [dbo].[QStatus_UserCommentsNag]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_UserCommentsNag]
AS

SET NOCOUNT ON

	DECLARE @FilterToDomain bit

	DECLARE @startText varchar(1000)
	
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)
	SELECT @mailType = 'text/html'
	SELECT @mailSubject = 'Status Report Reminder'
	DECLARE @userid int
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	declare @notupdated table(
		email varchar(1000),
		role varchar(20),
		userID int,
		appURL varchar(1000),
		reportName varchar(1000),
		lastcommented varchar(100)
	)

	SELECT @BaseDomain = BaseDomain, @FilterToDomain = FilterToDomain
	FROM QCheck_AppSettings where [id] = 1

	insert into @notupdated
		SELECT DISTINCT  u.email, 'Controller' as role, u.ID, app.appURL, r.Name, 
			CASE WHEN lastcomment.dayssince = 1 THEN 'last commented yesterday'
			ELSE
				isnull('last commented ' + cast(lastcomment.dayssince as varchar)+' days ago', 'never commented')
			END
			
				FROM
					QStatus_GroupReport gr
				INNER JOIN 
					QCheck_Groups g
				ON
					g.ID = gr.GroupID
				INNER JOIN
					QCheck_GroupMembership gm
				ON
					gm.GroupID = g.ID
				INNER JOIN
					QStatus_Report r
				ON
					r.ID = gr.ReportID
				AND
					r.IsDeleted = 0
				INNER JOIN
					QCheck_Users u
				ON
					u.ID = gm.UserID
				INNER JOIN
					QCheck_AppSettings app
				ON
					app.ID = u.App
				LEFT OUTER JOIN
				(
					SELECT reportID, UserID, datediff(day, commentdt, getdate()) as dayssince
					from qstatus_reportlastestcomments			
				) lastcomment
				on lastcomment.reportID = r.ID
				and lastcomment.userID = u.ID
			INNER JOIN qpi_users q on u.id = q.id
		WHERE (lastcomment.dayssince > 0 OR lastcomment.dayssince IS NULL)
		AND Not u.ShortName = 'graynor'
		AND Not u.ShortName = 'rmccormick'
		AND Not u.ShortName = 'dgillespie'
		AND len(u.Email) > 0
		AND u.IsDeleted = 0
		/*AND NOT r.ID in
			(SELECT ReportID
				FROM qstatus_onhold
			WHERE startdt < getdate() and enddt > getdate()
			)*/
		
		UNION ALL
		
			SELECT DISTINCT u.email, 'Supervisor' as role, u.ID, app.appURL, r.Name,
				CASE WHEN lastcomment.dayssince = 1 THEN 'last commented yesterday'
				ELSE
					isnull('last commented ' + cast(lastcomment.dayssince as varchar)+' days ago', 'never commented')
				END
			FROM
					QStatus_Supervisors s
				INNER JOIN 
					QCheck_Groups g
				ON
					g.ID = s.SupervisorGroupID
				AND
					s.DirectSupervisor = 1
				AND
					s.InterestedParty = 0
				INNER JOIN
					QCheck_GroupMembership gm
				ON
					gm.GroupID = g.ID
				INNER JOIN
					QStatus_Report r
				ON
					r.ID = s.ReportID
				AND
					r.IsDeleted = 0
				INNER JOIN
					QCheck_Users u
				ON
					u.ID = gm.UserID
				INNER JOIN
					QCheck_AppSettings app
				ON
					app.ID = u.App
				LEFT OUTER JOIN
				(
					SELECT reportID, UserID, datediff(day, commentdt, getdate()) as dayssince
					from qstatus_reportlastestcomments			
				) lastcomment
				on lastcomment.reportID = r.ID
				and lastcomment.userID = u.ID
			INNER JOIN qpi_users q on u.id = q.id
		WHERE (lastcomment.dayssince > 0 OR lastcomment.dayssince IS NULL)
		AND Not u.ShortName = 'graynor'
		AND Not u.ShortName = 'rmccormick'
		AND Not u.ShortName = 'dgillespie'
		AND len(u.Email) > 0
		AND u.IsDeleted = 0
		/*AND NOT r.ID in
			(SELECT ReportID
				FROM qstatus_onhold
			WHERE startdt < getdate() and enddt > getdate()
			)*/

		order by 1, 2
		



	DECLARE USERCURS CURSOR
	FOR 
		select distinct email, userid, appURL
		FROM @notupdated
		WHERE 
			@FilterToDomain = 0
			OR 
			email like '%' + @BaseDomain

	OPEN USERCURS

	FETCH NEXT FROM USERCURS INTO @mailTo, @userid, @AppURL
	WHILE @@FETCH_STATUS = 0 BEGIN

	SET @mailBody = 
	'<style>TH,TD{border: solid 1px #000000;}</style>'

	SET @mailBody = @mailBody + 'As you know, the ' + @AppName + ' grading system deducts points from your grade for each status report on which you haven''t commented in the last 10 days.<BR><BR>'

	
 	SET @mailBody = @mailBody + '
	To help you know which status reports need comments, the following report shows when you last commented.<BR><BR>
	Please update these status reports at <a href="'+@AppURL+'">'+@AppURL+'</a><BR><BR>
	'

	SET @mailBody = @mailBody + 'If you think you should not be required to comment at least every 10 days on any of the status reports below, please send a request to ' + @AppName + ' Grading and request approval to have them removed from the grading system.<br><br>
	'

	SET @mailBody = @mailBody + '
	<table cellspacing=0 cellpadding=8><tr><th>Your Role</th><th>Status Report</th><th>Issue</th></tr>'



	SELECT @mailBody = @mailBody + 
	'<tr><td>'+role+'</td><td>'+reportName+'</td><td>'+ lastcommented+'</td></tr>' + char(13) + char(10)
	FROM @notupdated
	WHERE userid = @userid
	order by role, reportName

	SELECT @mailBody = @mailBody + '</table>'

		EXEC XPSendEmail
		    @FROM       = @mailFrom,
		    @TO         = @mailTo,
		    @subject    = @mailSubject,
		    @message    = @mailBody,
		    @type       = @mailType,
		    @server     = @mailServer
		
		FETCH NEXT FROM USERCURS INTO @mailTo, @userid, @AppURL
	
	END
	CLOSE USERCURS
	DEALLOCATE USERCURS


SET NOCOUNT OFF




































GO
/****** Object:  StoredProcedure [dbo].[QStatus_UserNag]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[QStatus_UserNag]
AS

	DECLARE @startText varchar(1000)
	
	DECLARE @mailTo VARCHAR(100)
	DECLARE @mailSubject VARCHAR(500)
	DECLARE @mailBody VARCHAR(8000)
	DECLARE @mailType VARCHAR(100)
	SELECT @mailType = 'text/html'
	SELECT @mailSubject = 'Status Report Reminder'
	DECLARE @userid int
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE @MailFrom VARCHAR(500) = @AppName + '-Alert<' + REPLACE(@FromAddress, @AppName, @AppName + '-Alert') + '>'
	
	declare @notupdated table(
		email varchar(1000),
		userID int,
		appURL varchar(1000),
		reportName varchar(1000)
	)

	insert into @notupdated

		SELECT DISTINCT u.Email, u.ID, a.AppURL, r.name
		FROM
			QStatus_GroupReport gr
		INNER JOIN 
			QCheck_Groups g
		ON
			g.ID = gr.GroupID
		INNER JOIN
			QCheck_GroupMembership gm
		ON
			gm.GroupID = g.ID
		INNER JOIN
			QStatus_Report r
		ON
			r.ID = gr.ReportID
		AND
			r.IsDeleted = 0
		AND
			r.LastReportDate > 0
		AND
			(
				CONVERT(varchar,ISNULL(r.LastReportDate,0), 101) <> CONVERT(varchar,getdate(), 101)
			    AND
				isnull(r.LastReportDate,0) <> 0
			)
		INNER JOIN
			QCheck_Users u
		ON
			u.ID = gm.UserID
		INNER JOIN
			QCheck_AppSettings a
		ON
			a.ID = u.App
		AND Not u.ShortName = 'graynor'
		AND Not u.ShortName = 'rmccormick'
		AND Not u.ShortName = 'dgillespie'
		AND len(u.Email) > 0


	DECLARE USERCURS CURSOR
	FOR 
		select distinct email, userid, appURL
		FROM @notupdated

	OPEN USERCURS

	FETCH NEXT FROM USERCURS INTO @mailTo, @userid, @AppURL
	WHILE @@FETCH_STATUS = 0 BEGIN

	SET @mailBody = 'The following status reports have not been updated today.  Please update your status at <a href="'+@AppURL+'">'+@AppURL+'</a>.<br><ul>'
			
	SELECT @mailBody = @mailBody + '<li>'+reportName + '</li>'
	FROM @notupdated
	WHERE userid = @userid
	order by reportName

	SELECT @mailBody = @mailBody + '</ul>'

			EXEC XPSendEmail
			    @FROM       = @mailFrom,
			    @TO         = @mailTo,
			    @subject    = @mailSubject,
			    @message    = @mailBody,
			    @type       = @mailType,
			    @server     = @mailServer
		
		
		FETCH NEXT FROM USERCURS INTO @mailTo, @userid, @AppURL
	
	END
	CLOSE USERCURS
	DEALLOCATE USERCURS
























GO
/****** Object:  StoredProcedure [dbo].[QStatus2_AddReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[QStatus2_AddReport]
	@GroupID int,
	@ReportName varchar(50) = null,
	@ReturnID int output 
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @ReportID int

	INSERT INTO QStatus_Report
	([Name])
	VALUES
	(ISNULL(@ReportName,'New Report'))
	
	SELECT @ReportID = SCOPE_IDENTITY()

	select @ReturnID = @ReportID

	INSERT INTO QStatus_GroupReport
	(GroupID, ReportID)
	VALUES
	(@GroupID, @ReportID)
		
	EXEC QStatus_Init @ReportID


	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus2_AddSection]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
--Add a section to a status report

CREATE PROCEDURE [dbo].[QStatus2_AddSection]
	@ReportID int,
	@ReturnID int output
AS
BEGIN
	
	--check current number, if there are more than 15, then don't add
	SELECT 
		ID
	FROM
		QStatus_TaskTypes
	WHERE	
		ReportID = @ReportID

	IF @@ROWCOUNT < 150
	BEGIN
		--get the max display order so it can be added at the end
		DECLARE @DisplayOrder INT
		SELECT @DisplayOrder = MAX(DisplayOrder) + 1
		FROM QStatus_TaskTypes
		WHERE
			ReportID = @ReportID

		--insert the new section with the name 'new section'
		INSERT INTO QStatus_TaskTypes
		(ReportID, [Description], DisplayOrder)
		VALUES
		(@ReportID, 'New Section', @DisplayOrder)
		SELECT @ReturnID = @@IDENTITY
	END
END
GO
/****** Object:  StoredProcedure [dbo].[QStatus2_GetAlertTimes]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[QStatus2_GetAlertTimes](
	@ActiveChecklistID int,
	@IsCurrent bit,
	@IsArchived bit
)	
 AS

	
	IF @IsCurrent = 1 AND @IsArchived = 0
	BEGIN
		select 
			CASE a.AlertType 
				WHEN 'Reminder' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				WHEN 'Custom' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				ELSE
					ac.DueTime
			END
			as alerttime,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Custom' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Complete' THEN
					'When Completed'
				ELSE
					CAST(ac.DueTime as varchar(50))
			END
			as alerttimetext,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					dbo.QCheck_AssigneesList(ac.instanceID)
				ELSE
					u.FullName
			END as alertee,
			CASE a.AlertType
				WHEN 'Complete' THEN
					'When Completed'
				WHEN 'Overdue' THEN
					'When Overdue'
				WHEN 'Hours' THEN
					'Every '+cast(a.AlertTime as varchar(10))+' hours after overdue'
				ELSE
					a.AlertType
			END as type,
			CASE WHEN aa.senttime is null then 0 else 1 end as issent,
			CASE a.AlertType
				WHEN 'Complete' THEN 4
				WHEN 'Overdue' THEN 2
				WHEN 'Hours' THEN 3
				ELSE 1
			END as typeid
		from qcheck_alerts a
		inner join qcheck_activealerts aa
		on a.id = aa.alertid
		and aa.activechecklistid = @ActiveChecklistID
		inner join qcheck_activechecklists ac
		on ac.id = @ActiveChecklistID
		left outer join qcheck_groups g
		on g.id = a.alerteegroupid
		left outer join qcheck_groupmembership gm
		on gm.groupid = g.id
		left outer join qcheck_users u
		on u.id = gm.userid
		where a.alerttype in ('Custom', 'Complete', 'Overdue', 'Hours', 'Reminder')
		and a.IsDeleted = 0
		order by typeid, alerttime
	END 
	ELSE IF @IsCurrent = 0
		BEGIN
		select 
			CASE a.AlertType 
				WHEN 'Reminder' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime))
				WHEN 'Custom' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime))
				ELSE
					udt.DueTime
			END
			as alerttime,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Custom' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, udt.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Complete' THEN
					'When Completed'
				ELSE
					CAST(udt.DueTime as varchar(50))
			END
			as alerttimetext,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					dbo.QCheck_AssigneesList(udt.instanceID)
				ELSE
					u.FullName
			END as alertee,
			CASE a.AlertType
				WHEN 'Complete' THEN
					'When Completed'
				WHEN 'Overdue' THEN
					'When Overdue'
				WHEN 'Hours' THEN
					'Every '+cast(a.AlertTime as varchar(10))+' hours after overdue'
				ELSE
					a.AlertType
			END as type,
			0 issent,
			CASE a.AlertType
				WHEN 'Complete' THEN 4
				WHEN 'Overdue' THEN 2
				WHEN 'Hours' THEN 3
				ELSE 1
			END as typeid
		from qcheck_alerts a
		inner join qcheck_upcomingduetimes udt
		on udt.id = @ActiveChecklistID
		and a.instanceid = udt.instanceid
		left outer join qcheck_groups g
		on g.id = a.alerteegroupid
		left outer join qcheck_groupmembership gm
		on gm.groupid = g.id
		left outer join qcheck_users u
		on u.id = gm.userid
		where a.alerttype in ('Custom', 'Complete', 'Overdue', 'Hours', 'Reminder')
		and a.IsDeleted = 0
		order by typeid, alerttime
	END
	ELSE -- @IsArchived = 1
	BEGIN
		select 
			CASE a.AlertType 
				WHEN 'Reminder' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				WHEN 'Custom' THEN
						DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime))
				ELSE
					ac.DueTime
			END
			as alerttime,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Custom' THEN
					CAST(DateAdd(Hour, a.alerttime, Cast(Convert(varchar, DateAdd(Day, -1 * a.DaysBefore, ac.DueTime), 101) as datetime)) as varchar(50))
				WHEN 'Complete' THEN
					'When Completed'
				ELSE
					CAST(ac.DueTime as varchar(50))
			END
			as alerttimetext,
			CASE a.AlertType 
				WHEN 'Reminder' THEN
					dbo.QCheck_AssigneesList(ac.instanceID)
				ELSE
					u.FullName
			END as alertee,
			CASE a.AlertType
				WHEN 'Complete' THEN
					'When Completed'
				WHEN 'Overdue' THEN
					'When Overdue'
				WHEN 'Hours' THEN
					'Every '+cast(a.AlertTime as varchar(10))+' hours after overdue'
				ELSE
					a.AlertType
			END as type,
			CASE WHEN aa.senttime is null then 0 else 1 end as issent,
			CASE a.AlertType
				WHEN 'Complete' THEN 4
				WHEN 'Overdue' THEN 2
				WHEN 'Hours' THEN 3
				ELSE 1
			END as typeid
		from qcheck_alerts a
		inner join qcheck_activealertarchive aa
		on a.id = aa.alertid
		and aa.activechecklistid = @ActiveChecklistID
		inner join qcheck_activechecklistarchive ac
		on ac.id = @ActiveChecklistID
		left outer join qcheck_groups g
		on g.id = a.alerteegroupid
		left outer join qcheck_groupmembership gm
		on gm.groupid = g.id
		left outer join qcheck_users u
		on u.id = gm.userid
		where a.alerttype in ('Custom', 'Complete', 'Overdue', 'Hours', 'Reminder')
		and a.IsDeleted = 0
		order by typeid, alerttime

	END
GO
/****** Object:  StoredProcedure [dbo].[QStatus2_GetReportIDBySectionID]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[QStatus2_GetReportIDBySectionID]
	-- Add the parameters for the stored procedure here
	@SectionID int 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT ReportID FROM QStatus_TaskTypes WHERE ID=@SectionID
END
GO
/****** Object:  StoredProcedure [dbo].[RefreshTaskSearchCache]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[RefreshTaskSearchCache] AS

BEGIN

	TRUNCATE TABLE TaskSearchCache

	INSERT INTO TaskSearchCache (
		Name,
		Due,
		Completed,
		Assignees,
		Controllers,
		Schedule,
		LastCompletedBy,
		LastCompletedDate,
		ChecklistID,
		InstanceID,
		ActiveChecklistID,
		SearchColumn
	)
		SELECT DISTINCT
			c.Name AS [Name],
			CONVERT(VARCHAR(20), ac.DueTime) AS Due,
			CASE WHEN ac.CompletedDate IS NULL THEN 'No' ELSE 'Yes' END AS Completed,
			REPLACE(dbo.QCheck_FullAssigneesList(ci.ID), '&nbsp;', ' ') AS Assignees,
			dbo.QCheck_ManagersList(c.ID) As Controllers,
			dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule,
			ISNULL(acu.FullName, 'N/A') AS LastCompletedBy,
			ISNULL(CONVERT(VARCHAR(20), lc.CompletedDate), 'Never') AS LastCompletedDate,
			c.ID AS ChecklistID,
			ci.ID AS InstanceID,
			ac.ID AS ActiveChecklistID,
			c.Name + ' ' + REPLACE(dbo.QCheck_FullAssigneesList(ci.ID), '&nbsp;', ' ') + ' ' + dbo.QCheck_ManagersList(c.ID) + ' ' + ISNULL(acu.FullName, '')
		FROM
			dbo.QCheck_Checklists c
			INNER JOIN dbo.QCheck_ChecklistInstances ci
				ON c.ID = ci.ChecklistID
				AND c.IsDeleted = 0
				AND ci.IsDeleted = 0
			INNER JOIN dbo.QCheck_ActiveChecklists ac
				ON ci.ID = ac.InstanceID
			LEFT OUTER JOIN (
				SELECT 
					InstanceID,
					MAX(CompletedDate) AS CompletedDate
				FROM
					dbo.QCheck_ActiveChecklists_All
				WHERE
					CompletedDate IS NOT NULL
				GROUP BY
					InstanceID
			) lc
				ON ci.ID = lc.InstanceID
			LEFT OUTER JOIN dbo.QCheck_ActiveChecklists_All aca
				ON lc.InstanceID = aca.InstanceID
				AND lc.CompletedDate = ISNULL(aca.CompletedDate, '1/1/1900')
			LEFT OUTER JOIN dbo.QCheck_Users acu
				ON aca.CompletedBy = acu.ID
		
END
GO
/****** Object:  StoredProcedure [dbo].[Report_TasksCreated]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[Report_TasksCreated]
	@WeekCount int = 3,
	@ShowAll bit = 0
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @Columns varchar(1000) = '', @ColumnsIsNull varchar(1000) = '', @ColumnsSum varchar(1000) = ''

	;WITH cte_weeks AS
	(
		SELECT @WeekCount wk, DateAdd(day, (DatePart(dw, GETDATE()) - 1) * -1, CAST(GETDATE() AS DATE)) dt
		UNION ALL
		SELECT wk - 1 wk, DATEADD(wk, -1, dt) dt
		FROM cte_weeks
		WHERE wk-1 > 0
	)
	SELECT dt INTO ##dates FROM cte_weeks order by wk

	--SELECT * FROM ##dates

	SELECT @Columns = STRING_AGG(QUOTENAME(dt), ', '),
		@ColumnsIsNull = STRING_AGG('ISNULL(' + QUOTENAME(dt) + ', 0) ' + QUOTENAME(dt), ', '),
		@ColumnsSum = STRING_AGG('ISNULL(' + QUOTENAME(dt) + ', 0)', ' + ')
	FROM ##dates

	--SELECT @Columns, @ColumnsIsNull, @ColumnsSum

	DECLARE @sql varchar(max) = '
	SELECT FullName "Name", 
		'+@ColumnsIsNull+',
		'+@ColumnsSum+' Total'+CAST(@WeekCount as varchar(2))+'Wks
	FROM(
		SELECT u.ID UserID, u.FullName, g.ID GroupID, g.Name GroupName, 
			DateAdd(day, (DatePart(dw, c.CreateDate) - 1) * -1, CAST(c.CreateDate AS DATE)) WeekBeginning, 
			COUNT(*) NewChecklists
		FROM QCheck_Users u
		JOIN QCheck_GroupMembership gm 
			ON gm.UserID = u.ID
		JOIN QCheck_Groups g 
			ON g.ID = gm.GroupID 
			AND g.SingleMemberGroup = 1
		LEFT JOIN QCheck_Checklists c 
			ON c.Owner = u.ID 
			AND DateAdd(day, (DatePart(dw, c.CreateDate) - 1) * -1, CAST(c.CreateDate AS DATE)) IN (SELECT dt from ##dates)
		WHERE u.ShortName LIKE ''phi-%''
			AND u.IsDeleted = 0
		GROUP BY u.ID, u.FullName, g.ID, g.Name, 
			DateAdd(day, (DatePart(dw, c.CreateDate) - 1) * -1, CAST(c.CreateDate AS DATE))
	) AS m
	PIVOT ( 
		SUM(NewChecklists)
		FOR WeekBeginning IN (
			'+@Columns+'
		)
	) AS p
	WHERE (' + @ColumnsSum + ' > 0 OR ' + CAST(@ShowAll as varchar(1)) + ' = 1)
	ORDER BY FullName'

	EXEC(@sql)
	DROP TABLE ##dates
END
GO
/****** Object:  StoredProcedure [dbo].[spGetWeeklyBonusReviewBodyHtml1]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spGetWeeklyBonusReviewBodyHtml1] (
	@Body VARCHAR(MAX) OUTPUT
)
AS
BEGIN
	DECLARE @CurrentWeek TABLE (
		Employee VARCHAR(100)
		,Bonus SMALLINT
		,TasksCompletedOnTime SMALLINT
		,Comments SMALLINT
		,StatusAndPriorityListEmails SMALLINT
		,EmailTasks SMALLINT
		,ChangeRequests SMALLINT
		,StartDt DATETIME
	)
	INSERT INTO @CurrentWeek
	EXEC WeeklyBonusReview_NewBonus

	DECLARE @PriorWeek TABLE (
		Employee VARCHAR(100)
		,Bonus SMALLINT
		,TasksCompletedOnTime SMALLINT
		,Comments SMALLINT
		,StatusAndPriorityListEmails SMALLINT
		,EmailTasks SMALLINT
		,ChangeRequests SMALLINT
		,StartDt DATETIME
	)

	DECLARE @dt DATETIME = DATEADD(DD, -7, GETDATE())
		,@dCompleted SMALLINT
		,@dComments SMALLINT
		,@dEmails SMALLINT
		,@dEmailTasks SMALLINT
		,@dChangeRequests SMALLINT

	INSERT INTO @PriorWeek
	EXEC WeeklyBonusReview_NewBonus @dt

	;WITH t1 (TasksCompleted, Comments, Emails, EmailTasks, ChangeRequests) AS (
		SELECT CONVERT(REAL, SUM(TasksCompletedOnTime))
			,CONVERT(REAL, SUM(Comments))
			,CONVERT(REAL, SUM(StatusAndPriorityListEmails))
			,CONVERT(REAL, SUM(EmailTasks))
			,CONVERT(REAL, SUM(ChangeRequests))
		FROM @PriorWeek
	)	
	,t2 (TasksCompleted, Comments, Emails, EmailTasks, ChangeRequests) AS (
		SELECT CONVERT(REAL, SUM(TasksCompletedOnTime))
			,CONVERT(REAL, SUM(Comments))
			,CONVERT(REAL, SUM(StatusAndPriorityListEmails))
			,CONVERT(REAL, SUM(EmailTasks))
			,CONVERT(REAL, SUM(ChangeRequests))
		FROM @CurrentWeek
	)
	SELECT @dCompleted = ROUND((t2.TasksCompleted - t1.TasksCompleted) /t1.TasksCompleted, 2) * 100
		,@dComments = ROUND((t2.Comments - t1.Comments) /t1.Comments, 2) * 100
		,@dEmails = ROUND((t2.Emails - t1.Emails) /t1.Emails, 2) * 100
		,@dEmailTasks = ROUND((t2.EmailTasks - t1.EmailTasks) /t1.EmailTasks, 2) * 100
		,@dChangeRequests = ROUND((t2.ChangeRequests - t1.ChangeRequests) /t1.ChangeRequests, 2) * 100
	FROM t1, t2
 
	DECLARE @str1 VARCHAR(100) = 'no change '
		,@str2 VARCHAR(100) = 'no change '
		,@str3 VARCHAR(100) = 'no change '
		,@str4 VARCHAR(100) = 'no change '
		,@str5 VARCHAR(100) = 'no change '
		
	IF (@dEmailTasks >= 1)
		SET @str1 = 'up ' + CONVERT(VARCHAR(3), @dEmailTasks) + '%'
	ELSE IF (@dEmailTasks <= -1)
		SET @str1 = 'down ' + CONVERT(VARCHAR(3), ABS(@dEmailTasks)) + '%'

	IF (@dCompleted >= 1)
		SET @str2 = 'up ' + CONVERT(VARCHAR(3), @dCompleted) + '%'
	ELSE IF (@dCompleted <= -1)
		SET @str2 = 'down ' + CONVERT(VARCHAR(3), ABS(@dCompleted)) + '%'

	IF (@dComments >= 1)
		SET @str3 = 'up ' + CONVERT(VARCHAR(3), @dComments) + '%'
	ELSE IF (@dCompleted <= -1)
		SET @str3 = 'down ' + CONVERT(VARCHAR(3), ABS(@dComments)) + '%'

	IF (@dEmails >= 1)
		SET @str4 = 'up ' + CONVERT(VARCHAR(3), @dEmails) + '%'
	ELSE IF (@dEmails <= -1)
		SET @str4 = 'down ' + CONVERT(VARCHAR(3), ABS(@dEmails)) + '%'

	IF (@dChangeRequests >= 1)
		SET @str5 = 'up ' + CONVERT(VARCHAR(3), @dChangeRequests) + '%'
	ELSE IF (@dChangeRequests <= -1)
		SET @str5 = 'down ' + CONVERT(VARCHAR(3), ABS(@dChangeRequests)) + '%'

	SELECT @str1 = '"Email Tasks Created" ' + @str1
		,@str2 = '"Tasks Completed On Time" ' + @str2
		,@str3 = '"Comments" ' + @str3
		,@str4 = '"Status & Priority List Emails" ' + @str4
		,@str5 = '"Change Requests" ' + @str5

	DECLARE @header VARCHAR(8000) = @str1 + ', ' + @str2 + ', ' + @str3 + ', ' + @str4 + ', ' + 'and ' + @str5 + '  from prior week.'
	SET @Body = 
		N'<H4 style="color:#000000; font-family:Arial,Verdana"></H4>' +
		N'<H5 style="color:#000000; font-family:Arial,Verdana">' + @header + '</H5>' +
		N'<table border="1px solid black"; style="font-family:Arial,Verdana; text-align:left; font-size:9pt; color:#000000">' +
		N'<tr style="text-align:left;">
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Employee</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Bonus</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Tasks Completed<br>On Time</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Comments</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Status and<br>Priority List Emails</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Email Tasks</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Change Requests</th>'
		+ 
		CAST ( ( 
			SELECT td = Employee , '',
				[td/@align]='right', td = FORMAT(Bonus, 'C0') , '',
				[td/@align]='right', td = TasksCompletedOnTime, '',
				[td/@align]='right', td = Comments, '',
				[td/@align]='right', td = StatusAndPriorityListEmails, '',
				[td/@align]='right', td = EmailTasks, '',
				[td/@align]='right', td = ChangeRequests
			FROM @CurrentWeek
			ORDER BY Bonus DESC
		FOR XML PATH('tr'), TYPE
		) AS NVARCHAR(MAX) ) +
		N'</table>
	'
END
GO
/****** Object:  StoredProcedure [dbo].[spGetWeeklyBonusReviewBodyHtml2]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spGetWeeklyBonusReviewBodyHtml2] (
	@Body VARCHAR(MAX) OUTPUT
)
AS
BEGIN
	SET @Body = 
		N'<H4 style="color:#000000; font-family:Arial,Verdana">ITD bonus by individual:</H4>' +
		N'<H5 style="color:#000000; font-family:Arial,Verdana"></H5>' +
		N'<table border="1px solid black"; style="font-family:Arial,Verdana; text-align:left; font-size:9pt; color:#000000">' +
		N'<tr style="text-align:left;">
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Employee</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Total Bonus</th>'
		+ 
		CAST ( ( 
			SELECT td = Employee , '',
				[td/@align]='right', td = FORMAT(TotalBonus, 'C0')
			FROM vwEmployeeBonusByIndividual
			ORDER BY TotalBonus DESC
		FOR XML PATH('tr'), TYPE
		) AS NVARCHAR(MAX) ) +
		N'</table>
	'
END

GO
/****** Object:  StoredProcedure [dbo].[spGetWeeklyBonusReviewBodyHtml3]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spGetWeeklyBonusReviewBodyHtml3] (
	@Body VARCHAR(MAX) OUTPUT
)
AS
BEGIN
	DECLARE @TotalMonthlyBonus INT = (SELECT SUM(Bonus) FROM  vwEmployeeBonusByMonth)
		,@TotalIndividualBonus INT = (SELECT SUM(TotalBonus) FROM  vwEmployeeBonusByIndividual)

	SET @Body = 
		N'<H4 style="color:#000000; font-family:Arial,Verdana"></H4>' +
		N'<H5 style="color:#000000; font-family:Arial,Verdana">Usage bonus by month (reminder current month splits into LOCKED  they have earned $50 or more, vs PENDING  less than $50 so they may not get it)</H5>' +
		N'<table border="1px solid black"; style="font-family:Arial,Verdana; text-align:left; font-size:9pt; color:#000000">' +
		N'<tr style="text-align:left;">
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">StartOfMonth</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Bonus</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Locked</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Pending</th>'
		+ 
		CAST ( ( 
			SELECT td = StartOfMonth, '',
				[td/@align]='right', td = Bonus, '',
				[td/@align]='right', td = ISNULL(Locked, ''), '',
				[td/@align]='right', td = ISNULL(Pending, '')
			FROM (
				SELECT StartOfMonth = CONVERT(VARCHAR(10), StartOfMonth)
					,Bonus = FORMAT(Bonus, 'C0')
					,Locked = FORMAT(Locked, 'C0')
					,Pending = FORMAT(Pending, 'C0')
				FROM vwEmployeeBonusByMonth
				UNION ALL
				SELECT 'Total:', FORMAT(@TotalMonthlyBonus, 'C0'), '', ''
			) t
			ORDER BY StartOfMonth
		FOR XML PATH('tr'), TYPE
		) AS NVARCHAR(MAX) ) +
		N'</table>
	' + N'<H5 style="color:#000000; font-family:Arial,Verdana">Total bonus for usage and tests: ' + FORMAT(@TotalIndividualBonus, 'C0') + '</H5>'
END

GO
/****** Object:  StoredProcedure [dbo].[spGetWeeklyBonusReviewBodyHtml4]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spGetWeeklyBonusReviewBodyHtml4] (
	@Body VARCHAR(MAX) OUTPUT
)
AS
BEGIN
	DECLARE @TestBonusByMonth TABLE (
		StartOfMonth DATE
		,Bonus INT
	)
	INSERT INTO @TestBonusByMonth
	SELECT StartOfMonth
		,SUM(bonus)
	FROM (
		SELECT bonus
			,StartOfMonth = DATEADD(MONTH, DATEDIFF(MONTH, 0, firstTestDt), 0)
		FROM [QCheck_BonusTests]
	) t
	GROUP BY StartOfMonth

	DECLARE @TotalBonus INT = (SELECT SUM(Bonus) FROM @TestBonusByMonth)

	SET @Body = 
		N'<H4 style="color:#000000; font-family:Arial,Verdana">ITD bonus by individual:</H4>' +
		N'<H5 style="color:#000000; font-family:Arial,Verdana"></H5>' +
		N'<table border="1px solid black"; style="font-family:Arial,Verdana; text-align:left; font-size:9pt; color:#000000">' +
		N'<tr style="text-align:left;">
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Employee</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Total Bonus</th>'
		+ 
		CAST ( ( 
			SELECT td = StartOfMonth , '',
				[td/@align]='right', td = FORMAT(Bonus, 'C0')
			FROM (
				SELECT StartOfMonth = CONVERT(VARCHAR(10), StartOfMonth), Bonus
				FROM @TestBonusByMonth
				UNION ALL
				SELECT 'Total:', @TotalBonus
			) t
			ORDER BY StartOfMonth
		FOR XML PATH('tr'), TYPE
		) AS NVARCHAR(MAX) ) +
		N'</table>
	'
END

GO
/****** Object:  StoredProcedure [dbo].[spSendWeeklyBonusReviewEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spSendWeeklyBonusReviewEmail]
AS
BEGIN
	DECLARE @EmailRecipient VARCHAR(100)
		,@SubjectText VARCHAR(100)
		,@BodyHTML VARCHAR(MAX)
		,@BodyHTML1 VARCHAR(MAX)
		,@BodyHTML2 VARCHAR(MAX)
		,@BodyHTML3 VARCHAR(MAX)
		,@BodyHTML4 VARCHAR(MAX)
	SELECT TOP 1 @EmailRecipient = 'tly@acmewidget.com'
	SELECT @SubjectText = 'PFSProcess Bonus Program Update'

	EXEC [spGetWeeklyBonusReviewBodyHtml1] @BodyHTML1 OUTPUT
	EXEC [spGetWeeklyBonusReviewBodyHtml2] @BodyHTML2 OUTPUT
	EXEC [spGetWeeklyBonusReviewBodyHtml3] @BodyHTML3 OUTPUT
	EXEC [spGetWeeklyBonusReviewBodyHtml4] @BodyHTML4 OUTPUT

	SET @BodyHTML = 
		'<html><body>' + 		
			'<style>
			table, th, td {
			  border: 1px solid black;
			  border-collapse: collapse;
			  padding: 5px;
			  font-size: 14;
			}
			</style>' + 
			+ @BodyHTML4 + '<br>' + @BodyHTML3 + '<br>' + @BodyHTML2 + '<br>' + @BodyHTML1 +
		'</body></html>'

	EXEC [dbo].[xp_smtp_sendmail]
		@Message = @BodyHTML, 
		@To = @EmailRecipient, 
		@Subject = @SubjectText 
END
GO
/****** Object:  StoredProcedure [dbo].[spWeeklyBonusReviewEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spWeeklyBonusReviewEmail]
AS
BEGIN
	DECLARE @CurrentWeek TABLE (
		Employee VARCHAR(100)
		,Bonus SMALLINT
		,TasksCompletedOnTime SMALLINT
		,Comments SMALLINT
		,StatusAndPriorityListEmails SMALLINT
		,EmailTasks SMALLINT
		,ChangeRequests SMALLINT
		,StartDt DATETIME
	)
	INSERT INTO @CurrentWeek
	EXEC WeeklyBonusReview_NewBonus

	DECLARE @PriorWeek TABLE (
		Employee VARCHAR(100)
		,Bonus SMALLINT
		,TasksCompletedOnTime SMALLINT
		,Comments SMALLINT
		,StatusAndPriorityListEmails SMALLINT
		,EmailTasks SMALLINT
		,ChangeRequests SMALLINT
		,StartDt DATETIME
	)

	DECLARE @dt DATETIME = DATEADD(DD, -7, GETDATE())
		,@dCompleted SMALLINT
		,@dComments SMALLINT
		,@dEmails SMALLINT
		,@dEmailTasks SMALLINT
		,@dChangeRequests SMALLINT

	INSERT INTO @PriorWeek
	EXEC WeeklyBonusReview_NewBonus @dt

	;WITH t1 (TasksCompleted, Comments, Emails, EmailTasks, ChangeRequests) AS (
		SELECT CONVERT(REAL, SUM(TasksCompletedOnTime))
			,CONVERT(REAL, SUM(Comments))
			,CONVERT(REAL, SUM(StatusAndPriorityListEmails))
			,CONVERT(REAL, SUM(EmailTasks))
			,CONVERT(REAL, SUM(ChangeRequests))
		FROM @PriorWeek
	)	
	,t2 (TasksCompleted, Comments, Emails, EmailTasks, ChangeRequests) AS (
		SELECT CONVERT(REAL, SUM(TasksCompletedOnTime))
			,CONVERT(REAL, SUM(Comments))
			,CONVERT(REAL, SUM(StatusAndPriorityListEmails))
			,CONVERT(REAL, SUM(EmailTasks))
			,CONVERT(REAL, SUM(ChangeRequests))
		FROM @CurrentWeek
	)
	SELECT @dCompleted = ROUND((t2.TasksCompleted - t1.TasksCompleted) /t1.TasksCompleted, 2) * 100
		,@dComments = ROUND((t2.Comments - t1.Comments) /t1.Comments, 2) * 100
		,@dEmails = ROUND((t2.Emails - t1.Emails) /t1.Emails, 2) * 100
		,@dEmailTasks = ROUND((t2.EmailTasks - t1.EmailTasks) /t1.EmailTasks, 2) * 100
		,@dChangeRequests = ROUND((t2.ChangeRequests - t1.ChangeRequests) /t1.ChangeRequests, 2) * 100
	FROM t1, t2
 
	DECLARE @str1 VARCHAR(100) = 'no change '
		,@str2 VARCHAR(100) = 'no change '
		,@str3 VARCHAR(100) = 'no change '
		,@str4 VARCHAR(100) = 'no change '
		,@str5 VARCHAR(100) = 'no change '
		
	IF (@dEmailTasks >= 1)
		SET @str1 = 'up ' + CONVERT(VARCHAR(3), @dEmailTasks) + '%'
	ELSE IF (@dEmailTasks <= -1)
		SET @str1 = 'down ' + CONVERT(VARCHAR(3), ABS(@dEmailTasks)) + '%'

	IF (@dCompleted >= 1)
		SET @str2 = 'up ' + CONVERT(VARCHAR(3), @dCompleted) + '%'
	ELSE IF (@dCompleted <= -1)
		SET @str2 = 'down ' + CONVERT(VARCHAR(3), ABS(@dCompleted)) + '%'

	IF (@dComments >= 1)
		SET @str3 = 'up ' + CONVERT(VARCHAR(3), @dComments) + '%'
	ELSE IF (@dCompleted <= -1)
		SET @str3 = 'down ' + CONVERT(VARCHAR(3), ABS(@dComments)) + '%'

	IF (@dEmails >= 1)
		SET @str4 = 'up ' + CONVERT(VARCHAR(3), @dEmails) + '%'
	ELSE IF (@dEmails <= -1)
		SET @str4 = 'down ' + CONVERT(VARCHAR(3), ABS(@dEmails)) + '%'

	IF (@dChangeRequests >= 1)
		SET @str5 = 'up ' + CONVERT(VARCHAR(3), @dChangeRequests) + '%'
	ELSE IF (@dChangeRequests <= -1)
		SET @str5 = 'down ' + CONVERT(VARCHAR(3), ABS(@dChangeRequests)) + '%'

	SELECT @str1 = '"Email Tasks Created" ' + @str1
		,@str2 = '"Tasks Completed On Time" ' + @str2
		,@str3 = '"Comments" ' + @str3
		,@str4 = '"Status & Priority List Emails" ' + @str4
		,@str5 = '"Change Requests" ' + @str5

	DECLARE @header VARCHAR(8000) = @str1 + ', ' + @str2 + ', ' + @str3 + ', ' + @str4 + ', ' + 'and ' + @str5 + '  from prior week.'

	DECLARE @EmailRecipient VARCHAR(100), @SubjectText VARCHAR(100), @Body VARCHAR(MAX)
	SELECT TOP 1 @EmailRecipient = 'kcroft@acmewidget.com'
	SELECT @SubjectText = 'PFSProcess Bonus Program Update'
	SET @Body = '
		<style>
		table, th, td {
		  border: 1px solid black;
		  border-collapse: collapse;
		  padding: 5px;
		  font-size: 14;
		}
		</style>' + 
		N'<H4 style="color:#000000; font-family:Arial,Verdana"></H4>' +
		N'<H5 style="color:#000000; font-family:Arial,Verdana">' + @header + '</H5>' +
		N'<table border="1px solid black"; style="font-family:Arial,Verdana; text-align:left; font-size:9pt; color:#000000">' +
		N'<tr style="text-align:left;">
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Employee</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Bonus</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Tasks Completed<br>On Time</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Comments</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Status and<br>Priority List Emails</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Email Tasks</th>
		<th style="text-align:left;background-color:#000000;color:#FFF;font-weight:bold;">Change Requests</th>'
		+ 
		CAST ( ( SELECT
		td = Employee , '',
		[td/@align]='right', td = Bonus , '',
		[td/@align]='right', td = TasksCompletedOnTime, '',
		[td/@align]='right', td = Comments, '',
		[td/@align]='right', td = StatusAndPriorityListEmails, '',
		[td/@align]='right', td = EmailTasks, '',
		[td/@align]='right', td = ChangeRequests
		FROM @CurrentWeek
		FOR XML PATH('tr'), TYPE
		) AS NVARCHAR(MAX) ) +
		N'</table>
	'
	EXEC [dbo].[xp_smtp_sendmail]
		@Message = @Body, 
		@To = @EmailRecipient, 
		@Subject = @SubjectText 
END
GO
/****** Object:  StoredProcedure [dbo].[Util_ACName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_ACName] (
	@ActiveChecklistID INT
) AS

SELECT
	c.Name
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
WHERE 
	ac.ID = @ActiveChecklistID

GO
/****** Object:  StoredProcedure [dbo].[Util_AddQuickEmailTaskAlert]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_AddQuickEmailTaskAlert] (
	@TaskName VARCHAR(500),
	@Email VARCHAR(50),
	@AssignedByUserID INT
) AS
		
BEGIN

	DECLARE @GroupID INT,
			@InstanceID INT
		
	-- Get the instance for the task
	SELECT TOP 1
		@InstanceID = ci.ID
	FROM 
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON c.ID = ci.ChecklistID
		WHERE
			c.Name = @TaskName
			AND c.[Owner] = @AssignedByUserID
	ORDER BY c.ID DESC

	-- Get the group ID by e-mail address
	EXEC QCheck_GroupByEmail_Output @Email, @GroupID output
		
	-- Add the alert
	EXEC QCheck_AddAlert @InstanceID, NULL, 0.5, @GroupID, 'Hours', ''
	
END
GO
/****** Object:  StoredProcedure [dbo].[Util_AddQuickEmailTaskAssignee]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[Util_AddQuickEmailTaskAssignee] (
	@TaskName VARCHAR(500),
	@Email VARCHAR(500),
	@AssignedByUserID INT
) AS

BEGIN

	DECLARE @GroupID INT,
			@InstanceID INT,
			@ActiveChecklistID INT,
			@TaskType INT,
			@ReportID INT

	-- Get the instance for the task
	SELECT TOP 1
		@InstanceID = ci.ID,
		@ActiveChecklistID = ac.ID
	FROM 
		QCheck_Checklists c
		INNER JOIN QCheck_ChecklistInstances ci
			ON c.ID = ci.ChecklistID
		INNER JOIN QCheck_ActiveChecklists ac
			ON ci.ID = ac.InstanceID
		WHERE
			c.Name = @TaskName
			AND c.[Owner] = @AssignedByUserID
	ORDER BY c.ID DESC

	-- Get the group ID by e-mail address
	SELECT @GroupID = g.ID
	FROM 
		QCheck_Groups g
		INNER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
			AND g.SingleMemberGroup = 1
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.ID
	WHERE
		u.Email = @Email

	-- Add the assignment
	EXEC QCheck_AddAssignedTo @InstanceID, @GroupID, @AssignedByUserID, 1
	
	-- Get the first section on the assignee's personal status report
	SELECT top 1 
		@TaskType = tt.ID,
		@ReportID = r.ID
	FROM 
		QStatus_Report r
		INNER JOIN QCheck_GroupMembership gm1
			on gm1.GroupID = @GroupID
		INNER JOIN QStatus_GroupReport gr
			ON gr.ReportID = r.ID
		INNER JOIN QCheck_Groups g
			ON g.ID = gr.GroupID
		INNER JOIN QCheck_GroupMembership gm
			ON gm.GroupID = g.ID
			AND gm.UserID = gm1.UserID
		INNER JOIN QStatus_TaskTypes tt
			ON tt.ReportID = r.ID
			AND tt.IsDeleted = 0
			AND tt.NativeType = 0
	WHERE 
		r.IsDeleted = 0
	ORDER BY 
		gr.defaultreport desc, 
		r.ID, 
		tt.displayOrder
		
	-- Add the task to the assignee's personal status report
	IF NOT EXISTS(
		SELECT * 
		FROM QStatus_ActiveChecklistTaskType 
		WHERE ActiveChecklistID = @ActiveChecklistID 
		AND TaskType = @TaskType
	) AND @TaskType IS NOT NULL
	BEGIN
	
		INSERT INTO QStatus_ActiveChecklistTaskType (
			ActiveChecklistID,
			TaskType,
			[Priority],
			CreateDt
		) VALUES (
			@ActiveChecklistID,
			@TaskType,
			1,
			GETDATE()
		)
		
		UPDATE QStatus_Report
		SET IsDirty = 1
		WHERE ID = @ReportID
		
	END
	
END
GO
/****** Object:  StoredProcedure [dbo].[Util_AddQuickEmailTaskController]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_AddQuickEmailTaskController] (
	@TaskName VARCHAR(500),
	@Email VARCHAR(500),
	@UserID INT
) AS

BEGIN

	DECLARE @GroupID INT,
			@ChecklistID INT

	SELECT TOP 1
		@ChecklistID = ID
	FROM 
		QCheck_Checklists c
	WHERE
		c.Name = @TaskName
		AND c.[Owner] = @UserID
	ORDER BY c.ID DESC

	SELECT @GroupID = g.ID
	FROM 
		QCheck_Groups g
		INNER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
			AND g.SingleMemberGroup = 1
		INNER JOIN QCheck_Users u
			ON gm.UserID = u.ID
	WHERE
		u.Email = @Email

	EXEC QCheck_AddManager @GroupID, @ChecklistID

END
GO
/****** Object:  StoredProcedure [dbo].[Util_AssignedAndControlledCalendarByDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE proc [dbo].[Util_AssignedAndControlledCalendarByDate]
	@login varchar(100),
	@dt datetime 
As
BEGIN

	SET NOCOUNT ON
	
	declare @UserID int
	select @UserID = ID from QCheck_Users where shortname = @login
	
	declare @startDate datetime = @dt
	declare @endDate datetime = dateadd(day, 1, dateadd(second, -1, @startdate))
		
	DECLARE @tblAssigned table(
		ID int
	)
	
	DECLARE @tblManaged table(
		ID int
	)	
	
	DECLARE @tblResults table(
		objID int, 
		ChecklistID int, 
		ChecklistName varchar(500),  
		DueTime datetime, 
		ReminderDate datetime,
		type int,
		active int
	)
	
	
	INSERT INTO @tblAssigned
	SELECT a.InstanceID
	FROM 
		QCheck_Assignments a
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @UserID
	WHERE a.IsDeleted = 0

	INSERT INTO @tblManaged
	SELECT ci.ID
	FROM 
		QCheck_ChecklistInstances ci
		INNER JOIN QCheck_Checklists c
			on c.ID = ci.ChecklistID
			and c.IsDeleted = 0
			and ci.IsDeleted = 0
		INNER JOIN QCheck_ChecklistManagers cm
			on cm.ChecklistID = c.ID
			and cm.IsDeleted = 0
		INNER JOIN QCheck_Groups g
			on g.ID = cm.ManagerGroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
			and gm.UserID = @UserID
	
	-- Current tasks assigned to me
	INSERT INTO @tblResults
	SELECT 
		ac.ID as objID, 
		c.ID as ChecklistID, 
		c.Name + case when ac.DueTime BETWEEN @startDate and @endDate then '' else ' - Soft Due' end + ' -- Assigned to ' + dbo.QCheck_AssigneesList(ci.id)  as ChecklistName, 
		ac.DueTime,
		ac.ReminderDate,
		1 AS type, --meaning current
		case when ac.completeddate is null then 1 else 0 end as active
	FROM 
		QCheck_ChecklistInstances ci
		INNER JOIN QCheck_Checklists c 
			on ci.checklistID = c.ID 
			AND c.IsDeleted = 0
			and ci.IsDeleted = 0
		INNER JOIN QCheck_ActiveChecklists ac 
			on ac.InstanceID = ci.ID 
			AND (
				ac.DueTime BETWEEN @startDate and @endDate
				OR ac.ReminderDate BETWEEN @startDate and @endDate
			)
		INNER JOIN @tblAssigned ta
			on ta.ID = ci.ID

	-- Future tasks assigned to me
	INSERT INTO @tblResults
	SELECT 
		ac.ID as objID, 
		c.ID as ChecklistID, 
		c.Name + ' -- Assigned to ' + dbo.QCheck_AssigneesList(ci.id)  as ChecklistName, 
		ac.DueTime, 
		NULL AS ReminderDate,
		3 AS type, --meaning future
		1 as active
	FROM 
		QCheck_ChecklistInstances ci
		INNER JOIN QCheck_Checklists c 
			on ci.checklistID = c.ID 
			AND c.IsDeleted = 0
			and ci.IsDeleted = 0
		INNER JOIN QCheck_UpcomingDueTimes ac 
			on ac.InstanceID = ci.ID 
			AND ac.DueTime BETWEEN @startDate and @endDate
		INNER JOIN @tblAssigned ta
			on ta.ID = ci.ID
			
	INSERT INTO @tblResults
	SELECT 
		ac.ID as objID, 
		c.ID as ChecklistID, 
		c.Name + case when ac.DueTime BETWEEN @startDate and @endDate then '' else ' - Soft Due' end + ' -- Assigned to ' + dbo.QCheck_AssigneesList(ci.id)  as ChecklistName, 
		ac.DueTime, 
		ac.ReminderDate,
		1 AS type, --meaning current
		case when ac.completeddate is null then 1 else 0 end as active
	FROM 
		QCheck_ChecklistInstances ci
		INNER JOIN QCheck_Checklists c 
			on ci.checklistID = c.ID 
			AND c.IsDeleted = 0
			and ci.IsDeleted = 0
		INNER JOIN QCheck_ActiveChecklists ac 
			on ac.InstanceID = ci.ID 
			AND (
				ac.DueTime BETWEEN @startDate and @endDate
				OR ac.ReminderDate BETWEEN @startDate and @endDate
			)
		INNER JOIN QCheck_ActiveAssignments aa
			on aa.ActiveChecklistID = ac.ID
		INNER JOIN QCheck_Assignments a
			on a.ID = aa.AssignmentsID
			and a.isdeleted = 0
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
		INNER JOIN @tblManaged tm
			on tm.ID = ci.ID

	-- Future tasks managed by me
	INSERT INTO @tblResults
	SELECT 
		ac.ID as objID, 
		c.ID as ChecklistID, 
		c.Name + ' -- Assigned to ' + dbo.QCheck_AssigneesList(ci.id)  as ChecklistName, 
		ac.DueTime, 
		NULL AS ReminderDate,
		3 AS type, --meaning current
		1 as active
	FROM 
		QCheck_ChecklistInstances ci
		INNER JOIN QCheck_Checklists c 
			on ci.checklistID = c.ID 
			AND c.IsDeleted = 0
			and ci.IsDeleted = 0
		INNER JOIN QCheck_UpcomingDueTimes ac 
			on ac.InstanceID = ci.ID 
			AND ac.DueTime BETWEEN @startDate and @endDate
		INNER JOIN QCheck_Assignments a
			on a.InstanceID = ci.ID
			and a.isdeleted = 0
		INNER JOIN QCheck_Groups g
			on g.ID = a.GroupID
		INNER JOIN QCheck_Groupmembership gm
			on gm.GroupID = g.ID
		INNER JOIN @tblManaged tm
			on tm.ID = ci.ID
					
	-- Get the output
	SELECT DISTINCT checklistname
	FROM 
		@tblResults
	ORDER BY 
		ChecklistName
	

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[Util_AssignedCalendarByDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE proc [dbo].[Util_AssignedCalendarByDate]
	@login varchar(100),
	@dt datetime 
As
BEGIN

	SET NOCOUNT ON
	
	declare @UserID int
	select @UserID = ID from QCheck_Users where shortname = @login
	
	declare @startDate datetime = @dt
	declare @endDate datetime = dateadd(day, 1, dateadd(second, -1, @startdate))
		
	DECLARE @tblAssigned table(
		ID int
	)
	
	DECLARE @tblResults table(
		objID int, 
		ChecklistID int, 
		ChecklistName varchar(500),  
		DueTime datetime, 
		ReminderDate datetime,
		type int,
		active int
	)
	
	
		INSERT INTO @tblAssigned
		SELECT a.InstanceID
		FROM 
			QCheck_Assignments a
			INNER JOIN QCheck_Groups g
				on g.ID = a.GroupID
			INNER JOIN QCheck_Groupmembership gm
				on gm.GroupID = g.ID
				and gm.UserID = @UserID
		WHERE a.IsDeleted = 0
	
		-- Current tasks assigned to me
		INSERT INTO @tblResults
		SELECT 
			ac.ID as objID, 
			c.ID as ChecklistID, 
			c.Name + case when ac.DueTime BETWEEN @startDate and @endDate then '' else ' - Soft Due' end as ChecklistName, 
			ac.DueTime,
			ac.ReminderDate,
			1 AS type, --meaning current
			case when ac.completeddate is null then 1 else 0 end as active
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN QCheck_Checklists c 
				on ci.checklistID = c.ID 
				AND c.IsDeleted = 0
				and ci.IsDeleted = 0
			INNER JOIN QCheck_ActiveChecklists ac 
				on ac.InstanceID = ci.ID 
				AND (
					ac.DueTime BETWEEN @startDate and @endDate
					or ac.ReminderDate BETWEEN @startDate and @endDate
				)
			INNER JOIN @tblAssigned ta
				on ta.ID = ci.ID

		-- Future tasks assigned to me
		INSERT INTO @tblResults
		SELECT 
			ac.ID as objID, 
			c.ID as ChecklistID, 
			c.Name as ChecklistName, 
			ac.DueTime, 
			NULL AS ReminderDate,
			3 AS type, --meaning future
			1 as active
		FROM 
			QCheck_ChecklistInstances ci
			INNER JOIN QCheck_Checklists c 
				on ci.checklistID = c.ID 
				AND c.IsDeleted = 0
				and ci.IsDeleted = 0
			INNER JOIN QCheck_UpcomingDueTimes ac 
				on ac.InstanceID = ci.ID 
				AND ac.DueTime BETWEEN @startDate and @endDate
			INNER JOIN @tblAssigned ta
				on ta.ID = ci.ID
			LEFT OUTER JOIN QCheck_Schedule s 
				ON ci.ScheduleID = s.ID 

	-- Get the output
	SELECT DISTINCT checklistname
	FROM 
		@tblResults
	ORDER BY 
		ChecklistName
	

	SET NOCOUNT OFF
END
GO
/****** Object:  StoredProcedure [dbo].[Util_AutoCloseQUTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[Util_AutoCloseQUTask]
	(
		@UserVideoHistoryID int
	)
AS
BEGIN
	RETURN
	--DECLARE @ActiveChecklistID int, @login varchar(100), @CompletedBy int

	--SELECT @ActiveChecklistID = QPActiveChecklistID, @login = [login]
	--FROM MediaContent.dbo.UserVideoHistory
	--WHERE ID = @UserVideoHistoryID

	--SELECT @CompletedBy= ID FROM QCheck_Users WHERE ShortName = @login

	--exec QCheck_CompleteChecklist @ID = @ActiveChecklistID, @CompletedBy = @CompletedBy, @isComplete = 1
	
END
GO
/****** Object:  StoredProcedure [dbo].[Util_ChangeRequestsByUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_ChangeRequestsByUser] (
	@UserName VARCHAR(100)
) AS

BEGIN

	DECLARE @RequestingUserID INT

	SELECT @RequestingUserID = [ID]
	FROM QCheck_Users
	WHERE FullName LIKE '%' + @UserName + '%'

	SELECT @RequestingUserID = [ID]
	FROM QCheck_Users
	WHERE FullName LIKE '%' + @UserName + '%'

	IF @RequestingUserID IS NULL BEGIN
		SELECT @RequestingUserID = [ID]
		FROM QCheck_Users
		WHERE ShortName LIKE '%' + @UserName + '%'
	END

	SELECT
		cr.[ID] AS CRID,
		dbo.QCheck_Approval_CRChecklistName(cr.[id]) AS Checklist, 
		ISNULL(ru.FullName, '') AS RequestingUser,
		cr.RequestDate,
		cr.Approved,
		ISNULL(au.FullName, '') AS ApprovedUser,
		cr.ApprovedDate,
		cr.Rejected,
		ISNULL(du.FullName, '') AS RejectedUserUser,
		cr.RejectedDate,
		cr.IsActive,
		cr.Comment
	FROM
		qcheck_approval_changerequests cr
		LEFT OUTER JOIN qcheck_users ru
			ON cr.requestinguser = ru.[id]		
		LEFT OUTER JOIN qcheck_users au
			ON cr.approveduser = au.[id]
		LEFT OUTER JOIN qcheck_users du
			ON cr.rejecteduser = du.[id]
	WHERE
		readyforsupervisor = 1
		AND (
			requestinguser = @RequestingUserID
			OR @RequestingUserID IS NULL
		)
	ORDER BY
		requestdate DESC

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CleanupAllTests]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[Util_CleanupAllTests] AS

	DECLARE @Prefix varchar(5)

	--TODO: this is much better handled using an app setting, but whatev
	SELECT @Prefix = LEFT(DB_NAME() COLLATE Latin1_General_BIN, 5)
	DECLARE @done bit = 0

	WHILE @done = 0 AND LEN(@Prefix) > 0
	BEGIN
		IF NOT UNICODE(RIGHT(@Prefix, 1)) BETWEEN 65 AND 90
			SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
		ELSE SET @done = 1
	END
	--Take off the first character of the second term, either a "P" or "T"
	SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)

	UPDATE cr SET IsActive = 0
	FROM QCheck_Approval_ChangeRequests cr
		JOIN QCheck_Approval_ChangeRequestChecklist crc 
			ON crc.ChangeRequestID = cr.ID
		JOIN QCheck_Checklists c 
			ON c.ID = crc.id 
			AND (c.Name LIKE @Prefix +'Process%Test%'
				OR c.Name LIKE @Prefix + '%Process%Tasks%'
				OR c.Name LIKE @Prefix + '%Process%Group%'
				OR c.Name LIKE @Prefix + '%Process%Help%')

	UPDATE
		QCheck_Checklists
	SET
		IsDeleted = 1
	WHERE
		(Name LIKE @Prefix + '%Process%Test%'
			OR Name LIKE @Prefix + '%Process%Tasks%'
			OR Name LIKE @Prefix + '%Process%Group%'
			OR Name LIKE @Prefix + '%Process%Help%')

	DELETE FROM 
		QCheck_Groups 
	WHERE
		Name LIKE @Prefix + '%Process Test Group%'

	UPDATE
		QStatus_Report
	SET
		IsDeleted = 1
	WHERE 
		ID IN (
			SELECT
				r.ID
			FROM
				QStatus_Report r
				INNER JOIN QStatus_GroupReport gr
					ON r.ID = gr.ReportID
			WHERE
				r.Name LIKE @Prefix + '%Process Report%'
		)

	DELETE FROM 
		QCheck_GroupMembership
	WHERE
		ID IN (
			SELECT
				gm.ID
			FROM 
				QCheck_Groups g
				INNER JOIN QCheck_GroupMembership gm
					ON g.ID = gm.GroupID
			WHERE
				g.Name = @Prefix + '%Process Test Takers'
		)
GO
/****** Object:  StoredProcedure [dbo].[Util_CleanupTest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE   PROCEDURE [dbo].[Util_CleanupTest] (
	@TesterGroupID INT,
	@TestDate DATETIME
) AS

	DECLARE @RawScore FLOAT = 0,
			@TesterUserID INT,
			@TesterReportID INT,
			@Username VARCHAR(50),
			@Count INT

	DECLARE @Prefix varchar(5)

	--TODO: this is much better handled using an app setting, but whatev
	SELECT @Prefix = LEFT(DB_NAME() COLLATE Latin1_General_BIN, 5)
	DECLARE @done bit = 0

	WHILE @done = 0 AND LEN(@Prefix) > 0
	BEGIN
		IF NOT UNICODE(RIGHT(@Prefix, 1)) BETWEEN 65 AND 90
			SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
		ELSE SET @done = 1
	END
	--Take off the first character of the second term, either a "P" or "T"
	SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)

	SELECT 
		@TesterUserID = u.ID,
		@Username = u.ShortName,
		@TesterReportID = r.ID
	FROM 
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
		INNER JOIN QStatus_Report r
			ON u.FullName = r.Name
			AND r.IsDeleted = 0
	WHERE 
		g.ID = @TesterGroupID
		AND u.IsDeleted = 0
		AND g.SingleMemberGroup = 1
		AND u.FullName = g.Name

	UPDATE cr SET IsActive = 0
	FROM QCheck_Approval_ChangeRequests cr
		JOIN QCheck_Approval_ChangeRequestChecklist crc 
			ON crc.ChangeRequestID = cr.ID
		JOIN QCheck_Checklists c 
			ON c.ID = crc.id 
			AND (c.Name LIKE @Prefix + '%Process%Test%'
				OR c.Name LIKE @Prefix + '%Process%Tasks%'
				OR c.Name LIKE @Prefix + '%Process%Group%'
				OR c.Name LIKE @Prefix + '%Process%Help%')
	WHERE cr.RequestingUser = @TesterUserID


	UPDATE
		QCheck_Checklists
	SET
		IsDeleted = 1
	WHERE
		[Owner] = @TesterUserID	
		AND (
			Name LIKE @Prefix + '%Process%Test%'
			OR Name LIKE @Prefix + '%Process%Tasks%'
			OR Name LIKE @Prefix + '%Process%Group%'
			OR Name LIKE @Prefix + '%Process%Search%'
			OR Name LIKE @Prefix + '%Process%Change%Requests%'
			OR Name LIKE @Prefix + '%Process%Help%'
		)

	DELETE FROM 
		QCheck_Groups 
	WHERE
		[Owner] = @TesterUserID
		AND Name LIKE @Prefix + '%Process Test%'

	UPDATE
		QStatus_Report
	SET
		IsDeleted = 1
	WHERE 
		ID IN (
			SELECT
				r.ID
			FROM
				QStatus_Report r
				INNER JOIN QStatus_GroupReport gr
					ON r.ID = gr.ReportID
			WHERE
				gr.GroupID = @TesterGroupID
				AND r.Name LIKE @Prefix + '%Process Report%'
		)

	DELETE FROM 
		QCheck_GroupMembership
	WHERE
		ID IN (
			SELECT
				gm.ID
			FROM 
				QCheck_Groups g
				INNER JOIN QCheck_GroupMembership gm
					ON g.ID = gm.GroupID
			WHERE
				gm.UserID = @TesterUserID
				AND g.Name = @Prefix + '%Process Test Takers'
		)
GO
/****** Object:  StoredProcedure [dbo].[Util_CompleteBidQTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Util_CompleteBidQTask] (
	@ID int
)
as
begin
	declare @userid int = 30 --system user
	
	UPDATE 
		QCheck_ActiveChecklists
	SET
		CompletedDate = GETDATE(),
		CompletedBy = @UserID
	WHERE 
		ID = @ID


    UPDATE 
		QCheck_ActiveItems
	SET
		CompletedDate = GETDATE(),
		CompletedBy = @UserID
	WHERE 
		ActiveChecklistID = @ID

end
GO
/****** Object:  StoredProcedure [dbo].[Util_CompleteTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_CompleteTask] (
	@ChecklistName VARCHAR(1000),
	@Assignee VARCHAR(500),
	@CompleteAll BIT = 0
) AS

DECLARE @ActiveChecklistID INT,
		@UserID INT,
		@Count INT

SELECT
	@ActiveChecklistID = ac.ID,
	@Count = COUNT(ac.ID)
FROM
	QCheck_Checklists c
	INNER JOIN QCheck_ChecklistInstances ci
		ON c.ID = ci.ChecklistID
	INNER JOIN QCheck_ActiveChecklists ac
		ON ci.ID = ac.InstanceID
	INNER JOIN QCheck_ActiveAssignments aa
		ON ac.ID = aa.ActiveChecklistID
	INNER JOIN QCheck_Assignments a
		ON aa.AssignmentsID = a.ID
	INNER JOIN QCheck_Groups g
		ON a.GroupID = g.ID
WHERE
	c.Name = @ChecklistName
	AND g.Name = @Assignee
	AND CompletedDate IS NULL
GROUP BY
	ac.ID
	
SELECT @UserID = ID
FROM QCheck_Users
WHERE FullName = @Assignee

IF @UserID IS NULL BEGIN
	PRINT 'User "' + @Assignee + '" not found.'
END ELSE BEGIN
	IF @ActiveChecklistID IS NULL BEGIN
		PRINT 'Active checklist not found for task "' + @ChecklistName + '" assigned to "' + @Assignee + '"'
	END ELSE BEGIN
		IF @Count > 1 AND @CompleteAll = 0 BEGIN
				PRINT 'More than one active checklist found for task "' + @ChecklistName + '" assigned to "' + @Assignee + '", no update was made.'
				PRINT 'EXEC Util_GetActiveChecklists ''' + @ChecklistName + ''' to see the list.'
				PRINT 'Use the @CompleteAll flag to mark all of the active checklists complete.'
		END ELSE BEGIN
			
			PRINT 'Marking task complete...'
			
			UPDATE 
				QCheck_ActiveChecklists
			SET
				CompletedDate = GETDATE(),
				CompletedBy = @UserID
			WHERE 
				ID = @ActiveChecklistID
				
		END
	END
	
END
GO
/****** Object:  StoredProcedure [dbo].[Util_CopyInstanceNewDueDate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_CopyInstanceNewDueDate] (
	@InstanceID INT,
	@DueDate datetime
) AS

BEGIN
	
	DECLARE @NewInstanceID INT
	DECLARE @ScheduleID INT
	DECLARE @NewScheduleID INT
	DECLARE @NowDate DATETIME
	DECLARE @ChecklistID INT
	DECLARE @FreqType INT

	
	SELECT @NowDate = GetDate()

	SELECT 
		@ScheduleID = ScheduleID, 
		@ChecklistID = ChecklistID
	FROM 
		QCheck_ChecklistInstances
	WHERE
		ID = @InstanceID

	INSERT INTO QCheck_Schedule (
		firstDueDate, 
		lastDueDate, 
		freqType, 
		freqInterval, 
		freqRecurrance, 
		dueTime, 
		busDayBehavior,
		SoftDueOffsetDays
	)
		SELECT 
			@DueDate, 
			lastDueDate, 
			freqType, 
			freqInterval, 
			freqRecurrance, 
			dueTime, 
			busDayBehavior,
			SoftDueOffsetDays
		FROM 
			QCheck_Schedule
		WHERE
			[ID] = @ScheduleID

	SELECT @NewScheduleID = @@Identity
		
	INSERT INTO QCheck_ChecklistInstances (
		[Name], 
		ChecklistID, 
		ScheduleID, 
		IsDeleted, 
		CreatedBy
	)
		SELECT 
			[Name], 
			@ChecklistID, 
			@NewScheduleID,  
			0, 
			CreatedBy
		FROM 
			QCheck_ChecklistInstances
		WHERE
			[ID] = @InstanceID
			AND IsDeleted = 0

	SELECT @NewInstanceID = @@Identity

	INSERT INTO QCheck_Assignments (
		InstanceID, 
		GroupID, 
		IsDeleted
	)
		SELECT 
			@NewInstanceID, 
			GroupID, 
			0
		FROM 
			QCheck_Assignments
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	INSERT INTO QStatus_InstanceTaskType (
		InstanceID, 
		TaskType
	)
		SELECT 
			@NewInstanceID, 
			TaskType
		FROM 
			QStatus_InstanceTaskType
		WHERE 
			InstanceID = @InstanceID

	INSERT INTO QCheck_Alerts (
		InstanceID, 
		DaysBefore, 
		AlertTime, 
		AlertType, 
		AlertText, 
		SentTime, 
		IsDeleted, 
		AlerteeGroupID
	)
		SELECT 
			@NewInstanceID, 
			DaysBefore, 
			AlertTime, 
			AlertType, 
			AlertText, 
			Null, 
			0, 
			AlerteeGroupID
		FROM 
			QCheck_Alerts
		WHERE
			InstanceID = @InstanceID
			AND IsDeleted = 0

	SELECT @FreqType = FreqType 
	FROM QCheck_Schedule
	WHERE [ID] = @ScheduleID
	

	IF @FreqType = 1 
	BEGIN
		EXEC QCheck_ActivateInstance @NewInstanceID, @NowDate
	END
	ELSE
	BEGIN
		
		EXEC QCheck_SetUpcomingInstance @NewInstanceID
	
		EXEC QCheck_ActivateFutureInstance @NewInstanceID
		
	END
	

	
	
END































GO
/****** Object:  StoredProcedure [dbo].[Util_Create32HelpTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_Create32HelpTask] (
	@TaskName VARCHAR(1000),-- = '32HELP - Cameras - from jdoe@example.com'
	@emailSender VARCHAR(1000) = null,
	@emailToRecipients VARCHAR(1000) = null,
	@email2dbTrigger int,
	@messagebody varchar(max) = null,
	@uid varchar(1000) = null
) AS
BEGIN
	
	DECLARE @AssignedGroupID INT,
		@ControllerGroupID INT,
		@DueDaysAhead INT,
		@TasksCreatedBy INT

	SELECT @AssignedGroupID = AssignedGroupID,
		@ControllerGroupID = ControllerGroupID,
		@DueDaysAhead = DueDaysAhead,
		@TasksCreatedBy = TasksCreatedBy
	FROM Util_Email2DBTasks
	where triggerID = @email2dbTrigger

	DECLARE @DueDate DATETIME
	SELECT @DueDate = DATEADD(DAY, @DueDaysAhead, CAST(CAST(GETDATE() AS DATE) AS DATETIME))


	exec [Util_CreateEmailTaskWithPriority]
		@TaskName = @TaskName,
		@CreatedBy = @TasksCreatedBy,
		@Assignee = @AssignedGroupID,
		@Controller = @ControllerGroupID,
		@DueDate = @DueDate,
		@Section = 1151618,
		@Priority = 0, 
		@PriorityUser = 944


END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateBidQTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[Util_CreateBidQTask] (
	@TaskName VARCHAR(1000),
	@email2dbTrigger int = 1
) AS
BEGIN
	
	DECLARE @AssignedGroupID INT,
		@ControllerGroupID INT,
		@DueDaysAhead INT,
		@TasksCreatedBy INT,
		@SectionID INT

	SELECT @AssignedGroupID = AssignedGroupID,
		@ControllerGroupID = ControllerGroupID,
		@DueDaysAhead = DueDaysAhead,
		@TasksCreatedBy = TasksCreatedBy,
		@SectionID = SectionID
	FROM Util_Email2DBTasks
	where triggerID = @email2dbTrigger

	DECLARE @DueDate DATETIME
	SELECT @DueDate = DATEADD(DAY, @DueDaysAhead, CAST(CAST(GETDATE() AS DATE) AS DATETIME))


	exec [Util_CreateEmailTaskWithPriority]
		@TaskName = @TaskName,
		@CreatedBy = @TasksCreatedBy,
		@Assignee = @AssignedGroupID,
		@Controller = @ControllerGroupID,
		@DueDate = @DueDate,
		@Section = @SectionID,
		@Priority = 0, 
		@PriorityUser = 0,
		@Email = 0

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateDefaultStatus]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_CreateDefaultStatus] (
	@Username VARCHAR(50)
) AS

BEGIN

	DECLARE @userid INT,
			@reportid INT
		
	SELECT @userid = id 
	FROM qcheck_users 
	WHERE shortname = @username

	EXEC QStatus_DefaultStatus @UserID, @ReportID OUTPUT

	SELECT @reportid
	
END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateEmailTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_CreateEmailTask] (
	@TaskName VARCHAR(1000),
	@CreatedBy int,
	@Assignee int,
	@Controller int,
	@DueDate DATETIME, 
	@Section int,
	@Comments varchar(1500) = null
	
) AS

BEGIN

	SET NOCOUNT ON
	
	insert into qcheck_emailtasks (TaskName, CreatedBy, CreatedDt)
	select @TaskName, @CreatedBy, getdate()

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE 
		@CallingProgram varchar(50),
		@ID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@errorCode int,
		@errorMsg varchar(500)

	SELECT @CallingProgram = @AppName + ' Tasks Email'

-- =======================================================
-- Initialize and validate inputs
-- =======================================================
	SET @errorCode = 0
	SET @errorMsg = ''

	-- Make sure a calling program was passed in
	IF @ErrorCode = 0 BEGIN
		IF LEN(@CallingProgram) = 0 BEGIN
			SET @ErrorCode = -1000
			SET @ErrorMsg = 'Zero-length calling program was given'
		END
	END

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @Section > 0
		BEGIN
			SELECT @TaskType = @Section

			SELECT @ReportID = ReportID
			FROM QStatus_TaskTypes
			WHERE ID = @TaskType

			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report'
			END
		END
	END


-- =======================================================
-- Set up the checklist
-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		EXEC dbo.QCheck_CreateSimple_part1 
			@ID, @TaskName, 1, @DueDate, @CreatedBy, @TaskType, 
			@PrevFreqType OUTPUT, @RowsUpdated OUTPUT, @NewInstanceID OUTPUT, @NewActiveID OUTPUT, @assignee, 1
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'QCheck_CreateSimple_part1 ' + cast(@ID as varchar) + ', ' + @TaskName + ', ' + cast(@DueDate as varchar) + ', ' + @CreatedBy + ', ' + @TaskType + ', assignedTo = ' + @assignee
	END

	IF @ErrorCode = 0 BEGIN
		
		if len(isnull(ltrim(rtrim(@comments)), '')) > 0
		begin
			declare @NewID int,
				@initials varchar(100),
				@fn varchar(50)

			exec QStatus_CreateNewComment @NewActiveID, @CreatedBy, @comments, @NewID, @initials, @fn
		end
		update qstatus_report set isdirty = 1 where id = @reportID
	ENd

	-- Make the assigned group a controller on the task
	IF @errorCode = 0
	BEGIN
		UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @Controller
		WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = @NewInstanceID)
		
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'UPDATE QCheck_ChecklistManagers SET ManagerGroupID = ' + @assignee + ' WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = ' + CAST(@NewInstanceID AS varchar) + ')'
	END
	
-- =======================================================
-- Alert on any errors
-- =======================================================

	IF @errorCode <> 0
	BEGIN
		DECLARE @msg varchar(5000)
		SET @msg = 'Calling Program: ' + @CallingProgram + '<br/><br/>Error Number: ' + cast(@errorCode AS varchar) + '<br/><br/>' + @errorMsg
		DECLARE @MailSubject VARCHAR(1000)
		
		SET @MailSubject = @AppName + ' Automated Task Creation Eror'
		EXEC XPSendEmail
		    @FROM       = @FromAddress,
		    @FROM_NAME  = 'SQLMail',
		    @TO         = @DeveloperAddress,
		    @subject    = @MailSubject,
		    @message    = @msg,
		    @type       = 'text/html',
		    @server     = @MailServer

		RAISERROR ('Unable to create task', 16, 1)
	END
	
	SET NOCOUNT OFF

END







GO
/****** Object:  StoredProcedure [dbo].[Util_CreateEmailTask_TwoSections]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_CreateEmailTask_TwoSections] (
	@TaskName VARCHAR(1000),
	@CreatedBy int,
	@Assignee int,
	@Controller int,
	@DueDate DATETIME, 
	@Section int,
	@Section2 int,
	@Comments varchar(1500) = null
	
) AS

BEGIN

	SET NOCOUNT ON
	
	insert into qcheck_emailtasks (TaskName, CreatedBy, CreatedDt)
	select @TaskName, @CreatedBy, getdate()

	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE 
		@CallingProgram varchar(50),
		@ID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@errorCode int,
		@errorMsg varchar(500)

	SELECT @CallingProgram = @AppName + ' Tasks Email'

-- =======================================================
-- Initialize and validate inputs
-- =======================================================
	SET @errorCode = 0
	SET @errorMsg = ''

	-- Make sure a calling program was passed in
	IF @ErrorCode = 0 BEGIN
		IF LEN(@CallingProgram) = 0 BEGIN
			SET @ErrorCode = -1000
			SET @ErrorMsg = 'Zero-length calling program was given'
		END
	END

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @Section > 0
		BEGIN
			SELECT @TaskType = @Section

			SELECT @ReportID = ReportID
			FROM QStatus_TaskTypes
			WHERE ID = @TaskType

			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report'
			END
		END
	END


-- =======================================================
-- Set up the checklist
-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		EXEC dbo.QCheck_CreateSimple_part1 
			@ID OUTPUT, @TaskName, 1, @DueDate, @CreatedBy, @TaskType, 
			@PrevFreqType OUTPUT, @RowsUpdated OUTPUT, @NewInstanceID OUTPUT, @NewActiveID OUTPUT, @assignee, 1
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'QCheck_CreateSimple_part1 ' + cast(@ID as varchar) + ', ' + @TaskName + ', ' + cast(@DueDate as varchar) + ', ' + @CreatedBy + ', ' + @TaskType + ', assignedTo = ' + @assignee
	
		Update QCheck_Checklistmanagers set managergroupid = @controller where checklistid = @ID
	END

	IF @ErrorCode = 0 BEGIN
		IF @Section2 > 0
		BEGIN
			declare @ttID int

			exec QCheck_AddInstanceTaskType @NewInstanceID, @section2, 1, @ttID output
		END
	END
	
	IF @ErrorCode = 0 BEGIN
		
		if len(isnull(ltrim(rtrim(@comments)), '')) > 0
		begin
			declare @NewID int,
				@initials varchar(100),
				@fn varchar(50)

			exec QStatus_CreateNewComment @NewActiveID, @CreatedBy, @comments, @NewID, @initials, @fn
		end
		update qstatus_report set isdirty = 1 where id = @reportID
	ENd

	
	SET NOCOUNT OFF

END







GO
/****** Object:  StoredProcedure [dbo].[Util_CreateEmailTaskWithPriority]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/****** Object:  StoredProcedure [dbo].[Util_CreateEmailTaskWithPriority]    Script Date: 9/26/2017 11:28:12 AM ******/
CREATE PROCEDURE [dbo].[Util_CreateEmailTaskWithPriority] (
	@TaskName VARCHAR(1000),
	@CreatedBy int,
	@Assignee int,
	@Controller int,
	@DueDate DATETIME, 
	@Section int,
	@Priority int,
	@PriorityUser int = null,
	@Comments varchar(1500) = null,
	@Alert DATETIME = null,
	@SoftDue DATETIME = null,
	@Email bit = 1
) AS

BEGIN

	SET NOCOUNT ON

	if (@priority = 999) select @priority = 99 --999 is reserved for completed tasks
	
	insert into qcheck_emailtasks (TaskName, CreatedBy, CreatedDt)
	select @TaskName, @CreatedBy, getdate()

	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE 
		@CallingProgram varchar(50),
		@ID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@errorCode int,
		@errorMsg varchar(500),
		@nagBeforeDays int,
		@nagTime int

	SELECT @CallingProgram = @AppName + ' Tasks Email'

-- =======================================================
-- Initialize and validate inputs
-- =======================================================
	SET @errorCode = 0
	SET @errorMsg = ''
	
	--If(dbo.Util_IsOfficeDay(@DueDate)=0)--added by venkat 09/07/2018
	--Begin
	--set @DueDate=dbo.Util_NextOfficeDayMaintainTime(@DueDate)
	--End

	IF @SoftDue IS NULL SET @SoftDue = @DueDate

	-- Make sure a calling program was passed in
	IF @ErrorCode = 0 BEGIN
		IF LEN(@CallingProgram) = 0 BEGIN
			SET @ErrorCode = -1000
			SET @ErrorMsg = 'Zero-length calling program was given'
		END
	END

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @Section = 0 BEGIN
			--find a section for the group specified
			SELECT top 1 
				@TaskType = tt.ID
			FROM 
				QStatus_Report r
				INNER JOIN QCheck_GroupMembership gm1
					on gm1.GroupID = @Assignee
				INNER JOIN QStatus_GroupReport gr
					ON gr.ReportID = r.ID
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID = g.ID
					AND gm.UserID = gm1.UserID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ReportID = r.ID
					AND tt.IsDeleted = 0
					AND tt.NativeType = 0
			WHERE 
				r.IsDeleted = 0
			ORDER BY gr.defaultreport desc, r.ID, tt.displayOrder
		END ELSE BEGIN
			SELECT @TaskType = @Section
		END
		
		IF @TaskType is not null BEGIN
			SELECT @ReportID = ReportID
			FROM QStatus_TaskTypes
			WHERE ID = @TaskType

			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report'
			END
		END
	END


-- =======================================================
-- Set up the checklist
-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		/*
		EXEC dbo.QCheck_CreateSimple_part1 @ID, @TaskName, 1, @DueDate, @CreatedBy, @TaskType, @PrevFreqType OUTPUT, @RowsUpdated OUTPUT, @NewInstanceID OUTPUT, @NewActiveID OUTPUT, @assignee, 1, 0, @SoftDue			
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'QCheck_CreateSimple_part1 ' + cast(@ID as varchar) + ', ' + @TaskName + ', ' + cast(@DueDate as varchar) + ', ' + @CreatedBy + ', ' + @TaskType + ', assignedTo = ' + @assignee
		*/
		
		/*** LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
		DECLARE @ReminderDate DATETIME
		SET @ReminderDate = @SoftDue

		DECLARE @UserID int
		DECLARE @FolderID int
		DECLARE @FolderName varchar(50)

		DECLARE @PrevSchedule bit
		
		SET @PrevSchedule = 0

		SET @ReportID = 0

		SELECT @ReportID = reportID
		FROM
			QStatus_TaskTypes
		WHERE ID = @TaskType

		INSERT INTO QCheck_Checklists
		([Name], Owner)
		VALUES
		(@TaskName, @CreatedBy)

		SELECT @ID = @@IDENTITY	

		-- Creator is the controller
		DECLARE @ControllerGroupID int
		SELECT @ControllerGroupID = ID
		FROM QCheck_Groups
		WHERE owner = @CreatedBy
		AND SingleMemberGroup = 1

		INSERT INTO QCheck_ChecklistManagers
		(ChecklistID, ManagerGroupID)
		VALUES (@ID, @ControllerGroupID)

		EXEC QCheck_AddItem @ID, null, 1, @TaskName, '', @CreatedBy

		EXEC QCheck_CreateInstance @NewInstanceID output, @ID, '', @CreatedBy

		EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee, @CreatedBy, @Email

		---- KVS 2017-09-26 - Removing these default alerts per GPR/Nelson;
		----	Users who want them can add them manually
		---- Reminder 1 day before due
		--EXEC QCheck_AddAlert
		--		@InstanceID = @NewInstanceID, 
		--		@nagBeforeDays = 1,
		--		@nagTime = 17,
		--		@alertType = 'Reminder'
		
		---- 2/11/2014 dalvarado - Also set a reminder for 1 hour before due
		--EXEC QCheck_AddAlert
		--		@InstanceID = @NewInstanceID, 
		--		@nagBeforeDays = NULL,
		--		@nagTime = -1,
		--		@alertType = 'Reminder'
				
		DECLARE @DueTime INT = DATEPART(HOUR, @DueDate)

		EXEC QCheck_UpdateSchedule_part1 
				@InstanceID = @NewInstanceID, 
				@firstDueDate = @DueDate,
				@freqType = 1, 
				@dueTime = @DueTime,
				@PrevFreqType = @PrevFreqType output,
				@RowsUpdated = @RowsUpdated output,
				@Activate = 1
				--@busDayBehavior=3--added by venkat for testing

		SELECT @NewActiveID = ID
		FROM QCheck_ActiveChecklists
		WHERE InstanceID = @NewInstanceID

		-- Set the reminder date to whatever was passed in, if it's not past the due time
		UPDATE QCheck_ActiveChecklists
		SET ReminderDate = @ReminderDate
		WHERE 
			[ID] = @NewActiveID
			AND @ReminderDate <= DueTime

		IF @TaskType IS NOT NULL BEGIN
			DECLARE @NewTaskTypeID int
			EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT
		END      
		
		-- rebuild cache
		EXEC QCheck_ChecklistControllersList_Refresh @ID
		
		/*** END LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
	END
	
	-- Make sure the deadline is right--for some reason if you pass in 5pm, the task is due at 6pm.
	IF @ErrorCode = 0 BEGIN
		UPDATE QCheck_ActiveChecklists
		SET DueTime = @DueDate, OrigDueTime = @DueDate	
		WHERE ID = @NewActiveID
	END

	IF @ErrorCode = 0 BEGIN
		
		if len(isnull(ltrim(rtrim(@comments)), '')) > 0
		begin
			declare @NewID int,
				@initials varchar(100),
				@fn varchar(50)

			exec QStatus_CreateNewComment @NewActiveID, @CreatedBy, @comments, @NewID, @initials, @fn
		end
		update qstatus_report set isdirty = 1 where id = @reportID
	ENd

	-- Make the assigned group a controller on the task
	IF @errorCode = 0
	BEGIN
		UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @Controller
		WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = @NewInstanceID)
		
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'UPDATE QCheck_ChecklistManagers SET ManagerGroupID = ' + CAST(@assignee as varchar) + ' WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = ' + CAST(@NewInstanceID AS varchar) + ')'
	END
	
	-- ADD To priority lists
	IF @errorCode = 0
	BEGIN
		IF @PriorityUser > 0
		BEGIN	
			exec [PriorityList_AddTask] @PriorityUser, @NewActiveID, @Priority
			SET @errorCode = @@ERROR
			IF @ErrorCode <> 0 SET @errorMsg = 'ADD TO PRIORITIES'
		END	
		ELSE
		BEGIN
			IF @Priority > 0
			BEGIN
				exec [PriorityList_AddTask_ForGroup] @CreatedBy, @Assignee, @NewActiveID, @Priority
				SET @errorCode = @@ERROR
				IF @ErrorCode <> 0 SET @errorMsg = 'ADD TO PRIORITIES'
			END	
			
		END
	END
	
	-- Create a reminder
	IF @Alert IS NOT NULL BEGIN
		SET @nagBeforeDays = ABS(DATEDIFF(DAY, @DueDate, @Alert))
		SET @nagTime = DATEPART(HOUR, @Alert)
		EXEC QCheck_AddReminder	@NewInstanceID, @nagBeforeDays, @nagTime
	END
	
	
-- =======================================================
-- Alert on any errors
-- =======================================================

	IF @errorCode <> 0
	BEGIN
		DECLARE @msg varchar(5000)
		DECLARE @MailSubject VARCHAR(1000)
		SET @MailSubject = @AppName + ' Automated Task Creation Error'
		SET @msg = 'Calling Program: ' + @CallingProgram + '<br/><br/>Error Number: ' + cast(@errorCode AS varchar) + '<br/><br/>' + @errorMsg
		EXEC XPSendEmail
		    @FROM       = @FromAddress,
		    @FROM_NAME  = 'SQLMail',
		    @TO         = @DeveloperAddress,
		    @subject    = @MailSubject,
		    @message    = @msg,
		    @type       = 'text/html',
		    @server     = @MailServer

		RAISERROR ('Unable to create task', 16, 1)
	END
	ELSE
	BEGIN
		SELECT @AppURL = appurl from qcheck_appsettings s
		inner join qcheck_users u
		on s.ID = u.App
		WHERE u.ID = @CreatedBy

		if @ReportID is null
		begin
			select @AppURL as appUrl
		end
		else
		begin
			select @AppURL + '/MyStatus.aspx?reportID=' + convert(varchar(10), @reportId) + '&taskID=' + convert(varchar(10), @NewActiveID)  as appUrl
		
		end

	END	
	
	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateFoundationTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[Util_CreateFoundationTask]
	(
		@taskname varchar(500),
		@DueDate datetime,
		@item varchar(1000) = '',
		@tasktype int = 0
	)
AS
BEGIN

	Declare @copyTaskID int = 1802085
	Declare @newTaskID int
	Declare @instanceID int
	Declare @SupervisorID int
	Declare @SupervisorGroupID int
	declare @Admin varchar(100) = 'bharper'
	declare @AdminID int
	declare @AdminGroupID int = 1916
	Declare @DueTime float
	Declare @PrevFreqType int
	Declare @RowsUpdated int
	Declare @AssignedGroupID int = 2209 --Phil Lab Tracking


	SELECT @DueTime = 19



	select @AdminID = ID from QCheck_Users where shortname = @Admin


	exec [QCheck_CopyChecklist] 
		@ChecklistID = @copyTaskID,
		@NewChecklistID = @newTaskID OUTPUT,
		@NewName = @taskname,
		@Force = 1

	update qcheck_items
	set [text] = @taskname
	where checklistid = @newTaskID

	if len(@item) >0
	begin
		exec [QCheck_AddItem] @ChecklistID = @newTaskID, @ItemTypeID = 1, @Text = @item, @URL = ''
	end

	exec [QCheck_CreateInstance] 
		@ID = @instanceID output,
		@ChecklistID = @newTaskID,
		@CreatedBy = @AdminID
	
	exec QCheck_AddAssignedTo
		@InstanceID = @instanceID,
		@GroupID = @AssignedGroupID,
		@AssignedBy = @AdminID,
		@Email = 0

	EXEC QCheck_UpdateSchedule_part1 
		@InstanceID = @instanceID, 
		@firstDueDate = @DueDate,
		@freqType = 1, 
		@dueTime = @DueTime,
		@PrevFreqType = @PrevFreqType output,
		@RowsUpdated = @RowsUpdated output,
		@Activate = 1

	UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @AdminGroupID
		where ChecklistID = @newTaskID

	declare @itt int

	if @tasktype > 0
	begin
		exec QCheck_AddInstanceTaskType @InstanceID = @instanceID,@TaskType = @tasktype, @Priority = 1,@ID =@itt output
	end

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateHealthQTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*
CREATE PROCEDURE [dbo].[Util_CreateHealthQTask] (
	@ContractID int,
	@CategoryID int,
	@TaskName VARCHAR(1000),
	@CreatedBy int,
	@Assignee int,
	@Assignee2 int = 0,
	@Assignee3 int= 0,
	@Controller int,
	@DueDate DATETIME, 
	@Section int,
	@Priority int,
	@PriorityUser int = null,
	@Comments varchar(1500) = null,
	@Alert DATETIME = null,
	@SoftDue DATETIME = null
) AS

BEGIN

	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE 
		@CallingProgram varchar(50),
		@ID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@errorCode int,
		@errorMsg varchar(500),
		@nagBeforeDays int,
		@nagTime int

	SELECT @CallingProgram = 'PHI HealthQ'

-- =======================================================
-- Initialize and validate inputs
-- =======================================================
	SET @errorCode = 0
	SET @errorMsg = ''
	
	--If(dbo.Util_IsOfficeDay(@DueDate)=0)--added by venkat 09/07/2018
	--Begin
	--set @DueDate=dbo.Util_NextOfficeDayMaintainTime(@DueDate)
	--End

	IF @SoftDue IS NULL SET @SoftDue = DATEADD(D, -3, @DueDate)

	-- Make sure a calling program was passed in
	IF @ErrorCode = 0 BEGIN
		IF LEN(@CallingProgram) = 0 BEGIN
			SET @ErrorCode = -1000
			SET @ErrorMsg = 'Zero-length calling program was given'
		END
	END

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @Section = 0 BEGIN
			--find a section for the group specified
			SELECT top 1 
				@TaskType = tt.ID
			FROM 
				QStatus_Report r
				INNER JOIN QCheck_GroupMembership gm1
					on gm1.GroupID = @Assignee
				INNER JOIN QStatus_GroupReport gr
					ON gr.ReportID = r.ID
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID = g.ID
					AND gm.UserID = gm1.UserID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ReportID = r.ID
					AND tt.IsDeleted = 0
					AND tt.NativeType = 0
			WHERE 
				r.IsDeleted = 0
			ORDER BY gr.defaultreport desc, r.ID, tt.displayOrder
		END ELSE BEGIN
			SELECT @TaskType = @Section
		END
		
		IF @TaskType is not null BEGIN
			SELECT @ReportID = ReportID
			FROM QStatus_TaskTypes
			WHERE ID = @TaskType

			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report'
			END
		END
	END


-- =======================================================
-- Set up the checklist
-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		/*
		EXEC dbo.QCheck_CreateSimple_part1 @ID, @TaskName, 1, @DueDate, @CreatedBy, @TaskType, @PrevFreqType OUTPUT, @RowsUpdated OUTPUT, @NewInstanceID OUTPUT, @NewActiveID OUTPUT, @assignee, 1, 0, @SoftDue			
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'QCheck_CreateSimple_part1 ' + cast(@ID as varchar) + ', ' + @TaskName + ', ' + cast(@DueDate as varchar) + ', ' + @CreatedBy + ', ' + @TaskType + ', assignedTo = ' + @assignee
		*/
		
		/*** LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
		DECLARE @ReminderDate DATETIME
		SET @ReminderDate = @SoftDue

		DECLARE @UserID int
		DECLARE @FolderID int
		DECLARE @FolderName varchar(50)

		DECLARE @PrevSchedule bit
		
		SET @PrevSchedule = 0

		SET @ReportID = 0

		SELECT @ReportID = reportID
		FROM
			QStatus_TaskTypes
		WHERE ID = @TaskType

		INSERT INTO QCheck_Checklists
		([Name], Owner)
		VALUES
		(@TaskName, @CreatedBy)

		SELECT @ID = @@IDENTITY	

		-- Creator is the controller
		DECLARE @ControllerGroupID int
		SELECT @ControllerGroupID = gm.UserID
		FROM QCheck_Groups g
		LEFT OUTER JOIN QCheck_GroupMembership gm
			ON g.ID = gm.GroupID
		WHERE gm.GroupID = @CreatedBy
		AND g.SingleMemberGroup = 1

		INSERT INTO QCheck_ChecklistManagers
		(ChecklistID, ManagerGroupID)
		VALUES (@ID, @ControllerGroupID)

		EXEC QCheck_AddItem @ID, null, 1, @TaskName, ''

		EXEC QCheck_CreateInstance @NewInstanceID output, @ID, '', @CreatedBy

		EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee, @ControllerGroupID, 1
		if (@assignee2 > 0) EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee2, @ControllerGroupID, 1
		if (@assignee3 > 0) EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee3, @ControllerGroupID, 1

		---- KVS 2017-09-26 - Removing these default alerts per GPR/Nelson;
		----	Users who want them can add them manually
		---- Reminder 1 day before due
		EXEC QCheck_AddAlert
				@InstanceID = @NewInstanceID, 
				@nagBeforeDays = 1,
				@nagTime = 17,
				@alertType = 'Reminder'
		
		---- 2/11/2014 dalvarado - Also set a reminder for 1 hour before due
		--EXEC QCheck_AddAlert
		--		@InstanceID = @NewInstanceID, 
		--		@nagBeforeDays = NULL,
		--		@nagTime = -1,
		--		@alertType = 'Reminder'
				
		DECLARE @DueTime INT = DATEPART(HOUR, @DueDate)

		EXEC QCheck_UpdateSchedule_part1 
				@InstanceID = @NewInstanceID, 
				@firstDueDate = @DueDate,
				@freqType = 1, 
				@dueTime = @DueTime,
				@PrevFreqType = @PrevFreqType output,
				@RowsUpdated = @RowsUpdated output,
				@Activate = 1
				--@busDayBehavior=3--added by venkat for testing

		SELECT @NewActiveID = ID
		FROM QCheck_ActiveChecklists
		WHERE InstanceID = @NewInstanceID

		-- Set the reminder date to whatever was passed in, if it's not past the due time
		UPDATE QCheck_ActiveChecklists
		SET ReminderDate = @ReminderDate
		WHERE 
			[ID] = @NewActiveID
			AND @ReminderDate <= DueTime

		IF @TaskType IS NOT NULL BEGIN
			DECLARE @NewTaskTypeID int
			EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT
		END      
		
		-- rebuild cache
		EXEC QCheck_ChecklistControllersList_Refresh @ID
		
		/*** END LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
	END
	
	-- Make sure the deadline is right--for some reason if you pass in 5pm, the task is due at 6pm.
	IF @ErrorCode = 0 BEGIN
		UPDATE QCheck_ActiveChecklists
		SET DueTime = @DueDate, OrigDueTime = @DueDate	
		WHERE ID = @NewActiveID
	END

	IF @ErrorCode = 0 BEGIN
		
		if len(isnull(ltrim(rtrim(@comments)), '')) > 0
		begin
			declare @NewID int,
				@initials varchar(100),
				@fn varchar(50)

			exec QStatus_CreateNewComment @NewActiveID, @CreatedBy, @comments, @NewID, @initials, @fn
		end
		update qstatus_report set isdirty = 1 where id = @reportID
	ENd

	-- Make the assigned group a controller on the task
	IF @errorCode = 0
	BEGIN
		UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @Controller
		WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = @NewInstanceID)
		
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'UPDATE QCheck_ChecklistManagers SET ManagerGroupID = ' + @assignee + ' WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = ' + CAST(@NewInstanceID AS varchar) + ')'
	END
	
	-- ADD To priority lists
	IF @errorCode = 0
	BEGIN
		IF @PriorityUser > 0
		BEGIN	
			exec [PriorityList_AddTask] @PriorityUser, @NewActiveID, @Priority
			SET @errorCode = @@ERROR
			IF @ErrorCode <> 0 SET @errorMsg = 'ADD TO PRIORITIES'
		END	
		ELSE
		BEGIN
			IF @Priority > 0
			BEGIN
				exec [PriorityList_AddTask_ForGroup] @CreatedBy, @Assignee, @NewActiveID, @Priority
				SET @errorCode = @@ERROR
				IF @ErrorCode <> 0 SET @errorMsg = 'ADD TO PRIORITIES'
			END	
			
		END
	END
	
	-- Create a reminder
	IF @Alert IS NOT NULL BEGIN
		SET @nagBeforeDays = ABS(DATEDIFF(DAY, @DueDate, @Alert))
		SET @nagTime = DATEPART(HOUR, @Alert)
		EXEC QCheck_AddReminder	@NewInstanceID, @nagBeforeDays, @nagTime
	END
	
	
-- =======================================================
-- Alert on any errors
-- =======================================================

	IF @errorCode <> 0
	BEGIN
		DECLARE @msg varchar(5000)
		DECLARE @MailSubject VARCHAR(1000)
		SET @MailSubject = @AppName + ' Automated Task Creation Error'
		SET @msg = 'Calling Program: ' + @CallingProgram + '<br/><br/>Error Number: ' + cast(@errorCode AS varchar) + '<br/><br/>' + @errorMsg
		EXEC XPSendEmail
		    @FROM       = @FromAddress,
		    @FROM_NAME  = 'SQLMail',
		    @TO         = @DeveloperAddress,
		    @subject    = @MailSubject,
		    @message    = @msg,
		    @type       = 'text/html',
		    @server     = @MailServer

		RAISERROR ('Unable to create task', 16, 1)
	END
	ELSE
	BEGIN
		SELECT @AppURL = appurl from qcheck_appsettings s
		inner join qcheck_users u
		on s.ID = u.App
		WHERE u.ID = @CreatedBy

		if @ReportID is null
		begin
			select @AppURL as appUrl
		end
		else
		begin
			---EXTERNAL REFERENCE---
			INSERT INTO PHI_Health.dbo.DQ2_Assignments
			VALUES(@ContractID, @CategoryID, @NewActiveID)
		
		end

	END	
	
	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateLoanClosingTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[Util_CreateLoanClosingTask]
	(
		@NoteDate datetime,
		@Developer varchar(100),
		@Project varchar(100)
	)
AS
BEGIN

	set nocount on

	DECLARE @DueDate datetime
	DECLARE @taskname varchar(1000)

	Declare @copyTaskID int = 1820299
	DECLARE @tasktype int = 1148203 
	Declare @newTaskID int
	Declare @instanceID int
	Declare @SupervisorID int
	Declare @SupervisorGroupID int
	declare @Admin varchar(100) = 'mfranklin'
	declare @AdminID int
	Declare @DueTime float
	Declare @PrevFreqType int
	Declare @RowsUpdated int

	SELECT @taskname = 'NNN Audit of Pre-Loan Requirements  ' + @Developer + ' - ' + @Project
	SELECT @DueTime = 19
	SELECT @DueDate = dateadd(day, 9, cast(@NoteDate as date))
	
	select @AdminID = ID from QCheck_Users where shortname = @Admin

	exec [QCheck_CopyChecklist] 
		@ChecklistID = @copyTaskID,
		@NewChecklistID = @newTaskID OUTPUT,
		@NewName = @taskname, 
		@NewOwner = @AdminID

	select @instanceID = id from QCheck_ChecklistInstances
	where checklistid = @newTaskID

	EXEC QCheck_UpdateSchedule_part1 
		@InstanceID = @instanceID, 
		@firstDueDate = @DueDate,
		@freqType = 1, 
		@dueTime = @DueTime,
		@PrevFreqType = @PrevFreqType output,
		@RowsUpdated = @RowsUpdated output,
		@Activate = 1,
		@SoftDueOffsetDays = 2

	declare @itt int
	exec QCheck_AddInstanceTaskType @InstanceID = @instanceID,@TaskType = @tasktype, @Priority = 1, @ID = @itt output

END
GO
*/

/****** Object:  StoredProcedure [dbo].[Util_CreatePHITaskWithPriority]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Util_CreatePHITaskWithPriority] (
	@TaskName VARCHAR(1000),
	@CreatedBy int,
	@Assignee int,
	@Assignee2 int = 0,
	@Assignee3 int= 0,
	@Controller int,
	@DueDate DATETIME, 
	@Section int,
	@Priority int,
	@PriorityUser int = null,
	@Comments varchar(1500) = null,
	@Alert DATETIME = null,
	@SoftDue DATETIME = null
) AS

BEGIN

	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE 
		@CallingProgram varchar(50),
		@ID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@errorCode int,
		@errorMsg varchar(500),
		@nagBeforeDays int,
		@nagTime int

	SELECT @CallingProgram = 'PHI Spreadsheet'

-- =======================================================
-- Initialize and validate inputs
-- =======================================================
	SET @errorCode = 0
	SET @errorMsg = ''
	
	--If(dbo.Util_IsOfficeDay(@DueDate)=0)--added by venkat 09/07/2018
	--Begin
	--set @DueDate=dbo.Util_NextOfficeDayMaintainTime(@DueDate)
	--End

	IF @SoftDue IS NULL SET @SoftDue = @DueDate

	-- Make sure a calling program was passed in
	IF @ErrorCode = 0 BEGIN
		IF LEN(@CallingProgram) = 0 BEGIN
			SET @ErrorCode = -1000
			SET @ErrorMsg = 'Zero-length calling program was given'
		END
	END

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @Section = 0 BEGIN
			--find a section for the group specified
			SELECT top 1 
				@TaskType = tt.ID
			FROM 
				QStatus_Report r
				INNER JOIN QCheck_GroupMembership gm1
					on gm1.GroupID = @Assignee
				INNER JOIN QStatus_GroupReport gr
					ON gr.ReportID = r.ID
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID = g.ID
					AND gm.UserID = gm1.UserID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ReportID = r.ID
					AND tt.IsDeleted = 0
					AND tt.NativeType = 0
			WHERE 
				r.IsDeleted = 0
			ORDER BY gr.defaultreport desc, r.ID, tt.displayOrder
		END ELSE BEGIN
			SELECT @TaskType = @Section
		END
		
		IF @TaskType is not null BEGIN
			SELECT @ReportID = ReportID
			FROM QStatus_TaskTypes
			WHERE ID = @TaskType

			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report'
			END
		END
	END


-- =======================================================
-- Set up the checklist
-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		/*
		EXEC dbo.QCheck_CreateSimple_part1 @ID, @TaskName, 1, @DueDate, @CreatedBy, @TaskType, @PrevFreqType OUTPUT, @RowsUpdated OUTPUT, @NewInstanceID OUTPUT, @NewActiveID OUTPUT, @assignee, 1, 0, @SoftDue			
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'QCheck_CreateSimple_part1 ' + cast(@ID as varchar) + ', ' + @TaskName + ', ' + cast(@DueDate as varchar) + ', ' + @CreatedBy + ', ' + @TaskType + ', assignedTo = ' + @assignee
		*/
		
		/*** LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
		DECLARE @ReminderDate DATETIME
		SET @ReminderDate = @SoftDue

		DECLARE @UserID int
		DECLARE @FolderID int
		DECLARE @FolderName varchar(50)

		DECLARE @PrevSchedule bit
		
		SET @PrevSchedule = 0

		SET @ReportID = 0

		SELECT @ReportID = reportID
		FROM
			QStatus_TaskTypes
		WHERE ID = @TaskType

		INSERT INTO QCheck_Checklists
		([Name], Owner)
		VALUES
		(@TaskName, @CreatedBy)

		SELECT @ID = @@IDENTITY	

		-- Creator is the controller
		DECLARE @ControllerGroupID int
		SELECT @ControllerGroupID = ID
		FROM QCheck_Groups
		WHERE owner = @CreatedBy
		AND SingleMemberGroup = 1

		INSERT INTO QCheck_ChecklistManagers
		(ChecklistID, ManagerGroupID)
		VALUES (@ID, @ControllerGroupID)

		EXEC QCheck_AddItem @ID, null, 1, @TaskName, ''

		EXEC QCheck_CreateInstance @NewInstanceID output, @ID, '', @CreatedBy

		EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee, @CreatedBy, 0
		if (@assignee2 > 0) EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee2, @CreatedBy, 0
		if (@assignee3 > 0) EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee3, @CreatedBy, 0

		---- KVS 2017-09-26 - Removing these default alerts per GPR/Nelson;
		----	Users who want them can add them manually
		---- Reminder 1 day before due
		--EXEC QCheck_AddAlert
		--		@InstanceID = @NewInstanceID, 
		--		@nagBeforeDays = 1,
		--		@nagTime = 17,
		--		@alertType = 'Reminder'
		
		---- 2/11/2014 dalvarado - Also set a reminder for 1 hour before due
		--EXEC QCheck_AddAlert
		--		@InstanceID = @NewInstanceID, 
		--		@nagBeforeDays = NULL,
		--		@nagTime = -1,
		--		@alertType = 'Reminder'
				
		DECLARE @DueTime INT = DATEPART(HOUR, @DueDate)

		EXEC QCheck_UpdateSchedule_part1 
				@InstanceID = @NewInstanceID, 
				@firstDueDate = @DueDate,
				@freqType = 1, 
				@dueTime = @DueTime,
				@PrevFreqType = @PrevFreqType output,
				@RowsUpdated = @RowsUpdated output,
				@Activate = 1
				--@busDayBehavior=3--added by venkat for testing

		SELECT @NewActiveID = ID
		FROM QCheck_ActiveChecklists
		WHERE InstanceID = @NewInstanceID

		-- Set the reminder date to whatever was passed in, if it's not past the due time
		UPDATE QCheck_ActiveChecklists
		SET ReminderDate = @ReminderDate
		WHERE 
			[ID] = @NewActiveID
			AND @ReminderDate <= DueTime

		IF @TaskType IS NOT NULL BEGIN
			DECLARE @NewTaskTypeID int
			EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT
		END      
		
		-- rebuild cache
		EXEC QCheck_ChecklistControllersList_Refresh @ID
		
		/*** END LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
	END
	
	-- Make sure the deadline is right--for some reason if you pass in 5pm, the task is due at 6pm.
	IF @ErrorCode = 0 BEGIN
		UPDATE QCheck_ActiveChecklists
		SET DueTime = @DueDate, OrigDueTime = @DueDate	
		WHERE ID = @NewActiveID
	END

	IF @ErrorCode = 0 BEGIN
		
		if len(isnull(ltrim(rtrim(@comments)), '')) > 0
		begin
			declare @NewID int,
				@initials varchar(100),
				@fn varchar(50)

			exec QStatus_CreateNewComment @NewActiveID, @CreatedBy, @comments, @NewID, @initials, @fn
		end
		update qstatus_report set isdirty = 1 where id = @reportID
	ENd

	-- Make the assigned group a controller on the task
	IF @errorCode = 0
	BEGIN
		UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @Controller
		WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = @NewInstanceID)
		
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'UPDATE QCheck_ChecklistManagers SET ManagerGroupID = ' + @assignee + ' WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = ' + CAST(@NewInstanceID AS varchar) + ')'
	END
	
	-- ADD To priority lists
	IF @errorCode = 0
	BEGIN
		IF @PriorityUser > 0
		BEGIN	
			exec [PriorityList_AddTask] @PriorityUser, @NewActiveID, @Priority
			SET @errorCode = @@ERROR
			IF @ErrorCode <> 0 SET @errorMsg = 'ADD TO PRIORITIES'
		END	
		ELSE
		BEGIN
			IF @Priority > 0
			BEGIN
				exec [PriorityList_AddTask_ForGroup] @CreatedBy, @Assignee, @NewActiveID, @Priority
				SET @errorCode = @@ERROR
				IF @ErrorCode <> 0 SET @errorMsg = 'ADD TO PRIORITIES'
			END	
			
		END
	END
	
	-- Create a reminder
	IF @Alert IS NOT NULL BEGIN
		SET @nagBeforeDays = ABS(DATEDIFF(DAY, @DueDate, @Alert))
		SET @nagTime = DATEPART(HOUR, @Alert)
		EXEC QCheck_AddReminder	@NewInstanceID, @nagBeforeDays, @nagTime
	END
	
	
-- =======================================================
-- Alert on any errors
-- =======================================================

	IF @errorCode <> 0
	BEGIN
		DECLARE @msg varchar(5000)
		DECLARE @MailSubject VARCHAR(1000)
		SET @MailSubject = @AppName + ' Automated Task Creation Error'
		SET @msg = 'Calling Program: ' + @CallingProgram + '<br/><br/>Error Number: ' + cast(@errorCode AS varchar) + '<br/><br/>' + @errorMsg
		EXEC XPSendEmail
		    @FROM       = @FromAddress,
		    @FROM_NAME  = 'SQLMail',
		    @TO         = @DeveloperAddress,
		    @subject    = @MailSubject,
		    @message    = @msg,
		    @type       = 'text/html',
		    @server     = @MailServer

		RAISERROR ('Unable to create task', 16, 1)
	END
	ELSE
	BEGIN
		SELECT @AppURL = appurl from qcheck_appsettings s
		inner join qcheck_users u
		on s.ID = u.App
		WHERE u.ID = @CreatedBy

		if @ReportID is null
		begin
			select @AppURL as appUrl
		end
		else
		begin
			select @AppURL + '/MyStatus.aspx?reportID=' + convert(varchar(10), @reportId) + '&taskID=' + convert(varchar(10), @NewActiveID)  as appUrl
		
		end

	END	
	
	SET NOCOUNT OFF

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateQUFollowupTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[Util_CreateQUFollowupTask]
	(
		@UserVideoHistoryID int,
		@GroupAssigned varchar(100)
	)
AS
BEGIN
	RETURN
	--Declare @copyTaskID int = 1892661
	--Declare @AdminID int = 50
	--Declare @DueTime float
	--Declare @PrevFreqType int
	--Declare @RowsUpdated int
	--Declare @instanceID int
	--Declare @newChecklistID int
	--Declare @DueDate datetime
	--Declare @login varchar(100)
	--Declare @Assignee int
	--Declare @Controller int
	--Declare @videoguid varchar(100)
	--Declare @taskname varchar(100)

	--select @taskname ='QU Assignment - ' + fullname + ' - ' + videoname, 
	--	@login = [login] ,
	--	@DueDate = cast(dateadd(day, 14, reminderstart) as date),
	--	@videoguid = cast(videoguid as varchar(100))
	--from MediaContent.dbo.UserVideoHistory where ID = @UserVideoHistoryID
	
	--if @DueDate < dbo.Util_nextOfficeDay(getdate())
	--begin
	--	set @DueDate = dbo.Util_nextOfficeDay(getdate())
	--end

	--SELECT @DueTime = 19

	--SELECT 
	--TOP 1
	--	 @Assignee = g.ID
	--FROM
	--	QCheck_Groups g
	--WHERE
	--	g.Name = @GroupAssigned

	--EXEC [QCheck_CopyChecklist] 
	--	@ChecklistID = @copyTaskID,
	--	@NewChecklistID = @newChecklistID OUTPUT,
	--	@NewName = @taskname,
	--	@Force = 1

	--update qcheck_items
	--set  [text] = [text] + '/?videoguid=' + @videoguid,
	--	[url] = [url] + '/?videoguid=' + @videoguid
	--where checklistid = @newChecklistID
	--and len(isnull(url, '')) > 0 

	--exec [QCheck_CreateInstance] 
	--	@ID = @instanceID output,
	--	@ChecklistID = @newChecklistID,
	--	@CreatedBy = @AdminID
	
	--exec QCheck_AddAssignedTo
	--	@InstanceID = @instanceID,
	--	@GroupID = @Assignee,
	--	@AssignedBy = @AdminID,
	--	@Email = 0

	--EXEC QCheck_UpdateSchedule_part1 
	--	@InstanceID = @instanceID, 
	--	@firstDueDate = @DueDate,
	--	@freqType = 1, 
	--	@dueTime = @DueTime,
	--	@PrevFreqType = @PrevFreqType output,
	--	@RowsUpdated = @RowsUpdated output,
	--	@Activate = 1

	--UPDATE QCheck_ChecklistManagers
	--	SET ManagerGroupID = @Assignee
	--	where ChecklistID = @newChecklistID

	--DECLARE @NewActiveID int = 0
	--SELECT @NewActiveID = ID
	--FROM QCheck_ActiveChecklists
	--WHERE InstanceID = @instanceID

	--UPDATE MediaContent.dbo.UserVideoHistory
	--set QPActiveChecklistID = @NewActiveID
	--WHERE ID = @UserVideoHistoryID

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateQUTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Proc [dbo].[Util_CreateQUTask]
	(
		@UserVideoHistoryID int
	)
AS
BEGIN
	RETURN

	--Declare @copyTaskID int = 1882558
	--Declare @AdminID int = 50
	--Declare @DueTime float
	--Declare @PrevFreqType int
	--Declare @RowsUpdated int
	--Declare @instanceID int
	--Declare @newChecklistID int
	--Declare @DueDate datetime
	--Declare @login varchar(100)
	--Declare @Assignee int
	--Declare @Controller int
	--Declare @videoguid varchar(100)
	--Declare @taskname varchar(100)

	--select @taskname ='QU Assignment - ' + fullname + ' - ' + videoname, 
	--	@login = [login] ,
	--	@DueDate = cast(dateadd(day, 14, reminderstart) as date),
	--	@videoguid = cast(videoguid as varchar(100))
	--from MediaContent.dbo.UserVideoHistory where ID = @UserVideoHistoryID
	
	--if @DueDate < dbo.Util_nextOfficeDay(getdate())
	--begin
	--	set @DueDate = dbo.Util_nextOfficeDay(getdate())
	--end

	--SELECT @DueTime = 19

	--SELECT 
	--TOP 1
	--	 @Controller = us.SupervisorGroupID,  @Assignee = us.UserGroupID
	--FROM
	--	QStatus_UserSupervisors us
	--	INNER JOIN QCheck_Users u
	--		ON us.UserID = u.[ID]
	--	WHERE
	--		u.ShortName = @login

	--SELECT @Controller = ISNULL(@Controller, @Assignee)

	--EXEC [QCheck_CopyChecklist] 
	--	@ChecklistID = @copyTaskID,
	--	@NewChecklistID = @newChecklistID OUTPUT,
	--	@NewName = @taskname,
	--	@Force = 1

	--update qcheck_items
	--set  [text] = [text] + '/?videoguid=' + @videoguid,
	--	[url] = [url] + '/?videoguid=' + @videoguid
	--where checklistid = @newChecklistID
	--and len(isnull(url, '')) > 0 

	--exec [QCheck_CreateInstance] 
	--	@ID = @instanceID output,
	--	@ChecklistID = @newChecklistID,
	--	@CreatedBy = @AdminID
	
	--exec QCheck_AddAssignedTo
	--	@InstanceID = @instanceID,
	--	@GroupID = @Assignee,
	--	@AssignedBy = @AdminID,
	--	@Email = 0

	--EXEC QCheck_UpdateSchedule_part1 
	--	@InstanceID = @instanceID, 
	--	@firstDueDate = @DueDate,
	--	@freqType = 1, 
	--	@dueTime = @DueTime,
	--	@PrevFreqType = @PrevFreqType output,
	--	@RowsUpdated = @RowsUpdated output,
	--	@Activate = 1

	--UPDATE QCheck_ChecklistManagers
	--	SET ManagerGroupID = @Controller
	--	where ChecklistID = @newChecklistID

	--DECLARE @NewActiveID int = 0
	--SELECT @NewActiveID = ID
	--FROM QCheck_ActiveChecklists
	--WHERE InstanceID = @instanceID

	--UPDATE MediaContent.dbo.UserVideoHistory
	--set QPActiveChecklistID = @NewActiveID
	--WHERE ID = @UserVideoHistoryID

END
GO
/****** Object:  StoredProcedure [dbo].[Util_CreateTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[Util_CreateTask] (
	@CallingProgram VARCHAR(500),
	@TaskName VARCHAR(1000),
	@Assignee VARCHAR(50),
	@DueDate DATETIME = NULL, -- Optional, defaults to tomorrow
	@StatusReportName VARCHAR(50) = NULL, -- Optional, required if a section is supplied
	@StatusReportSection VARCHAR(50) = NULL, -- Optional, required if a status report is supplied
	@CreatedBy varchar(50) = NULL,
	@Controller varchar(50) = NULL
) AS

BEGIN

	SET NOCOUNT ON
	
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer FROM QCheck_AppSettings WHERE ID = 1

	DECLARE 
		@ID int,
		@CreatedByID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@assignedTo int,
		@controlledBy int,
		@errorCode int,
		@errorMsg varchar(500),
		@GroupName VARCHAR(50)

-- =======================================================
-- Initialize and validate inputs
-- =======================================================
	SET @errorCode = 0
	SET @errorMsg = ''

	-- Make sure a calling program was passed in
	IF @ErrorCode = 0 BEGIN
		IF LEN(@CallingProgram) = 0 BEGIN
			SET @ErrorCode = -1000
			SET @ErrorMsg = 'Zero-length calling program was given'
		END
	END

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the assigned group name
	IF @ErrorCode = 0 BEGIN
		SELECT @AssignedTo = [ID] FROM QCheck_Groups WHERE [Name] = @Assignee
		IF @AssignedTo IS NULL BEGIN
			-- See if what was passed in was a login
			SELECT @GroupName = Names FROM tblEmployees WHERE LogInID = @Assignee
			IF @GroupName IS NOT NULL BEGIN
				SELECT @AssignedTo = [ID] FROM QCheck_Groups WHERE [Name] = @GroupName
			END

			-- check and see if assignedTo is the userid in the users table
			IF @AssignedTo IS NULL BEGIN	
				SELECT @AssignedTo = g.[ID] 
				FROM QCheck_Groups g
				INNER JOIN QCheck_Groupmembership gm
					ON gm.groupid = g.ID
					and g.singlemembergroup = 1
				INNER JOIN QCheck_Users u
					ON gm.userid = u.id
					and u.shortname = @Assignee
				
				-- If not, throw an error
				IF @AssignedTo IS NULL BEGIN	
					SET @ErrorCode = -1002
					SET @ErrorMsg = 'Could not find group "' + ISNULL(@Assignee, 'NULL') + '"'
				END
			END
		END
	END
	
	-- Look up the controller group name
	IF @ErrorCode = 0 BEGIN
		IF @Controller is null
		BEGIN
			SELECT @controlledBy = @AssignedTo
		END
		ELSE
		BEGIN
			SELECT @controlledBy = [ID] FROM QCheck_Groups WHERE [Name] = @Controller

			IF @controlledBy IS NULL BEGIN
				-- See if what was passed in was a login
				SELECT @GroupName = Names FROM tblEmployees WHERE LogInID = @Controller
				IF @GroupName IS NOT NULL BEGIN
					SELECT @controlledBy = [ID] FROM QCheck_Groups WHERE [Name] = @GroupName
				END
				-- If not, throw an error
				IF @controlledBy IS NULL BEGIN			
					SET @ErrorCode = -1002
					SET @ErrorMsg = 'Could not find group "' + ISNULL(@controlledBy, 'NULL') + '"'
				END
			END
		END
	END


	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @StatusReportName IS NOT NULL BEGIN
			SELECT @ReportID = [ID] FROM QStatus_Report WHERE [Name] = @StatusReportName
			IF @StatusReportSection IS NULL BEGIN
				SET @ErrorCode = -1003
				SET @ErrorMsg = 'Status report name was given but no section name was given'
			END
			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report ' + ISNULL(@StatusReportName, 'NULL')
			END
		END
	END

	-- Look up the status report section, if one was passed in.  A status report must be passed in and the section must be on the given status report.
	IF @ErrorCode = 0 BEGIN
		IF @StatusReportSection IS NOT NULL BEGIN
			SELECT @TaskType = [ID] FROM QStatus_TaskTypes WHERE [Description] = @StatusReportSection AND ReportID = @ReportID
			IF @TaskType IS NULL BEGIN
				SET @ErrorCode = -1005
				SET @ErrorMsg = 'Could not find status report section "' + ISNULL(@StatusReportSection, 'NULL') + '" on status report "' + ISNULL(@StatusReportName, 'NULL') + '"'
			END
			IF @StatusReportName IS NULL BEGIN
				SET @ErrorCode = -1006
				SET @ErrorMsg = 'Status report section was given but no status report name was given'
			END
		END
	END	

	-- Set up the defaults
	IF @ErrorCode = 0 BEGIN
		-- Due date defaults to tomorrow
		IF @DueDate IS NULL SET @DueDate = DATEADD(DAY, 1, GETDATE())
		IF @DueDate < DATEADD(DAY, 1, GETDATE()) SET @DueDate = DATEADD(DAY, 1, GETDATE())


		-- Tasks get created by the owner of the assigned group
		IF @CreatedBy is null
		begin
			SELECT @CreatedByID = Owner FROM QCheck_Groups WHERE [ID] = @AssignedTo
		end
		ELSE
		begin
			SELECT @CreatedByID = ID FROM QCheck_Users WHERE shortname = @CreatedBy
		end
	END

-- =======================================================
-- Set up the checklist
-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		EXEC dbo.QCheck_CreateSimple_part1 
			@ID, @TaskName, 1, @DueDate, @CreatedByID, @TaskType, 
			@PrevFreqType OUTPUT, @RowsUpdated OUTPUT, @NewInstanceID OUTPUT, @NewActiveID OUTPUT, @assignedTo, 1
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'QCheck_CreateSimple_part1 ' + cast(@ID as varchar) + ', ' + @TaskName + ', ' + cast(@DueDate as varchar) + ', ' + @CreatedByID + ', ' + @TaskType + ', assignedTo = ' + @assignedTo
	END

	-- Make the assigned group a controller on the task
	IF @errorCode = 0
	BEGIN
		UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @controlledBy
		WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = @NewInstanceID)
		
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'UPDATE QCheck_ChecklistManagers SET ManagerGroupID = ' + @controlledBy + ' WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = ' + CAST(@NewInstanceID AS varchar) + ')'
	END
	
-- =======================================================
-- Alert on any errors
-- =======================================================

	IF @errorCode <> 0
	BEGIN
		DECLARE @msg varchar(5000)
		SET @msg = 'Calling Program: ' + @CallingProgram + '<br/><br/>Error Number: ' + cast(@errorCode AS varchar) + '<br/><br/>' + @errorMsg
		
		DECLARE @MailSubject VARCHAR(1000)
		SET @MailSubject = @AppName + ' Automated Task Creation Error'
		
		EXEC XPSendEmail
		    @FROM       = @FromAddress,
		    @FROM_NAME  = 'SQLMail',
		    @TO         = @DeveloperAddress,
		    @subject    = @MailSubject,
		    @message    = @msg,
		    @type       = 'text/html',
		    @server     = @MailServer
	END	
	
	SET NOCOUNT OFF

END



GO
/****** Object:  StoredProcedure [dbo].[Util_CreateTask_PFSCentral]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

CREATE PROCEDURE [dbo].[Util_CreateTask_PFSCentral] (
	@TaskName varchar(1000),
	@Assignee int,
	@Controller int,
	@DueDate datetime,
	@Section int,
	@Priority int,
	@PriorityUser int = null,
	@Comments varchar(1500) = null,
	@Alert datetime = null,
	@SoftDue datetime = null
) AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE
		@ID int,
		@ReportID int,
		@TaskType int,
		@PrevFreqType int,
		@RowsUpdated int,
		@NewInstanceID int,
		@NewActiveID int,
		@scheduleID int,
		@ErrorCode int,
		@ErrorMsg varchar(500),
		@CreatedBy int,
		@nagBeforeDays int,
		@nagTime int


	-- =======================================================
	-- Initialize and validate inputs
	-- =======================================================
	SET @ErrorCode = 0
	SET @ErrorMsg = ''

	SET @CreatedBy = 0 -- system does it

	IF @SoftDue IS NULL SET @SoftDue = DATEADD(D, -7, @DueDate)

	-- Validate the task name
	IF @ErrorCode = 0 BEGIN
		IF LEN(@TaskName) = 0 BEGIN
			SET @ErrorCode = -1001
			SET @ErrorMsg = 'Zero-length task name was given'
		END
	END

	-- Look up the status report, if one was passed in
	IF @ErrorCode = 0 BEGIN
		IF @Section = 0 BEGIN
			--find a section for the group specified
			SELECT top 1 
				@TaskType = tt.ID
			FROM 
				QStatus_Report r
				INNER JOIN QCheck_GroupMembership gm1
					on gm1.GroupID = @Assignee
				INNER JOIN QStatus_GroupReport gr
					ON gr.ReportID = r.ID
				INNER JOIN QCheck_Groups g
					ON g.ID = gr.GroupID
				INNER JOIN QCheck_GroupMembership gm
					ON gm.GroupID = g.ID
					AND gm.UserID = gm1.UserID
				INNER JOIN QStatus_TaskTypes tt
					ON tt.ReportID = r.ID
					AND tt.IsDeleted = 0
					AND tt.NativeType = 0
			WHERE 
				r.IsDeleted = 0
			ORDER BY gr.defaultreport desc, r.ID, tt.displayOrder
		END ELSE BEGIN
			SELECT @TaskType = @Section
		END
		
		IF @TaskType is not null BEGIN
			SELECT @ReportID = ReportID
			FROM QStatus_TaskTypes
			WHERE ID = @TaskType

			IF @ReportID IS NULL BEGIN
				SET @ErrorCode = -1004
				SET @ErrorMsg = 'Could not find status report'
			END
		END
	END

	--SELECT 
	--	@TaskName = a.QueueName + ' | ' + cast(a.AccountNumber as varchar),
	--	@DueDate = ISNULL(a.ClaimDueDate, DATEADD(day, 1, GETDATE())),
	--	@CreatedBy = 163, -- Matthew Nunemacher's ID for now remains userID (0 could represent sys did it)
	--	@Controller = 163, -- group ID not user; same as assignee
	--	@Assignee = g.ID -- needs to come from a group
	--FROM #accounts a
	--	INNER JOIN dbo.QCheck_Users u
	--		ON a.UserCode = u.empID
	--	INNER JOIN dbo.QCheck_GroupMembership gm
	--		ON u.ID = gm.UserID
	--	INNER JOIN dbo.QCheck_Groups g
	--		ON gm.GroupID = g.ID AND g.SingleMemberGroup = 1


	-- =======================================================
	-- Set up the checklist
	-- =======================================================

	-- Create the task
	IF @ErrorCode = 0 BEGIN
		/*** LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
		DECLARE @ReminderDate DATETIME
		--SET @ReminderDate = @SoftDue
		SET @ReminderDate = @DueDate -- should a soft due be set? non-NSA should 20 days before hard due date

		DECLARE @UserID int
		DECLARE @FolderID int
		DECLARE @FolderName varchar(50)

		DECLARE @PrevSchedule bit
		
		SET @PrevSchedule = 0

		SET @ReportID = 0
		SET @TaskType = 103987 -- Current Section on Status Report

		SELECT @ReportID = ReportID -- Should be 10515
		FROM
			QStatus_TaskTypes
		WHERE ID = @TaskType

		INSERT INTO QCheck_Checklists
		([Name], Owner)
		VALUES
		(@TaskName, @CreatedBy)

		SELECT @ID = @@IDENTITY	

		-- Creator is the controller
		--DECLARE @ControllerGroupID int
		--SELECT @ControllerGroupID = gm.UserID
		--FROM QCheck_Groups g
		--LEFT OUTER JOIN QCheck_GroupMembership gm
		--	ON g.ID = gm.GroupID
		--WHERE gm.GroupID = @CreatedBy
		--AND g.SingleMemberGroup = 1

		--INSERT INTO QCheck_ChecklistManagers
		--(ChecklistID, ManagerGroupID)
		--VALUES (@ID, @ControllerGroupID)

		EXEC QCheck_AddItem @ID, null, 1, @TaskName, ''

		EXEC QCheck_CreateInstance @NewInstanceID output, @ID, '', @CreatedBy -- Checklist 1->* ChecklistInstance 1->* ActiveChecklist

		--EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee, @ControllerGroupID, 1
		EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee, @Controller, 1-- we assign to groups (even individuals are a group of 1) should multiple assignments just go to a group? do the groups exist or do they need to be created?
		--if (@assignee2 > 0) EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee2, @ControllerGroupID, 1
		--if (@assignee3 > 0) EXEC QCheck_AddAssignedTo @NewInstanceID, @assignee3, @ControllerGroupID, 1

		---- KVS 2017-09-26 - Removing these default alerts per GPR/Nelson;
		----	Users who want them can add them manually
		---- Reminder 1 day before due
		EXEC QCheck_AddAlert
				@InstanceID = @NewInstanceID, 
				@nagBeforeDays = 1,
				@nagTime = 17,
				@alertType = 'Reminder'
		
		---- 2/11/2014 dalvarado - Also set a reminder for 1 hour before due
		--EXEC QCheck_AddAlert
		--		@InstanceID = @NewInstanceID, 
		--		@nagBeforeDays = NULL,
		--		@nagTime = -1,
		--		@alertType = 'Reminder'
				
		DECLARE @DueTime INT = DATEPART(HOUR, @DueDate)

		EXEC QCheck_UpdateSchedule_part1 
				@InstanceID = @NewInstanceID, 
				@firstDueDate = @DueDate,
				@freqType = 1, 
				@dueTime = @DueTime,
				@PrevFreqType = @PrevFreqType output,
				@RowsUpdated = @RowsUpdated output,
				@Activate = 1
				--@busDayBehavior=3--added by venkat for testing

		SELECT @NewActiveID = ID
		FROM QCheck_ActiveChecklists
		WHERE InstanceID = @NewInstanceID

		-- Set the reminder date to whatever was passed in, if it's not past the due time
		UPDATE QCheck_ActiveChecklists
		SET ReminderDate = @ReminderDate
		WHERE 
			[ID] = @NewActiveID
			AND @ReminderDate <= DueTime

		IF @TaskType IS NOT NULL BEGIN
			DECLARE @NewTaskTypeID int
			EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT
		END      
		
		-- rebuild cache
		EXEC QCheck_ChecklistControllersList_Refresh @ID
		
		/*** END LOGIC FROM QCheck_CreateSimple_Part1 with a fix for the due time ***/
	END
	
	-- Make sure the deadline is right--for some reason if you pass in 5pm, the task is due at 6pm.
	IF @ErrorCode = 0 BEGIN
		UPDATE QCheck_ActiveChecklists
		SET DueTime = @DueDate, OrigDueTime = @DueDate	
		WHERE ID = @NewActiveID
	END

	IF @ErrorCode = 0 BEGIN
		
		if len(isnull(ltrim(rtrim(@comments)), '')) > 0
		begin
			declare @NewID int,
				@initials varchar(100),
				@fn varchar(50)

			exec QStatus_CreateNewComment @NewActiveID, @CreatedBy, @comments, @NewID, @initials, @fn
		end
		update qstatus_report set isdirty = 1 where id = @reportID
	END

	-- Make the assigned group a controller on the task / who should the controllers be?
	IF @errorCode = 0
	BEGIN
		UPDATE QCheck_ChecklistManagers
		SET ManagerGroupID = @Controller
		WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = @NewInstanceID)
		
		SET @errorCode = @@ERROR
		IF @ErrorCode <> 0 SET @errorMsg = 'UPDATE QCheck_ChecklistManagers SET ManagerGroupID = ' + @assignee + ' WHERE ChecklistID = (SELECT ChecklistID FROM QCheck_ChecklistInstances WHERE ID = ' + CAST(@NewInstanceID AS varchar) + ')'
	END

	-- Create a reminder
	IF @Alert IS NOT NULL BEGIN
		SET @nagBeforeDays = ABS(DATEDIFF(DAY, @DueDate, @Alert))
		SET @nagTime = DATEPART(HOUR, @Alert)
		EXEC QCheck_AddReminder	@NewInstanceID, @nagBeforeDays, @nagTime
	END
END
GO
/****** Object:  StoredProcedure [dbo].[util_CT_GuardCameraCheck]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[util_CT_GuardCameraCheck](
       @ID int
)
as
BEGIN
       SET NOCOUNT ON
       DECLARE @ChkText VARCHAR(max)
       DECLARE @UserText VARCHAR(100)
       DECLARE @TaskName VARCHAR(MAX)
	   DECLARE @SequenceNum INT
	   DECLARE @Assignee INT

       DECLARE @DueDate DATETIME
       

       DECLARE checkbox_CURS CURSOR FOR

       SELECT DISTINCT k.Text, ai.text As UserText, k.sequencenum
              FROM 
                     QCheck_ActiveChecklists a
              INNER JOIN
                     QCheck_ChecklistInstances e 
                 ON
                     a.InstanceID = e.ID and e.isDeleted = 0
              INNER JOIN
                     QCheck_Checklists f
                 ON
                     e.ChecklistID = f.ID and f.isDeleted = 0
              INNER JOIN QCheck_Items k on k.checklistID = f.ID AND k.IsDeleted = 0
              INNER JOIN QCheck_ItemTypes it on k.ItemTypeID = it.ID
              LEFT OUTER JOIN QCheck_ActiveItems ai on ai.ActiveChecklistID = a.ID and ai.ChecklistItemID = k.ID
              WHERE
                     a.ID = @ID
                     and it.ID = 1
                     and len(isNull(ai.text, '')) > 0
                     and isNull(ai.text, '') != 'n/a'
              ORDER BY 
                     k.SequenceNum
                     
       OPEN checkbox_CURS
       FETCH NEXT FROM checkbox_CURS INTO @ChkText, @UserText, @SequenceNum
       WHILE @@FETCH_STATUS = 0 BEGIN
			  
              Select @TaskName = 'Camera Issue - ' + @ChkText
			  Select @Assignee = 1613
			  if not exists (SELECT c.Name
				  FROM [dbo].[QCheck_Checklists] c
				  inner join dbo.[QCheck_ChecklistInstances] ci on c.id = ci.ChecklistID
				  inner join dbo.[QCheck_ActiveChecklists] ac on ci.id = ac.InstanceID
				  inner join dbo.[QCheck_Assignments] a on ci.id = a.InstanceID
				  where c.name like @TaskName and a.GroupID = @Assignee and ac.CompletedDate is NULL)
			  Begin
				SELECT @DueDate = DATEADD(DAY, 2, CAST(CAST(GETDATE() AS DATE) AS DATETIME))
				EXEC [dbo].[Util_CreateEmailTaskWithPriority] @TaskName = @TaskName, @CreatedBy = 591, @Assignee = @Assignee, @Controller = 93, @DueDate = @DueDate, @Section = 1112653, @Priority = 1
			  End

              Select @TaskName = 'Camera Issue Check- ' + @ChkText
			  Select @Assignee = 2235
			  SELECT @DueDate = DATEADD(DAY, 5, CAST(CAST(GETDATE() AS DATE) AS DATETIME))
			  EXEC [dbo].[Util_CreateEmailTask] @TaskName = @TaskName, @CreatedBy = 591, @Assignee = @Assignee, @Controller = 93, @DueDate = @DueDate, @Section = 1151242

              FETCH NEXT FROM checkbox_CURS INTO @ChkText, @UserText, @SequenceNum
       END
       CLOSE checkbox_CURS
       DEALLOCATE checkbox_CURS

END;
GO
/****** Object:  StoredProcedure [dbo].[Util_DefaultDeadlines]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Util_DefaultDeadlines]
AS
BEGIN
	DECLARE @DueTime int

	SELECT @DueTime = duetime from QCheck_UserDefaultTimes
	WHERE UserID = -1

	SELECT DATEADD(HOUR, @DueTime, CONVERT(DATETIME, CONVERT(DATE, dbo.Util_NextOfficeDayMaintainTime(GETDATE())))) as deadline

END
GO
/****** Object:  StoredProcedure [dbo].[Util_Email2DBTasksEmailTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[Util_Email2DBTasksEmailTask](
--DECLARE
	@TaskName VARCHAR(1000),-- = 'WOHELP - Cameras - from jdoe@example.com'
	@emailSender VARCHAR(1000) = null,
	@emailToRecipients VARCHAR(1000) = null,
	@email2dbTrigger int,
	@messagebody varchar(max) = null,
	@uid varchar(1000) = null
) AS 
BEGIN


	DECLARE @AssignedGroupID INT,
		@ControllerGroupID INT,
		@SectionID INT,
		@DueDaysAhead INT,
		@TasksCreatedBy INT,
		@emailSenderGroupID INT,
		@alerteeGroup INT,
		@priorityUser INT,
		@email2dbmimetext varchar(max)

		SELECT @AssignedGroupID = AssignedGroupID,
		@ControllerGroupID = ControllerGroupID,
		@SectionID = SectionID,
		@DueDaysAhead = DueDaysAhead,
		@TasksCreatedBy = TasksCreatedBy,
		@priorityUser = priorityUser
	FROM Util_Email2DBTasks
	where triggerID = @email2dbTrigger

	--select @TaskName = @TaskName + ' sent in ' + convert(varchar, getdate(), 101)

	DECLARE @DueDate DATETIME
	SELECT @DueDate = DATEADD(DAY, @DueDaysAhead, CAST(CAST(GETDATE() AS DATE) AS DATETIME))

	Select @emailSenderGroupID = g.ID
    FROM QCheck_Groups g
    Inner join QCheck_Users u on u.FullName = g.Name and g.SingleMemberGroup = 1
    where u.Email = @emailSender
	select @ControllerGroupID
	EXEC [dbo].[Util_CreateEmailTask] @TaskName = @TaskName, @CreatedBy = @TasksCreatedBy,
		@Assignee = @AssignedGroupID, @Controller = @ControllerGroupID, @DueDate = @DueDate, @Section = @SectionID 

    DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @AppFromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50), @DeveloperAddress VARCHAR(50), @ITAddress VARCHAR(50), @MailServer VARCHAR(50)
		SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @AppFromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress, @DeveloperAddress = DeveloperAddress, @ITAddress = ITAddress, @MailServer = MailServer 
		FROM QCheck_AppSettings WHERE ID = 1

	Declare @ActiveChecklistId int, @InstanceID int, @ChecklistID int
	select TOP 1 @ActiveChecklistId = ac.Id, @InstanceID = ac.InstanceID, @ChecklistID = c.ID from QCheck_ActiveChecklists ac
		JOIN QCheck_ChecklistInstances ci ON ac.InstanceID = ci.ID AND ci.IsDeleted = 0
		JOIN QCheck_Checklists c ON c.ID = ci.ChecklistID AND c.IsDeleted = 0
	WHERE c.name = @TaskName
	ORDER BY ac.ID DESC

	EXEC [dbo].[QCheck_AddItem] @ChecklistID = @ChecklistID, @ItemTypeID = 1, @Text = 'I confirm that I have read the email body in its entirely and all requested steps are complete', @URL = ''

	-- Add the body of the email to the task
	if len(@messagebody) > 0
	begin
		EXEC [dbo].[QCheck_AddItem] @ChecklistID = @ChecklistID, @ItemTypeID = 2, @Text = 'Email Body:', @URL = ''

		declare @line varchar(1000)
		declare @splits table
		(
			id int identity(1,1),
			lineitem varchar(1000)
		)

		declare @end int, @split int
		set @split = 1000
		while (len(@messagebody) >0)
		begin
			if len(@messagebody) > @split
			begin
				set @end = len(left(@messagebody, @split)) - charindex(' ', reverse(left(@messagebody, @split)))
				if (@end <=0)
				begin
					set @end = @split
				end
				select @line = rtrim(ltrim(left(left(@messagebody, @split), @end)))
				insert into @splits select @line
				select @messagebody = substring(@messagebody, @end + 1, len(@messagebody))
			end
			else
			begin
				insert into @splits select @messagebody
				select @line = @messagebody
				set @messagebody = ''
			end

			
			EXEC [dbo].[QCheck_AddItem] @ChecklistID = @ChecklistID, @ItemTypeID = 3, @Text = @line, @URL = ''

		end

	end
	
	-- Add image to the task if one was sent in
	if len(isnull(@uid, '')) > 0
	begin
		
		insert into Email2dbImageChecklists ([uid], [checklistid]) select @uid, @ChecklistID

	end

	-- Add completion alerts
	select @alerteeGroup = alerteeGroupID FROM Util_Email2DBTasks
	where triggerID = @email2dbTrigger
	if @alerteeGroup is not null
		begin
			exec [dbo].QCheck_AddAlert @InstanceID = @InstanceID, @alerteegroupid = @alerteeGroup, @alertType = 'Complete'
		end

	if @emailSenderGroupID is not null 
    begin                
		exec [dbo].QCheck_AddAlert @InstanceID = @InstanceID, @alerteegroupid = @emailSenderGroupID, @alertType = 'Complete'
	end
	--Add to priority list if needed
	if @priorityUser is not null
	begin
		exec [dbo].[PriorityList_AddTask]  @priorityUser, @ActiveChecklistID, 1--add to priority list
	end

	--Auto assign the task to whoever was in the ToList of the original email
	declare @assigneeIDlist varchar(1000)
	select @assigneeIDlist = string_agg( g.ID, ',')
	FROM dbo.QCheck_Groups g
		Inner join dbo.QCheck_Users u on u.FullName = g.Name and g.SingleMemberGroup = 1
		inner join dbo.Util_split(@emailToRecipients,',') spl on spl.Data = u.email
		where g.id not in (39, 1633, 1641, 1928)

	if @assigneeIDlist is not null
	begin
		EXEC [dbo].[QCheck_UpdateAssigneesForTask]--update Assignee
		 @ActiveChecklistID ,
		     @assigneeIDlist,
		     @TasksCreatedBy

		Declare @NewInstanceID int,@TaskType int,@Priority int,@DueTime int

		SELECT @TaskType=Report,@Priority=Priority--,@DueDaysAhead=Due
		FROM QStatus_AutomationEmailPreferences
		WHERE UserID = @TasksCreatedBy

		select @NewInstanceID=InstanceID from QCheck_ActiveChecklists_All where id=@ActiveChecklistId
	 
		If @TaskType>0
		Begin
		DECLARE @NewTaskTypeID int
		EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT--add it to status report
		End

		If @Priority>0
		Begin

			declare @assigneeID int
			Declare assigneeCursor cursor for
				SELECT n FROM dbo.Util_fn_List_To_Table(@assigneeIDlist,',')
			open assigneeCursor
			fetch next from assigneeCursor into @assigneeID
			while @@FETCH_STATUS = 0
			begin
				exec [PriorityList_AddTask_ForGroup] @TasksCreatedBy,  @assigneeID, @ActiveChecklistID, @Priority--add to priority list
				fetch next from assigneeCursor into @assigneeID
				End
			Close assigneeCursor
			deallocate assigneeCursor
		End
	
		--SELECT @DueDate = DATEADD(DAY, @DueDaysAhead, CAST(CAST(GETDATE() AS DATE) AS DATETIME))
		--select @DueDate = dateadd(day, datediff(day,'19000101',@DueDate), CAST('19:00' AS DATETIME))
		UPDATE QCheck_ActiveChecklists--update due date
			SET DueTime = @DueDate	
			WHERE ID = @ActiveChecklistID
	end

	--Original query below; errors if more than one task has *ever* been created for the same e-mail sender and subject
    --select @ActiveChecklistId=Id from QCheck_ActiveChecklists 
	--where InstanceID=(select Id from QCheck_ChecklistInstances 
	--                   where ChecklistID=(select Id from QCheck_Checklists where name = @TaskName and IsDeleted=0) 
	--				   and IsDeleted=0) 
	
	-- Create assignment email for WOHelp tasks
	if @email2dbTrigger = 1
	Begin
		Create table #href
		( 
		  Id int identity(1,1),
		  name varchar(500)
		)
		Create table #href2
		( 
		  Id int identity(1,1),
		  AssigneeGroupId int,
		  name varchar(500)
		)
		insert into #href2 (AssigneeGroupId,name)
			SELECT n, '<b> (Already Assigned) </b>' FROM dbo.Util_fn_List_To_Table(@assigneeIDlist,',')
		insert into #href(name)
		select '<tr><td><a href='+ @ExternalURL + '/ReAssignTasksFromEmail.aspx?ActiveChecklistId='+Convert(varchar(50),@ActiveChecklistID)+'&AssigneeGroupId='+Convert(varchar(10),S.UserGroupID)+'&AssignedById='+Convert(varchar(10),@ControllerGroupID) +'>'+U.FullName + isnull(h2.name,'') +'</a></td></tr>'
	
		from QStatus_UserSupervisors  S
		inner join QCheck_Users U on S.UserID=U.ID
		left outer join #href2 h2 on s.UserGroupID = h2.AssigneeGroupId
		where S.SupervisorGroupID=@ControllerGroupID
		order by u.FullName
	
		--DECLARE @xml NVARCHAR(MAX)=''
		-- select @xml = CAST(( SELECT name AS 'td',''
	 --   from #href
	 --   FOR XML PATH('tr'), ELEMENTS,TYPE ).value('.', 'nvarchar(MAX)') AS NVARCHAR(MAX))
		----select @xml
		declare @concatAssignees varchar(max)=''
		declare @counter int=1
		declare @count int=1
		select @count=count(*) from #href
		while(@counter<=@count)
		Begin
			select @concatAssignees=@concatAssignees+ISNULL(name, '') from #href where Id=@counter
			set @counter=@counter+1
		End

		Declare @body varchar(max)
		SET @body = '<html><body><H3>Select the Assignee from the below list to reassign the task</H3><br>
				<table border = 1>
				<tr>
				<th>Assignee</th>
				</tr>'
	  -- SET @body = @body + @xml +'</table></body></html>'
	   SET @body = @body + @concatAssignees +'</table></body></html>'
	   Declare @toEmailddress varchar(100)
	   select @toEmailddress=U.Email from QCheck_Users U
	   inner join qcheck_groupmembership gm on U.id = gm.userid
		where gm.groupid=@ControllerGroupID

		Declare @subject varchar(500)='ReAssign WO Help Task: '+@TaskName
			,@from_address varchar(50) = (SELECT TOP 1 Email2DBFromAddress FROM QCheck_AppSettings)

	   EXEC dbo.xp_smtp_sendmail --this email is for Controller
	
	--		@FROM = 'qpt@automation.acmenetwork.com',
			@FROM = @from_address,
			@to = @toEmailddress, 
	
		
			@subject = @subject,

			@message = @Body, 
	
			@type = 'text/html', 
			@server = @MailServer

		DROP TABLE #href
		DROP TABLE #href2
	END

END

GO
/****** Object:  StoredProcedure [dbo].[Util_FindStatus_ByName]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE   PROCEDURE [dbo].[Util_FindStatus_ByName] (
	@Name VARCHAR(50) = '',
	@Exact BIT = 0
) AS

SELECT 
	ID, 
	Name, 
	IsConfidential, 
	LastReportDate
FROM
	QStatus_Report
WHERE
	IsDeleted = 0
	AND Name LIKE CASE 
		WHEN @Exact = 0 THEN '%' + @Name + '%'
		ELSE Name
	END
	AND Name = CASE
		WHEN @Exact = 1 THEN @Name
		ELSE Name
	END





GO
/****** Object:  StoredProcedure [dbo].[Util_GetActiveChecklists]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_GetActiveChecklists] (
	@ChecklistName VARCHAR(1000)
) AS

SELECT
	g.Name AS AssignedTo,
	ac.*
FROM
	QCheck_Checklists c
	INNER JOIN QCheck_ChecklistInstances ci
		ON c.ID = ci.ChecklistID
	INNER JOIN QCheck_ActiveChecklists ac
		ON ci.ID = ac.InstanceID
	INNER JOIN QCheck_ActiveAssignments aa
		ON ac.ID = aa.ActiveChecklistID
	INNER JOIN QCheck_Assignments a
		ON aa.AssignmentsID = a.ID
	INNER JOIN QCheck_Groups g
		ON a.GroupID = g.ID
WHERE
	c.Name = @ChecklistName
GO
/****** Object:  StoredProcedure [dbo].[Util_GetOfficeDayForQPAS]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Util_GetOfficeDayForQPAS]
	@date datetime,
	@result datetime output
as
begin
    set @result=@date
	if(dbo.Util_IsOfficeDay(@date)=0)
	Begin
	select @result = dbo.Util_NextOfficeDayMaintainTime(@date)
	End

	select @result
end
GO
/****** Object:  StoredProcedure [dbo].[Util_GetUserTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_GetUserTasks] (
	@Username VARCHAR(50)
) AS

SELECT DISTINCT
	c.Name AS Task,
	CONVERT(VARCHAR(10), ac.DueTime, 101) + ' ' + LTRIM(RIGHT(CONVERT(VARCHAR(20), ac.DueTime), 7)) AS [Next Due],
	dbo.QCheck_AssigneesList(ci.ID) AS Assignees,
	dbo.QCheck_ManagersList(c.ID) AS Controllers,
	dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule,
	ac.DueTime
FROM 
	QCheck_ActiveChecklists ac
	INNER JOIN QCheck_ChecklistInstances ci
		ON ac.InstanceID = ci.ID
		AND ac.CompletedDate IS NULL
		AND ci.IsDeleted = 0
	INNER JOIN QCheck_Checklists c
		ON ci.ChecklistID = c.ID
		AND c.IsDeleted = 0
	INNER JOIN (
		SELECT 
			InstanceID,
			MIN(ID) AS ID
		FROM 
			QCheck_ActiveChecklists
		WHERE
			CompletedDate IS NULL
		GROUP BY
			InstanceID
	) f
		ON ac.ID = f.ID
	INNER JOIN QCheck_Assignments a
		ON ci.ID = a.InstanceID
		AND a.IsDeleted = 0
	INNER JOIN QCheck_Groups g
		ON a.GroupID = g.ID
	INNER JOIN QCheck_GroupMembership gm
		ON g.ID = gm.GroupID
	INNER JOIN QCheck_Users u
		ON gm.UserID = u.ID
WHERE
	u.ShortName = @Username
ORDER BY 
	ac.DueTime
	
GO
/****** Object:  StoredProcedure [dbo].[Util_GradeTest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE     PROCEDURE [dbo].[Util_GradeTest] (
--DECLARE
	@TesterGroupID INT,-- = 436,
	@TestDate DATETIME-- = '2024-02-15'
) AS
BEGIN

	DECLARE @RawScore FLOAT = 0,
			@TesterUserID INT,
			@Username VARCHAR(50),
			@Fullname varchar(100),
			@TesterReportID INT,
			@Count INT,
			@TestGraders INT,
			@TestAssignee INT,
			@Prefix varchar(5)

	--TODO: this is much better handled using an app setting, but whatev
	SELECT @Prefix = LEFT(DB_NAME() COLLATE Latin1_General_BIN, 5)
	DECLARE @done bit = 0

	WHILE @done = 0 AND LEN(@Prefix) > 0
	BEGIN
		IF NOT UNICODE(RIGHT(@Prefix, 1)) BETWEEN 65 AND 90
			SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
		ELSE SET @done = 1
	END
	--Take off the first character of the second term, either a "P" or "T"
	SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
	
	--SELECT @Prefix

	SELECT 
		@TesterUserID = u.ID,
		@Username = u.ShortName,
		@Fullname = u.fullname,
		@TesterReportID = r.ID
	FROM 
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
		INNER JOIN QStatus_Report r
			ON u.FullName = r.Name
			AND r.IsDeleted = 0
	WHERE 
		g.ID = @TesterGroupID
		AND u.IsDeleted = 0
		AND g.SingleMemberGroup = 1
		AND u.FullName = g.Name

	--SELECT 
	--	@TesterGroupID TesterGroupID,
	--	@TesterUserID TesterUserID,
	--	@Username Username,
	--	@Fullname Fullname,
	--	@TesterReportID TesterReportID,
	--	@TestDate TestDate
		

	declare 
		@checklistcount int, 
		@itemcount int, 
		@reportcount int, 
		@sectioncount int, 
		@prioritiescount int, 
		@commentscount int, 
		@groupscount int

	--select *
	--from qcheck_checklists 
	--where owner = @testerUserID
	--and CreateDate > @TestDate
	--and name like @Prefix + '%test%'

	select @checklistcount = isnull(count(id), 0) 
	from qcheck_checklists 
	where owner = @testerUserID
		and CreateDate > @TestDate
		and name like @Prefix + '%test%'

	--select @checklistcount checklistcount

	if @checklistcount > 0 set @checklistcount = @checklistcount + 1
	if @checklistcount > 14 set @checklistcount = 14

	--select *
	--from qcheck_checklists c
	--	inner join qcheck_items i
	--		on i.checklistid = c.id
	--where c.owner = @testerUserID
	--	and c.CreateDate > @TestDate
	--	and c.name like @Prefix + '%test%5%'

	select @itemcount = isnull(count(i.id), 0) 
	from qcheck_checklists c
		inner join qcheck_items i
			on i.checklistid = c.id
	where c.owner = @testerUserID
		and c.CreateDate > @TestDate
		and c.name like @Prefix + '%test%5%'

	--select @itemcount itemcount

	--if @itemcount > 0 set @itemcount = @itemcount + 2

	if @itemcount > 8 set @itemcount = 8

	--Making sure there are 4 types of checklist items
	IF (
		SELECT COUNT(DISTINCT ItemTypeID) from qcheck_checklists c
			inner join qcheck_items i
				on i.checklistid = c.id
		where c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%5%'			
	) = 4
		set @itemcount = @itemcount + 1

	--Specifically looking for URL added to "Step 2"
	IF EXISTS (
		SELECT 'Y' from qcheck_checklists c
			inner join qcheck_items i
				on i.checklistid = c.id
		where c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%5%'
			AND i.Text = 'Step 2'
			AND i.URL LIKE 'http%google%com%'
	)
		set @itemcount = @itemcount + 1

	IF (
		select COUNT(*) from QCheck_ActiveAssignments aa
			JOIN QCheck_ActiveChecklists ac 
				ON ac.ID = aa.ActiveChecklistID
			JOIN QCheck_ChecklistInstances ci 
				ON ci.ID = ac.InstanceID
			JOIN QCheck_Checklists c 
				ON c.ID = ci.ChecklistID 
		WHERE c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%6'
	) = 2
		set @itemcount = @itemcount + 1

	--select *  
	--from qstatus_report r
	--	inner join qstatus_groupreport gr
	--		on r.id = gr.reportid
	--		AND gr.AsOf > @TestDate
	--	inner join qcheck_groupmembership gm
	--		on gm.groupid = gr.groupid
	--			and gm.userid = @testerUserID
	--			and r.name like '%' + @Prefix + '%proces%report%'

	SET @reportcount = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report'
		WHERE r.IsDeleted = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%2'
		WHERE r.IsDeleted = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%3'
		WHERE r.IsDeleted = 1

	--select @reportcount reportcount
			
	if @reportcount > 3 set @reportcount = 3	

	select @sectioncount = count(tt.id)
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%rep%'
		inner join qstatus_tasktypes tt
			on tt.reportid = r.id
			and tt.description like '%task%'

	if @sectioncount > 3 set @sectioncount = 3

	--select @sectioncount sectioncount

	--select *
	--from prioritylist pl
	--	inner join qcheck_activechecklists ac
	--		on ac.id = pl.activechecklistid
	--	inner join qcheck_checklistinstances ci
	--		on ci.id = ac.instanceid
	--	inner join qcheck_checklists c
	--		on c.id= ci.checklistid
	--		and c.name like @Prefix + '%test%'
	--where userid = @testerUserID

	select @prioritiescount = count(pl.id) 
	from prioritylist pl
		inner join qcheck_activechecklists ac
			on ac.id = pl.activechecklistid
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
	where userid = @testerUserID

	--select @prioritiescount prioritiescount

	if @prioritiescount > 10 set @prioritiescount = 10

	--select *
	--from qstatus_comments comm
	--	inner join qcheck_activechecklists ac
	--		on ac.id = comm.foreignkeyid 
	--		and comm.specialtask = 0
	--		and comm.userid = @testerUserID
	--	inner join qcheck_checklistinstances ci
	--		on ci.id = ac.instanceid
	--	inner join qcheck_checklists c
	--		on c.id= ci.checklistid
	--		and c.name like @Prefix + '%test%'
	--		and c.owner = @testerUserID
	--		and c.CreateDate > @TestDate

	select @commentscount = count(c.id) 
	from qstatus_comments comm
		inner join qcheck_activechecklists ac
			on ac.id = comm.foreignkeyid 
			and comm.specialtask = 0
			and comm.userid = @testerUserID
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
			and c.owner = @testerUserID
			and c.CreateDate > @TestDate

	--select @commentscount commentscount
		
	if @commentscount > 0 set @commentscount = @commentscount
	if @commentscount > 5 set @commentscount = 5

	select @groupscount = count(id) from qcheck_groups
	where owner = @testerUserID
	and name like '%' + @Prefix + '%test%'

	--select @groupscount groupscount

	if @groupscount > 1 set @groupscount = 1

	--SELECT 
	--	sectioncount = @sectioncount,
	--	reportcount = @reportcount,
	--	itemcount = @itemcount,
	--	checklistcount = @checklistcount,
	--	prioritiescount = @prioritiescount,
	--	commentscount = @commentscount,
	--	groupscount = @groupscount

	--New "Written Section" - worth a max of 8 points with opportunity for makeup credit
	DECLARE @writtenSection int = 0
	
	--"Total Tasks" = 12 (*could* be 13 if within two weeks of a calendar quarter - no points off for that)
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Total Tasks% 12' 
				OR name like @Prefix + 'Process Total Tasks% 13')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Calendar Tasks" = 10
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Calendar Tasks% 10')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Controlled Tasks" = 4
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Controlled Tasks% 4')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Report Tasks" = 3
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Report Tasks% 3')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Priority Tasks" = 4
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Priority Tasks% 4')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Change Requests" = 3
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Change Requests% 3')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Timeline Tasks" = 0
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Timeline Tasks% 0')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Group - Sample Process"
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Group%Sample%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Search - Choose AND Logic if..."
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Search%Choose AND logic%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Help - Every task needs to be assigned..."
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Help%Every task needs to be assigned%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	if @writtenSection > 9 set @writtenSection = 9

	SELECT @RawScore  = 2 * (@sectioncount + @reportcount + @itemcount + @checklistcount + @prioritiescount + @commentscount) + @groupscount + @writtenSection

	insert into Grading_QProcessTests (employee, grade, gradeddt)
	values (@Fullname,@RawScore, getdate());

	select @RawScore AS Score

END
GO
/****** Object:  StoredProcedure [dbo].[Util_GradeTest_Breakdown]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE     PROCEDURE [dbo].[Util_GradeTest_Breakdown] (
--DECLARE
	@TesterGroupID INT,-- = 352,
	@TestDate DATETIME-- = '2024-02-16'
) AS
BEGIN

	DECLARE @RawScore FLOAT = 0,
			@TesterUserID INT,
			@Username VARCHAR(50),
			@Fullname varchar(100),
			@TesterReportID INT,
			@Count INT,
			@TestGraders INT,
			@TestAssignee INT,
			@Prefix varchar(5)

	--TODO: this is much better handled using an app setting, but whatev
	SELECT @Prefix = LEFT(DB_NAME() COLLATE Latin1_General_BIN, 5)
	DECLARE @done bit = 0

	WHILE @done = 0 AND LEN(@Prefix) > 0
	BEGIN
		IF NOT UNICODE(RIGHT(@Prefix, 1)) BETWEEN 65 AND 90
			SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
		ELSE SET @done = 1
	END
	--Take off the first character of the second term, either a "P" or "T"
	SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
	
	--SELECT @Prefix

	SELECT 
		@TesterUserID = u.ID,
		@Username = u.ShortName,
		@Fullname = u.fullname,
		@TesterReportID = r.ID
	FROM 
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
		INNER JOIN QStatus_Report r
			ON u.FullName = r.Name
			AND r.IsDeleted = 0
	WHERE 
		g.ID = @TesterGroupID
		AND u.IsDeleted = 0
		AND g.SingleMemberGroup = 1
		AND u.FullName = g.Name

	SELECT @Prefix Prefix,
		@TesterGroupID TesterGroupID,
		@TesterUserID TesterUserID,
		@Username Username,
		@Fullname Fullname,
		@TesterReportID TesterReportID,
		@TestDate TestDate
		

	declare 
		@checklistcount int, 
		@itemcount int, 
		@reportcount int, 
		@sectioncount int, 
		@prioritiescount int, 
		@commentscount int, 
		@groupscount int

	select *
	from qcheck_checklists 
	where owner = @testerUserID
		and CreateDate > @TestDate
		and name like @Prefix + '%test%'

	select @checklistcount = isnull(count(id), 0) 
	from qcheck_checklists 
	where owner = @testerUserID
		and CreateDate > @TestDate
		and name like @Prefix + '%test%'

	--select @checklistcount checklistcount

	if @checklistcount > 0 set @checklistcount = @checklistcount + 1
	if @checklistcount > 14 set @checklistcount = 14

	select *
	from qcheck_checklists c
		inner join qcheck_items i
			on i.checklistid = c.id
	where c.owner = @testerUserID
		and c.CreateDate > @TestDate
		and c.name like @Prefix + '%test%5%'

	select @itemcount = isnull(count(i.id), 0) 
	from qcheck_checklists c
		inner join qcheck_items i
			on i.checklistid = c.id
	where c.owner = @testerUserID
		and c.CreateDate > @TestDate
		and c.name like @Prefix + '%test%5%'

	--select @itemcount itemcount

	--if @itemcount > 0 set @itemcount = @itemcount + 2

	if @itemcount > 8 set @itemcount = 8

	--Making sure there are 4 types of checklist items
	IF (
		SELECT COUNT(DISTINCT ItemTypeID) from qcheck_checklists c
			inner join qcheck_items i
				on i.checklistid = c.id
		where c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%5%'			
	) = 4
		set @itemcount = @itemcount + 1

	--Specifically looking for URL added to "Step 2"
	IF EXISTS (
		SELECT 'Y' from qcheck_checklists c
			inner join qcheck_items i
				on i.checklistid = c.id
		where c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%5%'
			AND i.Text = 'Step 2'
			AND i.URL LIKE 'http%google%com%'
	)
		set @itemcount = @itemcount + 1	

	--Looking for two assignments on *Process Test 6
	IF (
		select COUNT(*) from QCheck_ActiveAssignments aa
			JOIN QCheck_ActiveChecklists ac 
				ON ac.ID = aa.ActiveChecklistID
			JOIN QCheck_ChecklistInstances ci 
				ON ci.ID = ac.InstanceID
			JOIN QCheck_Checklists c 
				ON c.ID = ci.ChecklistID 
		WHERE c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%6'
	) = 2
		set @itemcount = @itemcount + 1

	set @itemcount = CASE WHEN @itemcount > 10 THEN 10 ELSE @itemcount END

	select *  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%'

	SET @reportcount = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report'
		WHERE r.IsDeleted = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%2'
		WHERE r.IsDeleted = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%3'
		WHERE r.IsDeleted = 1

	--select @reportcount reportcount
			
	if @reportcount > 3 set @reportcount = 3	

	select @sectioncount = count(tt.id)
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%rep%'
		inner join qstatus_tasktypes tt
			on tt.reportid = r.id
			and tt.description like '%task%'

	if @sectioncount > 3 set @sectioncount = 3

	--select @sectioncount sectioncount

	select *
	from prioritylist pl
		inner join qcheck_activechecklists ac
			on ac.id = pl.activechecklistid
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
	where userid = @testerUserID

	select @prioritiescount = count(pl.id) 
	from prioritylist pl
		inner join qcheck_activechecklists ac
			on ac.id = pl.activechecklistid
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
	where userid = @testerUserID

	--select @prioritiescount prioritiescount

	if @prioritiescount >= 9 set @prioritiescount = 10

	select *
	from qstatus_comments comm
		inner join qcheck_activechecklists ac
			on ac.id = comm.foreignkeyid 
			and comm.specialtask = 0
			and comm.userid = @testerUserID
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
			and c.owner = @testerUserID
			and c.CreateDate > @TestDate

	select @commentscount = count(c.id) 
	from qstatus_comments comm
		inner join qcheck_activechecklists ac
			on ac.id = comm.foreignkeyid 
			and comm.specialtask = 0
			and comm.userid = @testerUserID
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
			and c.owner = @testerUserID
			and c.CreateDate > @TestDate

	--select @commentscount commentscount
		
	if @commentscount > 0 set @commentscount = @commentscount
	if @commentscount > 5 set @commentscount = 5

	select @groupscount = count(id) from qcheck_groups
	where owner = @testerUserID
	and name like '%' + @Prefix + '%test%'

	--select @groupscount groupscount

	if @groupscount > 1 set @groupscount = 1

	--SELECT 
	--	sectioncount = @sectioncount,
	--	reportcount = @reportcount,
	--	itemcount = @itemcount,
	--	checklistcount = @checklistcount,
	--	prioritiescount = @prioritiescount,
	--	commentscount = @commentscount,
	--	groupscount = @groupscount

	--New "Written Section" - worth a max of 9 points with opportunity for makeup credit
	DECLARE @writtenSection int = 0

	SELECT *
	from qcheck_checklists 
	where owner = @testerUserID
		and CreateDate > @TestDate
		and (name like @Prefix + '%Process % Tasks%'
		OR name like @Prefix + '%Process Change Requests%'
		OR name like @Prefix + '%Process Group%'
		OR name like @Prefix + '%Process Search%'
		OR name like @Prefix + '%Process Help%')
	
	--"Total Tasks" = 12 (*could* be 13 if within two weeks of a calendar quarter - no points off for that)
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Total Tasks% 12' 
				OR name like @Prefix + 'Process Total Tasks% 13')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Calendar Tasks" = 10
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Calendar Tasks% 10')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Controlled Tasks" = 4
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Controlled Tasks% 4')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Report Tasks" = 3
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Report Tasks% 3')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Priority Tasks" = 4
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Priority Tasks% 4')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Change Requests" = 3
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Change Requests% 3')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Timeline Tasks" = 0
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Timeline Tasks% 0')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Group - Sample Process"
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Group%Sample%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Search - Choose AND Logic if..."
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Search%Choose AND logic%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Help - Every task needs to be assigned..."
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Help%Every task needs to be assigned%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	if @writtenSection > 9 set @writtenSection = 9

	SELECT 
		"Checklists (14) x2" = @checklistcount,
		"Items (10) x2" = @itemcount,
		"Reports (3) x2" = @reportcount,
		"Sections (3) x2" = @sectioncount,
		"Priorities (10) x2" = @prioritiescount,
		"Comments (5) x2" = @commentscount,
		"Groups (1)" = @groupscount,
		"Written (9)" = @writtensection

	SELECT @RawScore  = 2 * (@sectioncount + @reportcount + @itemcount + @checklistcount + @prioritiescount + @commentscount) + @groupscount + @writtenSection

	--insert into Grading_QProcessTests (employee, grade, gradeddt)
	--values (@Fullname,@RawScore, getdate());

	select @RawScore AS Score

END
GO
/****** Object:  StoredProcedure [dbo].[Util_GradeTest_Breakdown_KVS]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE   PROCEDURE [dbo].[Util_GradeTest_Breakdown_KVS]
	
	@TesterGroupID INT= null,
	@TestDate DATETIME = null,
	@Tester varchar(100) = null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @Prefix varchar(5)

	--TODO: this is much better done with some app setting
	SELECT @Prefix = LEFT(DB_NAME() COLLATE Latin1_General_BIN, 5)
	DECLARE @done bit = 0
	WHILE @done = 0 AND LEN(@Prefix) > 0
	BEGIN
		IF NOT UNICODE(RIGHT(@Prefix, 1)) BETWEEN 65 AND 90
			SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
		ELSE SET @done = 1
	END
	--Take off the first character of the second term, either a "P" or "T"
	SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
	--SELECT @Prefix

	if @TesterGroupID is null select @TesterGroupID = id from qcheck_groups where name like @Tester + '%'
	
	declare @testerUserID int = (select top 1 userid from qcheck_groupmembership where groupid = @testergroupid)

	declare @checklistcount int, @itemcount int, @reportcount int, @sectioncount int, @prioritiescount int, @commentscount int, @groupscount int

	select @checklistcount = isnull(count(id), 0) 
	from qcheck_checklists 
	where owner = @testerUserID
	and name like @Prefix + '%test%'

	if @checklistcount > 0 set @checklistcount = @checklistcount + 1

	if @checklistcount > 14 set @checklistcount = 14

	select @itemcount = isnull(count(i.id), 0) 
	from qcheck_checklists c
		inner join qcheck_items i
			on i.checklistid = c.id
	where c.owner = @testerUserID
	and c.name like @Prefix + '%test%5%'


	if @itemcount > 0 set @itemcount = @itemcount + 2

	if @itemcount > 10 set @itemcount = 10

	select @reportcount = isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%proces%rep%'
			
	if @reportcount > 3 set @reportcount = 3


	select @sectioncount = count(tt.id)
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%proces%rep%'
		inner join qstatus_tasktypes tt
			on tt.reportid = r.id
			and tt.description like '%task%'

	if @sectioncount > 3 set @sectioncount = 3

	select @prioritiescount = count(pl.id) from prioritylist pl
		inner join qcheck_activechecklists ac
			on ac.id = pl.activechecklistid
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
	where userid = @testerUserID

	if @prioritiescount > 8 set @prioritiescount = 8

	select @commentscount = count(c.id) from qstatus_comments comm
		inner join qcheck_activechecklists ac
			on ac.id = comm.foreignkeyid 
			and comm.specialtask = 0
			and comm.userid = @testerUserID
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
			and c.owner = @testerUserID

	if @commentscount > 0 set @commentscount = @commentscount + 2
	if @commentscount > 6 set @commentscount = 6

	select @groupscount = count(id) from qcheck_groups
	where owner = @testerUserID
	and name like '%' + @Prefix + '%test%'

	if @groupscount > 1 set @commentscount = 1

	select @TesterGroupID as 'group'
	select cast(@checklistcount as varchar(10)) + ' out of 14 checklists'
	select cast(@itemcount as varchar(10)) + ' out of 10 items'
	select cast(@reportcount as varchar(10)) + ' out of 3 reports'
	select cast(@sectioncount as varchar(10)) + ' out of 3 sections'
	select cast(@prioritiescount as varchar(10)) + ' out of 8 priorities'
	select cast(@commentscount as varchar(10)) + ' out of 6 comments'
	select cast(@groupscount as varchar(10)) + ' out of 1 group'

	select 2* (@sectioncount + @reportcount + @itemcount + @checklistcount + @prioritiescount + @commentscount + @groupscount) AS Score


END
GO
/****** Object:  StoredProcedure [dbo].[Util_GradeTest_KVS]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[Util_GradeTest_KVS] (
--DECLARE
	@TesterGroupID INT,-- = 66,
	@TestDate DATETIME-- = '2024-02-08'
) AS
BEGIN

	DECLARE @RawScore FLOAT = 0,
			@TesterUserID INT,
			@Username VARCHAR(50),
			@Fullname varchar(100),
			@TesterReportID INT,
			@Count INT,
			@TestGraders INT,
			@TestAssignee INT,
			@Prefix varchar(5)

	--TODO: this is much better handled using an app setting, but whatev
	SELECT @Prefix = LEFT(DB_NAME() COLLATE Latin1_General_BIN, 5)
	DECLARE @done bit = 0

	WHILE @done = 0 AND LEN(@Prefix) > 0
	BEGIN
		IF NOT UNICODE(RIGHT(@Prefix, 1)) BETWEEN 65 AND 90
			SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
		ELSE SET @done = 1
	END
	--Take off the first character of the second term, either a "P" or "T"
	SET @Prefix = LEFT(@Prefix, LEN(@Prefix) - 1)
	
	--SELECT @Prefix

	SELECT 
		@TesterUserID = u.ID,
		@Username = u.ShortName,
		@Fullname = u.fullname,
		@TesterReportID = r.ID
	FROM 
		QCheck_Users u
		INNER JOIN QCheck_GroupMembership gm
			ON u.ID = gm.UserID
		INNER JOIN QCheck_Groups g
			ON gm.GroupID = g.ID
		INNER JOIN QStatus_Report r
			ON u.FullName = r.Name
			AND r.IsDeleted = 0
	WHERE 
		g.ID = @TesterGroupID
		AND u.IsDeleted = 0
		AND g.SingleMemberGroup = 1
		AND u.FullName = g.Name

	--SELECT 
	--	@TesterGroupID TesterGroupID,
	--	@TesterUserID TesterUserID,
	--	@Username Username,
	--	@Fullname Fullname,
	--	@TesterReportID TesterReportID,
	--	@TestDate TestDate
		

	declare 
		@checklistcount int, 
		@itemcount int, 
		@reportcount int, 
		@sectioncount int, 
		@prioritiescount int, 
		@commentscount int, 
		@groupscount int

	--select *
	--from qcheck_checklists 
	--where owner = @testerUserID
	--and CreateDate > @TestDate
	--and name like @Prefix + '%test%'

	select @checklistcount = isnull(count(id), 0) 
	from qcheck_checklists 
	where owner = @testerUserID
		and CreateDate > @TestDate
		and name like @Prefix + '%test%'

	--select @checklistcount checklistcount

	if @checklistcount > 0 set @checklistcount = @checklistcount + 1
	if @checklistcount > 14 set @checklistcount = 14

	--select *
	--from qcheck_checklists c
	--	inner join qcheck_items i
	--		on i.checklistid = c.id
	--where c.owner = @testerUserID
	--	and c.CreateDate > @TestDate
	--	and c.name like @Prefix + '%test%5%'

	select @itemcount = isnull(count(i.id), 0) 
	from qcheck_checklists c
		inner join qcheck_items i
			on i.checklistid = c.id
	where c.owner = @testerUserID
		and c.CreateDate > @TestDate
		and c.name like @Prefix + '%test%5%'

	--select @itemcount itemcount

	--if @itemcount > 0 set @itemcount = @itemcount + 2

	if @itemcount > 8 set @itemcount = 8

	--Making sure there are 4 types of checklist items
	IF (
		SELECT COUNT(DISTINCT ItemTypeID) from qcheck_checklists c
			inner join qcheck_items i
				on i.checklistid = c.id
		where c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%5%'			
	) = 4
		set @itemcount = @itemcount + 1

	--Specifically looking for URL added to "Step 2"
	IF EXISTS (
		SELECT 'Y' from qcheck_checklists c
			inner join qcheck_items i
				on i.checklistid = c.id
		where c.owner = @testerUserID
			AND c.CreateDate > @TestDate
			AND c.name like @Prefix + '%test%5%'
			AND i.Text = 'Step 2'
			AND i.URL LIKE 'http%google%com%'
	)
		set @itemcount = @itemcount + 1

	--select *  
	--from qstatus_report r
	--	inner join qstatus_groupreport gr
	--		on r.id = gr.reportid
	--		AND gr.AsOf > @TestDate
	--	inner join qcheck_groupmembership gm
	--		on gm.groupid = gr.groupid
	--			and gm.userid = @testerUserID
	--			and r.name like '%' + @Prefix + '%proces%report%'

	SET @reportcount = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report'
		WHERE r.IsDeleted = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%2'
		WHERE r.IsDeleted = 0

	select @reportcount = @reportcount + isnull(count(r.id), 0)  
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
			AND gr.AsOf > @TestDate
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%report%3'
		WHERE r.IsDeleted = 1

	--select @reportcount reportcount
			
	if @reportcount > 3 set @reportcount = 3	

	select @sectioncount = count(tt.id)
	from qstatus_report r
		inner join qstatus_groupreport gr
			on r.id = gr.reportid
		inner join qcheck_groupmembership gm
			on gm.groupid = gr.groupid
				and gm.userid = @testerUserID
				and r.name like '%' + @Prefix + '%process%rep%'
		inner join qstatus_tasktypes tt
			on tt.reportid = r.id
			and tt.description like '%task%'

	if @sectioncount > 3 set @sectioncount = 3

	--select @sectioncount sectioncount

	--select *
	--from prioritylist pl
	--	inner join qcheck_activechecklists ac
	--		on ac.id = pl.activechecklistid
	--	inner join qcheck_checklistinstances ci
	--		on ci.id = ac.instanceid
	--	inner join qcheck_checklists c
	--		on c.id= ci.checklistid
	--		and c.name like @Prefix + '%test%'
	--where userid = @testerUserID

	select @prioritiescount = count(pl.id) 
	from prioritylist pl
		inner join qcheck_activechecklists ac
			on ac.id = pl.activechecklistid
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
	where userid = @testerUserID

	--select @prioritiescount prioritiescount

	if @prioritiescount > 10 set @prioritiescount = 10

	select *
	from qstatus_comments comm
		inner join qcheck_activechecklists ac
			on ac.id = comm.foreignkeyid 
			and comm.specialtask = 0
			and comm.userid = @testerUserID
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
			and c.owner = @testerUserID
			and c.CreateDate > @TestDate

	select @commentscount = count(c.id) 
	from qstatus_comments comm
		inner join qcheck_activechecklists ac
			on ac.id = comm.foreignkeyid 
			and comm.specialtask = 0
			and comm.userid = @testerUserID
		inner join qcheck_checklistinstances ci
			on ci.id = ac.instanceid
		inner join qcheck_checklists c
			on c.id= ci.checklistid
			and c.name like @Prefix + '%test%'
			and c.owner = @testerUserID
			and c.CreateDate > @TestDate

	--select @commentscount commentscount
		
	if @commentscount > 0 set @commentscount = @commentscount
	if @commentscount > 5 set @commentscount = 5

	select @groupscount = count(id) from qcheck_groups
	where owner = @testerUserID
	and name like '%' + @Prefix + '%test%'

	--select @groupscount groupscount

	if @groupscount > 1 set @commentscount = 1

	--SELECT 
	--	sectioncount = @sectioncount,
	--	reportcount = @reportcount,
	--	itemcount = @itemcount,
	--	checklistcount = @checklistcount,
	--	prioritiescount = @prioritiescount,
	--	commentscount = @commentscount,
	--	groupscount = @groupscount

	--New "Written Section" - worth a max of 8 points with opportunity for makeup credit
	DECLARE @writtenSection int = 0
	
	--"Total Tasks" = 12 (*could* be 13 if within two weeks of a calendar quarter - no points off for that)
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Total Tasks - 12' 
				OR name like @Prefix + 'Process Total Tasks - 13')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Calendar Tasks" = 10
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Calendar Tasks - 10')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Controlled Tasks" = 4
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Controlled Tasks - 4')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Report Tasks" = 3
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Report Tasks - 3')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Priority Tasks" = 4
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Priority Tasks - 4')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Change Requests" = 3
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Change Requests - 3')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Timeline Tasks" = 0
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Timeline Tasks - 0')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Group - Sample Process"
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Group - Sample%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Search - Choose AND Logic if..."
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Search - Choose AND logic%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	--"Process Help - Every task needs to be assigned..."
	IF(SELECT isnull(count(id), 0) 
		from qcheck_checklists 
		where owner = @testerUserID
			and CreateDate > @TestDate
			and (name like @Prefix + 'Process Help - Every task needs to be assigned%')
	) = 1
		SET @writtenSection = @writtenSection + 1

	if @writtenSection > 9 set @writtenSection = 9

	SELECT @RawScore  = 2 * (@sectioncount + @reportcount + @itemcount + @checklistcount + @prioritiescount + @commentscount) + @groupscount + @writtenSection

	--insert into Grading_QProcessTests (employee, grade, gradeddt)
	--values (@Fullname,@RawScore, getdate());

	select @RawScore AS Score

END
GO
/****** Object:  StoredProcedure [dbo].[Util_GradeTest_OLD]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[Util_GradeTest_OLD] (
	@TesterGroupID INT,
	@TestDate DATETIME
) AS
BEGIN


DECLARE @RawScore FLOAT = 0,
		@TesterUserID INT,
		@Username VARCHAR(50),
		@Fullname varchar(100),
		@TesterReportID INT,
		@Count INT,
		@TestGraders INT,
		@TestAssignee INT

SELECT 
	@TesterUserID = u.ID,
	@Username = u.ShortName,
	@Fullname = u.fullname,
	@TesterReportID = r.ID
FROM 
	QCheck_Users u
	INNER JOIN QCheck_GroupMembership gm
		ON u.ID = gm.UserID
	INNER JOIN QCheck_Groups g
		ON gm.GroupID = g.ID
	INNER JOIN QStatus_Report r
		ON u.FullName = r.Name
		AND r.IsDeleted = 0
WHERE 
	g.ID = @TesterGroupID
	AND u.IsDeleted = 0
	AND g.SingleMemberGroup = 1
	AND u.FullName = g.Name

declare @checklistcount int, @itemcount int, @reportcount int, @sectioncount int, @prioritiescount int, @commentscount int, @groupscount int

select @checklistcount = isnull(count(id), 0) 
from qcheck_checklists 
where owner = @testerUserID
and name like 'PHI%test%'

if @checklistcount > 0 set @checklistcount = @checklistcount + 1
if @checklistcount > 14 set @checklistcount = 14

select @itemcount = isnull(count(i.id), 0) 
from qcheck_checklists c
	inner join qcheck_items i
		on i.checklistid = c.id
where c.owner = @testerUserID
and c.name like 'PHI%test%5%'

if @itemcount > 0 set @itemcount = @itemcount + 2

if @itemcount > 10 set @itemcount = 10

select @reportcount = isnull(count(r.id), 0)  
from qstatus_report r
	inner join qstatus_groupreport gr
		on r.id = gr.reportid
	inner join qcheck_groupmembership gm
		on gm.groupid = gr.groupid
			and gm.userid = @testerUserID
			and r.name like '%Phi%proces%rep%'
			
if @reportcount > 3 set @reportcount = 3


select @sectioncount = count(tt.id)
from qstatus_report r
	inner join qstatus_groupreport gr
		on r.id = gr.reportid
	inner join qcheck_groupmembership gm
		on gm.groupid = gr.groupid
			and gm.userid = @testerUserID
			and r.name like '%Phi%proces%rep%'
	inner join qstatus_tasktypes tt
		on tt.reportid = r.id
		and tt.description like '%task%'

if @sectioncount > 3 set @sectioncount = 3

select @prioritiescount = count(pl.id) from prioritylist pl
	inner join qcheck_activechecklists ac
		on ac.id = pl.activechecklistid
	inner join qcheck_checklistinstances ci
		on ci.id = ac.instanceid
	inner join qcheck_checklists c
		on c.id= ci.checklistid
		and c.name like 'PHI%test%'
where userid = @testerUserID

if @prioritiescount > 8 set @prioritiescount = 8

select @commentscount = count(c.id) from qstatus_comments comm
	inner join qcheck_activechecklists ac
		on ac.id = comm.foreignkeyid 
		and comm.specialtask = 0
		and comm.userid = @testerUserID
	inner join qcheck_checklistinstances ci
		on ci.id = ac.instanceid
	inner join qcheck_checklists c
		on c.id= ci.checklistid
		and c.name like 'PHI%test%'
		and c.owner = @testerUserID
		
if @commentscount > 0 set @commentscount = @commentscount + 2
if @commentscount > 6 set @commentscount = 6

select @groupscount = count(id) from qcheck_groups
where owner = @testerUserID
and name like '%phi%test%'

if @groupscount > 1 set @commentscount = 1

SELECT @RawScore  = 2* (@sectioncount + @reportcount + @itemcount + @checklistcount + @prioritiescount + @commentscount + @groupscount) + 10.0

insert into Grading_QProcessTests (employee, grade, gradeddt)
values (@Fullname,@RawScore, getdate());


select @RawScore AS Score

END
GO
/****** Object:  StoredProcedure [dbo].[Util_GroupUsage]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC Util_GroupUsage 'Westover Power'

CREATE PROCEDURE [dbo].[Util_GroupUsage] (
	@GroupName VARCHAR(500)
) AS

BEGIN

	DECLARE @Count INT

	SELECT @Count = COUNT(*) FROM QCheck_Groups WHERE Name = @GroupName

	IF @Count > 1 BEGIN

		SELECT 'More than one group found with name "' + @GroupName + '"'
		SELECT Name FROM QCheck_Groups WHERE Name = @GroupName
		RETURN

	END

	IF @Count = 0 BEGIN

		SELECT @Count = COUNT(*) FROM QCheck_Groups WHERE Name LIKE '%' + @GroupName + '%'

		IF @Count > 1 BEGIN

			SELECT 'More than one group found with name like "' + @GroupName + '"'
			SELECT Name FROM QCheck_Groups WHERE Name LIKE '%' + @GroupName + '%'
			RETURN

		END

		IF @Count = 0 BEGIN

			SELECT 'No group found with name like "' + @GroupName + '"'
			RETURN

		END

		SELECT @GroupName = Name FROM QCheck_Groups WHERE Name LIKE '%' + @GroupName + '%'

	END

	SELECT 'Searching for usage for group "' + @GroupName + '"'

	SELECT 
		c.Name AS [Assigned To Task],
		dbo.QCheck_AssigneesList(ci.ID) AS Assignees
	FROM
		QCheck_Groups g
		INNER JOIN QCheck_Assignments a
			ON g.ID = a.GroupID
			AND a.IsDeleted = 0
		INNER JOIN QCheck_ChecklistInstances ci
			ON a.InstanceID = ci.ID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
			AND c.IsDeleted = 0
	WHERE
		g.Name = @GroupName

	SELECT 
		c.Name AS [Controls Task],
		dbo.QCheck_ManagersList(c.ID) AS Controllers
	FROM
		QCheck_Groups g
		INNER JOIN QCheck_ChecklistManagers cm
			ON g.ID = cm.ManagerGroupID
			AND cm.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON cm.ChecklistID = c.ID
			AND c.IsDeleted = 0
	WHERE
		g.Name = @GroupName


	SELECT 
		r.Name AS [Controls Status Report]
	FROM
		QCheck_Groups g
		INNER JOIN QStatus_GroupReport gr
			ON g.ID = gr.GroupID
		INNER JOIN QStatus_Report r
			ON gr.ReportID = r.ID
			AND r.IsDeleted = 0
	WHERE
		g.Name = @GroupName

	SELECT
		c.Name AS 'Alertee On Task'
	FROM
		QCheck_Groups g
		INNER JOIN QCheck_Alerts a
			ON g.ID = a.AlerteeGroupID
			AND a.IsDeleted = 0
		INNER JOIN QCheck_ChecklistInstances ci
			ON a.InstanceID = ci.ID
			AND ci.IsDeleted = 0
		INNER JOIN QCheck_Checklists c
			ON ci.ChecklistID = c.ID
			AND c.IsDeleted = 0
	WHERE
		g.Name = @GroupName

END
GO
/****** Object:  StoredProcedure [dbo].[Util_ImpersonateUser]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[Util_ImpersonateUser] (
	@AdminUserName VARCHAR(50) = 'STOP',
	@ImpersonateUserName VARCHAR(50) = NULL
) AS

BEGIN

	IF @AdminUserName = 'STOP' BEGIN
	
		UPDATE QCheck_Impersonate SET IsDeleted = 1
	
	END ELSE BEGIN
	
		UPDATE QCheck_Impersonate SET IsDeleted = 1
	
		DECLARE @AdminID INT
		DECLARE @ImpersonateID INT
		
		SELECT @AdminID = [ID] FROM QCheck_Users WHERE ShortName = @AdminUserName
		SELECT @ImpersonateID = [ID] FROM QCheck_Users WHERE ShortName = @ImpersonateUserName

		IF @AdminID IS NULL BEGIN
			PRINT 'User ' + @AdminUserName + ' was not found'
		END ELSE BEGIN
			IF @ImpersonateID IS NULL BEGIN
				PRINT 'User ' + @ImpersonateUserName + ' was not found'
			END ELSE BEGIN
				UPDATE QCheck_Impersonate set ImpersonateUserID = @ImpersonateID, isDeleted = 0 where UserID =	@AdminID
				
				if @@ROWCOUNT = 0
				BEGIN
					INSERT INTO QCheck_Impersonate (UserID, ImpersonateUserID, IsDeleted) VALUES (@AdminID, @ImpersonateID, 0)
				END				
			END
		END
			
	END

END

GO
/****** Object:  StoredProcedure [dbo].[Util_IsUserOnReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE   PROCEDURE [dbo].[Util_IsUserOnReport] (
 	@UserID INT = NULL,
 	@Username VARCHAR(50) = NULL,
 	@ReportID INT = NULL,
 	@ReportName VARCHAR(100) = NULL
) AS


DECLARE @OnReport BIT
SET @OnReport = 0

SELECT 
	@OnReport = 1
FROM
	QCheck_Users U
	INNER JOIN QCheck_Groupmembership gm
		ON gm.UserID = u.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QStatus_GroupReport gr
		ON gr.GroupID = g.ID
	INNER JOIN QStatus_Report R
		ON gr.ReportID = R.ID
WHERE
	R.IsDeleted = 0
	AND U.IsDeleted = 0
	AND U.ID = CASE
		WHEN @UserID IS NULL THEN U.ID
		ELSE @UserID
	END
	AND U.ShortName = CASE
		WHEN @UserName IS NULL THEN U.ShortName
		ELSE @Username
	END
	AND R.ID = CASE
		WHEN @ReportID IS NULL THEN R.ID
		ELSE @ReportID
	END
	AND R.Name LIKE '%' + ISNULL(@ReportName, '') + '%'



SELECT 
	@OnReport = 1
FROM
	QCheck_Users U
	INNER JOIN QCheck_Groupmembership gm
		ON gm.UserID = u.ID
	INNER JOIN QCheck_Groups g
		ON g.ID = gm.GroupID
	INNER JOIN QStatus_Supervisors S
		ON S.SupervisorGroupID = g.ID
	INNER JOIN QStatus_Report R
		ON S.ReportID = R.ID
WHERE
	R.IsDeleted = 0
	AND U.IsDeleted = 0
	AND U.ID = CASE
		WHEN @UserID IS NULL THEN U.ID
		ELSE @UserID
	END
	AND U.ShortName = CASE
		WHEN @UserName IS NULL THEN U.ShortName
		ELSE @Username
	END
	AND S.ReportID = CASE
		WHEN @ReportID IS NULL THEN S.ReportID
		ELSE @ReportID
	END
	AND R.Name LIKE '%' + ISNULL(@ReportName, '') + '%'

SELECT @OnReport AS OnReport





GO
/****** Object:  StoredProcedure [dbo].[Util_LegalSearch]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_LegalSearch] (
	@StartDate DATETIME,
	@EndDate DATETIME,
	@Keyword VARCHAR(500)
) AS

BEGIN

	SELECT
		c.[Name] AS ChecklistName,
		cmt.CommentDt AS CommentDate,
		u.FullName AS CommentBy,
		cmt.Comments
	FROM
		vwAllChecklists c
		INNER JOIN vwAllChecklistInstances ci
			ON ci.ChecklistID = c.[ID]
		INNER JOIN vwAllActiveChecklists ac
			ON ac.InstanceID = ci.[ID]
		INNER JOIN vwAllComments cmt
			ON ac.[ID] = cmt.ForeignKeyID
		INNER JOIN QCheck_Users u
			ON cmt.UserID = u.[ID]
	WHERE
		cmt.CommentDt BETWEEN @StartDate AND DATEADD(DAY, 1, @EndDate)
		AND (
			c.[Name] LIKE '%' + @Keyword + '%'
			OR cmt.Comments LIKE '%' + @Keyword + '%'
		)
	ORDER BY
		c.[Name],
		cmt.CommentDt,
		cmt.DisplayOrder

END




GO
/****** Object:  StoredProcedure [dbo].[Util_LegalSearchExample]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[Util_LegalSearchExample]
AS
BEGIN

	--comments on status reports controlled by users in the list
	--names of tasks controlled by or assigned to users in the list

	--look into reportID 1101097

	declare @search varchar(100) 
	declare @startdt datetime = '11/9/2013'
	declare @enddt datetime = '1/1/2050'

	declare @keywordsearch table (
		keyword varchar(100)
	)

	insert into @keywordsearch select 'Assaf'
	insert into @keywordsearch select 'Compass'
	insert into @keywordsearch select 'Nigro'
	insert into @keywordsearch select 'Wood Creek'
	insert into @keywordsearch select 'Woodcreek'
	insert into @keywordsearch select 'Hathiramani'
	insert into @keywordsearch select 'First Star'
	insert into @keywordsearch select 'Firststar'
	insert into @keywordsearch select 'Popovich'
	insert into @keywordsearch select 'Speirs'


	declare @personsearch table(
		shortname varchar(100)
	)

	insert into @personsearch select 'mkappen'
	insert into @personsearch select 'gmay'
	insert into @personsearch select 'graynor'


	declare @match table
	(
		id int,
		term varchar(100),
		match varchar(100),
		task varchar(1000),
		taskdue varchar(50),
		commentdt varchar(50),
		comments varchar(8000),
		commenter varchar(100),
		assignees varchar(200),
		controllers varchar(200),
		statusreports varchar(500)
	)


	DECLARE TASKNAMECURS CURSOR FOR 
			SELECT DISTINCT keyword
			FROM @keywordsearch

	OPEN TASKNAMECURS

	FETCH NEXT FROM TASKNAMECURS INTO @search
	WHILE @@FETCH_STATUS = 0 BEGIN

		insert into @match
		select distinct
			a.id,
			@search as term,
			'Task Name' as match,
			ch.name as task,
			convert(varchar, a.duetime, 101) as taskdue, 
			isnull(convert(varchar, c.commentdt, 101), '') as commentdt, 
			isnull(c.comments, '') as comments, 
			isnull(u.fullname, '') as commenter,
			replace(dbo.[QCheck_AssigneesList_WithArchive](ci.id), '&nbsp;', ' ') as assignees, 
			dbo.[QCheck_ManagersList_Full](ch.id) as controllers, 
			dbo.[QStatus_StatusReportList](ci.id) as statusreports
		  from qcheck_activechecklists_all a
		left outer join qcheck_checklistinstances_all ci
			on ci.id = a.instanceid
		left outer join qcheck_checklists_all ch
			on ch.id = ci.checklistid
		left outer join vwAllComments c
			on a.id = c.foreignkeyid and c.specialtask = 0
			and commentdt >= @startdt and  commentdt <= @enddt
		left outer join qcheck_users u
			on u.id = c.userid
		where (
			ch.name = @search --exact match
			or ch.name like @search + ' %' -- starts with search term
			or ch.name like '% ' + @search -- ends with search term
			or ch.name like '% ' + @search + '.%' -- sentence ends with search term
			or ch.name like '% ' + @search + ' %' --search term inside
			)
			and a.id not in (select id from @match)
			and isnull(a.duetime, @startdt) >= @startdt and  isnull(a.origduetime, @enddt) <= @enddt
			and (a.id in
				(
					select actt.activechecklistid from qstatus_report r
					inner join qstatus_Tasktypes tt
						on tt.reportid = r.id
					inner join (select tasktype, activechecklistid from qstatus_activechecklisttasktype
								union all select tasktype, activechecklistid from qstatus_activechecklisttasktypearchive
					) actt
						on actt.tasktype = tt.id
					inner join qstatus_groupreport gr
						on gr.reportid = r.id
					inner join qcheck_groupmembership gm
						on gm.groupid = gr.groupid
					inner join qcheck_users u
						on u.id = gm.userid
						and u.shortname in (select shortname from @personsearch)
				)
			)


			FETCH NEXT FROM TASKNAMECURS INTO @search
	END

	CLOSE TASKNAMECURS
	DEALLOCATE TASKNAMECURS




	DECLARE COMMENTCURS CURSOR FOR 
			SELECT DISTINCT keyword
			FROM @keywordsearch

	OPEN COMMENTCURS

	FETCH NEXT FROM COMMENTCURS INTO @search
	WHILE @@FETCH_STATUS = 0 BEGIN

		insert into @match
		select 
			a.id,
			@search as term,
			'Comments' as match,
			ch.name as task,
			convert(varchar, a.duetime, 101) as taskdue, 
			convert(varchar, c.commentdt, 101) as commentdt, 
			replace(c.comments, '<br>', '
			') as comments, 
			u.fullname as commenter,
			replace(dbo.[QCheck_AssigneesList_WithArchive](ci.id), '&nbsp;', ' ') as assignees, 
			dbo.[QCheck_ManagersList_Full](ch.id) as controllers, 
			dbo.[QStatus_StatusReportList](ci.id) as statusreports
		  from vwAllComments c
		left outer join qcheck_activechecklists_all a
			on a.id = c.foreignkeyid
		left outer join qcheck_checklistinstances_all ci
			on ci.id = a.instanceid
		left outer join qcheck_checklists_all ch
			on ch.id = ci.checklistid
		left outer join qcheck_users u
			on u.id = c.userid
		where (
			comments = @search --exact match
			or comments like @search + ' %' -- starts with search term
			or comments like '% ' + @search -- ends with search term
			or comments like '% ' + @search + '.%' -- sentence ends with search term
			or comments like '% ' + @search + ' %' --search term inside
			)
			and a.id not in (select id from @match)
			and commentdt >= @startdt and  commentdt <= @enddt
			and (specialtask = 0 and
				 
				foreignkeyid in
				(
					select actt.activechecklistid from qstatus_report r
					inner join qstatus_Tasktypes tt
						on tt.reportid = r.id
					inner join (select tasktype, activechecklistid from qstatus_activechecklisttasktype
								union all select tasktype, activechecklistid from qstatus_activechecklisttasktypearchive
					) actt
						on actt.tasktype = tt.id
					inner join qstatus_groupreport gr
						on gr.reportid = r.id
					inner join qcheck_groupmembership gm
						on gm.groupid = gr.groupid
					inner join qcheck_users u
						on u.id = gm.userid
						and u.shortname in (select shortname from @personsearch)
				)
			)
			FETCH NEXT FROM COMMENTCURS INTO @search
	END

	CLOSE COMMENTCURS
	DEALLOCATE COMMENTCURS



		
	select * from @match
	order by match, taskdue, commentdt
END
GO
/****** Object:  StoredProcedure [dbo].[Util_MakeControllerOnAllReportTasks]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_MakeControllerOnAllReportTasks] (
	@UserID int,
	@ReportID int
) AS

BEGIN

	declare @deletedDate datetime,
		@MoveCompleted bit,
		@DueFilter datetime,
		@AssignedTo int,
		@GroupID INT

	set @deletedDate = null
	set @moveCompleted = 0
	set @dueFilter = null
	set @AssignedTo = -1

	select @GroupID = g.[id]
	from 
		qcheck_users u
		inner join qcheck_groups g
			on u.fullname = g.[Name]
		where u.[id] = @UserID


	
	--exec sp_recompile 'QStatus_GetReport'
 
	SET NOCOUNT ON
	
	DECLARE @ReportUserID int
	DECLARE @LastReadDate datetime
	DECLARE @CompletedType varchar(50)
	DECLARE @CompletedOrder int
	DECLARE @Seed int
	INSERT INTO QStatus_Seed
	SELECT 1
	SELECT @Seed = scope_identity()
	DELETE FROM QStatus_Seed
	--find all the tasks
	DECLARE @ForeignKeyIDs TABLE (
		ForeignKeyID INT PRIMARY KEY
	)

	INSERT INTO @ForeignKeyIDs 
		SELECT distinct activechecklistid 
		FROM qstatus_commentedreporttasks
		WHERE 
		reportID = @reportID 

	--add a day to whatever was passed in (takes care of default to midnight)
	IF @DueFilter is not null
		SET @DueFilter = DateAdd(day, 1, @DueFilter)
	
	SELECT @CompletedType = 'Completed'
	--find out if they are a user or supervisor/ip
	SET @ReportUserID = 0
	SELECT @ReportUserID = UserID
	FROM
		QStatus_GroupReport gr
	INNER JOIN QCheck_Groups g
	ON
		g.ID = gr.GroupID
	INNER JOIN QCheck_GroupMembership gm
	ON
		gm.GroupID = g.ID
	AND
		gr.ReportID = @ReportID
	AND
		gm.UserID = @UserID
	--default to 60 days ago
	SELECT @LastReadDate =  getdate() - 60
	
	--find last time it was marked read by you if you are supervisor/ip
	SELECT @LastReadDate = LastViewed
		FROM 
			QStatus_SupervisorsLastViewed
		WHERE
			ReportID = @ReportID 
		AND
			SupervisorUserID = @UserID
	
	--if it is your report, just use yesterday
	IF @ReportUserID = @UserID
		SELECT @LastReadDate = dateadd(day, -1, getdate())
	DECLARE @tasks table(
		ID int PRIMARY KEY,
		DueTime datetime,
		InstanceID int,
		assignees varchar(1000),
		tasktype int,
		taskdescription varchar(1000),
		nativetype int,
		tasktypeorder int,
		priority int,
		prioritychanged bit,
		duedatechanged bit,
		newtask bit,
		CompletedDate datetime,
		Archived bit,
		description varchar(1000),
		tasknamechanged bit,
		isDeleted bit
	)
	declare @instances table(
		ID int PRIMARY KEY,
		ChecklistID int
	)
	declare @checklists table(
		ID int PRIMARY KEY,
		Description varchar(1000),
		tasknamechanged bit
	)
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived,
			IsDeleted
		)
	SELECT distinct
		ac.ID, 
		ac.DueTime,
		ac.InstanceID,
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		CompletedDate, 
		0,
		c.IsDeleted
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklists ac
	ON
		ac.ID = actt.ActiveChecklistID
	INNER JOIN 
		qcheck_checklistinstances ci
	ON
		ci.ID = ac.InstanceID
	INNER JOIN
		qcheck_checklists c
	ON
		ci.ChecklistID = c.ID
	INNER JOIN
		QCheck_Assignments a
	ON
		a.instanceID = ci.ID
	AND
		(a.GroupID = @AssignedTo or @AssignedTo = -1)
	AND
		a.IsDeleted = 0
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	WHERE
		tt.ReportID = @ReportID
	AND (
		@DueFilter is null 
		OR ac.DueTime < @DueFilter 
		OR ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	insert into @tasks
		(
			ID ,
			DueTime,
			InstanceID ,
			assignees ,
			tasktype ,
			taskdescription ,
			nativetype ,
			tasktypeorder ,
			priority ,
			prioritychanged ,
			duedatechanged ,
			newtask ,
			CompletedDate ,
			Archived 
		)
	
	SELECT distinct 
		ac.ID, 
		ac.DueTime,
		ac.InstanceID, 
		isnull(al.assignees, ''),
		--dbo.QCheck_FullAssigneesList(ac.instanceid),
		tt.ID,
		tt.Description,
		tt.NativeType,
		tt.DisplayOrder,
		actt.Priority,
		0 as PriorityChanged,
		0 as DueDateChanged,
		CASE WHEN actt.CreateDt > @deletedDate THEN 1 ELSE 0 END  as NewTask,
		CompletedDate, 
		1
	FROM
		QStatus_ActiveChecklistTaskType actt
	INNER JOIN
		QStatus_TaskTypes	tt
	ON
		actt.TaskType = tt.ID
	--AND
	--	tt.IsDeleted = 0
	INNER JOIN 
		QCheck_ActiveChecklistArchive ac
	ON
		ac.ID = actt.ActiveChecklistID
	AND 
		ac.archivedate > @deleteddate 
	AND
		@deleteddate is not null
	INNER JOIN
		QCheck_ActiveAssignmentArchive aa
	ON
		aa.ActiveChecklistID = ac.ID
	
	left outer join qcheck_assigneelookup al
		on al.instanceid = ac.instanceid
	WHERE
		
		tt.ReportID = @ReportID
	AND (
		@DueFilter is null 
		OR ac.DueTime < @DueFilter 
		OR ac.ID in (SELECT ForeignKeyID FROM @ForeignKeyIDs)
	)
	AND
		(
			@AssignedTo = -1
		OR
			aa.AssignmentsID in
			(SELECT ID FROM QCheck_Assignments
			WHERE GroupID = @AssignedTo and isdeleted = 0)
		OR
			aa.AssignmentsID in
			(SELECT ID FROM QCheck_AssignmentArchive
			WHERE GroupID = @AssignedTo and isdeleted = 0)
		)

	update @tasks
		set DueDateChanged = 1
		from @tasks t
		inner join QStatus_DueDateChanges ddc
		on 
			ddc.ActiveChecklistID =t.ID
		AND 
			ddc.UpdateDt > @deletedDate
	
	update @tasks
		set PriorityChanged = 1
		from @tasks t
		inner join QStatus_PriorityChanges pc
		on 
			pc.ActiveChecklistID =t.ID
		AND 
			pc.UpdateDt > @deletedDate

	insert into @instances
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstances ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			ci.IsDeleted = 0 
		OR 
			@deleteddate is not null
		UNION ALL
		SELECT distinct
			ci.ID,
			ci.ChecklistID
		FROM 
			QCheck_ChecklistInstanceArchive ci
		INNER JOIN 
			@tasks t
		ON 
			t.InstanceID = ci.ID
		WHERE
			(ci.IsDeleted = 0 
			OR	 
			@deleteddate is not null)
		AND 
			ci.archivedate > @deleteddate 
		AND 
			@deleteddate is not null
	
	insert into @checklists
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_Checklists c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		AND 
			tnc.UpdateDt > @deletedDate
		WHERE
			c.IsDeleted = 0 
		OR 
			@deleteddate is not null
		UNION ALL
		SELECT DISTINCT
			c.ID,
			c.Name,
			CASE WHEN tnc.ChecklistID IS NULL THEN 0 ELSE 1 END as TaskNameChanged
		FROM 
			QCheck_ChecklistArchive c
		INNER JOIN 
			@instances ci
		ON 
			c.ID = ci.ChecklistID
		LEFT OUTER JOIN
			QStatus_TaskNameChanges tnc
		ON
			tnc.ChecklistID = c.ID
		AND 
			tnc.UpdateDt > @deletedDate
		WHERE
			(c.IsDeleted = 0 
			OR	 
			@deleteddate is not null)
		AND 
			c.archivedate > @deleteddate 
		AND 
			@deleteddate is not null
	DELETE FROM @instances where checklistid not in (select id from @checklists)
	DELETE FROM @tasks where instanceid not in (select id from @instances)
	update @tasks
		set description = c.description,
		tasknamechanged = c.tasknamechanged
	from @tasks t
	inner join @instances i
	on i.id = t.instanceid
	inner join @checklists c
	on c.id = i.checklistid
	

	-- Set up the managers
	insert into qcheck_checklistmanagers (
		ManagerGroupID,
		ChecklistID,
		IsDeleted
	)
		select 
			@GroupID, 
			ci.ChecklistID, 
			0
		from 
			@tasks t
			inner join qcheck_checklistinstances ci
				on t.instanceid = ci.[id]
			left outer join qcheck_checklistmanagers cm
				on cm.checklistid = ci.checklistid
				and cm.managergroupid = 76
		where
			cm.managergroupid is null
	

END
GO
/****** Object:  StoredProcedure [dbo].[Util_MoveDueDatesOnReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_MoveDueDatesOnReport] (
	@ReportID INT,
	@DueBefore DATETIME,
	@NewDue DATETIME,
	@ChangedBy Varchar(100) = ''
) AS

-- This works pretty much like the bulk update tool used to.  This doesn't have any kind
-- of controller check, so make sure you have the proper approvals before running this.
-- It was originally written to move things on one of Brandon Teague's status reports.  It
-- won't update due dates for recurring tasks.  That's probably something worth looking at
-- later.

BEGIN

	-- Log all the due date changes
	INSERT INTO QStatus_DueDateChanges (
		ActiveChecklistID, 
		DueDateOld, 
		UpdateDT, 
		ChangedBy
	)
		SELECT 
			ac.[ID], DueTime, GETDATE(), @ChangedBy
		FROM 
			QStatus_Report r
			INNER JOIN QStatus_TaskTypes tt
				ON r.[ID] = tt.ReportID
			INNER JOIN QStatus_InstanceTaskType itt
				ON tt.[ID] = itt.TaskType
			INNER JOIN QCheck_ActiveChecklists ac
				ON itt.InstanceID = ac.InstanceID
		WHERE
			r.[ID] = @ReportID
			AND ac.CompletedDate IS NULL
			AND ac.DueTime < @DueBefore
	
	-- Move all the due dates back
	UPDATE 
		QCheck_ActiveChecklists
	SET
		DueTime = CONVERT(DATETIME, CONVERT(VARCHAR(10), @NewDue, 101) + ' ' + RIGHT('0' + CONVERT(VARCHAR(5), DATEPART(HOUR, ac.DueTime)), 2) + ':' + RIGHT('0' + CONVERT(VARCHAR(5), DATEPART(MINUTE, ac.DueTime)), 2) + ':00')
	FROM 
		QStatus_Report r
		INNER JOIN QStatus_TaskTypes tt
			ON r.[ID] = tt.ReportID
		INNER JOIN QStatus_InstanceTaskType itt
			ON tt.[ID] = itt.TaskType
		INNER JOIN QCheck_ActiveChecklists ac
			ON itt.InstanceID = ac.InstanceID
		LEFT OUTER JOIN QCheck_UpcomingDueTimes udt
			ON ac.InstanceID = udt.InstanceID
	WHERE
		r.[ID] = @ReportID
		AND ac.CompletedDate IS NULL
		AND ac.DueTime < @DueBefore
		AND udt.[ID] IS NULL

	-- Mark the status report as dirty so the changes are visible next time it is loaded
	UPDATE QStatus_Report 
	SET IsDirty = 1
	WHERE [ID] = @ReportID

END

GO
/****** Object:  StoredProcedure [dbo].[Util_NextDue_ByNames_List]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO





CREATE  PROCEDURE [dbo].[Util_NextDue_ByNames_List] (
	@ChecklistName VARCHAR(1000) = '',
	@SectionName VARCHAR(1000) = '',
	@StatusName VARCHAR(1000) = ''
) AS

BEGIN
	
	SELECT 
		ChecklistID, 
		ChecklistName, 
		MIN(DueTime) AS DueTime
	FROM (

		SELECT
			c.id AS ChecklistID,
			c.name AS ChecklistName,
			MIN(ac.DueTime) AS DueTime
		FROM
			qcheck_checklists c
			INNER JOIN qcheck_checklistinstances ci
				ON c.id = ci.checklistid
			INNER JOIN qcheck_activechecklists ac
				ON ac.instanceid = ci.id
			LEFT OUTER JOIN (
				SELECT 
					itt.InstanceID, 
					tt.Description AS SectionName, 
					r.Name AS StatusName
				FROM
					QStatus_InstanceTaskType itt
					INNER JOIN QStatus_TaskTypes tt
						ON itt.TaskType = tt.id
					INNER JOIN QStatus_Report r
						ON tt.ReportID = r.id
				WHERE
					tt.IsDeleted = 0
					AND r.IsDeleted = 0
			) r
				ON ci.ID = r.InstanceID
		WHERE
			ac.DUETIME > GETDATE()
			AND ac.CompletedDate IS NULL
			AND c.IsDeleted = 0
			AND ci.IsDeleted = 0
			AND c.Name LIKE '%' + @ChecklistName + '%'
			AND r.SectionName LIKE '%' + @SectionName + '%'
			AND r.StatusName LIKE '%' + @StatusName + '%'
		GROUP BY
			c.id,
			c.name
	
		UNION
		
		SELECT
			c.id AS ChecklistID,
			c.name AS ChecklistName,
			MIN(udt.DueTime)
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON c.id = ci.checklistid
			INNER JOIN QCheck_UpcomingDueTimes udt
					ON udt.instanceid = ci.id
			LEFT OUTER JOIN (
				SELECT 
					itt.InstanceID, 
					tt.Description AS SectionName, 
					r.Name AS StatusName
				FROM
					QStatus_InstanceTaskType itt
					INNER JOIN QStatus_TaskTypes tt
						ON itt.TaskType = tt.id
					INNER JOIN QStatus_Report r
						ON tt.ReportID = r.id
				WHERE
					tt.IsDeleted = 0
					AND r.IsDeleted = 0
			) r
				ON ci.ID = r.InstanceID
		WHERE
			udt.DueTime > GETDATE()
			AND c.IsDeleted = 0
			AND ci.IsDeleted = 0
			AND c.Name LIKE '%' + @ChecklistName + '%'
			AND r.SectionName LIKE '%' + @SectionName + '%'
			AND r.StatusName LIKE '%' + @StatusName + '%'
		GROUP BY
			c.id,
			c.name
	) A
	GROUP BY
		ChecklistID,
		ChecklistName
	ORDER BY 
		DueTime
END








GO
/****** Object:  StoredProcedure [dbo].[Util_NextDue_ByNames_Single]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE    PROCEDURE [dbo].[Util_NextDue_ByNames_Single] (
	@ChecklistName VARCHAR(1000) = '',
	@SectionName VARCHAR(1000) = '',
	@StatusName VARCHAR(1000) = ''
) AS

BEGIN

	SET NOCOUNT ON
	
	DECLARE @NextDue AS DATETIME
	
	SELECT
		@NextDue = MIN(ac.DueTime)
	FROM
		qcheck_checklists c
		INNER JOIN qcheck_checklistinstances ci
			ON c.id = ci.checklistid
		INNER JOIN qcheck_activechecklists ac
			ON ac.instanceid = ci.id
		LEFT OUTER JOIN (
			SELECT 
				itt.InstanceID, 
				tt.Description AS SectionName, 
				r.Name AS StatusName
			FROM
				QStatus_InstanceTaskType itt
				INNER JOIN QStatus_TaskTypes tt
					ON itt.TaskType = tt.id
				INNER JOIN QStatus_Report r
					ON tt.ReportID = r.id
			WHERE
				tt.IsDeleted = 0
				AND r.IsDeleted = 0
		) r
			ON ci.ID = r.InstanceID
	WHERE
		ac.DUETIME > GETDATE()
		AND ac.CompletedDate IS NULL
		AND c.IsDeleted = 0
		AND ci.IsDeleted = 0
		AND c.Name LIKE '%' + @ChecklistName + '%'
		AND r.SectionName LIKE '%' + @SectionName + '%'
		AND r.StatusName LIKE '%' + @StatusName + '%'
	
	IF @NextDue IS NULL BEGIN
	
		SELECT
			@NextDue = MIN(udt.DueTime) 
		FROM
			QCheck_Checklists c
			INNER JOIN QCheck_ChecklistInstances ci
				ON c.id = ci.checklistid
			INNER JOIN QCheck_UpcomingDueTimes udt
					ON udt.instanceid = ci.id
			LEFT OUTER JOIN (
				SELECT 
					itt.InstanceID, 
					tt.Description AS SectionName, 
					r.Name AS StatusName
				FROM
					QStatus_InstanceTaskType itt
					INNER JOIN QStatus_TaskTypes tt
						ON itt.TaskType = tt.id
					INNER JOIN QStatus_Report r
						ON tt.ReportID = r.id
				WHERE
					tt.IsDeleted = 0
					AND r.IsDeleted = 0
			) r
				ON ci.ID = r.InstanceID
		WHERE
			udt.DueTime > GETDATE()
			AND c.IsDeleted = 0
			AND ci.IsDeleted = 0
			AND c.Name LIKE '%' + @ChecklistName + '%'
			AND r.SectionName LIKE '%' + @SectionName + '%'
			AND r.StatusName LIKE '%' + @StatusName + '%'
	
	END
	
	SET NOCOUNT OFF
	
	SELECT @NextDue

END






GO
/****** Object:  StoredProcedure [dbo].[Util_ProcessAccounts_PFSCentral]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

CREATE PROCEDURE [dbo].[Util_ProcessAccounts_PFSCentral] 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE
		@Accounts Table
		(
			AccountNumber int,
			AccountStatus varchar(255),
			CurrentInsurance varchar(255),
			DateOfService datetime,
			ClaimDueDate datetime,
			AppealDueDate datetime,
			AgeOfClaim int,
			Balance money,
			TotalChargeOwedAmount money,
			TotalPaymentAmount money,
			QueueStatus char(7),
			QueueName varchar(20),
			UserCode varchar(50),
			UserName varchar(255),
			LastEditDate date,
			ClaimReceivedDate datetime,
			ClaimBilledDate datetime,
			ActionCode varchar(50)
		)

	DECLARE
		@AccountNumber int,
		@TaskName varchar(1000),
		@Assignee int,
		@Controller int,
		@DueDate datetime,
		@Section int,
		@Priority int

	-- Call [dbo].[Util_GetPFSCentral_NonNSA_Accounts]
	INSERT INTO @Accounts EXEC [dbo].[Util_GetPFSCentral_NonNSA_Accounts]

	-- Loop through results
	WHILE EXISTS(SELECT * FROM @Accounts)
	BEGIN
	--  If account exist in PHI Process tasks already
	--     Call to-be-developed update procedure
	--  Else
		SELECT TOP 1
			@AccountNumber = a.AccountNumber,
			@TaskName = a.QueueName + ' | ' + CAST(a.AccountNumber as varchar),
			@Assignee = CASE
				WHEN EXISTS(SELECT ID FROM [dbo].[QCheck_Users] WHERE empID = a.UserCode)
					THEN (
						SELECT g.ID
						FROM [dbo].[QCheck_Users] u
							INNER JOIN [dbo].[QCheck_GroupMembership] gm
								ON u.ID = gm.UserID
							INNER JOIN [dbo].[QCheck_Groups] g
								ON gm.GroupID = g.ID AND g.SingleMemberGroup = 1
						WHERE u.empID = a.UserCode
					)
				ELSE (
						SELECT g.ID
						FROM [dbo].[QCheck_Users] u
							INNER JOIN [dbo].[QCheck_GroupMembership] gm
								ON u.ID = gm.UserID
							INNER JOIN [dbo].[QCheck_Groups] g
								ON gm.GroupID = g.ID AND g.SingleMemberGroup = 1
						WHERE u.empID = 8559 -- hardcoded to Marlen's usercode
					)
			END,
			@Controller = (
						SELECT g.ID
						FROM [dbo].[QCheck_Users] u
							INNER JOIN [dbo].[QCheck_GroupMembership] gm
								ON u.ID = gm.UserID
							INNER JOIN [dbo].[QCheck_Groups] g
								ON gm.GroupID = g.ID AND g.SingleMemberGroup = 1
						WHERE u.empID = 8559 -- hardcoded to Marlen's usercode
					),
			@DueDate = a.AppealDueDate,
			@Section = 0,
			@Priority = 1
		FROM @Accounts a

		EXEC [dbo].[Util_CreateTask_PFSCentral] @TaskName, @Assignee, @Controller, @DueDate, @Section, @Priority

		DELETE @Accounts WHERE AccountNumber = @AccountNumber
	END
END
GO
/****** Object:  StoredProcedure [dbo].[Util_QPASDeadline]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Util_QPASDeadline]
AS
BEGIN

	exec Util_DefaultDeadlines

END
GO
/****** Object:  StoredProcedure [dbo].[Util_ReAssignTaskWithQPTPrefs]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[Util_ReAssignTaskWithQPTPrefs]
	@ActiveChecklistId int,
	@AssigneeGroupId int,
	@AssignedById int
AS
BEGIN
    
	EXEC [dbo].[QCheck_UpdateAssigneesForTask]--update Assignee
		 @ActiveChecklistID ,
		     @AssigneeGroupId,
		     @AssignedById

    Declare @NewInstanceID int,@TaskType int,@Priority int,@DueDate DATETIME,@DueDaysAhead int,@DueTime int

	SELECT @TaskType=Report,@Priority=Priority,@DueDaysAhead=Due
	FROM QStatus_AutomationEmailPreferences
	WHERE UserID = @AssignedById

	select @NewInstanceID=InstanceID from QCheck_ActiveChecklists_All where id=@ActiveChecklistId
	 
	If @TaskType>0
	Begin
    DECLARE @NewTaskTypeID int
    EXEC QCheck_AddInstanceTaskType @NewInstanceID, @TaskType, @Priority, @NewTaskTypeID OUTPUT--add it to status report
	End

	If @Priority>0
	Begin
	exec [PriorityList_AddTask_ForGroup] @AssignedById,  @AssigneeGroupId, @ActiveChecklistID, @Priority--add to priority list
	End
	
	SELECT @DueDate = DATEADD(DAY, @DueDaysAhead, CAST(CAST(GETDATE() AS DATE) AS DATETIME))
    select @DueDate = dateadd(day, datediff(day,'19000101',@DueDate), CAST('19:00' AS DATETIME))
	UPDATE QCheck_ActiveChecklists--update due date
		SET DueTime = @DueDate	
		WHERE ID = @ActiveChecklistID
END

GO
/****** Object:  StoredProcedure [dbo].[Util_RenameBidQTask]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create PROCEDURE [dbo].[Util_RenameBidQTask] (
	@ID int,
	@TaskName VARCHAR(1000)
) AS
BEGIN
	
	UPDATE QCheck_Checklists set name = @TaskName where ID = @ID

END
GO
/****** Object:  StoredProcedure [dbo].[Util_RestoreChecklistAsTemplate]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
-- ====================================================================================
--
-- 8/3/2010 dalvarado
--
-- Used to restore an archived checklist as a template.  Most of the requests we get
-- to restore old checklists are for things that should have been marked as templates
-- in the first place.
--
-- ====================================================================================

CREATE   PROCEDURE [dbo].[Util_RestoreChecklistAsTemplate] (
	@ChecklistName VARCHAR(500),
	@NewOwnerUsername VARCHAR(50)
) AS

BEGIN
	
	DECLARE @OwnerID INT,
		@FoundActiveChecklistID INT,
		@FoundChecklistID INT,
		@FoundChecklistName VARCHAR(500),
		@MatchCount INT

	DECLARE @work TABLE (
		ActiveChecklistID INT,
		ChecklistID INT,
		ChecklistName VARCHAR(500)
	)

	-- This is the hoop you have to jump through to get an ActiveChecklistID from a checklist name
	-- when the checklist is archived.
	INSERT INTO @work (
		ActiveChecklistID,
		ChecklistID,
		ChecklistName
	)
		SELECT
			ACA.[ID],
			CA.[ID],
			CA.[Name]
		FROM
			QCheck_ActiveChecklistArchive ACA
			INNER JOIN QCheck_ChecklistInstanceArchive CIA
				ON ACA.InstanceID = CIA.[ID]
			INNER JOIN QCheck_ChecklistArchive CA
				ON CIA.ChecklistID = CA.[ID]
				AND CA.[Name] LIKE '%' + @ChecklistName + '%'

	SELECT @MatchCount = COUNT(DISTINCT ChecklistID) FROM @work


	-- The name is wrong, you need to get more info from the user or change your search criteria.
	IF @MatchCount = 0 BEGIN

		SELECT 'No checklists found matching %' + @ChecklistName + '%'

	END ELSE BEGIN

		-- Too many matches, you can just pick one of the results and re-run to restore that checklist
		IF @MatchCount > 1 BEGIN

			SELECT DISTINCT ChecklistName AS 'Multiple checklists found.  Run again with one of these.' FROM @work

		END ELSE BEGIN

			SELECT TOP 1
				@FoundActiveChecklistID = ActiveChecklistID,
				@FoundChecklistID = ChecklistID,
				@FoundChecklistName = ChecklistName
			FROM 
				@Work
			ORDER BY
				ActiveChecklistID DESC

			SELECT 'Restoring checklist: ' + @FoundChecklistName
			SELECT 'Check for "DONE" message'

			-- Do the restore and make this checklist a template
			EXEC QCheck_RestoreTask @FoundActiveChecklistID
			UPDATE QCheck_Checklists SET Template = 1 WHERE [ID] = @FoundChecklistID

			-- Change ownership if requested
			IF @NewOwnerUsername IS NOT NULL BEGIN

				SELECT @OwnerID = [ID] FROM QCheck_Users WHERE ShortName = @NewOwnerUsername

				IF @OwnerID IS NOT NULL BEGIN

					UPDATE QCheck_Checklists SET Owner = @OwnerID WHERE [ID] = @FoundChecklistID
					SELECT 'Owner changed to ' + @NewOwnerUsername

				END ELSE BEGIN

					SELECT 'User ' + @NewOwnerUsername + ' NOT found in QCheck_Users, owner for this checklist was NOT updated'

				END

			END

			SELECT 'Checklist should show up under "Tasks I Control" but probably has out-of-date assignments.  The user will need to clear those up."'

			SELECT 'DONE'			

		END

	END

END	

GO
/****** Object:  StoredProcedure [dbo].[Util_RollDeadlinesOnStatusReport]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_RollDeadlinesOnStatusReport] (
	@ReportName VARCHAR(50),
	@CurrDueTime DATETIME,
	@NewDueTime DATETIME,
	@ChangedBy Varchar(100) = ''
) AS

BEGIN

	-- Log the deadline changes
	INSERT INTO QStatus_DueDateChanges (
		ActiveChecklistID,
		DueDateOld,
		UpdateDt, 
		ChangedBy
	)
		SELECT
			ac.ID,
			ac.DueTime,
			GETDATE(), 
			@ChangedBy
		FROM
			QStatus_Report r
			INNER JOIN QStatus_TaskTypes tt
				ON r.ID = tt.ReportID
			INNER JOIN QStatus_ActiveChecklistTaskType actt
				ON tt.ID = actt.TaskType
			INNER JOIN QCheck_ActiveChecklists ac
				ON actt.ActiveChecklistID = ac.ID
		WHERE
			r.Name = @ReportName
			AND CONVERT(VARCHAR(10), ac.DueTime, 101) = CONVERT(VARCHAR(10), @CurrDueTime, 101)

	-- Change the deadlines
	UPDATE
		QCheck_ActiveChecklists
	SET
		DueTime = @NewDueTime
	FROM
		QStatus_Report r
		INNER JOIN QStatus_TaskTypes tt
			ON r.ID = tt.ReportID
		INNER JOIN QStatus_ActiveChecklistTaskType actt
			ON tt.ID = actt.TaskType
		INNER JOIN QCheck_ActiveChecklists ac
			ON actt.ActiveChecklistID = ac.ID
	WHERE
		r.Name = @ReportName
		AND CONVERT(VARCHAR(10), ac.DueTime, 101) = CONVERT(VARCHAR(10), @CurrDueTime, 101)
		
	-- Mark the report dirty
	UPDATE 
		QStatus_Report
	SET 
		IsDirty = 1
	WHERE 
		Name = @ReportName

END
GO
/****** Object:  StoredProcedure [dbo].[Util_SetOncallGroups]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Util_SetOncallGroups]
AS

BEGIN

	DECLARE @status int
	DECLARE @responseText as table(responseText nvarchar(max))
	DECLARE @res as Int;
	DECLARE @url varchar(1000)
	DECLARE @baseurl varchar(1000) = 'https://acme-it-on-call.azurewebsites.net/api/ByDateTime/'
	DECLARE @dtstring varchar(10) = convert(varchar, getdate(), 23)
	DECLARE @apiCode varchar(100) = 'eRpIExytC46EF7rZhMPl26HYFAXYbAAdHwmzpDBg99PtcWdc7KABUg=='
	DECLARE @oncallGroupID int = 2155  --oncall group

	--this week oncall

	SELECT @url = @baseurl + @dtstring + '?code=' +@apiCode

	EXEC sp_OACreate 'MSXML2.ServerXMLHTTP', @res OUT
	EXEC sp_OAMethod @res, 'open', NULL, 'GET',@url,'false'
	EXEC sp_OAMethod @res, 'send'
	EXEC sp_OAGetProperty @res, 'status', @status OUT
	INSERT INTO @ResponseText (ResponseText) EXEC sp_OAGetProperty @res, 'responseText'
	EXEC sp_OADestroy @res

	DECLARE @fullResponse varchar(max) 

	SELECT @fullResponse = responseText FROM @responseText
	DECLARE @oncallName varchar(1000) 

	SELECT @oncallName = json_value(@fullResponse, '$.name')

	DECLARE @UserID int
	SELECT @UserID = ID from qcheck_users where fullname = @oncallName

	DELETE FROM qcheck_groupmembership where groupid = @oncallGroupID

	INSERT INTO qcheck_groupmembership (userid, groupid)
	SELECT @UserID, @oncallGroupID

	DELETE FROM @ResponseText

	--next week oncall

	SELECT @oncallGroupID = 2156  --oncall group for next week
	select @dtstring = convert(varchar, getdate() + 7, 23)

	SELECT @url = @baseurl + @dtstring + '?code=' +@apiCode

	EXEC sp_OACreate 'MSXML2.ServerXMLHTTP', @res OUT
	EXEC sp_OAMethod @res, 'open', NULL, 'GET',@url,'false'
	EXEC sp_OAMethod @res, 'send'
	EXEC sp_OAGetProperty @res, 'status', @status OUT
	INSERT INTO @ResponseText (ResponseText) EXEC sp_OAGetProperty @res, 'responseText'
	EXEC sp_OADestroy @res

	SELECT @fullResponse = responseText FROM @responseText
	SELECT @oncallName = json_value(@fullResponse, '$.name')
	SELECT @UserID = ID from qcheck_users where fullname = @oncallName

	DELETE FROM qcheck_groupmembership where groupid = @oncallGroupID
	INSERT INTO qcheck_groupmembership (userid, groupid)
	SELECT @UserID, @oncallGroupID
END
GO
/****** Object:  StoredProcedure [dbo].[Util_SetSupervisor]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_SetSupervisor] (
	@UserName VARCHAR(50),
	@SupervisorUserName VARCHAR(50)
) AS

BEGIN

	DECLARE @UserID INT,
			@UserFullName VARCHAR(100),
			@SupervisorID INT,
			@SupervisorFullName VARCHAR(100),
			@ReportID INT
			
	-- Get app configuration
	DECLARE @AppURL VARCHAR(50), @ImagesURL VARCHAR(50), @ExternalURL VARCHAR(50), @BaseDomain VARCHAR(50), @FromAddress VARCHAR(50), @AppName VARCHAR(50), @GradingAddress VARCHAR(50), @AutomationAddress VARCHAR(50)		
	SELECT @AppURL = AppURL, @ImagesURL = ImagesURL, @ExternalURL = ExternalURL, @BaseDomain = BaseDomain, @FromAddress = FromAddress, @Appname = AppName, @GradingAddress = GradingAddress, @AutomationAddress = AutomationAddress FROM QCheck_AppSettings WHERE ID = 1

	SELECT @UserID = ID, @UserFullName = FullName
	FROM QCheck_Users
	WHERE ShortName = @UserName

	SELECT @SupervisorID = ID, @SupervisorFullName = FullName
	FROM QCheck_Users
	WHERE ShortName = @SupervisorUserName

	IF @UserID IS NULL SELECT '*** FAILED ***', 'No QCheck_Users row found with shortname ' + ISNULL(@UserName, 'NULL')
	IF @SupervisorID IS NULL SELECT '*** FAILED ***', 'No QCheck_Users row found with shortname ' + ISNULL(@SupervisorUserName, 'NULL')

	IF @UserID IS NOT NULL AND @SupervisorID IS NOT NULL BEGIN

		IF EXISTS ( SELECT * FROM QStatus_Report WHERE Name = @UserFullName ) BEGIN
		
			SELECT '*** FAILED ***', ISNULL(@UserFullName, 'NULL') + ' has a personal status report, set their supervisor through the supervisor admin tool in ' + @AppName
		
		END ELSE BEGIN
		
			IF EXISTS(SELECT * FROM QStatus_SupervisorOverride WHERE UserID = @UserID) BEGIN
			
				UPDATE QStatus_SupervisorOverride
				SET SupervisorID = @SupervisorID 
				WHERE UserID = @UserID
				
			END ELSE BEGIN
			
				INSERT INTO QStatus_SupervisorOverride (UserID, SupervisorID) 
				VALUES (@UserID, @SupervisorID)
				
			END
			
			SELECT '*** SUCCESS ***', ISNULL(@UserFullName, 'NULL') + '''s supervisor set to ' + ISNULL(@SupervisorFullName, 'NULL')
		
		END
		
	END
	
END
GO
/****** Object:  StoredProcedure [dbo].[Util_SetupTest]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_SetupTest] (
	@TesterGroupID INT,
	@TestDate DATETIME
) AS

DECLARE @TesterUserID INT,
		@TesterReportID INT

SELECT 
	@TesterUserID = u.ID,
	@TesterReportID = r.ID
FROM 
	QCheck_Users u
	INNER JOIN QCheck_GroupMembership gm
		ON u.ID = gm.UserID
	INNER JOIN QCheck_Groups g
		ON gm.GroupID = g.ID
	INNER JOIN QStatus_Report r
		ON u.FullName = r.Name
		AND r.IsDeleted = 0
WHERE 
	g.ID = @TesterGroupID
	AND u.IsDeleted = 0
	AND g.SingleMemberGroup = 1
	AND u.FullName = g.Name

INSERT INTO QCheck_GroupMembership (UserID, GroupID, AsOf)
	SELECT
		@TesterUserID,
		g.ID,
		GETDATE()
	FROM 
		QCheck_Groups g
	WHERE
		g.[Name] like '%Process Test Takers'
GO
/****** Object:  StoredProcedure [dbo].[Util_TaskInfo]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_TaskInfo] (
	@Name VARCHAR(500)
) AS

SELECT
	c.ID AS ChecklistID,
	ci.ID AS InstanceID,
	ac.ID AS ActiveChecklistID,
	c.Name AS [Name],
	co.FullName AS Creator,
	ac.DueTime AS Due,
	dbo.QCheck_FullAssigneesList(ci.ID) AS Assignees,
	dbo.QCheck_ManagersList(c.ID) As Controllers,
	dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule,
	acu.FullName AS CompletedBy,
	ac.CompletedDate
FROM
	QCheck_Checklists c
	INNER JOIN QCheck_ChecklistInstances ci
		ON c.ID = ci.ChecklistID
		AND c.IsDeleted = 0
		AND ci.IsDeleted = 0
	INNER JOIN QCheck_ActiveChecklists ac
		ON ci.ID = ac.InstanceID
	INNER JOIN QCheck_Users co
		ON c.Owner = co.ID
	LEFT OUTER JOIN QCheck_Users acu
		ON ac.CompletedBy = acu.ID
WHERE
	c.Name LIKE '%' + @Name + '%'
	
GO
/****** Object:  StoredProcedure [dbo].[Util_TaskInfo_All]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_TaskInfo_All] (
	@Name VARCHAR(500)
) AS

SELECT
	c.ID AS ChecklistID,
	ci.ID AS InstanceID,
	ac.ID AS ActiveChecklistID,
	c.Name AS [Name],
	co.FullName AS Creator,
	ac.DueTime AS Due,
	dbo.QCheck_FullAssigneesList(ci.ID) AS Assignees,
	dbo.QCheck_ManagersList(c.ID) As Controllers,
	dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule,
	acu.FullName AS CompletedBy,
	ac.CompletedDate,
	ac.ArchiveDT
FROM
	QCheck_Checklists_All c
	INNER JOIN QCheck_ChecklistInstances_All ci
		ON c.ID = ci.ChecklistID
	INNER JOIN QCheck_ActiveChecklists_All ac
		ON ci.ID = ac.InstanceID
	INNER JOIN QCheck_Users co
		ON c.Owner = co.ID
	LEFT OUTER JOIN QCheck_Users acu
		ON ac.CompletedBy = acu.ID
WHERE
	c.Name LIKE '%' + @Name + '%'
ORDER BY
	ac.ID DESC
GO
/****** Object:  StoredProcedure [dbo].[Util_UserTaskListForGPROutprocessing]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Util_UserTaskListForGPROutprocessing] (
	@ShortName VARCHAR(50)
) AS

-- Used when a house manager or someone like that leaves.  The output should be put in a spreadsheet
-- and printed very large (plotter or 11x17 mininum) for GPR to review with Tim.
SELECT DISTINCT
      c.Name AS Task,
      CONVERT(VARCHAR(10), ac.DueTime, 101) + ' ' + LTRIM(RIGHT(CONVERT(VARCHAR(20), ac.DueTime), 7)) AS [Next Due],
      dbo.QCheck_AssigneesList(ci.ID) AS Assignees,
      dbo.QCheck_ManagersList(c.ID) AS Controllers,
      dbo.QCheck_ScheduleString(ci.ScheduleID) AS Schedule,
      ac.DueTime AS [FOR SORT DO NOT INCLUDE]
FROM 
      QCheck_ActiveChecklists ac
      INNER JOIN QCheck_ChecklistInstances ci
            ON ac.InstanceID = ci.ID
            AND ac.CompletedDate IS NULL
            AND ci.IsDeleted = 0
      INNER JOIN QCheck_Checklists c
            ON ci.ChecklistID = c.ID
            AND c.IsDeleted = 0
      INNER JOIN (
            SELECT 
                  InstanceID,
                  MIN(ID) AS ID
            FROM 
                  QCheck_ActiveChecklists
            WHERE
                  CompletedDate IS NULL
            GROUP BY
                  InstanceID
      ) f
            ON ac.ID = f.ID
      INNER JOIN QCheck_Assignments a
            ON ci.ID = a.InstanceID
            AND a.IsDeleted = 0
      INNER JOIN QCheck_Groups g
            ON a.GroupID = g.ID
      INNER JOIN QCheck_GroupMembership gm
            ON g.ID = gm.GroupID
      INNER JOIN QCheck_Users u
            ON gm.UserID = u.ID
WHERE
      u.ShortName = @ShortName
ORDER BY 
      ac.DueTime
      
GO
/****** Object:  StoredProcedure [dbo].[WeeklyBonusReview]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[WeeklyBonusReview]
(
	@dt datetime = null
)
as
begin
	if @dt is null select @dt = getdate()

	SELECT u.fullname
         ,isnull(bonus.b, 0) as bonus
         ,isnull(checklistcount, 0) as taskscreated
         ,isnull(activechecklists, 0) as taskscompletedontime
         ,isnull(comments, 0) as comments
         ,isnull(logid, 0) as priorityListSends
		 , bu.startdt
  FROM [dbo].QCheck_Users u
       inner join qcheck_bonususers bu
              on bu.userid = u.id
			  and u.isdeleted = 0
       outer apply
       (
         SELECT sum(bonus) as b
         FROM [dbo].[QCheck_BonusDatesAmounts]
         where userid = u.id
         and dt > dateadd(month, -1, @dt)
		 and dt <= @dt
       ) bonus
       outer apply
       (
              select count(id) as checklistcount
              from qcheck_checklists_all
              where owner = u.id
              and name not like '%test%'
              and createdate > dateadd(month, -1, @dt)
			  and createdate <= @dt
       ) as checklists
       outer apply
       (
              select count(ac.id) as activechecklists
              from qcheck_activechecklists_all ac
              inner join qcheck_checklistinstances_all ci
                     on ci.id = ac.instanceid
                     inner join qcheck_checklists_all c
                           on c.id = ci.checklistid
                           and c.name not like '%test%'
              where ac.completedby = u.id
              and ac.completeddate > dateadd(month, -1, @dt)
			  and ac.completeddate <= @dt
			  and ac.completeddate <= ac.duetime
       ) as ac
       
       outer apply
       (
              select count(id) as comments
              from qstatus_comments_all c 
              where c.userid = u.id
              and commentdt > dateadd(month, -1, @dt)
			  and commentdt <= @dt
       ) as comments
       outer apply
       (
			select count(sentdt) as logid
			from
			[QCheck_BonusStatusEmails]

              where userid = u.id
              and sentdt > dateadd(month, -1, @dt)
			  and sentdt <= @dt
       ) as priority
 
  order by 2 desc, isnull(checklistcount, 0) +
         isnull(activechecklists, 0) +
         isnull(comments, 0) +
         isnull(logid, 0) desc
 
 end
GO
/****** Object:  StoredProcedure [dbo].[WeeklyBonusReview_NewBonus]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[WeeklyBonusReview_NewBonus]
(
	@dt datetime = null
)
as
begin
	
	if @dt is null select @dt = getdate()

	SELECT u.fullname
         ,isnull(bonus.b, 0) as bonus
         ,isnull(activechecklists, 0) as taskscompletedontime
         ,isnull(comments, 0) as comments
         ,isnull(logid, 0) as priorityListSends
         ,isnull(emailtasks, 0) as emailtasks
         ,isnull(crcount, 0) as changerequests
		 , bu.startdt
  FROM [dbo].QCheck_Users u
       inner join qcheck_bonususers bu
              on bu.userid = u.id
			  and u.isdeleted = 0
       outer apply
       (
		 select sum(case when bonus > 30 then 30 else bonus end) as b from 
		 (
			 SELECT cast(dt as date) as dt, sum(bonus) as bonus 
			 FROM [dbo].[QCheck_BonusDatesAmounts]
			 where userid = u.id
			 and dt > dateadd(month, -1, @dt)
			 and dt <= @dt
			 group by cast(dt as date)
		 ) ib
		 
       ) bonus
       outer apply
       (
              select count(id) as checklistcount
              from qcheck_checklists_all
              where owner = u.id
              and name not like '%test%'
              and createdate > dateadd(month, -1, @dt)
			  and createdate <= @dt
       ) as checklists
       outer apply
       (
              select count(ac.id) as activechecklists
              from qcheck_activechecklists_all ac
              inner join qcheck_checklistinstances_all ci
                     on ci.id = ac.instanceid
                     inner join qcheck_checklists_all c
                           on c.id = ci.checklistid
                           and c.name not like '%test%'
              where ac.completedby = u.id
              and ac.completeddate > dateadd(month, -1, @dt)
			  and ac.completeddate <= @dt
			  and ac.completeddate <= ac.duetime
       ) as ac
       
       outer apply
       (
              select count(id) as comments
              from qstatus_comments_all c 
              where c.userid = u.id
              and commentdt > dateadd(month, -1, @dt)
			  and commentdt <= @dt
       ) as comments
       outer apply
       (
			select count(sentdt) as logid
			from
			[QCheck_BonusStatusEmails]

              where userid = u.id
              and sentdt > dateadd(month, -1, @dt)
			  and sentdt <= @dt
       ) as priority

	   outer apply 
	   (
			select count(cr.id) as crcount
			from QCheck_Approval_ChangeRequests cr
			INNER JOIN QCheck_Approval_ActiveChecklists aac ON aac.ChangeRequestID = cr.ID AND aac.DueTime IS NOT NULL AND NULLIF(cr.Comment,'') IS NOT NULL
			where cr.requestinguser = u.id
              and requestdate > dateadd(month, -1, @dt)
			  and requestdate <= @dt

	   ) changerequests

	   outer apply 
	   (
			SELECT count(id) as emailtasks
			FROM qcheck_emailtasks et
			where et.createdby = u.id 
              and createddt > dateadd(month, -1, @dt)
			  and createddt <= @dt
		) emailtasks
 
  order by 2 desc, isnull(checklistcount, 0) +
         isnull(activechecklists, 0) +
         isnull(comments, 0) +
         isnull(logid, 0) desc
 end
GO
/****** Object:  StoredProcedure [dbo].[WestoverEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO







CREATE        PROC [dbo].[WestoverEmail]
	(@review bit = 1)
AS
BEGIN

	IF dbo.Util_isOfficeDay(getdate()) = 1
	BEGIN
		
		DECLARE @to varchar(5000)
		DECLARE @from varchar(100)
		DECLARE @fromname varchar(100)
		DECLARE @cc varchar(5000)
		
		DECLARE @messagebody varchar(8000)
		
		DECLARE @NeedPriority varchar(3000)
		DECLARE @HighPriority varchar(3000)
		DECLARE @MediumPriority varchar(3000)
		DECLARE @LowPriority varchar(3000)
		DECLARE @Subject varchar(3000)
		
		SELECT @Subject = 'Westover priorities ' + left(convert(varchar, getdate(), 101), 5)
		
		IF @review = 1
			SET @Subject = @Subject + ' - please review'
	
		
		IF @review = 1
			SELECT @to = 'kcroft@acmewidget.com;rrockett@acmewidget.com;',
				@cc = ''
		ELSE
			SELECT @to = 'graynor1@acmewidget.com;',
				@cc = 'tgermany@acmewidget.com;kcroft@acmewidget.com;rrockett@acmewidget.com;'
			
	
		SELECT @from = 'kcroft@acmewidget.com'
		SELECT @fromname = 'Ken Croft'
	
		SELECT @NeedPriority = ''
		
		SELECT @NeedPriority = @NeedPriority + '- '+c.name +'<BR>' +CHAR(13)+CHAR(10)
		FROM qstatus_activechecklisttasktype actt
		INNER JOIN qcheck_activechecklists ac
		ON ac.id = actt.activechecklistid
		INNER JOIN qcheck_checklistinstances ci
		ON ci.id = ac.instanceid
		INNER JOIN qcheck_checklists c
		ON c.id = ci.checklistid
		WHERE actt.tasktype = 104465
		AND ac.completedby IS NULL
		
		IF LEN(@NeedPriority) > 0
			SELECT @NeedPriority = 'Need Priority:<BR>' +CHAR(13)+CHAR(10) + @NeedPriority+'<BR>' +CHAR(13)+CHAR(10)
		
		
		SELECT @HighPriority = ''
		
		SELECT @HighPriority = @HighPriority + convert(varchar(10), actt.Priority) + '. '+c.name +'<BR>' +CHAR(13)+CHAR(10)
		FROM qstatus_activechecklisttasktype actt
		INNER JOIN qcheck_activechecklists ac
		ON ac.id = actt.activechecklistid
		INNER JOIN qcheck_checklistinstances ci
		ON ci.id = ac.instanceid
		INNER JOIN qcheck_checklists c
		ON c.id = ci.checklistid
		WHERE actt.tasktype = 103596
		AND ac.completedby IS NULL
		ORDER BY actt.Priority asc
		
		IF LEN(@HighPriority) > 0
			SELECT @HighPriority = 'High Priority:<BR>'  +CHAR(13)+CHAR(10)+ @HighPriority+'<BR>' +CHAR(13)+CHAR(10)
		
		
		SELECT @MediumPriority = ''
		
		SELECT @MediumPriority = @MediumPriority + convert(varchar(10), actt.Priority) + '. '+c.name +'<BR>' +CHAR(13)+CHAR(10)
		FROM qstatus_activechecklisttasktype actt
		INNER JOIN qcheck_activechecklists ac
		ON ac.id = actt.activechecklistid
		INNER JOIN qcheck_checklistinstances ci
		ON ci.id = ac.instanceid
		INNER JOIN qcheck_checklists c
		ON c.id = ci.checklistid
		WHERE actt.tasktype = 103008
		AND ac.completedby IS NULL
		ORDER BY actt.Priority asc
		
		IF LEN(@MediumPriority) > 0
			SELECT @MediumPriority = 'Medium Priority:<BR>'  +CHAR(13)+CHAR(10) + @MediumPriority+'<BR>' +CHAR(13)+CHAR(10)
		
		
		SELECT @LowPriority = ''
		
		SELECT @LowPriority = @LowPriority + convert(varchar(10), actt.Priority) + '. '+c.name +'<BR>' +CHAR(13)+CHAR(10)
		FROM qstatus_activechecklisttasktype actt
		INNER JOIN qcheck_activechecklists ac
		ON ac.id = actt.activechecklistid
		INNER JOIN qcheck_checklistinstances ci
		ON ci.id = ac.instanceid
		INNER JOIN qcheck_checklists c
		ON c.id = ci.checklistid
		WHERE actt.tasktype = 103597
		AND ac.completedby IS NULL
		ORDER BY actt.Priority asc
		
		IF LEN(@LowPriority) > 0
			SELECT @LowPriority = 'Low Priority:<BR>'  +CHAR(13)+CHAR(10)+ @LowPriority+'<BR>' +CHAR(13)+CHAR(10)
		
		
		SELECT @messagebody = @NeedPriority + @HighPriority + @MediumPriority + @LowPriority
		
		IF len(@messagebody) = 0
			SET @messagebody = 'No tasks on Westover Priority List today'
	
		SELECT @messagebody = '<b>' + @messagebody + '</b>'
	
		exec dbo.xp_smtp_sendmail 
			@TO = @to, 
			@cc = @cc,
			@FROM = @from, 
			@FROM_NAME = @fromname,
			@type = 'text/html', 
			@server = 'SMTPGATEWAY', 
			@Subject = @Subject,  
			@message = @messagebody
	END

END







GO
/****** Object:  StoredProcedure [dbo].[WO_PowerOutageChecklist]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[WO_PowerOutageChecklist] AS

BEGIN

	-- Checklist instance to copy every time we need to make this checklist due.  This is a one-time task assigned 
	-- to the Westover Power Outtage group.
	DECLARE @InstanceID INT
	SET @InstanceID = 1683759
	
	DECLARE @DueTime int

	SELECT @DueTime = duetime from QCheck_UserDefaultTimes
	WHERE UserID = -1
	
	-- When the power goes out, this checklist should initially be due same-day.  The guys can push it back if they
	-- need to.
	DECLARE @DueDate DATETIME
	SET @DueDate = CONVERT(VARCHAR(10), GETDATE(), 101) + ' ' + convert(varchar(2), @DueTime) + ':00:00'
	
	-- Copy the instance to the new due date.  Thanks Ken for the handy util stored procedure.
	EXEC Util_CopyInstanceNewDueDate @InstanceID, @DueDate

END
GO

/****** Object:  StoredProcedure [dbo].[XPSendEmail]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[XPSendEmail]
	@FROM varchar(8000),
	@FROM_NAME varchar(8000) = '',
	@TO varchar(8000),
	@subject varchar(8000),
	@message varchar(8000),
	@type varchar(8000),
	@server varchar(8000)
 AS

BEGIN

	SET NOCOUNT ON

	EXEC dbo.xp_smtp_sendmail
	    @FROM       = @FROM,
	    @FROM_NAME  = @FROM_NAME,
	    @TO         = @TO,
	    @subject    = @subject,
	    @message    = @message,
	    @type       = @type,
	    @server     = @server

	insert into qcheck_emails (EmailAddress, Subject, Sent)
	values (@to, @subject, getdate())


	SET NOCOUNT OFF

END

GO
/****** Object:  Trigger [dbo].[trg_Email2dbImageChecklist_del]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create TRIGGER [dbo].[trg_Email2dbImageChecklist_del]
   ON  [dbo].[Email2dbImageChecklists]
   AFTER DELETE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for trigger here
	INSERT INTO Email2dbImageChecklists_Archive (id, uid, checklistid, archivedt)
	select id, uid, checklistid, getdate() from deleted

END
GO
ALTER TABLE [dbo].[Email2dbImageChecklists] ENABLE TRIGGER [trg_Email2dbImageChecklist_del]
GO
/****** Object:  Trigger [dbo].[trg_QCheck_ActiveChecklists_UPDATE]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[trg_QCheck_ActiveChecklists_UPDATE]
ON [dbo].[QCheck_ActiveChecklists]
FOR UPDATE AS

BEGIN

	UPDATE 
		QCheck_ActiveChecklists
	SET 
		ReminderDate = i.DueTime
	FROM
		QCheck_ActiveChecklists ac
		INNER JOIN INSERTED i
			ON ac.[ID] = i.[ID]
		INNER JOIN DELETED d
			ON ac.[ID] = i.[ID]
	WHERE
		-- Times were the same before the update
		CONVERT(VARCHAR(10), d.ReminderDate, 101) = CONVERT(VARCHAR(10), d.DueTime, 101)
		-- Soft due was not updated
		AND CONVERT(VARCHAR(10), i.ReminderDate, 101) = CONVERT(VARCHAR(10), d.ReminderDate, 101)
END
GO
ALTER TABLE [dbo].[QCheck_ActiveChecklists] ENABLE TRIGGER [trg_QCheck_ActiveChecklists_UPDATE]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_ActiveChecklists_INSERT]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TRIGGER [dbo].[tr_QCheck_Approval_ActiveChecklists_INSERT]
ON [dbo].[QCheck_Approval_ActiveChecklists]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		ActiveChecklistID int,
		InstanceID int,
		DueTime datetime,
		OrigDueTime datetime,
		ReminderDate datetime,
		CompletedDate datetime,
		HasNaggedDue int,
		CompletedBy int,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		ActiveChecklistID,
		InstanceID,
		DueTime,
		OrigDueTime,
		ReminderDate,
		CompletedDate,
		HasNaggedDue,
		CompletedBy,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			ActiveChecklistID,
			InstanceID,
			DueTime,
			OrigDueTime,
			ReminderDate,
			CompletedDate,
			HasNaggedDue,
			CompletedBy,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_ActiveChecklists
		SELECT 
			ChangeRequestID,
			ActiveChecklistID,
			InstanceID,
			DueTime,
			OrigDueTime,
			ReminderDate,
			CompletedDate,
			HasNaggedDue,
			CompletedBy,
			CRItemID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_ActiveChecklists] ENABLE TRIGGER [tr_QCheck_Approval_ActiveChecklists_INSERT]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_Alerts_INSERT]    Script Date: 3/22/2024 4:20:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[tr_QCheck_Approval_Alerts_INSERT]
ON [dbo].[QCheck_Approval_Alerts]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		AlertID int,
		InstanceID int,
		DaysBefore int,
		AlertTime float,
		AlertType varchar (10),
		AlertText varchar (250),
		SentTime datetime,
		IsDeleted bit,
		AlerteeGroupID int,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		AlertID,
		InstanceID,
		DaysBefore,
		AlertTime,
		AlertType,
		AlertText,
		SentTime,
		IsDeleted,
		AlerteeGroupID,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			AlertID,
			InstanceID,
			DaysBefore,
			AlertTime,
			AlertType,
			AlertText,
			SentTime,
			IsDeleted,
			AlerteeGroupID,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_Alerts
		SELECT 
			ChangeRequestID,
			AlertID,
			InstanceID,
			DaysBefore,
			AlertTime,
			AlertType,
			AlertText,
			SentTime,
			IsDeleted,
			AlerteeGroupID,
			CRItemID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_Alerts] ENABLE TRIGGER [tr_QCheck_Approval_Alerts_INSERT]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_Assignments_INSERT]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[tr_QCheck_Approval_Assignments_INSERT]
ON [dbo].[QCheck_Approval_Assignments]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		AssignmentID int,
		InstanceID int,
		GroupID int,
		DtAssigned datetime,
		IsDeleted bit,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		AssignmentID,
		InstanceID,
		GroupID,
		DtAssigned,
		IsDeleted,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			AssignmentID,
			InstanceID,
			GroupID,
			DtAssigned,
			IsDeleted,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_Assignments
		SELECT 
			ChangeRequestID,
			AssignmentID,
			InstanceID,
			GroupID,
			DtAssigned,
			IsDeleted,
			CRItemID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_Assignments] ENABLE TRIGGER [tr_QCheck_Approval_Assignments_INSERT]
GO
/****** Object:  Trigger [dbo].[TRG_QCheck_Approval_ChangeRequests_Del]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create TRIGGER [dbo].[TRG_QCheck_Approval_ChangeRequests_Del]
   ON  [dbo].[QCheck_Approval_ChangeRequests]
   AFTER DELETE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	INSERT INTO QCheck_Approval_ChangeRequests_Archive
		(
		[ID]
      ,[RequestingUser]
      ,[RequestDate]
      ,[ReadyForSupervisor]
      ,[Approved]
      ,[ApprovedUser]
      ,[ApprovedDate]
      ,[Rejected]
      ,[RejectedUser]
      ,[RejectedDate]
      ,[IsActive]
      ,[Comment]
	  ,[ArchiveDt]
		)
		SELECT 
		[ID]
      ,[RequestingUser]
      ,[RequestDate]
      ,[ReadyForSupervisor]
      ,[Approved]
      ,[ApprovedUser]
      ,[ApprovedDate]
      ,[Rejected]
      ,[RejectedUser]
      ,[RejectedDate]
      ,[IsActive]
      ,[Comment]
	  , getdate()
	FROM deleted

END
GO
ALTER TABLE [dbo].[QCheck_Approval_ChangeRequests] ENABLE TRIGGER [TRG_QCheck_Approval_ChangeRequests_Del]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_ChecklistInstances_INSERT]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[tr_QCheck_Approval_ChecklistInstances_INSERT]
ON [dbo].[QCheck_Approval_ChecklistInstances]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		InstanceID int,
		[Name] varchar (100),
		ChecklistID int,
		ScheduleID int,
		IsDeleted bit,
		CreatedBy int,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		InstanceID,
		[Name],
		ChecklistID,
		ScheduleID,
		IsDeleted,
		CreatedBy,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			InstanceID,
			[Name],
			ChecklistID,
			ScheduleID,
			IsDeleted,
			CreatedBy,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_ChecklistInstances
		SELECT 
			ChangeRequestID,
			InstanceID,
			[Name],
			ChecklistID,
			ScheduleID,
			IsDeleted,
			CreatedBy,
			CRItemID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_ChecklistInstances] ENABLE TRIGGER [tr_QCheck_Approval_ChecklistInstances_INSERT]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_ChecklistManagers_INSERT]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TRIGGER [dbo].[tr_QCheck_Approval_ChecklistManagers_INSERT]
ON [dbo].[QCheck_Approval_ChecklistManagers]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		ChecklistManagerID int,
		ManagerGroupID int,
		ChecklistID int,
		IsDeleted bit,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		ChecklistManagerID,
		ManagerGroupID,
		ChecklistID,
		IsDeleted,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			ChecklistManagerID,
			ManagerGroupID,
			ChecklistID,
			IsDeleted,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_ChecklistManagers
		SELECT 
			ChangeRequestID,
			ChecklistManagerID,
			ManagerGroupID,
			ChecklistID,
			IsDeleted,
			CRItemID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_ChecklistManagers] ENABLE TRIGGER [tr_QCheck_Approval_ChecklistManagers_INSERT]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_Checklists_INSERT]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[tr_QCheck_Approval_Checklists_INSERT]
ON [dbo].[QCheck_Approval_Checklists]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		ChecklistID int,
		[Name] varchar (500),
		IsDeleted bit,
		Owner int,
		Template bit,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		ChecklistID,
		[Name],
		IsDeleted,
		Owner,
		Template,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			ChecklistID,
			[Name],
			IsDeleted,
			Owner,
			Template,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_Checklists
		SELECT 
			ChangeRequestID,
			ChecklistID,
			[Name],
			IsDeleted,
			Owner,
			Template,
			CRItemID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_Checklists] ENABLE TRIGGER [tr_QCheck_Approval_Checklists_INSERT]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_Items_INSERT]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create TRIGGER [dbo].[tr_QCheck_Approval_Items_INSERT]
ON [dbo].[QCheck_Approval_Items]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT


	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		ItemID int,
		ChecklistID int,
		SequenceNum int,
		ItemTypeID int,
		[Text] varchar (max),
		URL varchar (1000),
		IsDeleted bit,
		CRItemID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		ItemID,
		ChecklistID,
		SequenceNum,
		ItemTypeID,
		[Text],
		URL,
		IsDeleted,
		CRItemID
	)
		SELECT 
			ChangeRequestID,
			ItemID,
			ChecklistID,
			SequenceNum,
			ItemTypeID,
			[Text],
			URL,
			IsDeleted,
			CRItemID
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_Items
		SELECT 
			ChangeRequestID,
			ItemID,
			ChecklistID,
			SequenceNum,
			ItemTypeID,
			[Text],
			URL,
			IsDeleted,
			CRItemID
		FROM 
			@Inserted

END
GO
ALTER TABLE [dbo].[QCheck_Approval_Items] ENABLE TRIGGER [tr_QCheck_Approval_Items_INSERT]
GO
/****** Object:  Trigger [dbo].[tr_QCheck_Approval_Schedule_INSERT]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[tr_QCheck_Approval_Schedule_INSERT]
ON [dbo].[QCheck_Approval_Schedule]
INSTEAD OF INSERT AS

BEGIN

	DECLARE @CRItemID INT,
		@ID INT,
		@ChangeID INT,
		@i INT,
		@count INT

	DECLARE @Inserted TABLE (
		Seq INT IDENTITY(1,1),
		ChangeRequestID int,
		ScheduleID int,
		firstDueDate datetime,
		lastDueDate datetime,
		freqType int,
		freqInterval int,
		freqRecurrance int,
		dueTime float,
		busDayBehavior int,
		SoftDueOffsetDays int,
		CRItemID int,
		busDayValue int,
		InstanceID int
	)

	INSERT INTO @Inserted (
		ChangeRequestID,
		ScheduleID,
		firstDueDate,
		lastDueDate,
		freqType,
		freqInterval,
		freqRecurrance,
		dueTime,
		busDayBehavior,
		SoftDueOffsetDays,
		CRItemID,
		busDayValue,
		InstanceID
	)
		SELECT 
			ChangeRequestID,
			ScheduleID,
			firstDueDate,
			lastDueDate,
			freqType,
			freqInterval,
			freqRecurrance,
			dueTime,
			busDayBehavior,
			SoftDueOffsetDays,
			CRItemID,
			busDayValue,
			InstanceID 
		FROM 
			INSERTED

	SELECT @count = MAX(seq) FROM @Inserted
	SET @i = 1
	WHILE @i <= @count BEGIN

		SELECT @ChangeID = ChangeRequestID FROM @Inserted WHERE Seq = @i
		EXEC QCheck_Approval_NewChangeRequestItem @ChangeID, @CRItemID OUTPUT
		UPDATE @Inserted SET CRItemID = @CRItemID WHERE Seq = @i
		SET @i = @i + 1

	END

	INSERT INTO QCheck_Approval_Schedule
		SELECT 
			ChangeRequestID,
			ScheduleID,
			firstDueDate,
			lastDueDate,
			freqType,
			freqInterval,
			freqRecurrance,
			dueTime,
			busDayBehavior,
			SoftDueOffsetDays,
			CRItemID,
			busDayValue,
			InstanceID
		FROM 
			@Inserted

END

GO
ALTER TABLE [dbo].[QCheck_Approval_Schedule] ENABLE TRIGGER [tr_QCheck_Approval_Schedule_INSERT]
GO
/****** Object:  Trigger [dbo].[trInsRefreshLookup]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create     TRIGGER [dbo].[trInsRefreshLookup] ON [dbo].[QCheck_Assignments] AFTER INSERT
AS

BEGIN


	DECLARE @InstanceID int
	
	SELECT 
		@InstanceID = InstanceID
	FROM
		INSERTED
	

	if @instanceID is not null
		exec QCheck_RefreshInstanceLookup @InstanceID

	
END


GO
ALTER TABLE [dbo].[QCheck_Assignments] ENABLE TRIGGER [trInsRefreshLookup]
GO
/****** Object:  Trigger [dbo].[trUpdtRefreshLookup]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create      TRIGGER [dbo].[trUpdtRefreshLookup] ON [dbo].[QCheck_Assignments] AFTER UPDATE
AS

BEGIN


	DECLARE @InstanceID int
	
	SELECT 
		@InstanceID = InstanceID
	FROM
		INSERTED

	if @instanceID is not null
	exec QCheck_RefreshInstanceLookup @InstanceID

	
END






GO
ALTER TABLE [dbo].[QCheck_Assignments] ENABLE TRIGGER [trUpdtRefreshLookup]
GO
/****** Object:  Trigger [dbo].[QCheck_AssignmentsTemporary_DEL]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create TRIGGER [dbo].[QCheck_AssignmentsTemporary_DEL]
   ON  [dbo].[QCheck_AssignmentsTemporary]
   AFTER DELETE
AS 
BEGIN
	
	SET NOCOUNT ON;

		INSERT INTO [dbo].[QCheck_AssignmentsTemporary_History]
           ([ID]
           ,[ReplacingID]
           ,[TempAssignmentsID]
           ,[InstanceID]
           ,[TempGroupID]
           ,[TempAssignmentStart]
           ,[TempAssignmentEnd]
           ,[TempAssignmentApplied]
           ,[TempAssignmentRemoved]
		   ,[AssigneesAlerted]
		   ,[ControllersAlerted]
           ,[CreatedDt]
           ,[CreatedBy]
           ,[ArchiveDt])
		SELECT [ID]
           ,[ReplacingID]
           ,[TempAssignmentsID]
           ,[InstanceID]
           ,[TempGroupID]
           ,[TempAssignmentStart]
           ,[TempAssignmentEnd]
           ,[TempAssignmentApplied]
           ,[TempAssignmentRemoved]
		   ,[AssigneesAlerted]
		   ,[ControllersAlerted]
           ,[CreatedDt]
           ,[CreatedBy]
		   ,GETDATE()
		FROM deleted

	SET NOCOUNT OFF;

END
GO
ALTER TABLE [dbo].[QCheck_AssignmentsTemporary] ENABLE TRIGGER [QCheck_AssignmentsTemporary_DEL]
GO
/****** Object:  Trigger [dbo].[QCheck_trg_controllers]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create   TRIGGER [dbo].[QCheck_trg_controllers] ON [dbo].[QCheck_ChecklistManagers] 
FOR INSERT, UPDATE, DELETE
AS
	DECLARE @ChecklistID int

	SELECT @ChecklistID = ChecklistID from Inserted

	if @ChecklistID is not null EXEC QCheck_ChecklistControllersList_Refresh @ChecklistID








GO
ALTER TABLE [dbo].[QCheck_ChecklistManagers] ENABLE TRIGGER [QCheck_trg_controllers]
GO
/****** Object:  Trigger [dbo].[QStatus_trg_tasktypes_del]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  TRIGGER [dbo].[QStatus_trg_tasktypes_del] ON [dbo].[QStatus_ActiveChecklistTaskType] 
FOR DELETE 
AS
	DECLARE @TaskType int
	DECLARE @TaskTypeTo int
	DECLARE @ActiveChecklistID int

	SELECT @TaskType = TaskType, @ActiveChecklistID = ActiveChecklistID from Deleted

	SET @TaskTypeTo = 0

	SELECT @TaskTypeTo = TaskTypeTo
	FROM QStatus_TaskType_Relation
	WHERE TaskTypeFrom = @TaskType

	IF @TaskTypeTo > 0
	BEGIN

		DELETE FROM QStatus_ActiveChecklistTaskType
		WHERE TaskType = @TaskTypeTo
		AND ActiveChecklistID = @ActiveChecklistID

	END

	if @ActiveChecklistID is not null EXEC QStatus_TaskReportList_Refresh @ActiveChecklistID





GO
ALTER TABLE [dbo].[QStatus_ActiveChecklistTaskType] ENABLE TRIGGER [QStatus_trg_tasktypes_del]
GO
/****** Object:  Trigger [dbo].[QStatus_trg_tasktypes_ins]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  TRIGGER [dbo].[QStatus_trg_tasktypes_ins] ON [dbo].[QStatus_ActiveChecklistTaskType] 
FOR INSERT
AS
	DECLARE @TaskType int
	DECLARE @TaskTypeTo int
	DECLARE @ActiveChecklistID int

	SELECT @TaskType = TaskType, @ActiveChecklistID = ActiveChecklistID from Inserted

	SET @TaskTypeTo = 0

	SELECT @TaskTypeTo = TaskTypeTo
	FROM QStatus_TaskType_Relation
	WHERE TaskTypeFrom = @TaskType

	IF @TaskTypeTo > 0
	BEGIN

		INSERT INTO QStatus_ActiveChecklistTaskType
		SELECT ActiveChecklistID, @TaskTypeTo, Priority, CreateDt
		FROM Inserted

	END

	if @ActiveChecklistID is not null EXEC QStatus_TaskReportList_Refresh @ActiveChecklistID







GO
ALTER TABLE [dbo].[QStatus_ActiveChecklistTaskType] ENABLE TRIGGER [QStatus_trg_tasktypes_ins]
GO
/****** Object:  Trigger [dbo].[QStatus_trg_tasktypes_upd]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  TRIGGER [dbo].[QStatus_trg_tasktypes_upd] ON [dbo].[QStatus_ActiveChecklistTaskType] 
FOR UPDATE 
AS
	
	DECLARE @TaskType int
	DECLARE @ActiveChecklistID int
	
	DECLARE @TaskTypeTo int

	SET @TaskTypeTo = 0

	--check to see if it has been moved out of the section
	SELECT @TaskType = TaskType, @ActiveChecklistID = ActiveChecklistID
	FROM DELETED

	SELECT @TaskTypeTo = TaskTypeTo
	FROM QStatus_TaskType_Relation
	WHERE TaskTypeFrom = @TaskType

	IF @TaskTypeTo > 0
	BEGIN

		DELETE FROM QStatus_ActiveChecklistTaskType
		WHERE TaskType = @TaskTypeTo
		AND ActiveChecklistID = @ActiveChecklistID

	END

	--check the newly inserted section
	SELECT @TaskType = TaskType
	FROM INSERTED

	SET @TaskTypeTo = 0

	SELECT @TaskTypeTo = TaskTypeTo
	FROM QStatus_TaskType_Relation
	WHERE TaskTypeFrom = @TaskType

	IF @TaskTypeTo > 0
	BEGIN

		INSERT INTO QStatus_ActiveChecklistTaskType
		SELECT ActiveChecklistID, @TaskTypeTo, Priority, CreateDt
		FROM Inserted

	END

	if @ActiveChecklistID is not null EXEC QStatus_TaskReportList_Refresh @ActiveChecklistID







GO
ALTER TABLE [dbo].[QStatus_ActiveChecklistTaskType] ENABLE TRIGGER [QStatus_trg_tasktypes_upd]
GO
/****** Object:  Trigger [dbo].[QStatus_trg_comments_ins]    Script Date: 3/22/2024 4:20:59 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create    TRIGGER [dbo].[QStatus_trg_comments_ins] ON [dbo].[QStatus_Comments] 
FOR INSERT
AS
	DECLARE @UserID int,
	@CommentDt datetime,
	@ForeignKeyID int,
	@SpecialTask bit

	SELECT @UserID = UserID,
		@CommentDt = CommentDt,
		@ForeignKeyID = ForeignKeyID,
		@SpecialTask = SpecialTask
	 from Inserted

	EXEC QStatus_ReportLastestComments_Update @UserID, @CommentDt, @ForeignKeyID, @SpecialTask
GO
ALTER TABLE [dbo].[QStatus_Comments] ENABLE TRIGGER [QStatus_trg_comments_ins]
GO
ALTER DATABASE [PFSProcess] SET  READ_WRITE 
GO

use [master]
GO